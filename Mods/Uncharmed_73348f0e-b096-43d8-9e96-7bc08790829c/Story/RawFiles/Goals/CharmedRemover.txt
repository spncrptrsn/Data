Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
IF 
CharacterStatusApplied((CHARACTERGUID)_Char,"CHARMED",(CHARACTERGUID)_Source)
AND
DB_IsPlayer(_Source)
THEN
DB_CH_CharmedSource(_Char,_Source);

IF
CharacterStatusRemoved((CHARACTERGUID)_Char,"CHARMED",_)
AND
DB_CH_CharmedSource(_Char,_Charmer)
THEN
NOT DB_CH_CharmedSource(_Char,_Charmer);

IF 
CharacterReceivedDamage((CHARACTERGUID)_Char,_,(CHARACTERGUID)_Source)
AND
DB_CH_CharmedSource(_Char,_Charmer)
AND
DB_CombatCharacters(_Char,_ID)
AND
NOT CombatGetActiveEntity(_ID,_Char)
AND
CharacterIsInPartyWith(_Charmer,_Source,1)
THEN
RemoveStatus(_Char,"CHARMED");
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "CharmLossOnDamage"
