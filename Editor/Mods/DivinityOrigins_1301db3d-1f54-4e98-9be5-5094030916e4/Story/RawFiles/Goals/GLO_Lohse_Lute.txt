Version 1
SubGoalCombiner SGC_AND
INITSECTION
//New Lute
DB_RC_DW_MagicLute("RC_DW_SpeedLute","Shout_QUEST_PlayLute_Haste","RC_DW_Haste_MagicalLute_933350b3-e6a0-4aa3-99b6-fbb25e94f43e");
DB_RC_DW_MagicLute("RC_DW_HealthLute","Shout_QUEST_PlayLute_Heal","RC_DW_Healing_MagicalLute_48e24b5c-030d-4e72-b3af-7f517bbb8115");
DB_RC_DW_MagicLute("RC_DW_BlessLute","Shout_QUEST_PlayLute_Bless","RC_DW_Bless_MagicalLute_31d99ceb-83ab-44b6-98ce-8d97eed3650a");
KBSECTION
//REGION FTJ Lute

IF
CharacterUsedItem((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4)
AND
ItemIsInInventory(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,0)
THEN
CharacterPickupItem(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,"");

IF
CharacterUsedItem((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4)
AND
ItemIsInInventory(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,1)
THEN
ItemToInventory(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

IF
CharacterUsedItem((CHARACTERGUID)_Player,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(1,"FTJ_AD_UseLaslorLute",_Player);

IF
CharacterUsedItem((CHARACTERGUID)_Player,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
Proc_FTJ_UseLaslorLute(_Player);

IF
CharacterUsedItem((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
THEN
ItemDestroy(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4);

PROC
Proc_FTJ_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Polymorphed",1)
THEN
ProcRemovePolymorphs(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_FTJ_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
ItemSetCanInteract(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,0);
MusicPlayOnCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"SE_Lohse_OM_PlayLute_1st");
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Shout_QUEST_PlayLute",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0, 1, 1);

IF
ObjectFlagSet("FTJ_ThrowLute",(CHARACTERGUID)_Player,_)
AND
ObjectGetFlag(_Player,"GLO_Polymorphed",1)
THEN
ProcRemovePolymorphs(_Player);

IF
ObjectFlagSet("FTJ_ThrowLute",(CHARACTERGUID)_Player,_)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
RealSum(_X,1.5,_NewX)
THEN
TeleportToPosition(GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,_NewX,_Y,_Z,"",0);
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Projectile_QUEST_Grenade_Lute",GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,0, 1, 1);

IF
StoryEvent((ITEMGUID)_Lute,"RC_DW_LuteProjectile_TouchedGound")
THEN
PlayEffect(_Lute,"RS3_FX_GP_Impacts_MagicalLute_01");
Transform(_Lute,"FTJ_Laslors_Broekn_Lute_a8a93b69-9acd-4c87-aace-d7c27f6a5092",0);
DB_HasStoryEvent(_Lute,"RC_DW_HasLaslors_Broken_Lute");
DB_GiveItemToEvent(_Lute,"RC_DW_GiveLaslors_Broken_Lute");
TimerLaunch("FTJ_DestroyLute",1000);

//END_REGION

//REGION DW Lute
IF
DB_RC_DW_MagicLute(_LuteFlag,_Skill,_LuteRoot)
THEN
DB_SharedObjectFlags(_LuteFlag);

IF
ObjectFlagSet("RC_DW_GiveMagicLute",_Player,_)
AND
DB_RC_DW_MagicLute(_LuteFlag,_Skill,_LuteRoot)
AND
ObjectGetFlag(_Player,_LuteFlag,1)
THEN
ItemTemplateAddTo(_LuteRoot,_Player,1);


IF
ItemTemplateAddedToCharacter(_LuteRootGUID,_Item,_Player)
AND
String(_LuteRootGUID,_LuteRoot)
AND
DB_RC_DW_MagicLute(_LuteFlag,_Skill,_LuteRoot)
AND
ObjectGetFlag(_Player,_LuteFlag,1)
AND
NOT DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag);


IF
ItemTemplateAddedToCharacter(_LuteRootGUID,_Item,_Player)
AND
String(_LuteRootGUID,_LuteRoot)
AND
DB_RC_DW_MagicLute(_LuteFlag,_Skill,_LuteRoot)
AND
ObjectGetFlag(_Player,_LuteFlag,1)
THEN
ItemSetCanInteract(_Item,1);


IF
CharacterUsedItem((CHARACTERGUID)_Player,_Item)
AND
GetTemplate(_Item,_LuteRoot)
AND
DB_RC_DW_MagicLute(_LuteFlag,_Skill,_LuteRoot)
AND
ItemIsInPartyInventory(_Item,_Player,0,0)
THEN
CharacterPickupItem(_Player,_Item,"");

IF
CharacterUsedItem(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Item)
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_LuteFlag,0) // Handles the case if a diffrent character fixed the lute
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_LuteFlag);

IF
CharacterUsedItem(_Player,_Item)
AND
DB_IsPlayer(_Player)
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
Proc_StartDialog(1,"RC_DW_AD_UseMagicLute",_Player);


IF
CharacterUsedItem(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Item)
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
Proc_DW_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Skill,_Item);


PROC
Proc_DW_UseLaslorLute((CHARACTERGUID)_Player,(STRING)_Skill,(ITEMGUID)_Item)
THEN
ItemSetCanInteract(_Item,0);

PROC
Proc_DW_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(STRING)_Skill,(ITEMGUID)_Item)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Polymorphed",1)
THEN
ProcRemovePolymorphs(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_DW_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(STRING)_Skill,(ITEMGUID)_Item)
AND
GlobalGetFlag("GLO_LohseHasDemons",1)
THEN
MusicPlayOnCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"SE_Lohse_OM_PlayLute_2nd_Demon");

PROC
Proc_DW_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(STRING)_Skill,(ITEMGUID)_Item)
AND
GlobalGetFlag("GLO_LohseHasDemons",0)
THEN
MusicPlayOnCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"SE_Lohse_OM_PlayLute_2nd_NoDemon");

PROC
Proc_DW_UseLaslorLute(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(STRING)_Skill,(ITEMGUID)_Item)
THEN
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Skill,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0, 1, 1);

IF
ObjectFlagSet("RC_DW_MagicLute_BurnIt",(CHARACTERGUID)_Player,_)
AND
ObjectGetFlag(_Player,"GLO_Polymorphed",1)
THEN
ProcRemovePolymorphs(_Player);

IF
ObjectFlagSet("RC_DW_MagicLute_BurnIt",(CHARACTERGUID)_Player,_)
AND
GetPosition(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_X,_Y,_Z)
AND
RealSum(_X,1.5,_NewX)
AND
DB_RC_DW_UseMagicLute(_Item,_,_) 
THEN
ItemDestroy(_Item);
TeleportToPosition(GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,_NewX,_Y,_Z,"",0);
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Projectile_QUEST_Grenade_MagicalLute",GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,0, 1, 1);

IF
ObjectFlagSet("RC_DW_MagicLute_BurnIt",(CHARACTERGUID)_Player,_)
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
NOT DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag);

IF
AutomatedDialogEnded("RC_DW_AD_UseMagicLute",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"RC_DW_MagicLute_BurnIt",0)
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
ItemSetCanInteract(_Item,1);

IF
GlobalFlagSet("RC_DW_MagicLute_LostPower")
AND
DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag)
THEN
ItemTemplateAddTo("LOOT_Guitar_Lute_A_58d19c4b-87a5-47f1-8335-f48dd1af3a36",S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1);
ItemDestroy(_Item);
NOT DB_RC_DW_UseMagicLute(_Item,_Skill,_LuteFlag);

IF
CharacterDied(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
THEN
GlobalClearFlag("GLO_LohseHasDemons");

//END_REGION 

//REGION DEBUG
IF
TextEventSet("Shout_QUEST_PlayLute")
THEN
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Shout_QUEST_PlayLute",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0, 1, 1);

IF
TextEventSet("Projectile_QUEST_Grenade_Lute")
AND
GetPosition(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_X,_Y,_Z)
AND
RealSum(_X,1.0,_NewX)
THEN
TeleportToPosition(GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,_NewX,_Y,_Z,"",0);
CharacterUseSkill(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Projectile_QUEST_Grenade_Lute",GLO_Lohse_LuteThrow_Helper_6d386628-1fe3-4e84-9f3e-e140ab0f8eb7,0, 1, 1);

IF
TextEventSet("GiveLute")
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("Debug_GiveLute")
THEN
ItemToInventory(ITEMGUID_S_FTJ_LaslorLute_6e70de6f-8bb8-4ae6-b779-09312c4472b4,_Player);

IF
TextEventSet("LohseRemoveDemon")
THEN
GlobalClearFlag("GLO_LohseHasDemons");

IF
TextEventSet("GiveBrokenLute")
AND
DB_IsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
GetPosition(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("FTJ_Laslors_Broekn_Lute_a8a93b69-9acd-4c87-aace-d7c27f6a5092",_X,_Y,_Z,_Item)
THEN
DB_HasStoryEvent(_Item,"RC_DW_HasLaslors_Broken_Lute");
DB_GiveItemToEvent(_Item,"RC_DW_GiveLaslors_Broken_Lute");

IF
TextEventSet("GiveBlessingLute")
THEN
GlobalClearFlag("RC_DW_MagicLute_LostPower");
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_DW_BlessLute");
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_DW_GiveMagicLute");
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_DW_MagicLute_BurnIt");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_DW_BlessLute");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_DW_GiveMagicLute");

IF
TextEventSet("LOHSE_Test_Full_Preformance1")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"DOS2_CHAPTER9_Arx");
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"DOS2_CHAPTER9_Arx");
GlobalSetFlag("ARX_TheDoctor_IsDead");
Proc_StartDialog(0,"Lohse2",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
TextEventSet("LOHSE_Test_Full_Preformance2")
THEN
Proc_StartDialog(0,"ARX_TheDoctorIsDead_CRD_Lohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

//END_REGION

//REGION FullSong

IF
ObjectFlagSet("GLO_Lohse_PlayFullSong",_Lohse,_ID)
AND
CharacterIsInFightMode((CHARACTERGUID)_Lohse,1)
THEN
CharacterSetFightMode(_Lohse,0,1);

IF
ObjectFlagSet("GLO_Lohse_PlayFullSong",_Lohse,_ID)
THEN
ProcRemovePolymorphs((CHARACTERGUID)_Lohse);
CharacterSetAnimationOverride(_Lohse,"Play_LohseSong_01");
DB_GLO_Lohse_PlayFullSong(_Lohse,_ID);
ProcObjectTimer(_Lohse,"GLO_Lohse_PlayFullSong",161000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Lohse,"GLO_Lohse_PlayFullSong")
THEN
ObjectClearFlag(_Lohse,"GLO_Lohse_PlayFullSong");

IF
DialogEnded(_Dialog,_ID)
AND
DB_GLO_Lohse_PlayFullSong(_Lohse,_ID)
THEN
NOT DB_GLO_Lohse_PlayFullSong(_Lohse,_ID);
ObjectClearFlag(_Lohse,"GLO_Lohse_PlayFullSong");

IF
ObjectFlagCleared("GLO_Lohse_PlayFullSong",_Lohse,_ID)
AND
DB_GLO_Lohse_PlayFullSong((CHARACTERGUID)_Lohse,_ID)
THEN
NOT DB_GLO_Lohse_PlayFullSong(_Lohse,_ID);

IF
ObjectFlagCleared("GLO_Lohse_PlayFullSong",_Lohse,_ID)
THEN
ProcObjectTimerCancel(_Lohse,"GLO_Lohse_PlayFullSong");
CharacterSetAnimationOverride((CHARACTERGUID)_Lohse,"");
PlayAnimation(_Lohse,"Bow_01");
PlaySound(_Lohse,"SE_FTJ_Lastor_Lohse_Stop");

IF
TextEventSet("LohsetestSong")
THEN
CharacterSetAnimationOverride((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Play_LohseSong_01");
//END_REGION  

//REGION
IF
CharacterUsedItemTemplate(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"UNIQUE_ARX_LohseLute_ad88041c-4b88-4540-b1c8-2dd8e1cc9185",_)
THEN
Proc_StartDialog(0,"ARX_Lohse_Lute",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

IF
CharacterDied(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
QueryOnlyOnce("Add_ARX_LohseLute")
THEN
ItemTemplateAddTo("UNIQUE_ARX_LohseLute_ad88041c-4b88-4540-b1c8-2dd8e1cc9185",CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
