Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/graveyard---tombs/loyal-dog

DB_Dialogs(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog");
DB_Dialogs(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,"RC_GY_LoyalDog_Necromancer");
ProcCrimeSetAllCustomSensibleAction(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"AttackAnimal","");
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);
SetCanFight(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,0);
DB_BlockThreatenedDialog(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);
DB_NoLowAttitudeDialog(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);

DB_RC_GY_LoyalDog_PetrifiedVictims((CHARACTERGUID)CHARACTERGUID_S_RC_GY_LoyalDog_PetrifiedVictim_01_4e154a51-b8d2-4358-8120-a855700d27de);
DB_RC_GY_LoyalDog_PetrifiedVictims(CHARACTERGUID_S_RC_GY_LoyalDog_PetrifiedVictim_02_8a77709e-cc47-48f4-9fc8-62dc3a57f214);
DB_RC_GY_LoyalDog_PetrifiedVictims(CHARACTERGUID_S_RC_GY_LoyalDog_PetrifiedVictim_03_3867f393-33a6-4ad2-bfcd-b9d339ddf65b);
DB_RC_GY_LoyalDog_PetrifiedVictims(CHARACTERGUID_S_RC_GY_LoyalDog_PetrifiedVictim_04_420dce16-0afd-44f0-8726-1904e219907d);
DB_RC_GY_LoyalDog_PetrifiedVictims(CHARACTERGUID_S_RC_GY_LoyalDog_PetrifiedVictim_05_97c8599a-d749-4c3f-8eed-de8bc378a9cd);

DB_Ghosts(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,CHARACTERGUID_S_RC_GY_LoyalDog_Ghost_3c3c1167-9c76-444a-96a7-afc4003d9c42,"RC_GY_LoyalDog_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_Ghost_db202f3f-6141-49f9-b606-39b7a9f6b8a2,"RC_GY_LoyalDog_Necromancer_Ghost");

DB_DoNotFace(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);

DB_SneakTriggerSpotter(TRIGGERGUID_S_RC_GY_LoyalDog_SpotSneakerTrigger_9a8df799-5f87-4892-8497-60f7eabfde3c,CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce);

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_LoyalDog_PetrifyBox_e48c1b3a-5df2-4b0a-bbc4-618d7a195d7a);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_GY_LoyalDog_CryptVBarkTrigger_e1529f81-ba39-4c22-8724-9cb7b715fe5f);

ApplyStatus(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,"PETRIFIED",-1.0,1);

DB_RC_GY_LoyalDog_TombPetrifies(1);
KBSECTION
//REGION Dog Outside
IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_GY_LoyalDog_CryptLever_e28921a1-8fc5-4491-be87-39d7e4dd3a08)
AND
ItemIsLocked(ITEMGUID_S_RC_GY_LoyalDog_CryptDoor_98a6960a-7852-4544-bf3a-409b9c044ff4,1)
THEN
ItemUnlockAndOpen(ITEMGUID_S_RC_GY_LoyalDog_CryptDoor_98a6960a-7852-4544-bf3a-409b9c044ff4);

PROC
ProcCharInTriggerSpotted(_Player,TRIGGERGUID_S_RC_GY_LoyalDog_SpotSneakerTrigger_9a8df799-5f87-4892-8497-60f7eabfde3c)
AND
DB_IsPlayer(_Player)
THEN
Proc_StartDialog(0,"RC_GY_LoyalDog",CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_Player);

PROC
ProcBlockLockpickItem(_Player,ITEMGUID_S_RC_GY_LoyalDog_CryptDoor_98a6960a-7852-4544-bf3a-409b9c044ff4)
THEN
Proc_RC_GY_LoyalDog_Interogation(_Player);

PROC
ProcBlockUseOfItem(_Player,ITEMGUID_S_RC_GY_LoyalDog_CryptHatch_3e9467f1-9eb6-4b60-b192-4b7ea3db11b9)
THEN
Proc_RC_GY_LoyalDog_Interogation(_Player);

PROC
ProcBlockUseOfItem(_Player,ITEMGUID_S_RC_GY_LoyalDog_CryptDoor_98a6960a-7852-4544-bf3a-409b9c044ff4)
THEN
Proc_RC_GY_LoyalDog_Interogation(_Player);

PROC
Proc_RC_GY_LoyalDog_Interogation((CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
AND
GlobalGetFlag("RC_GY_LoyalDog_Died",0)
AND
CharacterCanSee(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_Player,1)
THEN
DB_CustomLockpickItemResponse(_Player, ITEMGUID_S_RC_GY_LoyalDog_CryptDoor_98a6960a-7852-4544-bf3a-409b9c044ff4,0);
DB_CustomUseItemResponse(_Player,ITEMGUID_S_RC_GY_LoyalDog_CryptHatch_3e9467f1-9eb6-4b60-b192-4b7ea3db11b9,0);
DialogRequestStop(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce);
Proc_StartDialog(0,"RC_GY_LoyalDog",CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_Player);
ObjectSetFlag(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Interogation");

PROC
ProcCrimeOnCustomSensibleAction(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,(STRING)_,(INTEGER)_CrimeID,(STRING)_,(STRING)_,_Player,(CHARACTERGUID)_,(CHARACTERGUID)_,(CHARACTERGUID)_,(INTEGER)_)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Interogation");
UserSetFlag(_Player,"RC_GY_LoyalDog_SecondWarning");
Proc_StartDialog(0,"RC_GY_LoyalDog",CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_Player);

IF
DialogEnded("RC_GY_LoyalDog",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Interogation",1)
THEN
ObjectClearFlag(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Interogation");

IF
ObjectFlagSet("RC_GY_LoyalDog_Attacks",CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_)
THEN
SetFaction(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"Evil NPC");
SetHasDialog(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,0);

IF
ObjectEnteredCombat(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,_)
THEN
PROC_LoopEffect("RS3_FX_Char_Animals_NecroDog_Mouth_01",CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Effect","RC_Main","Dummy_StatusFX");

IF
CharacterDied(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce)
THEN
GlobalSetFlag("RC_GY_LoyalDog_Died");
PROC_StopLoopEffect(CHARACTERGUID_S_RC_GY_LoyalDog_46e022c5-f2d4-465c-a5f0-db0e9760fcce,"RC_GY_LoyalDog_Effect");

//END_REGION

//REGION Removing Petrified from Skeletons
IF
DB_RC_GY_LoyalDog_PetrifiedVictims(_Char)
THEN
DB_Dialogs(_Char,"RC_GY_LoyalDog_PetrifiedVictim");
DB_DoNotFace(_Char);
ApplyStatus(_Char,"PETRIFIED",-1.0,1);
DB_DontCreateMurder(_Char);
SetCanFight(_Char,0);

IF
CharacterStatusRemoved(_Char,"PETRIFIED",(CHARACTERGUID)_Player)
AND
DB_RC_GY_LoyalDog_PetrifiedVictims(_Char)
AND
DB_IsPlayer(_Player)
AND
GetPosition(_Char,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_Combat_Death_Petrified_01_Medium",_X,_Y,_Z);
CharacterDie(_Char,1,"Explode");
StartVoiceBark("RC_GY_VB_LoyalDog_UnpetrifyingSkeleton",_Player);

//END_REGION

//REGION Petrifying Tomb
IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_GY_LoyalDog_PetrifyingTomb_76634527-7d60-4459-a444-c99de30a76dc)
AND
DB_RC_GY_LoyalDog_TombPetrifies(1)
AND
GetPosition(ITEMGUID_S_RC_GY_LoyalDog_PetrifyingTomb_76634527-7d60-4459-a444-c99de30a76dc,_X,_Y,_Z)
THEN
ApplyStatus(_Player,"PETRIFIED",-1.0,1);
PlayEffect(_Player,"RS3_FX_Skills_PetrifyingTouch_Impact_Root_01");
PlayEffectAtPosition("RS3_FX_Skills_Earth_Rock_Impact_01",_X,_Y,_Z);
ProcObjectTimer(_Player,"Timer_RC_GY_TombPetrification",500);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"Timer_RC_GY_TombPetrification")
AND
HasActiveStatus(_Player,"PETRIFIED",1)
THEN
CloseUI(_Player,"Container");

//END_REGION

//REGION Nercromancer
IF
CharacterStatusRemoved(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,"PETRIFIED",(CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
THEN
ProcCharacterEnableAllCrimes(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);
SetCanFight(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,1);
DialogRequestStop(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);
SetHasDialog(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,0);
NOT DB_DoNotFace(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb);
ObjectSetFlag(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,"RC_GY_LoyalDog_Helped");
ProcObjectTimer(_Player,"RC_GY_LoyalDog_Necromancer_Unpetrifying",1500);

PROC
ProcObjectTimerFinished(_Player,"RC_GY_LoyalDog_Necromancer_Unpetrifying")
THEN
SetHasDialog(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,1);
Proc_StartDialog(0,"RC_GY_LoyalDog_Necromancer",CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,_Player);

IF
ObjectFlagSet("RC_GY_LoyalDog_NecroAttacks",CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,_)
THEN
SetFaction(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,"Evil NPC");

//END_REGION

//REGION VBs
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_GY_LoyalDog_CryptBox_89124061-1d5f-43c3-af90-9a4393dc9829)
AND
QueryOnlyOnce("RC_GY_LoyalDog_EnteredCrypt")
THEN
ObjectSetFlag(_Player,"RC_GY_LoyalDog_WasInCrypt");

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_GY_LoyalDog_CryptVBarkTrigger_e1529f81-ba39-4c22-8724-9cb7b715fe5f)
THEN
StartVoiceBark("RC_GY_VB_LoyalDog_EnteredCrypt",_Player);

PROC
Proc_ObjectLeftCombat((CHARACTERGUID)_Player,_CombatID)
AND
DB_WasInCombat(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,_CombatID)
AND
DB_IsPlayer(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_RC_GY_LoyalDog_Necromancer_e11b3dc2-0297-4d53-9846-2df9ef665ebb,1)
AND
QueryOnlyOnce("RC_GY_LoyalDog_NecromancersDeath")
THEN
StartVoiceBark("RC_GY_VB_LoyalDog_KilledNecromancer",_Player);
UserSetFlag(_Player,"RC_GY_LoyalDog_NecroKilled");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
