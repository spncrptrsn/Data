Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ARX_KemmMansion_CellarTraderTrigger((TRIGGERGUID)TRIGGERGUID_S_ARX_KemmMansion_OneShot_ChiefCellar_49e85f5c-2398-4309-b82b-39a345fddef3);

ProcTriggerRegisterForPlayers(S_RC_DW_KemmVault_Floor01_84095ddf-39b1-49aa-9840-a8bd5f61f965);

DB_Dialogs(CHARACTERGUID_S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,"ARX_AntiqueTraders_Bodyguard");

//Traders KM
DB_Dialogs(S_ARX_KM_Trader_Antique_01_ee8eebd2-cb85-41f6-87a6-f540017e8821,"ARX_KM_Trader_Antique_01");
DB_Dialogs(S_ARX_KM_Trader_Antique_02_b4a87795-0d90-47c0-a77e-7193a368bd72,"ARX_KM_Trader_Antique_02");
DB_Dialogs(S_ARX_KM_Trader_Antique_03_9f3b3fb5-dfac-4565-a584-93c665be6671,"ARX_KM_Trader_Antique_03");

DB_ARX_KemmMansion_AntiqueTraderOutside(S_ARX_KM_Trader_Antique_01_ee8eebd2-cb85-41f6-87a6-f540017e8821);
DB_ARX_KemmMansion_AntiqueTraderOutside(S_ARX_KM_Trader_Antique_02_b4a87795-0d90-47c0-a77e-7193a368bd72);
DB_ARX_KemmMansion_AntiqueTraderOutside(S_ARX_KM_Trader_Antique_03_9f3b3fb5-dfac-4565-a584-93c665be6671);

//Setup Trader on 1st floor
GlobalSetFlag("ARX_AntiqueTraders_ChiefMansion");
DB_Dialogs(CHARACTERGUID_S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Chief");
CharacterSetCanTrade(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,1);

//ProcCharacterDisableAllCrimes(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f);
ProcCharacterDisableCrime(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"Steal");
ProcCharacterDisableCrime(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"MoveForbiddenItem");
ProcCharacterDisableCrime(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"UseForbiddenItem");
ProcCharacterDisableCrime(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"TeleportPlayerDialog");

ProcCharacterDisableCrime(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,"Steal");
ProcCharacterDisableCrime(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,"MoveForbiddenItem");
ProcCharacterDisableCrime(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,"UseForbiddenItem");

//Requested Items 
DB_ARX_AntiqueTraders_RequstedItem(S_ARX_AntiqueTraders_UglyPainting_de23c6d9-2fbb-4594-84ff-61e599e996b8);
DB_ARX_AntiqueTraders_RequstedItem(S_ARX_AntiqueTraders_RustedCup_059478fc-d723-494b-b2dd-644873054582);
DB_ARX_AntiqueTraders_RequstedItem(S_ARX_AntiqueTraders_Scrolls_e48425b1-fe89-4022-a4b2-68e9e7ac23cf);

DB_HasStoryEvent(S_ARX_AntiqueTraders_UglyPainting_de23c6d9-2fbb-4594-84ff-61e599e996b8,"ARX_AntiqueTraders_Has_Painting");
DB_HasStoryEvent(S_ARX_AntiqueTraders_RustedCup_059478fc-d723-494b-b2dd-644873054582,"ARX_AntiqueTraders_Has_Cup");
DB_HasStoryEvent(S_ARX_AntiqueTraders_Scrolls_e48425b1-fe89-4022-a4b2-68e9e7ac23cf,"ARX_AntiqueTraders_Has_Scrolls");

DB_ARX_AntiqueTraders_RequstedItem_Flags("ARX_AntiqueTraders_Has_Painting","QuestUpdate_ARX_AntiqueTraders_GotPainting","ARX_AntiqueTraders_AppraiserGotPainting","QuestUpdate_ARX_AntiqueTraders_TradedPainting");
DB_ARX_AntiqueTraders_RequstedItem_Flags("ARX_AntiqueTraders_Has_Cup","QuestUpdate_ARX_AntiqueTraders_GotCup","ARX_AntiqueTraders_AppraiserGotCup","QuestUpdate_ARX_AntiqueTraders_TradedCup");
DB_ARX_AntiqueTraders_RequstedItem_Flags("ARX_AntiqueTraders_Has_Scrolls","QuestUpdate_ARX_AntiqueTraders_GotScrolls","ARX_AntiqueTraders_AppraiserGotScrolls","QuestUpdate_ARX_AntiqueTraders_TradedScrolls");

SetTagPriceModifier(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_ANTIQUE_ITEM",2000);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_FUR_Cutlery_Fork_A_006_f0b7bd70-f2bb-445c-8dcf-404392915df4);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_FUR_Poor_Plate_A_006_03cb949b-4c64-4557-ade6-0f9886fd3f69);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_FUR_Cutlery_Knife_A_001_0061c337-f26a-4094-90da-fbb0f789bde6);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_CON_Drink_Mug_A_Empty_007_e6fafedd-dfb6-462e-b7de-be9c047e8d63);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_LOOT_Jar_A_006_6ff80671-7494-4426-967c-01a64d2576af);
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(S_Antique_TOOL_Pitchfork_A_000_41034f9a-4a0b-4429-9236-d511d859b810);
CharacterAddGold(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,21531);
CharacterSetCanTrade(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,0);

ItemToInventory(S_ARM_UNIQUE_AntiqueSpecialRing_000_2f155e69-0686-4cb3-999d-36a2e78e67b7,S_ARX_KM_Trader_Antique_01_ee8eebd2-cb85-41f6-87a6-f540017e8821);
ItemToInventory(S_ARM_UNIQUE_AntiqueSpecialBelt_118644b7-980d-44d9-b8e7-c59f391b9efc,S_ARX_KM_Trader_Antique_02_b4a87795-0d90-47c0-a77e-7193a368bd72);

DB_ARX_QuestDef_DeadCharacterUpdates(CHARACTERGUID_S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"QuestUpdate_ARX_AntiqueTraders_AppriserIsDead");
KBSECTION
//REGION Items added to Mechent
IF
DB_ARX_KemmMansion_ChiefTrader_AntiqueItems(_Item)
AND
ItemIsInInventory((ITEMGUID)_Item,0) //For editor when reloading story
THEN
ItemToInventory((ITEMGUID)_Item,S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f);
/*
IF
DB_ARX_KemmMansion_AntiqueTraderOutside(_Trader)
THEN
SetTagPriceModifier((CHARACTERGUID)_Trader,"ARX_ANTIQUE_PRICE_MULTIPLAYER",2);
*/

//END_REGION

//REGION Going to the Celler

IF
CharacterEnteredTrigger(_Player,S_RC_DW_KemmVault_Floor01_84095ddf-39b1-49aa-9840-a8bd5f61f965)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"QuestUpdate_ARX_AntiqueTraders_AppriserToldAboutVault",1)
AND
UserGetFlag(_Player,"ARX_KemmMansion_VB_Celler_LookForVault",0)
THEN
UserSetFlag(_Player,"ARX_KemmMansion_VB_Celler_LookForVault");
StartVoiceBark("ARX_KemmMansion_VB_Celler_LookForVault",_Player);


//END_REGION

//REGION Requested Items
IF
ObjectFlagSet(_Flag,_Player,_ID)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
UserSetFlag(_Player,"ARX_AntiqueTraders_Has_RequestedItem");

IF
ObjectFlagCleared(_Flag,_Player,_ID)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"ARX_AntiqueTraders_Has_Painting",0)
AND
UserGetFlag(_Player,"ARX_AntiqueTraders_Has_Cup",0)
AND
UserGetFlag(_Player,"ARX_AntiqueTraders_Has_Scrolls",0)
THEN
UserClearFlag(_Player,"ARX_AntiqueTraders_Has_RequestedItem",0);

IF
ObjectFlagSet(_Flag,S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,_ID)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_,_,_)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Has_Painting",1)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Has_Cup",1)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Has_Scrolls",1)
THEN
ObjectSetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Have_All_Items");

IF
DialogEnded("ARX_AntiqueTraders_Chief",_ID)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Have_All_Items",1)
THEN
ProcCharacterDisappearOutOfSight(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,180,0,"",0);
ProcCharacterDisappearOutOfSight(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,180,0,"",0);
ProcCharacterFollowCharacter(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f);
SetHasDialog(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,0);
SetHasDialog(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,0);
//END_REGION

//REGION Bodyguard

IF
AttackedByObject(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,_Player,_Summon,_,_)
AND
CharacterIsInCombat(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,0)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterCanSee(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,_Player,1)
THEN
ProcForceStopDialog(_Player);
Proc_CharacterSetTemporaryHostileRelation(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,_Player);
Proc_StartDialog(1,"ARX_AD_AntiqueTraders_Bodyguard",S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4); 

IF
CharacterDied(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f)
AND
CharacterIsInCombat(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,0)
THEN
ProcCharacterDisappearOutOfSight(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,180,0,"",0);
SetHasDialog(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,0);

IF
CharacterDied(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f)
AND
CharacterIsInCombat(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,1)
AND
CombatGetIDForCharacter(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,_CombatID)
THEN
DB_ARX_AntiqueTraders_KemmMansion_Bodyguard_DisappearAfterCombat(_CombatID);

IF
CombatEnded(_CombatID)
AND
DB_ARX_AntiqueTraders_KemmMansion_Bodyguard_DisappearAfterCombat(_CombatID)
THEN
ProcCharacterDisappearOutOfSight(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,180,0,"",0);
SetHasDialog(S_ARX_KemmMansion_Bodyguard_16ce58c4-ff55-4571-ad8f-8c995a75e0e4,0);

//END_REGION

//REGION Journal
IF
ObjectFlagSet("ARX_AntiqueTraders_SpottedInCellar",_Player,_ID)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_AntiqueTraders_MetAppriserInCaller");


//Set Item Update only if she requested them 
IF 
ObjectFlagSet(_Flag,_Player,_Id)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_JournalUpdate,_,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_AntiqueTraders_AppriserToldAboutVault",1)
THEN
ObjectSetFlag(_Player,_JournalUpdate);

IF 
ObjectFlagSet("QuestUpdate_ARX_AntiqueTraders_AppriserToldAboutVault",_Player,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_,_,_)
AND
ObjectGetFlag(_Player,_Flag,1)
THEN
DB_ARX_AntiqueTraders_SetHasFlagAfterDialog(_Player,_Flag);

IF
DialogEnded("ARX_AntiqueTraders_Chief",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
AND
DB_ARX_AntiqueTraders_SetHasFlagAfterDialog((CHARACTERGUID)_Player,_Flag)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_JournalUpdate,_,_)
AND
ObjectGetFlag(_Player,_Flag,1)
THEN
ObjectSetFlag(_Player,_JournalUpdate);

IF
ObjectFlagSet(_Flag,(CHARACTERGUID)_Player,_)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_Flag,_,_,_)
AND
PartyGetFlag(_Player,"ARX_AntiqueTraders_Has_Painting",1)
AND
PartyGetFlag(_Player,"ARX_AntiqueTraders_Has_Cup",1)
AND
PartyGetFlag(_Player,"ARX_AntiqueTraders_Has_Scrolls",1)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_AntiqueTraders_GotAllTheItems");

IF
DialogEnded("ARX_AntiqueTraders_Chief",_)
AND
DB_ARX_AntiqueTraders_SetHasFlagAfterDialog(_Player,_Flag)
THEN
NOT DB_ARX_AntiqueTraders_SetHasFlagAfterDialog(_Player,_Flag);

//END_REGION

//REGION Debug
IF
TextEventSet("ARX_Antique_SpottedInCaller")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_AntiqueTraders_SpottedInCellar");


IF
TextEventSet("ARX_Antique_SpottedInCaller")
AND
DB_IsPlayer(_Player)
THEN
ItemToInventory(ITEMGUID_S_ARX_AntiqueTraders_RustedCup_059478fc-d723-494b-b2dd-644873054582,_Player);
ItemToInventory(ITEMGUID_S_ARX_AntiqueTraders_Scrolls_e48425b1-fe89-4022-a4b2-68e9e7ac23cf,_Player);
ItemToInventory(ITEMGUID_S_ARX_AntiqueTraders_UglyPainting_de23c6d9-2fbb-4594-84ff-61e599e996b8,_Player);


//END_REGION

//REGION Traded journal updates


IF
TradeEnds(_Player,CHARACTERGUID_S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_HasFlag,_,_Global,_)
AND
NOT DB_GlobalFlag(_Global)
AND
ObjectGetFlag(CHARACTERGUID_S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,_HasFlag,1)
THEN
GlobalSetFlag(_Global);
DB_ARX_AntiqueTraders_TradedItem(_Player,_HasFlag);
DB_ARX_AntiqueTraders_CheckTradingUpdates(1);


IF
DialogEnded("ARX_AntiqueTraders_Chief",_)
AND
DB_ARX_AntiqueTraders_CheckTradingUpdates(1)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Have_All_Items",0)
AND
DB_ARX_AntiqueTraders_TradedItem(_Player,_HasFlag)
AND
DB_ARX_AntiqueTraders_RequstedItem_Flags(_HasFlag,_,_,_TradedFlag)
THEN
PartySetFlag(_Player,_TradedFlag);


IF
DialogEnded("ARX_AntiqueTraders_Chief",_Inst)
AND
DB_ARX_AntiqueTraders_CheckTradingUpdates(1)
AND
ObjectGetFlag(S_ARX_KemmMansion_ChiefTrader_46ced128-0571-4e0b-ac7b-96279d92072f,"ARX_AntiqueTraders_Have_All_Items",1)
AND
DB_DialogPlayers(_Inst,_Player,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_AntiqueTraders_AppriserToldAboutVault",1)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_AntiqueTraders_GaveAllTheItems");


IF
DialogEnded("ARX_AntiqueTraders_Chief",_)
AND
DB_ARX_AntiqueTraders_TradedItem(_Player,_HasFlag)
THEN
NOT DB_ARX_AntiqueTraders_TradedItem(_Player,_HasFlag);


IF
DialogEnded("ARX_AntiqueTraders_Chief",_)
THEN
NOT DB_ARX_AntiqueTraders_CheckTradingUpdates(1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
