Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_OriginMomentTag("FTJ_Saheila","LOHSE","FTJ_Saheila_COM_Lohse");
DB_OriginMomentTag("FTJ_Saheila","SHAPESHIFT_LOHSE","FTJ_Saheila_COM_Lohse");
DB_OriginMomentTag("FTJ_Prison_JahanApprentice","LOHSE","FTJ_Prison_JahanApprentice_COM_Lohse");
DB_OriginMomentTag("FTJ_Prison_JahanApprentice","SHAPESHIFT_LOHSE","FTJ_Prison_JahanApprentice_COM_Lohse");
DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE","RC_BF_DemonHunter_COM_Lohse");
DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE_SHAPESHIFT","RC_BF_DemonHunter_COM_Lohse");
DB_OriginMomentTag("RC_BI_River","LOHSE","RC_BI_River_COM_Lohse");
DB_OriginMomentTag("RC_LV_RiverOnBoat","LOHSE","RC_LV_RiverOnBoat_COM_Lohse");
DB_OriginMomentTag("RC_LV_RiverOnBoat","SHAPESHIFT_LOHSE","RC_LV_RiverOnBoat_COM_Lohse");
DB_OriginMomentTag_3SP_HighPriority("ARX_DoctorsHouse_TheDoctor","LOHSE","ARX_DoctorsHouse_TheDoctor_COM_Lohse");
DB_OriginMomentTag_3SP_HighPriority("ARX_DoctorsHouse_TheDoctor","SHAPESHIFT_LOHSE","ARX_DoctorsHouse_TheDoctor_COM_Lohse");

DB_OriginMomentTag_3SP("ARX_DoctorsHouse_TheDoctor", "BEAST", "ARX_DoctorsHouse_TheDoctor_COM_Beast");
DB_OriginDialogTrigger("RC_DW_Tavern_RichMerchant", TRIGGERGUID_S_FTJ_SW_NearZillik_f19a66cf-c53e-483c-9b25-90f2f877900b);
DB_OriginDialogTrigger("ARX_DoctorsHouse_TheDoctor", TRIGGERGUID_ARX_OMs_NearDoctor_382ac1ce-0969-4f25-90ba-dae7b1f1ec7c);

DB_FTJ_LohseSaheilaDialog("FTJ_LohseSaheilaEvent");
DB_FTJ_LohseSaheilaDialog("FTJ_Saheila_COM_Lohse");

DB_OneTimeEventFlag("RC_BF_Lohse_Exorcism_FallAndGetUp");
DB_OneTimeEventFlag("RC_BF_Lohse_Exorcism_Knockdown");
DB_OneTimeEventFlag("RC_BF_Lohse_Exorcism_DemonEffect");
DB_OneTimeEventFlag("RC_BF_Lohse_Exorcism_DemonEffectOff");

DB_OrphanFlagForwarding("FTJ_Prison_JahanApprentice_DidCompanionLohseEvent");

DB_SharedObjectFlags("GLO_Lohse_MetJahan");
KBSECTION
//REGION Region-specific inits
IF
RegionStarted("FJ_FortJoy_Main")
AND
QueryOnlyOnce("FTJ_LohseInit")
THEN
DB_FTJ_SaheilaAllies((CHARACTERGUID)CHARACTERGUID_S_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066);
DB_FTJ_SaheilaAllies(CHARACTERGUID_S_FTJ_Skeptic_Elf_001_d8902155-d0e3-4dfe-b6dd-d90fd5606f50);
DB_DeadEvent(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,"FTJ_Saheila_Dead");
Proc_FTJ_Origins_Lohse_Start();


IF
ObjectFlagSet("FTJ_ElodiReturnedToCave",CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_)
AND
NOT DB_FTJ_SaheilaAllies(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789)
THEN
DB_FTJ_SaheilaAllies(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);

PROC
Proc_FTJ_Origins_Lohse_Start()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
THEN
DB_DoNotFace(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_FTJ_Origins_Lohse_Start()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_LohseWashedAshore");
//END_REGION

//REGION Recruitment
IF
DialogEnded("Lohse_Recruitment",_)
THEN
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohsePlayPossesseddAnimation",0);

IF
ObjectFlagCleared("FTJ_LohsePlayPossesseddAnimation",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Avatar)
AND
NOT DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_Lohse_RecruitedInFortJoy");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Avatar)
AND
DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_Lohse_RecruitedInLV");

IF
DB_OriginRecruitmentLocation_Region("__Shelter",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_,_)
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Lohse", 0)
AND
ObjectGetFlag(_Player,"GLO_Lohse_RecruitedInFortJoy",0)
THEN
ObjectSetFlag(_Player,"QuestAdd_FTJ_COM_Lohse");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Lohse_StartLV");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Lohse", 0)
AND
NOT DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Player,"QuestAdd_FTJ_COM_Lohse");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Lohse_Start");

//END_REGION

//REGION Saheila Moment
PROC
PROC_EndLohseSaheilaMoment()
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,0)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"AVATAR",1)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Lohse",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Lohse_Saheila_Lives");

PROC
PROC_EndLohseSaheilaMoment()
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,1)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"AVATAR",1)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Lohse",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Lohse_Saheila_Dies");

//REGION Track when event is active

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build,3, 6, 0, 1)
AND
DB_FTJ_InLohseSaheilaEvent(1)
THEN
GlobalSetFlag("FTJ_LohseSaheilaEventIsActive");

IF
DialogStarted(_Dialog,_)
AND
DB_FTJ_LohseSaheilaDialog(_Dialog)
THEN
GlobalSetFlag("FTJ_LohseSaheilaEventIsActive");

PROC
PROC_EndLohseSaheilaMoment()
THEN
GlobalClearFlag("FTJ_LohseSaheilaEventIsActive");

//END_REGION

PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
GetRegion(CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,_Region)
AND
_Region == "FJ_FortJoy_Main"
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
QueryOnlyOnce("FTJ_OriginLohseSaheilaEvent")
THEN
ProcForceStopDialog(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);
ProcForceStopDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
Proc_StartDialog(0,"FTJ_LohseSaheilaEvent",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
Proc_LohseSaheilaEventSetUp();

PROC
Proc_LohseSaheilaEventSetUp()
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"AVATAR",0)
THEN
DB_ExcludePlayerForPDD("FTJ_PDD_LohseSaheilaEvent",_Player);

IF
ObjectFlagSet("FTJ_JoinSaheilaInCombat",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
THEN
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_JoinSaheilaInCombat");
ObjectSetFlag(_Avatar,"FTJ_JoinSaheilaInCombat");

IF
ObjectFlagSet("FTJ_JoinSaheilaInCombat",(CHARACTERGUID)_Player,_)
AND
_Player != CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
THEN
DB_FTJ_LohseSaheila_KickLohseOut(_Player);

PROC
Proc_COMFinished("FTJ_Saheila_COM_Lohse",_)
AND
GetFaction(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Faction)
AND
DB_OriginNPCAlignment(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_RecruitmentFaction)
THEN
DB_FTJ_Origins_Lohse_OriginalFaction(_Faction);
SetFaction(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_RecruitmentFaction);
DB_PlayerAlignments_BlockFix(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
CharacterRemoveFromParty(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
CharacterMakeNPC(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);


PROC
Proc_COMFinished("FTJ_Saheila_COM_Lohse",_)
AND
DB_FTJ_LohseSaheila_KickLohseOut(_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player);

IF
DialogEnded("FTJ_LohseSaheilaEvent",_)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
DB_FTJ_InLohseSaheilaEvent(1);
// Say AD only once combat has properly started, and make CombatStarted() check quick
DB_FTJ_OriginsLohseCombatStarted(1);
// Prevent accidentally killing Lohse in case you do too much damage at once
CharacterSetImmortal(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1);
DB_FTJ_SaheilaLohseImmortal(1);


PROC
Proc_COMFinished("FTJ_Saheila_COM_Lohse",_)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
DB_FTJ_InLohseSaheilaEvent(1);
// Say AD only once combat has properly started, and make CombatStarted() check quick
DB_FTJ_OriginsLohseCombatStarted(1);

PROC
Proc_COMFinished("FTJ_Saheila_COM_Lohse",_)
AND
DB_IsPlayer(_Player)
AND
CharacterGetAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player,_Attitude)
THEN
DB_FTJ_Saheila_PreFightAttitude(_Player,_Attitude);

IF
CombatStarted(_ID)
AND
DB_FTJ_OriginsLohseCombatStarted(1)
AND
DB_FTJ_InLohseSaheilaEvent(1)
AND
DB_IsPlayer(_Player)
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
CombatGetIDForCharacter(_Player,_ID)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_ID)
THEN
NOT DB_FTJ_OriginsLohseCombatStarted(1);
Proc_StartDialog(1,"FTJ_AD_SaheilaLohseFightStart",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);

//REGION Add Amyro to allies if he is in the cave
IF
GlobalFlagSet("FTJ_AmyroReturned")
THEN 
DB_FTJ_SaheilaAllies(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a);

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build,3, 6, 0, 1)
AND
DB_CurrentLevel("FJ_FortJoy_Main")
AND
GlobalGetFlag("FTJ_AmyroReturned",1)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,0)
THEN 
DB_FTJ_SaheilaAllies(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a);
//END_REGION

IF
DialogEnded("FTJ_LohseSaheilaEvent",_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_FTJ_SUB_Caverns_e23bceea-0d50-44ab-98b1-260c7f483ff2)
AND
ObjectGetFlag(_Player,"FTJ_JoinLohseInCombat",1)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,_Player);

IF
DialogEnded("FTJ_LohseSaheilaEvent",_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_FTJ_SUB_Caverns_e23bceea-0d50-44ab-98b1-260c7f483ff2)
AND
ObjectGetFlag(_Player,"FTJ_JoinSaheilaInCombat",1)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player);

PROC
Proc_COMFinished("FTJ_Saheila_COM_Lohse",_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
AND
DB_InRegion(_Avatar,TRIGGERGUID_S_FTJ_SUB_Caverns_e23bceea-0d50-44ab-98b1-260c7f483ff2)
AND
ObjectGetFlag(_Avatar,"FTJ_JoinLohseInCombat",1)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,_Avatar);

IF
ObjectLeftCombat(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
AND
CharacterIsInCombat(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0)
AND
DB_FTJ_InLohseSaheilaEvent(1)
THEN
PROC_EndLohseSaheilaMoment();

IF
CharacterReceivedDamage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _, _)
AND
DB_FTJ_InLohseSaheilaEvent(1)
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_HP)
AND
_HP > 50.0
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
Random(2,0)
THEN
Proc_StartDialog(1,"FTJ_AD_SaheilaLohseFightOngoing",CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);

IF
CharacterReceivedDamage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _, _)
AND
DB_FTJ_InLohseSaheilaEvent(1)
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_HP)
AND
_HP <= 50.0
AND
_HP >=30.0
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
QueryOnlyOnce("FTJ_SaheilaLohseEventHalf")
THEN
Proc_StartDialog(1,"FTJ_AD_SaheilaLohseFightHalf",CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);

IF
CharacterReceivedDamage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _, _)
AND
DB_FTJ_InLohseSaheilaEvent(1)
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_HP)
AND
_HP < 30.0
AND
CombatGetIDForCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_ID)
THEN
CharacterSetHitpointsPercentage(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,30.0);
PROC_EndLohseSaheilaMoment();


IF
CharacterDying(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
DB_FTJ_InLohseSaheilaEvent(1)
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseFledSaheilaEvent");

IF
CharacterDied(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
DB_FTJ_InLohseSaheilaEvent(1)
THEN
PROC_EndLohseSaheilaMoment();

IF //IF Saheila Dies The Kids are not comming back after they fled
CharacterDying(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
THEN
ObjectSetFlag(S_FTJ_SkepticChild_002_7f795cf2-db7f-46b6-aa9c-f9d5eefcc789,"GEB_DontAppearAfter");
ObjectSetFlag(S_FTJ_SkepticChild_001_780631fb-3619-4ed1-b48b-f1ff847d4183,"GEB_DontAppearAfter");

// End all combats before adding Lohse to the party, because otherwise we can still get
// attacks of opportunity (even from party members) while Lohse runs back to the party
PROC
PROC_EndLohseSaheilaMoment()
AND
CombatGetIDForCharacter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_ID)
THEN
EndCombat(_ID);

PROC
PROC_EndLohseSaheilaMoment()
THEN
NOT DB_PlayerAlignments_BlockFix(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_FTJ_SaheilaAllies(_Ally)
AND
// Normally they were in the same combat as Lohse, so it should have ended already
CharacterIsInCombat(_Ally,1)
AND
CombatGetIDForCharacter(_Ally,_ID)
THEN
NOT DB_CombatCharacters(_Ally,_ID);
DB_IgnoreAssault(_Ally);
ProcObjectTimer(_Ally,"StopIgnoringAssault",7000);
EndCombat(_ID);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Ally,"StopIgnoringAssault")
THEN
NOT DB_IgnoreAssault(_Ally);

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
AND
DB_FTJ_Origins_Lohse_OriginalFaction(_Faction)
THEN
CharacterMakePlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _Avatar);
SetFaction(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Faction);

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_FTJ_LohseSaheila_KickLohseOut(_Player)
AND
DB_Avatars(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
CharacterMakePlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _Player);

PROC
PROC_EndLohseSaheilaMoment()
AND
CharacterIsDead(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1)
THEN
DB_FTJ_Saheila_LohseDied(1);

IF
CharacterResurrected(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
DB_FTJ_Saheila_LohseDied(1)
THEN
NOT DB_FTJ_Saheila_LohseDied(1);
Proc_Saheila_LohseResurrected();

PROC
Proc_Saheila_LohseResurrected()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
NOT QRY_IsAvailableTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",NULL_00000000-0000-0000-0000-000000000000,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_Saheila_LohseResurrected()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_Saheila_LohseResurrected()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_Saheila_CRD_Lohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_FTJ_Saheila_PreFightAttitude(_Player,_Attitude)
AND
CharacterGetAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player,_Current)
AND
IntegerSubtract(_Attitude,_Current,_Delta)
THEN
NOT DB_FTJ_Saheila_PreFightAttitude(_Player,_Attitude);
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player,_Delta);

PROC
PROC_EndLohseSaheilaMoment()
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,1)
AND
DB_FTJ_SaheilaAllies((CHARACTERGUID)_Char)
AND
CharacterIsDead(_Char,0)
THEN
CharacterMoveTo(_Char,ITEMGUID_S_FTJ_CaveExit_4cc1f8d1-6961-4a18-a1cf-282b2abcc99a,1,"GEN_GoOffStage",2);

PROC
PROC_EndLohseSaheilaMoment()
AND
GetDistanceTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,_Dist)
AND
_Dist > 16.0
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseFledSaheilaEvent");
DebugText(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FLED");

IF
CharacterSawCharacter((CHARACTERGUID)_Player,CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
ObjectGetFlag(_Player,"FTJ_LohseQueueSaheilaFollowUp",1)
AND
QRY_SpeakerIsAvailable(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,1)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",NULL_00000000-0000-0000-0000-000000000000,_Player);

IF
CharacterSawCharacter((CHARACTERGUID)_Player,CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
ObjectGetFlag(_Player,"FTJ_LohseQueueSaheilaFollowUp",1)
AND
QRY_IsAvailableTo(_Player,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,_Player);

IF
DB_Chapter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,5)
THEN
ObjectClearFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseQueueSaheilaFollowUp");

IF
TextEventSet("lohsefollowup")
AND
CharacterGetHostCharacter((CHARACTERGUID)_Player)
THEN
ObjectSetFlag(_Player,"FTJ_LohseQueueSaheilaFollowUp");

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
NOT QRY_IsAvailableTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseFledSaheilaEvent",0)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",NULL_00000000-0000-0000-0000-000000000000,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseFledSaheilaEvent",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_LohseQueueSaheilaFollowUp");

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
QueryOnlyOnce("FTJ_LohseSaheilaEventEnd_Once")
THEN
Proc_StartDialog(0,"FTJ_LohseSaheilaEventEnd_001",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_Saheila_CRD_Lohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
THEN
DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);
DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_Skeptic_Elf_001_d8902155-d0e3-4dfe-b6dd-d90fd5606f50);
DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066);
NOT DB_FTJ_InLohseSaheilaEvent(1);

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestAdd_FTJ_OriginLohse");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_Start");

IF
DialogEnded("FTJ_LohseSaheilaEventEnd_001",_)
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
THEN
ProcDefineReflectionDialog("FTJ_RD_OriginLohseSaheilaEvent",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

IF
DialogEnded("FTJ_LohseSaheilaEventEnd_001",_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
DB_GlobalFlag("FTJ_Saheila_Dead")
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_Saheila_ARD_Ifan",CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
AND
NOT DB_FTJ_LohseSaheila_KickLohseOut(_)
THEN
StartVoiceBark("FTJ_VB_OM_SaheilaLohse_ChoseLohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
PROC_EndLohseSaheilaMoment()
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",0)
AND
DB_FTJ_LohseSaheila_KickLohseOut(_Player)
THEN
StartVoiceBark("FTJ_VB_OM_SaheilaLohse_ChoseSaheila",(CHARACTERGUID)_Player);

PROC
PROC_EndLohseSaheilaMoment()
THEN
GlobalSetFlag("GLO_Lohse_SaheilaEventHappened");

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_FTJ_LohseSaheila_KickLohseOut(_Player)
THEN
NOT DB_FTJ_LohseSaheila_KickLohseOut(_Player);

PROC
PROC_EndLohseSaheilaMoment()
AND
DB_FTJ_SaheilaLohseImmortal(1)
THEN
NOT DB_FTJ_SaheilaLohseImmortal(1);
CharacterSetImmortal(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0);

IF
GlobalFlagSet("FTJ_COM_LohseRunToSaheila")
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,1,"");
//END_REGION

//REGION Lute
IF
DB_Avatars(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
DB_OriginMomentTag("FTJ_GhettoDwarf_001","LOHSE","");

IF
TimerFinished("FTJ_DestroyLute")
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestAdd_FTJ_OriginLohse");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_Lute");

IF
TimerFinished("FTJ_DestroyLute")
AND
DB_CompanionAvatarBond(_Companion,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
QueryOnlyOnce("FTJ_LohseDestroyedLute_ARD_Any")
THEN
Proc_RelationshipDialog(_Companion,"FTJ_LohseDestroyedLute_ARD_Any",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);


///Witch gives discount
IF 
ObjectFlagSet("FTJ_Witch_LohseDiscount",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
THEN 
PartySetShopPriceModifier(CHARACTERGUID_S_FTJ_SW_Witch_4014aee0-56f1-47e0-a8eb-89c4b5a1da83,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,65);
//END_REGION

//REGION Swamp God Meet&Greet
IF
StoryEvent(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"FTJ_DoHoEReturnRD")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_HallOfEchoes");
//END_REGION

//REGION Prison - Jahan Apprentice
PROC
Proc_COMFinished("FTJ_Prison_JahanApprentice_COM_Lohse",(CHARACTERGUID)_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_JahanApprentice");
//END_REGION

//REGION Act 2 Start
IF
DB_Chapter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,5)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
THEN
ProcObjectTimer(_Avatar,"RC_LV_StartAct2_CRD_Lohse",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Avatar,"RC_LV_StartAct2_CRD_Lohse")
THEN
//ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_Act2Start"); // set in RC_LV_StartAct2_CRD_Lohse
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_LV_StartAct2_CRD_Lohse",_Avatar);
//END_REGION

//REGION Jahan & AncestorTree

IF
ObjectFlagSet("Debug_OrigLohseDem",(CHARACTERGUID)_Player,_)
THEN
ObjectClearFlag(_Player,"Debug_OrigLohseDem");
TeleportTo(_Player,TRIGGERGUID_S_RC_BI_CampDemonAppearAtTree_000_f2f1b0cb-093a-4995-97c3-650370dc8b91);
CharacterDie(S_RC_BI_AncestorTree_Blackring_001_5c413561-15bf-4cd7-8db6-f69df9bf978d,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_002_ce4b11ce-0f4b-487b-a67c-4123134e1b8b,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_003_ec71afef-c81f-4c56-b81d-7bc73958478d,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_004_f1ca4587-d0e9-415c-a0c9-c0dd0a992748,1,"DoT");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Lohse_MetJahan");
GlobalSetFlag("RC_BI_AncestorTree_Awoken");

IF
ObjectFlagSet("Debug_OrigLohseDem2",(CHARACTERGUID)_Player,_)
THEN
ObjectClearFlag(_Player,"Debug_OrigLohseDem2");
CharacterDie(S_RC_BI_AncestorTree_Blackring_001_5c413561-15bf-4cd7-8db6-f69df9bf978d,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_002_ce4b11ce-0f4b-487b-a67c-4123134e1b8b,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_003_ec71afef-c81f-4c56-b81d-7bc73958478d,1,"DoT");
CharacterDie(S_RC_BI_AncestorTree_Blackring_004_f1ca4587-d0e9-415c-a0c9-c0dd0a992748,1,"DoT");
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Lohse_MetJahan");
GlobalSetFlag("RC_BI_AncestorTree_Awoken");
PartySetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Lohse_KnowDemonName");
NOT DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE","RC_BF_DemonHunter_COM_Lohse");
NOT DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE_SHAPESHIFT","RC_BF_DemonHunter_COM_Lohse");
DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE","RC_BF_DemonHunter_COM_Lohse");
TeleportTo(_Player,CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633);

IF
ObjectFlagSet("RC_DW_Meistr_FoundListOfSourcerers",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
THEN
PartySetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Lohse_JahanIsSourcerer");

//Companion Received Quest from Jahan
PROC
Proc_COMFinished("RC_BF_DemonHunter_COM_Lohse",_Avatar)
AND
NOT DB_RC_BI_AncestorTreeCOMPreReqs(1)
THEN
DB_RC_BI_AncestorTreeCOMPreReqs(1);
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Lohse_MetJahan");
ProcObjectTimer(_Avatar,"RC_BF_JahanWarnsLohsesAvatar",500);

PROC
ProcObjectTimerFinished(_Avatar,"RC_BF_JahanWarnsLohsesAvatar")
AND
PartyGetFlag((CHARACTERGUID)_Avatar,"GLO_Lohse_KnowDemonName",0)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_MetJahan");

PROC
ProcObjectTimerFinished(_Avatar,"RC_BF_JahanWarnsLohsesAvatar")
AND
PartyGetFlag((CHARACTERGUID)_Avatar,"GLO_Lohse_KnowDemonName",0)
AND
GetDistanceTo(_Avatar,CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633,_Dist)
AND
_Dist < 15.0
THEN
Proc_StartDialog(0,"RC_BF_JahanWarnsLohsesAvatar",CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633,_Avatar);

IF
ObjectFlagSet("RC_BF_Jahan_QuestFinished",_,_)
THEN
DB_RC_BI_AncestorTreeCOMPreReqs(2);

IF
DB_RC_BI_AncestorTreeCOMPreReqs(1)
AND
DB_RC_BI_AncestorTreeCOMPreReqs(2)
THEN
DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE","RC_BF_DemonHunter_COM_Lohse");
DB_OriginMomentTag("RC_BF_DemonHunter","LOHSE_SHAPESHIFT","RC_BF_DemonHunter_COM_Lohse");

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_Lohse_FailedJahanExorcism",_Avatar,_)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_DemonHunter_Exorcism_CRD_Lohse",(CHARACTERGUID)_Avatar);

PROC
Proc_OneTimeEventFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_FallAndGetUp")
THEN
SetStoryEvent(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GEN_FallAndGetUp");

PROC
Proc_OneTimeEventFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_Knockdown")
THEN
SetStoryEvent(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GEN_FallAndLie");

PROC
Proc_OneTimeEventFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_DemonEffect")
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Loshe_Exorcism_01",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_DemonEffect","RC_Main","");

PROC
Proc_OneTimeEventFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_DemonEffectOff")
THEN
PROC_StopLoopEffect(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"RC_BF_Lohse_Exorcism_DemonEffect");
//END_REGION

//REGION Act 2m Start
//Flag for Jahan to talk to Companion Lohse's Bonded Avatar
PROC
Proc_DialogFlagSetup("CoS_LV_Jahan",CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633,(GUIDSTRING)_Player)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Player)
AND
QueryOnlyOnce("GLO_Jahan_LohsesAvatar")
THEN
ObjectSetFlag(_Player,"GLO_Jahan_LohsesAvatar");

IF
DB_Chapter(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,6)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
THEN
ProcObjectTimer(_Avatar,"CoS_LV_StartAct2m_CRD_Lohse",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Avatar,"CoS_LV_StartAct2m_CRD_Lohse")
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"CoS_LV_StartAct2m_CRD_Lohse",_Avatar);
//END_REGION

//REGION CoS Hidden Library
IF
GameBookInterfaceClosed(ITEMGUID_S_CoS_BOOK_ForbiddenLibrary_001_66503ac1-b98d-43ab-8a2f-db9704bd5355,_Character)
AND
GetDistanceTo(_Character,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Dist)
AND
_Dist < 15.0
AND
QueryOnlyOnce("CoS_AD_Library_LohseDemonReacts")
THEN
Proc_StartDialog(1,"CoS_AD_Library_LohseDemonReacts",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
//END_REGION

//REGION Arx start
IF
DialogStarted("ARX_LV_River",_)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_LV_River_LeftLV",0)
AND
PartyGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"GLO_Lohse_KnowDemonName",1)
AND
QueryOnlyOnce("ARX_LV_River_Crash_COM_Lohse")
THEN
DB_OriginMomentTag("ARX_LV_River","LOHSE","ARX_LV_River_Crash_COM_Lohse");
DB_OriginMomentTag("ARX_LV_River","SHAPESHIFT_LOHSE","ARX_LV_River_Crash_COM_Lohse");

PROC
Proc_ARX_TheCrash_NPCLeave()
THEN
NOT DB_OriginMomentTag("ARX_LV_River","LOHSE","ARX_LV_River_Crash_COM_Lohse");
NOT DB_OriginMomentTag("ARX_LV_River","SHAPESHIFT_LOHSE","ARX_LV_River_Crash_COM_Lohse");

IF
DB_OriginMomentTag("ARX_LV_River",_,_)
AND
DB_OriginMoment_COMREQ_Denied(_Lohse,_Malady)
THEN
NOT DB_OriginMoment_COMREQ_Denied(_Lohse,_Malady);
//END_REGION


//REGION State Flags
IF
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Player)
THEN
PartySetFlag(_Player,"GLO_Lohse_InParty");

PROC
Proc_CompanionLeftParty((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,(CHARACTERGUID)_Player)
THEN
PartyClearFlag(_Player,"GLO_Lohse_InParty",0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
