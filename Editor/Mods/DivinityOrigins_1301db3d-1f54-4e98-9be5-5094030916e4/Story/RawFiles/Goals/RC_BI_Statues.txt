Version 1
SubGoalCombiner SGC_AND
INITSECTION
ProcDeclareCounter("RC_BI_Vault_Completed");

AddEntryToCustomBook("RC_BI_Vaults_SongBook_AllTags","RC_BI_Vaults_SongBook_AllTags");
 
//REGION Entrances
DB_BI_Vault_Entrances((ITEMGUID)S_RC_BI_Vault_Statue_001_f54138c5-5aef-4a00-8ac5-3766c05ca3f6,(ITEMGUID)S_RC_BI_Vault_Hatch_001_5bbc793f-ac42-4691-9410-a0bfb38bbf26);
DB_BI_Vault_Entrances(S_RC_BI_Vault_Statue_002_faff8047-034e-4fce-8e0e-9840cdd7349b,S_RC_BI_Vault_Hatch_002_b61caa73-eefb-4480-97fa-7e22d5946c1a);
DB_BI_Vault_Entrances(S_RC_BI_Vault_Statue_003_4c1562f2-349f-49fa-9219-0ed14166b2cb,S_RC_BI_Vault_Hatch_003_03233eb3-647e-4330-876d-fbb137d9cad7);
DB_BI_Vault_Entrances(ITEMGUID_S_RC_BI_Vault_Statue_004_97cdaa15-e5c7-40a5-8da1-b273e781f2b1,ITEMGUID_S_RC_BI_Vault_Hatch_004_abd8dba1-1b89-49fb-ae89-99d2797accf4);
DB_BI_Vault_StatueDestroyedUpdate((ITEMGUID)S_RC_BI_Vault_Statue_001_f54138c5-5aef-4a00-8ac5-3766c05ca3f6,"QuestUpdate_RC_BI_TheVaultAdventurer_OpenSeal");
DB_BI_Vault_StatueDestroyedUpdate((ITEMGUID)S_RC_BI_Vault_Statue_002_faff8047-034e-4fce-8e0e-9840cdd7349b,"QuestUpdate_RC_BI_TheVaultKid_OpenSeal");
DB_BI_Vault_StatueDestroyedUpdate((ITEMGUID)S_RC_BI_Vault_Statue_003_4c1562f2-349f-49fa-9219-0ed14166b2cb,"QuestUpdate_RC_BI_TheVaultGodwoken_OpenSeal");
//END_REGION
//REGION Doors & levers
DB_BI_Vault_DoorsLever((ITEMGUID)S_RC_BI_Vault_Door_001_37c50142-7a81-4614-a2fb-dd9c5202557a,(ITEMGUID)S_RC_BI_Vault_Lever_001_4f43bd22-1613-468b-8a19-41b7500c9cf3,"QUEST_VaultLever_Broken_A_d6d03498-6b62-4232-bb08-4c7d20293399");
DB_BI_Vault_DoorsLever((ITEMGUID)S_RC_BI_Vault_Door_002_fbadd1fb-1b06-4b7a-a0bc-0aaeb76965a8,(ITEMGUID)S_RC_BI_Vault_Lever_002_ae44746c-a239-4654-bd5b-fbc7eb204c3f,"QUEST_VaultLever_Broken_B_b63f003a-9f83-4862-b2e3-2315619345e5");
DB_BI_Vault_DoorsLever((ITEMGUID)S_RC_BI_Vault_Door_003_af886608-4f0f-4edc-aff2-fafa3d732b72,(ITEMGUID)S_RC_BI_Vault_Lever_003_83387865-a734-4af1-a435-5af7432bad4b,"QUEST_VaultLever_Broken_C_9c2d3731-6413-4d30-b767-40550cc52611");
DB_BI_Vault_LeverUpdate((ITEMGUID)S_RC_BI_Vault_Lever_001_4f43bd22-1613-468b-8a19-41b7500c9cf3,"QuestUpdate_RC_BI_TheVaultAdventurer_UsedBrokenLever","QuestUpdate_RC_BI_TheVaultAdventurer_RepairLever","QuestUpdate_RC_BI_TheVaultAdventurer_UsedBrokenLever","QuestUpdate_RC_BI_TheVaultAdventurer_OpenedDoor");
DB_BI_Vault_LeverUpdate((ITEMGUID)S_RC_BI_Vault_Lever_002_ae44746c-a239-4654-bd5b-fbc7eb204c3f,"QuestUpdate_RC_BI_TheVaultKid_UsedBrokenLever","QuestUpdate_RC_BI_TheVaultKid_RepairLever","QuestUpdate_RC_BI_TheVaultKid_UsedEnchantedLever","QuestUpdate_RC_BI_TheVaultKid_OpenedDoor");
DB_BI_Vault_LeverUpdate((ITEMGUID)S_RC_BI_Vault_Lever_003_83387865-a734-4af1-a435-5af7432bad4b,"QuestUpdate_RC_BI_TheVaultGodwoken_UsedBrokenLever","QuestUpdate_RC_BI_TheVaultGodwoken_RepairLever","QuestUpdate_RC_BI_TheVaultGodwoken_UsedEnchantedLever","QuestUpdate_RC_BI_TheVaultGodwoken_OpenedDoor");
//DB_BI_Vault_DoorsLever((ITEMGUID)ITEMGUID_S_RC_BI_Vault_Door_004_30dea32e-2af9-444e-b48d-447e9aec238f,(ITEMGUID)ITEMGUID_S_RC_BI_Vault_Lever_004_adfbcfb4-7d80-4986-9a0b-0eb334122f36,"QUEST_VaultLever_Broken_C_9c2d3731-6413-4d30-b767-40550cc52611");
ItemOpen(ITEMGUID_S_RC_BI_Vault_Door_004_30dea32e-2af9-444e-b48d-447e9aec238f);
ItemSetCanInteract(ITEMGUID_S_RC_BI_Vault_Door_004_30dea32e-2af9-444e-b48d-447e9aec238f,0);
Transform(ITEMGUID_S_RC_BI_Vault_Lever_004_adfbcfb4-7d80-4986-9a0b-0eb334122f36,"QUEST_VaultLever_Repaired_42d170f8-5798-4b8d-994f-b987f522ec52",1);

DB_BI_Vault_LeverGhost((ITEMGUID)S_RC_BI_Vault_Lever_001_4f43bd22-1613-468b-8a19-41b7500c9cf3,(CHARACTERGUID)S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84);
DB_BI_Vault_LeverGhost((ITEMGUID)S_RC_BI_Vault_Lever_002_ae44746c-a239-4654-bd5b-fbc7eb204c3f,(CHARACTERGUID)S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81);
DB_BI_Vault_LeverGhost((ITEMGUID)S_RC_BI_Vault_Lever_003_83387865-a734-4af1-a435-5af7432bad4b,(CHARACTERGUID)S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc);
//END_REGION
//REGION Areas
DB_BI_Vault_Areas((TRIGGERGUID)S_RC_BI_Vault_Area_001_853b8a41-6591-4e2c-a149-9841dc7f8655);
DB_BI_Vault_Areas((TRIGGERGUID)S_RC_BI_Vault_Area_002_58f8c677-8c3a-4bb9-ac19-673d1635f72c);
DB_BI_Vault_Areas((TRIGGERGUID)S_RC_BI_Vault_Area_003_01202eb7-1bf4-4985-a642-2e70fdcd0781);
DB_BI_Vault_Areas((TRIGGERGUID)S_RC_BI_Vault_Area_004_00a88ef6-bc40-4a72-b039-c063075d0833);
//END_REGION
DB_PossessedDemon((CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_Demon_001_01c5d4d3-425f-42fd-8200-528b14aafec8);

DB_PossessedGhost(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,CHARACTERGUID_S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84);
DB_PossessedGhost(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,CHARACTERGUID_S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81);
DB_PossessedGhost(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,CHARACTERGUID_S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc);


DB_Ghosts(S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84,"RC_BI_Vault_Ghost_001");
DB_Ghosts(S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81,"RC_BI_Vault_Ghost_002");
DB_Ghosts(S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc,"RC_BI_Vault_Ghost_003");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_BI_Vault_Prison_001_ed3c583a-2c8d-4022-8cc1-07e15849ad2b);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_BI_Vault_Prison_002_84d2cd3a-c3e1-42e4-ad67-5a7393baeeea);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_BI_Vault_Prison_003_0f989d97-4c51-4fef-9124-3d15a03238c8);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_BI_Vault_Prison_004_46f34536-7940-471e-9baa-7689f6e20cb5);


DB_BI_Vault_VampirismDamage(100);

DB_Dialogs(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,"RC_BI_Vault_Possessed_002");
DB_Dialogs(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,"RC_BI_Vault_Possessed_003");
DB_Dialogs(CHARACTERGUID_S_RC_BI_Vault_Cat_de900e03-eb64-4515-a2f6-7be33c72f7a1,"RC_BI_Vault_Cat");

//REGION Pillars
DB_RC_BI_Vault_PillarsDestroyedUpdate(1,"QuestUpdate_RC_BI_TheVaultAdventurer_DestroyedPillars");
DB_RC_BI_Vault_PillarsDestroyedUpdate(2,"QuestUpdate_RC_BI_TheVaultKid_DestroyedPillars");
DB_RC_BI_Vault_PillarsDestroyedUpdate(3,"QuestUpdate_RC_BI_TheVaultGodwoken_DestroyedPillars");

DB_RC_BI_Vault_Pillars((ITEMGUID)ITEMGUID_S_RC_BI_Vault_001_Pillar_1_64ba83d3-0ce4-4991-8596-19a625e4e359,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84,"RC_BI_Vault_001_Pillar_1",1);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_001_Pillar_2_2deeae6b-0d16-4d74-8d72-0efbbae537d9,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,CHARACTERGUID_S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84,"RC_BI_Vault_001_Pillar_2",1);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_001_Pillar_3_923d5f19-29dd-4441-9256-53d1c288894f,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,CHARACTERGUID_S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84,"RC_BI_Vault_001_Pillar_3",1);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_001_Pillar_4_8d5000cf-a519-4146-b077-4d078ec8cb74,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,CHARACTERGUID_S_RC_BI_Vault_Ghost_001_28a0a573-7f60-4516-b68e-537f57e5db84,"RC_BI_Vault_001_Pillar_4",1);

DB_RC_BI_Vault_Pillars_Count(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,4,"RC_BI_Vault_001_Shackled");

DB_RC_BI_Vault_Pillars((ITEMGUID)ITEMGUID_S_RC_BI_Vault_002_Pillar_1_26fa2b71-c3c4-4eb9-b75c-5207976a0e21,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81,"RC_BI_Vault_002_Pillar_1",2);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_002_Pillar_2_346fe8b5-ca30-46e5-bebb-cf67eef99f44,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,CHARACTERGUID_S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81,"RC_BI_Vault_002_Pillar_2",2);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_002_Pillar_3_51492ff5-576e-40f7-904b-6809fc397dc1,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,CHARACTERGUID_S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81,"RC_BI_Vault_002_Pillar_3",2);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_002_Pillar_4_906ef4c9-03b4-4a81-9e8d-6f1bcd3fa66f,CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,CHARACTERGUID_S_RC_BI_Vault_Ghost_002_b5697652-50a0-4db5-a195-9584b56f7c81,"RC_BI_Vault_002_Pillar_4",2);

DB_RC_BI_Vault_Pillars_Count(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_002_1bfd9e78-846f-4f24-82db-6ebb48ddc203,4,"RC_BI_Vault_002_Shackled");

DB_RC_BI_Vault_Pillars((ITEMGUID)ITEMGUID_S_RC_BI_Vault_003_Pillar_1_34266b5f-1db1-4c7d-b5fc-c82d271ca4e4,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,(CHARACTERGUID)CHARACTERGUID_S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc,"RC_BI_Vault_003_Pillar_1",3);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_003_Pillar_2_8fd41645-db15-4525-99e0-b33d099e81d3,CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,CHARACTERGUID_S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc,"RC_BI_Vault_003_Pillar_2",3);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_003_Pillar_3_482cef46-f975-442b-aa9d-3c019693f2f9,CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,CHARACTERGUID_S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc,"RC_BI_Vault_003_Pillar_3",3);
DB_RC_BI_Vault_Pillars(ITEMGUID_S_RC_BI_Vault_003_Pillar_4_e0596ccb-7343-4aec-8ce5-7909cf21070c,CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,CHARACTERGUID_S_RC_BI_Vault_Ghost_003_9f9f0a92-4985-4f7d-9102-e6c6dcb381bc,"RC_BI_Vault_003_Pillar_4",3);

DB_RC_BI_Vault_Pillars_Count(CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,4,"RC_BI_Vault_003_Shackled");
//END_REGION
DB_KilledEvent(CHARACTERGUID_S_RC_BI_Vault_PosessedPerson_001_f0d1f343-fc73-4c09-8d13-ed37bf51ae25,"QuestUpdate_RC_BI_TheVaultAdventurer_KilledAdventurer");
DB_KilledEvent(CHARACTERGUID_S_RC_BI_Vault_Cat_de900e03-eb64-4515-a2f6-7be33c72f7a1,"QuestUpdate_RC_BI_TheVaultKid_KilledCat");
DB_KilledEvent(CHARACTERGUID_S_RC_BI_Vault_PossessedPerson_003_019e266d-2d45-4818-a778-2cebffdcd743,"QuestUpdate_RC_BI_TheVaultGodwoken_KilledGodwoken");

DB_Dialogs(ITEMGUID_S_RC_BI_AncientForge_2ede0521-33b0-42f5-b21e-597fd0d34b63,"RC_BI_AncientForge");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_RC_BI_VB_Forge_bc44ed50-393b-4207-aa46-b060a61b34de,"RC_BI_VB_AncientForge");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_BI_Forge_Journal_0ab08169-35f1-4e77-b389-b1c502e99052);
DB_RC_BI_Vault_ForgeJournal(1,"QuestUpdate_RC_BI_TheVaults_FoundForgeRecipe"); //DB_RC_BI_Vault_ForgeJournal(_State,_Flag)
DB_RC_BI_Vault_ForgeJournal(0,"QuestUpdate_RC_BI_TheVaults_FoundForgeNoRecipe");
KBSECTION
//REGION Generic Quest Updates 

IF
ObjectFlagSet("QuestUpdate_RC_BI_TheVaults_KilledAdventurer",_Player,_)
AND
NOT DB_OnlyOnce("RC_BI_Vault_001_Completed")
THEN
ProcIncreaseCounter("RC_BI_Vault_Completed");
ObjectSetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne");
DB_OnlyOnce("RC_BI_Vault_001_Completed"); 

IF
ObjectFlagSet("QuestUpdate_RC_BI_TheVaults_SavedAdventurer",_Player,_)
AND
NOT DB_OnlyOnce("RC_BI_Vault_001_Completed")
THEN
ProcIncreaseCounter("RC_BI_Vault_Completed");
ObjectSetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne");
DB_OnlyOnce("RC_BI_Vault_001_Completed");

IF
ObjectFlagSet("QuestUpdate_RC_BI_TheVaults_TookKid",_Player,_)
AND
NOT DB_OnlyOnce("RC_BI_Vault_002_Completed")
THEN
ProcIncreaseCounter("RC_BI_Vault_Completed");
ObjectSetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne");
DB_OnlyOnce("RC_BI_Vault_002_Completed");

IF
ObjectFlagSet("QuestUpdate_RC_BI_TheVaults_KilledGodwoken",_Player,_)
AND
NOT DB_OnlyOnce("RC_BI_Vault_003_Completed") 
THEN
ProcIncreaseCounter("RC_BI_Vault_Completed");
ObjectSetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne");
DB_OnlyOnce("RC_BI_Vault_003_Completed");

//END_REGION

//REGION Statue Markers

IF
CharacterUsedItem(_Player,S_RC_BI_Vault_Statue_001_f54138c5-5aef-4a00-8ac5-3766c05ca3f6)
THEN
ProcShowMarker(_Player,"RC_BI_Vault_001");

IF
CharacterUsedItem(_Player,S_RC_BI_Vault_Statue_002_faff8047-034e-4fce-8e0e-9840cdd7349b)
THEN
ProcShowMarker(_Player,"RC_BI_Vault_002");

IF
CharacterUsedItem(_Player,S_RC_BI_Vault_Statue_003_4c1562f2-349f-49fa-9219-0ed14166b2cb)
THEN
ProcShowMarker(_Player,"RC_BI_Vault_003");

IF
DB_GlobalCounter("RC_BI_Vault_Completed",3)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_Completed");
ProcHideMarker(_Player,"RC_BI_Vault_001");
ProcHideMarker(_Player,"RC_BI_Vault_002");
ProcHideMarker(_Player,"RC_BI_Vault_003");

//END_REGION

IF
DB_RC_BI_Vault_Pillars(_Pillar,_,_,_,_)
THEN
ItemSetForceSynch(_Pillar,1);

IF
DB_PossessedGhost(_Ghost,_)
THEN
CharacterSetForceSynch((CHARACTERGUID)_Ghost,1);

PROC
ProcRegionEnded("RC_Main")
AND
DB_RC_BI_Vault_Pillars(_Pillar,_,_,_,_)
THEN
ItemSetForceSynch(_Pillar,0);

PROC
ProcRegionEnded("RC_Main")
AND
DB_PossessedGhost(_Ghost,_)
AND
NOT DB_Dead((CHARACTERGUID)_Ghost)
THEN
CharacterSetForceSynch(_Ghost,0);

IF
CharacterEnteredTrigger(_Player,S_RC_BI_BloodIslandRegion_9c0a84b1-314c-4262-b33b-26cfcdfc10ee)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne",1)
AND
PartyGetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne_RD",0)
THEN
ProcDefineReflectionDialog("RC_BI_RD_Vault_CompletedAtLeastOne",_Player);
PartySetFlag(_Player,"RC_BI_Vault_CompletedAtLeastOne_RD");

//REGION Song

IF
CharacterUsedItem(_Player,_Book)
AND
GetTemplate(_Book,"QUEST_BOOK_RC_BI_Hymn_49ed93f4-ecaf-4119-9066-4067d76ed2ca")
AND
IsTagged(_Player,"SCHOLAR",1)
THEN
//CloseUI(_Player,"Book"); - don't work
OpenCustomBookUI(_Player,"RC_BI_Vaults_SongBook_AllTags");
ObjectSetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_LearnedHymn");

//END_REGION

//REGION Vault Exterior

IF
DB_BI_Vault_Entrances((ITEMGUID)_Statue,_Hatch)
THEN
ItemSetCanInteract(_Hatch,0);
//SetVarFixedString(_Statue,"StatusOnInit","HOLY_FIRE");

IF
CharacterUsedItem(_Player,_Statue)
AND
DB_BI_Vault_Entrances(_Statue,_Hatch)
THEN
//Proc_StartDialog(1,"RC_BI_AD_Vault_Statue_Generic",_Player);
Proc_StartDialog(0,"RC_BI_Vault_Statue_Generic",_Statue,_Player);
ObjectSetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_DiscoveredStatues");

IF
ObjectFlagSet("RC_BI_Vault_Destroy",(ITEMGUID)_Statue,_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
AND
DB_BI_Vault_StatueDestroyedUpdate(_Statue,_Update)
THEN
ItemSetCanInteract(_Statue,0);
DialogRequestStop(_Statue);
ProcObjectTimer(_Statue,"Timer_RC_BI_VaultDamage",1000);
PartySetFlag((CHARACTERGUID)_Player,_Update);

PROC
ProcObjectTimerFinished((ITEMGUID)_Statue,"Timer_RC_BI_VaultDamage")
//AND
//HasActiveStatus(_Statue,"NECROFIRE",1)
AND
DB_BI_Vault_Entrances(_Statue,_Hatch)
AND
GetPosition(_Statue,_X,_Y,_Z)
THEN
ItemDestroy(_Statue);
PlayScaledEffectAtPosition("RS3_FX_GP_Impacts_InfectiousFlame_01",1.5,_X,_Y,_Z);

IF
ItemDestroyed(_Statue)
AND
DB_BI_Vault_Entrances(_Statue,_Hatch)
THEN
NOT DB_BI_Vault_Entrances(_Statue,_Hatch);
ItemSetCanInteract(_Hatch,1);


IF
DialogEnded("RC_BI_Vault_Statue_Generic",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(ITEMGUID)_Statue)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"RC_BI_Vault_SangSong",0)
AND
ObjectGetFlag(_Statue,"RC_BI_Vault_Destroy",1)
THEN
StartVoiceBark("RC_BI_VB_Vault_Statue_Song",_Player);
UserSetFlag(_Player,"RC_BI_Vault_SangSong");

PROC
ProcObjectTimerFinished(_Statue,"Timer_RC_BI_VaultDamage")
AND
HasActiveStatus(_Statue,"NECROFIRE",0)
THEN
ProcObjectTimerCancel(_Statue,"Timer_RC_BI_VaultDamage");

//END_REGION

//REGION Vault Interior

IF
DB_BI_Vault_Areas(_Area)
THEN
ProcTriggerRegisterForPlayers(_Area);

IF
DB_BI_Vault_DoorsLever(_Door,_,_)
THEN
ItemSetCanInteract(_Door,0);

IF
DB_PossessedDemon(_Possessed,_Demon)
THEN
SetOnStage(_Demon,0);
ProcCharacterDisableAllCrimes(_Possessed);

IF
DialogEnded(_Dialog,_ID)
AND
DB_Ghosts(_Ghost,_Dialog)
AND
DB_BI_Vault_LeverGhost(_Lever,_Ghost)
AND
ObjectGetFlag(_Ghost,"RC_BI_Vault_Persuaded",1)
AND
ObjectGetFlag(_Ghost,"RC_BI_Vault_Opened",0)
THEN
ObjectSetFlag(_Lever,"RC_BI_Vault_Unsealed");
ObjectSetFlag(_Ghost,"RC_BI_Vault_Opened");
SetHasDialog(_Ghost,0);
CharacterUseItem(_Ghost,_Lever,"RC_BI_Vault_LeverUsed");

IF
StoryEvent(_Ghost,"RC_BI_Vault_LeverUsed")
THEN
SetHasDialog(_Ghost,1);

// Temporal solution for the voice bark's appearance on random triggers

IF
CharacterEnteredTrigger(_Player,S_RC_BI_Vault_Area_001_853b8a41-6591-4e2c-a149-9841dc7f8655)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_BI_TheVaultAdventurer_EnterVault");
Proc_BI_VaultEnter(_Player);

IF
CharacterEnteredTrigger(_Player,S_RC_BI_Vault_Area_002_58f8c677-8c3a-4bb9-ac19-673d1635f72c)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_BI_TheVaultKid_EnterVault");
Proc_BI_VaultEnter(_Player);

IF
CharacterEnteredTrigger(_Player,S_RC_BI_Vault_Area_003_01202eb7-1bf4-4985-a642-2e70fdcd0781)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_BI_TheVaultGodwoken_EnterVault");
Proc_BI_VaultEnter(_Player);

IF
CharacterEnteredTrigger(_Player,S_RC_BI_Vault_Area_004_00a88ef6-bc40-4a72-b039-c063075d0833)
AND
UserGetFlag(_Player,"RC_BI_SawEmptyVault",0)
THEN
UserSetFlag(_Player,"RC_BI_SawEmptyVault");
StartVoiceBark("RC_BI_VB_EmptyVault",_Player);
 
PROC
Proc_BI_VaultEnter((CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"RC_BI_SawVault",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_LearnedAboutVaults",0)
THEN
UserSetFlag(_Player,"RC_BI_SawVault");
StartVoiceBark("RC_BI_VB_Vault",_Player);
ObjectSetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_DiscoveredRuins");

PROC
Proc_BI_VaultEnter((CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"RC_BI_SawVault",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_LearnedAboutVaults",1)
THEN
UserSetFlag(_Player,"RC_BI_SawVault");
StartVoiceBark("RC_BI_VB_Vault_Seen",_Player);
ObjectSetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_DiscoveredRuins");

IF
CharacterGhostDestroyed(_Ghost,_Ghost)
AND
DB_BI_Vault_LeverGhost(_Lever,_Ghost)
AND
DB_BI_Vault_DoorsLever(_Door,_Lever,_)
THEN
PlayEffect(_Lever,"RS3_FX_GP_ScriptedEvent_Source_Absorb_01");
ObjectSetFlag(_Lever,"RC_BI_Vault_Unsealed");

IF
CharacterUsedItem(_Ghost,_Lever)
AND
DB_BI_Vault_DoorsLever(_Door,_Lever,_)
AND
ObjectGetFlag(_Ghost,"RC_BI_Vault_Persuaded",1)
THEN
ItemOpen(_Door);
PlayEffect(_Lever,"RS3_FX_GP_ScriptedEvent_Source_Absorb_01");

IF
CharacterUsedItem(_Character,_Lever)
AND
DB_BI_Vault_DoorsLever(_Door,_Lever,_)
AND
ObjectGetFlag(_Character,"RC_BI_Vault_Persuaded",0)
THEN
Proc_RC_BI_Vault_UseLever(_Door,_Lever,_Character);

IF
ItemTemplateCombinedWithItemTemplate(_LeverTemplate,"QUEST_RC_BI_LeverShaft_292e3398-730c-4a74-a48a-ee8adb2f7bce",_,_,_,_Player,_)
AND
DB_BI_Vault_DoorsLever(_Door,_Lever,_LeverTemplate)
AND
DB_BI_Vault_LeverGhost(_Lever,_Ghost)
AND
DB_BI_Vault_LeverUpdate(_Lever,_,_RepairedUpdate,_,_)
AND
GetItemForItemTemplateInPartyInventory(_Player,"QUEST_RC_BI_LeverShaft_292e3398-730c-4a74-a48a-ee8adb2f7bce",_Shaft)
THEN
PartySetFlag(_Player,_RepairedUpdate);
Transform(_Lever,"QUEST_VaultLever_Repaired_42d170f8-5798-4b8d-994f-b987f522ec52",1);
ItemDestroy(_Shaft);
PlayEffect(_Lever,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");
ObjectSetFlag(_Lever,"RC_BI_Vault_Repaired",1);
ObjectSetFlag(_Ghost,"RC_BI_Vault_Repaired",1);
CloseUI(_Player,"Crafting");

PROC
Proc_RC_BI_Vault_UseLever((ITEMGUID)_Door,(ITEMGUID)_Lever,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Lever,"RC_BI_Vault_Repaired",0)
AND
DB_BI_Vault_LeverUpdate(_Lever,_BrokenUpdate,_,_,_)
THEN
Proc_StartDialog(0,"RC_BI_Vault_Lever_Generic",_Lever,_Player);
PartySetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_UsedBrokenLever");
PartySetFlag(_Player,_BrokenUpdate);

IF
ObjectFlagSet("RC_BI_Vault_Lever_Repair",(ITEMGUID)_Lever,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
DialogRequestStop(_Player);
OpenCraftUI(_Player,_Lever);
ObjectClearFlag(_Lever,"RC_BI_Vault_Lever_Repair");

PROC
Proc_RC_BI_Vault_UseLever(_Door,_Lever,_Player)
AND
ObjectGetFlag(_Lever,"RC_BI_Vault_Repaired",1)
AND
ObjectGetFlag(_Lever,"RC_BI_Vault_Unsealed",0)
AND
DB_BI_Vault_LeverUpdate(_Lever,_,_,_EnchantedUpdate,_)
THEN
SetVarInteger(_Lever,"WantedState",0);
PlayEffect(_Lever,"RS3_FX_GP_ScriptedEvent_Source_Absorb_01");
Proc_StartDialog(1,"RC_BI_AD_Vault_Lever_Enchanted",_Player);
PartySetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_UsedEnchantedLever");
PartySetFlag(_Player,_EnchantedUpdate);

PROC
Proc_RC_BI_Vault_UseLever(_Door,_Lever,_Player)
AND
ObjectGetFlag(_Lever,"RC_BI_Vault_Repaired",1)
AND
ObjectGetFlag(_Lever,"RC_BI_Vault_Unsealed",1)
AND
DB_BI_Vault_LeverUpdate(_Lever,_,_,_,_DoorOpenedUpdate)
THEN
ItemOpen(_Door);
PartySetFlag(_Player,_DoorOpenedUpdate);

IF
CharacterDied(_Possessed)
AND
DB_PossessedGhost(_Possessed,_Ghost)
AND
DB_RC_BI_Vault_Pillars_Count(_Possessed,_Num,_)
AND
_Num <= 0
AND
ObjectGetFlag(_Possessed,"RC_BI_DemonReleased",0)
THEN
CharacterSetForceSynch(_Possessed,0);
ObjectSetFlag(_Possessed,"RC_BI_DemonReleased",1);
ObjectSetFlag(_Ghost,"RC_BI_PossessedDied",1);

IF
ObjectFlagSet("RC_BI_DemonReleased",(CHARACTERGUID)_Possessed,_)
AND
DB_PossessedDemon(_Possessed,_Demon)
AND
DB_PossessedGhost(_Possessed,_Ghost)
THEN
ProcCharacterDisableAllCrimes(_Possessed);
ObjectSetFlag(_Ghost,"RC_BI_DemonReleased");
PlayEffect(_Possessed,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");
ApplyStatus(_Possessed,"KNOCKED_DOWN",10.0,1);
SetFaction(_Possessed, "Good NPC");
TeleportTo(_Demon,_Possessed);
SetOnStage(_Demon,1);
PlayEffect(_Demon,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");

IF
CharacterDied(_Demon)
AND
DB_PossessedDemon(_Possessed,_Demon)
AND
DB_PossessedGhost(_Possessed,_Ghost)
THEN
ObjectSetFlag(_Ghost,"RC_BI_DemonDied");
ObjectSetFlag(_Possessed,"RC_BI_DemonDied");

IF
CharacterDied(_Possessed)
AND
DB_PossessedGhost(_Possessed,_Ghost)
THEN
ObjectSetFlag(_Ghost,"RC_BI_PossessedDied");

//END_REGION

//REGION Vault Inner Chamber

PROC
PROC_RC_BI_DestroyShackles((ITEMGUID)_Pillar)
AND
DB_RC_BI_Vault_Pillars(_Pillar,_Prisoner,_Posessed,_Flag,_QuestNum) 
AND
DB_RC_BI_Vault_Pillars_Count(_Prisoner,_Num,_OtherFlag)
AND
IntegerSubtract(_Num,1,_NewNum)
THEN
ItemSetForceSynch(_Pillar,0);
NOT DB_RC_BI_Vault_Pillars_Count(_Prisoner,_Num,_OtherFlag);
DB_RC_BI_Vault_Pillars_Count(_Prisoner,_NewNum,_OtherFlag);
NOT DB_RC_BI_Vault_Pillars(_Pillar,_Prisoner,_Posessed,_Flag,_QuestNum);
PROC_StopLoopBeamEffect(_Pillar,_Flag);
PROC_StopLoopEffect(_Pillar,_Flag);
PlayEffect(_Pillar,"RS3_FX_GP_ScriptedEvent_RC_BI_Vault_PillarDestruction_01");
PlayEffect(_Pillar,"RS3_FX_GP_ScriptedEvent_Source_Absorb_01");

IF
DB_RC_BI_Vault_Pillars_Count(_Prisoner,_Num,_Flag)
AND
_Num > 0
THEN
SetCanFight(_Prisoner,0);

IF
DB_RC_BI_Vault_Pillars_Count(_Prisoner,_Num,_Flag)
AND
_Num > 0
AND
HasActiveStatus(_Prisoner,"QUEST_SOURCECHAIN",0)
THEN
ApplyStatus(_Prisoner,"QUEST_SOURCECHAIN",-1.0);

IF
CharacterGhostDestroyed(_,_Ghost)
AND
DB_RC_BI_Vault_Pillars((ITEMGUID)_Pillar,_Prisoner,_Ghost,_Flag,_QuestNum)
THEN
ItemDestroy(_Pillar);

IF
ItemDestroying(_Pillar)
AND
DB_RC_BI_Vault_Pillars(_Pillar,_Prisoner,_Ghost,_Flag,_QuestNum)
THEN
PROC_RC_BI_DestroyShackles(_Pillar);


IF
AttackedByObject((ITEMGUID)_Pillar,(CHARACTERGUID)_Player,_,_,_)
AND
DB_RC_BI_Vault_Pillars(_Pillar,_,_,_,_QuestNum)
AND
DB_IsPlayer(_Player)
AND
ItemGetHealthPoints(_Pillar,_INT)
AND
_INT < 1
THEN
Proc_RC_BI_Vault_SetBrokenPillarsUpdate(_Player,_Pillar,_QuestNum);


PROC
Proc_RC_BI_Vault_SetBrokenPillarsUpdate((CHARACTERGUID)_Player,(ITEMGUID)_Pillar,(INTEGER)_QuestNum)
AND
NOT QRY_RC_BI_Vault_OtherPillarLeft(_Pillar,_QuestNum)
AND
DB_RC_BI_Vault_PillarsDestroyedUpdate(_QuestNum,_Update)
THEN
PartySetFlag(_Player,_Update);


QRY
QRY_RC_BI_Vault_OtherPillarLeft((ITEMGUID)_Pillar,(INTEGER)_QuestNum)
AND
DB_RC_BI_Vault_Pillars(_OtherPillar,_,_,_,_QuestNum)
AND
_OtherPillar != _Pillar
THEN
DB_NOOP(1);


IF
DB_RC_BI_Vault_Pillars_Count(_Prisoner,0,_Flag)
THEN
SetCanFight(_Prisoner,1);
ObjectSetFlag(_Prisoner,"RC_BI_Vault_ChainsDestroyed");
RemoveStatus(_Prisoner,"QUEST_SOURCECHAIN");

IF
CharacterEnteredTrigger(_,TRIGGERGUID_S_RC_BI_BloodIslandRegion_9c0a84b1-314c-4262-b33b-26cfcdfc10ee)
AND
QueryOnlyOnce("RC_BI_VaultFXSetup")
AND
DB_RC_BI_Vault_Pillars(_Pillar,_Prisoner,_Ghost,_Flag,_QuestNum)
AND
CharacterIsDead(_Prisoner,0)
THEN
PROC_LoopBeamEffect("RS3_FX_GP_ScriptedEvent_ChainedDragon_Beam_01",_Pillar,_Prisoner,"","Dummy_NeckFX",_Flag,"RC_Main");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_SourceGlow_Overlay_01",_Pillar,_Flag,"RC_Main","");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_SourcePillar_02",_Pillar,_Flag,"RC_Main","");

//END_REGION

//REGION Crafting the shaft

IF
ObjectFlagSet("RC_BI_OpenForge",(CHARACTERGUID)_Player,_)
THEN
ObjectClearFlag(_Player,"RC_BI_OpenForge");
OpenCraftUI(_Player,ITEMGUID_S_RC_BI_AncientForge_2ede0521-33b0-42f5-b21e-597fd0d34b63);

IF
ItemTemplateCombinedWithItemTemplate(_Root,_,_,_,_,_Player,_)
AND
_Root == "QUEST_RC_BI_AncientForge_71dcfd2d-451b-4408-8ae2-996020de3178"
THEN
PROC_LoopEffect("RS3_FX_LTS_Coal_Basket_D_01",TRIGGERGUID_S_RC_BI_AncientForge_Point_e07dffc4-20cc-4b9c-b9e7-ff850099937c,"RC_BI_ForgeFire","RC_Main","");
TimerLaunch("RC_BI_ForgeFired",5000);

IF
TimerFinished("RC_BI_ForgeFired")
THEN
PROC_StopLoopEffect(TRIGGERGUID_S_RC_BI_AncientForge_Point_e07dffc4-20cc-4b9c-b9e7-ff850099937c,"RC_BI_ForgeFire");

IF
ItemTemplateCombinedWithItemTemplate(_,_,_,_,_,_Player,_Item)
AND
GetTemplate(_Item,_Root)
AND
_Root == "QUEST_RC_BI_LeverShaft_292e3398-730c-4a74-a48a-ee8adb2f7bce"
AND
UserGetFlag(_Player,"RC_BI_AncientForgeCrafted",0)
THEN
UserSetFlag(_Player,"RC_BI_AncientForgeCrafted");
StartVoiceBark("RC_BI_VB_AncientForgeShaft",_Player);

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_BI_AncientForge_2ede0521-33b0-42f5-b21e-597fd0d34b63)
THEN
ProcShowMarker(_Player,"RC_BI_AncientForge");
//END_REGION

//REGION Journal for encountering the Forge

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_BI_Forge_Journal_0ab08169-35f1-4e77-b389-b1c502e99052)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"QuestUpdate_RC_BI_TheVaults_DiscoveredShaftRecipe",_State)
AND
DB_RC_BI_Vault_ForgeJournal(_State,_Flag)
THEN
PartySetFlag(_Player,_Flag);

//END_REGION

/*IF
DB_BI_Vault_DoorsLever(ITEMGUID_S_RC_BI_Vault_Door_004_30dea32e-2af9-444e-b48d-447e9aec238f,ITEMGUID_S_RC_BI_Vault_Lever_004_adfbcfb4-7d80-4986-9a0b-0eb334122f36,"QUEST_VaultLever_Broken_C_9c2d3731-6413-4d30-b767-40550cc52611")
THEN
Transform(ITEMGUID_S_RC_BI_Vault_Lever_004_adfbcfb4-7d80-4986-9a0b-0eb334122f36,"QUEST_VaultLever_Repaired_42d170f8-5798-4b8d-994f-b987f522ec52",1);
ObjectSetFlag(ITEMGUID_S_RC_BI_Vault_Lever_004_adfbcfb4-7d80-4986-9a0b-0eb334122f36,"RC_BI_Vault_Repaired",1);
ItemOpen(ITEMGUID_S_RC_BI_Vault_Door_004_30dea32e-2af9-444e-b48d-447e9aec238f);*/
//
IF 
DB_BI_Vault_Entrances(ITEMGUID_S_RC_BI_Vault_Statue_004_97cdaa15-e5c7-40a5-8da1-b273e781f2b1,ITEMGUID_S_RC_BI_Vault_Hatch_004_abd8dba1-1b89-49fb-ae89-99d2797accf4)
THEN
ItemDestroy(S_RC_BI_Vault_Statue_004_97cdaa15-e5c7-40a5-8da1-b273e781f2b1);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
