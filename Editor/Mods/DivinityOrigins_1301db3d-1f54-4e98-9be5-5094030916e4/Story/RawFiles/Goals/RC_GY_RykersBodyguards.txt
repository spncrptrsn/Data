Version 1
SubGoalCombiner SGC_AND
INITSECTION
// https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/graveyard---ryker-s-contract
// https://www.lucidchart.com/documents/edit/1a47e3d7-089a-49c7-907a-ba1622929174#
// See also RC_GY_Ryker, RC_GY_RykersContract

// Ryker's bodyguards
DB_RC_GY_RykersBodyguards((CHARACTERGUID)CHARACTERGUID_S_RC_GY_RykersBodyguard_001_f4fafa1b-d6c7-4483-894c-66caebe9e6b1,(CHARACTERGUID)CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_001_11b2401f-3e04-40cb-ba45-673a0c3d2d61);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_002_a823bbff-668c-49a9-acd5-4094fe114c8d,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_002_5494b92c-9053-40b1-9768-88e948ea4c04);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_003_f05b403d-799b-45ad-8770-6900f0e85de8,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_003_23cba808-4581-434b-b4b8-2ce54884af62);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_004_0fdce096-7735-4410-9668-b7173db74f1d,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_004_34026af1-e609-40ef-bc56-795c6ff1f45d);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_006_b10e3799-10a3-45a1-bb6d-0080cc960672,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_006_78509c1c-35e6-4a74-b182-ed7d3132e5f1);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_007_bac676aa-586f-4486-affb-6a9716ced419,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_007_96a41d7c-1129-405d-a822-a4aaed95e13a);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_008_1b31dfc4-dbfa-44a2-8433-82d319bc688c,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_008_bfc7b133-76f7-4d1f-9089-647a6a5a8ab6);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_009_1a12f8ec-8a88-428c-a419-a10026cd09d8,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_009_ab09dbf3-ca02-4e6a-8006-3973ed17b39e);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_010_3353e5bf-9bac-4c6c-b6d0-5c405c7ec8ff,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_010_637d5451-ecf4-4ffa-a46f-b26f13a02a0a);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_011_e2f77f28-5f85-4395-8c36-330bbdca13b0,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_011_5a262712-b6da-4f41-8c4d-39cd85cb295e);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_012_77dbf87b-5021-42ef-b6e8-90c00cef1f16,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_012_ae99d07a-0f1b-49a5-9f05-c89b6fbc8869);

//Outside bodyguard
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_Statue_db5b242a-f1b6-4285-9dda-0a18f56e01ea,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Statue_4a6c3611-67c3-44de-81cb-5bc9983b9d1d);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_Digger_b963ef8c-5c21-4189-9291-73128d667d73,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Digger_5f072c63-f5b5-4e8c-a465-025781d792c5);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_Gate_a4d2b334-2a9e-482b-84f3-98487f7f21d4,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Gates_1e98ee0c-5f9e-40b1-8421-b5ec4e3ed509);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_Lizards_f042cb96-7bc8-46bc-ba5e-03552943e9b1,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Lizards_266a6864-0185-482b-8023-d30917ad3a29);
DB_RC_GY_RykersBodyguards(CHARACTERGUID_S_RC_GY_RykersBodyguard_Portal_4969c9af-ed3f-4e2f-b16a-aefafbead99d,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Portal_e2fd4635-c471-45bc-acf4-08e88c1adb41);

// In room
DB_RC_GY_RykersBodyguardsInRoom((CHARACTERGUID)CHARACTERGUID_S_RC_GY_RykersBodyguard_002_a823bbff-668c-49a9-acd5-4094fe114c8d);
DB_RC_GY_RykersBodyguardsInRoom(CHARACTERGUID_S_RC_GY_RykersBodyguard_001_f4fafa1b-d6c7-4483-894c-66caebe9e6b1);
DB_RC_GY_RykersBodyguardsInRoom(CHARACTERGUID_S_RC_GY_RykersBodyguard_0012_77dbf87b-5021-42ef-b6e8-90c00cef1f16);

//Inside secret chamber
DB_RC_GY_RykersBodyguardsInSecretChamber((CHARACTERGUID)CHARACTERGUID_S_RC_GY_RykersBodyguard_003_f05b403d-799b-45ad-8770-6900f0e85de8,(CHARACTERGUID)CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_003_23cba808-4581-434b-b4b8-2ce54884af62);
DB_RC_GY_RykersBodyguardsInSecretChamber(CHARACTERGUID_S_RC_GY_RykersBodyguard_004_0fdce096-7735-4410-9668-b7173db74f1d,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_004_34026af1-e609-40ef-bc56-795c6ff1f45d);
DB_RC_GY_RykersBodyguardsInSecretChamber(CHARACTERGUID_S_RC_GY_RykersBodyguard_006_b10e3799-10a3-45a1-bb6d-0080cc960672,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_006_78509c1c-35e6-4a74-b182-ed7d3132e5f1);

DB_OneShotUser_VoicebarkTrigger(TRIGGERGUID_S_RC_GY_RykersBodyguard_Digger_VB_Trigger_cda5bc92-dfb0-469c-ac18-99c31ed03cab,"RC_GY_VB_RykersBodyguard_Digger");

DB_CrimeWarningIsAD("RC_GY_AD_RykersBodyguard_Crime");
DB_CrimeWarningIsAD("RC_GY_AD_RykersBodyguard_Investigation");


Proc_RC_GY_RykersBodyguards_SetUp();
Proc_RC_GY_RykersBodyguards_SetUpCrimes();
Proc_RC_GY_RykersBodyguardsInRoom_SetUp();
Proc_RC_GY_RykersBodyguardsInSecretChamber_SetUp();
KBSECTION
//REGION Bodyguards setup
PROC
Proc_RC_GY_RykersBodyguards_SetUp()
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
THEN
Proc_AddSourcePoint(_Bodyguard);
DB_Dialogs(_Bodyguard,"RC_GY_RykersBodyguard");
DB_Ghosts(_Ghost,"RC_GY_RykersBodyguardGhost");
ApplyStatus(_Ghost,"MUTED",-1.0,1);

PROC
Proc_RC_GY_RykersBodyguards_SetUp()
THEN
CharacterUseItem(CHARACTERGUID_S_RC_GY_RykersBodyguard_unfinished_001_93d4082f-6e6d-4fe1-9751-cc8622215f16,ITEMGUID_S_RC_GY_RykersSecretChamber_OperatingTable_000_bd05df3e-2f89-4d54-927e-3c43b23dfddc,"RC_GY_RykersBodyguard_UnfinishedLieDown");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_RykersBodyguard_unfinished_001_93d4082f-6e6d-4fe1-9751-cc8622215f16,"RC_GY_RykersBodyguard_UnfinishedLieDown")
THEN
CharacterDie(CHARACTERGUID_S_RC_GY_RykersBodyguard_unfinished_001_93d4082f-6e6d-4fe1-9751-cc8622215f16,0,"Lifetime");

PROC
Proc_RC_GY_RykersBodyguards_SetUp()
AND
String(WPN_Tool_Shovel_2H_A_4b9b1f2d-e00b-48b4-a209-d183d826f390,_ShovelTmpl)
THEN
ItemTemplateAddTo(_ShovelTmpl,CHARACTERGUID_S_RC_GY_RykersBodyguard_Digger_b963ef8c-5c21-4189-9291-73128d667d73,1);

IF
ItemTemplateAddedToCharacter(WPN_Tool_Shovel_2H_A_4b9b1f2d-e00b-48b4-a209-d183d826f390,_Shovel,CHARACTERGUID_S_RC_GY_RykersBodyguard_Digger_b963ef8c-5c21-4189-9291-73128d667d73)
THEN
CharacterEquipItem(CHARACTERGUID_S_RC_GY_RykersBodyguard_Digger_b963ef8c-5c21-4189-9291-73128d667d73,_Shovel);

PROC
Proc_RC_GY_RykersBodyguards_SetUpCrimes()
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_)
THEN
DB_CrimeReaction_DoNotInterrogate(_Bodyguard);
DB_NoLowAttitudeDialog(_Bodyguard);
ProcCrimeSetCustomInvestigationAD(_Bodyguard,"RC_GY_AD_RykersBodyguard_Investigation");


PROC
Proc_RC_GY_RykersBodyguardsInRoom_SetUp()
AND
DB_RC_GY_RykersBodyguardsInRoom(_Bodyguard)
THEN
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_GY_RykersRoomArea_5ff7ebd2-30d1-4df9-8196-07432752b3e8,_Bodyguard);

PROC
Proc_RC_GY_RykersBodyguardsInSecretChamber_SetUp()
AND
DB_RC_GY_RykersBodyguardsInSecretChamber(_Bodyguard,_Ghost)
THEN
SetOnStage(_Bodyguard,0);
SetOnStage(_Ghost,0);
//END_REGION


//REGION Bodyguard flags and interaction logic
IF
GlobalFlagSet("RC_GY_RykerDead")
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
THEN
RemoveStatus(_Ghost,"MUTED");

IF
CharacterStatusApplied(_Ghost,"MUTED",_)
AND
DB_RC_GY_RykersBodyguards(_,_Ghost)
THEN
ObjectSetFlag(_Ghost,"Muted");

IF
CharacterStatusRemoved(_Ghost,"MUTED",_)
AND
DB_RC_GY_RykersBodyguards(_,_Ghost)
THEN
ObjectClearFlag(_Ghost,"Muted",0);


IF
AttackedByObject((CHARACTERGUID)_Bodyguard,_Player,_Summon,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_)
AND
CharacterIsInCombat(_Player,0)
THEN
Proc_RC_GY_RykersBodyguardAttacked(_Bodyguard,_Player);

IF
DialogEnded("RC_GY_RykersBodyguardGhost",_ID)
AND
DB_DialogPlayers(_ID,_Player,1)
AND
UserGetFlag((CHARACTERGUID)_Player,"RC_GY_RykerBodyGuardGhost_VB",0)
THEN
UserSetFlag(_Player,"RC_GY_RykerBodyGuardGhost_VB");
StartVoiceBark("RC_GY_VB_RykerBodyGuardGhost",_Player);


PROC
Proc_RC_GY_RykerWentToSecretChamber()
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
AND
NOT DB_RC_GY_RykersBodyguardsInSecretChamber(_Bodyguard,_Ghost)
THEN
SetFaction(_Bodyguard,"RC_GY_RykerBodyguardsLeftAlone");
//END_REGION



//REGION Rykers bodyguards-ghost connection
// Source-vampired the bodyguard => destroy the ghost
/*IF
CharacterUsedSkillOnTarget(_Character,(CHARACTERGUID)_Bodyguard,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
*/
IF
CharacterStatusAttempt((CHARACTERGUID)_Bodyguard,"DRAIN",(CHARACTERGUID)_Character)
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
AND
NOT DB_Dead(_Bodyguard)
THEN
NOT DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost);
CharacterDie(_Bodyguard,1,"Explode");
Proc_GhostHacks_GhostPoof(_Ghost);
Proc_RC_GY_RykersBodyguardAttacked(_Bodyguard,_Character);
PROC_RC_GY_RykersBodyguardVampired(_Character);

IF
CharacterUsedSkillOnTarget(_Character,(CHARACTERGUID)_Bodyguard,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
AND
DB_Dead(_Bodyguard)
THEN
NOT DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost);
DB_RC_GY_RykersBodyguardsVampired((CHARACTERGUID)_Bodyguard,(CHARACTERGUID)_Ghost);
DB_RC_GY_RykersBodyguardsSucker((CHARACTERGUID)_Character);


IF
CharacterStatusApplied(_Bodyguard,"Explode",_)
AND
DB_RC_GY_RykersBodyguardsVampired(_Bodyguard,_Ghost)
AND
DB_RC_GY_RykersBodyguardsSucker(_Character)
THEN
NOT DB_RC_GY_RykersBodyguardsVampired(_Bodyguard,_Ghost);
Proc_GhostHacks_GhostPoof(_Ghost);
Proc_RC_GY_RykersBodyguardAttacked(_Bodyguard,_Character);
PROC_RC_GY_RykersBodyguardVampired(_Character);


// Source-vampired the ghost => add to another DB, to explode body at the end of skill
IF
CharacterUsedSkillOnTarget(_Character,(CHARACTERGUID)_Ghost,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
THEN
NOT DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost);
DB_RC_GY_RykersBodyguardsVampired((CHARACTERGUID)_Bodyguard,(CHARACTERGUID)_Ghost);
DB_RC_GY_RykersBodyguardsSucker((CHARACTERGUID)_Character);

// Source-vampired the ghost => explode the bodyguard
IF
CharacterStatusApplied(_Ghost,"Drain",_)
AND
DB_RC_GY_RykersBodyguardsVampired((CHARACTERGUID)_Bodyguard,(CHARACTERGUID)_Ghost)
AND
NOT DB_Dead(_Bodyguard)
AND
DB_RC_GY_RykersBodyguardsSucker(_Character)
THEN
NOT DB_RC_GY_RykersBodyguardsVampired(_Bodyguard,_Ghost);
CharacterDie(_Bodyguard,1,"Explode");
Proc_RC_GY_RykersBodyguardAttacked(_Bodyguard,_Character);
PROC_RC_GY_RykersBodyguardVampired(_Character);

// Source-vampired the ghost => explode the corpse
IF
CharacterStatusApplied(_Ghost,"Drain",_)
AND
DB_RC_GY_RykersBodyguardsVampired((CHARACTERGUID)_Bodyguard,(CHARACTERGUID)_Ghost)
AND
DB_Dead(_Bodyguard)
AND
DB_RC_GY_RykersBodyguardsSucker(_Character)
THEN
NOT DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost);
ApplyStatus(_Bodyguard,"EXPLODE",1.0);
Proc_RC_GY_RykersBodyguardAttacked(_Bodyguard,_Character);
PROC_RC_GY_RykersBodyguardVampired(_Character);


PROC
PROC_RC_GY_RykersBodyguardVampired((CHARACTERGUID)_Player)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterIsInCombat(_Player,0)
AND
CrimeGetNewID(_CrimeID)
THEN
CharacterRegisterCrime(_Player,"Murder",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_CrimeID);

// Explode all bodyguards when Ryker dies
IF
GlobalFlagSet("RC_GY_RykerDead")
AND
DB_RC_GY_RykersBodyguards(_Bodyguard,_Ghost)
THEN
CharacterDie(_Bodyguard,1,"Explode");
Proc_GhostHacks_GhostPoof(_Ghost);
//END_REGION

// Patroling bodyguard stop if his spirit is talked to
IF
DialogStarted("RC_GY_RykersBodyguardGhost",_Inst)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Gates_1e98ee0c-5f9e-40b1-8421-b5ec4e3ed509,1)
AND
GetVarObject(CHARACTERGUID_S_RC_GY_RykersBodyguard_Gate_a4d2b334-2a9e-482b-84f3-98487f7f21d4,"SplineGUID",_Spline)
THEN
DB_RC_GY_RykerBodyguardGate_Spline((SPLINEGUID)_Spline);
SetStoryEvent(CHARACTERGUID_S_RC_GY_RykersBodyguard_Gate_a4d2b334-2a9e-482b-84f3-98487f7f21d4,"StopPatrol");

IF
DialogEnded("RC_GY_RykersBodyguardGhost",_Inst)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Gates_1e98ee0c-5f9e-40b1-8421-b5ec4e3ed509,1)
AND
DB_RC_GY_RykerBodyguardGate_Spline(_Spline)
THEN
NOT DB_RC_GY_RykerBodyguardGate_Spline((SPLINEGUID)_Spline);
SetVarObject(CHARACTERGUID_S_RC_GY_RykersBodyguard_Gate_a4d2b334-2a9e-482b-84f3-98487f7f21d4,"SplineGUID",_Spline);
SetStoryEvent(CHARACTERGUID_S_RC_GY_RykersBodyguard_Gate_a4d2b334-2a9e-482b-84f3-98487f7f21d4,"InitiateSplinePatrol");

// Washing bodyguard stop if his spirit is talked to
IF
DialogStarted("RC_GY_RykersBodyguardGhost",_Inst)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Statue_4a6c3611-67c3-44de-81cb-5bc9983b9d1d,1)
THEN
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_RykersBodyguard_Statue_db5b242a-f1b6-4285-9dda-0a18f56e01ea,"Action_GuardWashStatue",0);

IF
DialogEnded("RC_GY_RykersBodyguardGhost",_Inst)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_GY_RykersBodyguardGhost_Statue_4a6c3611-67c3-44de-81cb-5bc9983b9d1d,1)
THEN
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_RykersBodyguard_Statue_db5b242a-f1b6-4285-9dda-0a18f56e01ea,"Action_GuardWashStatue",900);
EXITSECTION
SysClear("DB_RC_GY_RykersBodyguards",2);
NOT DB_CrimeReaction_CustomWarning(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"Assault","RC_GY_Ryker");
NOT DB_CrimeReaction_CustomWarning(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"Trespassing","RC_GY_Ryker_TrespassingWarning");
NOT DB_CrimeWarningIsAD("RC_GY_AD_RykersBodyguard_Crime");
NOT DB_CrimeWarningIsAD("RC_GY_AD_RykersBodyguard_Investigation");

SysClear("DB_RC_GY_RykersBodyguardsInRoom",1);
SysClear("DB_RC_GY_RykersBodyguardsInSecretChamber",2);
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
