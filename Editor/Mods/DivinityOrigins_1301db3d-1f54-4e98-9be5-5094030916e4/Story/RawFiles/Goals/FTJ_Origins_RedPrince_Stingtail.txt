Version 1
SubGoalCombiner SGC_AND
INITSECTION
// Handle Stingtail's and Bahara's deaths in Red Prince' origin story, both for Red Prince as avatar and Red Prince as companion

// character - event to set on RedPrince
DB_RedPrinceOrigin_SeesDeadPeople(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,"FTJ_RedPrinceOrigin_StingtailDead");
DB_RedPrinceOrigin_SeesDeadPeople(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,"FTJ_RedPrinceOrigin_BaharaDead");
KBSECTION
//REGION Debugging
IF
TextEventSet("rp_reset")
THEN
DB_RedPrinceOrigin_SeesDeadPeople(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,"FTJ_RedPrinceOrigin_StingtailDead");
DB_RedPrinceOrigin_SeesDeadPeople(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,"FTJ_RedPrinceOrigin_BaharaDead");
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_DreamerKilledBeforeTalking",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_DreamerKilledAfterTalking",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceOrigin_GotStingtailInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_BaharaKilled_StingtailGaveInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_BaharaKilled_NoStingtailInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_BaharaInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_StingtailDead",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Bahara",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_BaharaKilled_StingtailGaveInfo",0);
UserClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_BaharaKilled_NoStingtailInfo",0);
NOT DB_Dead(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
NOT DB_Dead(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);
NOT DB_Sees(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
NOT DB_Sees(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

IF
TextEventSet("rp_reset")
AND
DB_HasMet(_Char,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Race)
AND
DB_RedPrinceOrigin_SeesDeadPeople(_Char,_)
THEN
NOT DB_HasMet(_Char,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Race);

IF
TextEventSet("rp_stmet")
THEN
DB_HasMet(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"LIZARD");

IF
TextEventSet("rp_stinfo")
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo");

IF
TextEventSet("rp_stinfo")
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail");

IF
TextEventSet("rp_stdead")
THEN
DB_Dead(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);

IF
TextEventSet("rp_stsee")
THEN
DB_Sees(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);


IF
TextEventSet("rp_bdead")
THEN
DB_Dead(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

IF
TextEventSet("rp_bsee")
THEN
DB_Sees(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

//END_REGION

//REGION Set flag if we met Stingtail for AD when he dies
// Shapeshifting doesn't matter, because it's about us recognising Stingtail
// and not the other way around
IF
DB_HasMet(_Char,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
AND
DB_RedPrinceOrigin_SeesDeadPeople(_Char,_)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAvatar_HasMet_Stingtail");
//END_REGION

//REGION Set flag when we know a character died
IF
DB_Dead(_DeadPerson)
AND
DB_RedPrinceOrigin_SeesDeadPeople(_DeadPerson,_Flag)
AND
DB_Sees(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_DeadPerson)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Flag);

//END_REGION

//REGION Seeing dead Stingtail
IF
ObjectFlagSet("FTJ_RedPrinceOrigin_StingtailDead",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
PROC_FTJ_Origins_RedPrince_StingtailDead();

// Journal if avatar Red Prince did not yet meet him
PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAvatar_HasMet_Stingtail",0)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_DreamerKilledBeforeTalking");

// Journal if avatar Red Prince already yet met him
PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAvatar_HasMet_Stingtail",1)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_DreamerKilledAfterTalking");

// Journal for companion Red Prince in case he did not get the info yet
PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
AND
DB_IsPlayer(_Avatar)
AND
IsTagged(_Avatar,"AVATAR",1)
AND
CharacterIsInPartyWith((CHARACTERGUID)_Avatar,(CHARACTERGUID)CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,1)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_StingtailDead");

PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceOrigin_DeadStingtailBeforeInfo");

PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
THEN
Proc_StartDialog(1,"FTJ_AD_RedPrinceStingtailDead",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

PROC
PROC_FTJ_Origins_RedPrince_StingtailDead()
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
//END_REGION

//REGION Seeing dead Bahara
IF
ObjectFlagSet("FTJ_RedPrinceOrigin_BaharaDead",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
PROC_FTJ_Origins_RedPrince_BaharaDead();

// Quest update, Red Prince as avatar
PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_BaharaKilled_StingtailGaveInfo");
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceOrigin_GotStingtailInfo");

PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",0)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_BaharaKilled_NoStingtailInfo");

// Quest update, Red Prince as companion
PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail",1)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_BaharaKilled_StingtailGaveInfo");
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceOrigin_GotStingtailInfo");

PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail",0)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_BaharaKilled_NoStingtailInfo");

PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
THEN
Proc_StartDialog(1,"FTJ_SW_AD_RedPrinceBaharaDead",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

PROC
PROC_FTJ_Origins_RedPrince_BaharaDead()
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);
//END_REGION

//REGION Once Red Prince got the info, he doesnt care about them dying anymore
IF
ObjectFlagSet("QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",_,_)
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_RedPrince_Stingtail",_,_)
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);

IF
ObjectFlagSet("QuestUpdate_FTJ_OriginRedPrince_BaharaInfo",_,_)
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_RedPrince_Bahara",_,_)
THEN
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

PROC
PROC_FTJ_Origins_RedPrince_DeadPersonFinished(_Char)
AND
DB_RedPrinceOrigin_SeesDeadPeople(_Char,_Flag)
THEN
NOT DB_RedPrinceOrigin_SeesDeadPeople(_Char,_Flag);

//END_REGION


PROC
PROC_FTJ_Origins_RedPrince_DeadPersonFinished((CHARACTERGUID)_Char)
AND
NOT DB_RedPrinceOrigin_SeesDeadPeople(_,_)
THEN
GoalCompleted;

// Also clean up once we leave Fort Joy
PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
