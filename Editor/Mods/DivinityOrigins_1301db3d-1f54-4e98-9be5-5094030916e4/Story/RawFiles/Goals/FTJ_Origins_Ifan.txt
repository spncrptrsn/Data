Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_OriginMomentTag("FTJ_GhettoGuard_004","IFAN","FTJ_GhettoGuard_004_COM_Ifan");
DB_OriginMomentTag("RC_DW_Tavern_RichMerchant","IFAN","RC_DW_Tavern_RichMerchant_COM_Ifan");
DB_OriginMomentTag("RC_WC_BombScientist","IFAN","RC_WC_BombScientist_COM_Ifan");
DB_OriginMomentTag("RC_WC_BombScientist","SHAPESHIFT_IFAN","RC_WC_BombScientist_COM_Ifan");
DB_OriginMomentTag("RC_WC_BombScientist_Ghost","IFAN","RC_WC_BombScientist_COM_Ifan");
DB_OriginMomentTag("RC_WC_BombScientist_Ghost","SHAPESHIFT_IFAN","RC_WC_BombScientist_COM_Ifan");
DB_OriginMomentTag("RC_DF_PaladinCheckpoint_1","IFAN","RC_DF_PaladinCheckpoint_COM_Ifan");
DB_OriginMomentTag("RC_MIL_Roost","IFAN","RC_MIL_Roost_COM_Ifan");
DB_OriginMomentTag_3SP("RC_MIL_RoostWithSaheila","IFAN","RC_MIL_RoostWithSaheila_COM_Ifan");
DB_OriginMomentTag("CoS_Temples_Alexandar","IFAN","CoS_Temples_Alexandar_COM_Ifan"); 
DB_OriginMomentTag("CoS_Temples_Alexandar_Ghost","IFAN","CoS_Temples_Alexandar_COM_Ifan");
DB_OriginMomentTag("ARX_MerchantEstate_Groom","IFAN","ARX_MerchantEstate_Groom_COM_Ifan");
DB_QueueFriendlyCOM("FTJ_IfansHandler_COM_Sebille");
DB_OriginDialogTrigger("RC_DW_Tavern_RichMerchant", (TRIGGERGUID)TRIGGERGUID_S_RC_DW_NearBaran_756988de-4fac-41d1-b18b-1e8bfa4478e8);

DB_OriginsIfan_NoteReadToAvatarQuestUpdate("OriginsIfan_ReadInTut","QuestUpdate_FTJ_Ifan_DarkFaction_Start_TUT");
DB_OriginsIfan_NoteReadToAvatarQuestUpdate("OriginsIfan_ReadBeforeBorris","QuestUpdate_FTJ_Ifan_DarkFaction_Start_AfterTUT");
DB_OriginsIfan_NoteReadToAvatarQuestUpdate("OriginsIfan_ReadAfterBorris","QuestUpdate_FTJ_Ifan_DarkFaction_Start_AfterBorris");

DB_DialogMoneyTransfer(1,"RC_DW_Ifan_Barracks_Trespass",25); 
DB_DialogMoneyTransfer(2,"RC_DW_Ifan_Barracks_Trespass",50); 
DB_DialogMoneyTransfer(3,"RC_DW_Ifan_Barracks_Trespass",75); 
DB_DialogMoneyTransfer(4,"RC_DW_Ifan_Barracks_Trespass",100); 

// Ifan keeping stuff hidden on his body to give it to his avatar at when the latter happens to be in the mood for some fun
DB_GiveNewItemFromTemplateEvent("CON_Food_Meat_Raw_A_a831f7b3-c6a4-4437-a623-8a3df0d6b2e7","Ifan_GiveMeat");
DB_GiveNewItemFromTemplateEvent("CON_Nature_Mushroom_FlyAgaric_A_c09d258c-3a49-482b-83b2-ab970e7ccd55","Ifan_GiveShroom");
DB_GiveNewItemFromTemplateEvent("CON_Herb_Drudanae_A_84ce1dfa-12b1-4b37-8907-aa7301f1edbf","Ifan_GiveCandy");

DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_IfanHandler_d0920841-a984-4ea4-92c6-31d236ee2540);
KBSECTION
//https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/ifan-and-the-dark-faction
//REGION Region-specific inits
IF
RegionStarted("FJ_FortJoy_Main")
AND
QueryOnlyOnce("FTJ_IfanInit")
THEN
DB_HasStoryEvent((ITEMGUID)ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505,"FTJ_HasNoteZaleskar");
DB_GiveItemToEvent((ITEMGUID)ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505,"FTJ_NoteZaleskarTo");
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_FalseSourcerer_d9578eb3-16fc-448c-ab38-577bd02065b3,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,-40);
DB_ManualTradeNPC(CHARACTERGUID_S_FTJ_FalseSourcerer_d9578eb3-16fc-448c-ab38-577bd02065b3);
DB_PreventTradeBetween(CHARACTERGUID_S_FTJ_FalseSourcerer_d9578eb3-16fc-448c-ab38-577bd02065b3,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
DB_FTJ_IfanExecuteSaheila_CaveDwellers((CHARACTERGUID)CHARACTERGUID_S_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066);
DB_FTJ_IfanExecuteSaheila_CaveDwellers(CHARACTERGUID_S_FTJ_Skeptic_Elf_001_d8902155-d0e3-4dfe-b6dd-d90fd5606f50);
DB_FTJ_IfanExecuteSaheila_CaveDwellers(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a);
DB_FTJ_IfanExecuteSaheila_CaveDwellers(CHARACTERGUID_S_FTJ_SkepticChild_001_780631fb-3619-4ed1-b48b-f1ff847d4183);
DB_FTJ_IfanExecuteSaheila_CaveDwellers(CHARACTERGUID_S_FTJ_SkepticChild_002_7f795cf2-db7f-46b6-aa9c-f9d5eefcc789);
DB_FTJ_IfanExecuteSaheila_CaveDwellers(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
Proc_FTJ_Origins_Ifan_Start();

PROC
Proc_FTJ_Origins_Ifan_Start()
THEN
DB_Dialogs(CHARACTERGUID_S_FTJ_IfanHandler_d0920841-a984-4ea4-92c6-31d236ee2540,"FTJ_IfansHandler");
ItemToInventory(ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505,CHARACTERGUID_S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8);


PROC
Proc_FTJ_Origins_Ifan_Start()
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_IfanWashedAshore");

// Ifan has the contract regardless of whether he is avatar or not
IF
GameStarted("FJ_FortJoy_Main",_)
AND
QueryOnlyOnce("FTJ_IfanStoryInit")
THEN
ItemToInventory(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
RegionStarted("RC_Main")
AND
QueryOnlyOnce("RC_IfanInit")
THEN
DB_TriggerSendsSpotEvents(S_RC_DW_IfanKidRunup_50e87963-e07d-4918-ace3-38d6d993ef33);
DB_Dialogs(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,"RC_DW_IfanKid");
DB_Children(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_WH_IfanExposition_287f653d-2def-4741-b984-68b3a80ed627,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DW_UnderTavern_IfanRomance_7a34d1d9-132f-400f-b3d7-23f8e500315f,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
//END_REGION

//REGION Recruitement Flags & Journal starts
PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Avatar)
AND
NOT DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_Ifan_RecruitedInFortJoy");
GlobalSetFlag("GLO_Ifan_RecruitedInFortJoy");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Avatar)
AND
DB_OriginRecruitmentLocation((CHARACTERGUID)CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(TRIGGERGUID)TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point_811d43e1-5c27-4d00-aedf-51b629ac9dc8)
THEN
NOT DB_OriginRecruitmentLocation_Region("FJ_FortJoy_Main",(CHARACTERGUID)CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(TRIGGERGUID)TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point_811d43e1-5c27-4d00-aedf-51b629ac9dc8,"State_FortJoy");
DB_OriginRecruitmentLocation_Region("FJ_FortJoy_Main",(CHARACTERGUID)CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(TRIGGERGUID)TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point2_11d93a5b-a811-458f-bf89-6541676d52e3,"State_FortJoy");
NOT DB_OriginRecruitmentLocation(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point_811d43e1-5c27-4d00-aedf-51b629ac9dc8);
DB_OriginRecruitmentLocation(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point2_11d93a5b-a811-458f-bf89-6541676d52e3);
SetVarObject(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FortJoyRecruitmentPoint",TRIGGERGUID_S_FTJ_Origin_IfanDefault_Point2_11d93a5b-a811-458f-bf89-6541676d52e3);

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Avatar)
AND
DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_Ifan_RecruitedInLV");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Ifan", 0)
AND
ObjectGetFlag(_Player,"GLO_Ifan_RecruitedInFortJoy",0)
THEN
ObjectSetFlag(_Player,"QuestAdd_FTJ_COM_Ifan");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Ifan_StartLV");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestAdd_FTJ_COM_Ifan", 0)
AND
NOT DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Player,"QuestAdd_FTJ_COM_Ifan");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Ifan_Start");
//END_REGION

//REGION Fort Joy - Borris
PROC
Proc_COMFinished("FTJ_GhettoGuard_004_COM_Ifan",_)
THEN
DB_OriginMomentTag_HighPriority("FTJ_IfansHandler","IFAN","FTJ_IfansHandler_COM_Ifan");

PROC
Proc_COMFinished("FTJ_GhettoGuard_004_COM_Ifan",(CHARACTERGUID)_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_Borris");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_GhettoGuard_004_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);


//END_REGION

//REGION Fort Joy - Shakedown Elf
IF
CharacterDied(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_ShakedownElf_ARD_Ifan",CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
//END_REGION

//REGION Swamps - Zaleskar
PROC
Proc_COMFinished("FTJ_IfansHandler_COM_Ifan",(CHARACTERGUID)_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_Zaleskar");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfansHandler_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
ObjectFlagSet("FTJ_IfanHandler_GiveSourceBow",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
// Shadow's Eye
ItemTemplateAddTo("WPN_UNIQUE_IfansBow_766137bb-5346-42fa-90ce-c8959f2fe925",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1);
// Comes with a complimentary poison cloud arrow!
ItemTemplateAddTo("WPN_Arrow_Poison_Cloud_A_a1c4934d-1021-40a3-8c2c-42972208ade8",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1);

//END_REGION

//REGION Handling of reading the Dark Faction contract depending on where Ifan is
PROC
PROC_Origins_Ifan_SetNoteReadFlag()
AND
DB_CurrentLevel("TUT_Tutorial_A")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"OriginsIfan_ReadInTut");

PROC
PROC_Origins_Ifan_SetNoteReadFlag()
AND
NOT DB_CurrentLevel("TUT_Tutorial_A")
AND
NOT DB_HasMet(CHARACTERGUID_S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"OriginsIfan_ReadBeforeBorris");

PROC
PROC_Origins_Ifan_SetNoteReadFlag()
AND
DB_HasMet(CHARACTERGUID_S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"OriginsIfan_ReadAfterBorris");

IF
ObjectFlagSet(_Flag,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
AND
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
DB_OriginsIfan_NoteReadToAvatarQuestUpdate(_Flag,_Update)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestAdd_FTJ_Ifan_DarkFaction");
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Update);

IF
CharacterUsedItem(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb)
AND
QueryOnlyOnce("FTJ_IfanDarkFactionQuestInitiated")
THEN
PROC_Origins_Ifan_SetNoteReadFlag();
PROC_Origins_Ifan_DarkFactionStartIfAvatar();

PROC
PROC_Origins_Ifan_DarkFactionStartIfAvatar()
AND
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
GlobalSetFlag("FTJ_IfanDarkFactionQuestInitiated");

IF
GameBookInterfaceClosed(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,(CHARACTERGUID)_Player)
AND 
DB_HighestChapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Chapter)
AND 
_Chapter < 3
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanNote_CRD_Ifan",_Player);

IF
GameBookInterfaceClosed(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,(CHARACTERGUID)_Player)
AND 
DB_HighestChapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Chapter)
AND 
_Chapter < 3
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_NoteZaleskarTo",0)
AND
QueryOnlyOnce("FTJ_IfanDFNoteVB_Once")
THEN
PROC_Origins_Ifan_SetNoteReadFlag();
PROC_Origins_Ifan_DarkFactionStartIfAvatar();
Proc_StartDialog(1,"FTJ_VB_IfanReadsDFNote",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
DialogEnded("FTJ_IfanNote_CRD_Ifan",_)
AND
DB_HighestChapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Ifan_NoteDarkFaction");
ObjectSetFlag(_Player,"GLO_Ifan_ReadContract");

IF
DialogEnded("FTJ_IfanNote_CRD_Ifan",_)
AND
DB_HighestChapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,2)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Ifan_NoteDarkFactionAfterFTJ");
ObjectSetFlag(_Player,"GLO_Ifan_ReadContract");

IF
DialogEnded("FTJ_IfanNote_CRD_Ifan",_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_NoteZaleskarTo",0)
AND
QueryOnlyOnce("FTJ_IfanDFNoteVB_Once")
THEN
PROC_Origins_Ifan_SetNoteReadFlag();
Proc_StartDialog(1,"FTJ_VB_IfanReadsDFNote",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
DialogEnded("Ifan",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,2)
AND
ObjectGetFlag(_Player,"GLO_Ifan_ShowContract",1)
THEN
ObjectClearFlag(_Player,"GLO_Ifan_ShowContract");
CharacterUseItem((CHARACTERGUID)_Player,ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,"");

IF
CharacterUsedItem(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505)
AND
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
QueryOnlyOnce("FTJ_IfanNoteZaleskar_OneShot")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_Borris_Note");

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505)
AND
NOT DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
CharacterIsInPartyWith(_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
AND
QueryOnlyOnce("FTJ_IfanNoteZaleskar_OneShot")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_Borris");
DB_OriginMomentTag_HighPriority("FTJ_IfansHandler","IFAN","FTJ_IfansHandler_COM_Ifan");

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 5, 1, 0)
AND
DB_OnlyOnce("FTJ_IfanNoteZaleskar_OneShot")
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_Zaleskar",0)
THEN
DB_OriginMomentTag_HighPriority("FTJ_IfansHandler","IFAN","FTJ_IfansHandler_COM_Ifan");

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_KillOrder",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_SaheilaKilled");
//END_REGION

//REGION Fort Joy - Atusa event
IF
DB_Sees(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GetRegion(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FJ_FortJoy_Main")
AND
NOT DB_FTJ_IfanAlexandarCommentDone(1)
AND
ObjectIsInTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_FTJ_IfanAlexandarVB_66d2ee30-bc08-4973-a037-46f391fbb93f,1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
DB_FTJ_IfanAlexandarCommentDone(1);
Proc_StartDialog(1,"FTJ_AD_IfanSawAlexandarAtAtusaEvent",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

// Comment only makes sense before Atusa event
PROC
Proc_SceneOver("FTJ_DallasStartScene")
THEN
DB_FTJ_IfanAlexandarCommentDone(1);

PROC
Proc_SceneOver("FTJ_DallasStartScene")
AND
DB_IsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",1)
AND
GlobalGetFlag("FTJ_AlexandarIsDead",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_Atusa_Event");
//END_REGION

//REGION Magister Borris dead -> flag for different recruitment greeting
IF
DB_Dead(CHARACTERGUID_S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanRecruitment_BorrisDead");
//END_REGION

//REGION Saheila Execution
IF
TextEventSet("saheilaexecute")
AND
CharacterGetHostCharacter(_Player)
THEN
ObjectSetFlag(_Player,"FTJ_AllowSaheilaExecution");

// Told Saheila you will kill her
IF
ObjectFlagSet("FTJ_AllowSaheilaExecution",(CHARACTERGUID)_Ifan,_Id)
THEN
DB_IgnoreAssaultFor(_Ifan,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);
DB_FTJ_IfanToldSaheilaDies(_Id);
CharacterSetFightMode(_Ifan,1,0);
ObjectSetFlag(_Ifan,"GLO_PathOfBlood_MurderedInnocent");

// Got info another way and talked to Saheila -> clean up
IF
ObjectFlagCleared("FTJ_AllowSaheilaExecution",(CHARACTERGUID)_Ifan,_)
THEN
NOT DB_IgnoreAssaultFor(_Ifan,CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);
CharacterSetFightMode(_Ifan,0,0);

IF
ObjectFlagCleared("FTJ_AllowSaheilaExecution",(CHARACTERGUID)_Ifan,_)
AND
DB_FTJ_IfanToldSaheilaDies(_Id)
THEN
NOT DB_FTJ_IfanToldSaheilaDies(_Id);

IF
DialogEnded("FTJ_Saheila",_Id)
AND
DB_FTJ_IfanToldSaheilaDies(_Id)
AND
DialogGetInvolvedPlayer(_Id,1,_Ifan)
THEN
NOT DB_FTJ_IfanToldSaheilaDies(_Id);
ProcObjectTimer(_Ifan,"FTJ_IfanRemarkKillSaheila",500);

PROC
ProcObjectTimerFinished(_Ifan,"FTJ_IfanRemarkKillSaheila")
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
CharacterIsInCombat((CHARACTERGUID)_Ifan,0)
AND
CharacterIsInCombat((CHARACTERGUID)CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,0)
THEN
Proc_StartDialog(1,"FTJ_AD_IfanCanExecuteSaheila",_Ifan);

IF
AttackedByObject(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,(CHARACTERGUID)_Ifan,_,_,_)
AND
ObjectGetFlag(_Ifan,"FTJ_AllowSaheilaExecution",1)
AND
CharacterIsInCombat(_Ifan,0)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,0)
THEN
Proc_FTJ_IfanExecuteSaheila(_Ifan);


PROC
Proc_FTJ_IfanExecuteSaheila((CHARACTERGUID)_Ifan)
THEN
Proc_StartDialog(1,"FTJ_AD_IfanExecuteSaheila",_Ifan);
CharacterSetHitpointsPercentage(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,0.0);

//NPCs refuse trade with Ifan
PROC
Proc_FTJ_IfanExecuteSaheila((CHARACTERGUID)_Ifan)
AND
DB_FTJ_IfanExecuteSaheila_CaveDwellers(_NPC)
AND
CharacterCanSee(_NPC,_Ifan,1)
THEN
DB_ManualTradeNPC(_NPC);
DB_PreventTradeBetween(_NPC,_Ifan);
CharacterAddAttitudeTowardsPlayer(_NPC,_Ifan,-50);

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_Borris_Intimidated",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanDontNeedToKillSaheila");

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_Borris_Note",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanDontNeedToKillSaheila");

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_AlexandarInformation",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanDontNeedToKillSaheila");

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_AlexandarKilled",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanDontNeedToKillSaheila");

IF
CharacterDied(CHARACTERGUID_S_FTJ_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_KillOrder",1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_IfanDontNeedToKillSaheila",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_SaheilaKilled");
//END_REGION

//REGION Companion Dialog Flags
IF
ObjectFlagSet("FTJ_IfanHandler_GiveRabbitMeat",_Player,_)
THEN
ItemTemplateAddTo("CON_Food_Meat_RabbitMeat_A_05e559b0-8dec-4265-9466-54ee75d0888b",_Player,1);

IF
CharacterUsedSkill(S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f, "Summon_SoulWolf", _,_)
THEN
GlobalSetFlag("Ifan_SummonedWolf");
//END_REGION

//REGION Alexandar Fight
IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_AlexandarKilled");
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_AfterAlexandarFight");

IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
THEN
GlobalSetFlag("FTJ_AlexandarIsDead");
//END_REGION

//REGION Offer Booze
IF
DialogStarted("Ifan",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,2)
THEN
GlobalClearFlag("GLO_Ifan_HasBooze");
ProcLaunchMagicPocketIterator((CHARACTERGUID)_Player, "GLO_Ifan_HasBooze", "");

IF
StoryEvent(_Item, "GLO_Ifan_HasBooze")
AND
IsTagged(_Item, "ALCOHOL", 1)
AND
IsTagged(_Item, "POISONED", 0)
THEN
GlobalSetFlag("GLO_Ifan_HasBooze");

IF
ObjectFlagSet("GLO_Ifan_GiveBooze",_Player,_)
THEN
ObjectClearFlag(_Player,"GLO_Ifan_GiveBooze");
ProcLaunchMagicPocketIterator((CHARACTERGUID)_Player, "GLO_Ifan_GiveBooze", "GLO_Ifan_GaveBooze");

IF
StoryEvent((ITEMGUID)_Item, "GLO_Ifan_GiveBooze")
AND
IsTagged(_Item, "ALCOHOL", 1)
AND
IsTagged(_Item, "POISONED", 0)
AND
QueryOnlyOnce("GLO_Ifan_GiveBooze")
AND
GetTemplate(_Item,_Template)
AND
ItemGetOwner(_Item,_Player)
THEN
ItemTemplateRemoveFrom(_Template,_Player,1);
ApplyStatus(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"DRUNK",3.0);

IF
GlobalFlagSet("GLO_Ifan_GaveBooze")
THEN
GlobalClearFlag("GLO_Ifan_GaveBooze");
NOT DB_OnlyOnce("GLO_Ifan_GiveBooze");

IF
ObjectFlagSet("GLO_Ifan_PlayerDrinksBooze",_Player,_)
THEN
ApplyStatus(_Player,"DRUNK",3.0);
ObjectClearFlag(_Player,"GLO_Ifan_PlayerDrinksBooze");
//END_REGION

//REGION Ifan Leaving
IF
StoryEvent(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_CompanionLeaves_LowRelation")
AND
ItemIsInCharacterInventory(ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
THEN
ItemRemove(ITEMGUID_S_FTJ_IfanNoteFindZaleskar_2f1b551c-4e27-4964-aaab-0d088dc7f505);

IF
StoryEvent(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_CompanionLeaves_LowRelation")
AND
ItemIsInCharacterInventory(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
THEN
ItemRemove(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb);

PROC
Proc_DialogFlagSetup("Ifan_Leaving",(GUIDSTRING)_Ifan,(GUIDSTRING)_Player)
AND
ItemIsInPartyInventory(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,(CHARACTERGUID)_Player,0,1)
THEN
ObjectSetFlag(_Player,"GLO_Ifan_Leaving_PartyHasContract");

PROC
Proc_DialogFlagSetup("Ifan_Leaving",(GUIDSTRING)_Ifan,(GUIDSTRING)_Player)
AND
ItemIsInCharacterInventory(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,(CHARACTERGUID)_Ifan,1)
THEN
ObjectSetFlag(_Player,"GLO_Ifan_Leaving_IfanHasContract");
ObjectClearFlag(_Player,"GLO_Ifan_Leaving_PartyHasContract");

IF
ObjectFlagSet("GLO_Ifan_Leaving_GiveContract",_,_)
THEN
ItemToInventory(ITEMGUID_S_FTJ_IfanNoteFromDarkFaction_51899f0f-6ea2-4522-893b-69ccd87b97fb,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
//END_REGION

//REGION Gareth
IF
ObjectFlagSet("FTJ_SW_GodwokenKillings",_Player,_)
AND
CharacterIsInPartyWith((CHARACTERGUID)_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_Gareth_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
ObjectFlagSet("FTJ_SW_GarethToldGodwokenAreHunted",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_Gareth_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
DialogEnded("FTJ_Gareth_CRD_Ifan",_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
UserSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_GarethInfo");
UserSetFlag(_Avatar,"QuestUpdate_FTJ_Hunted_IfanHunted");

//END_REGION

//REGION Alexandar Killed in LV
//DOSTWO-25081 Remove "Kill Alexandar" updates from Ifan quest if Alexandar is already dead
IF
GlobalFlagSet("FTJ_LV_AlexandarKilledOnLV")
THEN
NOT DB_CompanionUpdateObjectFlag("IFAN","QuestUpdate_FTJ_COM_Ifan_AlexandarLV","QuestUpdate_LV_Main_AlexandarCaptive");
NOT DB_AvatarUpdateObjectFlag("IFAN","QuestUpdate_FTJ_Ifan_DarkFaction_AlexandarLV","QuestUpdate_LV_Main_AlexandarCaptive");

IF
GlobalFlagSet("FTJ_LV_AlexandarKilledOnLV")
AND
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_AlexandarKilledLV");

IF
GlobalFlagSet("FTJ_LV_AlexandarKilledOnLV")
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_AlexandarKilledLV");
//END_REGION

//REGION Setup attitude Ifan LV
IF
RegionStarted("LV_HoE_Main")
AND
NOT DB_GlobalFlag("GLO_Ifan_RecruitedInFortJoy")
AND
DB_Avatars(_Avatar)
AND
CharacterGetAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar,_OldAttitude)
AND
IntegerSubtract(0,_OldAttitude,_Delta)
AND
_Delta!=0
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar,_Delta);
//END_REGION

//REGION Act 2 start
IF
DB_Chapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,5)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
ProcObjectTimer(_Avatar,"RC_LV_StartAct2_CRD_Ifan",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Avatar,"RC_LV_StartAct2_CRD_Ifan")
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_LV_StartAct2_CRD_Ifan",_Avatar);

IF
DB_Chapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,5)
AND
DB_Avatars((CHARACTERGUID)CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_Act2Start");
//END_REGION

//REGION Driftwood-approach Scruffy Kid
IF
DB_Event_CharacterAppearedInSpotTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,S_RC_DW_IfanKidRunup_50e87963-e07d-4918-ace3-38d6d993ef33)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_Polymorphed",0)
THEN
DialogRequestStop(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550);

IF
DB_Event_CharacterAppearedInSpotTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,S_RC_DW_IfanKidRunup_50e87963-e07d-4918-ace3-38d6d993ef33)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_Polymorphed",0)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550)
THEN
ProcTriggerUnregisterForPlayers(S_RC_DW_IfanKidRunup_50e87963-e07d-4918-ace3-38d6d993ef33);
ProcCharacterMoveTo(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1,"RC_DW_IfanKid");

IF
StoryEvent(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,"RC_DW_IfanKid")
THEN
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_DW_IfanKid",0,"",1,10.0,0,0);

IF
StoryEvent(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,"RC_DW_IfanKid")
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550)
THEN
DB_DWKidWaitingForIfan(1);

IF
DialogEnded(_,_Inst)
AND
DB_DWKidWaitingForIfan(1)
AND
DB_DialogPlayers(_Inst,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
NOT DB_DWKidWaitingForIfan(1);
ProcCharacterMoveTo(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1,"RC_DW_IfanKid");

IF
DialogEnded("RC_DW_IfanKid",_Inst)
AND
DB_DialogPlayers(_Inst,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_Polymorphed",0)
THEN
SetHasDialog(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,0);
ProcTriggerUnregisterForPlayers(S_RC_DW_IfanKidRunup_50e87963-e07d-4918-ace3-38d6d993ef33);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,0,1,"",1);
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_DWKid");

IF
DialogEnded("RC_DW_IfanKid",_Inst)
AND
DB_DialogPlayers(_Inst,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_Polymorphed",0)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_DWKid");

IF
AttackedByObject(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,_Player,_Attacker,_,_)
AND
CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550 != _Attacker
THEN
DialogRequestStop(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_DW_IfanKid_3bc80e98-bc51-48db-ad3d-ca57ebfda550,0,1,"",0);
//END_REGION

//REGION Driftwood
IF
GlobalFlagSet("GLO_Ifan_SpottedInDW")
AND
NOT DB_OnlyOnce("RC_DW_IfanArrestInDriftwoodOriginMoment")
AND
QRY_StartDialog(0,"RC_DW_Ifan_Barracks_Trespass",CHARACTERGUID_S_RC_DW_Patrol_Magister_001_1643a994-6159-4132-b2ec-0307a35cf9bc,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
DB_OnlyOnce("RC_DW_IfanArrestInDriftwoodOriginMoment");

PROC
Proc_COMFinished("RC_DW_Tavern_RichMerchant_COM_Ifan",(CHARACTERGUID)_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_LearnedBaran");

IF
ObjectFlagSet("RC_LearnedBaran", _Player, _)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Ifan_DarkFaction_LearnedBaran");
//END_REGION

//REGION Mill
IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_MetRoost",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
NOT DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_RC_MIL_Roost_6fffadfe-b2a8-4e12-a664-ba84c0b0a3a3,"QuestUpdate_FTJ_Ifan_DarkFaction_RoostDead");

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_Ifan_MetRoost",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
THEN
NOT DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_RC_MIL_Roost_6fffadfe-b2a8-4e12-a664-ba84c0b0a3a3,"QuestUpdate_FTJ_COM_Ifan_RoostDead");
//END_REGION

//REGION Undertavern Romantic Moment
IF
CharacterEnteredTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_RC_DW_UnderTavern_IfanRomance_7a34d1d9-132f-400f-b3d7-23f8e500315f)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
AND
ObjectGetFlag(_Avatar,"GLO_FriendZone_Ifan",0)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_DW_UnderTavern_Romance_CRD_Ifan",_Avatar);

IF
CharacterLeftTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_RC_DW_UnderTavern_Ownership_940f5177-3697-4fa7-91a3-504f962ba937)
AND
NOT DB_RelationshipDialogsFinished(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_DW_UnderTavern_Romance_CRD_Ifan")
THEN
ProcCancelOneRelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_DW_UnderTavern_Romance_CRD_Ifan");
NOT DB_RelationshipDialogsFinished(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_DW_UnderTavern_Romance_CRD_Ifan");

IF
DialogEnded("RC_BF_CorneredSourcerer_Sourcerer_CRD_Ifan",_)
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_RC_DW_UnderTavern_IfanRomance_7a34d1d9-132f-400f-b3d7-23f8e500315f,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
ObjectFlagSet("GLO_CompanionWalkToAvatar",_Companion,_)
AND
DB_CompanionAvatarBond((CHARACTERGUID)_Companion,_Avatar)
AND
GetDistanceTo(_Companion,_Avatar,_Dist)
AND
_Dist < 10.0
THEN
CharacterMoveTo(_Companion,_Avatar,0,"",1);
ObjectClearFlag(_Companion,"GLO_CompanionWalkToAvatar");

IF
ObjectFlagSet("GLO_AvatarWalkToCompanion",_Avatar,_)
AND
DB_CompanionAvatarBond(_Companion,(CHARACTERGUID)_Avatar)
AND
GetDistanceTo(_Companion,_Avatar,_Dist)
AND
_Dist < 10.0
THEN
CharacterMoveTo(_Avatar,_Companion,0,"",1);
ObjectClearFlag(_Avatar,"GLO_AvatarWalkToCompanion");

IF
ObjectFlagSet("GLO_Ifan_SpawnDrink",_Player,_)
THEN
ItemTemplateAddTo("CON_Drink_Mug_A_Beer_2cda275d-2aea-4e57-970a-0cdb9c342b86",_Player,1);
//END_REGION

//REGION Wrecker Hills
IF
CharacterEnteredTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_RC_WH_IfanExposition_287f653d-2def-4741-b984-68b3a80ed627)
AND
DB_CompanionAvatarBond(_Companion,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
GetDistanceTo(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Companion,_Dist)
AND
_Dist < 10.0
AND
QueryOnlyOnce("RC_WH_AD_Ifan_ToldAboutPast")
THEN
Proc_StartDialog(1,"RC_WH_AD_Ifan_ToldAboutPast",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
CharacterEnteredTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_RC_WH_IfanExposition_287f653d-2def-4741-b984-68b3a80ed627)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
AND
GetDistanceTo(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar,_Dist)
AND
_Dist < 10.0
AND
QueryOnlyOnce("RC_WH_AD_Ifan_ToldAboutPast")
THEN
Proc_StartDialog(1,"RC_WH_AD_Ifan_ToldAboutPast",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
AutomatedDialogEnded("RC_WH_AD_Ifan_ToldAboutPast",_)
AND
DB_CompanionAvatarBond(_Companion,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Companion, CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
QueryOnlyOnce("RC_WH_IfanTellPast_ARD_Any")
THEN
Proc_RelationshipDialog(_Companion,"RC_WH_IfanTellPast_ARD_Any",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

IF
AutomatedDialogEnded("RC_WH_AD_Ifan_ToldAboutPast",_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_WH_TellPast_CRD_Ifan",_Avatar);

IF
DialogEnded("RC_WH_TellPast_CRD_Ifan",_ID)
AND
DB_DialogPlayers(_ID,_Player,2)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_COM_Ifan_WreckerHillsConfession");

IF
DialogEnded("RC_WH_IfanTellPast_ARD_Any",_ID)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_WreckerHillsConfession");
//END_REGION

//REGION Wrecker Cave - Bomb Scientist
PROC
Proc_COMFinished("RC_WC_BombScientist_COM_Ifan",(CHARACTERGUID)_Avatar)
AND
NOT DB_GlobalFlag("GLO_Ifan_LearnedAboutBetrayal")
THEN
GlobalSetFlag("GLO_Ifan_LearnedAboutBetrayal");

IF
GlobalFlagSet("GLO_Ifan_LearnedAboutBetrayal")
THEN
DB_OnlyOnce("RC_WH_AD_Ifan_ToldAboutPast"); //Disable the exposition scene at the foot of the wrecker hills
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_Tricked");
UserSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_Tricked");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_WC_BombScientist_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
DB_OriginMomentTag("RC_BF_CorneredSourcerer_Sourcerer_Ghost","IFAN","RC_BF_CorneredSourcerer_Sourcerer_COM_Ifan");
DB_OriginMomentTag("RC_BF_CorneredSourcerer_Sourcerer_Ghost","SHAPESHIFT_IFAN","RC_BF_CorneredSourcerer_Sourcerer_COM_Ifan");

IF
GameBookInterfaceClosed(ITEMGUID_S_RC_WC_BombScientist_HannagLetter_0f80a878-3e67-46bc-8aa1-7dadcd88f7fa,_Player)
THEN
UserSetFlag(_Player,"RC_WC_BombScientist_KnowAboutHannag");

IF
GlobalFlagSet("GLO_Ifan_LearnedAboutBetrayal")
AND
UserGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_BF_Hannag_HasMet",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_FindHannag");
UserSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_FindHannag");

IF
GlobalFlagSet("GLO_Ifan_LearnedAboutBetrayal")
AND
UserGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_BF_Hannag_HasMet",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_FindHannagAlt");
UserSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_FindHannagAlt");

IF
ObjectFlagSet("QuestUpdate_FTJ_Ifan_DarkFaction_FindHannag",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_FL_Hannag_UsefulFact",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_HannaginBF");
UserSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_HannaginBF");


IF
ObjectFlagSet("RC_FL_Hannag_UsefulFact",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_FindHannag",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_Ifan_DarkFaction_HannaginBF");
UserSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"QuestUpdate_FTJ_COM_Ifan_HannaginBF");



//END_REGION

//REGION Some AOM Defaults
IF
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
DB_OriginMomentTag_HighPriority("FTJ_IfansHandler","IFAN","FTJ_IfansHandler_COM_Ifan");

//END_REGION

//REGION Paladin Checkpoint
PROC
Proc_COMFinished("RC_DF_PaladinCheckpoint_COM_Ifan",_Avatar)
THEN
ObjectSetFlag(_Avatar,"RC_DF_PaladinCheckpoint_COM_Ifan_Happened");

//END_REGION

//REGION Blood Forest - Weather Mage
IF
DB_GlobalFlag("RC_BF_CorneredSourcerer_MagistersDead")
AND
DB_GlobalFlag("GLO_Ifan_LearnedAboutBetrayal")
THEN
DB_OriginMomentTag("RC_BF_CorneredSourcerer_Sourcerer","IFAN","RC_BF_CorneredSourcerer_Sourcerer_COM_Ifan");
DB_OriginMomentTag("RC_BF_CorneredSourcerer_Sourcerer","SHAPESHIFT_IFAN","RC_BF_CorneredSourcerer_Sourcerer_COM_Ifan");

PROC
Proc_COMFinished("RC_BF_CorneredSourcerer_Sourcerer_COM_Ifan",(CHARACTERGUID)_Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_HannagInfo");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_BF_CorneredSourcerer_Sourcerer_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
//END_REGION

//REGION Blood Island - Ifan angry at Withering causing Godking rise
//Companion
IF
GlobalFlagSet("RC_BI_TalkAboutDFhelpingGodKing")
AND
NOT DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
GlobalClearFlag("RC_BI_TalkAboutDFhelpingGodKing");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"RC_BI_LizardDemonLeader_CRD_Ifan",CHARACTERGUID_S_GLO_Advocate_bfa3e903-78ab-46aa-9a95-54fb956eb2b3);

IF
DialogEnded("RC_BI_LizardDemonLeader",_)
AND
DB_GlobalFlag("RC_BI_TalkAboutDFhelpingGodKing")
AND
GetDistanceTo(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_S_GLO_Advocate_bfa3e903-78ab-46aa-9a95-54fb956eb2b3,_Dist)
AND
_Dist < 20.0
THEN
TimerLaunch("RC_BI_LizardDemonLeader_ARD_Ifan",2000);

IF
TimerFinished("RC_BI_LizardDemonLeader_ARD_Ifan")
AND
QRY_StartDialog(0,"RC_BI_LizardDemonLeader_ARD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
GlobalClearFlag("RC_BI_TalkAboutDFhelpingGodKing");

IF
ObjectFlagSet("RC_BI_Ifan_UpgradeWolf",(CHARACTERGUID)_Ifan,_)
THEN
CharacterAddSourcePoints(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1);
CharacterUseSkill(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"Summon_SoulWolf",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1,1,1);

//END_REGION

//REGION CoS - Alexandar encounter
IF
DialogEnded("CoS_Temples_Alexandar_COM_Ifan",_)
AND
DB_GlobalFlag("CoS_Alexandar_Murder")
THEN
PlayEffect(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"RS3_FX_GP_Combat_Hit_Blood_01_Large");
CreateSurface(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"SurfaceBlood",0.2,-1.0);
CharacterDie(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,1,"DoT");
CharacterSetRelationFactionToFaction("CoS_Magister","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_Magister",0);
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"GLO_PathOfBlood_MurderedInnocent");


PROC
Proc_COMFinished("CoS_Temples_Alexandar_COM_Ifan",(CHARACTERGUID)_Avatar)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"CoS_Temples_Alexandar_CRD_Ifan",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Ifan_COSAlexandar");
//END_REGION

//REGION CoS - Deathfog used
IF
ObjectFlagSet("QuestUpdate_CoS_SpyMaster_BombDetonated",_Player,_)
AND
_Player != CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f
AND
NOT DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
QRY_SameUser((CHARACTERGUID)_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
QueryOnlyOnce("Ifanisdisappointedinyouforusingdeathfog.")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"CompanionRelationDown20");
//END_REGION

//REGION Ifan State Flags
IF
CharacterDied(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
GlobalSetFlag("GLO_Ifan_Dead");

IF
CharacterResurrected(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
GlobalClearFlag("GLO_Ifan_Dead");

IF
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
THEN
PartySetFlag(_Player,"GLO_Ifan_InParty");

PROC
Proc_CompanionLeftParty((CHARACTERGUID)CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,(CHARACTERGUID)_Player)
THEN
PartyClearFlag(_Player,"GLO_Ifan_InParty",0);
//END_REGION

//REGION Act 3 start
/*
IF
DB_Chapter(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,9)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
ProcObjectTimer(_Avatar,"ARX_LV_StartAct3_CRD_Ifan",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Avatar,"ARX_LV_StartAct3_CRD_Ifan")
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"ARX_LV_StartAct3_CRD_Ifan",_Avatar);
*/
IF
CharacterEnteredTrigger(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_SUB_Arx_cb6e79c8-f5f8-49d7-8d46-133e2d13349d)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
THEN
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"ARX_LV_StartAct3_CRD_Ifan",_Avatar);



IF
DialogEnded("ARX_LV_StartAct3_CRD_Ifan",_)
AND
DB_GlobalFlag("GLO_Ifan_LeavesPermanently")
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar)
AND
DB_OriginLeavingDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_OriginLeavingDialog)
THEN
PROC_Origins_CompanionLeavePermanently(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
Proc_OriginLeft(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f, "_LowRelation");
DB_CompanionLeaving(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Avatar);
NOT DB_OriginLeavingDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_OriginLeavingDialog);
CharacterMakeStoryNpc(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,0,1,"GLO_CompanionLeaves_LowRelation",1);
//END_REGION

//REGION Arx Groom
PROC
Proc_COMFinished("ARX_MerchantEstate_Groom_COM_Ifan",_Avatar)
THEN
ObjectSetFlag(_Avatar,"ARX_MerchantEstate_Groom_COM_Ifan_Finished");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"ARX_MerchantEstate_Groom_CRD_Ifan",_Avatar);

PROC
Proc_DialogFlagSetup("ARX_MerchantEstate_Groom",_Groom,_Avatar)
AND
ObjectGetFlag(_Avatar,"ARX_MerchantEstate_Groom_COM_Ifan_Finished",1)
AND
GetDistanceTo(_Avatar,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Dist)
AND
_Dist < 10.0
THEN
ObjectSetFlag(_Avatar,"ARX_MerchantEstate_Groom_COM_Ifan_Finished_And_Ifan_Near");

IF
ObjectFlagSet("ARX_MerchantEstate_Groom_AssassinationQuestStarted",_,_)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Char)
AND
PartyGetFlag(_Char,"ARX_MerchantEstate_Groom_AssassinationQuestStarted",1)
THEN
NOT DB_OriginMomentTag("ARX_MerchantEstate_Groom","IFAN","ARX_MerchantEstate_Groom_COM_Ifan");

IF
ObjectFlagSet("ARX_MerchantEstate_Groom_AssassinationQuestStarted",_,_)
AND
DB_IsPlayer(_Char)
THEN
ObjectClearFlag(_Char,"ARX_MerchantEstate_Groom_COM_Ifan_Finished_And_Ifan_Near");

//END_REGION 

//REGION Spirit leaves of its own accord
IF
DialogEnded("LV_Ifan_Ghost",_)
THEN
PROC_FTJ_Origins_Ifan_MaybeGhostDisappear();

IF
DialogEnded("EG_Epilogue_Ifan_Ghost",_)
THEN
PROC_FTJ_Origins_Ifan_MaybeGhostDisappear();

PROC
PROC_FTJ_Origins_Ifan_MaybeGhostDisappear()
AND
DB_GlobalFlag("GLO_Ifan_Disappear")
THEN
Poof(CHARACTERGUID_LV_Ifan_Ghost_8623e194-02bb-4fc9-855c-6f0da8a1c87a);
// Make sure it doesn't come back ever again
DB_GoneGhosts(CHARACTERGUID_LV_Ifan_Ghost_8623e194-02bb-4fc9-855c-6f0da8a1c87a);
CharacterUnlinkGhost(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_LV_Ifan_Ghost_8623e194-02bb-4fc9-855c-6f0da8a1c87a);
//END_REGION

//REGION Friendzoning Ifan
IF
ObjectFlagSet("FTJ_SidedWithBrutes",_Avatar,_)
THEN
ObjectSetFlag(_Avatar,"GLO_FriendZone_Ifan");
//END_REGION

//REGION Epilogue
IF
DialogEnded("EG_Epilogue_Ifan",_)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"EG_Ifan_SummonWolf_WalkAway",1)
THEN
ObjectClearFlag(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"EG_Ifan_SummonWolf_WalkAway");
CharacterMoveTo(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,TRIGGERGUID_S_EG_Epilogue_IfanStareArSea_e230e356-d37b-4da2-927f-cca593312b16,0,"EG_Ifan_AtSeastarepoint",0);

IF
StoryEvent((CHARACTERGUID)_Ifan,"EG_Ifan_AtSeastarepoint")
THEN
CharacterLookFromTrigger(_Ifan,TRIGGERGUID_S_EG_Epilogue_IfanStareArSea_e230e356-d37b-4da2-927f-cca593312b16,1);
CharacterAddSourcePoints(_Ifan,1);
CharacterUseSkill(_Ifan,"Summon_SoulWolf",_Ifan,1,1,1);
//END_REGION


IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 6, 0, 1)
AND
NOT DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_IfanHandler_d0920841-a984-4ea4-92c6-31d236ee2540)
THEN
DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_IfanHandler_d0920841-a984-4ea4-92c6-31d236ee2540);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
