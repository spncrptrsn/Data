Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Dialogs
DB_Dialogs(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"FTJ_SW_IllusionistAtEntrance");
DB_Dialogs(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308,"FTJ_SW_LaughingIllusion");
DB_Dialogs(CHARACTERGUID_S_FTJ_SW_IllusionistDungeonRat_4c2f0ebc-59ba-4ea8-9341-7a38c66a88c0,"FTJ_SW_IllusionistDungeonRat");
DB_Dialogs(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"FTJ_SW_IllusionistJar");
DB_Dialogs(ITEMGUID_S_FTJ_SW_SoulJar_GuardUndead1_46ccad9c-a2fe-4004-89ba-f422528b2860,"FTJ_SW_SoulJar_GuardUndead1");
DB_Dialogs(ITEMGUID_S_FTJ_SW_SoulJar_GuardUndead2_40aa483c-fa08-4a95-8d30-99539a0c7137,"FTJ_SW_SoulJar_GuardUndead2");
DB_Dialogs(ITEMGUID_S_FTJ_SW_SoulJar_GuardUndead3_ce0f3ebb-c6bf-41b9-933e-fb021e13dfd8,"FTJ_SW_SoulJar_GuardUndead3");
DB_Dialogs(ITEMGUID_S_FTJ_SW_SoulJar_ShelterUndead_a11a3798-9382-433a-8a43-73d1d19df474,"FTJ_SW_SoulJar_ShelterUndead");
DB_Dialogs(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,"FTJ_SW_SoulJar_Illusionist");


DB_IgnoreAssault(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308);

//Triggeres

DB_OneShotPlayerTrigger(TRIGGERGUID_S_FTJ_ChestRoomIllusionistAutoStopDialog_Box_a0d8aac6-8ea2-4423-8a4c-e811b619634b);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_FTJ_EntranceIllusionistSpawn_Poly_b9bbb12d-b695-47b3-b0f2-11126142a710);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_FTJ_ChestRoomIllusionistSpawn_Poly_38043f55-5dac-493c-8c27-afcb13d91b8d);
DB_AmbushTrigger(TRIGGERGUID_S_FTJ_SW_IllusionistBossDialog_Poly_55ba1b73-55a6-4e22-b340-1b4469b6a99b, ITEMGUID_S_FTJ_SW_IllusionistAmbushHelper_ad349458-a239-45d4-bddb-4c2f132e9af8);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_FTJ_SW_OneShot_IllusionistJar_3e18e8cd-0269-4123-8c07-0f86b95506ad);
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_FTJ_SW_OneShot_IllusionistVault_4695112f-0f33-4da0-87c0-c4d399302d23,"FTJ_SW_VB_IllusionistVault");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_FTJ_SW_IllusoryDungeonEntrance_07b04841-05ac-4f52-b853-8b8743f64e65,"FTJ_SW_VB_FoundIllusoryEntrance");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_FTJ_IllusionistBridge_Box_001_a7b751e3-ed9a-42e4-aa14-2d2390610139,"FTJ_SW_VB_IllusoryBridge");

//Entities
DB_SW_IllusionsCheck((CHARACTERGUID)S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd);
DB_SW_IllusionsCheck(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308);
DB_SW_IllusionsCheck(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d);

DB_SW_IllusionistsIllusions((CHARACTERGUID)CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503);
DB_SW_IllusionistsIllusions(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_002_0e5779db-8418-4be9-9fdf-7f52c38b67bc);
DB_SW_IllusionistsIllusions(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_003_f5b0ab9f-f99e-4360-b455-a2f7043349a8);
DB_SW_IllusionistsIllusions(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd);
DB_SW_IllusionistsIllusions(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308);
DB_SW_IllusionistsIllusions(CHARACTERGUID_FTJ_SW_IllusionPhase1_001_68a47ec8-ac86-452a-a09a-518338b86b4f);
DB_SW_IllusionistsIllusions(CHARACTERGUID_FTJ_SW_IllusionPhase1_002_bf948008-5ba1-4573-84ff-4a81912d7848);
DB_SW_IllusionistsIllusions(CHARACTERGUID_FTJ_SW_IllusionPhase1_003_0ae5c9bb-9992-4764-9118-9f1377ce827d);
DB_SW_IllusionistsIllusions(CHARACTERGUID_S_FTJ_SW_IllusionPhase2_001_4efa5cda-f2fc-4adb-9dff-66a1a01a16c9);
DB_SW_IllusionistsIllusions(CHARACTERGUID_S_FTJ_SW_IllusionPhase2_002_7f920fbe-5a22-40b9-9e9c-3989f2fa0aab);
DB_SW_IllusionistsIllusions(CHARACTERGUID_S_FTJ_SW_IllusionPhase2_003_90b0de69-fb7b-45a9-bc8c-af0fc5b7099e);

DB_FTJ_SW_ChestRoomIllusions((CHARACTERGUID)CHARACTERGUID_S_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503);
DB_FTJ_SW_ChestRoomIllusions(CHARACTERGUID_S_FTJ_SW_ChestRoomIllusionist_002_0e5779db-8418-4be9-9fdf-7f52c38b67bc);
DB_FTJ_SW_ChestRoomIllusions(CHARACTERGUID_S_FTJ_SW_ChestRoomIllusionist_003_f5b0ab9f-f99e-4360-b455-a2f7043349a8);
DB_KillCounter_Internal(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503,"FTJ_SW_ChestRoomIllusion");
DB_KillCounter_Internal(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_002_0e5779db-8418-4be9-9fdf-7f52c38b67bc,"FTJ_SW_ChestRoomIllusion");
DB_KillCounter_Internal(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_003_f5b0ab9f-f99e-4360-b455-a2f7043349a8,"FTJ_SW_ChestRoomIllusion");
DB_KillCounter("FTJ_SW_ChestRoomIllusion",3);

DB_FTJ_SW_IllusionistPhase1Illusions((CHARACTERGUID)CHARACTERGUID_FTJ_SW_IllusionPhase1_001_68a47ec8-ac86-452a-a09a-518338b86b4f);
DB_FTJ_SW_IllusionistPhase1Illusions(CHARACTERGUID_FTJ_SW_IllusionPhase1_002_bf948008-5ba1-4573-84ff-4a81912d7848);
DB_FTJ_SW_IllusionistPhase1Illusions(CHARACTERGUID_FTJ_SW_IllusionPhase1_003_0ae5c9bb-9992-4764-9118-9f1377ce827d);
DB_FTJ_SW_IllusionistPhase2Illusions((CHARACTERGUID)CHARACTERGUID_S_FTJ_SW_IllusionistPhase2Illusion_001_4efa5cda-f2fc-4adb-9dff-66a1a01a16c9);
DB_FTJ_SW_IllusionistPhase2Illusions(CHARACTERGUID_S_FTJ_SW_IllusionistPhase2Illusion_002_7f920fbe-5a22-40b9-9e9c-3989f2fa0aab);
DB_FTJ_SW_IllusionistPhase2Illusions(CHARACTERGUID_S_FTJ_SW_IllusionistPhase2Illusion_003_90b0de69-fb7b-45a9-bc8c-af0fc5b7099e);


//Items
ItemToInventory(ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d);
SetOnStage(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0);
TeleportTo(ITEMGUID_S_FTJ_SW_IllusionistMagicWall_eb3bf192-92f4-4201-b7ac-5ec80448eb86,TRIGGERGUID_S_FTJ_SW_IllusionistBlockingField_6e753259-3fdf-40b3-ab65-4a9136b4244d);
SetOnStage(ITEMGUID_S_FTJ_SW_IllusionistTrapChest_001_9ebe7612-201b-4609-b888-9d8874987cd6,0);

ItemSetForceSynch(ITEMGUID_S_FTJ_SW_IllusionistDungeonEntrance_00b9cf78-d62d-4e6f-a0d5-cc80714da014,1);
KBSECTION
//REGION Setup

IF
DB_SW_IllusionistsIllusions(_Illusion)
THEN
DB_SW_IllusionsCheck(_Illusion);


IF
DB_SW_IllusionsCheck(_Illusion)
THEN
SetOnStage(_Illusion,0);

IF
CharacterWentOnStage(_Illusion,1)
AND
DB_SW_IllusionsCheck(_Illusion)
THEN
DB_SW_IllusionOnStage(_Illusion);

IF
CharacterWentOnStage(_Illusion,0)
AND
DB_SW_IllusionsCheck(_Illusion)
THEN
NOT DB_SW_IllusionOnStage(_Illusion);

IF
CharacterUsedItem(_,ITEMGUID_S_FTJ_SW_IllusionistLever_a2ed196c-8e60-4c55-93ab-c2142e672a2e)
AND
QueryOnlyOnce("FTJ_SW_IllusionistLever")
THEN
ItemDestroy(ITEMGUID_S_FTJ_SW_IllusionistMagicWall_eb3bf192-92f4-4201-b7ac-5ec80448eb86);

//END_REGION

//REGION Illusions


//END_REGION

//REGION Entrance

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_FTJ_SUB_IllusionistEntrance_Poly_0f5cf23b-78d6-43d8-8cc7-2c3385b985a1)
AND
UserGetFlag(_Player,"FTJ_SW_IllusionistStart",0)
THEN
UserSetFlag(_Player,"FTJ_SW_IllusionistStart");
ObjectSetFlag(_Player,"QuestAdd_FTJ_SW_Illusionist");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_Start_FindEntrance");

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_FTJ_EntranceIllusionistSpawn_Poly_b9bbb12d-b695-47b3-b0f2-11126142a710)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
THEN
CharacterAppearCustom(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"Teleport_In_01","");
DB_FTJ_SW_IllusionistAtEntrance_Teleport_In_01(_Player);
ProcObjectTimer(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"S_FTJ_SW_IllusionistAtEntrance_Teleport_In_01",1300);


PROC
ProcObjectTimerFinished(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"S_FTJ_SW_IllusionistAtEntrance_Teleport_In_01")
AND
DB_FTJ_SW_IllusionistAtEntrance_Teleport_In_01(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(0,"FTJ_SW_IllusionistAtEntrance",CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,_Player);
NOT DB_FTJ_SW_IllusionistAtEntrance_Teleport_In_01(_Player);

IF
ObjectFlagSet("FTJ_SW_RevealIllusion",CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,_)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_EntranceIllusion",CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd);

IF
ObjectFlagSet("FTJ_SW_RevealIllusion",(ITEMGUID)_Item,_)
AND
CharacterCanSee(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,_Item,1)
AND
_Item != CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd
AND
QueryOnlyOnce("FTJ_IllusionistSawPlayer_Use_Trap")
THEN
CharacterLookAt(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,_Item,0);
Proc_StartDialog(1,"FTJ_SW_AD_IllusionistSawUseIllusion",CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd);

IF
ObjectFlagSet("FTJ_SW_RevealIllusion",_Illusion,_)
THEN
ProcObjectTimer(_Illusion,"FTJ_SW_RevealIllusion_RemoveMesh",1500);

PROC
ProcObjectTimerFinished(_Illusion,"FTJ_SW_RevealIllusion_RemoveMesh")
THEN
SetStoryEvent(_Illusion,"FTJ_SW_RevealIllusion_RemoveMesh");

IF
CharacterDying(_Illusion)
AND
DB_SW_IllusionistsIllusions(_Illusion)
THEN
//PlayAnimation(_Illusion,"Teleport_Out_01");
PlayEffect(_Illusion,"RS3_FX_GP_ScriptedEvent_IllusionDeath_01","Dummy_Root");

IF
CharacterDied(_Illusion)
AND
DB_SW_IllusionistsIllusions(_Illusion)
THEN
ProcObjectTimer(_Illusion,"FTJ_SW_IllusionDeath_Delay",3300);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Illusion,"FTJ_SW_IllusionDeath_Delay")
THEN
SetOnStage(_Illusion,0);
//Poof(_Illusion);
//END_REGION

//REGION Chest Room

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_FTJ_ChestRoomIllusionistSpawn_Poly_38043f55-5dac-493c-8c27-afcb13d91b8d)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
QRY_SpeakerIsAvailable(_Player)
AND
CharacterIsDead(CHARACTERGUID_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0)
THEN
CharacterAppearCustom(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503,"Teleport_In_01","");
DB_FTJ_SW_ChestRoomIllusionist_Teleport_In_01(_Player);
ProcObjectTimer(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"S_FTJ_SW_ChestRoomIllusionist_Teleport_In_01",1300);
//Foop(CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503);

PROC
ProcObjectTimerFinished(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,"S_FTJ_SW_ChestRoomIllusionist_Teleport_In_01")
AND
DB_FTJ_SW_ChestRoomIllusionist_Teleport_In_01(_Player)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
CharacterIsDead(CHARACTERGUID_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
NOT DB_FTJ_SW_ChestRoomIllusionist_Teleport_In_01(_Player);
ProcForceStopDialog(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd);
Proc_StartDialog(0,"FTJ_SW_IllusionistInChestRoom",CHARACTERGUID_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503,_Player);

PROC
ProcOneShotTriggerEntered((CHARACTERGUID)_Player,TRIGGERGUID_S_FTJ_ChestRoomIllusionistAutoStopDialog_Box_a0d8aac6-8ea2-4423-8a4c-e811b619634b)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503,0)
THEN
ProcForceStopDialog(CHARACTERGUID_S_FTJ_SW_ChestRoomIllusionist_001_d656548b-329c-4ce4-ae61-984feb732503);

IF
DialogEnded("FTJ_SW_IllusionistInChestRoom",_)
AND
DB_FTJ_SW_ChestRoomIllusions((CHARACTERGUID)_Illusion)
AND
ObjectIsOnStage(_Illusion,0)
THEN
CharacterAppearCustom(_Illusion,"Teleport_In_01","");

IF
DialogEnded("FTJ_SW_IllusionistInChestRoom",_)
AND
DB_FTJ_SW_ChestRoomIllusions((CHARACTERGUID)_Illusion)
THEN
//SetOnStage(_Illusion,1);
ProcSetRelationToPlayers(_Illusion,0);


IF
DialogEnded("FTJ_SW_IllusionistInChestRoom",_)
THEN
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_SW_IllusionistAtEntrance_e01c3723-872a-454d-a59b-d798b21183cd,0);

PROC
ReactOnKillCounter("FTJ_SW_ChestRoomIllusion")
AND
GetPosition(ITEMGUID_S_FTJ_SW_IllusionistTrapChest_001_9ebe7612-201b-4609-b888-9d8874987cd6,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);
SetOnStage(ITEMGUID_S_FTJ_SW_IllusionistTrapChest_001_9ebe7612-201b-4609-b888-9d8874987cd6,1);

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_SW_IllusionistTrapChest_001_9ebe7612-201b-4609-b888-9d8874987cd6)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
QueryOnlyOnce("FTJ_SW_FoopLaughingIllusion")
THEN
CharacterAppearCustom(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308,"Teleport_In_01","");

//TODO: Audio Add Laughter Event here
//Foop(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308);

//END_REGION

//REGION Statue Room

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_SW_RiddleStatue_24d4387c-fac7-46ef-88f4-8ba7947279b8)
AND
NOT DB_FTJ_SW_BlockSummonAncientIllusionist(1)
AND
GlobalGetFlag("FTJ_SW_RiddlePass",0)
THEN
DB_FTJ_SW_BlockSummonAncientIllusionist(1);
Proc_StartDialog(0,"FTJ_SW_RiddleIllusion",ITEMGUID_S_FTJ_SW_RiddleStatue_24d4387c-fac7-46ef-88f4-8ba7947279b8,_Player);

IF
DialogEnded("FTJ_SW_RiddleIllusion",_ID)
THEN
NOT DB_FTJ_SW_BlockSummonAncientIllusionist(1);

IF
DialogEnded("FTJ_SW_RiddleIllusion",_ID)
AND
GlobalGetFlag("FTJ_SW_RiddlePass",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
ItemUnLock(ITEMGUID_S_FTJ_SW_DoorToIllusionistBossRoom_2c7dbfde-855d-4a31-b149-2a459c9a1910);
ItemOpen(ITEMGUID_S_FTJ_SW_DoorToIllusionistBossRoom_2c7dbfde-855d-4a31-b149-2a459c9a1910);
PartyAddExperience(_Player,1,6,7);

IF
DialogEnded("FTJ_SW_RiddleIllusion",_)
AND
GlobalGetFlag("FTJ_SW_RiddleFail",1)
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_FTJ_SW_SUB_RiddleRoom_8c4180c8-e234-4993-8edf-945823ef4209)
THEN
Proc_ShakeCameraForTime(_Player,2000);

IF
DialogEnded("FTJ_SW_RiddleIllusion",_ID)
AND
GlobalGetFlag("FTJ_SW_RiddleFail",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
GlobalClearFlag("FTJ_SW_RiddleFail");
CharacterItemSetEvent(_Player,ITEMGUID_S_FTJ_SW_RiddleStatue_24d4387c-fac7-46ef-88f4-8ba7947279b8,"FTJ_SW_RiddleIllusion");

//END_REGION

//REGION Boss Room

IF
CharacterDying(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d)
AND
DB_SW_IllusionistsIllusions(_Illusion)
AND
CharacterIsDead(_Illusion,0)
THEN
CharacterDie(_Illusion,0,"DoT");
ItemSetCanInteract(ITEMGUID_S_FTJ_SW_RiddleStatue_24d4387c-fac7-46ef-88f4-8ba7947279b8,0);

IF
CharacterDied(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag((CHARACTERGUID)_Player,"QuestUpdate_FTJ_SW_Illusionist_Start_FindEntrance",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_KillIllusionist");

PROC
ProcLaunchAmbush(TRIGGERGUID_S_FTJ_SW_IllusionistBossDialog_Poly_55ba1b73-55a6-4e22-b340-1b4469b6a99b,_Player)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
CharacterIsDead(CHARACTERGUID_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0)
THEN
CharacterAppearCustom(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,"Teleport_In_01","");
Proc_StartDialog(1,"FTJ_SW_AD_IllusionistBoss",CHARACTERGUID_S_FTJ_SW_IllusionPhase1_002_bf948008-5ba1-4573-84ff-4a81912d7848);
CharacterSetArmorPercentage(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,100.0);
CharacterSetMagicArmorPercentage(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,100.0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_LaughingIllusion_2e275231-d62d-4726-80f8-259e0c2f3308,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0);

PROC
ProcLaunchAmbush(TRIGGERGUID_S_FTJ_SW_IllusionistBossDialog_Poly_55ba1b73-55a6-4e22-b340-1b4469b6a99b,_Player)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
DB_FTJ_SW_IllusionistPhase1Illusions((CHARACTERGUID)_Illusion)
THEN
CharacterAppearCustom(_Illusion,"Teleport_In_01","");
ProcSetRelationToPlayers(_Illusion,0);
CharacterSetArmorPercentage(_Illusion,100.0);
CharacterSetMagicArmorPercentage(_Illusion,100.0);


PROC
ProcLaunchAmbush(TRIGGERGUID_S_FTJ_SW_IllusionistBossDialog_Poly_55ba1b73-55a6-4e22-b340-1b4469b6a99b,_Player)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0)
THEN
CharacterAppearCustom(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,"Teleport_In_01","");
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0);

IF
GlobalFlagSet("FTJ_SW_IllusionistStartPhase2")
AND
QueryOnlyOnce("FTJ_SW_IllusionistPhase_2")
AND
DB_FTJ_SW_IllusionistPhase2Illusions((CHARACTERGUID)_Illusion)
AND
GetPosition(_Illusion,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Trompedoy_Summon_01",_X,_Y,_Z);
CharacterAppearCustom(_Illusion,"Teleport_In_01","");
ProcSetRelationToPlayers(_Illusion,0);
CharacterSetArmorPercentage(_Illusion,100.0);
CharacterSetMagicArmorPercentage(_Illusion,100.0);

//END_REGION

//REGION Soul Jars

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_FTJ_SW_OneShot_IllusionistJar_3e18e8cd-0269-4123-8c07-0f86b95506ad)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
THEN
ProcObjectTimer(_Player,"Timer_FTJ_SW_IllusionistSoulJar",200);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"Timer_FTJ_SW_IllusionistSoulJar")
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
THEN
CharacterAppearCustom(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"Teleport_In_01","");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_IllusionistRevive");
ProcObjectTimer(_Player,"Timer_FTJ_SW_IllusionistSoulJar_DelayDialog",400);


PROC
ProcObjectTimerFinished(_Player,"Timer_FTJ_SW_IllusionistSoulJar_DelayDialog")
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
NOT QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_IllusionistJar",CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d);

PROC
ProcObjectTimerFinished(_Player,"Timer_FTJ_SW_IllusionistSoulJar_DelayDialog")
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(0,"FTJ_SW_IllusionistJar",CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,_Player);

IF
DialogEnded("FTJ_SW_IllusionistJar",_)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
ObjectGetFlag(_Player,"FTJ_SW_IllusionistDungeon_DestroySoulJar",0)
THEN
ProcObjectTimer(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"Teleport_Out_01",1900);
PlayAnimation(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"Teleport_Out_01");

IF
DialogEnded("FTJ_SW_IllusionistJar",_)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
ObjectGetFlag(_Player,"FTJ_SW_IllusionistDungeon_DestroySoulJar",1)
THEN
PlayEffect(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"RS3_FX_GP_ScriptedEvent_Illusion_Death_01");
ProcObjectTimer(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"RS3_FX_GP_ScriptedEvent_Illusion_Death_01_Poof",1900);
//Poof(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d);

IF
AutomatedDialogStarted("FTJ_SW_AD_IllusionistJar",_)
THEN
PlayEffect(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"RS3_FX_GP_ScriptedEvent_Illusion_Death_01");

IF
AutomatedDialogEnded("FTJ_SW_AD_IllusionistJar",_)
THEN
Poof(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d);

PROC
ProcObjectTimerFinished(_NPC,"RS3_FX_GP_ScriptedEvent_Illusion_Death_01_Poof")
THEN
Poof(_NPC);

PROC
ProcObjectTimerFinished(_NPC,"Teleport_Out_01")
THEN
SetOnStage(_NPC,0);

IF
DialogEnded("FTJ_SW_SoulJar_Illusionist",_)
AND
ObjectGetFlag(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,"Absorb_SoulJar",1)
THEN
DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1);

IF
DialogEnded("FTJ_SW_SoulJar_Illusionist",_)
AND
ObjectGetFlag(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,"Absorb_SoulJar",1)
AND
DB_SW_IllusionsCheck(_Illusion)
AND
DB_SW_IllusionOnStage(_Illusion)
THEN
ProcForceStopDialog(_Illusion);
CharacterDie(_Illusion,0,"DoT");
//Poof(_Illusion);

IF
ItemDestroyed(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
THEN
DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1);


IF
ObjectFlagSet("FTJ_SW_IllusionistDungeon_DestroySoulJar",(CHARACTERGUID)_Player,_)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
CharacterCanSee(_Player,ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,1)
THEN
ItemSetCanInteract(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,0);
ProcForceStopDialog(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa);
ProcCharacterMoveTo(_Player,ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,0,"");

IF
DialogEnded("FTJ_SW_IllusionistJar",_Inst)
AND
NOT DB_FTJ_SW_IllusionistDungeon_JarDestroyed(1)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
ObjectGetFlag(_Player,"FTJ_SW_IllusionistDungeon_DestroySoulJar",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_DestroyIllusionistJar");
ItemDestroy(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa);


IF
ItemDestroyed(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
AND
ObjectIsOnStage(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,1)
THEN
PlayEffect(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,"RS3_FX_GP_ScriptedEvent_SourceJar_Death_Impact_01");
CharacterDie(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,1,"DoT");

IF
ItemDestroyed(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
AND
ObjectIsOnStage(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,0)
THEN
CharacterAppear(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,1,"FTJ_SW_IllusionistSetToDie");

IF
StoryEvent((CHARACTERGUID)CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,"FTJ_SW_IllusionistSetToDie")
THEN
PlayEffect(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,"RS3_FX_GP_ScriptedEvent_SourceJar_Death_Impact_01");
CharacterDie(CHARACTERGUID_S_FTJ_TrueIllusionist_a3b10150-1871-48a4-9d64-f51c84316b6d,1,"DoT");

IF
ItemDestroyed(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
AND
DB_SW_IllusionsCheck(_Illusion)
AND
DB_SW_IllusionOnStage(_Illusion)
THEN
ProcForceStopDialog(_Illusion);
CharacterDie(_Illusion,0,"DoT");
//Poof(_Illusion);

IF
DialogEnded("FTJ_SW_SoulJar_Illusionist",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(ITEMGUID)ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,"Absorb_SoulJar",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_AbsorbedIllusionistJar");

IF
DialogEnded("FTJ_SW_SoulJar_Illusionist",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(ITEMGUID)ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa,"Destroy_SoulJar",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_DestroyIllusionistJar");

IF
CharacterDestroyedItem(_Player, ITEMGUID_S_FTJ_SW_SoulJar_Illusionist_8ed6b714-24b1-4f97-a02b-c5b95c2b69aa)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_Illusionist_DestroyIllusionistJar");
//END_REGION

IF
ItemTemplateAddedToCharacter(WPN_Wand_Purging_2b4412a5-467a-44ae-9d7b-bf39a06794b2,_,_Player)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"FTJ_PickedPurgingWand",0)
THEN
UserSetFlag(_Player,"FTJ_PickedPurgingWand");
StartVoiceBark("FTJ_SW_VB_PickedPurgingWand",_Player);

IF
ItemTemplateAddedToCharacter(WPN_Wand_Purging_Inert_90f4ab1d-0595-4f06-8d0e-89bff5afe26b,_,_Player)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"FTJ_PickedPurgingWandInert",0)
THEN
UserSetFlag(_Player,"FTJ_PickedPurgingWandInert");
StartVoiceBark("FTJ_SW_VB_PickedPurgingWandInert",_Player);

IF
CharacterUsedItem(_Player,ITEMGUID_S_BOOK_FTJ_Map_VaultBlueprint_000_8e83a6bf-2665-4886-aa5d-a67418cb267c)
AND
DB_IsPlayer(_Player)
THEN
ProcHideMarker((CHARACTERGUID)_Player,"FTJ_SW_IllusionDungeonHint");
ProcShowMarker((CHARACTERGUID)_Player,"FTJ_SoulJarVault");
UserSetFlag((CHARACTERGUID)_Player,"QuestUpdate_FTJ_SW_Illusionist_FoundMap");
UserSetFlag((CHARACTERGUID)_Player,"QuestUpdate_FTJ_SW_StuckHaunting_FoundMap");
UserSetFlag((CHARACTERGUID)_Player,"QuestUpdate_FTJ_SW_Necromancers_FoundMap");

//REGION Cursed Ring

IF
ItemEquipped(ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,_Player)
AND
DB_IsPlayer(_Player)
THEN
Proc_FTJ_ApplyBraccusRingCurse(_Player);

IF
ItemAddedToCharacter(ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,(CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QueryOnlyOnce("FTJ_BraccusCurseRingDialog_OneShot")
THEN
Proc_StartDialog(0,"FTJ_SW_BraccusCurseRing",ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,_Player);
ObjectSetFlag(_Player,"QuestAdd_FTJ_SW_CursedRing");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_Start");

PROC
Proc_FTJ_ApplyBraccusRingCurse((CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
AND
DB_IsPlayer(_OtherPlayer)
AND
_Player != _OtherPlayer
AND
ObjectGetFlag(_OtherPlayer,"FTJ_SW_HasBraccusRingCurse",1)
THEN
ObjectClearFlag(_OtherPlayer,"FTJ_SW_HasBraccusRingCurse",0);

PROC
Proc_FTJ_ApplyBraccusRingCurse((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",0)
THEN
RemoveStatus(_Player,"BLESSED");
ApplyStatus(_Player,"CURSED",-1.0,1);
ObjectSetFlag(_Player,"FTJ_SW_HasBraccusRingCurse");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_CurseApply");

IF
CharacterStatusAttempt((CHARACTERGUID)_Player,"BLESSED",_)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",1)
THEN
CharacterUnequipItem(_Player,ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae);
ObjectClearFlag(_Player,"FTJ_SW_HasBraccusRingCurse",0);

IF
CharacterStatusAttempt((CHARACTERGUID)_Player,"BLESSED",_)
AND
CharacterGetEquippedItem(_Player,"Ring",_Ring1)
AND
_Ring1 == ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae
AND
HasActiveStatus(_Player,"CURSED",1)
THEN
CharacterUnequipItem(_Player,ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae);


IF
CharacterStatusAttempt((CHARACTERGUID)_Player,"BLESSED",_)
AND
CharacterGetEquippedItem(_Player,"Ring2",_Ring2)
AND
_Ring2 == ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae
AND
HasActiveStatus(_Player,"CURSED",1)
THEN
CharacterUnequipItem(_Player,ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae);


IF
ObjectFlagSet("FTJ_SW_HasBraccusRingCurse",_Player,_)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_CurseRingApplied",_Player);

IF
ObjectFlagCleared("FTJ_SW_HasBraccusRingCurse",_Player,_)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_CurseRingRemoved",_Player);
RemoveStatus(_Player,"CURSED");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_RemoveCurse");

IF
ItemUnEquipped(ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",1)
AND
NOT DB_FTJ_SW_DidCurseRingUnequipDialog(_Player)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_CurseRingUnequipped",_Player);
DB_FTJ_SW_DidCurseRingUnequipDialog(_Player);
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_TakeOff");

IF
CharacterResurrected(_Player)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",1)
THEN
ApplyStatus(_Player,"CURSED",-1.0,1);


IF
CharacterStatusRemoved(_Player,"CURSED",_)
AND
HasAppliedStatus(_Player,"CURSED",0)
AND
HasAppliedStatus(_Player,"BLESSED",0)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",1)
THEN
ApplyStatus(_Player,"CURSED",-1.0,1);


//END_REGION

IF
ObjectFlagSet("FTJ_SW_ShowIllusionistHint", _Player, _)
THEN
ProcShowMarker((CHARACTERGUID)_Player, "FTJ_SW_IllusionDungeonHint");


//REGION Debug 

IF
TextEventSet("FTJ_SW_IllusionistPhase2Illusions_FX")
AND
DB_FTJ_SW_IllusionistPhase2Illusions((CHARACTERGUID)_Illusion)
AND
GetPosition(_Illusion,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Trompedoy_Summon_01",_X,_Y,_Z);
CharacterAppear(_Illusion,1,"");
ProcSetRelationToPlayers(_Illusion,0);
CharacterSetArmorPercentage(_Illusion,100.0);
CharacterSetMagicArmorPercentage(_Illusion,100.0);

IF
TextEventSet("FTJ_SW_IllusionistTeleport_Out_01")
THEN
SetOnStage(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,1);
ProcObjectTimer(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"Teleport_Out_01",1900);
PlayAnimation(CHARACTERGUID_S_FTJ_SW_IllusionistFinal_1a3b44d4-0ba4-4289-b158-a54111b83e1d,"Teleport_Out_01");
//END_REGION 
EXITSECTION
ItemSetForceSynch(ITEMGUID_S_FTJ_SW_IllusionistDungeonEntrance_00b9cf78-d62d-4e6f-a0d5-cc80714da014,0);
ENDEXITSECTION
ParentTargetEdge "FortJoy"
