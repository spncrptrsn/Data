Version 1
SubGoalCombiner SGC_AND
INITSECTION
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DU_Caravan_Box_af654fb9-679b-4f79-bb99-0060b0386156);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_DU_Caravan_Box_af654fb9-679b-4f79-bb99-0060b0386156);

DB_Dialogs(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, "RC_DU_Caravan_SurvivingDwarf");
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, "Cower_03_Loop");
ProcCharacterDisableCrime(S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,"Assault");
//DB_Dialogs(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa, "RC_DU_Caravan_GhostMagisterAndDwarf");


DB_Ghosts(CHARACTERGUID_S_RC_DU_Caravan_Animals_Bull_52decead-a3cd-4941-8506-6be9d4db7309, CHARACTERGUID_S_RC_DU_Caravan_Animals_Bull_Ghost_52dc3883-2a72-4a6a-8809-9c6a6fda218f,"RC_DU_Caravan_GhostBull");
DB_Ghosts(CHARACTERGUID_S_RC_DU_Caravan_DeadMagisterGrunt_5508277d-09e8-4ec2-93c5-3824a0e86a88, CHARACTERGUID_S_RC_DU_Caravan_GhostMagisterGrunt_009a6001-ba8c-4d54-b774-159c31d4ba50,"RC_DU_Caravan_MagisterGrunt");
DB_Ghosts(CHARACTERGUID_S_RC_DU_Caravan_DeadDwarfBossSon_66c2bf72-3e8e-4e43-96df-3a154cd81cf5, CHARACTERGUID_S_RC_DU_Caravan_GhostDwarfBossSon_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,"");
DB_Ghosts(CHARACTERGUID_S_RC_DU_Caravan_DeadMagister_09ab81e9-aa82-486d-b9f4-e172732d4bb8, CHARACTERGUID_S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,"");

/*
CharacterLinkGhost(CHARACTERGUID_S_RC_DU_Caravan_DeadDwarfBossSon_66c2bf72-3e8e-4e43-96df-3a154cd81cf5, CHARACTERGUID_S_RC_DU_Caravan_GhostDwarfBossSon_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa);
CharacterSetImmortal(CHARACTERGUID_S_RC_DU_Caravan_GhostDwarfBossSon_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa, 1);
CharacterLinkGhost(CHARACTERGUID_S_RC_DU_Caravan_DeadMagister_09ab81e9-aa82-486d-b9f4-e172732d4bb8, CHARACTERGUID_S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29);
CharacterSetImmortal(CHARACTERGUID_S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,1);
*/


//ItemToInventory(ITEMGUID_S_RC_DU_Caravan_DwarfBoss_Orders_93c48f97-6e1c-4a2c-86de-ed8d1c89e381,CHARACTERGUID_S_RC_DU_Caravan_Dead_Liliansson_66c2bf72-3e8e-4e43-96df-3a154cd81cf5); Trying to delete
ItemToInventory(ITEMGUID_S_RC_DU_Caravan_DwarfBoss_Family_Boots_bada2227-ae1f-4aa9-a889-1bcad74959ec,CHARACTERGUID_S_RC_DU_Caravan_Dead_Liliansson_66c2bf72-3e8e-4e43-96df-3a154cd81cf5);


DB_RC_DU_Caravan_BloodiedBodylimbs(S_RC_DU_Caravan_VoidTainted_BodyPart_001_b1dabd59-6493-4a1d-96c3-b77e053bbf7e);
DB_RC_DU_Caravan_BloodiedBodylimbs(S_RC_DU_Caravan_VoidTainted_BodyPart_002_2a2ca906-4b2d-4ba7-ab2e-f68eb0a6ad7c);
DB_RC_DU_Caravan_BloodiedBodylimbs(S_RC_DU_Caravan_VoidTainted_BodyPart_003_75f2c498-552e-4b55-957c-bde40029d6e2);
DB_RC_DU_Caravan_BloodiedBodylimbs(S_RC_DU_Caravan_VoidTainted_BodyPart_004_8cdfc914-c0c6-4a6e-850f-dbea4fbebb2c);
DB_RC_DU_Caravan_BloodiedBodylimbs(S_RC_DU_Caravan_VoidTainted_BodyPart_005_7ef238da-5ed8-474a-b4a0-ac87945643b0);
DB_RC_DU_Caravan_BloodiedBodylimbs(S_LOOT_Human_Bodypart_Leg_A_Fresh_Sourcerer_000_a2f7f4a4-83f4-4b16-b517-91c0a06170a8);
proc_RC_DU_Caravan_AddBloodToTaintedLimbs();
KBSECTION
//RC_DU_Caravan_GhostMagisterAndDwarf

//REGION Journal updates

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DU_Caravan_Box_af654fb9-679b-4f79-bb99-0060b0386156)
AND
PartyGetFlag(_Player,"RC_DU_SeenCaraven",0)
THEN
PartySetFlag(_Player, "RC_DU_SeenCaraven",0);
StartVoiceBark("RC_DU_VB_SeenCaraven", _Player);
PartySetFlag(_Player, "QuestAdd_RC_DW_WreckedCaravan");
PartySetFlag(_Player, "QuestUpdate_RC_DW_WreckedCaravan_SawCaravan");

IF
ObjectFlagSet("RC_DU_UpdateWreckedCaravan",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"RC_DW_WreckedCaravan_KnowOfGhostsContacts");
PartySetFlag(_Player,"QuestUpdate_RC_DW_WreckedCaravan_KnowOfGhostsContacts");

IF
ObjectFlagSet("RC_DU_ToldLilianAboutCaravan",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_WreckedCaravan_ToldLilian");
//PartySetFlag(_Player,"QuestClose_RC_DW_WreckedCaravan");

IF
ObjectFlagSet("RC_DU_ToldMagisterAboutCaravan",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_WreckedCaravan_ToldMagister");
//PartySetFlag(_Player,"QuestClose_RC_DW_WreckedCaravan");

IF
SkillAdded(_Player,"Shout_SpiritVision",_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_DU_SeenCaraven",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_WreckedCaravan_HaveSourceVision");

//END_REGION

//REGION Add Blood to the Limbs

PROC
proc_RC_DU_Caravan_AddBloodToTaintedLimbs()
AND
DB_RC_DU_Caravan_BloodiedBodylimbs(_Item)
THEN
CreatePuddle(_Item,"SurfaceBlood",3,7,3,4,0.02);
//END_REGION

//REGION  Ghosts Disappear

// Magister Dumuri poofs
IF
CharacterUsedSkillOnTarget(_Player,S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
THEN
GlobalSetFlag("RC_DU_Caravan_GhostMagisterPoofed");

IF
ObjectFlagSet("GLO_GhostSuck",S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,_)
THEN
GlobalSetFlag("RC_DU_Caravan_GhostMagisterPoofed");


// Dwarf boss' son poofs
IF
CharacterUsedSkillOnTarget(_Player,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
THEN
GlobalSetFlag("RC_DU_Caravan_LilianssonPoofed");

IF
ObjectFlagSet("GLO_GhostSuck",S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_)
THEN
GlobalSetFlag("RC_DU_Caravan_LilianssonPoofed");

///TODO Remove after Char finishes the dialog
IF
GlobalFlagSet("RC_DU_Caravan_LilianssonPoofed")
THEN
GlobalSetFlag("RC_DU_Caravan_LilianssonGone");

IF
GlobalFlagSet("RC_DU_Caravan_LilianssonVanished")
THEN
GlobalSetFlag("RC_DU_Caravan_LilianssonGone");

IF
GlobalFlagSet("RC_DU_Caravan_GhostMagisterPoofed")
THEN
GlobalSetFlag("RC_DU_Caravan_GhostMagisterGone");

IF
GlobalFlagSet("RC_DU_Caravan_GhostMagisterVanished")
THEN
GlobalSetFlag("RC_DU_Caravan_GhostMagisterGone");
//END_REGION

//REGION Ghost Arguing  
//Starting Dialog with The Arguing Ghosts
PROC
PROC_GLOBAL_DialogStartRequested(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,_Player)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
proc_RC_DU_Caravan_StartDialogWithGhosts(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,_Player);

PROC
PROC_GLOBAL_DialogStartRequested(S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_Player)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
proc_RC_DU_Caravan_StartDialogWithGhosts(S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_Player);

PROC
proc_RC_DU_Caravan_StartDialogWithGhosts((CHARACTERGUID)_NPC,(CHARACTERGUID)_Player)
THEN
DB_NOOP(1);

PROC
proc_RC_DU_Caravan_StartDialogWithGhosts(_NPC,_Player)
AND
GlobalGetFlag("RC_DU_Caravan_LilianssonGone",0)
AND
GlobalGetFlag("RC_DU_Caravan_GhostMagisterGone",0)
THEN
Proc_StartDialog(0,"RC_DU_Caravan_GhostMagisterAndDwarf",S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_Player);

PROC
proc_RC_DU_Caravan_StartDialogWithGhosts(_NPC,_Player)
AND
GlobalGetFlag("RC_DU_Caravan_LilianssonGone",1)
AND
GlobalGetFlag("RC_DU_Caravan_GhostMagisterGone",0)
THEN
Proc_StartDialog(0,"RC_DU_Caravan_GhostMagisterAndDwarf",S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,NULL_00000000-0000-0000-0000-000000000000,_Player);

PROC
proc_RC_DU_Caravan_StartDialogWithGhosts(_NPC,_Player)
AND
GlobalGetFlag("RC_DU_Caravan_LilianssonGone",0)
AND
GlobalGetFlag("RC_DU_Caravan_GhostMagisterGone",1)
THEN
Proc_StartDialog(0,"RC_DU_Caravan_GhostMagisterAndDwarf",NULL_00000000-0000-0000-0000-000000000000,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_Player);

IF 
CharacterStatusApplied(S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,"SPIRIT",_)
AND
HasActiveStatus(S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,"SPIRIT",1)
AND
QRY_SpeakerIsAvailable(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29)
THEN
Proc_StartDialog(0,"RC_DU_AD_CravanGhostsArgue",S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29);

IF
AttackedByObject(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa,_,_,_)
THEN
Proc_StartDialog(1,"RC_DU_AD_Caravan_GhostMagisterGotHit",S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29);

IF
ObjectFlagSet("RC_DU_Caravan_GhostMagisterHitDwarf",S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,_ID)
THEN
CharacterAttack(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa);

IF
AutomatedDialogEnded("RC_DU_AD_CravanGhostsArgue",_ID)
AND
DialogGetInvolvedNPC(_ID,2,_NPC)
AND
ObjectGetFlag(_NPC,"RC_DU_Caravan_GhostMagisterHitDwarf",1)
THEN
ObjectClearFlag(_NPC,"RC_DU_Caravan_GhostMagisterHitDwarf",_ID);

/*
IF
AutomatedDialogEnded("RC_DU_AD_Caravan_GhostMagisterGotHit",_ID)
AND
QRY_SpeakerIsAvailable(S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa)
THEN
CharacterAttack(S_RC_DU_Caravan_GhostMagister_5b36ece1-5fa7-4505-96e5-8b9a92106a29,S_RC_DU_Caravan_Liliansson_ea9a590b-38bd-40f8-9c1d-4b61ee2437fa);
*/


//END_REGION 

//REGION Talking to the Shell Shocked Dwarf 
IF
DialogStarted("RC_DU_Caravan_SurvivingDwarf",_ID)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, "");
CharacterSetFightMode(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,1,0);

IF
ObjectFlagSet("RC_DU_Caravan_SurvivingDwarf_HasMet",_Char,_)
THEN
CharacterLookAt(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,_Char);

IF
DialogStarted("RC_DU_Caravan_SurvivingDwarf_COM_Beast",_ID)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, "");
CharacterSetFightMode(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,1,0);


IF
ObjectFlagSet("RC_DU_Caravan_SurvivingDwarf_CombatModeOff",CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,_ID)
THEN
CharacterSetFightMode(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,0,0);

IF
ObjectFlagSet("RC_DU_Caravan_ShowUnderTavernMarker",_Player,_)
THEN
PartySetFlag((CHARACTERGUID)_Player, "QuestUpdate_RC_DW_WreckedCaravan_FindLilian");

IF
DialogEnded("RC_DU_Caravan_SurvivingDwarf",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"RC_DU_Caravan_SurvivingDwarfFlee",1)
THEN
ProcCharacterDisappearOutOfSight(_NPC,0,1,"",1);
SetHasDialog(_NPC,0);

IF
CharacterReceivedDamage(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, _, _)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,"");

IF
ObjectEnteredCombat(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,_CombatID)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,"");

IF
CharacterReceivedDamage(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8, _, _)
AND
CharacterIsInCombat(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,0)
THEN
Proc_StartDialog(1,"RC_AD_DU_Caravan_SurvivingDwarf",S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,0,1,"",1);
SetHasDialog(CHARACTERGUID_S_RC_DU_Caravan_SurvivingDwarf_1c3759c4-284d-46e1-98e0-da880d9f3da8,0);

//END_REGION



//REGION Talking to the Shell Shocked Dwarf 

IF
TextEventSet("DU_Caravan_Set_DWFlags")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"RC_DW_WhiteMagister_SaidSawCaravan");

//END_REGION

IF
DialogStarted(_,_Inst)
AND
DialogGetInvolvedPlayer(_Inst,1,(CHARACTERGUID)_Player)
AND
CharacterHasSkill(_Player,"Target_Bless",1)
THEN
ObjectSetFlag(_Player,"Has_Bless");

IF
DialogStarted(_,_Inst)
AND
DialogGetInvolvedPlayer(_Inst,1,(CHARACTERGUID)_Player)
AND
CharacterHasSkill(_Player,"Target_Bless",0)
THEN
ObjectClearFlag(_Player,"Has_Bless",0);

IF
ObjectFlagSet("Use_Bless",(CHARACTERGUID)_Player,_Inst)
AND
DialogGetInvolvedNPC(_Inst,1,(CHARACTERGUID)_NPC)
THEN
ObjectClearFlag(_Player,"Use_Bless",0);
CharacterUseSkill(_Player,"Target_Bless",_NPC);



EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
