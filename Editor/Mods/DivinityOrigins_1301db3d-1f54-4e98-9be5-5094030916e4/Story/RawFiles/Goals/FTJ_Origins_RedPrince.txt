Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DoNotFace(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

ItemToInventory(ITEMGUID_S_FTJ_RPAssassinLetter_1e954a73-e708-4487-b66f-7cdcf0f38d24,CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
DB_Dialogs(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,"FTJ_RedPrinceAssassin");
DB_TriggerSendsSpotEvents(S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e);
TriggerRegisterForCharacter(S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e, CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
TeleportTo(CHARACTERGUID_S_GLO_Brahmos_d4064352-33f9-49df-b208-09fd822d2270, TRIGGERGUID_S_FTJ_SW_RedPrince_BrahmosDreamPoint_8fd01b29-1674-44cb-ac3c-e03495a51b9f);
CharacterLookFromTrigger(CHARACTERGUID_S_GLO_Brahmos_d4064352-33f9-49df-b208-09fd822d2270, TRIGGERGUID_S_FTJ_SW_RedPrince_BrahmosDreamPoint_8fd01b29-1674-44cb-ac3c-e03495a51b9f, 1);

Proc_FTJ_Origins_RedPrince_Start();
SetOnStage(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, 0);

DB_FTJ_SW_Origins_RedPrince_BaharaTriggers((TRIGGERGUID)S_FTJ_SW_BaharaUpTrigger1_aea57e1d-016e-4e62-a2da-8c345d5f63b0,(TRIGGERGUID)S_FTJ_SW_RedPrinceBaharaUp1COM_Point_e5d8127c-8094-4375-9d44-0a71e2c88720);
DB_FTJ_SW_Origins_RedPrince_BaharaTriggers(TRIGGERGUID_S_FTJ_SW_BaharaUpTrigger2_fc2f5257-dddd-4185-8c36-d025b68ab1ef,TRIGGERGUID_S_FTJ_SW_RedPrinceBaharaUp2COM_Point_f0f9f802-50fc-4a1b-bf67-5883f5ae0e18);

DB_FTJ_SW_CheckpointSourcererDialogs("FTJ_SW_CheckpointSourcerer");
DB_FTJ_SW_CheckpointSourcererDialogs("FTJ_SW_CheckpointSourcerer_COM_RedPrince");

CharacterAddPreferredAiTargetTag(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,"RED PRINCE");
KBSECTION
IF
ObjectFlagSet("FTJ_ORI_RedPrinceAttack",(CHARACTERGUID)_Player,_)
THEN
ApplyStatus(_Player,"KNOCKED_DOWN",1.0,1);
CharacterLookAt(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player,1);
PlayAnimation(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"attack3");
PlayEffect(_Player,"RS3_FX_GP_Combat_Hit_Blood_01_Large");
ApplyDamage(_Player,2,"Physical");
SetStoryEvent(_Player,"Play_Anim_knockdown_getup");
ProcObjectTimer(_Player,"FTJ_ORI_RedPrinceAttack",400);

PROC
ProcObjectTimerFinished(_Player,"FTJ_ORI_RedPrinceAttack")
THEN
CreateSurface(_Player,"SurfaceBlood",0.1,-1.0);

PROC
Proc_FTJ_Origins_RedPrince_Start()
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_RPWashedAshore");

PROC
Proc_COMFinished("FTJ_LizardDreamer_COM_RedPrince",(CHARACTERGUID)_Avatar)
THEN
UserSetFlag(_Avatar,"QuestUpdate_FTJ_COM_RedPrince_Stingtail");

PROC
Proc_COMFinished("FTJ_SW_CheckpointSourcerer_COM_RedPrince",(CHARACTERGUID)_Avatar)
THEN
UserSetFlag(_Avatar,"QuestUpdate_FTJ_COM_RedPrince_Bahara");
GlobalSetFlag("GLO_RedPrince_BaharaFinished");

IF
GlobalFlagSet("FTJ_SW_ShelterAccessible")
THEN
DB_OriginMomentTag("FTJ_SW_CheckpointSourcerer","RED PRINCE","FTJ_SW_CheckpointSourcerer_COM_RedPrince");

//REGION Stingtail Drudenae Checks
IF
ItemTemplateAddedToCharacter(_DrudenaeGUID,_Item,_Player)
AND
DB_CurrentLevel("FJ_FortJoy_Main")
AND
String(_DrudenaeGUID,_Drudenae)
AND
DB_DrudenaeTemplates(_Drudenae)
AND
_Item != ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096
THEN
ProcSetMagicPocketsOwnershipFlag(_Player,"FTJ_HasDrudenae");

IF
ItemTemplateRemovedFromCharacter(_Drudenae,_Item,_Player)
AND
DB_CurrentLevel("FJ_FortJoy_Main")
AND
_Item != ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096
AND
DB_DrudenaeTemplates(_Drudenae)
THEN
ProcCheckForFTJDrudenaeFlag(_Player);

//REGION allow for check of Griffs Drud after Amyro freed
//FTJ_ImprissonedSkepticFreed

IF
ItemRemovedFromCharacter(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4)
THEN
DB_HasStoryEvent(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,"FTJ_HasDrudenae");

//END_REGION



PROC
Proc_ItemEventCheck()
AND
DB_CurrentLevel("FJ_FortJoy_Main")
AND
DB_IsPlayer(_Player)
THEN
ProcCheckForFTJDrudenaeFlag(_Player);

PROC
ProcCheckForFTJDrudenaeFlag((CHARACTERGUID)_Player)
AND
DB_DrudenaeTemplates(_Drudenae)
AND
GetTemplate(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,_OlgoTemplate)
THEN
ProcCheckForFTJDrudenaeInMagicPockets(_Player,_Drudenae,_OlgoTemplate);

PROC
ProcCheckForFTJDrudenaeInMagicPockets((CHARACTERGUID)_Player,(STRING)_Drudenae,(STRING)_OlgoTemplate)
AND
_OlgoTemplate != _Drudenae
AND
QryItemTemplateInMagicPockets(_Player,_Drudenae)
THEN
DB_FTJHasDrudenae(1);


PROC
ProcCheckForFTJDrudenaeInMagicPockets((CHARACTERGUID)_Player,(STRING)_Drudenae,(STRING)_OlgoTemplate)
AND
_OlgoTemplate == _Drudenae
AND
QryItemTemplateInMagicPocketsCount(_Player,_Drudenae)
AND
DB_MagicPocketsItemTemplateCount(_Player,_Drudenae,_Count)
AND
_Count > 1
THEN
DB_FTJHasDrudenae(1);

PROC
ProcCheckForFTJDrudenaeFlag((CHARACTERGUID)_Player)
AND
NOT DB_FTJHasDrudenae(1)
THEN
ProcClearMagicPocketsOwnershipFlag(_Player,"FTJ_HasDrudenae");

PROC
ProcCheckForFTJDrudenaeFlag((CHARACTERGUID)_Player)
AND
DB_FTJHasDrudenae(1)
THEN
ProcSetMagicPocketsOwnershipFlag(_Player,"FTJ_HasDrudenae");

PROC
ProcCheckForFTJDrudenaeFlag((CHARACTERGUID)_Player)
THEN
NOT DB_FTJHasDrudenae(1);

IF
ObjectFlagSet("FTJ_GiveStingTailDrudenae",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"FTJ_HasDrudenae",1)
AND
DB_DrudenaeTemplates(_Drudenae)
AND
NOT DB_GaveStingTailDrudenae(1)
THEN
DB_FTJCheckStingTailTemplate(_Drudenae);
ProcLaunchMagicPocketIterator(_Player,"checkForDrudenae","");
ProcLaunchMagicPocketIterator(_Player,"checkForDrudenae_Griff","");
SetStoryEvent(_Player,"checkForDrudenae_Griff");
FireOsirisEvents();
NOT DB_FTJCheckStingTailTemplate(_Drudenae);

IF
StoryEvent(_Item,"checkForDrudenae")
AND
_Item != ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096
AND
DB_FTJCheckStingTailTemplate(_Drudenae)
AND
GetTemplate(_Item,_Drudenae)
AND
NOT DB_GaveStingTailDrudenae(1)
THEN
ItemToInventory((ITEMGUID)_Item,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
CharacterUseItem(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,_Item,"");
DB_GaveStingTailDrudenae(1);

//Prioritize Griff's Drud to give Last
IF
StoryEvent(_Item,"checkForDrudenae_Griff")
AND
_Item == ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096
AND
NOT DB_GaveStingTailDrudenae(1)
THEN
ItemToInventory((ITEMGUID)_Item,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
CharacterUseItem(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,_Item,"");
DB_GaveStingTailDrudenae(1);

//Fallback, if it is still in the Orange, send to Stingtail
IF
StoryEvent((CHARACTERGUID)_Player,"checkForDrudenae_Griff")
AND
ItemIsInPartyInventory(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,_Player,1,1)
AND
NOT DB_GaveStingTailDrudenae(1)
THEN
ItemToInventory(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
CharacterUseItem(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,"");
DB_GaveStingTailDrudenae(1);

IF
GlobalFlagSet("FTJ_StingtailEatStolenDrud")
THEN
ItemRemove(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096);


//END_REGION

IF
GlobalFlagSet("FTJ_Origin_RedPrince_StingtailGaveInfo")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo");
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_Origin_RedPrince_HasTolemyInfo");

IF
DialogEnded("FTJ_LizardDreamer",_)
AND
DB_GlobalFlag("FTJ_Origin_RedPrince_StingtailGaveInfo")
AND
QueryOnlyOnce("FTJ_VB_OM_RedPrince-StingTail")
THEN
StartVoiceBark("FTJ_VB_OM_RedPrince-StingTail",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

IF
DialogEnded("FTJ_LizardDreamer_COM_RedPrince",_)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_VB_OM_RedPrince-StingTail",1)
AND
QueryOnlyOnce("FTJ_VB_OM_RedPrince-StingTail")
THEN
StartVoiceBark("FTJ_VB_OM_RedPrince-StingTail",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
GlobalSetFlag("GLO_RedPrince_TalkedToStingtail");

//REGION Assassin
IF
CharacterLeftTrigger(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440, S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e)
THEN
TeleportTo(S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e, CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);

IF
DB_Event_CharacterAppearedInSpotTrigger(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"RED PRINCE",1)
THEN
DialogRequestStop(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);

IF
DB_Event_CharacterAppearedInSpotTrigger(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"RED PRINCE",1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440)
THEN
CharacterSetCanTrade(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440, 0);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin",0,"FTJ_RedPrinceAssassin",1,10.0,0,0);

//Fail fallback (Tried to start dialog but it failed
IF
CharacterMoveToAndTalkRequestDialogFailedEvent(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_,"FTJ_RedPrinceAssassin")
THEN
DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1);

//In the event that his dialogue fails, the Assassin waits for the Red Prince and himself to be free, then approaches the Red Prince if he's near enough and
//not polymorphed.
IF
DialogEnded(_,_Inst)
AND
DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1)
AND
DB_DialogPlayers(_Inst,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "RED PRINCE", 1)
AND
GetDistanceTo(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440, _Dist)
AND
_Dist <= 10.0
THEN
DialogRequestStop(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin",0,"FTJ_RedPrinceAssassin",1,10.0,0,0);

IF
DialogEnded(_,_Inst)
AND
DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1)
AND
DB_DialogPlayers(_Inst,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
NOT DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1);

IF
DialogEnded(_,_Inst)
AND
DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "RED PRINCE", 1)
THEN
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin",0,"FTJ_RedPrinceAssassin",1,10.0,0,0);

IF
DialogEnded(_,_Inst)
AND
DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
THEN
NOT DB_FTJ_RPAssassinWaitsForRPToBeAvailable(1);

PROC
PROC_CRIME_CrimeTriggers_GetSilentWitnessesForCrime(_,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"Assault",_,CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440)
AND
CharacterCanSee(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440, CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, 1)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "RED PRINCE", 1)
THEN
DB_CRIME_CrimeTriggers_SilentWitnessesForCrime(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
CharacterSetCanTrade(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440, 0);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin",0,"FTJ_RedPrinceAssassin",1,10.0,0,0);

IF
ObjectTurnStarted(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_ID)
AND
QueryOnlyOnce("FTJ_RPAssassin_AD_Once")
THEN
Proc_StartDialog(1,"FTJ_AD_RedPrinceAssassin",CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);

IF
DB_OnlyOnce("FTJ_RPAssassin_AD_Once")
THEN
GlobalSetFlag("FTJ_Origin_RedPrince_AssassinRecognisedRedPrince");

IF
CharacterDying(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
DB_CombatCharacters(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_ID)
THEN
ObjectSetFlag(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,"GEN_DisappearOutOfSightWhenAvailable");
SetHasDialog(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,0);

IF
CharacterDying(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440)
AND
DB_CombatCharacters(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_ID)
AND
DB_GlobalFlag("FTJ_Origin_RedPrince_AssassinRecognisedRedPrince")
THEN
GlobalSetFlag("FTJ_RedPrince_AssassinDead");
Proc_StartDialog(1,"FTJ_AD_AfterRPAssassin",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
Proc_RelationshipDialog(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin_CRD_RedPrince",CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
Proc_FTJ_COM_RedPrince_CheckGiveAssassinKilled();

IF
CharacterDying(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440)
AND
DB_WasInCombat(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440,_ID)
AND
DB_GlobalFlag("FTJ_Origin_RedPrince_AssassinRecognisedRedPrince")
THEN
GlobalSetFlag("FTJ_RedPrince_AssassinDead");
Proc_StartDialog(1,"FTJ_AD_AfterRPAssassin",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
Proc_RelationshipDialog(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_RedPrinceAssassin_CRD_RedPrince",CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
Proc_FTJ_COM_RedPrince_CheckGiveAssassinKilled();

IF
CharacterUsedItem(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,ITEMGUID_S_FTJ_RPAssassinLetter_1e954a73-e708-4487-b66f-7cdcf0f38d24)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_AssassinKilled");

IF
CharacterUsedItem(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,ITEMGUID_S_FTJ_RPAssassinLetter_1e954a73-e708-4487-b66f-7cdcf0f38d24)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_StingtailGaveInfo",1)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_AssassinKilled",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_AssassinKilledKnown");

IF
CharacterUsedItem(_Player, ITEMGUID_S_FTJ_RPAssassinLetter_1e954a73-e708-4487-b66f-7cdcf0f38d24)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
AND
QRY_SameUser(_Player, CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_AssassinKilledShadow", 0)
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_AssassinKilled", 0)
THEN
GlobalSetFlag("FTJ_RedPrince_AssassinDead");
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_AssassinLetterRead");


PROC
Proc_FTJ_COM_RedPrince_CheckGiveAssassinKilled()
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail",0)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_AssassinKilled");

PROC
Proc_FTJ_COM_RedPrince_CheckGiveAssassinKilled()
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"AVATAR",0)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_Stingtail",1)
THEN
UserSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_COM_RedPrince_AssassinKilledShadow");

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build,3, 6, 0, 1)
THEN
TriggerRegisterForCharacter(S_FTJ_RPAssassin_Area_1f725eb1-3696-481c-8baa-df083aab634e, CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
//END_REGION

//REGION Bahara dream sequence
IF
ObjectFlagSet("FTJ_SW_CheckpointSourcerer_RedPrince_StartBrahmos",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Id)
THEN
// Get Brahmos helper in position
TeleportTo(ITEMGUID_S_FTJ_SW_Brahmos_Invisible_Helper_e69ae7c8-2fc0-4f56-b0d4-ffd7565c1d7c,CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);
DB_FTJ_SW_RedPrinceOrigin_StartBrahmos(_Id);

IF
DialogEnded("FTJ_SW_CheckpointSourcerer",_Id)
AND
DB_FTJ_SW_RedPrinceOrigin_StartBrahmos(_Id)
AND
GetPosition(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _X, _Y, _Z)
THEN
NOT DB_FTJ_SW_RedPrinceOrigin_StartBrahmos(_Id);
DB_FTJ_SW_RedPrince_BrahmosDreamPosition(_X, _Y, _Z);
PROC_StopLoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DreamerStatus_01");
TeleportTo(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, TRIGGERGUID_S_FTJ_SW_RedPrince_PrinceDreamPoint_b4b44a98-80ec-4f71-bf16-16083a93af86, "", 0);
Proc_StartDialog(0,"FTJ_SW_CheckpointSourcerer_Brahmos", CHARACTERGUID_S_GLO_Brahmos_d4064352-33f9-49df-b208-09fd822d2270,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"");
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);
PlayEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeOut_01");

IF
DialogEnded(_Dialog,_Id)
AND
DB_FTJ_SW_CheckpointSourcererDialogs(_Dialog)
AND
DB_LoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _fxHandle,"FJ_RedPrinceO_DarknessFadeIn",_Region,_effect, _BoneName)
THEN
PROC_StopLoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn");
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"");

IF
ObjectFlagSet("FTJ_SW_CheckpointSourcerer_RedPrince_Wakeup",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp();
PROC_StopLoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn");
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"");

IF
ObjectFlagSet("FTJ_SW_CheckpointSourcerer_RedPrince_BaharaDead",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
CharacterDie(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,1,"DoT");

IF
ObjectFlagSet("FTJ_SW_CheckpointSourcerer_RedPrince_BaharaStartDreamForced",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara("FTJ_SW_RedPrinceOrigin_MovedToBaharaAndFall");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeIn_Looping_01",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn","FJ_FortJoy_Main","");

IF
ObjectFlagSet("FTJ_SW_CheckpointSourcerer_RedPrince_BaharaStartDream",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_)
THEN
//PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara("FTJ_SW_RedPrinceOrigin_MovedToBahara");
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara("FTJ_SW_RedPrinceOrigin_MovedToBahara");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeIn_Looping_01",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn","FJ_FortJoy_Main","");

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara((STRING)_ArrivalEvent)
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1)
AND
DB_FTJ_SW_Origins_RedPrince_BaharaTriggers(_BaharaBox,_RedPrinceDest)
AND
ObjectIsInTrigger(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,_BaharaBox,1)
AND
ObjectIsInTrigger(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_BaharaBox,0)
THEN
DB_FTJ_SW_Origins_RedPrince_MovingToBahara(1);
CharacterMoveTo(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_RedPrinceDest,1,_ArrivalEvent,0);

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara((STRING)_ArrivalEvent)
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1)
AND
NOT DB_FTJ_SW_Origins_RedPrince_MovingToBahara(1)
THEN
CharacterMoveTo(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,1,_ArrivalEvent,0);

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara((STRING)_ArrivalEvent)
THEN
NOT DB_FTJ_SW_Origins_RedPrince_MovingToBahara(1);

IF
StoryEvent(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_RedPrinceOrigin_MovedToBaharaAndFall")
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1)
THEN
ProcFaceEachother(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
DB_FTJ_SW_CheckpointSourcerer_RedPrince_Forced(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
// Setting SLEEPING status will also make us get up, so we'll skip that and instead just stay in the knockdown_loop
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"knockdown_loop");
DB_FTJ_SW_RedPrinceOrigin_DreamFrozen((CHARACTERGUID)S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
CharacterFreeze((CHARACTERGUID)S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
SetStoryEvent(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_RedPrinceOrigin_MovedToBahara");

IF
StoryEvent(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_RedPrinceOrigin_MovedToBahara")
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamFrozen((CHARACTERGUID)S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
THEN
ProcFaceEachother(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

// Once Red Prince arrives at Bahara, also let Bahara fall asleep
IF
StoryEvent(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_RedPrinceOrigin_MovedToBahara")
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad,"FTJ_SW_RedPrinceOrigin_MovedToBahara");

IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_SW_RedPrinceOrigin_MovedToBahara")
AND
DB_Avatars(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamFrozen(_Char)
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1)
THEN
DB_FTJ_SW_RedPrinceOrigin_DreamFrozen(_Char);
CharacterFreeze(_Char);

IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_SW_RedPrinceOrigin_MovedToBahara")
//AND
//DB_Avatars(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
//AND
//NOT DB_FTJ_SW_CheckpointSourcerer_RedPrince_Forced(_Char)
AND
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1)
THEN
ApplyStatus(_Char,"SLEEPING",-1.0,1);
DB_FTJ_SW_RedPrinceOrigin_DreamSleeping(_Char);
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DreamerStatus_01",_Char,"FJ_RedPrinceO_DreamerStatus_01","FJ_FortJoy_Main","Dummy_BodyFX");

IF
DialogStarted("FTJ_SW_CheckpointSourcerer_Brahmos",_)
THEN
RemoveStatus(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"SLEEPING");
GlobalSetFlag("GLO_RedPrince_BaharaFinished");

IF
DialogEnded("FTJ_SW_CheckpointSourcerer_Brahmos",_Id)
THEN
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp();

// Also clean up if starting the second part failed for whatever reason
IF
DialogRequestFailed("FTJ_SW_CheckpointSourcerer_Brahmos",_)
THEN
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp();

// If you race through the dialog, it's possible to end it before we actually lay down
// -> abort any pending sleep-related actions
PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
NOT DB_FTJ_SW_RedPrince_BrahmosDreamPosition(_, _, _)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_CheckpointSourcerer_RedPrince_StartBrahmos",1) // This is for when this ran for a COM moment so the character doesn't teleport 
THEN
TeleportTo(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
DB_FTJ_SW_RedPrince_BrahmosDreamPosition(_X, _Y, _Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);
TeleportToPosition(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _X, _Y, _Z, "", 0);
CharacterLookAt(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad);
NOT DB_FTJ_SW_RedPrince_BrahmosDreamPosition(_X, _Y, _Z);


PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_CheckpointSourcerer_RedPrince_StartBrahmos",1) 
THEN
PlayEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeOut_01");


PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
THEN
DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1);

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
DB_FTJ_SW_RedPrinceOrigin_DreamSleeping(_Char)
THEN
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleeping(_Char);
PROC_StopLoopEffect(_Char,"FJ_RedPrinceO_DreamerStatus_01");
RemoveStatus(_Char,"SLEEPING");
//ApplyStatus(_Char,"SLEEPING",1.0,1);
RemoveStatus(_Char,"LYING");

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
DB_FTJ_SW_RedPrinceOrigin_DreamFrozen(_Char)
THEN
NOT DB_FTJ_SW_RedPrinceOrigin_DreamFrozen(_Char);
CharacterUnfreeze(_Char);

PROC
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp()
AND
DB_FTJ_SW_CheckpointSourcerer_RedPrince_Forced(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
THEN
NOT DB_FTJ_SW_CheckpointSourcerer_RedPrince_Forced(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"");
PlayAnimation(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"knockdown_getup");

//REGION Debug
IF
TextEventSet("baharasleep")
THEN
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1);
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara("FTJ_SW_RedPrinceOrigin_MovedToBahara");

IF
TextEventSet("baharaforcesleep")
THEN
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1);
PROC_FTJ_SW_RedPrinceOrigin_DreamGoToBahara("FTJ_SW_RedPrinceOrigin_MovedToBaharaAndFall");

IF
TextEventSet("baharawakeup")
THEN
PROC_FTJ_SW_RedPrinceOrigin_DreamCleanUp();
NOT DB_FTJ_SW_RedPrinceOrigin_DreamSleapingAbort(1);

//END_REGION

//END_REGION

//If the Red Prince gets sent to the Shelter, we assume he talks to Bahara off-stage.
PROC
PROC_GLO_PartyMembers_MakeNPC(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_InShelter", 1)
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad)
THEN
GlobalSetFlag("GLO_RedPrince_BaharaFinished");

//If the Red Prince gets sent to the Shelter, we assume he talks to Bahara off-stage.
PROC
PROC_GLO_PartyMembers_MakeNPC(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FTJ_SW_InShelter", 1)
AND
DB_Dead(CHARACTERGUID_S_FTJ_SW_CheckpointSourcerer_02f6e4f7-587c-41d0-9ac6-89104f9d16ad)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "FTJ_RedPrinceOrigin_BaharaDead", 0);

IF
GlobalFlagSet("FTJ_SW_Brahmos_AppearRedPrincess")
THEN
SetOnStage(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, 1);
PlayEffect(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690,"RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_PrincessSpawn_01");
/*
IF
GlobalFlagSet("FTJ_SW_Brahmos_AppearRedPrincess")
AND
GetPosition(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, _X, _Y, _Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_RedPrincess_Teleport_01",_X,_Y,_Z);
*/
IF
CharacterWentOnStage(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, 1)
THEN
CharacterLookAt(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
TimerLaunch("FTJ_SW_DreamPrincessKissyHand", 1200);

IF
TimerFinished("FTJ_SW_DreamPrincessKissyHand")
THEN
PlayAnimation(CHARACTERGUID_S_FTJ_SW_DreamRedPrincess_a54d0f54-e710-49e5-89cb-53ff9613e690, "Kiss_01");

//REGION Red Prince sleeps while talking to Stingtail
IF
ObjectFlagSet("FTJ_RedPrince_Sleep", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _ID)
THEN
ApplyStatus(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "SLEEPING", -1.0, 1);
ApplyStatus(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4, "SLEEPING", -1.0, 1);
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeIn_Looping_01",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn_StingTail","FJ_FortJoy_Main","");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DreamerStatus_01",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn_Status1","FJ_FortJoy_Main","Dummy_BodyFX");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DreamerStatus_01",CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,"FJ_RedPrinceO_DarknessFadeIn_Status2","FJ_FortJoy_Main","Dummy_BodyFX");
DB_FTJ_RedPrinceSleepingDialogue(_ID);

IF
ObjectFlagCleared("FTJ_RedPrince_Sleep", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
AND
DB_FTJ_RedPrinceSleepingDialogue(_ID)
THEN
NOT DB_FTJ_RedPrinceSleepingDialogue(_ID);

IF
ObjectFlagCleared("FTJ_RedPrince_Sleep", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
RemoveStatus(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "SLEEPING");
RemoveStatus(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4, "SLEEPING");
PROC_StopLoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn_StingTail");
PROC_StopLoopEffect(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"FJ_RedPrinceO_DarknessFadeIn_Status1");
PROC_StopLoopEffect(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,"FJ_RedPrinceO_DarknessFadeIn_Status2");

IF
DialogEnded(_, _ID)
AND
DB_FTJ_RedPrinceSleepingDialogue(_ID)
THEN
NOT DB_FTJ_RedPrinceSleepingDialogue(_ID);
ObjectClearFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "FTJ_RedPrince_Sleep", 0);
//END_REGION

IF
RegionStarted("RC_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
