Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,"FTJ_BlackCat");


//ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_BlackCatFollowVB_Poly_29c87ed8-d80e-4614-8f08-32dcf4a0934f);

SetOnStage(S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,0);
ProcTriggerRegisterForPlayers(S_FTJ_BlackCatStartEvent_Poly_35fc2591-68a3-4a5d-8bfb-2205446d5f66);


ProcCharacterDisableAllCrimes(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830);
ProcCharacterEnableCrime(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,"Assault");

//http://fileserver-dmz/mediawiki/index.php/The_Black_Cat

KBSECTION
IF
CharacterEnteredTrigger(_Player,S_FTJ_BlackCatStartEvent_Poly_35fc2591-68a3-4a5d-8bfb-2205446d5f66)
AND
QueryOnlyOnce("FTJ_BlackCat_Start")
THEN
ObjectSetFlag(_Player,"FTJ_StartBlackCatEvent");

IF
GlobalFlagSet("FTJ_BlackCatLeave")
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,0)
THEN
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,1,1,"",0);
SetHasDialog(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,0);

IF
CharacterKilledBy(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_AttackerOwner,_Attacker)
AND
DB_IsPlayer(_AttackerOwner)
AND
CharacterCanSee(_Attacker,CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,1)
AND
QueryOnlyOnce("FTJ_VB_BlackCatDead")
THEN
SetTag(_AttackerOwner,"KilledBlackCat");
StartVoiceBark("FTJ_VB_BlackCatDead_KilledByPlayer",_Attacker);

IF
CharacterKilledBy(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_AttackerOwner,_Attacker)
AND
IsTagged(_AttackerOwner,"MAGISTER",1)
AND
GetVarObject(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,"TargetPlayer",(CHARACTERGUID)_Player)
AND
CharacterCanSee(_Player,_Attacker,1)
AND
QueryOnlyOnce("FTJ_VB_BlackCatDead")
THEN
SetTag(_AttackerOwner,"KilledBlackCat");
StartVoiceBark("FTJ_VB_BlackCatDead_KilledByMagister",_Player);


IF
CharacterDied(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830)
AND
DB_IsPlayer(_Char)
AND
ObjectGetFlag(_Char,"FTJ_StartBlackCatEvent",1)
AND
CharacterCanSee(_Char,CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,1)
AND
QueryOnlyOnce("FTJ_VB_BlackCatDead")
THEN
StartVoiceBark("FTJ_VB_BlackCatDead",_Char);


IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_StartBlackCatThanksDialog")
THEN
Proc_StartDialog(0,"FTJ_BlackCat_ThanksPlayer",CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_Player);
PartySetFlag(_Player,"QuestUpdate_FTJ_Escape_BlackCat_Saved");

IF
DialogEnded("FTJ_BlackCat_ThanksPlayer",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
THEN
CharacterAddSkill(_Player,"Summon_Cat");
GlobalSetFlag("FTJ_BlackCatLeave");


//Teleport Hack

PROC
Proc_FTJ_BlackCatTeleportCheck((CHARACTERGUID)_Char,(ITEMGUID)_Portal)
AND
GetVarObject(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,"TargetPlayer",_Target)
AND
_Target == _Char
AND
IsSpeakerReserved(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,0)
AND
GetDistanceTo(_Portal,CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_Dist)
AND
_Dist < 16.0
THEN
TeleportTo(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_Char);




PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;


// Patch fix for black cat stuck offline but force updating (didn't find the cause, must be Behavior interrupted by something)
IF
GlobalFlagSet("FTJ_BlackCatLeave")
THEN
CharacterSetForceUpdate(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,0);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
