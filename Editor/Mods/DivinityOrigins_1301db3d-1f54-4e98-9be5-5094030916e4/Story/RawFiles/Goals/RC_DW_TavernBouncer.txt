Version 1
SubGoalCombiner SGC_AND
INITSECTION
// http://fileserver-dmz/mediawiki/index.php/Tavern_Bouncer
ProcTriggerRegisterForPlayers(RC_DW_Tavern_BouncerTrig_cdaf7fe6-3094-4e1e-bcd9-893350feaec2);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_Undertavern_41caf09c-8ddd-461f-a892-a085009b648b);

DB_Dialogs(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"RC_DW_TavernBouncer");
DB_NoLowAttitudeDialog(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);

SetOnStage(RC_DW_ToUndertavernStairs_404ed36a-1b24-48de-963b-2ac07950ad1f,0);
KBSECTION
//REGION TEMP gold check
IF
DialogStarted("RC_DW_TavernBouncer",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
ProcEvaluateMagicPocketGold((CHARACTERGUID)_Player,">=",50,"RC_DW_TavernBouncer_PartyHas50Gold");

IF
ObjectFlagSet("RC_DW_TavernBouncer_GiveGold",(CHARACTERGUID)_Char,_)
THEN
ProcAddGoldToMagicPockets(_Char,-50);
CharacterAddGold(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,50);
//END_REGION
IF
CharacterEnteredTrigger(_Char,TRIGGERGUID_S_RC_DW_Undertavern_41caf09c-8ddd-461f-a892-a085009b648b)
THEN
UserSetFlag(_Char,"RC_DW_TavernBouncer_Cleared",0);

IF
StoryEvent((CHARACTERGUID)_Char,"RC_DW_TavernBouncer_CharSpotted")
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
UserGetFlag(_Char,"RC_DW_TavernBouncer_Questioned",0)
THEN
Proc_StartDialog(0,"RC_DW_TavernBouncer",RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char);
ObjectSetFlag(_Char,"RC_DW_TavernBouncer_Questioned",0);

IF
CharacterUsedItem(_Char,ITEMGUID_S_RC_DW_ToUndertavernStairs_OnStage_8464a78a-67a7-4298-ab61-a3d6be429839)
THEN
Proc_RC_DW_ToUndertavernStairs(_Char);


PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
NOT DB_IsPlayer(_Char)
THEN
TeleportTo(_Char,RC_DW_Tavern_Hideout_Ent_3c484eae-b27c-42a9-9407-09dcdf52ae4b);

PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
CharacterCanSee(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,0)
THEN
TeleportTo(_Char,RC_DW_Tavern_Hideout_Ent_3c484eae-b27c-42a9-9407-09dcdf52ae4b);

PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
THEN
TeleportTo(_Char,RC_DW_Tavern_Hideout_Ent_3c484eae-b27c-42a9-9407-09dcdf52ae4b);


/*
PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
PartyGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
DB_IsPlayer(_Player)
AND
CharactersAreGrouped(_Char,_Player,1)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
TeleportTo(_Player,RC_DW_Tavern_Hideout_Ent_3c484eae-b27c-42a9-9407-09dcdf52ae4b);
*/

IF
ObjectFlagSet("RC_DW_TavernBouncer_Cleared",_,_)
AND
GlobalGetFlag("RC_DW_TavernBouncer_ClearSpotter",0)
THEN
GlobalSetFlag("RC_DW_TavernBouncer_ClearSpotter");

IF
DialogEnded("RC_DW_TavernBouncer",_)
AND
GlobalGetFlag("RC_DW_TavernBouncer_ClearSpotter",0)
THEN
GlobalClearFlag("RC_DW_TavernBouncer_ResetSpotter");
GlobalSetFlag("RC_DW_TavernBouncer_ResetSpotter");


PROC //User already got a warning
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
UserGetFlag(_Char,"RC_DW_TavernBouncer_FirstWarning",1)
AND
CharacterCanSee(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,1)
AND
CharacterIsInCombat(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,0)
THEN
ProcForceStopDialog(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);
ProcMakeNPCHostile(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char);
DB_TavernBouncer_HostileTo(_Char);

PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
CharacterCanSee(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,1)
AND
CharacterIsInCombat(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,1)
THEN
GlobalSetFlag("RC_DW_TavernBouncer_InCombatWarning");
Proc_StartDialog(1,"RC_DW_AD_TavernBouncer",CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);

PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_Cleared",1)
AND
NOT UserGetFlag(_Char,"RC_DW_TavernBouncer_FirstWarning",1)
AND
CharacterCanSee(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,1)
AND
CharacterIsInCombat(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,0)
THEN
Proc_RC_DW_TavernBouncer_SetWarning(_Char);
ObjectSetFlag(_Char,"RC_DW_TavernBouncer_FirstWarning",0);
ObjectSetFlag(_Char,"RC_DW_TavernBouncer_WarningDialog",0);
ProcForceStopDialog(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);
Proc_StartDialog(0,"RC_DW_TavernBouncer",RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char);

PROC
Proc_RC_DW_TavernBouncer_SetWarning((CHARACTERGUID)_)
AND
DB_InRegion(_Char,TRIGGERGUID_S_RC_DW_Tavern_BouncerTrig_cdaf7fe6-3094-4e1e-bcd9-893350feaec2)
AND
ObjectGetFlag(_Char,"RC_DW_TavernBouncer_FirstWarning",0)
THEN
ObjectSetFlag(_Char,"RC_DW_TavernBouncer_FirstWarning",0);


PROC
Proc_RC_DW_ToUndertavernStairs((CHARACTERGUID)_Char)
AND
CharacterCanSee(RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,0)
THEN
TeleportTo(_Char,RC_DW_Tavern_Hideout_Ent_3c484eae-b27c-42a9-9407-09dcdf52ae4b);

//REGION
IF
ObjectFlagSet("RC_DW_TavernBouncer_HostileTo",(CHARACTERGUID)_Char,_)
THEN
DB_TavernBouncer_HostileTo(_Char);

IF
ObjectFlagSet("RC_DW_TavernBouncer_HostileTo",(CHARACTERGUID)_Char,_)
AND
DB_IsPlayer(_OtherChar)
AND
CharacterIsInPartyWith(_OtherChar,_Char,1)
AND
NOT DB_TavernBouncer_HostileTo(_OtherChar)
THEN
DB_TavernBouncer_HostileTo(_OtherChar);

IF
ObjectTurnEnded((CHARACTERGUID)_Char)
AND
NOT DB_RC_DW_TavernBouncer_GiveUp(1)
AND
DB_TavernBouncer_HostileTo(_Char)
AND
CharacterGetMagicArmorPercentage(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,0.0)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"STUNNED",0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"FROZEN",0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"PETRIFIED",0)
THEN
Proc_RC_DW_TavernBouncer_GiveUp(_Char);
DB_RC_DW_TavernBouncer_GiveUp(1);

IF
ObjectTurnEnded((CHARACTERGUID)_Char)
AND
NOT DB_RC_DW_TavernBouncer_GiveUp(1)
AND
DB_TavernBouncer_HostileTo(_Char)
AND
CharacterGetArmorPercentage(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_ArmorPercentage)
AND
_ArmorPercentage <= 0.0
//CharacterGetHitpointsPercentage(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_CurHealth)
//AND
//_CurHealth <= 85
AND
CharacterIsDead(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"STUNNED",0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"FROZEN",0)
AND
HasActiveStatus(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,"PETRIFIED",0)
THEN
Proc_RC_DW_TavernBouncer_GiveUp(_Char);
DB_RC_DW_TavernBouncer_GiveUp(1);

PROC 
Proc_RC_DW_TavernBouncer_GiveUp((CHARACTERGUID)_Char)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Id)
AND
CombatGetIDForCharacter(_Char,_Id)
THEN
JumpToTurn(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);
NOT DB_TavernBouncer_HostileTo(_Char);
ChangeAttitude(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_Char,0);
EndCombat(_Id);
//LeaveCombat(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);
GlobalSetFlag("RC_DW_TavernBouncer_LostFight");
UserSetFlag(_Char,"RC_DW_TavernBouncer_Cleared");
Proc_StartDialog(1,"RC_DW_AD_TavernBouncer",CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b);

IF
ObjectLeftCombat(CHARACTERGUID_S_RC_DW_TavernBouncer_375ff3ff-13c3-4498-b4b8-2c183df7751b,_)
AND
DB_TavernBouncer_HostileTo(_Char)
THEN
NOT DB_TavernBouncer_HostileTo(_Char);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
