Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_RC_GY_TerracottaArmy(1,(CHARACTERGUID)CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Melee_01_84782e40-4f83-4707-80e3-e890a49182af,(ITEMGUID)ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_01_e87b5320-5e83-4dda-9438-b26ec52fee2f);
DB_RC_GY_TerracottaArmy(1,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Melee_02_40548524-2067-4604-808c-a3cb4436bf99,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_02_4b4e5b92-efc0-4a9b-a44e-2d07a151f2a3);
DB_RC_GY_TerracottaArmy(1,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Melee_03_276921b9-5a17-4255-8e10-0525737493c3,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_03_1a9f62ee-30ba-41f5-870d-16e4c6e8fbee);
DB_RC_GY_TerracottaArmy(1,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Melee_04_99607d38-0445-4442-a919-3077578b27f3,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_04_ef59cb5b-96b1-4161-b488-7db80c0f631d);
DB_RC_GY_TerracottaArmy(1,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Ranged_01_b602e50f-d4c7-48fc-b086-a70d31a1266b,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_05_f03b47e0-eb46-4633-88b6-02ad9348c9ac);
DB_RC_GY_TerracottaArmy(1,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_Ranged_02_3ec5ef99-1383-4fac-a1e3-96f26953cc3a,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W1_06_b4442bc0-f7f3-42c5-b55e-fcf97d5d115c);

DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Melee_01_23f1101e-76b7-44ae-8e9e-646889c20a72,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_01_cd2ce866-c70d-4430-b842-48a9b1014602);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Melee_02_f79ee5a2-8b76-4774-ad04-f9a895325074,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_02_e7c92c03-c6d5-4a2d-ae5c-a9e52977150d);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Melee_03_1ebcc164-4479-4558-a9df-ef130b54b089,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_03_d6245021-e53e-4fd3-b01f-bbfb5537fde5);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Melee_04_3cc448db-13a3-4a97-96f8-25e9318b4de4,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_04_a15ef82d-a028-43a3-9dbe-b05f901f9dd3);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Ranged_01_199eda77-0ec0-420f-bc43-27b53ab2eb2f,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_05_aea983e4-750e-4781-8042-aa097e4cac9f);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Ranged_02_1bc4e3c7-a2aa-4f82-9e27-45586548819f,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_06_58da7abf-00df-4644-950a-375baa37a88c);
DB_RC_GY_TerracottaArmy(2,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Special_01_1ec42474-63ac-4107-86d7-07fba7d3b8e8,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W2_Special_77a120cd-d37a-4679-8b12-9f66c09efb43);

DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Melee_01_a61aff31-5de5-4f94-93a2-063bcf764f15,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_01_64e776ff-ead8-4ae1-b8cc-0d63d10b37a8);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Melee_02_a6757c10-d163-4816-a98c-60519874d4a9,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_02_86946448-e659-4509-905e-dcee3ee8e9cc);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Melee_03_d8d9de92-bba6-432c-b097-b94cf6bfe575,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_03_a307e8a6-10c8-4c44-80b9-122a82e12713);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Melee_04_a6223497-ddfe-4858-a78b-7f17d1824e0b,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_04_a25b7183-e8a9-4e45-b03e-a9327c37b623);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Ranged_01_a6965245-1edb-4dd5-865a-9a65b006bea3,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_05_c0ac7c13-3961-4fba-94d1-f500c63b7d78);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Ranged_02_b3425c1c-41f1-4e5f-818a-5dc0fb58f24e,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_06_d94a481b-47eb-4510-8c0c-c1bd0b126504);
DB_RC_GY_TerracottaArmy(3,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Special_01_4a1278e8-a7ce-418c-9797-d964b36658a9,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W3_Special_b126fa61-821c-4b39-b9ad-4f8f111e9bb0);

DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Melee_01_0269ecd6-4d32-489b-9e7f-854c0d82aa20,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_01_27921dee-e4b7-4916-b387-36bbc31fad89);
DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Melee_02_b77cabb0-2c8a-4cd7-adc5-de3e8a1021ce,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_02_e6acd792-77b9-4e92-bdf4-9f629e735aea);
DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Melee_03_2842ce7b-3fc0-4ab5-8131-2c2a22278813,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_03_e57e38d3-5798-4e7a-adf7-37cbb7f7d5d4);
DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Melee_04_9b20b5b8-ddf3-42aa-b679-5f8aa7c989a2,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_04_1668c3b2-6869-4054-af51-3059ac3af884);
DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Ranged_01_efd0d875-118b-4b6e-b97b-c55be6300f61,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_05_8a7aa0cf-13eb-4bad-aacd-a777638037aa);
DB_RC_GY_TerracottaArmy(4,CHARACTERGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_Ranged_02_bebe490d-c1e8-44c3-9280-1157656f00d0,ITEMGUID_S_RC_GY_VengefulSpirits_ClayArmy_W4_06_be16255e-a88d-44f2-ac2a-d646f0809ef6);
KBSECTION
IF
DB_RC_GY_TerracottaArmy(_,_Enemy,_)
THEN
SetOnStage(_Enemy,0);

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_GY_GodslayerShard_Tomb_d910b8ca-c508-44d1-81f8-16eaab211858)
AND
NOT DB_RC_GY_ChestLooter(_)
AND
NOT QRY_IsEmptyDB("DB_RC_GY_TerracottaArmy",3)
THEN
UserSetFlag(_Player,"RC_GY_Chestlooter");
DB_RC_GY_ChestLooter(_Player);

IF
DB_RC_GY_ChestLooter(_Player)
THEN
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_VengefulSpirits_CombatStart_c0b1cad6-6761-4a16-98f3-7418304b0c21);

PROC
Proc_RC_GY_TerracottaArmy_Spawn((CHARACTERGUID)_Enemy,(ITEMGUID)_Dummy)
THEN
SetOnStage(_Dummy,0);
SetOnStage(_Enemy,1);

IF
CharacterWentOnStage(_Enemy,1)
AND
DB_RC_GY_TerracottaArmy(_,_Enemy,_)
THEN
PlayEffect(_Enemy,"RS3_FX_GP_ScriptedEvent_Terracotta_Awaken_01");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_GY_VengefulSpirits_CombatStart_c0b1cad6-6761-4a16-98f3-7418304b0c21)
AND
UserGetFlag(_Player,"RC_GY_Chestlooter",1)
AND
QueryOnlyOnce("RC_GY_TerracottaArmy_SpawnEvent")
THEN
SetStoryEvent(_Player,"RC_GY_TerracottaArmy_CombatStart");

IF
CharacterUsedItem(_Player,TOOL_Ladder_4-ITEMGUID_TOOL_Ladder_4-5H_A_015_6b0824d6-7e3e-4fbd-b2c2-aba418c1fa8d)
AND
UserGetFlag(_Player,"RC_GY_Chestlooter",1)
AND
QueryOnlyOnce("RC_GY_TerracottaArmy_SpawnEvent")
THEN
SetStoryEvent(_Player,"RC_GY_TerracottaArmy_CombatStart");

IF
AttackedByObject((ITEMGUID)_Dummy,_Player,_Attacker,_,_)
AND
_Dummy != _Attacker
AND
DB_RC_GY_TerracottaArmy(_,_,_Dummy)
AND
DB_RC_GY_TerracottaArmy(1,_FirstWaveEnemy,_)
AND
CharacterIsInCombat(_FirstWaveEnemy,0)
AND
CharacterIsDead(_FirstWaveEnemy,0)
AND
QueryOnlyOnce("RC_GY_TerracottaArmy_SpawnEvent")
THEN
SetStoryEvent(_Player,"RC_GY_TerracottaArmy_CombatStart");

IF
AttackedByObject((ITEMGUID)_Dummy,_Player,_Attacker,_,_)
AND
_Dummy != _Attacker
AND
DB_RC_GY_TerracottaArmy(_,_Enemy,_Dummy)
THEN
Proc_RC_GY_TerracottaArmy_Spawn((CHARACTERGUID)_Enemy,(ITEMGUID)_Dummy);

IF
StoryEvent((CHARACTERGUID)_Player,"RC_GY_TerracottaArmy_CombatStart")
AND
DB_RC_GY_TerracottaArmy(1,_Enemies,_Dummies)
THEN
Proc_RC_GY_TerracottaArmy_Spawn((CHARACTERGUID)_Enemies,(ITEMGUID)_Dummies);

IF
StoryEvent((CHARACTERGUID)_Player,"RC_GY_TerracottaArmy_CombatStart")
THEN
ProcDeclareCounter("RC_GY_TerracottaArmy_Counter_W1");
DB_RC_GY_TerracottaArmy_Counters("RC_GY_TerracottaArmy_Counter_W1",1);
StartVoiceBark("RC_GY_VengefulSpirits_VB_EnemiesEncountered",_Player);
UserClearFlag(_Player,"RC_GY_Chestlooter",0);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_GY_VengefulSpirits_CombatStart_c0b1cad6-6761-4a16-98f3-7418304b0c21);

IF
CharacterDied(_Enemy)
AND
DB_RC_GY_TerracottaArmy(_Wave,_Enemy,_)
AND
DB_RC_GY_TerracottaArmy_Counters(_Name,_Wave)
THEN
ProcIncreaseCounter(_Name);

PROC
Proc_RC_GY_TerracottaArmy_CheckCurrentWave((INTEGER)_Wave)
AND
NOT DB_RC_GY_TerracottaArmy(_Wave,_,_)
AND
DB_RC_GY_TerracottaArmy_Counters(_Name,_Wave)
THEN
Proc_RC_GY_TerracottaArmy_NextWave(_Wave);
ProcRemoveCounter(_Name);
NOT DB_RC_GY_TerracottaArmy_Counters(_Name,_Wave);

IF
ItemDestroyed(_Dummy)
AND
DB_RC_GY_TerracottaArmy(_Wave,_Enemy,_Dummy)
THEN
NOT DB_RC_GY_TerracottaArmy(_Wave,_Enemy,_Dummy);

IF
CharacterDied(_Enemy)
AND
DB_RC_GY_TerracottaArmy(_Wave,_Enemy,_Dummy)
THEN
NOT DB_RC_GY_TerracottaArmy(_Wave,_Enemy,_Dummy);
Proc_RC_GY_TerracottaArmy_CheckCurrentWave(_Wave);
Proc_RC_GY_TerracottaArmy_CombatFinished();

IF
DB_GlobalCounter(_Name,_Count)
AND
DB_RC_GY_TerracottaArmy_Counters(_Name,_Wave)
AND
_Wave < 4
AND
Random(2,_Random)
AND
IntegerSum(_Random,3,_NeededCount)
AND
_Count >= _NeededCount
THEN
Proc_RC_GY_TerracottaArmy_NextWave(_Wave);
ProcRemoveCounter(_Name);
NOT DB_RC_GY_TerracottaArmy_Counters(_Name,_Wave);

PROC
Proc_RC_GY_TerracottaArmy_NextWave((INTEGER)_Wave)
THEN
SysClear("DB_RC_GY_TerracottaArmy_WaveToSummon",1);

PROC
Proc_RC_GY_TerracottaArmy_NextWave((INTEGER)_Wave)
AND
DB_RC_GY_TerracottaArmy(_NewWave,_,_)
AND
_NewWave > _Wave
AND
NOT DB_RC_GY_TerracottaArmy_WaveToSummon(_)
THEN
DB_RC_GY_TerracottaArmy_WaveToSummon((INTEGER)_NewWave);

IF
DB_RC_GY_TerracottaArmy_WaveToSummon((INTEGER)_Wave)
AND
DB_RC_GY_TerracottaArmy(_Wave,_Enemies,_Dummies)
THEN
Proc_RC_GY_TerracottaArmy_Spawn((CHARACTERGUID)_Enemies,(ITEMGUID)_Dummies);

IF
DB_RC_GY_TerracottaArmy_WaveToSummon((INTEGER)_Wave)
AND
IntegertoString(_Wave,_StrWave)
AND
StringConcatenate("RC_GY_TerracottaArmy_Counter_W",_StrWave,_NewCounter)
THEN
ProcDeclareCounter(_NewCounter);
DB_RC_GY_TerracottaArmy_Counters(_NewCounter,_Wave);

PROC
Proc_RC_GY_TerracottaArmy_CombatFinished()
AND
NOT DB_RC_GY_TerracottaArmy(_,_,_)
AND
DB_RC_GY_ChestLooter(_Player)
THEN
NOT DB_RC_GY_ChestLooter(_Player);
StartVoiceBark("RC_GY_VengefulSpirits_VB_EnemiesDefeated",_Player);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
