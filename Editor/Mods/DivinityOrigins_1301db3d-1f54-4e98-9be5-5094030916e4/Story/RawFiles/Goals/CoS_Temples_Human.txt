Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_002_a2899920-3459-46d4-97cb-7a59a78d7e37);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_004_81ac50cd-2966-43f3-946a-f15391ec9eef);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_005_29c6711c-adce-4e8f-b402-8b6239a7c7e3);
DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);

DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313,"CoS_Temples_Human_Magister_001");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313,CHARACTERGUID_S_CoS_Temples_Human_Magister_001_Ghost_1728dda5-14cd-4274-a4b5-28fa3cfcafa7,"CoS_Temples_Human_Magister_001_Ghost");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559,"CoS_Temples_Human_Magister_002");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559,CHARACTERGUID_S_CoS_Temples_Human_Magister_002_Ghost_eea15ac8-13da-49a2-9cdf-618e4617acd9,"CoS_Temples_Human_Magister_002_Ghost");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca,"CoS_Temples_Human_Magister_003");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca,CHARACTERGUID_S_CoS_Temples_Human_Magister_003_Ghost_64e34160-fc14-4d49-b7b9-d17f668d5016,"CoS_Temples_Human_Magister_003_Ghost");


DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,"CoS_Temples_Human_BlackRing_Captain");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db,"CoS_Temples_Human_BlackRing_001");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_002_29c6711c-adce-4e8f-b402-8b6239a7c7e3,"CoS_Temples_Human_BlackRing_002");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"CoS_Temples_Human_BlackRing_003");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,
					CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_Ghost_88bca5bd-39fd-460c-9992-685261a5e5f9,"CoS_Temples_Human_BlackRing_003_Ghost");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_004_81ac50cd-2966-43f3-946a-f15391ec9eef,"CoS_Temples_Human_BlackRing_004");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,"CoS_Temples_Human_BlackRingWarg_001");

DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Human_KnightOfRhalic_Ghost_2cdfd77c-3b09-4410-aa55-fb435cbea6e5,"CoS_Temples_Human_KnightOfRhalic_Ghost");
CharacterLinkGhost(CHARACTERGUID_S_CoS_Temples_Human_KnightOfRhalic_9d2dd4cb-2502-44eb-8d18-63039ccdce8d,CHARACTERGUID_S_CoS_Temples_Human_KnightOfRhalic_Ghost_2cdfd77c-3b09-4410-aa55-fb435cbea6e5);


DB_CoS_Temples_Human_Magisters((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313);
DB_CoS_Temples_Human_Magisters(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559);
DB_CoS_Temples_Human_Magisters(CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca);




SetOnStage(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,0);
SetCanJoinCombat(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,0);
SetCanFight(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,0);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_CoS_Temples_Human_CaptainAppear_Poly_755b8a7b-4078-4f7d-ac24-f8db09742431);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_CoS_Temples_Human_CombatStart_Box_2601aefe-efa6-42f8-ac8a-32f1e7079e18);

//BR DB_
DB_CoS_Temples_Human_BlackRing((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db);
DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_002_a2899920-3459-46d4-97cb-7a59a78d7e37);
DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_004_81ac50cd-2966-43f3-946a-f15391ec9eef);
DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_005_29c6711c-adce-4e8f-b402-8b6239a7c7e3);
DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);


SetOnStage(ITEMGUID_S_CoS_Temples_Human_SwordInWarg_1bccfe9c-023d-493e-ae16-7e5b5d111915,0);

Proc_CoS_Temples_Human_Init();
KBSECTION
PROC
Proc_CoS_Temples_Human_Init()
AND
DB_CoS_Temples_Human_Combatants(_Combatant)
THEN
ProcSetInvulnerable(_Combatant,1);
SetVarFixedString(_Combatant,"AiHint","AiHint_Unique");
SetVarInteger(_Combatant,"StayInAiHints",1);


IF
DB_CoS_Temples_Human_Magisters((CHARACTERGUID)_Magister)
THEN
CharacterDisableCrime(_Magister,"SourceMagic");
//CharacterDisableCrime(_Magister,"ActiveUndead");


//Start Captain Event
IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_CoS_Temples_Human_CaptainAppear_Poly_755b8a7b-4078-4f7d-ac24-f8db09742431)
AND
QueryOnlyOnce("CoS_Temples_Human_BRCaptainAppear_Once")
AND
GetPosition(_Player,_X,_Y,_Z)
AND
RealSum(_Y,1.0,_NewY)
AND
RealSum(_Z,3.0,_NewZ)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Smoke_01",_X,_NewY,_NewZ);
CharacterAppearAtPosition(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,_X,_Y,_NewZ,1,"");
ProcStateManagerCharacterMoveTo(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,_Player,1,6.5,"","");

IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_CoS_Temples_Human_CaptainAppear_Poly_755b8a7b-4078-4f7d-ac24-f8db09742431)
AND
ObjectGetFlag(_Player,"CoS_Temples_AllBlackRingHostileTo",1)
THEN
SetCanJoinCombat(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);
SetCanFight(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);
Proc_CoS_Temples_Human_CombatStart();

IF
DialogEnded("CoS_Temples_Human_BlackRing_Captain",_)
THEN
SetCanJoinCombat(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);
SetCanFight(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);

IF
DialogEnded("CoS_Temples_Human_BlackRing_Captain",_)
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_CoS_Temples_Human_CombatStart_Box_2601aefe-efa6-42f8-ac8a-32f1e7079e18)
AND
DB_IsPlayer(_Player)
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",0);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_CoS_Temples_Human_CombatStart_Box_2601aefe-efa6-42f8-ac8a-32f1e7079e18);

//REGION Remove Invulnerabilities once Player joins
//Dialog end prematurely fallback
IF
DialogEnded("CoS_Temples_Human_BlackRing_Captain",_Id)
AND
DialogGetLocalFlag(_Id,"HasDonePersuade",0)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",0);
Proc_CoS_Temples_Human_CombatStart();


IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_ID)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313, _HumanID)
AND
_ID == _HumanID
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

IF
ObjectEnteredCombat((CHARACTERGUID)_Combatant,_ID)
AND
DB_CoS_Temples_Human_Combatants(_Combatant)
AND
DB_CombatCharacters(_Player, _PlayerID)
AND
DB_IsPlayer(_Player)
AND
_ID == _PlayerID
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_ID)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Combatant, _ID)
AND
DB_CoS_Temples_Human_Combatants(_Combatant)
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

IF
AttackedByObject(_Combatant,(CHARACTERGUID)_Player,_,_,_)
AND
DB_CoS_Temples_Human_Combatants(_Combatant)
AND
DB_IsPlayer(_Player)
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

//Invulnerability fallback
IF
CharacterDied(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37)
AND
NOT DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once")
THEN
Proc_CoS_Temples_Human_CombatStart();

PROC
Proc_CoS_Temples_Human_CombatStart()
THEN
DB_OnlyOnce("CoS_Temples_Human_CombatStart_Once");


PROC
Proc_CoS_Temples_Human_CombatStart()
AND
DB_CoS_Temples_Human_Combatants(_Combatant)
THEN
ProcForceStopDialog(_Combatant);
ProcSetInvulnerable(_Combatant,0);
SetVarFixedString(_Combatant,"AiHint","");
SetVarInteger(_Combatant,"StayInAiHints",0);
SetTag(_Combatant,"AI_CANUSESKILL");


PROC
Proc_CoS_Temples_Human_CombatStart()
THEN
SetVarFixedString(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,"AiHint","AI_HINT_RANGER");
SetVarFixedString(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559,"AiHint","AI_HINT_RANGER");


//Link the Captain to the rest of the combat
PROC
Proc_CoS_Temples_Human_CombatStart()
THEN
CharacterPurgeQueue(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37);
SetCanJoinCombat(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);
SetCanFight(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,1);
ProcSetInvulnerable(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,0);
EnterCombat(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db);

//END_REGION

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_Id)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player, _Id)
AND
DB_CoS_Temples_Human_Magisters((CHARACTERGUID)_Magister)
AND
DB_CombatCharacters(_Magister, _mId)
AND
_Id == _mId
AND
CharacterGetRelationToCharacter(_Player,_Magister,0)
THEN
ObjectSetFlag(_Player,"CoS_Temples_Human_WentHostileToMagisters");


IF
CharacterRelationChangedTo((CHARACTERGUID)_Player,(CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,0)
AND
DB_IsPlayer(_Player)
AND
CharacterGetRelationToCharacter(_Player,CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313,_Relation)
AND
_Relation != 0
THEN
CharacterSetRelationFactionToFaction("Hero","CoS_Magister_Human",100);
CharacterSetRelationFactionToFaction("CoS_Magister_Human","Hero",100);

//REGION Block Thanks
IF
GlobalFlagSet("CoS_AlexandarDead")
THEN
DB_OnlyOnce("CoS_Temples_Human_StartThanksDialog_Once");

//END_REGION

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_StartThanksDialog_1")
AND
PartyGetFlag(_Player,"CoS_Temples_Alexandar_HasMet",0)
AND
QueryOnlyOnce("CoS_Temples_Human_StartThanksDialog_Once")
THEN
Proc_StartDialog(0,"CoS_Temples_Human_Magister_ThanksDialog",CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313,_Player);

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_StartThanksDialog_2")
AND
PartyGetFlag(_Player,"CoS_Temples_Alexandar_HasMet",0)
AND
QueryOnlyOnce("CoS_Temples_Human_StartThanksDialog_Once")
THEN
Proc_StartDialog(0,"CoS_Temples_Human_Magister_ThanksDialog",CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559,_Player);

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_StartThanksDialog_3")
AND
PartyGetFlag(_Player,"CoS_Temples_Alexandar_HasMet",0)
AND
QueryOnlyOnce("CoS_Temples_Human_StartThanksDialog_Once")
THEN
Proc_StartDialog(0,"CoS_Temples_Human_Magister_ThanksDialog",CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca,_Player);

/////BR dialog on sight
IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_BlackRing_Captain_DialogStart")
AND
QueryOnlyOnce("CoS_Temples_Human_BlackRing_Captain_DialogStart_Once")
THEN
Proc_StartDialog(0,"CoS_Temples_Human_BlackRing_Captain",CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,_Player);

//fallback, if captain dies, camp is hostile to hero
IF
CharacterDied(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",0);

//Join with Magisters
IF
DialogEnded("CoS_Temples_Human_BlackRing_Captain",_Id)
AND
DialogGetInvolvedNPC(_Id,1,(CHARACTERGUID)_Captain)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Captain,"CoS_Temples_CaptainGoHostile",1)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",0);
CharacterSetRelationFactionToFaction("Hero","CoS_Magister_Human",100);
CharacterSetRelationFactionToFaction("CoS_Magister_Human","Hero",100);
EnterCombat(_Player,_Captain);

//Join with BR
IF
DialogEnded("CoS_Temples_Human_BlackRing_Captain",_Id)
AND
DialogGetInvolvedNPC(_Id,1,(CHARACTERGUID)_Captain)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"CoS_Temples_Human_GoHostileToMagisters",1)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",100);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",100);
CharacterSetRelationFactionToFaction("Hero","CoS_Magister_Human",0);
CharacterSetRelationFactionToFaction("CoS_Magister_Human","Hero",0);
EnterCombat(_Player,_Captain);


//Limb
IF
CharacterItemEvent((CHARACTERGUID)_Player,ITEMGUID_S_CoS_Temples_Human_Limb_001_2f66b3fd-f810-4ba1-a34c-2b0d840a833c,"GLO_AteBodyPart")
THEN
Proc_StartDialog(0,"CoS_Temples_Human_Limb_001",_Player);


//REGION CoS_Temples_Human_BlackRing_003_GaveDagger
IF
ObjectFlagSet("CoS_Temples_Human_BlackRing_003_GaveDagger",(CHARACTERGUID)_Player,_)
AND
NOT DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_,_Player)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("QUEST_CoS_WPN_BlackRing_Dagger_1H_61347274-8404-4fc2-ad6c-6d213a2b1c75",_X,_Y,_Z,_Dagger)
THEN
DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,_Player);
ItemToInventory(_Dagger,_Player);
ObjectSetFlag(_Player,"GLO_PathOfBlood_MurderedInnocent");


IF
ItemAddedToCharacter(_Dagger,(CHARACTERGUID)_Player)
AND
DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,_Player)
THEN
CharacterEquipItem(_Player,_Dagger);

IF
ItemEquipped((ITEMGUID)_Dagger,(CHARACTERGUID)_Player)
AND
DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,_Player)
THEN
DB_IgnoreAssaultFor(_Player,CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
CharacterAttack(_Player,CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);

IF
AttackedByObject(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,_Player,_,_,_)
AND
DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,(CHARACTERGUID)_Player)
THEN
CreateSurface(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"SurfaceBlood",2.0,-1.0);
PlayEffect(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"RS3_FX_GP_Combat_Hit_Blood_01_Large");
CharacterSetAnimationOverride(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"Injured_01_Loop");
NOT DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,_Player);

//Took Dagger, no kill
IF
ObjectFlagSet("CoS_Temples_Human_BlackRing_003_TakeDagger_NoKill",(CHARACTERGUID)_Player,_)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("QUEST_CoS_WPN_BlackRing_Dagger_1H_61347274-8404-4fc2-ad6c-6d213a2b1c75",_X,_Y,_Z,_Dagger)
THEN
ItemToInventory(_Dagger,_Player);
DB_CoS_Temples_Human_BlackRing_003_TookDagger_NoKill(_Dagger,_Player);

//Change Mind, do kill
IF
ObjectFlagSet("CharacterDieAfterDialog",CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,_Id)
AND
DB_CoS_Temples_Human_BlackRing_003_TookDagger_NoKill(_Dagger,_Player)
THEN
NOT DB_CoS_Temples_Human_BlackRing_003_TookDagger_NoKill(_Dagger,_Player);
DB_CoS_Temples_Human_BlackRing_003_DieOnHit(_Dagger,_Player);
ObjectSetFlag(_Player,"CoS_Temples_Human_BlackRing_003_GaveDagger");
CharacterUnequipItem(_Player,_Dagger);
CharacterEquipItem(_Player,_Dagger);


//Resurrect
IF
DialogEnded("CoS_Temples_Human_BlackRing_003_Ghost",_)
AND
ObjectGetFlag(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_Ghost_88bca5bd-39fd-460c-9992-685261a5e5f9,"CoS_Temples_Human_BlackRing_003_Resurrected",1)
AND
QueryOnlyOnce("CoS_Temples_Human_BlackRing_003_Resurrected_Once")
THEN
Proc_CoS_BlackRingResurrectedByGod(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
CharacterSetRelationFactionToFaction("CoS_BlackRing_HumanCamp","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_HumanCamp",0);
ObjectSetFlag(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"CoS_Temples_Human_BlackRing_003_Resurrected");


PROC
Proc_CoS_BlackRingResurrectedByGod((CHARACTERGUID)_BlackRing)
AND
GetPosition(_BlackRing,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Lightning_Vertical_01",_X,_Y,_Z); 
PlayEffectAtPosition("RS3_FX_Skills_Source_Resurrect_Target_Cast",_X,_Y,_Z);
NOT DB_Dead(_BlackRing);
CharacterResurrect(_BlackRing);
CharacterSetHitpointsPercentage(_BlackRing,50.0);

IF
CharacterDied(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6)
AND
ObjectGetFlag(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6,"CoS_Temples_Human_BlackRing_003_Resurrected",1)
THEN
SetOnStage(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_Ghost_88bca5bd-39fd-460c-9992-685261a5e5f9,1);
DB_Dialogs(S_CoS_Temples_Human_BlackRing_003_Ghost_88bca5bd-39fd-460c-9992-685261a5e5f9,"CoS_Temples_Human_BlackRing_003_Ghost");

//END_REGION


//Alexandar VB
IF
DialogEnded("CoS_Temples_Human_Magister_001_Ghost",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_HelpingAlexandar_Start",0)
AND
QueryOnlyOnce("CoS_Temples_VB_VisionOfAlexandar_Once")
THEN
StartVoiceBark("CoS_Temples_VB_VisionOfAlexandar",_Player);

//Magisters and Pallys helping eachother VB
IF
DialogEnded("CoS_Temples_Human_Magister_003_Ghost",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
QueryOnlyOnce("CoS_Temples_VB_MagisterPaladinAlliance_Once")
THEN
StartVoiceBark("CoS_Temples_VB_MagisterPaladinAlliance",_Player);




//REGION Warg with Sword in Him
IF
ObjectFlagSet("CoS_Temples_Human_WargRemoveSword",(CHARACTERGUID)_Player,_)
THEN
CharacterMoveTo(_Player,CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,0,"CoS_Temples_Human_WargRemoveSword",0);

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_WargRemoveSword")
THEN
CharacterLookAt(_Player,CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);
PlayAnimation(_Player,"use_activate");
TimerLaunch("CoS_Temples_Human_WargRemoveSword_Delay",500);

IF
TimerFinished("CoS_Temples_Human_WargRemoveSword_Delay")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"CoS_Temples_Human_WargRemoveSword",1)
THEN
PlayAnimation(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,"hit");
CreateSurface(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,"SurfaceBlood",0.5,-1.0);
PlayEffect(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,"RS3_FX_GP_Combat_Hit_Blood_01_Large");
SetOnStage(ITEMGUID_S_CoS_Temples_Human_SwordInWarg_1bccfe9c-023d-493e-ae16-7e5b5d111915,1);
ItemToInventory(ITEMGUID_S_CoS_Temples_Human_SwordInWarg_1bccfe9c-023d-493e-ae16-7e5b5d111915,_Player,1);

IF
ObjectFlagSet("CoS_Temples_Human_WargLickPlayer",(CHARACTERGUID)_Player,_)
THEN
CharacterPurgeQueue(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);
CharacterLookAt(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,_Player);
PlayAnimation(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f,"use_inspect");
ApplyStatus(_Player,"DISEASED",15.0,1);

//END_REGION

//REGION Drink Blood

IF
ObjectFlagSet("CoS_Temples_Human_BlackRing_004_DrinkBlood",_Player,_)
THEN
PlayAnimation(_Player,"use_drink","CoS_Temples_Human_BlackRing_004_DrinkBlood_LeechCheck");
ObjectClearFlag(_Player,"CoS_Temples_Human_BlackRing_004_DrinkBlood");

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Human_BlackRing_004_DrinkBlood_LeechCheck")
AND
CharacterHasTalent(_Player,"Leech",1)
THEN
ApplyStatus(_Player,"HEAL",1.0);


//END_REGION

//REGION Human Temple Altar - BR Checker

IF
DialogStarted("CoS_Temples_Human_Altar",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
DB_CoS_Temples_Human_BlackRing((CHARACTERGUID)_Br)
AND
CharacterIsDead(_Br,0)
AND
GetDistanceTo(_Player,_Br,_Dist)
AND
_Dist < 8.0
THEN
ObjectSetFlag(_Player,"CoS_Temples_Human_Altar_BlackRingNearby");

IF
DialogEnded("CoS_Temples_Human_Altar",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
THEN
ObjectClearFlag(_Player,"CoS_Temples_Human_Altar_BlackRingNearby");

IF
ObjectFlagSet("PlayAnimation_Kneel_02",_Player,_Id)
THEN
DB_CoS_Temples_Human_Altar_BlackRingNearby_DoAD(_Player);

IF
DialogEnded("CoS_Temples_Human_Altar",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
DB_CoS_Temples_Human_Altar_BlackRingNearby_DoAD(_Player)
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,_Player,1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37,_Player,0,"");
Proc_StartDialog(1,"CoS_Temples_AD_Human_Captain_AltarRemark",CHARACTERGUID_S_CoS_Temples_Human_BlackRing_Captain_a2899920-3459-46d4-97cb-7a59a78d7e37);

IF
DialogEnded("CoS_Temples_Human_Altar",_Id)
AND
DB_CoS_Temples_Human_Altar_BlackRingNearby_DoAD(_Player)
THEN
NOT DB_CoS_Temples_Human_Altar_BlackRingNearby_DoAD(_Player);

//END_REGION


PROC
ProcRegionEnded("CoS_Main")
THEN
GoalCompleted;


EXITSECTION
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_001_5b6cb39b-2e8a-4a8c-8447-8538f6b47313);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_002_3c5a4458-a17c-43c7-9827-4eb3fd028559);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_Magister_003_318befa0-49d4-4ada-9196-90d8bd4d89ca);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_002_a2899920-3459-46d4-97cb-7a59a78d7e37);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_004_81ac50cd-2966-43f3-946a-f15391ec9eef);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_005_29c6711c-adce-4e8f-b402-8b6239a7c7e3);
NOT DB_CoS_Temples_Human_Combatants(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);


NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_001_25888479-67b5-4380-9cd4-163a004883db);
NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_002_a2899920-3459-46d4-97cb-7a59a78d7e37);
NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_003_93f7c630-eece-420c-b519-6caa057ecff6);
NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_004_81ac50cd-2966-43f3-946a-f15391ec9eef);
NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRing_005_29c6711c-adce-4e8f-b402-8b6239a7c7e3);
NOT DB_CoS_Temples_Human_BlackRing(CHARACTERGUID_S_CoS_Temples_Human_BlackRingWarg_001_a5721459-2417-404b-a591-13491fab040f);


ENDEXITSECTION
ParentTargetEdge "CoS_Temples"
