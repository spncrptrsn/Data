Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe,"FTJ_BraccusShrine");
DB_Dialogs(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"FTJ_SW_BraccusArmoryMagister");
DB_FTJ_SW_BraccusArmoryPlaque(ITEMGUID_S_FTJ_SW_BraccusArmory_Statue1_3d860e4e-8feb-42ec-93b6-2ae4e3e0af27,"FTJ_SW_AD_BraccusArmoryPlaque1");
DB_FTJ_SW_BraccusArmoryPlaque(ITEMGUID_S_FTJ_SW_BraccusArmory_Statue2_b55af0bb-b27d-49d2-934a-022dcca4f509,"FTJ_SW_AD_BraccusArmoryPlaque2");
DB_FTJ_SW_BraccusArmoryPlaque(ITEMGUID_S_FTJ_SW_BraccusArmory_Statue3_ee5d3ea2-a4ec-47e0-93e5-e76dbf684bb8,"FTJ_SW_AD_BraccusArmoryPlaque3");
CharacterSetAnimationOverride(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"Lie_Wounded_03_Loop");
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0);
CharacterSetHitpointsPercentage(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,25.0);

ApplyStatus(ITEMGUID_S_FTJ_SW_BraccusArmory_Lever_fff7f974-2901-43b1-8d3f-054bd9b898bd,"CURSED",-1.0);
ItemToInventory(ITEMGUID_S_FTJ_ARM_BraccusHelm_Cured_92a963b6-d4e0-4dc6-a49d-8b0847bfb7f5,CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06);
SetOnStage(ITEMGUID_S_FTJ_BraccusShrine_ClickThrough_70aff6a1-7eca-4e35-9823-8ce455c2bd6e,0);
SetOnStage(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,0);
SetOnStage(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77,0);

ProcDeclareCounter("FTJ_BraccusAxeSourceVampUses");

DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_FTJ_SW_BraccusShrineVB_Box_e558aac1-3585-4af3-a9ed-f2f22e4c7ac2,"FTJ_SW_VB_BraccusVault");
DB_SneakTriggerSpotter(TRIGGERGUID_S_FTJ_SW_OneShot_ArmoryMagister_ec1cf899-5369-4e70-9a54-c5d51350f53b,CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0);


DB_SourceFountains(ITEMGUID_S_FTJ_SW_BraccusArmory_SourceFountain_26e1d60e-ba27-4bf5-906f-17ba90feb6e0,TRIGGERGUID_S_FTJ_SW_BraccusArmory_SourceFountain_Point_d361f37a-d277-4b4d-aa34-5cc00868e15c);

DB_HasStoryEvent(ITEMGUID_S_FTJ_SW_BraccusCurseRing_08732b24-8f87-4ecf-b6e6-4cead56297ae,"FTJ_SW_AsCursedRingInInventory");
KBSECTION
IF
CharacterUsedItem(_Player,_Item)
AND
DB_FTJ_SW_BraccusArmoryPlaque(_Item,_Dialog)
THEN
Proc_StartDialog(1,_Dialog,_Item);

//REGION Puzzle

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_SW_BraccusArmoryDoor_6685e055-ced3-4fd3-9da8-7799f7b2807e)
AND
ItemIsLocked(ITEMGUID_S_FTJ_SW_BraccusArmoryDoor_6685e055-ced3-4fd3-9da8-7799f7b2807e,1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_Start");

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_SW_BraccusArmory_Lever_fff7f974-2901-43b1-8d3f-054bd9b898bd)
AND
HasAppliedStatus(ITEMGUID_S_FTJ_SW_BraccusArmory_Lever_fff7f974-2901-43b1-8d3f-054bd9b898bd,"CURSED",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_Start");

IF
ObjectFlagSet("FTJ_SW_BraccusArmoryDoorOpen",(CHARACTERGUID)_Player,_)
AND
QueryOnlyOnce("FTJ_SW_BraccusArmoryDoorOpen")
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_OpenDoorArmory");
ItemUnlockAndOpen(ITEMGUID_S_FTJ_SW_BraccusArmoryDoor_6685e055-ced3-4fd3-9da8-7799f7b2807e);
PartyAddExperience(_Player,1,5,1);
Proc_ShakeCameraForTime(_Player,1000);

IF
ObjectFlagSet("FTJ_SW_BraccusArmoryDoorOpen",(CHARACTERGUID)_Player,_)
AND
QueryOnlyOnce("FTJ_SW_VB_BraccusArmoryOpened")
AND
QRY_SpeakerIsAvailable(_Player)
THEN
StartVoiceBark("FTJ_SW_VB_BraccusArmoryOpened",_Player);

IF
CharacterUsedSkillOnTarget(_Player,ITEMGUID_S_FTJ_SW_BraccusArmory_Lever_fff7f974-2901-43b1-8d3f-054bd9b898bd,"Target_Bless",_,_)
THEN
RemoveStatus(ITEMGUID_S_FTJ_SW_BraccusArmory_Lever_fff7f974-2901-43b1-8d3f-054bd9b898bd,"CURSED");

IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_SW_BraccusArmory_Curse")
AND
ObjectGetFlag(_Player,"FTJ_SW_BraccusArmory_Curse",0)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
StartVoiceBark("FTJ_SW_VB_BraccusArmoryCurse",_Player);


//END_REGION

//REGION Magister

IF
DialogStarted("FTJ_SW_BraccusArmoryMagister",_ID)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_Start");

PROC
ProcCharInTriggerSpotted(_Player,TRIGGERGUID_S_FTJ_SW_OneShot_ArmoryMagister_ec1cf899-5369-4e70-9a54-c5d51350f53b)
AND
QRY_IsAvailableTo(_Player,CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0)
THEN
Proc_StartDialog(0,"FTJ_SW_BraccusArmoryMagister",CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,_Player);

IF
DialogStarted("FTJ_SW_BraccusArmoryMagister",_)
THEN
ProcCleanUpSneakTrigger(TRIGGERGUID_S_FTJ_SW_OneShot_ArmoryMagister_ec1cf899-5369-4e70-9a54-c5d51350f53b);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_FTJ_SW_OneShot_ArmoryMagister_ec1cf899-5369-4e70-9a54-c5d51350f53b);

// Blessing the guy
/*
IF
CharacterUsedSkillOnTarget(_Player,CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"Target_Bless",_,_)
THEN
ProcForceStopDialog(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0);
Proc_StartDialog(1,"GEN_AD_Cough",CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0);
SetHasDialog(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,0);
SetVarInteger(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"StatusReApplyOnRemove",0);

IF
CharacterUsedSkillOnTarget(_Player,CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"Target_Bless",_,_)
AND
HasActiveStatus(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"DECAYING_TOUCH",1)
THEN
RemoveStatus(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"DECAYING_TOUCH");

IF
CharacterStatusRemoved(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,"BLESSED",_)
THEN
CharacterDie(CHARACTERGUID_S_FTJ_SW_BraccusArmory_Magister_4a75220a-983d-44d7-a762-f7d5a4197be0,1,"DoT");
*/
//END_REGION

//REGION Shrine 

IF
DialogStarted("FTJ_BraccusShrine",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
CharacterGetSourcePoints((CHARACTERGUID)_Player,_Int)
AND
_Int > 0
THEN
ObjectSetFlag(_Player,"FTJ_HasSourcePointForBraccusShrine");
DB_FTJ_BraccusShrinePlayerClearFlags(_Player);

IF
DialogEnded("FTJ_BraccusShrine",_)
AND
DB_FTJ_BraccusShrinePlayerClearFlags(_Player)
THEN
NOT DB_FTJ_BraccusShrinePlayerClearFlags(_Player);
ObjectClearFlag(_Player,"FTJ_HasSourcePointForBraccusShrine",0);

IF
GlobalFlagSet("FTJ_OpenBraccusShrine")
THEN
ItemSetCanInteract(S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe,0);
PlayAnimation(S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe,"open");
TimerLaunch("FTJ_BraccusShrineSwap",5200);


IF
TimerFinished("FTJ_BraccusShrineSwap")
AND
GetPosition(S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe,_X,_Y,_Z)
THEN
TeleportToPosition(ITEMGUID_S_FTJ_BraccusShrine_ClickThrough_70aff6a1-7eca-4e35-9823-8ce455c2bd6e,_X,_Y,_Z,"",0);
ItemSetCanInteract(ITEMGUID_S_FTJ_BraccusShrine_ClickThrough_70aff6a1-7eca-4e35-9823-8ce455c2bd6e,0);
TimerLaunch("FTJ_BraccusShrineSwapOffStage",400); // Adding a timer to smooth out the swap.
SetOnStage(ITEMGUID_S_FTJ_BraccusShrine_ClickThrough_70aff6a1-7eca-4e35-9823-8ce455c2bd6e,1);
SetOnStage(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77,1);
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_RaanaarWaypoint_Active_01",ITEMGUID_S_FTJ_BraccusShrine_ClickThrough_70aff6a1-7eca-4e35-9823-8ce455c2bd6e,
					"FTJ_BraccusShrine_ActiveFx","FJ_FortJoy_Main","");

IF
TimerFinished("FTJ_BraccusShrineSwapOffStage")
THEN 
SetOnStage(S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe,0);

IF
TextEventSet("shrineopen")
THEN
GlobalSetFlag("FTJ_OpenBraccusShrine");


PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_FTJ_SW_BraccusShrineVB_Box_e558aac1-3585-4af3-a9ed-f2f22e4c7ac2)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_SeeRaanaarArmory");

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_BraccusShrine_920b6b30-744e-49d9-999b-758f2e9c5cfe)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_SeeRaanaarArmory");

IF
ObjectFlagSet("RemoveOneSourcePoint",_Player,_ID)
AND
DB_DialogName("FTJ_BraccusShrine",_ID)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_OpenRaanaarArmory");

PROC
ProcRegionEnded("FJ_FortJoy_Main")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_Start",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_OpenRaanaarArmory",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_BraccusArmory_CloseLeftFortJoy");

//END_REGION 

//REGION Braccus Axe / Demon

IF
CharacterUsedSkill(_Player,"Target_SourceDisruption",_,_)
AND
DB_FTJ_BraccusHelmOn(_Player)
THEN
ProcIncreaseCounter("FTJ_BraccusAxeSourceVampUses");

IF
ItemEquipped(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77,_Player)
THEN
DB_FTJ_BraccusHelmOn(_Player);

IF
ItemUnEquipped(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77,_Player)
AND
DB_FTJ_BraccusHelmOn(_Player)
THEN
NOT DB_FTJ_BraccusHelmOn(_Player);

IF
DB_GlobalCounter("FTJ_BraccusAxeSourceVampUses",_Int)
AND
DB_IsPlayer(_Player)
AND
DB_FTJ_BraccusHelmOn(_Player)
AND
_Int != 0
AND
_Int < 3
THEN
Proc_StartDialog(1,"FTJ_SW_AD_BraccusAxeUseVampirism",_Player);

IF
DB_GlobalCounter("FTJ_BraccusAxeSourceVampUses",3)
THEN
GlobalSetFlag("FTJ_BraccusAxeDemonSpawned");

IF
TextEventSet("bigboy")
AND
CharacterGetHostCharacter((CHARACTERGUID)_Player)
THEN
CharacterAppearAt(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_Player,1,"FTJ_DemonInBraccusAxeSpawned");
DB_FTJ_BraccusHelmDemonPlayerTarget(_Player);


IF
GlobalFlagSet("FTJ_BraccusAxeDemonSpawned")
AND
DB_IsPlayer(_Player)
AND
ItemIsInCharacterInventory(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77,_Player,1)
THEN
ItemRemove(ITEMGUID_S_FTJ_ARM_BraccusHelm_Uncured_9e30ecd5-ce72-49d6-a798-c20c8235dd77);
CharacterAppearAt(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_Player,1,"FTJ_DemonInBraccusAxeSpawned");
DB_FTJ_BraccusHelmDemonPlayerTarget(_Player);
Proc_StartDialog(1,"FTJ_SW_AD_BraccusAxeUseVampirism",_Player);
PartySetFlag(_Player,"QuestUpdate_FTJ_SW_Tyrant_HelmDemon");


IF
StoryEvent(_Demon,"FTJ_DemonInBraccusAxeSpawned")
AND
DB_FTJ_BraccusHelmDemonPlayerTarget(_Player)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_Player)
THEN
Proc_StartDialog(0,"FTJ_SW_BraccusDemon",CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_Player);

IF
DialogEnded("FTJ_SW_BraccusDemon",_)
THEN
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,0);

IF
StoryEvent(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,"FTJ_DemonInBraccusAxeSpawned")
AND
DB_FTJ_BraccusHelmDemonPlayerTarget(_Player)
AND
NOT QRY_IsAvailableTo(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_Player)
THEN
Proc_StartDialog(1,"FTJ_SW_AD_BraccusDemon",CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,0);

IF
ObjectLeftCombat(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,_)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06)
THEN
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_FTJ_SW_BraccusDemon_020cb16e-8a44-4525-9f61-d11c78a21c06,0,1,"",1);

//END_REGION

//REGION FTJ_SW_CursedRing

PROC
ProcQuestCategorySet("FTJ_SW_CursedRing",(STRING)_,(CHARACTERGUID)_Player)
AND
QuestAccepted(_Player,"FTJ_SW_CursedRing",1)
THEN
Proc_FTJ_SW_CurseRing_RegionEndedUpdate(_Player);

PROC
Proc_FTJ_SW_CurseRing_RegionEndedUpdate((CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"FTJ_SW_AsCursedRingInInventory",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_CloseLeftLevel");
QuestArchive(_Player,"FTJ_SW_CursedRing",1);

PROC
Proc_FTJ_SW_CurseRing_RegionEndedUpdate((CHARACTERGUID)_Player)
AND 
UserGetFlag(_Player,"FTJ_SW_AsCursedRingInInventory",1)
AND
ObjectGetFlag(_Player,"FTJ_SW_HasBraccusRingCurse",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SW_CursedRing_MoveToNextCategory");

//END_REGION

//this goal doesn't close on region ended because of Braccus' Helm and Ring quests

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
