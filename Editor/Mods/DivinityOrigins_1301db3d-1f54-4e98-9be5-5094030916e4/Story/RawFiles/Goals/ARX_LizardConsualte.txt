Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Consulate
ProcTriggerRegisterForPlayers(TRIGGERGUID_RC_ARX_LizardConsul_716b7fb5-bc77-473a-a9ad-4de792002624);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_LizardConsulate_Firefighters_React_6818ce80-473c-4879-8d9a-7770f51ac178);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_LizardConsulate_SawVoidwoken_eb6e9fc8-a971-4429-a79c-4a0dc1f2d60f);
DB_OriginMomentTag("ARX_LizardConsulate_DoorToHorrorSleep","RED PRINCE","ARX_LizardConsulate_DoorToHorrorSleep_COM_RedPrince");

DB_ARX_LizardConsulate_DoorToHorrorSleep("ARX_LizardConsulate_DoorToHorrorSleep");
DB_ARX_LizardConsulate_DoorToHorrorSleep("ARX_LizardConsulate_DoorToHorrorSleep_COM_RedPrince");
//Consulate plebs
//DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_TrappedHuman_77e569b6-d8e4-43ae-bd48-298880cbf1cc,"ARX_LizardConsulate_TrappedHuman"); 
DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_Priest_7e4b9156-25d5-4f9b-833f-17442ec72523,"ARX_LizardConsulate_Priest");
DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_Commoner01_6d429134-2f01-41f2-8b32-7d3904a84a2d,"ARX_LizardConsulate_Commoner01");
DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_Commoner02_582291a5-b785-4eb7-b802-30768eca317e,"ARX_LizardConsulate_Commoner02");
DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_Paladin_FireFighter2_f064869f-59b8-4671-be11-1ecfd0af228f,"ARX_LizardConsulate_Paladin_FireFighter2");
DB_Dialogs(CHARACTERGUID_S_ARX_LizardConsulate_Paladin_FireFighter1_9ea2b5d2-0821-4075-93ca-6e774da4bc40,"ARX_LizardConsulate_Paladin_FireFighter1");


//Inside the Consulate
DB_Ghosts(CHARACTERGUID_ARX_Lizard_Consulate_Female_Corpse1_00a590a5-a893-408d-ad69-d20009b83b3d,CHARACTERGUID_ARX_Lizard_Consulate_Female_Corpse1_Ghost_47a47724-bafd-4bc4-a1bd-576412c80f2d,"ARX_LizardConsulate_F_Lizard_Corpse1_Ghost");
DB_Ghosts(CHARACTERGUID_S_ARX_Lizard_Consulate_Male_Corpse3_fee772b3-ce49-4378-89b5-218bf9ee5652,CHARACTERGUID_S_ARX_Lizard_Consulate_Male_Corpse3_Ghost_bc1a7058-0a47-4462-87b3-d7e6db6a7bc3,"ARX_LizardConsulate_M_Lizard_Corpse3_Ghost");
DB_Ghosts(CHARACTERGUID_S_ARX_LizardConsulate_F_Lizard_Corpse4_134a4775-f44b-4832-98f5-2304c7d70ad2,CHARACTERGUID_S_ARX_LizardConsulate_F_Lizard_Corpse4_Ghost_ac9caae8-0a42-43f1-a2d1-2df486effd50,"ARX_LizardConsulate_F_Lizard_Corpse4_Ghost");
DB_Ghosts(CHARACTERGUID_S_ARX_LizardConsulate_Garden_DeadAssassin_462f417b-cc10-4995-9404-f7d43c3febd2,CHARACTERGUID_S_ARX_LizardConsulate_Garden_DeadAssassin_Ghost_434ca14d-aa85-4e7c-8cf2-4da75539f477,"ARX_LizardConsulate_Garden_DeadAssassin_Ghost");

ItemToInventory(ITEMGUID_S_ARX_LizardConsulate_TrappedHuman_Visa_cacf9494-1de2-49ad-822a-f2daac47db3e,CHARACTERGUID_S_ARX_LizardConsulate_TrappedHuman_77e569b6-d8e4-43ae-bd48-298880cbf1cc);

DB_ARX_LizardConsulate_EntrencePaladins((CHARACTERGUID)CHARACTERGUID_S_ARX_LizardConsulate_Paladin_FireFighter1_9ea2b5d2-0821-4075-93ca-6e774da4bc40);
DB_ARX_LizardConsulate_EntrencePaladins(CHARACTERGUID_S_ARX_LizardConsulate_Paladin_FireFighter2_f064869f-59b8-4671-be11-1ecfd0af228f);

DB_ARX_LizardConsulate_InfernalLizards((CHARACTERGUID)CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_01_ade1bfee-f057-4b1f-8390-33ae025e9ea8,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_01_SpawnHelper_44996e5f-b05e-4cd7-b0d2-c96348a05791);
DB_ARX_LizardConsulate_InfernalLizards(CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_02_c0f3c58e-8d05-4d64-9098-d2f7bb8669d0,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_02_SpawnHelper_ef7b9956-69fc-478a-b18f-38f87ee58fea);
DB_ARX_LizardConsulate_InfernalLizards(CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_03_85bf82a9-de63-4982-8806-bbd1cee3ab37,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_03_SpawnHelper_e6f54bc7-d84a-4810-a1be-7de55916cd56);
DB_ARX_LizardConsulate_InfernalLizards(CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_04_7161c772-d04d-4c6a-b5e4-46568fcbd612,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_04_SpawnHelper_308f7e3d-6c3a-4319-a938-9c6e6d752617);
DB_ARX_LizardConsulate_InfernalLizards(CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_05_7c94819e-89d2-46cf-8ea4-0d0d7e317a75,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_05_SpawnHelper_e742a9dd-05c6-4579-9e39-8b4fb51a451d);


DB_ARX_LizardConsulate_InfernalLizards_Ambush((TRIGGERGUID)TRIGGERGUID_RC_ARX_LizardConsul_716b7fb5-bc77-473a-a9ad-4de792002624,(CHARACTERGUID)CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_01_ade1bfee-f057-4b1f-8390-33ae025e9ea8,"ARX_LizardConsulate_InfernalLizard_Ambush1");
DB_ARX_LizardConsulate_InfernalLizards_Ambush((TRIGGERGUID)TRIGGERGUID_RC_ARX_LizardConsul_716b7fb5-bc77-473a-a9ad-4de792002624,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_02_c0f3c58e-8d05-4d64-9098-d2f7bb8669d0,"ARX_LizardConsulate_InfernalLizard_Ambush1");
DB_ARX_LizardConsulate_InfernalLizards_Ambush((TRIGGERGUID)TRIGGERGUID_S_ARX_LizardConsulate_InfernalLizard_Ambush2_Trigger_3a01e123-cccc-45c6-8b93-7b8a5d9f02d1,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_03_85bf82a9-de63-4982-8806-bbd1cee3ab37,"ARX_LizardConsulate_InfernalLizard_Ambush2");
DB_ARX_LizardConsulate_InfernalLizards_Ambush((TRIGGERGUID)TRIGGERGUID_S_ARX_LizardConsulate_InfernalLizard_Ambush2_Trigger_3a01e123-cccc-45c6-8b93-7b8a5d9f02d1,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_04_7161c772-d04d-4c6a-b5e4-46568fcbd612,"ARX_LizardConsulate_InfernalLizard_Ambush2");
DB_ARX_LizardConsulate_InfernalLizards_Ambush((TRIGGERGUID)TRIGGERGUID_S_ARX_LizardConsulate_InfernalLizard_Ambush2_Trigger_3a01e123-cccc-45c6-8b93-7b8a5d9f02d1,CHARACTERGUID_S_ARX_LizardConsualte_InfernalLizard_05_7c94819e-89d2-46cf-8ea4-0d0d7e317a75,"ARX_LizardConsulate_InfernalLizard_Ambush2");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_LizardConsulate_Garden_e91bc36a-e395-49e0-9ece-2cdee6aa1ecc);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_LizardConsulate_InfernalLizard_Ambush2_Trigger_3a01e123-cccc-45c6-8b93-7b8a5d9f02d1);

ItemToInventory(ITEMGUID_S_ARX_LizardConsualte_LockedDoor_01_Key_14bca736-30ad-41cb-8ebe-d4fee812f044,CHARACTERGUID_S_ARX_LizardConsulate_M_Lizard_Corpse3_fee772b3-ce49-4378-89b5-218bf9ee5652);
ItemToInventory(ITEMGUID_S_ARX_LizardConsualte_LockedDoor_Garden_Key_8cb50c0a-a9bf-4178-8bac-8914b816d999,CHARACTERGUID_S_ARX_LizardConsulate_M_Lizard_Corpse4_ddd42332-8d6f-4879-b947-aecff93d3a07);

DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_FUR_Humans_Painting_Gods_ZorlStissa_000_d6236531-c064-4166-8220-2ba9859e5cf5,"ARX_AD_Cathedral_GodsPainting_ZorlStissa");  
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_HorrorSleep_Sunset_LizardGodPicture_bf486c7d-16a5-4588-9cc8-f87d2d1c6475,"ARX_AD_Cathedral_GodsPainting_ZorlStissa");  
//SetOnStage(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,0); Handled with a Ghost tag
//REGION
DB_Dialogs(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,"ARX_BridgeCathedral_Lizard");
//END_REGION
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_GhostPainting_Indication_01",TRIGGERGUID_ARX_LizardConsulate_Garden_PortalHint_Effect_6ea2c238-8c82-4aa1-a8af-8b0c0122c441,"ARX_LizardConsulate_Garden_PortalHint","ARX_Main","");

ItemSetForceSynch(ITEMGUID_S_ARX_LizardConsualte_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,1);
KBSECTION
//REGION Lizard Consulate

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_Firefighters_React_6818ce80-473c-4879-8d9a-7770f51ac178)
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_LizardConsulate_PlayerEntered"); //used only for the Paladins outside 

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_Firefighters_React_6818ce80-473c-4879-8d9a-7770f51ac178)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_LizardConsulate_EntrencePaladins(_Paladin)
AND
QRY_SpeakerIsAvailable((CHARACTERGUID)_Paladin)
AND
QueryOnlyOnce("ARX_LizardConsulate_PaladinStartDialogOnEntry")
THEN
Proc_StartDialog(1,"ARX_LizardConsulate_AD_Paladin_FireFighter_ReactToEnteredTheConsulate",_Paladin,_Player);

//Trapped human
IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_LizardConsulate_TrappedHuman_Visa_cacf9494-1de2-49ad-822a-f2daac47db3e,_Player)
THEN
UserSetFlag(_Player,"ARX_LizardConsulate_TrappedHuman_FoundLetter");

IF
DialogEnded("ARX_LizardConsulate_Commoner01",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Lizard_Consulate_Commoner01_Leave",1)
THEN
ClearVarObject(CHARACTERGUID_S_ARX_LizardConsulate_Commoner01_6d429134-2f01-41f2-8b32-7d3904a84a2d,"currentState");
DialogRequestStop(CHARACTERGUID_S_ARX_Lizard_Consulate_Commoner02_582291a5-b785-4eb7-b802-30768eca317e);
SetHasDialog(CHARACTERGUID_S_ARX_Lizard_Consulate_Commoner02_582291a5-b785-4eb7-b802-30768eca317e,0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_ARX_Lizard_Consulate_Commoner02_582291a5-b785-4eb7-b802-30768eca317e,90,0,"",0);
SetHasDialog(_NPC,0);
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_NPC,90,0,"",0);

IF
DialogEnded("ARX_LizardConsulate_M_Lizard_Corpse3_Ghost",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_LizardConsulate_DiscoveredThePrincess_DeeperIntoTheConsulate",1)
THEN
proc_ARX_LizardConsulate_RP_React_RedPrincessInConsulate((CHARACTERGUID)_Player);

PROC
proc_ARX_LizardConsulate_RP_React_RedPrincessInConsulate(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
AND
QueryOnlyOnce("ARX_AD_LizardConsulate_RP_RedPrincessInConsulate_OnlyOnce")
THEN
Proc_StartDialog(1,"ARX_AD_LizardConsulate_RP_RedPrincessInConsulate",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);


PROC
proc_ARX_LizardConsulate_RP_React_RedPrincessInConsulate((CHARACTERGUID)_Player)
AND
GetDistanceTo(_Player,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Dist)
AND
_Dist < 16.0
AND
QueryOnlyOnce("ARX_AD_LizardConsulate_RP_RedPrincessInConsulate_OnlyOnce")
THEN
Proc_StartDialog(1,"ARX_AD_LizardConsulate_RP_RedPrincessInConsulate",CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

PROC
proc_ARX_LizardConsulate_RP_React_RedPrincessInConsulate(_Player)
AND
NOT DB_OnlyOnce("ARX_AD_LizardConsulate_RP_RedPrincessInConsulate_OnlyOnce")
THEN
ObjectClearFlag(_Player,"ARX_LizardConsulate_DiscoveredThePrincess_DeeperIntoTheConsulate");
//END_REGION

//REGION Horror Sleep Start

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_Garden_e91bc36a-e395-49e0-9ece-2cdee6aa1ecc)
AND
PartyGetFlag(_Player,"ARX_AD_LizardConsulate_Garden",0)
THEN
PartySetFlag(_Player,"ARX_AD_LizardConsulate_Garden");
Proc_StartDialog(1,"ARX_AD_LizardConsulate_Garden",_Player);

IF
ItemGhostRevealed(ITEMGUID_S_ARX_LizardConsualte_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSeeGhost(_Player,ITEMGUID_S_ARX_LizardConsualte_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,1)
THEN
Proc_ARX_LizardConsualte_DoorToHorrorSleep_Revealed(_Player);

IF
ItemGhostRevealed(ITEMGUID_S_ARX_LizardConsualte_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5)
THEN
ItemSetForceSynch(ITEMGUID_S_ARX_LizardConsualte_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,0);

PROC
Proc_ARX_LizardConsualte_DoorToHorrorSleep_Revealed((CHARACTERGUID)_Player)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_LizardConsulate_ConsulateRP");

PROC
Proc_ARX_LizardConsualte_DoorToHorrorSleep_Revealed((CHARACTERGUID)_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QueryOnlyOnce("ARX_LizardConsualte_DoorToHorrorSleep_Revealed")
THEN
StartVoiceBark("ARX_LizardConsualte_VB_DoorToHorrorSleep_Revealed",_Player);

/*
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_Garden_e91bc36a-e395-49e0-9ece-2cdee6aa1ecc)
AND
NOT DB_IsPlayer(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_ConsulateNoRP");


IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_716b7fb5-bc77-473a-a9ad-4de792002624)
AND
DB_IsPlayer(_Player)
THEN
proc_ARX_LizardConsulate_DoorToHorrorSleep_CheckForRedPrince();

PROC
proc_ARX_LizardConsulate_DoorToHorrorSleep_CheckForRedPrince()
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"RED PRINCE",1)
THEN
GlobalSetFlag("ARX_LizardConsulate_DoorToHorrorSleep_REDPRINCE_Found");

PROC
proc_ARX_LizardConsulate_DoorToHorrorSleep_CheckForRedPrince()
AND
GlobalGetFlag("ARX_LizardConsulate_DoorToHorrorSleep_REDPRINCE_Found",0)
THEN
SetOnStage(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,0);

PROC
proc_ARX_LizardConsulate_DoorToHorrorSleep_CheckForRedPrince()
AND
GlobalGetFlag("ARX_LizardConsulate_DoorToHorrorSleep_REDPRINCE_Found",1)
THEN
SetOnStage(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,1);
SetTag(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,"GHOST");
*/

IF
ItemGhostRevealed(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5)
AND
PlayLoopEffect(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,"RS3_FX_GP_ScriptedEvent_HorrorSleep_Portal_Spirits_01","",_Handle)
THEN
DB_S_ARX_LizardConsulate_DoorToHorrorSleep_Effect(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,_Handle);


IF
GlobalFlagSet("ARX_HorrorSleep_Closed")
AND
DB_S_ARX_LizardConsulate_DoorToHorrorSleep_Effect(ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,_Handle)
THEN
StopLoopEffect(_Handle);

IF
GlobalFlagSet("ARX_HorrorSleep_Closed")
THEN
PROC_StopLoopEffect(TRIGGERGUID_ARX_LizardConsulate_Garden_PortalHint_Effect_6ea2c238-8c82-4aa1-a8af-8b0c0122c441,"ARX_LizardConsulate_Garden_PortalHint");

IF 
CharacterUsedItem(_Player,ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5)
AND
GlobalGetFlag("ARX_HorrorSleep_Closed",0)
AND
CharacterIsInCombat(_Player,0)
THEN
Proc_StartDialog(0,"ARX_LizardConsulate_DoorToHorrorSleep",ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5,_Player);

IF 
CharacterUsedItem(_Player,ITEMGUID_S_ARX_LizardConsulate_DoorToHorrorSleep_0453f684-d357-8be0-4b5e-13e6004ed7d5)
AND
GlobalGetFlag("ARX_HorrorSleep_Closed",0)
AND
CharacterIsInCombat(_Player,1)
THEN
Proc_Arx_HorrorSleep_InitiateTeleport_CheckDestination((CHARACTERGUID)_Player);

IF
DialogEnded(_Dialog,_ID)
AND
DB_ARX_LizardConsulate_DoorToHorrorSleep(_Dialog)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag(_Player,"ARX_LizardConsulate_DoorToHorrorSleep_StartTeleport",1)
THEN
Proc_Arx_HorrorSleep_InitiateTeleport_CheckDestination((CHARACTERGUID)_Player);
ObjectClearFlag(_Player,"ARX_LizardConsulate_DoorToHorrorSleep_StartTeleport");
PROC
Proc_Arx_HorrorSleep_InitiateTeleport_CheckDestination((CHARACTERGUID)_Char)
AND
PartyGetFlag(_Char,"ARX_LizardPrincess_AskedToBringRP",1)
THEN
Proc_ARX_HorrorSleep_TeleportToSunSet(_Char,1);

PROC
Proc_Arx_HorrorSleep_InitiateTeleport_CheckDestination((CHARACTERGUID)_Char)
AND
PartyGetFlag(_Char,"ARX_LizardPrincess_AskedToBringRP",0)
THEN
Proc_Arx_HorrorSleep_InitiateTeleport((CHARACTERGUID)_Char);

PROC
Proc_Arx_HorrorSleep_InitiateTeleport((CHARACTERGUID)_Char)
AND
DB_IsPlayer(_Player)
AND
CharactersAreGrouped(_Char,_Player,1)
THEN
ApplyStatus(_Player,"BLIND",3.0,1);

PROC
Proc_Arx_HorrorSleep_InitiateTeleport((CHARACTERGUID)_Char)
AND
GetUUID(_Char,_StringUUID)
AND
StringConcatenate("HorrorSleep_InitiateTeleport_Timer_",_StringUUID,_String)
THEN
DB_Arx_HorrorSleep_InitiateTeleport(_Char,_String);
PlayEffect(_Char,"RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeIn_01");
FadeToBlack(_Char,2.0,0,"HorrorSleep_InitiateTeleport");
TimerLaunch(_String,3000);

IF
TimerFinished(_String)
AND
DB_Arx_HorrorSleep_InitiateTeleport(_Char,_String)
AND
DB_IsPlayer(_Other)
AND
CharactersAreGrouped(_Other,_Char,1)
THEN
PlayEffect(_Other,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");
LeaveCombat(_Other);
ProcForceStopDialog(_Other);
TeleportTo(_Other,TRIGGERGUID_S_RC_ARX_HorrorSleep_StartPoint_ad545a8f-fb39-4ef3-af74-62b56e5ae8d5,"TEMP_RC_ARX_HorrorSleep_Closed",1);

IF
TimerFinished(_String)
AND
DB_Arx_HorrorSleep_InitiateTeleport(_Char,_String)
AND
GetPosition(_Char,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);
PlayEffect(_Char,"RS3_FX_GP_ScriptedEvent_FJ_RedPrinceO_DarknessFadeOut_01");
FadeToBlack(_Char,2.0,1,"HorrorSleep_InitiateTeleport");
NOT DB_Arx_HorrorSleep_InitiateTeleport(_Char,_String);
TimerLaunch("RC_ARX_VB_HorrorSleep_Enter",2000);

IF
TimerFinished("RC_ARX_VB_HorrorSleep_Enter")
AND
DB_InRegion(_Char,TRIGGERGUID_S_RC_ARX_HorrorSleep_1b8cf005-392f-434a-a564-ecae6778fab0)
AND
QueryOnlyOnce("RC_ARX_VB_HorrorSleep_Enter")
THEN
StartVoiceBark("RC_ARX_VB_HorrorSleep_Enter",_Char);

IF
CharacterEnteredTrigger(_Player,S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0) //Eentered HorrorSleep Block WP
THEN
PROC_BlockWaypointUsage(_Player);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_716b7fb5-bc77-473a-a9ad-4de792002624) //Left HorrorSleep
AND
DB_BlockWaypointUsage(_Player)
THEN
PROC_UnblockWaypointUsage(_Player);

//END_REGION

//REGION Infernal Lizards
IF
DB_ARX_LizardConsulate_InfernalLizards(_Lizard,_)
THEN
SetOnStage(_Lizard,0);

IF
CharacterUsedSkillOnTarget(_Player,(CHARACTERGUID)_Lizard,"Target_Bless",_,_)
AND
DB_IsPlayer(_Player) // Just in case
AND
DB_ARX_LizardConsulate_InfernalLizards(_Lizard,_)
AND
CharacterIsDead(_Lizard,0)
AND
QueryOnlyOnce("ARX_LizardConsulate_AD_InfernalLizard_ReactToBlessed")
THEN
Proc_StartDialog(1,"ARX_LizardConsulate_AD_InfernalLizard_ReactToBlessed",_Player);

IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_ARX_LizardConsulate_InfernalLizards_Ambush(_Trigger,_Lizard,_GroupString)
AND
QueryOnlyOnce(_GroupString)
THEN
ARX_LizardConsulate_InfernalLizard_Ambush(_GroupString);

PROC
ARX_LizardConsulate_InfernalLizard_Ambush((STRING)_GroupString)
AND
DB_ARX_LizardConsulate_InfernalLizards_Ambush(_Trigger,_Lizard,_GroupString)
THEN
CharacterAppear(_Lizard,1,"");

IF
CharacterCharacterEvent(_Lizard,_Helper,"ARX_LizardConsulate_InfernalLizard_Ressurect")
AND
NOT DB_OnlyOnce("ARX_LizardConsulate_InfernalLizard_Ressurect")
THEN
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard);

IF
ObjectEnteredCombat((CHARACTERGUID)_Lizard,_CombatID)
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard)
THEN
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard);
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID);

IF
ObjectTurnStarted((CHARACTERGUID)_Player)
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID) //Early out
AND
DB_IsPlayer(_Player)
AND
CombatGetIDForCharacter(_Player,_CombatID)
AND
QueryOnlyOnce("ARX_LizardConsulate_InfernalLizard_Ressurect")
THEN
Proc_StartDialog(1,"ARX_LizardConsulate_AD_InfernalLizard_Ressurect",_Player);
PartySetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_Consulate_InfernalLizardResurrected");
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID);

IF
ObjectSwitchedCombat((CHARACTERGUID)_Lizard,_OldCombatID,_NewCombatID) // Combat merge
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_OldCombatID)
THEN
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_OldCombatID);
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID) //This means that the AD didn't trigger and combat ended when the Lizard ressuracted too far to keep being in combat. 
THEN
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID);

//Cleanup
IF
AutomatedDialogStarted("ARX_LizardConsulate_AD_InfernalLizard_Ressurect",_)
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard)
THEN
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard);

IF
AutomatedDialogStarted("ARX_LizardConsulate_AD_InfernalLizard_Ressurect",_)
AND
DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID)
THEN
NOT DB_ARX_LizardConsulate_InfernalLizard_Ressurect_PlayerReact(_Lizard,_CombatID);

//Ressurect Logic
/*
IF
CharacterCharacterEvent(_Lizard,_Helper,"ARX_LizardConsulate_InfernalLizard_Ressurect")
AND
CharacterIsInCombat(_Helper,1)
THEN
DB_ARX_LizardConsulate_InfernalLizards_JumpToTurn(_Lizard);

IF
ObjectEnteredCombat((CHARACTERGUID)_Lizard,_CombatID)
AND
DB_ARX_LizardConsulate_InfernalLizards_JumpToTurn(_Lizard)
THEN
NOT DB_ARX_LizardConsulate_InfernalLizards_JumpToTurn(_Lizard);
JumpToTurn(_Lizard);
*/
IF
CharacterCharacterEvent(_Lizard,_Helper,"ARX_LizardConsulate_InfernalLizard_Ressurect")
AND
GetPosition(_Helper,_X,_Y,_Z)
THEN
//CharacterUseSkillAtPosition((CHARACTERGUID)_Helper,"Target_Bless",_X,_Y,_Z,1,1);
SetOnStage(_Lizard,1);
CharacterResurrect((CHARACTERGUID)_Lizard);
PlayEffect(_Lizard,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_02");
PlayEffect(_Lizard,"RS3_FX_Skills_Fire_Cast_Shout_Supernova_01");
CreateSurfaceAtPosition(_X,_Y,_Z,"SurfaceNone",3.0,-1.0);

IF
CharacterCharacterEvent(_Lizard,_Helper,"ARX_LizardConsulate_InfernalLizard_StartSpawner") //Offstage being handled in Behaviour
THEN
SetOnStage(_Helper,1);

IF
StoryEvent(_Helper,"ARX_InfernalLizard_FoundNewSurface") //Offstage being handled in Behaviour
THEN
CharacterPurgeQueue((CHARACTERGUID)_Helper);

IF
CharacterCharacterEvent(_Lizard,_Helper,"ARX_LizardConsulate_InfernalLizard_DieExplode")
THEN
SetOnStage(_Lizard,1);
SetOnStage(_Helper,0);
PlayEffect(_Lizard,"RS3_FX_GP_ScriptedEvent_ARX_Lizard_Revenant_Death_01","Dummy_BodyFX");

IF
CharacterResurrected(_Lizard)
AND
DB_ARX_LizardConsulate_InfernalLizards(_Lizard,_)
THEN
SetStoryEvent(_Lizard,"ARX_InfernalLizard_Ressurected"); //This removes the helper from cobmat and allows a smoother transition
ApplyStatus(_Lizard,"NECROFIRE",-1.0,1);

//END_REGION 

//REGION Journal 
// useless entry
/*IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_SawVoidwoken_eb6e9fc8-a971-4429-a79c-4a0dc1f2d60f)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_SawVoidwoken");*/

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_LizardConsulate_Firefighters_React_6818ce80-473c-4879-8d9a-7770f51ac178)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_EnteredTheConsulate");

IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_LizardConsulate_VisitorRecords_51a20859-a7f8-4708-b5df-9d7fa7761190,_Player)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_DiscoveredThePrincessWasHere");

IF
TimerFinished("RC_ARX_VB_HorrorSleep_Enter")
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_ARX_HorrorSleep_1b8cf005-392f-434a-a564-ecae6778fab0)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_HorrorSleep_Enter",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_HorrorSleep_Enter");

IF
GlobalFlagSet("ARX_HorrorSleep_Closed")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_ConsulateNoRP",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_EnteredTheConsulate",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_HorrorSleep_Enter",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_LizardConsulate_ConsulateNoRP");

IF
GlobalFlagSet("ARX_HorrorSleep_Closed") //Removed DB_IsPlayer Check to handle a dismissed prince at this point
AND
NOT DB_InRegion(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
THEN
proc_ARX_HorrorSleep_Closed_RP_JournalUpdate(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);

IF
GlobalFlagSet("ARX_HorrorSleep_Closed")
AND
DB_InRegion(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
THEN
DB_ARX_HorrorSleep_Closed_TriggerJournalUpdateOnLeave(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c);

IF
DB_WasInRegion(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Sunset)
AND
DB_ARX_HorrorSleep_Closed_TriggerJournalUpdateOnLeave(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Sunset)
THEN
proc_ARX_HorrorSleep_Closed_RP_JournalUpdate(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
NOT DB_ARX_HorrorSleep_Closed_TriggerJournalUpdateOnLeave(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Sunset);

PROC
proc_ARX_HorrorSleep_Closed_RP_JournalUpdate((CHARACTERGUID)_RedPrince)
AND
DB_Avatars(_RedPrince)
THEN
ObjectSetFlag(_RedPrince,"QuestUpdate_FTJ_OriginRedPrince_CompleteEmpire");

PROC
proc_ARX_HorrorSleep_Closed_RP_JournalUpdate((CHARACTERGUID)_RedPrince)
AND
NOT DB_Avatars(_RedPrince)
THEN
ObjectSetFlag(_RedPrince,"QuestUpdate_FTJ_COM_RedPrince_CompleteEmpire");

//END_REGION

//REGION Handle Death In HorrorSleep 
////Proc Triggers
IF
GlobalFlagSet("ARX_HorrorSleep_Closed")
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0);
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21);
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c);

//Hanlding Pyramids left behind - Called on teleport back to reality

PROC
proc_ARX_HorrorSleep_CheckPyramids()
AND
DB_TeleporterPyramidUnlocked(_Pyramid)
AND
ItemIsInInventory(_Pyramid,0)
AND
qry_ARX_HorrorSleep_CheckForPyramidsLeftBehind(_Pyramid)
AND
GetPosition(TRIGGERGUID_ARX_HorrorSleep_Sunset_BackToReality_Point_12d36d65-789b-48be-9667-5bf2d0b66b40,_X,_Y,_Z)
AND
GetPosition(_Pyramid,_Xpyrm,_Ypyrm,_Zpyrm)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_Xpyrm,_Ypyrm,_Zpyrm);
ItemScatterAt(_Pyramid,_X,_Y,_Z);
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);

QRY
qry_ARX_HorrorSleep_CheckForPyramidsLeftBehind((ITEMGUID)_Pyramid)
AND
ObjectIsInTrigger(_Pyramid,S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0,1)
THEN
DB_Noop(1);

QRY
qry_ARX_HorrorSleep_CheckForPyramidsLeftBehind((ITEMGUID)_Pyramid)
AND
ObjectIsInTrigger(_Pyramid,S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21,1)
THEN
DB_Noop(1);

QRY
qry_ARX_HorrorSleep_CheckForPyramidsLeftBehind((ITEMGUID)_Pyramid)
AND
ObjectIsInTrigger(_Pyramid,S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c,1)
THEN
DB_Noop(1);

PROC
ProcObjectTimerFinished(_Char,"ARX_HorrorSleep_TeleportToWarZone")
THEN
ProcObjectTimerCancel(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay");
ProcObjectTimer(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay",100);

PROC
ProcObjectTimerFinished(_Char,"ARX_HorrorSleep_TeleportToSunSet")
THEN
ProcObjectTimerCancel(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay");
ProcObjectTimer(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay",100);

IF
TimerFinished(_String)
AND
DB_Arx_HorrorSleep_InitiateTeleport_BackToReality(_Char,_String)
THEN
ProcObjectTimerCancel(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay");
ProcObjectTimer(TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay",100);



//Added Timer as DB_InRegion was not updated yet when the proc ran
PROC
ProcObjectTimerFinished(_Region,"proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion_FrameDelay")
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion((TRIGGERGUID)_Region);

IF
CharacterDied(_Player)
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0)
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0);

IF
CharacterDied(_Player)
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21);

IF
CharacterDied(_Player)
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c);

////Proc Functions
PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion((TRIGGERGUID)_Region)
AND
DB_InRegion(_Player,_Region)
AND
CharacterIsDead(_Player,0)
THEN
DB_ARX_HorrorSleep_PlayersAliveInRegion(_Player,_Region);

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0)
AND
NOT DB_ARX_HorrorSleep_PlayersAliveInRegion(_,TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0)
AND
DB_InRegion(_OtherPlayers,TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
AND
CharacterIsDead(_OtherPlayers,0)
AND
ObjectGetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting",0)
THEN
ObjectSetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting");
Proc_ARX_HorrorSleep_TeleportToWarZone(_Player,0);
GlobalSetFlag("ARX_HorrorSleep_DeadPlayersTeleported");

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
AND
NOT DB_ARX_HorrorSleep_PlayersAliveInRegion(_,TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
AND
DB_InRegion(_OtherPlayers,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
AND
CharacterIsDead(_OtherPlayers,0)
AND
ObjectGetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting",0)
THEN
ObjectSetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting");
Proc_ARX_HorrorSleep_TeleportToSunSet(_Player,0);
GlobalSetFlag("ARX_HorrorSleep_DeadPlayersTeleported");

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
AND
NOT DB_ARX_HorrorSleep_PlayersAliveInRegion(_,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
AND
NOT DB_InRegion(_,TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
AND
ObjectGetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting",0)
THEN
ObjectSetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting");
Proc_Arx_HorrorSleep_Sunset_BackToReality_InitiateTeleport(_Player,0);
GlobalSetFlag("ARX_HorrorSleep_DeadPlayersTeleported");


PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(_Region)
AND
NOT DB_ARX_HorrorSleep_PlayersAliveInRegion(_,_Region)
AND
GlobalGetFlag("ARX_HorrorSleep_DeadPlayersTeleported",0)
AND
DB_InRegion(_Player,_Region)
AND
ObjectGetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting",0)
THEN
ObjectSetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting");
Proc_Arx_HorrorSleep_Sunset_BackToReality_InitiateTeleport(_Player,0);


//CleanUp 
PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(_Region)
THEN
GlobalClearFlag("ARX_HorrorSleep_DeadPlayersTeleported");

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(_Region)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting",1)
THEN
ObjectClearFlag(_Player,"ARX_HorrorSleep_DeadPlayersTeleporting");

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion((TRIGGERGUID)_Region)
AND
DB_ARX_HorrorSleep_PlayersAliveInRegion(_Player,_Region)
THEN
NOT DB_ARX_HorrorSleep_PlayersAliveInRegion(_Player,_Region);

PROC
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Sunset_67df0f1c-9cf2-46c5-8b28-64376a9b274c)
AND
GlobalGetFlag("ARX_HorrorSleep_Closed",1)
THEN
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_Arena_1b8cf005-392f-434a-a564-ecae6778fab0); //In case there are someone in the warzone and Arena
proc_ARX_HorrorSleep_CheckForDeadPlayersInRegion(TRIGGERGUID_S_ARX_HorrorSleep_WarZone_59391e6d-a22d-4f33-982b-a5b65c023e21);

//END_REGION

//REGION Paladins outside 


IF
DialogEnded("ARX_LizardConsulate_Paladin_FireFighter1",_ID)
AND
GlobalGetFlag("ARX_LizardConsulate_PaladinsLeave",1)
THEN
proc_ARX_LizardConsulate_Paladin_FireFighter_Leave();

PROC
proc_ARX_LizardConsulate_Paladin_FireFighter_Leave()
AND
DB_ARX_LizardConsulate_EntrencePaladins(_Paladin)
AND
CharacterIsDead(_Paladin,0)
THEN
ProcForceStopDialog(_Paladin);
SetHasDialog(_Paladin,0);
ProcCharacterDisappearOutOfSight(_Paladin,0,0,"",0);

//END_REGION

//REGION ARX2-80  
IF
ObjectFlagSet("QuestUpdate_ARX_LizardConsulate_BridgeCathedral_Start",(CHARACTERGUID)_Char,_)
THEN
ProcShowMarker(_Char,"ARX_LizardConsulate");

IF
CharacterCharacterEvent(_Char,_Helper,"ARX_LizardConsulate_InfernalLizard_DieExplode")
AND
DB_ARX_LizardConsulate_InfernalLizards(_Char,_)
THEN
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead();

PROC
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead()
THEN
NOT DB_ARX_LizardConsulate_InfernalLizards_Alive(1);

PROC
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead()
AND
DB_ARX_LizardConsulate_InfernalLizards(_Char,_)
AND
CharacterIsDead(_Char,0)
THEN
DB_ARX_LizardConsulate_InfernalLizards_Alive(1);

PROC
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead()
AND
DB_ARX_LizardConsulate_InfernalLizards(_Char,_Helper)
AND
ObjectGetFlag(_Helper,"ARX_LizardConsulate_InfernalLizard_SpawnerWaitingToSpawn",1)
THEN
DB_ARX_LizardConsulate_InfernalLizards_Alive(1);

PROC
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead()
AND
NOT DB_ARX_LizardConsulate_InfernalLizards_Alive(1)
THEN
GlobalSetFlag("ARX_LizardConsulate_InfernalLizards_Cleared");

PROC
Proc_ARX_LizardConsulate_InfernalLizards_CheckIfAllDead()
AND
GlobalGetFlag("ARX_LizardConsulate_InfernalLizards_Cleared",1)
AND
DB_IsPlayer(_Char)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_LizardConsulate_KilledAllInfernalLizards");

IF
ObjectLeftCombat(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,_)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,0)
AND
GlobalGetFlag("ARX_BridgeCathedral_Lizard_MoveToConsulet",1)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,TRIGGERGUID_ARX_BridgeCathedral_Lizard_MoveToTrigger_4f5bc924-69fc-435a-8fbb-d6c74902a8fa,0,"ARX_BridgeCathedral_Lizard_Reached");

IF
DialogEnded("ARX_BridgeCathedral_Lizard",_)
AND
GlobalGetFlag("ARX_BridgeCathedral_Lizard_MoveToConsulet",1)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,TRIGGERGUID_ARX_BridgeCathedral_Lizard_MoveToTrigger_4f5bc924-69fc-435a-8fbb-d6c74902a8fa,0,"ARX_BridgeCathedral_Lizard_Reached");

IF
StoryEvent(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,"ARX_BridgeCathedral_Lizard_Reached")
THEN
GlobalSetFlag("ARX_BridgeCathedral_Lizard_MovedToConsulet");
GlobalClearFlag("ARX_BridgeCathedral_Lizard_MoveToConsulet");

IF
GlobalFlagSet("ARX_LizardConsulate_InfernalLizards_Cleared")
AND
GlobalGetFlag("ARX_BridgeCathedral_Lizard_MovedToConsulet",0)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608,TRIGGERGUID_ARX_BridgeCathedral_Lizard_MoveToTrigger_4f5bc924-69fc-435a-8fbb-d6c74902a8fa,0,"ARX_BridgeCathedral_Lizard_Reached");

IF
GlobalFlagSet("ARX_LizardConsulate_InfernalLizards_Cleared")
AND
GlobalGetFlag("ARX_BridgeCathedral_Lizard_MovedToConsulet",0)
AND
NOT QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_BridgeCathedral_Lizard_e8a80940-735b-4aee-812f-e4a59665a608)
THEN
GlobalSetFlag("ARX_BridgeCathedral_Lizard_MoveToConsulet");

IF
DB_Dead(CHARACTERGUID_S_ARX_BridgeCathedral_Guard_06_fa9d4495-433c-4e21-87e7-f541ca3a18f6)
AND
DB_Dead(CHARACTERGUID_S_ARX_BridgeCathedral_Guard_07_744510f5-d178-4dde-b395-3765f537fa3c)
THEN
GlobalSetFlag("ARX_BridgeCathedral_Lizard_BothDead");


//END_REGION

//REGION
IF
StoryEvent((CHARACTERGUID)_Char,"ARX_LizardConsulate_Priest_SpottedChar")
AND
GlobalGetFlag("ARX_LizardConsulate_InfernalLizards_Cleared",0)
THEN
GlobalSetFlag("ARX_LizardConsulate_Priest_ApproachOnce");
Proc_StartDialog(0,"ARX_LizardConsulate_Priest",CHARACTERGUID_S_ARX_LizardConsulate_Priest_7e4b9156-25d5-4f9b-833f-17442ec72523,_Char);

IF
GlobalFlagSet("ARX_LizardConsulate_InfernalLizards_Cleared")
THEN
GlobalSetFlag("ARX_LizardConsulate_Priest_StopSpotter");

IF
DialogStarted("ARX_LizardConsulate_Priest",_)
THEN
GlobalSetFlag("ARX_LizardConsulate_Priest_StopSpotter");


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
