Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ARX_Barracks_WhiteMagisterVault_Evidence(S_ARX_Barracks_WhiteMagisterVault_Evidence1_dfab7a60-37a1-4fda-a1a1-d7cff36f7c05,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer1_fbfb66cf-505f-4e0a-a68a-b7a760c209ac);
DB_ARX_Barracks_WhiteMagisterVault_Evidence(S_ARX_Barracks_WhiteMagisterVault_Evidence2_01d59fd6-b7a0-4a1d-a16c-46f28980fc23,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer2_c5d2726a-fe71-4287-a7f4-3a2d0c15e390);
DB_ARX_Barracks_WhiteMagisterVault_Evidence(S_ARX_Barracks_WhiteMagisterVault_Evidence3_9225011f-3bf0-4948-a947-f0059980577d,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer3_86463879-0c92-4249-a543-f500a6035d12);

/*
DB_ARX_Barracks_WhiteMagisterVault_EvidenceContainters(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer1_fbfb66cf-505f-4e0a-a68a-b7a760c209ac,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer1_Trigger_06ea8254-4503-4009-b158-ca9695d7fc2b);
DB_ARX_Barracks_WhiteMagisterVault_EvidenceContainters(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer2_c5d2726a-fe71-4287-a7f4-3a2d0c15e390,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer2_Trigger_e52a0d4c-941f-416d-914e-f80b6b6b4de6);
DB_ARX_Barracks_WhiteMagisterVault_EvidenceContainters(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer3_86463879-0c92-4249-a543-f500a6035d12,S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer3_Trigger_d9318b26-e047-44e0-9af9-967476be6465);
*/

DB_ARX_Barracks_WhiteMagisterVault_BurntEvidence(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer1_fbfb66cf-505f-4e0a-a68a-b7a760c209ac,S_ARX_Barracks_WhiteMagisterVault_Evidence1_Burned_d504a4f6-2730-4b14-bf30-22fab0071e67);
DB_ARX_Barracks_WhiteMagisterVault_BurntEvidence(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer2_c5d2726a-fe71-4287-a7f4-3a2d0c15e390,S_ARX_Barracks_WhiteMagisterVault_Evidence2_Burned_6d09c7e6-9cde-4bb6-a500-8cdc4a2e1153);
DB_ARX_Barracks_WhiteMagisterVault_BurntEvidence(S_ARX_Barracks_WhiteMagisterVault_EvidenceContainer3_86463879-0c92-4249-a543-f500a6035d12,S_ARX_Barracks_WhiteMagisterVault_Evidence3_Burned_9b1dcbea-fa77-43c5-901e-41cb16e20d11);

SetOnStage(S_ARX_Barracks_WhiteMagisterVault_Evidence1_Burned_d504a4f6-2730-4b14-bf30-22fab0071e67,0);
SetOnStage(S_ARX_Barracks_WhiteMagisterVault_Evidence2_Burned_6d09c7e6-9cde-4bb6-a500-8cdc4a2e1153,0);
SetOnStage(S_ARX_Barracks_WhiteMagisterVault_Evidence3_Burned_9b1dcbea-fa77-43c5-901e-41cb16e20d11,0);

ItemSetCanInteract(ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9,0);


DB_ARX_Barracks_WhiteMagisterVault_Gheists(S_ARX_Barracks_WhiteMagisterVault_Gheist1_bf45ee01-e395-4169-9013-4dd96e422e07);
DB_ARX_Barracks_WhiteMagisterVault_Gheists(S_ARX_Barracks_WhiteMagisterVault_Gheist2_99366040-3f84-4fbb-ac32-b26fe0378ae8);
DB_ARX_Barracks_WhiteMagisterVault_Gheists(S_ARX_Barracks_WhiteMagisterVault_Gheist3_1a3dd9ea-1c4c-440e-82bf-0e9ca9ac6e30);

/*
//Corpses
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse1_42da85cd-56cf-4485-81a1-c1cda52916a9);
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse2_9b077c9a-ebdf-4a76-8558-4541b4f5989d);
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse3_b673e6ca-9af7-4552-8aed-c19cd3d95110);
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse4_53983d0f-1f1b-4587-bdbc-362429b46804);
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse5_a87ede6d-0477-45ba-9fe6-986454acdacc);
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse6_9679a9b5-1493-489c-b10c-e0a1dc921f42);
*/

DB_Ghosts(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse5_a87ede6d-0477-45ba-9fe6-986454acdacc,S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse5_Ghost_f35de200-ac3f-4e4f-9f57-d3790d4624d2,"ARX_Barracks_WhiteMagisterVault_MagisterCorpse5_Ghost");
DB_Ghosts(S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse1_42da85cd-56cf-4485-81a1-c1cda52916a9,S_ARX_Barracks_WhiteMagisterVault_MagisterCorpse1_Ghost_6575823e-ae67-4203-9560-2169f981c5f1,"ARX_Barracks_WhiteMagisterVault_MagisterCorpse1_Ghost");

//Secret Passage
ProcTriggerRegisterForPlayers(S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Barracks_2ndFloor_Archives_TreasureRoom_320e38f2-03d9-4a52-b9fc-6177e3a5bedf);
ItemSetCanInteract(S_ARX_Barracks_WhiteMagisterVault_ToArchives_3345cde5-07ef-4361-b9fb-388d623b1aac,0);


KBSECTION
//REGION Initiate Evidence Containters
IF
DB_ARX_Barracks_WhiteMagisterVault_Evidence(_Evidence,_Containter)
THEN
ItemToInventory((ITEMGUID)_Evidence,_Containter);

/*
IF
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagisterCorpses(_DeadMagister)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_OneUseKey")
THEN
ItemTemplateAddTo("ARX_Barracks_WhiteMagisterVault_OneUseKey_0b60b99c-5278-46f5-980b-efc2e2abcc79",_DeadMagister,1);
*/

PROC
ProcRegionStarted("ARX_Main")
AND
GlobalGetFlag("RC_DW_DwarvenSabotage_GaveLetterToMagister",1)
AND
GetInventoryOwner(S_RC_DW_WC_EmpressLetter_ffaa5485-ccc8-4e66-a69b-52316fdc7c82,_Owner)
AND
NOT DB_IsPlayer((CHARACTERGUID)_Owner)
THEN
TeleportTo(S_RC_DW_WC_EmpressLetter_ffaa5485-ccc8-4e66-a69b-52316fdc7c82,S_ARX_Barracks_RC_DW_WC_EmpressLetter_Trigger_04ff12ac-8c91-46ef-8f67-851782329ec5);

//END_REGION

//REGION Initiate White Magister
IF
DB_ARX_Barracks_WhiteMagisterVault_Gheists(_Gheist)
THEN
DB_DontCreateMurder((CHARACTERGUID)_Gheist);

PROC
ProcRegionStarted("ARX_Main")
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_ResurrectWhiteMagister")
THEN
GlobalSetFlag("ARX_Barracks_WhiteMagisterVault_WhiteMagisterWasDeadInRC");
DB_Ghosts(S_ARX_Barracks_WhiteMagisterVault_WhiteMagisterGhost_93f45e9f-1ec5-4b6c-8733-4f4b9a54c2cd,"ARX_Barracks_WhiteMagisterVault_WhiteMagisterGhost");
CharacterSetForceSynch(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1);

PROC
ProcRegionStarted("ARX_Main")
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1)
THEN
SetRelationFactionToPlayers("ARX_Barracks_WhiteMagister",0);

PROC
ProcRegionStarted("ARX_Main")
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_WhiteMagister_SetUp")
THEN
CharacterLevelUpTo(CHARACTERGUID_S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,18);
SetOnStage(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1);
CharacterSetCanTrade(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0);
ItemToInventory(S_ARX_Barracks_WhiteMagisterVault_ReimondsJournal_aeb8cffd-a213-4279-931c-3f73967efa4f,S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
//ItemToInventory(ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_Book_BraccusRexReveal_c719e9ac-c2fd-425a-83ef-10c22481e36c,S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7); //Removed that doc from reimond's body
DB_Ghosts(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,S_ARX_Barracks_WhiteMagisterVault_WhiteMagisterGhost_93f45e9f-1ec5-4b6c-8733-4f4b9a54c2cd,"ARX_Barracks_WhiteMagisterVault_WhiteMagisterGhost");
ProcRemoveAllDialogEntriesForSpeaker(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7); 
DB_Dialogs(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,"ARX_Barracks_WhiteMagisterVault_WhiteMagister");
DB_DontCreateMurder(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
TeleportTo(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,swsws_f0c8f785-d51c-4b26-ad48-e42fad1e7f14);
SetFaction(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,"ARX_Barracks_WhiteMagister");
//ProcCharacterDisableCrime(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,"Assault");
ProcCharacterDisableAllCrimes(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
DB_CrimeReaction_DoNotInterrogate(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
GlobalSetFlag("ARX_Barracks_WhiteMagister_IsInARX");
GlobalSetFlag("ARX_Barracks_WhiteMagister_StartOnSightScript");

IF
TextEventSet("ARX_Barracks_WhiteMagisterVault_WhiteMagister_IsInARX")
THEN
GlobalClearFlag("ARX_Barracks_WhiteMagister_IsInARX");
GlobalSetFlag("ARX_Barracks_WhiteMagister_IsInARX");
//END_REGION

//REGION Dialog Molotov Check 

IF 
ObjectFlagSet("ARX_Barracks_WhiteMagisterVault_WhiteMagister_CheckGrenades",_Magister,_ID)
AND
CharacterGetItemTemplateCount((CHARACTERGUID)_Magister,"GRN_Grenade_Molotov_A_5208b121-64fa-4704-8924-c61c576e1ac5",_Count)
AND
_Count > 0
THEN
ObjectSetFlag(_Magister,"ARX_Barracks_WhiteMagisterVault_WhiteMagister_HasGrenades");


//END_REGION

//REGION Move Evidence Container 
IF
CharacterMovedItem(_Player,_Item)
AND
DB_ARX_Barracks_WhiteMagisterVault_Evidence(_,_Item)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Item,"ARX_Barracks_WhiteMagisterVault_EvidenceContainterMoved");



//END_REGION 

//REGION Attacking A Gheist
IF 
ObjectEnteredCombat((CHARACTERGUID)_Enemy,_) 
AND 
DB_ARX_Barracks_WhiteMagisterVault_Gheists(_Enemy) 
AND 
QueryOnlyOnce("ARX_CombatSave_Reimond") 
THEN 
AutoSave();


IF
AttackedByObject(_Gheist,_Player,_Summon,_,_)
AND
DB_ARX_Barracks_WhiteMagisterVault_Gheists(_Gheist)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterIsInCombat((CHARACTERGUID)_Gheist,0)
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0)
THEN
SetStoryEvent(_Player,"ARX_Barracks_WhiteMagisterVault_PlayerAttacked");
// CharacterCharacterSetEvent(_Player,_Gheist,"ARX_Barracks_WhiteMagisterVault_PlayerAttackedGheist"); Call Doesn't Exist http://gojira:8082/browse/DOSTWO-10859
CharacterLookAt(_Gheist,_Player);
CharacterLookAt(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Gheist);

IF
AttackedByObject(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player,_Summon,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterIsInCombat((CHARACTERGUID)S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0)
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0)
THEN
SetStoryEvent(_Player,"ARX_Barracks_WhiteMagisterVault_PlayerAttacked");


IF
AttackedByObject(_Gheist,_Player,_Summon,_,_)
AND
DB_ARX_Barracks_WhiteMagisterVault_Gheists(_Gheist)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterIsInCombat((CHARACTERGUID)_Gheist,0)
AND
CharacterIsDead(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1)
THEN
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Gheist,(CHARACTERGUID)_Player,0);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,(CHARACTERGUID)_Gheist,0);

//END_REGION

//REGION Secret Passgae To Archives

IF
CharacterMovedItem(_Player,S_ARX_Barracks_WhiteMagisterVault_SecretLightSource_4be966f0-9bea-4cdc-9fd7-edae2e0763f2)
AND
GlobalGetFlag("S_ARX_Barracks_WhiteMagisterVault_SecretPassageIsOpen",0)
THEN
SetStoryEvent(S_ARX_Barracks_WhiteMagisterVault_SecretPressurePlate_034cffee-0691-476e-89ab-1253af3e9a24,"RevealFromStory");

IF
CharacterItemEvent(_Player,S_ARX_Barracks_WhiteMagisterVault_SecretPressurePlate_034cffee-0691-476e-89ab-1253af3e9a24,"S_ARX_Barracks_WhiteMagisterVault_MoveSecretWall")
AND
GlobalGetFlag("S_ARX_Barracks_WhiteMagisterVault_SecretPassageIsOpen",0)
AND
DB_IsPlayer(_Players)
AND
ObjectIsInTrigger(_Players,S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,1)
AND
QueryOnlyOnce("S_ARX_Barracks_WhiteMagisterVault_MoveSecretWall")
THEN
SetStoryEvent(S_ARX_Barracks_WhiteMagisterVault_SecretPressurePlate_034cffee-0691-476e-89ab-1253af3e9a24,"RevealFromStory");
ItemOpen(ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9);
//proc_ItemMoveToTrigger(S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9,S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_MoveTo_d2442ee8-ff02-42c9-85c0-ed9ecc88bcec,2.0,0.0,0);
ItemSetCanInteract(S_ARX_Barracks_WhiteMagisterVault_ToArchives_3345cde5-07ef-4361-b9fb-388d623b1aac,1);
GlobalSetFlag("S_ARX_Barracks_WhiteMagisterVault_SecretPassageIsOpen");

IF
CharacterUsedItem(_Player,S_ARX_Barracks_2ndFloor_Archives_To2ndFloorVault_37aad082-c021-4f96-b28a-513fe6a882bf)
THEN
ItemSetForceSynch(ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9,0);

IF
CharacterUsedItem(_Player,S_ARX_Barracks_2ndFloor_Archives_To2ndFloorVault_37aad082-c021-4f96-b28a-513fe6a882bf)
AND
GlobalGetFlag("S_ARX_Barracks_WhiteMagisterVault_SecretPassageIsOpen",0)
AND
ItemIsLocked(S_ARX_Barracks_2ndFloor_Archives_To2ndFloorVault_37aad082-c021-4f96-b28a-513fe6a882bf,0)
THEN
SetStoryEvent(S_ARX_Barracks_WhiteMagisterVault_SecretPressurePlate_034cffee-0691-476e-89ab-1253af3e9a24,"RevealFromStory");
ItemOpen(ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9);
//proc_ItemMoveToTrigger(S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_1c0aa312-009b-40ba-a92f-3457f48c53a9,S_ARX_Barracks_WhiteMagisterVault_SecretWallPassage_MoveTo_d2442ee8-ff02-42c9-85c0-ed9ecc88bcec,2.0,0.0,0);
ItemSetCanInteract(S_ARX_Barracks_WhiteMagisterVault_ToArchives_3345cde5-07ef-4361-b9fb-388d623b1aac,1);
GlobalSetFlag("S_ARX_Barracks_WhiteMagisterVault_SecretPassageIsOpen");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Barracks_2ndFloor_Archives_TreasureRoom_320e38f2-03d9-4a52-b9fc-6177e3a5bedf)
AND
DB_IsPlayer(_Player)
THEN
UnlockSecretRegion(TRIGGERGUID_S_ARX_Barracks_2ndFloor_Archives_TreasureRoom_320e38f2-03d9-4a52-b9fc-6177e3a5bedf);
//END_REGION

//REGION Burnt Evidence Spawn
IF
ObjectFlagSet("ARX_Barracks_WhiteMagisterVault_EvidenceContainer_Burnt",_Container,_ID)
AND
DB_ARX_Barracks_WhiteMagisterVault_Evidence(_Evidence,_Container)
AND
DB_ARX_Barracks_WhiteMagisterVault_BurntEvidence(_Container,_BurnedEvidence)
AND
GetInventoryOwner((ITEMGUID)_Evidence,_Container)
THEN
SetOnStage(_Evidence,0);
SetOnStage(_BurnedEvidence,1);

IF
ObjectFlagSet("ARX_Barracks_WhiteMagisterVault_EvidenceContainer_Burnt",_Container,_ID)
AND
NOT DB_GlobalFlag("ARX_Barracks_WhiteMagisterVault_EvidenceContainer_Burnt")
THEN
GlobalSetFlag("ARX_Barracks_WhiteMagisterVault_EvidenceContainer_Burnt"); //This is for Reimond's Dialog to react to the fact that the evdie

/*
IF
ObjectFlagSet("ARX_Barracks_WhiteMagisterVault_EvidenceContainer_Burnt",_Container,_ID)
THEN
PlayEffect(_Container,"RS3_FX_Skills_Fire_Impact_01");
Transform(_Container,"COR_AshPile_A_Big_dae08ec5-b004-4ac0-88d4-ba50e6e0038a",0);
*/
//END_REGION

//REGION Reading The Book

IF
GameBookInterfaceClosed(S_ARX_Barracks_WhiteMagisterVault_ReimondsJournal_aeb8cffd-a213-4279-931c-3f73967efa4f,_Player)
THEN
UserSetFlag(_Player,"ARX_Barracks_PlayerKnows_WhiteMagisterTruth");

IF
ObjectFlagSet("ARX_Barracks_PlayerKnows_WhiteMagisterTruth",(CHARACTERGUID)_Player,_)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_LearnedWhiteMagisterSecret");
PartySetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_DefeatedReimond"); 
UserSetFlag(_Player,"QuestUpdate_CORE_Chapter6_ARX_DallisToTomb");


// Giving ReportedKemmDead even if Kemm is still alive when he has reached a spot where he's not helpful for the player anymore
// (ReportedKemmDead doesn't actually mentions that Kemm is dead, it just avoids saying that we should report to Kemm)
IF
GameBookInterfaceClosed(S_ARX_Barracks_WhiteMagisterVault_ReimondsJournal_aeb8cffd-a213-4279-931c-3f73967efa4f,_Player)
AND
NOT QRY_ARX_KemmIsDeadOrUnspeakable()
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemm");

IF
GameBookInterfaceClosed(S_ARX_Barracks_WhiteMagisterVault_ReimondsJournal_aeb8cffd-a213-4279-931c-3f73967efa4f,_Player)
AND
QRY_ARX_KemmIsDeadOrUnspeakable()
AND
UserGetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemm",0)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemmDead");

//Closing the Situation if Kemm is dead

IF
ObjectFlagSet("ARX_Kemm_Party_SawKemmDead",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
QuestAccepted(_Player,"ARX_Barracks",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemm",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_Barracks_LearnedWhiteMagisterSecret",1)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemmDead");

IF
ObjectFlagSet("ARX_Kemm_Party_SawKemmDead",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"ARX_KnowsAbout_KemmInvestigation",1)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_KemmAtBarracks_Dead");

IF
ObjectFlagSet("ARX_KnowsAbout_KemmInvestigation",(CHARACTERGUID)_Player,_)
AND
ObjectGetFlag(_Player,"ARX_Kemm_Party_SawKemmDead",1)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_KemmAtBarracks_Dead");

IF
ObjectFlagSet("QuestUpdate_ARX_Barracks_LearnedWhiteMagisterSecret",(CHARACTERGUID)_Player,_)
AND
ObjectGetFlag(_Player,"ARX_Kemm_Party_SawKemmDead",1)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_ReportedKemmDead");

QRY
QRY_ARX_KemmIsDeadOrUnspeakable()
AND
DB_Dead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
DB_NOOP(1);

QRY
QRY_ARX_KemmIsDeadOrUnspeakable()
AND
DB_GlobalFlag("ARX_Cathedral_DisapArhu_KemmAppeared")
THEN
DB_NOOP(1);

QRY
QRY_ARX_KemmIsDeadOrUnspeakable()
AND
DB_GlobalFlag("ARX_KemmVault_ArhusPrison_KemmAppeared")
THEN
DB_NOOP(1);

QRY
QRY_ARX_KemmIsDeadOrUnspeakable()
AND
DB_GlobalFlag("ARX_InitiateGenocide")
THEN
DB_NOOP(1);


//END_REGION

//REGION Reimond Starts Dialog

IF
CharacterEnteredTrigger(_Player,S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15)
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_Barracks_VisitedHQ");

IF
CharacterEnteredTrigger(_Player,S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15)
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("ARX_AD_Barracks_WhiteMagisterVault_EnteredVault")
THEN
Proc_StartDialog(1,"ARX_AD_Barracks_WhiteMagisterVault_EnteredVault",_Player);

IF
CharacterCharacterEvent(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player,"ARX_Barracks_WhiteMagisterVault_WhiteMagister_SpottedPlayer")
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
THEN
DialogRequestStop(_Player);
Proc_StartDialog(0,"ARX_Barracks_WhiteMagisterVault_WhiteMagister",S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player);

IF
DialogStarted("ARX_Barracks_WhiteMagisterVault_WhiteMagister",_ID)
THEN
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagister(_ID);

IF
DialogStarted("ARX_Barracks_WhiteMagisterVault_WhiteMagister",_ID)
AND
DB_IsPlayer(_Player)
AND
NOT DB_DialogPlayers(_ID,_Player,_)
AND
CharacterCanSee(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player,1)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DialogAddActor(_ID,_Player);

IF
DialogEnded("ARX_Barracks_WhiteMagisterVault_WhiteMagister",_ID)
AND
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagister(_ID)
THEN
NOT DB_ARX_Barracks_WhiteMagisterVault_WhiteMagister(_ID);


IF
CharacterStoleItem(_Player,_Item,_X,_Y,_Z,_Victim,_SrcContainer,_)
AND
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagister(_ID)
AND
CharacterCanSee(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player,1)
THEN
ProcForceStopDialog(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
Proc_StartDialog(1,"GEB_AD_AttackHelp",S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);

IF
CharacterMovedItem(_Player,_Item)
AND
DB_ARX_Barracks_WhiteMagisterVault_WhiteMagister(_ID)
AND
CharacterCanSee(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player,1)
THEN
ProcForceStopDialog(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);
Proc_StartDialog(1,"GEB_AD_AttackHelp",S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7);

IF
CharacterCharacterEvent(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Summon,"ARX_Barracks_WhiteMagisterVault_WhiteMagister_SpottedPlayer")
AND
QRY_IsSummonOrPartyFollower(_Summon)
AND
CharacterGetOwner(_Summon,_Player)
THEN
CharacterSetRelationIndivFactionToIndivFaction(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,(CHARACTERGUID)_Player,0);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,0);
SetStoryEvent(_Player,"ARX_Barracks_WhiteMagisterVault_PlayerAttacked");


IF
DialogEnded("ARX_Barracks_WhiteMagisterVault_WhiteMagister",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
UserSetFlag((CHARACTERGUID)_Player,"ARX_Barracks_WhiteMagisterVault_WhiteMagister");
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_NPC,(CHARACTERGUID)_Player,0);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,(CHARACTERGUID)_NPC,0);

IF
TextEventSet("StelFromReimond")
AND
DB_IsPlayer(_Player)
THEN
MoveAllItemsTo(CHARACTERGUID_S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_Player);

//END_REGION

//REGION Reimond Suicides 

IF
ObjectFlagSet("ARX_Barracks_WhiteMagisterVault_CastSuicideSkill",CHARACTERGUID_S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_)
AND
GetPosition(CHARACTERGUID_S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_X,_Y,_Z)
THEN
CharacterUseSkillAtPosition(CHARACTERGUID_S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,"Projectile_Grenade_Molotov",_X,_Y,_Z,0,1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
