Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,"RC_DF_Troll_Marg");
DB_Dialogs(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_Grog");
DB_Ghosts(CHARACTERGUID_S_RC_DF_TrollBridge_Skeleton_8c143f3e-f925-445c-8f60-e243e2c61e56,CHARACTERGUID_S_RC_DF_TrollBridge_Ghost_332856d2-76d2-4f30-a21b-448d748a448a,"RC_DF_Troll_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_BF_TrollBridge_DeadTraveler_e74471f3-60bd-4bab-b905-b40ff2d0a536,CHARACTERGUID_S_RC_BF_TrollBridge_DeadTraveler_Ghost_2c53217a-bb29-4c63-bb17-dd5532013c00,"RC_BF_Troll_TravelerGhost");
DB_CrimeWarningIsAD("RC_DF_AD_Troll_Attack");

DB_RC_DF_Trolls((CHARACTERGUID)CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97,"RC_DF_TrollBridge_Marg","RC_DF_Troll_PaidMarg");
DB_RC_DF_Trolls((CHARACTERGUID)CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_TrespassBox_30d149d4-4b39-4371-82ae-7fc135e99da2,"RC_DF_TrollBridge_Grog","RC_DF_Troll_PaidGrog");
DB_RC_DF_Troll_Trespass((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97,"RC_DF_Troll_CameFromFields",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_FieldPoint_3e63edac-5e2f-4054-b068-089228037295);
DB_RC_DF_Troll_Trespass((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97,"RC_DF_Troll_CameFromForest",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ForestPoint_d299d07b-9d2d-48bf-8eae-43746b8a50a3);
DB_RC_DF_Troll_Trespass((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_TrespassBox_30d149d4-4b39-4371-82ae-7fc135e99da2,"RC_DF_Troll_CameFromHills",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_HillPoint_01fa7607-7efa-471e-8929-034800e37581);
DB_RC_DF_Troll_Trespass((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_TrespassBox_30d149d4-4b39-4371-82ae-7fc135e99da2,"RC_DF_Troll_CameFromForest",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ForestPoint_c733c7a4-f4da-4a19-bf2b-fdc7ce6dff31);
DB_RC_DF_Troll_SpotEvent((CHARACTERGUID)CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,"RC_DF_Troll_MargSpotPlayer","RC_DF_Troll_MargRestartSpot",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_SpotBox_79bc1400-bb45-4ac3-b05e-741caf7dfc88);
DB_RC_DF_Troll_SpotEvent((CHARACTERGUID)CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogSpotPlayer","RC_DF_Troll_GrogRestartSpot",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_SpotBox_ee51e505-329f-4d01-90ab-0a0ff2406301);
DB_RC_DF_Troll_PaidFlag((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,"RC_DF_Troll_PaidMarg");
DB_RC_DF_Troll_PaidFlag((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585,"RC_DF_Troll_PaidGrog");
DB_RC_DF_Troll_Trigger((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_FieldBox_3573bd5a-add2-4348-9e25-b6456df4f678,"RC_DF_Troll_CameFromFields");
DB_RC_DF_Troll_Trigger((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ForestBox_223114cc-a411-4ca7-b83e-e8601d5d5192,"RC_DF_Troll_CameFromForest");
DB_RC_DF_Troll_Trigger((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_HillBox_555c5cac-fb2f-49d7-b4c0-21edc1313e4b,"RC_DF_Troll_CameFromHills");
DB_RC_DF_Troll_Trigger((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ForestBox_779d7eb0-20fa-4500-82d9-f241e9118e8a,"RC_DF_Troll_CameFromForest");
DB_RC_DF_Troll_DefaultTeleport((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_FieldPoint_3e63edac-5e2f-4054-b068-089228037295);
DB_RC_DF_Troll_DefaultTeleport((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_TrespassBox_30d149d4-4b39-4371-82ae-7fc135e99da2,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_HillPoint_01fa7607-7efa-471e-8929-034800e37581);


ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_TrespassBox_30d149d4-4b39-4371-82ae-7fc135e99da2);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_HillBox_555c5cac-fb2f-49d7-b4c0-21edc1313e4b);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ForestBox_779d7eb0-20fa-4500-82d9-f241e9118e8a);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_FieldBox_3573bd5a-add2-4348-9e25-b6456df4f678);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ForestBox_223114cc-a411-4ca7-b83e-e8601d5d5192);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DF_Troll_Bridge_TreeTrunk_Box_5195308d-d2ae-463c-86f0-e708c1ca0bda);

TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938);

DB_DeadEvent(CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,"RC_DF_Troll_MargIsDead");
DB_DeadEvent(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogIsDead");


//REGION--- Tolls
// Marg's
DB_DialogMoneyTransfer(1,"RC_DF_Troll_Marg",1); //RC_DF_Troll_PayMarg_Small //GEN_CheckMagicPocketGold_6057ad05-9492-4630-9f0a-be548b134c54
DB_DialogMoneyTransfer(2,"RC_DF_Troll_Marg",3); //RC_DF_Troll_PayMarg_Big //GEN_CheckMagicPocketGold_2_463b0f43-5410-412d-aba3-875cf81c38ca
DB_DialogMoneyTransfer(3,"RC_DF_Troll_Marg",14999); //RC_DF_Troll_PayMarg_Huge //GEN_CheckMagicPocketGold_3_01f129ea-b4dc-44b6-8154-9a948f876a82
// Grog's
DB_DialogMoneyTransfer(1,"RC_DF_Troll_Grog",4999); //RC_DF_Troll_PayGrog_Lower //GEN_CheckMagicPocketGold_6057ad05-9492-4630-9f0a-be548b134c54
DB_DialogMoneyTransfer(2,"RC_DF_Troll_Grog",5000); //RC_DF_Troll_PayGrog_Big //GEN_CheckMagicPocketGold_2_463b0f43-5410-412d-aba3-875cf81c38ca
DB_DialogMoneyTransfer(3,"RC_DF_Troll_Grog",15000); //RC_DF_Troll_PayGrog_Huge //GEN_CheckMagicPocketGold_3_01f129ea-b4dc-44b6-8154-9a948f876a82

DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayGrog_Lower",1);
DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayGrog_Big",2);
DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayGrog_Huge",3);
DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayMarg_Small",1);
DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayMarg_Big",2);
DB_ItemEvents_TransferFlagToMoneyVarIndex("RC_DF_Troll_PayMarg_Huge",3);
//END_REGION

Proc_RC_DF_Troll_SetupCrimes();
TeleportTo(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_Point_e350fab4-6cab-4a47-bd5a-1f55e8900fe4);

//DB_Troll_Journal_MainSub(_Init,_Main,_Sub);
DB_Troll_Journal_MainSub("QuestUpdate_RC_DF_TrollBridge_CompetitionRemoved","QuestUpdate_RC_DF_TrollBridge_CompetitionRemovedMain","QuestUpdate_RC_DF_TrollBridge_CompetitionRemovedSub");
DB_Troll_Journal_MainSub("QuestUpdate_RC_DF_TrollBridge_GrogMoved","QuestUpdate_RC_DF_TrollBridge_GrogMovedMain","QuestUpdate_RC_DF_TrollBridge_GrogMovedSub");
DB_Troll_Journal_MainSub("QuestUpdate_RC_DF_TrollBridge_GrogIsDead","QuestUpdate_RC_DF_TrollBridge_GrogIsDeadMain","QuestUpdate_RC_DF_TrollBridge_GrogIsDeadSub");
KBSECTION
//REGION Debug

IF
TextEventSet("TrollGiveVWFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"FTJ_SW_HeardVoidWokenSpeak");
UserSetFlag(_Player,"QuestUpdate_RC_DU_HeroicRescue_KilledVoidwoken");
UserSetFlag(_Player,"QuestUpdate_RC_DW_WC_AtaraxianLair_KilledBoss");
GlobalSetFlag("FTJ_FinalBattle_VoidwokenAppeared");


//END_REGION

//REGION Adding either Sub or Main entries

IF
ObjectFlagSet("QuestUpdate_RC_DF_TrollBridge_CounterOffer",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_RemoveCompetition",1)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_RemoveCompetitionSub");

IF
ObjectFlagSet(_Init,(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
DB_Troll_Journal_MainSub(_Init,_Main,_Sub)
AND
UserGetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_CounterOffer",0)
THEN
UserSetFlag(_Player,_Main);

IF
ObjectFlagSet(_Init,(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
DB_Troll_Journal_MainSub(_Init,_Main,_Sub)
AND
UserGetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_CounterOffer",1)
THEN
UserSetFlag(_Player,_Sub);

//END_REGION

//REGION Trolls die

//--- Marg
IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,1)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_CompetitionRemoved");
UserSetFlag(_Player,"RC_DF_Troll_HeardAboutMarg");

IF
CharacterDied(CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_RC_DF_Troll_Marg_33b7d3f0-436a-4520-a073-dd2862122b0e,1)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_CompetitionRemoved");
UserSetFlag(_Player,"RC_DF_Troll_HeardAboutMarg");

//--- Grog
IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938)
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,1)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_GrogIsDead");

IF
CharacterDied(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,1)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_GrogIsDead");


//--- Both
IF
ObjectFlagSet("QuestUpdate_RC_DF_TrollBridge_GrogIsDead",_Player,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_CompetitionRemoved",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_AllDead");

IF
ObjectFlagSet("QuestUpdate_RC_DF_TrollBridge_CompetitionRemoved",_Player,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_GrogIsDead",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DF_TrollBridge_AllDead");

//END_REGION


//REGION Trespass flag

IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_RC_DF_Troll_Trespass(_Trigger,_,_)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_,_)
AND
NOT Qry_RC_DF_Troll_PlayerPaid(_Troll,_Player)
THEN
ObjectSetFlag(_Player,"RC_DF_Troll_IsTrespassing");

IF
CharacterLeftTrigger(_Player,_Trigger)
AND
DB_RC_DF_Troll_Trespass(_Trigger,_,_)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_,_)
AND
NOT Qry_RC_DF_Troll_PlayerPaid(_Troll,_Player)
THEN
ObjectClearFlag(_Player,"RC_DF_Troll_IsTrespassing");

IF
DialogEnded("RC_DF_Troll_Marg",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
ObjectClearFlag(_Player,"RC_DF_Troll_IsTrespassing");

IF
DialogEnded("RC_DF_Troll_Grog",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
ObjectClearFlag(_Player,"RC_DF_Troll_IsTrespassing");

//END_REGION


//REGION Tree trunk

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DF_Troll_Bridge_TreeTrunk_Box_5195308d-d2ae-463c-86f0-e708c1ca0bda)
THEN
Proc_RC_DF_Troll_SeeTreeTrunk(_Player);

PROC
Proc_RC_DF_Troll_SeeTreeTrunk((CHARACTERGUID)_Player)
AND
UserGetFlag(_Player,"RC_DF_Troll_SawTreeTrunk",0)
THEN
Proc_StartDialog(1,"RC_DF_AD_Troll_SpotTrunk",_Player);
UserSetFlag(_Player,"RC_DF_Troll_SawTreeTrunk");

//END_REGION


//REGION Moving Grog + give skill

IF
ObjectFlagSet("RC_DF_Troll_LearnGrogsSkill",_Player,_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
CharacterAddSkill((CHARACTERGUID)_Player,"Shout_ReactiveArmor"); //the skill is given in ARX too, if it changes here, change it in ARX_Outskirts_Misc too



//--- Update and move
IF
ObjectFlagSet("QuestUpdate_RC_DF_TrollBridge_GrogMoved",_Player,_)
AND
QueryOnlyOnce("DB_RC_DF_Troll_MoveGrog")
THEN
DB_RC_DF_Troll_MoveGrog(1);

IF
DialogEnded("RC_DF_Troll_Grog",_)
AND
DB_RC_DF_Troll_MoveGrog(1)
THEN
NOT DB_RC_DF_Troll_MoveGrog(1);
Proc_StartDialog(1,"RC_DF_AD_Troll_MoveToBridge",CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938);
ObjectSetFlag(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogStopSpot");
CharacterDisableCrime(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_TrollBridge_Grog");
Proc_RC_DF_Troll_TransferBridge();
Proc_RC_DF_Troll_Grog_SetNewOriginalPos();
SetHasDialog(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,0);
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_Point_71e752f4-370a-41cc-9fb9-671b2289635b,0,"RC_DF_Troll_GrogMoved");
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938);
TriggerUnregisterForCharacter(TRIGGERGUID_S_RC_DF_Troll_Bridge_WreckedHills_ControlBox_c0d073ff-1eea-4b93-812e-4d9b5e1e2585,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938);

PROC
Proc_RC_DF_Troll_Grog_SetNewOriginalPos()
AND
GetPosition(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_Point_71e752f4-370a-41cc-9fb9-671b2289635b,_X,_Y,_Z)
THEN
SetVarFloat3(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"NPCOrgPos",_X,_Y,_Z);
SetVarFloat3(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"DefaultPoint",_X,_Y,_Z);
SetVarObject(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"DefaultPointTrigger",TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_Point_71e752f4-370a-41cc-9fb9-671b2289635b);
SetVarObject(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"WanderTrigger",TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_WanderBox_96689818-ae4d-41e8-9b65-358c88e024c6);

//--- Deleting previous DB
PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_RC_DF_Trolls(_,_TrespassTri,_Crime,_PaidFlag)
AND
DB_IsPlayer(_Player)
THEN
CharacterStopCrime(_Player,_Crime,_TrespassTri);

PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_RC_DF_Trolls(_Troll,_TrespassTri,_Crime,_PaidFlag)
THEN
NOT DB_RC_DF_Trolls(_Troll,_TrespassTri,_Crime,_PaidFlag);

PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_RC_DF_Troll_PaidFlag(_ControlTri,_Flag)
THEN
NOT DB_RC_DF_Troll_PaidFlag(_ControlTri,_Flag);

PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_RC_DF_Troll_SpotEvent(_Troll,_SpotEvent,_RestartSpotEvent,_SpotBox)
THEN
NOT DB_RC_DF_Troll_SpotEvent(_Troll,_SpotEvent,_RestartSpotEvent,_SpotBox);

PROC
Proc_RC_DF_Troll_TransferBridge()
THEN
DB_RC_DF_Trolls((CHARACTERGUID)CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_TrespassBox_125289ae-12b5-40e5-94e7-ce33b9d18f97,"RC_DF_TrollBridge_Grog","RC_DF_Troll_PaidGrog");
DB_RC_DF_Troll_PaidFlag((TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_ControlBox_dec3e360-4f07-4c8b-936b-47ee164c6d27,"RC_DF_Troll_PaidGrog");
DB_RC_DF_Troll_SpotEvent((CHARACTERGUID)CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogSpotPlayer","RC_DF_Troll_GrogRestartSpot",(TRIGGERGUID)TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_SpotBox_79bc1400-bb45-4ac3-b05e-741caf7dfc88);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DF_Troll_Bridge_FieldsWest_SpotBox_79bc1400-bb45-4ac3-b05e-741caf7dfc88,CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938);

PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_IsPlayer(_Player)
THEN
UserClearFlag(_Player,"RC_DF_Troll_PaidGrog",0);

PROC
Proc_RC_DF_Troll_TransferBridge()
AND
DB_IsPlayer(_Player)
THEN
ObjectClearFlag(_Player,"RC_DF_Troll_FailedGrogPersuasion",0);


IF
StoryEvent(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogMoved")
THEN
SetHasDialog(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,1);
SetVarObject(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"WanderTrigger",S_RC_DF_Troll_Bridge_FieldsWest_WanderBox_96689818-ae4d-41e8-9b65-358c88e024c6);
SetVarObject(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"SpotTrigger",S_RC_DF_Troll_Bridge_FieldsWest_SpotBox_79bc1400-bb45-4ac3-b05e-741caf7dfc88);
ObjectSetFlag(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogAtMargsBridge");
ObjectSetFlag(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogRestartSpot");
Proc_RC_DF_Troll_SetupCrimes();
ObjectClearFlag(CHARACTERGUID_S_GLO_Troll_Grog_9671dad5-258d-4174-84c0-0141502b2938,"RC_DF_Troll_GrogStopSpot");

//END_REGION


//REGION Spot player event

IF
CharacterCharacterEvent(_Troll,_Player,_Event)
AND
DB_RC_DF_Troll_SpotEvent(_Troll,_Event,_Restart,_)
THEN
Proc_RC_DF_Troll_StartDialog(_Troll,_Player,_Restart);

PROC
Proc_RC_DF_Troll_StartDialog((CHARACTERGUID)_Troll,(CHARACTERGUID)_Player,(STRING)_Restart)
AND
ObjectGetFlag(_Troll,"RC_DF_Troll_NotOnBridge",0)
AND
NOT Qry_RC_DF_Troll_PlayerPaid(_Troll,_Player)
AND
IsSpeakerReserved(_Troll,0)
AND
DB_Dialogs(_Troll,_Dialog)
THEN
Proc_StartDialog(0,_Dialog,_Troll,_Player);

PROC
Proc_RC_DF_Troll_StartDialog((CHARACTERGUID)_Troll,(CHARACTERGUID)_Player,(STRING)_Restart)
THEN
ObjectSetFlag(_Troll,_Restart);

QRY
Qry_RC_DF_Troll_PlayerPaid((CHARACTERGUID)_Troll,(CHARACTERGUID)_Player)
AND
DB_RC_DF_Trolls(_Troll,_,_,_PlaidFlag)
AND
ObjectGetFlag(_Player,_PlaidFlag,1)
THEN
DB_NOOP(1);

//END_REGION


//REGION Out of bridge troll flag

IF
CharacterLeftTrigger(_Troll,_ControlTrigger)
AND
DB_RC_DF_Trolls(_Troll,_,_,_PaidFlag)
AND
DB_RC_DF_Troll_PaidFlag(_ControlTrigger,_PaidFlag)
THEN
ObjectSetFlag(_Troll,"RC_DF_Troll_NotOnBridge");

IF
CharacterEnteredTrigger(_Troll,_ControlTrigger)
AND
DB_RC_DF_Trolls(_Troll,_,_,_PaidFlag)
AND
DB_RC_DF_Troll_PaidFlag(_ControlTrigger,_PaidFlag)
THEN
ObjectClearFlag(_Troll,"RC_DF_Troll_NotOnBridge");


//END_REGION


//REGION Teleport player

IF
ObjectFlagSet("RC_DF_Troll_TeleportPlayerOut",(CHARACTERGUID)_Player,_Inst)
THEN
Proc_RC_DF_Troll_SetTeleportAfterDialog(_Player,_Inst);


PROC
Proc_RC_DF_Troll_SetTeleportAfterDialog((CHARACTERGUID)_Player,(INTEGER)_Inst)
AND
DB_DialogNPCs(_Inst,_Troll,1)
AND
DB_RC_DF_Trolls((CHARACTERGUID)_Troll,_TrespassBox,_,_)
AND
Qry_RC_DF_Troll_GetTeleportSide(_TrespassBox,_Player,_Inst) //ObjectGetFlag(_Player,_SideFlag,1)
THEN
DB_NOOP(1); //DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_Inst,_Point);


QRY
Qry_RC_DF_Troll_GetTeleportSide((TRIGGERGUID)_TrespassBox,(CHARACTERGUID)_Player,(INTEGER)_DialogInst)
AND
DB_RC_DF_Troll_Trespass(_TrespassBox,_SideFlag,_Point)
AND
ObjectGetFlag(_Player,_SideFlag,1)
THEN
DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_DialogInst,_Point);


PROC
Proc_RC_DF_Troll_SetTeleportAfterDialog((CHARACTERGUID)_Player,(INTEGER)_Inst)
AND
DB_DialogNPCs(_Inst,_Troll,1)
AND
DB_RC_DF_Trolls((CHARACTERGUID)_Troll,_TrespassBox,_,_)
AND
NOT DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_Inst,_)
AND
DB_RC_DF_Troll_DefaultTeleport(_TrespassBox,_DefaultPoint)
THEN
DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_Inst,_DefaultPoint);


PROC
Proc_RC_DF_Troll_SetTeleportAfterDialog((CHARACTERGUID)_Player,(INTEGER)_Inst)
THEN
ObjectClearFlag(_Player,"RC_DF_Troll_TeleportPlayerOut");


IF
DialogEnded(_,_Inst)
AND
DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_Inst,_Point)
THEN
NOT DB_RC_DF_Troll_TeleportPlayerAfterDialog(_Player,_Inst,_Point);
TeleportTo(_Player,_Point,"",1);


//END_REGION


//REGION Crossing bridge

IF
CharacterEnteredTrigger(_Player,_ControlTri)
AND
DB_RC_DF_Troll_Trigger(_ControlTri,_SideTri,_Flag)
AND
DB_InRegion(_Player,_SideTri)
THEN
ObjectSetFlag(_Player,_Flag);


IF
CharacterLeftTrigger(_Player,_ControlTri)
AND
DB_RC_DF_Troll_Trigger(_ControlTri,_SideTri,_)
AND
DB_InRegion(_Player,_SideTri)
THEN
Proc_RC_DF_Troll_CheckIfCrossedBridge(_Player,_ControlTri,_SideTri);
Proc_RC_DF_Troll_ClearFlag(_Player);


PROC
Proc_RC_DF_Troll_CheckIfCrossedBridge((CHARACTERGUID)_Player,(TRIGGERGUID)_ControlTri,(TRIGGERGUID)_SideTri)
AND
Qry_RC_DF_Troll_CameFromOtherSide(_Player,_ControlTri,_SideTri)
AND
DB_RC_DF_Troll_PaidFlag(_ControlTri,_PaidFlag)
AND
ObjectGetFlag(_Player,_PaidFlag,0)
AND
DB_RC_DF_Trolls(_Troll,_,_,_PaidFlag)
THEN
Proc_CharacterSetTemporaryHostileRelation(_Troll,_Player); // crossed but didn't pay -> hostile troll


PROC
Proc_RC_DF_Troll_CheckIfCrossedBridge((CHARACTERGUID)_Player,(TRIGGERGUID)_ControlTri,(TRIGGERGUID)_SideTri)
AND
Qry_RC_DF_Troll_CameFromOtherSide(_Player,_ControlTri,_SideTri)
AND
DB_RC_DF_Troll_PaidFlag(_ControlTri,_PaidFlag)
AND
ObjectGetFlag(_Player,_PaidFlag,1)
THEN
ObjectClearFlag(_Player,_PaidFlag,0); //shouldn't be user


PROC
Proc_RC_DF_Troll_ClearFlag((CHARACTERGUID)_Player)
AND
DB_RC_DF_Troll_Trigger(_ControlTri,_,_Flag)
THEN
ObjectClearFlag(_Player,_Flag);


QRY
Qry_RC_DF_Troll_CameFromOtherSide((CHARACTERGUID)_Player,(TRIGGERGUID)_ControlTri,(TRIGGERGUID)_SideTri)
AND
DB_RC_DF_Troll_Trigger(_ControlTri,_OtherTri,_Flag)
AND
_SideTri != _OtherTri
AND
ObjectGetFlag(_Player,_Flag,1)
THEN
DB_NOOP(1);

//END_REGION


//REGION Custom crime

PROC
Proc_RC_DF_Troll_SetupCrimes()
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_Crime,_PaidFlag)
THEN
//ProcCharacterDisableAllCrimes(_Troll);
ProcCharacterEnableCrime(_Troll,_Crime);
ProcCharacterEnableCrime(_Troll,"Assault");


IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_Crime,_PaidFlag)
AND
CharacterIsPlayer(_Player,1)
AND
IsTagged(_Player,"SUMMON",0)
AND
UserGetFlag(_Player,_PaidFlag,0)
THEN
CharacterRegisterCrime(_Player,_Crime,_Trigger,_Troll,0);

IF
CharacterLeftTrigger(_Player,_Trigger)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_Crime,_PaidFlag)
AND
CharacterIsPlayer(_Player,1)
THEN
CharacterStopCrime(_Player,_Crime,_Trigger);

IF
ObjectFlagSet(_PaidFlag,(CHARACTERGUID)_Player,_)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_Crime,_PaidFlag)
THEN
CharacterStopCrime(_Player,_Crime,_Trigger);


IF
CharacterSelectedAsBestUnavailableFallbackLead(_NPC,_RegionID,_CrimeID,_BusyCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
CrimeGetType(_CrimeID,_Crime)
AND
DB_RC_DF_Trolls(_Troll,_Trigger,_Crime,_PaidFlag)
AND
NOT Qry_RC_DF_Troll_UserPaid(_Criminal1,_Criminal2,_Criminal3,_Criminal4,_PaidFlag)
THEN
ProcCrimeTrespassingCheckDetection(_CrimeID,_NPC,_Criminal1);
ProcCrimeTrespassingCheckDetection(_CrimeID,_NPC,_Criminal2);
ProcCrimeTrespassingCheckDetection(_CrimeID,_NPC,_Criminal3);
ProcCrimeTrespassingCheckDetection(_CrimeID,_NPC,_Criminal4);
ProcCrimeTrespassingStopNPCsDialogAndMakeHostileTo(_CrimeID,_BusyCrimeID,_NPC);


QRY
Qry_RC_DF_Troll_UserPaid((CHARACTERGUID)_Criminal1,(CHARACTERGUID)_C2,(CHARACTERGUID)_C3,(CHARACTERGUID)_C4,(STRING)_PaidFlag)
AND
NOT QRY_CharacterIsNull(_Criminal1)
AND
UserGetFlag(_Criminal1,_PaidFlag,1)
THEN
DB_NOOP(1);

QRY
Qry_RC_DF_Troll_UserPaid((CHARACTERGUID)_C1,(CHARACTERGUID)_Criminal2,(CHARACTERGUID)_C3,(CHARACTERGUID)_C4,(STRING)_PaidFlag)
AND
NOT QRY_CharacterIsNull(_Criminal2)
AND
UserGetFlag(_Criminal2,_PaidFlag,1)
THEN
DB_NOOP(1);

QRY
Qry_RC_DF_Troll_UserPaid((CHARACTERGUID)_C1,(CHARACTERGUID)_C2,(CHARACTERGUID)_Criminal3,(CHARACTERGUID)_C4,(STRING)_PaidFlag)
AND
NOT QRY_CharacterIsNull(_Criminal3)
AND
UserGetFlag(_Criminal3,_PaidFlag,1)
THEN
DB_NOOP(1);

QRY
Qry_RC_DF_Troll_UserPaid((CHARACTERGUID)_C1,(CHARACTERGUID)_C2,(CHARACTERGUID)_C3,(CHARACTERGUID)_Criminal4,(STRING)_PaidFlag)
AND
NOT QRY_CharacterIsNull(_Criminal4)
AND
UserGetFlag(_Criminal4,_PaidFlag,1)
THEN
DB_NOOP(1);




//END_REGION


PROC
ProcRegionEnded("RC_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
