Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
IF
ObjectSourcePointAddRequest((CHARACTERGUID)_Player,_AddSP,_WasSP)
AND
DB_IsPlayer(_Player)
AND
CharacterGetEquippedItem(_Player,"Amulet",_Item)
AND
GetTemplate(_Item,"QUEST_ARX_SourceAmulet_86c59384-3686-4594-b485-507caed669a5")
AND
CharacterGetMaxSourcePoints(_Player,_MaxSP)
AND
_MaxSP == _WasSP
THEN
Proc_HandleSourceAmulet(_Player,(ITEMGUID)_Item,(INTEGER)_AddSP);

PROC
Proc_HandleSourceAmulet((CHARACTERGUID)_Player,(ITEMGUID)_Item,(INTEGER)_Amount)
AND
ObjectGetFlag(_Item,"GLO_SourceAmuletIsFull",1)
THEN
Proc_StartDialog(1,"GLO_AD_SourceAmulet_IsFull",_Player);

PROC
Proc_HandleSourceAmulet((CHARACTERGUID)_Player,(ITEMGUID)_Item,(INTEGER)_Amount)
AND
ObjectGetFlag(_Item,"GLO_SourceAmuletIsFull",0)
THEN
proc_SourceAmulet_AddSource((ITEMGUID)_Item,_Amount,_Player);


//REGION Used Charge
IF
CharacterUsedSkill(_Player,"Target_Item_ReplenishSource",_,_)
AND
DB_IsPlayer(_Player)
AND
CharacterGetEquippedItem(_Player,"Amulet",_Item)
AND
GetTemplate(_Item,"QUEST_ARX_SourceAmulet_86c59384-3686-4594-b485-507caed669a5")
THEN
procUsedCharge(_Player,(ITEMGUID)_Item);

PROC
procUsedCharge((CHARACTERGUID)_Player,(ITEMGUID)_Item)
THEN
proc_SourceAmulet_AddSource((ITEMGUID)_Item,0,_Player);


PROC
procUsedCharge((CHARACTERGUID)_Player,(ITEMGUID)_Item)
AND
QueryOnlyOnce("Target_Item_ReplenishSource_FirstTime")
THEN
Proc_StartDialog(1,"GLO_AD_SourceAmulet_UsedCharge",_Player);
//END_REGION

//REGION AddSource
PROC
proc_SourceAmulet_AddSource((ITEMGUID)_Item,(INTEGER)_Amount)
THEN
proc_SourceAmulet_AddSource(_Item,_Amount,NULL_00000000-0000-0000-0000-000000000000);


PROC
proc_SourceAmulet_AddSource((ITEMGUID)_Item,(INTEGER)_Amount,(CHARACTERGUID)_Player)
AND
NOT DB_GLO_AD_SourceAmulet_AddedCharge_Feedback_OnlyOnce(_Player)
AND
_Amount > 0
AND
ItemGetCharges(_Item,_CurrentCharges)
AND
_CurrentCharges < 5
THEN
DB_GLO_AD_SourceAmulet_AddedCharge_Feedback_OnlyOnce(_Player);
Proc_StartDialog(1,"GLO_AD_SourceAmulet_AddedCharge",_Player);

PROC
proc_SourceAmulet_AddSource((ITEMGUID)_Item,(INTEGER)_Amount,(CHARACTERGUID)_Player)
AND
_Amount > 0
AND
ItemGetCharges(_Item,5)
THEN
ObjectSetFlag(_Item,"GLO_SourceAmuletIsFull");
Proc_StartDialog(1,"GLO_AD_SourceAmulet_IsFull",_Player);
ProcReplenishedAmulet(_Player);

PROC
ProcReplenishedAmulet((CHARACTERGUID)_Char)
THEN
DB_NOOP(1);

PROC
proc_SourceAmulet_AddSource((ITEMGUID)_Item,(INTEGER)_Amount,(CHARACTERGUID)_)
AND
ItemGetCharges(_Item,_CurrentCharges)
AND
_CurrentCharges < 5
AND
ObjectGetFlag(_Item,"GLO_SourceAmuletIsFull",1)
THEN
ObjectClearFlag(_Item,"GLO_SourceAmuletIsFull",0);
//END_REGION

//REGION Debug
IF
TextEventSet("GLO_Show_DebugNumberOfCharges")
AND
DB_IsPlayer(_Player)
AND
CharacterGetEquippedItem(_Player,"Amulet",(ITEMGUID)_Item)
AND
GetTemplate(_Item,"QUEST_ARX_SourceAmulet_86c59384-3686-4594-b485-507caed669a5")
AND
ItemGetCharges(_Item,_CurrentCharges)
AND
IntegertoString(_CurrentCharges,_CurrentChargesString)
THEN
DebugText(_Player,_CurrentChargesString);

IF
TextEventSet("GLO_AddSourcePoints")
AND
DB_IsPlayer(_Player)
AND
CharacterGetEquippedItem(_Player,"Amulet",_Item)
AND
GetTemplate(_Item,"QUEST_ARX_SourceAmulet_86c59384-3686-4594-b485-507caed669a5")
THEN
Proc_HandleSourceAmulet(_Player,(ITEMGUID)_Item,5);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
