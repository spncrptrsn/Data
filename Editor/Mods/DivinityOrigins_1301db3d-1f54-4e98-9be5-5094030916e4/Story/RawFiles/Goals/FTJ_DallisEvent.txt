Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_HasStoryEvent((ITEMGUID)RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,"FTJ_HasFlorenceLeg");
DB_GiveItemToEvent(RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,"FTJ_FlorenceLegToDog");
DB_GiveItemToEvent(RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,"FTJ_FlorenceLegToKniles");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_DallisGheistKnockback_Poly_b76b52e8-b2cd-4021-ba2f-5bae9d4233e8);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_DallisEventAutoEnd_Poly_c66c0ceb-84d0-42f2-af77-854d178a58d5);

DB_FTJ_DallisGheist((CHARACTERGUID)S_FTJ_DallisGheist_001_fa573f6f-7af3-40da-bc9a-e7d984711b09,(TRIGGERGUID)S_FTJ_GheistKnockdown_Point_001_f96b6d3f-40c4-46ff-8a1f-d04d9118c107);
DB_FTJ_DallisGheist(S_FTJ_DallisGheist_002_5aff71df-ec52-41cc-9b28-fb6b491a15c4,S_FTJ_GheistKnockdown_Point_002_3fe7a7f6-4091-4324-b93e-84af7f14fdca);
CrimeAreaSetTensionModifier(TRIGGERGUID_S_FTJ_CrimeRegion_DallsScene_6e23e5d6-4dae-405f-9364-0fe332e9d440,4);
Proc_FTJ_DallisEventStart();

//Atusa Loot
ItemTemplateAddTo("CON_Potion_A_Health_Large_68b40462-247a-44fd-87d0-c2eea2f49ed1",S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1);
ItemTemplateAddTo("GRN_Grenade_Molotov_A_5208b121-64fa-4704-8924-c61c576e1ac5",S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1);
ItemTemplateAddTo("Scroll_Skill_Source_Resurrect_60180909-ee47-4d1c-b81c-e43bd8fdce1e",S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1);

//Scene Manager
DB_SceneManager((CHARACTERGUID)GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,"FTJ_DallasStartScene");
DB_SceneManager((CHARACTERGUID)RC_FTJ_DallisGheist_001_fa573f6f-7af3-40da-bc9a-e7d984711b09,"FTJ_DallasStartScene");
DB_SceneManager((CHARACTERGUID)RC_FTJ_DallisGheist_002_5aff71df-ec52-41cc-9b28-fb6b491a15c4,"FTJ_DallasStartScene");
DB_SceneManager((CHARACTERGUID)GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_DallasStartScene");
DB_SceneManager((CHARACTERGUID)S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,"FTJ_DallasStartScene");
DB_SceneTriggerManager("FTJ_DallasStartScene",(TRIGGERGUID)S_FTJ_DallisGheistKnockback_Poly_b76b52e8-b2cd-4021-ba2f-5bae9d4233e8);
DB_DoNotFace(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
DB_DoNotFace(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338);
DB_DoNotFace(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
KBSECTION
//REGION Dallis Purge Atusa Event
//https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/fortjoy---dallis-purging-florence
PROC 
Proc_FTJ_DallisEventStart()
THEN
ProcCharacterDisableAllCrimes(GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
ProcCharacterDisableAllCrimes(RC_FTJ_DallisGheist_001_fa573f6f-7af3-40da-bc9a-e7d984711b09);
ProcCharacterDisableAllCrimes(RC_FTJ_DallisGheist_002_5aff71df-ec52-41cc-9b28-fb6b491a15c4);
ProcCharacterDisableAllCrimes(GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
DB_IsNotMessingAround(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
DB_IsNotMessingAround(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
DB_IsNotMessingAround(CHARACTERGUID_S_FTJ_DallisGheist_002_5aff71df-ec52-41cc-9b28-fb6b491a15c4);
DB_IsNotMessingAround(CHARACTERGUID_S_FTJ_DallisGheist_001_fa573f6f-7af3-40da-bc9a-e7d984711b09);
DB_IsNotMessingAround(S_FTJ_GhettoGuard_001_ee5789f4-9320-493f-8fa1-a4ec1b8177f2);
DB_IsNotMessingAround(S_FTJ_GhettoGuard_002_098c299c-a7a1-4857-9ab5-fb01849a68ae);
DB_IsNotMessingAround(S_FTJ_GhettoGuard_003_7db795c9-9e63-40ab-a2f9-21b46fdb0c74);
DB_IsNotMessingAround(S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8);
CharacterSetImmortal(S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,1);
CharacterSetImmortal(S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,1);
SetOnStage(RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,0);

//Because Alexandar is the only character to maintain his collar outside act 1, give him special rule here
PROC 
Proc_FTJ_DallisEventStart()
THEN
PROC_LoopEffect("RS3_FX_GP_Status_HoECollar_01",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_SourceCollar","FJ_FortJoy_Main","Dummy_NeckFX");
ApplyStatus(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"SOURCE_MUTED",-1.0,1);

//REGION DOS2EE-1077 enable undead crimes during scenes for dallis

IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_StartDallisEvent")
AND
IsTagged(_Player,"UNDEAD",1)
AND
IsTagged(_Player,"VEILED_UNDEAD",0)
AND
IsTagged(_Player,"MASKED_UNDEAD",0)
AND
QueryOnlyOnce("FTJ_StartDallisEvent_OneShot")
THEN
LeaveCombat(_Player);
Proc_StartDialog(0,"GEB_Attack_Undead",GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,_Player);


PROC
Proc_SceneOver("FTJ_DallasStartScene")
THEN
SetTag(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,"IGNORE_UNDEAD_CRIME");
//END_REGION




IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_StartDallisEvent")
AND
QueryOnlyOnce("FTJ_StartDallisEvent_OneShot")
THEN
LeaveCombat(_Player);
Proc_StartDialog(0,"FTJ_DallisPurgeAtusa",GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,_Player);

IF 
DialogEnded("FTJ_DallisPurgeAtusa",_ID)
THEN
ProcForceStopDialog(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338);
ProcForceStopDialog(S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
ProcForceStopDialog(S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
NOT DB_DoNotFace(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);

IF
ObjectFlagSet("FTJ_KnowsAtusaHelpsEscape",(CHARACTERGUID)_Player,_)
AND
CharacterIsDead(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Escape_StartFlorence");

IF
CharacterUsedSkillOnTarget(S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,"Target_Quest_PurgeCharacter",_,_)
THEN
TimerLaunch("FTJ_DallisCastPurgeOnAtusa",1400); //Let's the Effect play and syncs the entire scene to the animation

IF
TimerFinished("FTJ_DallisCastPurgeOnAtusa")
THEN
GlobalSetFlag("FTJ_DallisCastPurgeOnAtusa");


//REGION
IF
CharacterDying(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
GlobalGetFlag("FTJ_DallisCastPurgeOnAtusa",1)
THEN
SetOnStage(RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,1);
ItemToInventory(RC_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9,CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338);

//END_REGION

IF
CharacterDying(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
GlobalGetFlag("FTJ_DallisCastPurgeOnAtusa",1)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1)
THEN
Proc_ShakeCameraForTime(_Player,850);

IF
GlobalFlagSet("FTJ_DallisGhettoEventEnd")
THEN
DB_RemoveIsNotMessingAround(CHARACTERGUID_S_FTJ_GhettoGuard_001_ee5789f4-9320-493f-8fa1-a4ec1b8177f2);
DB_RemoveIsNotMessingAround(CHARACTERGUID_S_FTJ_GhettoGuard_002_098c299c-a7a1-4857-9ab5-fb01849a68ae);
DB_RemoveIsNotMessingAround(CHARACTERGUID_S_FTJ_GhettoGuard_003_7db795c9-9e63-40ab-a2f9-21b46fdb0c74);
DB_RemoveIsNotMessingAround(CHARACTERGUID_S_FTJ_GhettoGuard_004_d11296d9-833f-4070-9fa7-44ac606aedb8);

IF
CharacterDying(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
CharacterIsInCombat(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,0)
AND
GlobalGetFlag("FTJ_DallisCastPurgeOnAtusa",1)
AND
GetClosestAlivePlayer(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,_Player,_Dist)
AND
_Dist < 15.0
THEN
ProcDefineReflectionDialog("FTJ_RD_AtusaDeath",_Player);

//REGION Atusa cuts tongue
IF
GlobalFlagSet("FTJ_AtusaCutsTongue")
AND
GetPosition(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,_X,_Y,_Z)
AND
RealSum(_Y,2.0,_NewY)
THEN
PlayAnimation(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,"hit");
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_FTJ_Florence_CutTongue_Blood_01",_X,_NewY,_Z);
TimerLaunch("FTJ_AtusaCutTongue",400);

IF
TimerFinished("FTJ_AtusaCutTongue")
THEN
CreateSurface(S_RC_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,"SurfaceBlood",0.1,-1.0);

//END_REGION

//END_REGION

//REGION Quest logs
IF
GlobalFlagSet("FTJ_DallisCastPurgeOnAtusa")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
GetDistanceTo(_Player,CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,_Dist)
AND
_Dist < 20.0
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_FlorenceEnd");
UserSetFlag(_Player,"QuestUpdate_FTJ_Seeker_AtusaEvent");


IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_player,"ELF",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_AtusaLimb");
UserSetFlag(_Player,"QuestUpdate_FTJ_Seeker_AtusaLimb");

IF
ObjectFlagSet("FTJ_Seeker_Unnis_SetMetFlag",(CHARACTERGUID)_Player,_)
AND
UserGetFlag(_Player,"QuestUpdate_FTJ_Escape_FlorenceEnd",0)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Seeker_UnnisMet");

IF
ObjectFlagSet("FTJ_Seeker_Unnis_SetMetFlag",(CHARACTERGUID)_Player,_)
AND
UserGetFlag(_Player,"QuestUpdate_FTJ_Escape_FlorenceEnd",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Seeker_UnnisMetAtusa");


//END_REGION

//Subdue Player
IF
ObjectFlagSet("FTJ_DallisSubduePlayer",(CHARACTERGUID)_Player,_)
THEN
PlayAnimation(S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,"skill_silence_cast");
PlayAnimation(_Player,"knockdown_fall");
ApplyStatus(_Player,"KNOCKED_DOWN",12.0,1);
PlayEffect(_Player,"RS3_FX_Skills_Air_FreeFall_Disappear_01");
PlayEffect(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,"RS3_FX_Skills_Air_FreeFall_Cast_01");

//REGION Gheist Knockdown
// ontriggerenter, get closest Gheist and knock the player back to their corresponding point trigger

IF 
CharacterEnteredTrigger((CHARACTERGUID)_Player,(TRIGGERGUID)S_FTJ_DallisGheistKnockback_Poly_b76b52e8-b2cd-4021-ba2f-5bae9d4233e8)
AND
DB_IsPlayer(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND 
DB_FTJ_DallisGheist(_Gheist,_Trigger)
AND 
DB_FTJ_DallisGheist(_OtherGheist,_OtherTrigger)
AND
_Gheist != _OtherGheist
AND
_Trigger != _OtherTrigger
AND
GetDistanceTo(_Gheist,_Player,_Dist)
AND
GetDistanceTo(_OtherGheist,_Player,_OtherDist)
AND
_Dist > _OtherDist
AND
CharacterCanSee(_OtherGheist,_Player,1)
AND
GlobalGetFlag("FTJ_FlorenceEventEnded",0)
AND
QRY_SpeakerIsAvailable(_OtherGheist)
THEN 
Proc_FTJ_GheistKnockBackPlayer(_Player,_OtherTrigger,_OtherGheist);

PROC
Proc_FTJ_GheistKnockBackPlayer((CHARACTERGUID)_Player,(TRIGGERGUID)_ToTrigger,(CHARACTERGUID)_Gheist)
THEN
CharacterPurgeQueue(_Gheist);
CharacterLookAt(_Gheist,_Player);
PlayAnimation(_Gheist,"skill_blitzbolt_cast");
RemoveStatus(_Player,"RESTED");
ApplyStatus(_Player,"KNOCKED_DOWN",1.5,1);
TeleportTo(_Player,_ToTrigger);
Proc_StartDialog(1,"FTJ_AD_GheistKnockbackPlayer",_Gheist);
PlayEffect(_Gheist,"RS3_FX_GP_ScriptedEvent_RadialBlowBack_01");


////END_REGION

IF
CharacterDied(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1)
THEN
ObjectSetFlag(_Player,"FTJ_KnowsAtusaIsDead");

IF
CharacterSawCharacter((CHARACTERGUID)_Player,CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,1)
THEN
UserSetFlag(_Player,"FTJ_KnowsAtusaIsDead");

//REGION Auto-End event

//Scene Interupted
PROC
Proc_SceneInterrupted(_,_,"FTJ_DallasStartScene",_Reason)
AND
DB_GLO_GenericSceneManager_LeavingReason(_Reason)
AND
DB_SceneManager(_NPC,"FTJ_DallasStartScene")
AND
_NPC != S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338
THEN
DB_OnlyOnce("FTJ_StartDallisEvent_OneShot");
DialogRequestStop(_NPC);
GlobalSetFlag("FTJ_ForceStartDallisPurge");
Proc_SceneOver("FTJ_DallasStartScene");

PROC
Proc_SceneInterrupted(_,_Player,"FTJ_DallasStartScene",_Reason)
AND
QRY_FTJDallisEvent_InterruptReasonAttackedOrCombat(_Reason)
AND
DB_SceneManager(_NPC,"FTJ_DallasStartScene")
THEN
DB_OnlyOnce("FTJ_StartDallisEvent_OneShot");
DialogRequestStop(_NPC);
DialogRequestStop(_Player);
GlobalSetFlag("FTJ_ForceStartDallisPurge");
Proc_SceneOver("FTJ_DallasStartScene");
ProcMakeNPCHostile((CHARACTERGUID)_NPC,_Player);

QRY
QRY_FTJDallisEvent_InterruptReasonAttackedOrCombat((STRING)_Reason)
AND
_Reason == "Attacked"
THEN
DB_NOOP(1);

QRY
QRY_FTJDallisEvent_InterruptReasonAttackedOrCombat((STRING)_Reason)
AND
_Reason == "EnteredCombat"
THEN
DB_NOOP(1);

IF
GlobalFlagSet("FTJ_FlorenceEventEnded")
THEN
Proc_SceneOver("FTJ_DallasStartScene");

PROC
Proc_FTJ_EscapedFortJoy((CHARACTERGUID)_Player)
AND
GlobalGetFlag("FTJ_FlorencePurgingEnd",0)
THEN
DB_OnlyOnce("FTJ_StartDallisEvent_OneShot");
DialogRequestStop(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
GlobalSetFlag("FTJ_ForceStartDallisPurge");


//If Atusa is Insta-killed
IF
CharacterDied(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338)
AND
GlobalGetFlag("FTJ_FlorencePurgingEnd",0)
THEN
GlobalSetFlag("FTJ_ForceStartDallisPurge");

IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_FTJ_DallisEventAutoEnd_Poly_c66c0ceb-84d0-42f2-af77-854d178a58d5)
THEN
Proc_FTJ_EscapedFortJoy(_Player);

PROC
Proc_FTJ_EscapedFortJoy(_Player)
AND
NOT DB_OncePerPlayerCharacter(_Player,"QuestUpdate_FTJ_Escape_EnterDunes")
THEN
CharacterSetRelationIndivFactionToFaction(_Player,"RC_Magister",0);
CharacterSetRelationFactionToIndivFaction("RC_Magister",_Player,0);
DB_OncePerPlayerCharacter(_Player,"QuestUpdate_FTJ_Escape_EnterDunes");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Escape_EnterDunes");

PROC
Proc_FTJ_EscapedFortJoy((CHARACTERGUID)_Origin)
AND
DB_OriginRecruitmentLocation(_Origin,_OldLocation)
AND
DB_OriginRecruitmentLocation_Region("__Shelter",_Origin,_NewLocation,_State)
THEN
DB_OriginRecruitmentLocation(_Origin,_NewLocation);
NOT DB_OriginRecruitmentLocation_Region("__Shelter",_Origin,_NewLocation,_State);
NOT DB_OriginRecruitmentLocation(_Origin,_OldLocation);
SetVarFixedString(_Origin,"currentState",_State);
ObjectSetFlag(_Origin,"FTJ_SW_InShelter");

//END_REGION

//REGION RD when the players escape Fort Joy

PROC
Proc_FTJ_EscapedFortJoy((CHARACTERGUID)_Player)
AND
QueryOnlyOnce("FTJ_SW_RD_EscapedFortJoy")
THEN
ProcDefineReflectionDialog("FTJ_SW_RD_EscapedFortJoy",_Player);

//END_REGION

IF
TextEventSet("stundallis")
THEN
ApplyStatus(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,"STUNNED",-1.0,1);


PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
CharacterSetForceUpdate(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,0);
GoalCompleted;


EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
