Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_OneShotPlayerTrigger(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_SeePrison_b5620f01-0e6d-4d9a-8f8a-f0492e4820e0);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_JournalUpdate_Box_d2bf13fb-f94c-4695-ba94-679cb7338cc8);
DB_DoNotFace(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
DB_Dialogs(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_KemmVault_Arhu");
DB_Ghosts(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,CHARACTERGUID_S_ARX_KemmVault_Arhu_Ghost_df7d4b26-51ab-4dd7-935f-66422f903e9b,"ARX_KemmVault_ArhuGhost");

CharacterSetCanTrade(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0);
ApplyStatus(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"GROUNDED",-1.0);
SetTag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"CHICKENTOUCH_IMMUNE");

//REGION arhu prison
DB_Ghosts(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_01_e9fcdbbc-d4c1-41cd-a3f4-fa79104e9f3c,"ARX_KemmVault_ArhusPrison_Source_01");
DB_Ghosts(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_02_4cd4055b-bf94-43c4-93b5-c0c2fac5e767,"ARX_KemmVault_ArhusPrison_Source_02");
DB_Ghosts(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_03_3f2200a1-88b2-4311-97c0-23ba089d4cfe,"ARX_KemmVault_ArhusPrison_Source_03");


//END_REGION
SetCanFight(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0);
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);

//REGION arhus prison
DB_KemmVault_ArhusPrison_Beam((CHARACTERGUID)CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_01_e9fcdbbc-d4c1-41cd-a3f4-fa79104e9f3c,"ARX_KemmVault_ArhusPrison_Source_01");
DB_KemmVault_ArhusPrison_Beam(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_02_4cd4055b-bf94-43c4-93b5-c0c2fac5e767,"ARX_KemmVault_ArhusPrison_Source_02");
DB_KemmVault_ArhusPrison_Beam(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_03_3f2200a1-88b2-4311-97c0-23ba089d4cfe,"ARX_KemmVault_ArhusPrison_Source_03");

DB_GhostIgnoreCower((CHARACTERGUID)CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_01_e9fcdbbc-d4c1-41cd-a3f4-fa79104e9f3c);
DB_GhostIgnoreCower(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_02_4cd4055b-bf94-43c4-93b5-c0c2fac5e767);
DB_GhostIgnoreCower(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_03_3f2200a1-88b2-4311-97c0-23ba089d4cfe);

DB_KemmVault_ArhusPrison_Horror((CHARACTERGUID)CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_01_e5da66e9-a385-48ef-a488-df463dfc7de5);
DB_KemmVault_ArhusPrison_Horror(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_02_9abc5e99-9ebe-4107-b561-691bad0c6cd7);
DB_KemmVault_ArhusPrison_Horror(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_03_8604e931-2d21-4f2e-b5f4-b27a9c12eff3);
DB_KemmVault_ArhusPrison_Horror(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_04_b5d345ea-7a93-4b3a-9f9b-9c6d666b6c01);

DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_01_e5da66e9-a385-48ef-a488-df463dfc7de5,"ARX_KemmVault_ArhusPrison");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_02_9abc5e99-9ebe-4107-b561-691bad0c6cd7,"ARX_KemmVault_ArhusPrison");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_03_8604e931-2d21-4f2e-b5f4-b27a9c12eff3,"ARX_KemmVault_ArhusPrison");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_04_b5d345ea-7a93-4b3a-9f9b-9c6d666b6c01,"ARX_KemmVault_ArhusPrison");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_KemmVault_ArhusPrison");
DB_KillCounter("ARX_KemmVault_ArhusPrison",5);

DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_01_e5da66e9-a385-48ef-a488-df463dfc7de5,"ARX_KemmVault_ArhusPrison_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_02_9abc5e99-9ebe-4107-b561-691bad0c6cd7,"ARX_KemmVault_ArhusPrison_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_03_8604e931-2d21-4f2e-b5f4-b27a9c12eff3,"ARX_KemmVault_ArhusPrison_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Horror_04_b5d345ea-7a93-4b3a-9f9b-9c6d666b6c01,"ARX_KemmVault_ArhusPrison_Fallback");
DB_KillCounter("ARX_KemmVault_ArhusPrison_Fallback",4);

//END_REGION
DB_DeadEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_KemmVault_Arhu_IsDead");
DB_DeadEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_IsDead");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97);
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Arhu_Binding_01",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"RS3_FX_GP_ScriptedEvent_Arhu_Binding_01","ARX_Main","");



DB_SourceFountains(ITEMGUID_S_ARX_KemmVault_SourceFountain_b24852de-de4e-4715-a21f-273fa27e0d09,TRIGGERGUID_S_ARX_KemmVault_SourceFountain_Point_4996654c-3bb1-4a18-8111-abecc25bf3d6);

DB_KilledEvent(CHARACTERGUID_S_ARX_Sewers_Q_52f20922-7b22-4d47-90f7-83172f21fe3b,"ARX_Sewers_Q_KilledIsbeil");


DB_KilledEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuPrison_KilledArhu");
DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_SeenDead_Arhu");
KBSECTION
//REGION
 
IF 
ObjectEnteredCombat((CHARACTERGUID)_Enemy,_) 
AND 
DB_KemmVault_ArhusPrison_Horror(_Enemy) 
AND 
QueryOnlyOnce("ARX_CombatSave_Kemm") 
THEN 
AutoSave();

IF
CharacterGhostRevealed(_,_Char)
AND
DB_KemmVault_ArhusPrison_Beam(_Char,_)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,_Char,1)
AND
QueryOnlyOnce("ARX_KemmVault_VB_ArhusPrison_SourceRevealed")
THEN
DB_ARX_KemmVault_VB_ArhusPrison_SourceRevealed(_Player);
TimerLaunch("ARX_KemmVault_VB_ArhusPrison_SourceRevealed_Timer",2000);

IF
TimerFinished("ARX_KemmVault_VB_ArhusPrison_SourceRevealed_Timer")
AND
DB_ARX_KemmVault_VB_ArhusPrison_SourceRevealed(_Player)
THEN
NOT DB_ARX_KemmVault_VB_ArhusPrison_SourceRevealed(_Player);
StartVoiceBark("ARX_KemmVault_VB_ArhusPrison_SourceRevealed",_Player);
//END_REGION

//REGION ghost prison
IF
DB_KemmVault_ArhusPrison_Beam(_Char,_)
THEN
CharacterLookAt(_Char,CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1);
CharacterSetAnimationOverride(_Char,"skill_prepare_fire_01_loop");
DB_DoNotFace(_Char);

PROC
ProcOneShotTriggerEntered(_Char,TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_SeePrison_b5620f01-0e6d-4d9a-8f8a-f0492e4820e0)
THEN
StartVoiceBark("ARX_KemmVault_VB_ArhusPrison",_Char);


IF
CharacterUsedSkillOnTarget(_Player,(CHARACTERGUID)_Char,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
AND
DB_KemmVault_ArhusPrison_Beam(_Char,_)
THEN
DB_ARX_KemmVault_Arhu_InPain_QueueDialog(_Player);
ProcForceStopDialog(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
Proc_StartDialog(1,"ARX_KemmVault_AD_Arhu_InPain",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);

IF
TextEventSet("arhupris")
AND
DB_KemmVault_ArhusPrison_Beam(_Char,_)
THEN
DestroyGhost(_Char);

IF
CharacterGhostDestroyed(_,_Char)
AND
DB_KemmVault_ArhusPrison_Beam(_Char,_Id)
THEN
PROC_StopLoopBeamEffect(_Char,_Id);
NOT DB_KemmVault_ArhusPrison_Beam(_Char,_Id);
Proc_KemmVault_ArhusPrison_CheckIfPrisonBroken();
Proc_KemmVault_ArhusPrison_DealDamage();

PROC
Proc_KemmVault_ArhusPrison_DealDamage()
AND
GetVarFloat(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"maxVitality",_Vitality)
AND
RealDivide(_Vitality,3.5,_DamageAmount)
AND
Integer(_DamageAmount,_DamageAmountInt)
THEN
ApplyDamage(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,_DamageAmountInt,"Shadow");

IF
AutomatedDialogEnded("ARX_KemmVault_AD_Arhu_InPain",_)
AND
DB_ARX_KemmVault_Arhu_InPain_QueueDialog(_Player)
AND
DB_ARX_KemmVault_Arhu_InPainDialog(1)
AND
NOT DB_ARX_KemmVault_Arhu_InPainDialog(2)
THEN
ProcForceStopDialog(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
NOT DB_ARX_KemmVault_Arhu_InPainDialog(1);
DB_ARX_KemmVault_Arhu_InPainDialog(2);
GlobalClearFlag("ARX_KemmVault_Arhu_InPainDialog");
GlobalSetFlag("ARX_KemmVault_Arhu_InPainDialog_Second");
Proc_StartDialog(0,"ARX_KemmVault_Arhu",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,_Player);
NOT DB_ARX_KemmVault_Arhu_InPain_QueueDialog(_Player);

IF
AutomatedDialogEnded("ARX_KemmVault_AD_Arhu_InPain",_)
AND
DB_ARX_KemmVault_Arhu_InPain_QueueDialog(_Player)
AND
NOT DB_ARX_KemmVault_Arhu_InPainDialog(_)
THEN
ProcForceStopDialog(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
DB_ARX_KemmVault_Arhu_InPainDialog(1);
GlobalSetFlag("ARX_KemmVault_Arhu_InPainDialog");
Proc_StartDialog(0,"ARX_KemmVault_Arhu",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,_Player);
ObjectSetFlag(_Player,"QuestUpdate_ARX_KemmVault_ArhuPrison_BrokeChain");
NOT DB_ARX_KemmVault_Arhu_InPain_QueueDialog(_Player);

IF
DB_KemmVault_ArhusPrison_Horror(_Char)
THEN
SetOnStage(_Char,0);

IF
DB_KemmVault_ArhusPrison_Beam(_Char,_Id)
AND
NOT DB_KemmVault_ArhusPrison_Beam_Once(_Char)
THEN
DB_KemmVault_ArhusPrison_Beam_Once(_Char);
PROC_LoopBeamEffect("RS3_FX_GP_Beams_Ataraxian_Green_01",_Char,CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"Dummy_L_HandFX","",_Id,"ARX_Main");

PROC
Proc_KemmVault_ArhusPrison_CheckIfPrisonBroken()
THEN
NOT DB_KemmVault_ArhusPrison_CheckIfPrisonBroken(0);

PROC
Proc_KemmVault_ArhusPrison_CheckIfPrisonBroken()
AND
DB_KemmVault_ArhusPrison_Beam(_,_)
THEN
DB_KemmVault_ArhusPrison_CheckIfPrisonBroken(0);

PROC
Proc_KemmVault_ArhusPrison_CheckIfPrisonBroken()
AND
NOT DB_KemmVault_ArhusPrison_CheckIfPrisonBroken(0)
THEN
Proc_KemmVault_ArhusPrison_PrisonBroken();
GlobalSetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken");
RemoveStatus(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"GROUNDED");
ClearTag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"CHICKENTOUCH_IMMUNE");
PROC_StopLoopEffect(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"RS3_FX_GP_ScriptedEvent_Arhu_Binding_01");
NOT DB_DoNotFace(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);


PROC
Proc_KemmVault_ArhusPrison_PrisonBroken()
AND
DB_KemmVault_ArhusPrison_Horror(_Char)
THEN
CharacterAppear(_Char,1,"");
PlayEffect(_Char,"RS3_FX_Skills_Void_Netherswap_Reappear_01");

PROC
Proc_KemmVault_ArhusPrison_PrisonBroken()
AND
DB_IsPlayer(_Char)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_KemmVault_ArhuPrison_Ambush");

PROC
Proc_KemmVault_ArhusPrison_PrisonBroken()
AND
CharacterIsDead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0)
THEN
Proc_StartDialog(1,"ARX_KemmVault_AD_Arhu_CombatStarted",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);

PROC
Proc_KemmVault_ArhusPrison_PrisonBroken()
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
DB_IsPlayer(_Char)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
THEN
ObjectSetFlag(_Char,"ARX_KemmVault_KemmDiedBeforeCombat");

PROC
ReactOnKillCounter("ARX_KemmVault_ArhusPrison_Fallback")
AND
DB_IsPlayer(_Char)
AND
ObjectGetFlag(_Char,"ARX_KemmVault_KemmDiedBeforeCombat",1)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_KemmVault_ArhuPrison_KemmAlreadyDead");

IF
CharacterDied(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken",0)
AND
DB_KemmVault_ArhusPrison_Beam(_Char,_Id)
THEN
Proc_GhostHacks_GhostPoof(_Char);
PROC_StopLoopBeamEffect(_Char,_Id);
NOT DB_KemmVault_ArhusPrison_Beam(_Char,_Id);
Proc_KemmVault_ArhusPrison_CheckIfPrisonBroken();

IF
ObjectTurnStarted((CHARACTERGUID)_Char)
AND
DB_KemmVault_ArhusPrison_Horror(_Char)
AND
QueryOnlyOnce("ARX_KemmVault_AD_ArhusPrison_Horror")
THEN
Proc_StartDialog(1,"ARX_KemmVault_AD_ArhusPrison_Horror",_Char);
//END_REGION

//REGION kemm appearance
IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_Combat)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
DB_KemmVault_ArhusPrison_Horror(_Char)
AND
DB_IsPlayer(_Player)
AND
CombatGetIDForCharacter(_Player,_Combat)
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_InitiateCombatCounter")
THEN
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,0,_Combat);
Proc_ARX_KemmVault_ArhusPrison_SetKemm();

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_Combat)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
DB_IsPlayer(_Player)
AND
DB_KemmVault_ArhusPrison_Horror(_Char)
AND
CombatGetIDForCharacter(_Char,_Combat)
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_InitiateCombatCounter")
THEN
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,0,_Combat);
Proc_ARX_KemmVault_ArhusPrison_SetKemm();

IF
ItemTemplateAddedToCharacter(WPN_UNIQUE_ARX_KemmsShield_0e42ad67-661f-4e3a-9ff2-f97a838a4b7b,_Item,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
CharacterEquipItem(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Item);

IF
ObjectTurnEnded((CHARACTERGUID)_Char)
AND
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_OtherChar,_Count,_Combat)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
CombatGetIDForCharacter(_Char,_Combat)
THEN
Proc_ARX_KemmVault_ArhusPrison_CombatCounter();

IF
CharacterKilledBy(_Defender,_AttackerOwner,_Attacker)
AND
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Defender,_Count,_Combat)
AND
IntegerSum(_Count,1,_newCount)
AND
CombatGetIDForCharacter(_Defender,_newCombat)
THEN
NOT DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Defender,_Count,_Combat);
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_AttackerOwner,_newCount,_newCombat);

PROC
Proc_ARX_KemmVault_ArhusPrison_CombatCounter()
AND
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,_Count,_Combat)
AND
_Count >= 2
AND
QueryOnlyOnce("Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance")
THEN
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance();
NOT DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,_Count,_Combat);

PROC
Proc_ARX_KemmVault_ArhusPrison_CombatCounter()
AND
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,_Count,_Combat)
AND
_Count < 2
AND
IntegerSum(_Count,1,_newCount)
THEN
NOT DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,_Count,_Combat);
DB_ARX_KemmVault_ArhusPrison_CombatCounter(_Char,_newCount,_Combat);

PROC
ReactOnKillCounter("ARX_KemmVault_ArhusPrison_Fallback")
AND
QueryOnlyOnce("Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance")
THEN
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance();

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance()
THEN
CharacterSetCanTrade(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance()
AND
QRY_AnyRegionActive()
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
THEN
SetCombatGroupID(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"3f34eaa1-5fe9-4e40-b381-1e98d1010c77");
GlobalSetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared");
CharacterSetFightMode(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1,1);
TeleportTo(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,TRIGGERGUID_S_ARX_KemmVault_FinalFloor_EntPoint_6a724f9b-b7f3-459f-92a2-2fb126395601);
SetOnStage(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
CharacterMoveTo(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_KemmMoveTo_b568775a-918b-48ea-99d1-43935f646ac5,0,"ARX_KemmVault_ArhusPrison_KemmAppeared_Windego",0);
SetFaction(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"Evil NPC");

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance()
AND
QRY_AnyRegionActive()
AND
DB_KemmVault_ArhusPrison_Horror(_Char)
THEN
EnterCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Char);
NOT DB_KemmVault_ArhusPrison_Horror(_Char);

IF
CombatStarted(_Id)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PlayerDeath_Appeared",0)
AND
CombatGetActiveEntity(_Id,(CHARACTERGUID)_Char)
AND
NOT DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_)
THEN
DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char);

IF
CombatStarted(_Id)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_KemmsAppearance_JumpToTurn")
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PlayerDeath_Appeared",0)
THEN
JumpToTurn(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog();

IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PlayerDeath_Appeared",0)
AND
CombatGetActiveEntity(_Id,(CHARACTERGUID)_Char)
AND
NOT DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_)
THEN
DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char);

IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Combat)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_KemmsAppearance_JumpToTurn")
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PlayerDeath_Appeared",0)
THEN
JumpToTurn(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog();

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
THEN
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(4,NULL_00000000-0000-0000-0000-000000000000);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(5,NULL_00000000-0000-0000-0000-000000000000);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(6,NULL_00000000-0000-0000-0000-000000000000);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
DB_IsPlayer(_Char)
AND
CombatGetIDForCharacter(_Char,_Id)
AND
IsTagged(_Char,"AVATAR",1)
AND
IsTagged(_Char,"PROMISED",1)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,_Char);
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(3);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
DB_IsPlayer(_Char)
AND
CombatGetIDForCharacter(_Char,_Id)
AND
IsTagged(_Char,"AVATAR",1)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,_Char);
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(3);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Id)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
DB_IsPlayer(_Char)
AND
CharacterIsDead(_Char,0)
AND
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(_,_Char)
AND
CombatGetIDForCharacter(_Char,_Id)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(_Count)
AND
IntegerSum(_Count,1,_NewCount)
THEN
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(_NewCount,_Char);
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(_NewCount,NULL_00000000-0000-0000-0000-000000000000);
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(_Count);
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(_NewCount);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,_Speaker1)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(4,_Speaker2)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(5,_Speaker3)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(6,_Speaker4)
AND
StartDialog_Internal("ARX_KemmVault_ArhusPrison_Kemm",1,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_)
THEN
SetStoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"SetCombatTimeout");

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
NOT DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(3,_Speaker1)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(4,_Speaker2)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(5,_Speaker3)
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Speaker(6,_Speaker4)
AND
StartDialog_Internal("ARX_KemmVault_ArhusPrison_Kemm",1,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,NULL_00000000-0000-0000-0000-000000000000,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_)
THEN
SetStoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"SetCombatTimeout");

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsDialog()
AND
DB_ARX_KemmVault_ArhusPrison_KemmsDialog_Count(2)
THEN
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath();



IF
ObjectTurnEnded(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char)
THEN
Proc_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity();

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity()
AND
DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_id)
AND
CombatGetIDForCharacter(_Char,_id)
THEN
JumpToTurn(_Char);

PROC
Proc_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity()
AND
DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char)
THEN
NOT DB_ARX_KemmVault_ArhusPrison_KemmAppeared_ActiveEntity(_Char);

//END_REGION

//REGION post kemm
PROC
ReactOnKillCounter("ARX_KemmVault_ArhusPrison")
THEN
DB_Queue("ARX_KemmVault_ArhusPrison_Dialog");
Proc_ARX_KemmVault_ArhusPrison_PostKemm();

PROC
Proc_ARX_KemmVault_ArhusPrison_PostKemm()
THEN
GlobalSetFlag("ARX_KemmVault_Arhu_Freed_OnceCongrats");
GlobalClearFlag("ARX_KemmVault_Arhu_Fainted");
GlobalSetFlag("ARX_KemmVault_Arhu_Freed");
SetStoryEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ClearAnimationOverride");
SetVarInteger(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"FleeFromDangerousSurface",1);
SetCanFight(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1);
ProcCharacterEnableAllCrimes(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
GlobalSetFlag("ARX_KemmVault_Arhu_InitiateSpotter");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_JournalUpdate_Box_d2bf13fb-f94c-4695-ba94-679cb7338cc8);

IF
StoryEvent(_Char,"ARX_KemmVault_Arhu_SpottedChar")
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
THEN
Proc_StartDialog(0,"ARX_KemmVault_Arhu",CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,_Char);
GlobalSetFlag("ARX_KemmVault_Arhu_StopSpotter");
NOT DB_Queue("ARX_KemmVault_ArhusPrison_Dialog");

IF
DialogStarted("ARX_KemmVault_Arhu",_)
AND
DB_Queue("ARX_KemmVault_ArhusPrison_Dialog")
THEN
GlobalSetFlag("ARX_KemmVault_Arhu_StopSpotter");
NOT DB_Queue("ARX_KemmVault_ArhusPrison_Dialog");

IF
DialogEnded("ARX_KemmVault_Arhu",_)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_ToTheCathedral",1)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
THEN
GlobalClearFlag("ARX_KemmVault_Arhu_ToTheCathedral");
SetHasDialog(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0);
CharacterDisappearOutOfSightToObject(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,ITEMGUID_S_ARX_KemmVault_FinalFloor_Ext_305e609e-b8c5-4631-a956-c245e7cfdbfe,0,"ARX_KemmVault_Arhu_Disappeared",0);
ClearTag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"AI_UNPREFERRED_TARGET");
GlobalSetFlag("ARX_KemmVault_Arhu_StopSpotter");
NOT DB_Queue("ARX_KemmVault_ArhusPrison_Dialog");

IF
StoryEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_KemmVault_Arhu_Disappeared")
THEN
CharacterAppearOutOfSightTo(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,TRIGGERGUID_S_ARX_Cathedral_ArhuPosition_f3ca4512-7c29-40d0-b60a-84adbf696e80,0,0,"ARX_KemmVault_Arhu_Appeared");
GlobalSetFlag("ARX_KemmVault_Arhu_InCathedral");
CharacterSetCanTrade(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1);

IF
StoryEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_KemmVault_Arhu_Appeared")
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,TRIGGERGUID_S_ARX_Cathedral_ArhuPosition_f3ca4512-7c29-40d0-b60a-84adbf696e80,0,"ARX_Arhu_ArrivedInCathedral");

//END_REGION

//REGION Arhus death

IF
CharacterLeftTrigger(_,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
QRY_AnyRegionActive()
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken",1)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
AND
NOT DB_InRegion(_,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
THEN
//CharacterDie(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0,"DoT");
CharacterDisappearOutOfSightToObject(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,ITEMGUID_S_ARX_KemmVault_FinalFloor_Ext_305e609e-b8c5-4631-a956-c245e7cfdbfe,0,"ARX_KemmVault_Arhu_Disappeared",0);
ClearTag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"AI_UNPREFERRED_TARGET");

IF
CharacterLeftTrigger(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
AND
NOT DB_InRegion(_,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
QueryOnlyOnce("Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance")
THEN
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance();

IF
CharacterDied(_Char)
AND
DB_IsPlayer(_Char)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
THEN
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath();

PROC
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath()
THEN
NOT DB_ARX_KemmVault_ArhusPrison_AliveChar(1);

PROC
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath()
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
AND
CharacterIsDead(_Char,0)
THEN
DB_ARX_KemmVault_ArhusPrison_AliveChar(1);

PROC
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath()
AND
NOT DB_ARX_KemmVault_ArhusPrison_AliveChar(1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
QueryOnlyOnce("Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance")
THEN
GlobalSetFlag("ARX_KemmVault_ArhusPrison_PlayerDeath_Appeared");
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance();


PROC
Proc_ARX_KemmVault_ArhusPrison_PlayerDeath()
AND
NOT DB_ARX_KemmVault_ArhusPrison_AliveChar(1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0)
THEN
CharacterAttack(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
DB_ARX_KemmVault_ArhusPrison_OneHitKill(1);

IF
AttackedByObject(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_,_,_)
AND
DB_ARX_KemmVault_ArhusPrison_OneHitKill(1)
THEN
CharacterDie(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,0,"DoT");
//END_REGION

//REGION quest updates

IF
CharacterDied(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
DB_IsPlayer(_Char)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_03_0a0bfbfb-1a85-4acf-9d71-f0db7c9dca97)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_KemmVault_ArhuPrison_KemmDefeat");

//--- Finding Arhu while he's still alive and captive
IF
CharacterEnteredTrigger(_Player, TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_JournalUpdate_Box_d2bf13fb-f94c-4695-ba94-679cb7338cc8)
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b)
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_Freed")
THEN
UserSetFlag(_Player, "QuestUpdate_ARX_KemmVault_ArhuPrison_OnSight");
UserSetFlag(_Player, "QuestUpdate_ARX_DisappearanceOfArhu_ArhuPrison_FoundArhu"); 
UserSetFlag(_Player, "ARX_KemmVault_SawArhu");

// removing the VB trigger (in case the player used a jump skill and went over it)
IF
CharacterEnteredTrigger(_, TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_JournalUpdate_Box_d2bf13fb-f94c-4695-ba94-679cb7338cc8)
THEN
RemoveOneShotTrigger(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_SeePrison_b5620f01-0e6d-4d9a-8f8a-f0492e4820e0);

// unregistering the triggers (in case the player kills Arhu from a distance in the vault)
IF
CharacterDied(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b)
THEN
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_JournalUpdate_Box_d2bf13fb-f94c-4695-ba94-679cb7338cc8);
RemoveOneShotTrigger(TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_SeePrison_b5620f01-0e6d-4d9a-8f8a-f0492e4820e0);

//END_REGION

IF
TextEventSet("doomdest")
AND
DB_IsPlayer(_Char)
THEN
UserSetFlag(_Char,"ARX_Sewers_DoomsdayDevice_Destroy");

IF
TextEventSet("doomsea")
AND
DB_IsPlayer(_Char)
THEN
UserSetFlag(_Char,"ARX_Sewers_DoomsdayDevice_ToSea");

//REGION


PROC
Proc_ARX_KemmVault_ArhusPrison_KemmsAppearance()
AND
QRY_AnyRegionActive()
AND
GlobalGetFlag("ARX_KemmVault_Windego_Wounded",1)
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0)
AND
NOT DB_ARX_KemmVault_Kemm_KillWindego(_)
AND
QueryOnlyOnce("ARX_KemmVault_Windego_Wounded_Disappear")
AND
GetPosition(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_X,_Y,_Z)
THEN
ProcForceStopDialog(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
PlayEffectAtPosition("RS3_FX_Skills_Void_Netherswap_Disappear_Root_01",_X,_Y,_Z);
SetOnStage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0);

IF
ObjectFlagSet("ARX_KemmVault_TeleportWindego",_,_Id)
AND
GlobalGetFlag("ARX_KemmVault_Windego_Wounded",1)
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0)
AND
QueryOnlyOnce("ARX_KemmVault_Windego_Appear")
THEN
DB_ARX_KemmVault_Kemm_KillWindego(_Id);
TeleportTo(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,TRIGGERGUID_S_ARX_KemmVault_ArhusPrison_WindegoMoveTo_9352859c-9110-4cba-a667-ab834fd6acc2);
SetOnStage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1);
SetCanFight(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0);
CharacterDisableAllCrimes(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
SetTag(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"IGNORESEENCOMBAT");
ProcSetInvulnerable(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1);
ApplyStatus(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"CRIPPLED",-1.0,1);
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"Execution_01_Loop");
PlayEffect(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"RS3_FX_Skills_Void_Netherswap_Reappear_01");
DialogAddActorAt(_Id,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,7);

IF
GlobalFlagSet("ARX_KemmVault_Kemm_KillWindego")
AND
DB_ARX_KemmVault_Kemm_KillWindego(_Id)
AND
DialogRemoveActorFromDialog(_Id,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
THEN
ProcSetInvulnerable(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0);
CharacterAttack(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

IF
AttackedByObject(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_,_)
AND
GlobalGetFlag("ARX_KemmVault_Kemm_KillWindego",1)
THEN
CharacterDie(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1,"Physical");
GlobalClearFlag("ARX_KemmVault_Kemm_KillWindego");
GlobalSetFlag("ARX_KemmVault_Kemm_KilledWindego");

//END_REGION

//REGION Arhus death event

IF
ObjectFlagSet("ARX_SeenDead_Arhu",(CHARACTERGUID)_Char,_)
AND
PartyGetFlag(_Char, "QuestUpdate_ARX_DisappearanceOfArhu_ArhuPrison_KilledArhu",0)
THEN
ObjectSetFlag(_Char, "QuestUpdate_ARX_DisappearanceOfArhu_ArhuPrison_ArhuDied");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
