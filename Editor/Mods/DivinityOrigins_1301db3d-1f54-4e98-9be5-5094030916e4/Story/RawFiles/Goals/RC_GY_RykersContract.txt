Version 1
SubGoalCombiner SGC_AND
INITSECTION
// https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/graveyard---ryker-s-contract
// https://www.lucidchart.com/documents/edit/1a47e3d7-089a-49c7-907a-ba1622929174#
// See also RC_GY_Ryker, RC_GY_RykersContract

DB_RC_GY_RykersContract_RitualGhosts((CHARACTERGUID)CHARACTERGUID_RC_GY_RykersRitualGhost_000_0eabc79c-7826-48d1-a049-933671a043f0,(TRIGGERGUID)TRIGGERGUID_S_RC_GY_RykersContract_RitualGhost_InRoom_000_24c9f6f6-7e9a-42c7-a622-cf1434058646);
DB_RC_GY_RykersContract_RitualGhosts(CHARACTERGUID_RC_GY_RykersRitualGhost_001_4ee66881-2def-4375-93e4-d5732a0097e2,TRIGGERGUID_S_RC_GY_RykersContract_RitualGhost_InRoom_001_cac3fe16-009f-4c7f-bf47-826514514023);
DB_RC_GY_RykersContract_RitualGhosts(CHARACTERGUID_RC_GY_RykersRitualGhost_002_d222ea63-3026-405e-aee4-de7942fed1ed,TRIGGERGUID_S_RC_GY_RykersContract_RitualGhost_InRoom_002_d25ce824-d277-4a37-9379-dd4b81fe90e7);

DB_GiveTemplateFromNpcToPlayerDialogEvent("RC_GY_RykersNote_6b4db312-fef1-4b1f-9562-70d9400eaf07","RC_GY_RykersBodyguard_GiveNote","RC_GY_RykersBodyguard_GaveNote");

TriggerRegisterForCharacter(TRIGGERGUID_S_RC_GY_SUB_RykersSecretChamber_736934a1-d5ed-4eae-8f7b-18426ef78325,CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4);
SetOnStage(ITEMGUID_RC_GY_RykersNote_OnTable_576a999a-144a-41bb-a5c6-bedb66819ade,0);

DB_OneTimeEventFlag("RC_GY_RykersContract_Phase0th");
DB_OneTimeEventFlag("RC_GY_RykersContract_Phase1st");
DB_OneTimeEventFlag("RC_GY_RykersContract_Phase2nd");
DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseEmpty");
DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseInterrupted");
DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseLast");
DB_OneTimeEventFlag("RC_GY_RykersContract_ApplySpiritVision");

Proc_RC_GY_RykersContract_RitualGhostSetup();

DB_RC_GY_RykersContract_ContractKnowledgeFlags("RC_GY_RykersContract_SourcererList_Start");
DB_RC_GY_RykersContract_ContractKnowledgeFlags("RC_KnowsAssassinationContract");
DB_RC_GY_RykersContract_ContractKnowledgeFlags("QuestUpdate_RC_GY_RykersContract_IfanAvatarKnowsRyker");
DB_RC_GY_RykersContract_ContractKnowledgeFlags("QuestUpdate_RC_GY_RykersContract_IfanCompanionKnowsRyker");
KBSECTION
//REGION Debug
IF
TextEventSet("ryker2")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"GaveQuest");
ObjectSetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_GotRykersQuest");
GlobalSetFlag("RC_GY_RykerWentToSecretChamber");
ClearVarObject(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"Seat");
ClearVarObject(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"SeatTrigger");
TeleportTo(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,TRIGGERGUID_S_RC_GY_RykersSecretChamber_RykerTeleportPoint_c9cde360-b119-4bc2-9d5a-aebb148f95c4);

IF
TextEventSet("ryker2")
AND
CharacterGetHostCharacter(_Player)
THEN
ItemTemplateAddTo("QUEST_AtaraxianTablet_PromiseInfo_23edac9b-2517-4fd0-a068-6bc9e60d1bbc",_Player,1);

IF
TextEventSet("ryker_clear")
AND
CharacterGetHostCharacter(_Player)
THEN
PartyClearFlag(_Player,"RC_GY_RykersContract_SourcererList_Start",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_GotRykersQuest",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanAvatarKnowsRyker",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanCompanionKnowsRyker",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_RefusedRykersQuest",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KnowsAboutBetrayal",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_FoundAtaraxianTablet",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_DeliveredAtaraxianTablet",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_LeaveTabletForMe",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_BetrayedByRyker",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KilledRyker",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_EnteredBlackPits",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_EnteredCave",0);
PartyClearFlag(_Player,"QuestUpdate_RC_GY_RykersContract_FoundTomb",0);
//END_REGION



//REGION QUEST UPDATES
IF
GlobalFlagSet("RC_GY_RykerDead")
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KilledRyker");

IF
ObjectFlagSet("GLO_HasAtaraxianTablet_PromiseInfo",(CHARACTERGUID)_Character,_)
THEN
PartySetFlag(_Character,"QuestUpdate_RC_GY_RykersContract_FoundAtaraxianTablet");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_OIL_SUB_Oilfields_bdbc337d-ee81-4b3d-96f7-d291fc5b271f)
AND
DB_IsPlayer(_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_EnteredBlackPits",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_EnteredBlackPits");

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_OIL_OilcaveEntrance_d7ec2f5b-99bf-4a9d-a621-f31a3b1ff10b)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_EnteredCave");

PROC
ProcOneShotTriggerEntered(_Player,S_RC_OIL_OneShot_PuzzleRoom_5fe4cda8-4827-4adb-964b-a52811a4edbe)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_FoundTomb");

IF
ObjectFlagSet("RC_GY_RykersContract_QuestRewardHack",_Player,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ProcGiveQuestReward(_Player,"RC_GY_RykersContract","QuestReward");
//END_REGION



//REGION Quest objects and interaction

//REGION Knowledge about Rykers assassination contract
// Found contract in Ryker's house
IF
GameBookInterfaceClosed(ITEMGUID_S_RC_GY_RykerHouse_GodwokenAssassinationContract_ff0e47e4-021b-47e2-ae55-a0be648d389d,_Player)
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KnowsAboutBetrayal");

// Any contract gives generic flag
IF
GameBookInterfaceClosed(_Item,_Player)
AND
GetTemplate(_Item,"GLO_GodwokenAssassinationContract_0b88012c-9b14-409e-b50d-328d6b154781")
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"RC_KnowsAssassinationContract", 0);

// Knows, that Ryker is Lone Wolf from Sourcerer list and saw assassination contract
QRY
QRY_RC_GY_RykersContract_CheckKnowsBetrayal((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"RC_GY_RykersContract_SourcererList_Start",1)
AND
PartyGetFlag(_Player,"RC_KnowsAssassinationContract",1)
THEN
DB_NOOP(1);

// Ifan-Avatar knows Ryker's a Lone Wolf and found contract
QRY
QRY_RC_GY_RykersContract_CheckKnowsBetrayal((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanAvatarKnowsRyker",1)
AND
PartyGetFlag(_Player,"RC_KnowsAssassinationContract",1)
THEN
DB_NOOP(1);

// Ifan-companion knows Ryker's a Lone Wolf and found contract
QRY
QRY_RC_GY_RykersContract_CheckKnowsBetrayal((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanCompanionKnowsRyker",1)
AND
PartyGetFlag(_Player,"RC_KnowsAssassinationContract",1)
THEN
DB_NOOP(1);

IF
ObjectFlagSet("QuestUpdate_RC_GY_RykersContract_GotRykersQuest",_Player,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"RC_GY_RykersContract_SourcererList_Start",0)
AND
CharacterIsInPartyWith(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player,1)
AND
DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanAvatarKnowsRyker");

IF
ObjectFlagSet("QuestUpdate_RC_GY_RykersContract_GotRykersQuest",_Player,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"RC_GY_RykersContract_SourcererList_Start",0)
AND
CharacterIsInPartyWith(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player,1)
AND
NOT DB_Avatars(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_IfanCompanionKnowsRyker");

IF
ObjectFlagSet(_Flag,_Player,_)
AND
DB_RC_GY_RykersContract_ContractKnowledgeFlags(_Flag)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KnowsAboutBetrayal",0)
AND
QRY_RC_GY_RykersContract_CheckKnowsBetrayal(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_KnowsAboutBetrayal");
//END_REGION

PROC
Proc_RC_GY_KilledRyker((CHARACTERGUID)_Player)
AND
QueryOnlyOnce("RC_GY_VB_KilledRyker")
THEN
StartVoiceBark("RC_GY_VB_KilledRyker",_Player);

IF
ObjectFlagSet("QuestUpdate_RC_GY_RykersContract_DeliveredAtaraxianTablet",_Player,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
QryTakeItemTemplateFromMagicPockets(_Player,"QUEST_AtaraxianTablet_PromiseInfo_23edac9b-2517-4fd0-a068-6bc9e60d1bbc",1,CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4)
THEN
DB_NOOP(1);

IF
ObjectFlagSet("QuestUpdate_RC_GY_RykersContract_DeliveredAtaraxianTablet",_Player,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"ReceivedTablet");

IF
CharacterItemEvent(_Player,ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryLever_0eea1dc1-db92-4794-8ce3-353e5c5f61c2,"RC_GY_RykersSecretChamber_OpenLibrary")
THEN
StartVoiceBark("RC_GY_VB_RykersSecretChamber_Lever",_Player);

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryDoor_889cae0e-f8c4-4f66-8b0c-77c9661e7ee5)
AND
DB_IsPlayer(_Player)
AND
ItemIsLocked(ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryDoor_889cae0e-f8c4-4f66-8b0c-77c9661e7ee5,1)
THEN
StartVoiceBark("RC_GY_VB_RykersSecretChamber_LibraryDoor",_Player);

PROC
ProcBlockLockpickItem(_Player,ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryDoor_889cae0e-f8c4-4f66-8b0c-77c9661e7ee5)
AND
DB_IsPlayer(_Player)
AND
ItemIsLocked(ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryDoor_889cae0e-f8c4-4f66-8b0c-77c9661e7ee5,1)
THEN
DB_CustomLockpickItemResponse(_Player,ITEMGUID_S_RC_GY_RykersSecretChamber_LibraryDoor_889cae0e-f8c4-4f66-8b0c-77c9661e7ee5,0);
StartVoiceBark("RC_GY_VB_RykersSecretChamber_LibraryDoor",_Player);
//END_REGION



//REGION Aux checks and flags
IF
CharacterCharacterEvent(_Bodyguard,_Player,"RC_GY_GiveRykersNote")
AND
DB_IsPlayer(_Player)
AND
DB_RC_GY_RykersBodyguardsInRoom(_Bodyguard)
AND
PartyGetFlag(_Player,"RC_GY_GotRykersNote",0)
THEN
Proc_StartDialog(0,"RC_GY_RykersBodyguard_GiveNote",_Bodyguard,_Player);
PartySetFlag(_Player,"RC_GY_GotRykersNote");
//END_REGION



//REGION Move to secret chamber sequence
IF
CharacterLeftTrigger(_Char,TRIGGERGUID_S_RC_GY_SUB_RykerHouse_GroundFloor_f685aad8-a811-4d5c-9e90-81e5a66456cc)
AND
QRY_AnyRegionActive()
AND
DB_IsPlayer(_Char)
AND
NOT DB_GlobalFlag("RC_GY_RykerWentToSecretChamber")
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"GaveQuest",1)
AND
NOT QRY_RC_GY_PlayerInRykersMansion()
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"ReceivedTablet",0)
THEN
Proc_RC_GY_RykerGoToSecretChamber();
/*
// all quest givers left GY
QRY
QRY_RC_GY_RykersContractQuestersInGY()
AND
DB_IsPlayer(_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_RykersContract_GotRykersQuest",1)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_GY_SUB_Graveyard_59ac9cef-edf4-492f-906c-fbde552e68d3)
THEN
DB_NOOP(1);
*/
// there's no one on first floor of mansion
QRY
QRY_RC_GY_PlayerInRykersMansion()
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_GY_SUB_RykerHouse_GroundFloor_f685aad8-a811-4d5c-9e90-81e5a66456cc)
THEN
DB_NOOP(1);

QRY
QRY_RC_GY_PlayerInRykersMansion()
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_GY_SUB_RykerHouse_SecondFloor_0b11d783-9950-4ea8-9d2c-d18026d49025)
THEN
DB_NOOP(1);


PROC
Proc_RC_GY_RykerGoToSecretChamber()
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"GoingToSecretChamber",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"GoingToSecretChamber");
ClearVarObject(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"Seat");
ClearVarObject(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"SeatTrigger");
SetScriptframe(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"MoveToSecretChamber");

IF
GlobalFlagSet("RC_GY_RykerUnlockedHatch")
THEN
Proc_RC_GY_RykersContract_UnlockSecretHatch();
ItemClearOwner(ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a);


// Ryker entered his secret lab
IF
CharacterEnteredTrigger(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,TRIGGERGUID_S_RC_GY_SUB_RykersSecretChamber_736934a1-d5ed-4eae-8f7b-18426ef78325)
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_RC_GY_SUB_RykersSecretChamber_736934a1-d5ed-4eae-8f7b-18426ef78325,CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4);
GlobalSetFlag("RC_GY_RykerWentToSecretChamber");
ObjectSetFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_RykerWentToSecretChamber");
ObjectClearFlag(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"GoingToSecretChamber");
Proc_RC_GY_RykerWentToSecretChamber();

PROC
Proc_RC_GY_RykerWentToSecretChamber()
AND
DB_RC_GY_RykersBodyguardsInSecretChamber(_Bodyguard,_Ghost)
THEN
Foop(_Bodyguard);
SetOnStage(_Ghost,1);

PROC
Proc_RC_GY_RykerWentToSecretChamber()
THEN
SetOnStage(ITEMGUID_RC_GY_RykersNote_OnTable_576a999a-144a-41bb-a5c6-bedb66819ade,1);

PROC
Proc_RC_GY_RykerWentToSecretChamber()
AND
DB_RC_GY_RykersBodyguardsInRoom(_Bodyguard)
AND
NOT DB_Dead(_Bodyguard)
THEN
ItemTemplateAddTo("RC_GY_RykersNote_6b4db312-fef1-4b1f-9562-70d9400eaf07",_Bodyguard,1);
ObjectSetFlag(_Bodyguard,"RC_GY_RykerWentToSecretChamber");


IF
CharacterCharacterEvent(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_Player,"RC_GY_RykersContract_RykerAsksOnSight")
AND
DB_IsPlayer(_Player)
THEN
Proc_StartDialog(0,"RC_GY_Ryker",CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_Player);
//END_REGION


//REGION Secret chamber hatches and doors
IF
CharacterUsedItem(_,ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d)
THEN
ObjectSetFlag(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d,"Removed");
PlayEffect(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d,"RS3_FX_GP_ScriptedEvent_RC_GY_RykersCarpe_Rollover_01");
PlaySound(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d,"SE_RC_GY_RykersCarpe_Rollover");
TimerLaunch("RC_GY_RykersCarpet_OffStage",500);
//Poof(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d);
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_SourceGlow_Overlay_01",ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a,"SourceInfused","RC_Main","");
SetOnStage(ITEMGUID_S_RC_GY_RykersCarpetRolled_7543a9fc-c34a-4fcc-a4da-6289203145b9,1);
SetOnStage(ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a,1);


IF
TimerFinished("RC_GY_RykersCarpet_OffStage")
THEN
SetOnStage(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d,0);

IF
CharacterUsedItem(_,ITEMGUID_TOOL_Ladder_6H_B_019_a87e5ca1-c46f-4527-bfb3-38dca09dc644)
THEN
Proc_RC_GY_RykersContract_UnlockSecretHatch();

PROC
Proc_RC_GY_RykersContract_UnlockSecretHatch()
THEN
SetOnStage(ITEMGUID_S_RC_GY_RykersCarpet_1b69c50c-91ee-4edd-8055-a43898acc00d,0); // sane check
SetOnStage(ITEMGUID_S_RC_GY_RykersCarpetRolled_7543a9fc-c34a-4fcc-a4da-6289203145b9,1); // sane check
SetOnStage(ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a,1);
ItemUnLock(ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a);
PROC_StopLoopEffect(ITEMGUID_S_RC_GY_RykersSecretChamber_Hatch_e2f19559-8a6c-479b-8454-189a1dac255a,"SourceInfused");
//END_REGION



//REGION Ghost ritual in secret chamber
// RITUAL SEQUENCE RitualGhosts actions
PROC
Proc_RC_GY_RykersContract_RitualGhostSetup()
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
THEN
DB_Dialogs(_Ghost,"RC_GY_RykersContract_RitualGhost");
DB_BlockThreatenedDialog(_Ghost);
SetStoryEvent(_Ghost,"RC_GY_RitualGhost_StateHide");

PROC
Proc_RC_GY_RykersContract_GhostsState0th()
THEN
CharacterUseSkill(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"Shout_SpiritVision",NULL_00000000-0000-0000-0000-000000000000,0);

PROC
Proc_OneTimeEventFlag(_Player,"RC_GY_RykersContract_ApplySpiritVision")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
CharacterCanSee(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_Player,1)
THEN
ApplyStatus(_Player,"SPIRIT_VISION",30.0,1);

PROC
Proc_RC_GY_RykersContract_GhostsState0th()
AND
NOT DB_GlobalFlag("RC_GY_RykerWentToSecretChamber")
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_Trigger)
THEN
TeleportTo(_Ghost,_Trigger);
CharacterLookFromTrigger(_Ghost,_Trigger,0);

PROC
Proc_RC_GY_RykersContract_GhostsState0th()
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
AND
String(_Ghost,_GhostStr)
AND
StringConcatenate("RC_GY_RykersContract_RykerBeam_",_GhostStr,_BeamName)
THEN
ObjectSetFlag(_Ghost,"RC_GY_RykersContract_RitualGhost_InUse");
SetStoryEvent(_Ghost,"RC_GY_RitualGhost_State0th");
PROC_StopLoopBeamEffect(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_BeamName);


PROC
Proc_RC_GY_RykersContract_GhostsState1st()
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
AND
String(_Ghost,_GhostStr)
AND
StringConcatenate("RC_GY_RykersContract_RykerBeam_",_GhostStr,_BeamName)
THEN
ObjectSetFlag(_Ghost,"RC_GY_RykersContract_RitualGhost_InUse");
SetStoryEvent(_Ghost,"RC_GY_RitualGhost_State1st");
PROC_LoopBeamEffect("RS3_FX_Skills_Soul_ShacklesOfPain_LinkBeam_01",CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_Ghost,"","",_BeamName,"RC_Main");
//RS3_FX_GP_Beams_Ataraxian_Green_01

PROC
Proc_RC_GY_RykersContract_GhostsState2nd()
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
THEN
ObjectSetFlag(_Ghost,"RC_GY_RykersContract_RitualGhost_InUse");
SetStoryEvent(_Ghost,"RC_GY_RitualGhost_State2nd");


// RITUAL SEQUENCE Global flags
PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_Phase0th")
THEN
Proc_RC_GY_RykersContract_GhostsState0th();
RemoveStatus(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"SITTING");
PlayAnimation(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"skill_prepare_voodoo_01_start","RC_GY_RykersContract_VoodooStart");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_RykersContract_VoodooStart")
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"skill_prepare_voodoo_01_loop");


PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_Phase1st")
THEN
Proc_RC_GY_RykersContract_GhostsState1st();
PROC_LoopEffect("RS3_FX_Skills_Source_Prepare_Ground_01",CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_RykersContract_RykerEffect","RC_Main","");


PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_Phase2nd")
THEN
Proc_RC_GY_RykersContract_GhostsState2nd();


PROC
Proc_OneTimeEventFlag(_Player,"RC_GY_RykersContract_PhaseEmpty")
THEN
GlobalSetFlag("RC_GY_RykersContract_Ritual_Unavailable");

PROC
Proc_OneTimeEventFlag(_Player,"RC_GY_RykersContract_PhaseLast")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
PROC_LoopBeamEffect("RS3_FX_Skills_Soul_ShacklesOfPain_LinkBeam_01",_Player,CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"","","RC_GY_RykersContract_RykerBeam","RC_Main");
PROC_LoopEffect("RS3_FX_GP_Status_SourceInfused_01",_Player,"RC_GY_RykersContract_SourceInfused","RC_Main","");


PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseEmpty")
AND
DB_IsPlayer(_Player)
THEN
PROC_StopLoopBeamEffect(_Player,"RC_GY_RykersContract_RykerBeam");
PROC_StopLoopEffect(_Player,"RC_GY_RykersContract_SourceInfused");

PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseEmpty")
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
AND
String(_Ghost,_GhostStr)
AND
StringConcatenate("RC_GY_RykersContract_RykerBeam_",_GhostStr,_BeamName)
THEN
PROC_StopLoopBeamEffect(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,_BeamName);
PlayEffect(_Ghost,"RS3_FX_GP_ScriptedEvents_ARX_HorrorSleep_Arena_Resurrect_01");
Proc_GhostHacks_GhostPoof(_Ghost);

PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseEmpty")
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"");
PROC_StopLoopEffect(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_RykersContract_RykerEffect");


PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseInterrupted")
AND
DB_IsPlayer(_Player)
THEN
PROC_StopLoopBeamEffect(_Player,"RC_GY_RykersContract_RykerBeam");
PROC_StopLoopEffect(_Player,"RC_GY_RykersContract_SourceInfused");

PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseInterrupted")
THEN
Proc_RC_GY_RykersContract_GhostsState0th();
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"");
PROC_StopLoopEffect(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_RykersContract_RykerEffect");

PROC
Proc_OneTimeEventFlag("RC_GY_RykersContract_PhaseInterrupted")
AND
DB_RC_GY_RykersContract_RitualGhosts(_Ghost,_)
THEN
ObjectClearFlag(_Ghost,"RC_GY_RykersContract_RitualGhost_InUse");
//END_REGION
EXITSECTION
SysClear("DB_RC_GY_RykersContract_RitualGhosts",2);
NOT DB_GiveTemplateFromNpcToPlayerDialogEvent("RC_GY_RykersNote_6b4db312-fef1-4b1f-9562-70d9400eaf07","RC_GY_RykersBodyguard_GiveNote","RC_GY_RykersBodyguard_GaveNote");
TriggerUnregisterForCharacter(TRIGGERGUID_S_RC_GY_SUB_RykersSecretChamber_736934a1-d5ed-4eae-8f7b-18426ef78325,CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4);
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_Phase0th");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_Phase1st");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_Phase2nd");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseEmpty");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseInterrupted");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_PhaseLast");
NOT DB_OneTimeEventFlag("RC_GY_RykersContract_ApplySpiritVision");
SysClear("DB_RC_GY_RykersContract_ContractKnowledgeFlags",1);
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
