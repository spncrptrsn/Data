Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_TUT_LowerDeck_ArrestingMagister((CHARACTERGUID)S_TUT_LowerDeck_CrossBowMagister_001_b2ec3611-6484-4168-9039-c092bcdea52d);
DB_TUT_LowerDeck_ArrestingMagister(S_TUT_LowerDeck_CrossBowMagister_000_c4531ec5-203f-4ff2-95f6-ac14b9cf7994);

DB_TUT_LowerDeck_WindegoDialogGroup((CHARACTERGUID)S_TUT_LowerDeck_CrossBowMagister_001_b2ec3611-6484-4168-9039-c092bcdea52d);
DB_TUT_LowerDeck_WindegoDialogGroup(S_TUT_LowerDeck_CrossBowMagister_000_c4531ec5-203f-4ff2-95f6-ac14b9cf7994);
DB_TUT_LowerDeck_WindegoDialogGroup(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);
DB_TUT_LowerDeck_WindegoDialogGroup(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

DB_OneShotPlayerTrigger(S_TUT_LowerDeck_WindegoInterrogationBox_8e06af80-ac9c-43ea-914e-d7c419325e97);
PROC_TUT_InitWindegoInterrogation();

SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_CrossBowMagister_000_c4531ec5-203f-4ff2-95f6-ac14b9cf7994, 1);
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_CrossBowMagister_001_b2ec3611-6484-4168-9039-c092bcdea52d, 1);
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340, 1);

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_TUT_LowerDeck_InterrogationTrigger_0c031789-4b3f-474a-b432-ef7073ef0af3);
KBSECTION
//REGION Init
PROC
PROC_TUT_InitWindegoInterrogation()
AND
DB_TUT_LowerDeck_ArrestingMagister(_Magister)
THEN
CharacterLookAt(_Magister,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
CharacterSetFightMode(_Magister,1,1);
ProcCharacterDisableAllCrimes(_Magister);
DB_IsNotMessingAround(_Magister);
DB_SceneManager(_Magister,"TUT_WindegoEvent");

PROC
PROC_TUT_InitWindegoInterrogation()
THEN
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
SetHasDialog(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1);
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,1);
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);
DB_IsNotMessingAround(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
DB_IsNotMessingAround(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);
CharacterSetImmortal(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1);
DB_SceneManager(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"TUT_WindegoEvent");
DB_SceneManager(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,"TUT_WindegoEvent");
DB_SceneTriggerManager("TUT_WindegoEvent",TRIGGERGUID_S_TUT_WindegoSceneBox_17dc6aa3-f77c-4a07-b7f0-0578bf932447);
TimerLaunch("TUT_RepeatWindegoInterrogation",1000);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_TUT_LowerDeck_InterrogationTrigger_0c031789-4b3f-474a-b432-ef7073ef0af3)
THEN
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_TUT_LowerDeck_InterrogationTrigger_0c031789-4b3f-474a-b432-ef7073ef0af3);
Proc_StartDialog(1,"TUT_AD_LowerDeck_WindegoInterrogation",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);

IF
TimerFinished("TUT_RepeatWindegoInterrogation")
AND
NOT DB_GlobalFlag("TUT_BlockLowerDeckADs")
THEN
Proc_StartDialog(1,"TUT_AD_LowerDeck_WindegoInterrogation",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);

IF
TimerFinished("TUT_RepeatWindegoInterrogation")
AND
DB_GlobalFlag("TUT_BlockLowerDeckADs")
THEN
TimerLaunch("TUT_RepeatWindegoInterrogation",10000);

IF
AutomatedDialogEnded("TUT_AD_LowerDeck_WindegoInterrogation",_)
AND
CharacterIsDead(S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,0)
THEN
TimerLaunch("TUT_RepeatWindegoInterrogation",10000);

IF
AutomatedDialogRequestFailed("TUT_AD_LowerDeck_WindegoInterrogation",_)
AND
CharacterIsDead(S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,0)
THEN
TimerLaunch("TUT_RepeatWindegoInterrogation",5000);


//END_REGION //Init

//REGION Entrance into stern room
IF
DialogStarted("TUT_LowerDeck_ExitDoorGuard_001",_)
THEN
DB_TUT_LowerDeck_TalkedToSternRoomGuard(1);

PROC
ProcBlockUseOfItem(_Player,S_TUT_LowerDeck_DoorToStairs_a3568413-0821-406c-b8a9-33d3a5c1638f)
AND
DB_IsPlayer(_Player)
AND
NOT DB_TUT_LowerDeck_TalkedToSternRoomGuard(1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_TUT_LowerDeck_ExitDoorGuard_001_bf967ae2-69a9-4791-8f80-ad72236edaf7,_Player)
THEN
DB_CustomUseItemResponse(_Player,S_TUT_LowerDeck_DoorToStairs_a3568413-0821-406c-b8a9-33d3a5c1638f,0);
Proc_StartDialog(0,"TUT_LowerDeck_ExitDoorGuard_001",S_TUT_LowerDeck_ExitDoorGuard_001_bf967ae2-69a9-4791-8f80-ad72236edaf7,_Player);

IF
ItemDestroyed(S_TUT_LowerDeck_DoorToStairs_a3568413-0821-406c-b8a9-33d3a5c1638f)
THEN
DB_TUT_LowerDeck_DoorToStairsDestroyed(1);

IF
DialogEnded("TUT_LowerDeck_ExitDoorGuard_001",_)
AND
NOT DB_TUT_LowerDeck_TalkedToSternRoomGuard_DoorOpened(1)
AND
NOT DB_TUT_LowerDeck_DoorToStairsDestroyed(1)
THEN
DB_TUT_LowerDeck_TalkedToSternRoomGuard_DoorOpened(1);
ItemUnLock(S_TUT_LowerDeck_DoorToStairs_a3568413-0821-406c-b8a9-33d3a5c1638f);
ItemOpen(S_TUT_LowerDeck_DoorToStairs_a3568413-0821-406c-b8a9-33d3a5c1638f);
//END_REGION //Entrance into stern room

IF
ObjectFlagSet("TUT_WindegoPreparesSource",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
THEN
PlayAnimation(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"Pray_01");

IF
DialogStarted("TUT_LowerDeck_WindegoInterrogation",_)
THEN
GlobalSetFlag("TUT_WindegoStopAllADs");
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_CrossBowMagister_000_c4531ec5-203f-4ff2-95f6-ac14b9cf7994, 0);
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_CrossBowMagister_001_b2ec3611-6484-4168-9039-c092bcdea52d, 0);
SetHasDialog(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340, 0);

//REGION Detect when Windego should start her casting
IF
DialogEnded("TUT_LowerDeck_WindegoInterrogation",_)
THEN
Proc_SceneOver_Once("TUT_WindegoEvent");

IF
DialogRequestFailed("TUT_LowerDeck_WindegoInterrogation",_)
THEN
Proc_SceneOver_Once("TUT_WindegoEvent");

PROC
Proc_SceneInterrupted(_,_,"TUT_WindegoEvent",_Reason)
AND
DB_GLO_GenericSceneManager_LeavingReason(_Reason)
THEN
Proc_SceneOver_Once("TUT_WindegoEvent");

PROC
Proc_SceneInterrupted(_,_,"TUT_WindegoEvent","Attacked")
THEN
Proc_SceneOver_Once("TUT_WindegoEvent");

IF
ObjectEnteredCombat(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_Combat)
THEN
DB_TUT_LowerDeck_WindegoCombat(_Combat);

IF
CombatStarted(_Combat)
AND
DB_TUT_LowerDeck_WindegoCombat(_Combat)
THEN
NOT DB_TUT_LowerDeck_WindegoCombat(_Combat);
Proc_SceneOver_Once("TUT_WindegoEvent");


// Fallback in case the players find a way to hurt her a lot without starting combat
IF
CharacterReceivedDamage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182, _, _)
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_Percentage)
AND
_Percentage <= 70.0
AND
CharacterIsInCombat(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0)
THEN
DB_TUT_Windego_HealthBeforeCasting(_Percentage);
Proc_SceneOver_Once("TUT_WindegoEvent");

PROC
Proc_SceneOver_Once("TUT_WindegoEvent")
AND
QueryOnlyOnce("TUT_WindegoEvent_SceneOver")
THEN
Proc_SceneOver("TUT_WindegoEvent");
//END_REGION

//REGION Trigger the TUT_Windego goal event code
PROC
Proc_SceneOver("TUT_WindegoEvent")
THEN
PROC_TUT_LowerDeck_WindegoStart();

PROC
PROC_TUT_LowerDeck_WindegoStart()
AND
DB_IsPlayer(_Player)
THEN
// Make Windego hostile to all players (Windego is hostile to Godwoken), so Windego enters combat immediately after the combat
CharacterSetTemporaryHostileRelation(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_Player);

PROC
PROC_TUT_LowerDeck_WindegoStart()
THEN
DB_TUT_LowerDeck_WindegoEventStarted(1);
DB_TUT_LowerDeck_WindegoDialogDone(1);
PROC_TUT_WindegoBeserk(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
//END_REGION

PROC
ProcOneShotTriggerEntered(_Player,S_TUT_LowerDeck_WindegoInterrogationBox_8e06af80-ac9c-43ea-914e-d7c419325e97)
THEN
PROC_TUT_LowerDeck_StartWindegoInterrogationDialog(_Player);

PROC
PROC_GLOBAL_DialogStartRequested((CHARACTERGUID)_Char,(CHARACTERGUID)_Player)
AND
DB_TUT_LowerDeck_WindegoDialogGroup(_Char)
THEN
PROC_TUT_LowerDeck_StartWindegoInterrogationDialog(_Player);

PROC
PROC_TUT_LowerDeck_StartWindegoInterrogationDialog((CHARACTERGUID)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,_Player)
THEN
SetVarFixedString(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"currentState","");
ProcForceStopDialog(CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340);
ProcForceStopDialog(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
Proc_StartDialog(0,"TUT_LowerDeck_WindegoInterrogation",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,CHARACTERGUID_S_TUT_LowerDeck_Officer_X_a658e0ea-db65-4be9-82c0-40629a2d0340,_Player);

PROC
ProcBlockUseOfItem(_Player,S_TUT_LowerDeck_StairsToMiddleDeck_Blocked_57d13139-818c-4853-b238-fbb9454175a8)
AND
DB_IsPlayer(_Player)
AND
NOT DB_TUT_WindegoFinishedCastingAnimation(1)
THEN
DB_CustomUseItemResponse(_Player,S_TUT_LowerDeck_StairsToMiddleDeck_Blocked_57d13139-818c-4853-b238-fbb9454175a8,0);
Proc_StartDialog(1,"TUT_AD_LowerDeck_SternStairsBlocked",_Player);

PROC
ProcRegionEnded("TUT_Tutorial_A")
THEN
CharacterSetHitpointsPercentage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,100.0);
CharacterSetImmortal(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0);
GoalCompleted;
EXITSECTION
NOT DB_TUT_LowerDeck_TalkedToSternRoomGuard_DoorOpened(1);
NOT DB_TUT_LowerDeck_TalkedToSternRoomGuard(1);
NOT DB_TUT_LowerDeck_DoorToStairsDestroyed(1);
ENDEXITSECTION
ParentTargetEdge "TUT_LowerDeck"
