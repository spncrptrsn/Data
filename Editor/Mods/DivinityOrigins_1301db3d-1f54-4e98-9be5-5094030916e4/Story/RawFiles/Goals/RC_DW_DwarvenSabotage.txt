Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_HasStoryEvent(RC_WC_EmpressLetter_ffaa5485-ccc8-4e66-a69b-52316fdc7c82,"RC_WC_HasEmpressLetter");

DB_RC_DW_DwarvenSabotage_EmpressLetterNPCQuestUpdate(CHARACTERGUID_S_RC_DW_Julian_356538aa-90b6-4cc0-89e9-53dc3633e12d,"QuestUpdate_RC_DW_DwarvenSabotage_GaveLetterToMagister");
DB_RC_DW_DwarvenSabotage_EmpressLetterNPCQuestUpdate(CHARACTERGUID_S_RC_DW_UnderTavern_DwarfBoss_8e58abc6-1010-4e67-97b2-b9686586e784,"QuestUpdate_RC_DW_DwarvenSabotage_GaveLetterToLilian");
KBSECTION
IF
ObjectFlagSet("RC_WC_HasEmpressLetter",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("RC_DW_WC_PickUpEmpressLetter")
THEN
StartVoiceBark("RC_DW_WC_VB_PickedUpEmpressLetter",_Player);

IF
ObjectFlagSet("RC_WC_HasEmpressLetter",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player, "QuestUpdate_RC_DW_DwarvenSabotage_FoundEmpressLetter");

//REGION Empress letter
IF
ObjectFlagSet("RC_DW_GiveEmpressLetter", _NPC, _ID)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
AND
QryTakeItemFromMagicPockets((CHARACTERGUID)_Player,ITEMGUID_RC_WC_EmpressLetter_ffaa5485-ccc8-4e66-a69b-52316fdc7c82, _NPC)
AND
DB_RC_DW_DwarvenSabotage_EmpressLetterNPCQuestUpdate(_NPC,_QuestUpdate)
THEN
PartySetFlag(_Player,_QuestUpdate);
PROC_RC_DW_DwarvenSabotage_MaybeDwarfEnemy((CHARACTERGUID)_Player,(CHARACTERGUID)_NPC);

IF
ObjectFlagSet("QuestUpdate_RC_DW_DwarvenSabotage_GaveLetterToMagister",_Player,_Id)
AND
GlobalGetFlag("RC_DW_DwarvenSabotage_GaveLetterToMagister",0)
THEN
GlobalSetFlag("RC_DW_DwarvenSabotage_GaveLetterToMagister");

PROC
PROC_RC_DW_DwarvenSabotage_MaybeDwarfEnemy((CHARACTERGUID)_Player,(CHARACTERGUID)_NPC)
AND
_NPC == CHARACTERGUID_S_RC_DW_Julian_356538aa-90b6-4cc0-89e9-53dc3633e12d
THEN
PartySetFlag((CHARACTERGUID)_Player,"GLO_SetTag_DWARF-ENEMY");
//END_REGION

IF
CharacterDied((CHARACTERGUID)S_RC_DW_UnderTavern_DwarfBoss_8e58abc6-1010-4e67-97b2-b9686586e784)
AND
DB_IsPlayer(_Player)
THEN
// only update if already ongoing
PartySetFlag(_Player,"QuestUpdate_RC_DW_DwarvenSabotage_KilledLohar");


//REGION Debug
IF
TextEventSet("GiveLetterToJulien")
THEN
ItemToInventory(S_RC_DW_WC_EmpressLetter_ffaa5485-ccc8-4e66-a69b-52316fdc7c82,S_RC_DW_Julian_356538aa-90b6-4cc0-89e9-53dc3633e12d);
GlobalSetFlag("RC_DW_DwarvenSabotage_GaveLetterToMagister");
//END_REGION

IF
GlobalFlagSet("RC_DW_EmpressLetterGiven")
THEN
ItemClearOwner(S_RC_DW_WhiteMagisterReward_533f9427-4d61-4d60-9edb-8c10c79b24da);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
