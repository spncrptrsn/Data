Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/at-the-doorstep

DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_OIL_Wall_Balcony_5ddd7bee-f5ae-457d-a116-9b884602263b);

DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Cave_WallBoss");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_EnslavedBR_01_05e270f5-a5a7-44f1-8ec8-de2086a63d88,"RC_OIL_Cave_PossessedBlackRing1");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_EnslavedBR_02_0d1584eb-bded-4b11-8a67-e26f5e53dd76,"RC_OIL_Cave_PossessedBlackRing2");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_Magister1_0592c117-c506-4241-8439-1ca498045576,"RC_OIL_Cave_Wall_Magister1");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_Magister2_e220513f-8df4-4a42-bfcf-676847cdc45c,"RC_OIL_Cave_Wall_Magister2");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_Monk1_87bf9286-f494-40d3-9a7c-69b0634f23f8,"RC_OIL_Cave_Wall_Monk1");
DB_Dialogs(CHARACTERGUID_S_RC_OIL_Wall_Monk2_63e4bba1-264c-4068-97bb-d441e31f3fa5,"RC_OIL_Cave_Wall_Monk2");

DB_Ghosts(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,CHARACTERGUID_S_RC_OIL_Wall_Boss_Ghost_837b5e4b-99a9-4ebe-8113-71743de58cc3,"RC_OIL_Cave_WallBossGhost");

DB_RC_OIL_Cave_WallMagisters((CHARACTERGUID)CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
DB_RC_OIL_Cave_WallMagisters(CHARACTERGUID_S_RC_OIL_Wall_Magister1_0592c117-c506-4241-8439-1ca498045576);
DB_RC_OIL_Cave_WallMagisters(CHARACTERGUID_S_RC_OIL_Wall_Magister2_e220513f-8df4-4a42-bfcf-676847cdc45c);
DB_RC_OIL_Cave_WallMagisters(CHARACTERGUID_S_RC_OIL_Wall_Monk1_87bf9286-f494-40d3-9a7c-69b0634f23f8);
DB_RC_OIL_Cave_WallMagisters(CHARACTERGUID_S_RC_OIL_Wall_Monk2_63e4bba1-264c-4068-97bb-d441e31f3fa5);

//Oil Machine
DB_RC_OIL_Cave_OilMachineCombination("RC_OIL_FourthHouse_2");
DB_RC_OIL_Cave_OilMachineCombination("RC_OIL_FourthHouse_1");
DB_RC_OIL_Cave_OilMachineCombination("RC_OIL_FourthHouse_4");
DB_Dialogs(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"RC_OIL_Cave_OilMachine");
//PROC_LoopEffect("RS3_FX_Environment_Smoke_Chimney_01",ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"RC_OIL_Cave_OilMachineSpark","RC_Main","");
DB_OneShotUser_VoicebarkTrigger(TRIGGERGUID_S_RC_OIL_Cave_VB_Machine_7b8dc41f-e0d3-4356-afb7-47c7af16d887,"RC_OIL_VB_OilMachine");

DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_OIL_Cave_WallOfBarrels_9245511c-8153-489c-af5e-3693631c3d55);

DB_RC_OIL_Cave_BlackRing((CHARACTERGUID)CHARACTERGUID_S_RC_OIL_Wall_EnslavedBR_01_05e270f5-a5a7-44f1-8ec8-de2086a63d88);
DB_RC_OIL_Cave_BlackRing(CHARACTERGUID_S_RC_OIL_Wall_EnslavedBR_02_0d1584eb-bded-4b11-8a67-e26f5e53dd76);

KBSECTION
//REGION Magisters

IF
DB_RC_OIL_Cave_BlackRing(_Ring)
THEN
ApplyStatus(_Ring,"POSSESSED",-1.0);
ProcCharacterDisableAllCrimes(_Ring);

IF
CharacterDied(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785)
THEN
CharacterSetRelationFactionToFaction("RC_OIL_Temple_BlackRing","RC_OIL_CaveCombatHostile",0);
CharacterSetRelationFactionToFaction("RC_OIL_CaveCombatHostile","RC_OIL_Temple_BlackRing",0);
CharacterSetRelationFactionToFaction("RC_OIL_Temple_BlackRing","Hero",0);
CharacterSetRelationFactionToFaction("Hero","RC_OIL_Temple_BlackRing",0);

IF
CharacterDied(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785)
AND
DB_RC_OIL_Cave_BlackRing(_Ring)
THEN
RemoveStatus(_Ring,"POSSESSED");
ProcCharacterEnableAllCrimes(_Ring);
CharacterSetCustomName(_Ring,"RC_OIL_BlackRingReaver");
PlayEffect(_Ring,"RS3_FX_Skills_Voodoo_DominateMind_Impact_StatusFx_01");

IF
CharacterDied(_Ring)
AND
DB_RC_OIL_Cave_BlackRing(_Ring)
THEN
RemoveStatus(_Ring,"POSSESSED");
CharacterSetCustomName(_Ring,"RC_OIL_BlackRingReaver");
PlayEffect(_Ring,"RS3_FX_Skills_Voodoo_DominateMind_Impact_StatusFx_01");

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_OIL_Wall_Balcony_5ddd7bee-f5ae-457d-a116-9b884602263b)
THEN
CharacterSetReactionPriority(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"Action_MagisterBossWander",900);
Proc_StartDialog(1,"RC_OIL_AD_Cave_Wall",_Player);

IF
StoryEvent((CHARACTERGUID)_Player,"RC_OIL_Wall_BossDialog")
THEN
Proc_StartDialog(0,"RC_OIL_Cave_WallBoss",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,_Player);

IF
DialogRequestFailed("RC_OIL_Cave_WallBoss",_)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Wall_BossDialog_Restart");

IF
DialogEnded("RC_OIL_Cave_WallBoss",_)
AND
DB_GlobalFlag("RC_OIL_Cave_WallBossHostile")
THEN
Proc_StartDialog(1,"RC_OIL_AD_WallBossCombat",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
Proc_RC_OIL_AtTheDoorstepHostile();

IF
AttackedByObject((CHARACTERGUID)_Magister,_,_Attacker,_,_)
AND
_Magister != _Attacker
AND
DB_RC_OIL_Cave_WallMagisters(_Magister)
AND
GetFaction(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Cave_Temple")
THEN
Proc_StartDialog(1,"RC_OIL_AD_WallBossCombat",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
Proc_RC_OIL_AtTheDoorstepHostile();

IF
AttackedByObject((CHARACTERGUID)_Ring,_,_Attacker,_,_)
AND
_Ring != _Attacker
AND
DB_RC_OIL_Cave_BlackRing(_Ring)
AND
GetFaction(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Cave_Temple")
THEN
Proc_StartDialog(1,"RC_OIL_AD_WallBossCombat",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
Proc_RC_OIL_AtTheDoorstepHostile();

IF
ItemReceivedDamage(ITEMGUID_S_RC_OIL_Wall_3239ba5e-5e4c-4c3e-8cd6-d8479927a391)
AND
GetFaction(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Cave_Temple")
THEN
Proc_StartDialog(1,"RC_OIL_AD_WallBossPanic",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
Proc_RC_OIL_AtTheDoorstepHostile();

IF
CharacterReceivedDamage(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785, _, _)
AND
GetFaction(CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785,"RC_OIL_Cave_Temple")
THEN
Proc_StartDialog(1,"RC_OIL_AD_WallBossPanic",CHARACTERGUID_S_RC_OIL_Wall_Boss_61df0b93-6498-414d-8c43-d08df9f40785);
Proc_RC_OIL_AtTheDoorstepHostile();

PROC
Proc_RC_OIL_AtTheDoorstepHostile()
AND
QueryOnlyOnce("RC_OIL_TempleExcavationHostile")
AND
DB_RC_OIL_Cave_WallMagisters(_Magister)
THEN
SetFaction(_Magister,"RC_OIL_CaveCombatHostile");

//END_REGION

//REGION Machine

IF
ObjectFlagSet("SE_RC_Oil_Machine_Start",ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,_)
THEN
ObjectClearFlag(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"SE_RC_Oil_Machine_Start");
PlaySound(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"SE_RC_Oil_Machine_Start");

IF
GlobalFlagSet(_Flag)
AND
DB_RC_OIL_Cave_OilMachineCombination(_Flag)
AND
DB_DialogNPCs(_Inst,ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,1)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
GetPosition(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,_X,_Y,_Z)
THEN
PlaySound(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"SE_RC_Oil_Machine_Lever_01");
Proc_ShakeCameraForTime((CHARACTERGUID)_Player,1000);
PlayScaledEffectAtPosition("RS3_FX_GP_ScriptedEvent_RC_Oil_Machine_Failure_01",2.5,_X,_Y,_Z);

IF
GlobalFlagSet(_Flag)
AND
DB_RC_OIL_Cave_OilMachineCombination(_Flag)
AND
DB_RC_OIL_OilMachine_SequenceCount(_PrevCount)
AND
IntegerSum(_PrevCount,1,_NewCount)
AND
IntegertoString(_NewCount,_StrC)
THEN
NOT DB_RC_OIL_OilMachine_SequenceCount(_PrevCount);
DB_RC_OIL_OilMachine_SequenceCount(_NewCount);
DB_RC_OIL_OilMachine_Sequence(_NewCount,_Flag);

IF
GlobalFlagSet(_Flag)
AND
DB_RC_OIL_Cave_OilMachineCombination(_Flag)
AND
NOT DB_RC_OIL_OilMachine_SequenceCount(_)
THEN
DB_RC_OIL_OilMachine_SequenceCount(1);
DB_RC_OIL_OilMachine_Sequence(1,_Flag);

IF
DB_RC_OIL_OilMachine_Sequence(_Count,_Flag)
AND
SysCount("DB_RC_OIL_OilMachine_Sequence",2,3)
THEN
Proc_RC_OIL_FourthHouse_CheckLevers();

PROC
Proc_RC_OIL_FourthHouse_CheckLevers()
AND
DB_RC_OIL_OilMachine_Sequence(1,"RC_OIL_FourthHouse_2")
AND
DB_RC_OIL_OilMachine_Sequence(2,"RC_OIL_FourthHouse_4")
AND
DB_RC_OIL_OilMachine_Sequence(3,"RC_OIL_FourthHouse_1")
THEN
ProcRemoveAllDialogEntriesForSpeaker(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb);
Transform(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"debfc181-2d37-40d9-ac08-47871569fd10",1);
GlobalSetFlag("RC_OIL_FouthHouse_DisablePump");
PROC_StopLoopEffect(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"RC_OIL_Cave_OilMachineSpark");

PROC
Proc_RC_OIL_FourthHouse_CheckLevers()
AND
GlobalGetFlag("RC_OIL_FouthHouse_DisablePump",0)
AND
DB_RC_OIL_OilMachine_Sequence(_Count,_Flag)
THEN
NOT DB_RC_OIL_OilMachine_Sequence(_Count,_Flag);

PROC
Proc_RC_OIL_FourthHouse_CheckLevers()
AND
GlobalGetFlag("RC_OIL_FouthHouse_DisablePump",0)
AND
DB_RC_OIL_OilMachine_SequenceCount(_Count)
THEN
NOT DB_RC_OIL_OilMachine_SequenceCount(_Count);

IF
DialogEnded("RC_OIL_Cave_OilMachine",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"RC_OIL_FourthHouse_PumpVB",1)
THEN
Proc_StartDialog(1,"RC_OIL_VB_OilMachine_WrongSequence",_Player);
ObjectClearFlag(_Player,"RC_OIL_FourthHouse_PumpVB");

IF
DialogEnded("RC_OIL_Cave_OilMachine",_ID)
AND
GlobalGetFlag("RC_OIL_FouthHouse_DisablePump",1)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
Proc_StartDialog(1,"RC_OIL_VB_OilMachine_Repaired",_Player);

IF
GlobalFlagSet("RC_OIL_FourthHouse_Purge")
AND
GetPosition(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,_X,_Y,_Z)
THEN
PlaySound(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"SE_RC_Oil_Machine_Explode");
ItemSetCanInteract(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,0);
PlayScaledEffectAtPosition("RS3_FX_GP_Impacts_ArrowFire_01",2.0,_X,_Y,_Z);
PlayScaledEffectAtPosition("RS3_FX_GP_ScriptedEvent_RC_Oil_Machine_Failure_01",2.0,_X,_Y,_Z);
PROC_LoopEffect("RS3_FX_Environment_Smoke_Chimney_01",ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,"RC_OIL_Cave_OilMachineSmoke","RC_Main","");

IF
ItemTemplateCombinedWithItemTemplate("PUZ_OIL_Machines_A_debfc181-2d37-40d9-ac08-47871569fd10",_,_,_,_,_Player,_Item)
AND
GetTemplate(_Item,"CONT_Barrel_Oil_A_1b34b32c-e96c-404e-90cc-054cb549c558")
AND
GetPosition(ITEMGUID_S_RC_OIL_Cave_OilMachine_5c41bb49-8b62-47d6-a71e-9b3aa744cbcb,_X,_Y,_Z)
THEN
PlayScaledEffectAtPosition("RS3_FX_GP_ScriptedEvent_RC_Oil_Machine_Failure_01",2.5,_X,_Y,_Z);
Proc_ShakeCameraForTime(_Player,1000);

IF
GameBookInterfaceClosed(ITEMGUID_S_RC_OIL_Cave_ScholarBook_525bdb32-bb57-4b26-adbf-c2e20d356943,_Player)
AND
UserGetFlag(_Player,"RC_OIL_Cave_MachineBook",0)
THEN
UserSetFlag(_Player,"RC_OIL_Cave_MachineBook");
Proc_StartDialog(1,"RC_OIL_VB_CaveOilMachineInfo",_Player);

//END_REGION


PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_OIL_Cave_WallOfBarrels_9245511c-8153-489c-af5e-3693631c3d55)
THEN
Proc_StartDialog(1,"RC_OIL_VB_WallOfBarrels",_Player);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
