Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(RC_FTJ_Brute_001_94131f94-2152-49f2-8ee2-9832263eec05,"FTJ_BruteLeader");
DB_Dialogs(RC_FTJ_Brute_002_e3ec4f83-ddef-4f10-8c71-5a022b571dad,"FTJ_BruteOneLiner_001");
DB_Dialogs(RC_FTJ_Brute_003_75c00f7f-f7ff-4227-bbe8-fe2a28fcb11c,"FTJ_BruteOneLiner_002");
DB_Dialogs(RC_FTJ_OlgoGuard_001_59786a5f-a665-498c-8bf3-ecb9e6cd69dc,"FTJ_GhettoBossGuard_001");
DB_Dialogs(RC_FTJ_OlgoGuard_003_59fc99da-4c46-41d1-a467-1edbf5615921,"FTJ_GhettoBossGuard_003");
DB_Dialogs(RC_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_GhettoBossGuard_004");
DB_Dialogs(RC_FTJ_OlgoGuard_005_6cad1eb7-7d14-45e0-af87-0ea519aa5887,"FTJ_GhettoBossGuard_005");
DB_Dialogs(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,"FTJ_BlackMarketDealer");
DB_Dialogs(RC_FTJ_PatrolBrute_001_99972d67-0efe-42f9-af2b-d8e3249e0af0,"FTJ_PatrolBrute_001");
DB_Dialogs(RC_FTJ_PatrolBrute_002_9f2fb476-2a2a-408a-88f2-628518b4deba,"FTJ_PatrolBrute_002");
DB_Dialogs(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,"FTJ_GhettoBoss");
//ProcCharacterDisableCrime(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,"Assault");
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_Brute_001_94131f94-2152-49f2-8ee2-9832263eec05);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_Brute_002_e3ec4f83-ddef-4f10-8c71-5a022b571dad);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_Brute_003_75c00f7f-f7ff-4227-bbe8-fe2a28fcb11c);
DB_FTJ_Brutes((CHARACTERGUID)S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_OlgoGuard_001_59786a5f-a665-498c-8bf3-ecb9e6cd69dc);
DB_FTJ_Brutes((CHARACTERGUID)S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_OlgoGuard_003_59fc99da-4c46-41d1-a467-1edbf5615921);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c);
DB_FTJ_Brutes((CHARACTERGUID)RC_FTJ_OlgoGuard_005_6cad1eb7-7d14-45e0-af87-0ea519aa5887);

DB_HasStoryEvent((ITEMGUID)S_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3,"RC_FTJ_HasOlgoOranges");
DB_HasStoryEvent((ITEMGUID)S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,"RC_FTJ_HasOlgoDrugs");
DB_HasStoryEvent((ITEMGUID)S_FTJ_OlgoKeyToCellar_6901a093-31b1-4da6-8c72-949acc4a4946,"RC_FTJ_HasOlgoKey");
DB_HasStoryEvent((ITEMGUID)ITEMGUID_S_FTJ_ButtterDiary_14b2bf9d-3542-4557-a88c-ea082534ed86,"FTJ_HasButterDiary");
DB_DeadEvent(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,"FTJ_AmyroDead");

DB_FTJ_Brutes_DrudanaeInOrange(1);

ItemToInventory(ITEMGUID_S_FTJ_ButtterDiary_14b2bf9d-3542-4557-a88c-ea082534ed86,CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c);

Proc_RegisterPartyDecisionDialogOutcomes_Fixed("FTJ_PDD_GhettoBoss","FTJ_PDD_GhettoBoss_Tell","FTJ_PDD_GhettoBoss_Shutup","","","");

ProcCharacterDisableAllCrimes(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b);
ProcCharacterEnableCrime(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,"Assault");
DB_IsNotMessingAround(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b);
Proc_FTJ_BrutesStart();
//http://fileserver-dmz/mediawiki/index.php/Olgo_-_Saheila_Quest
KBSECTION
PROC
Proc_FTJ_BrutesStart()
THEN
ItemToInventory(S_FTJ_OlgoKeyToCellar_6901a093-31b1-4da6-8c72-949acc4a4946,S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,1);
ItemSetOwner(RC_FTJ_ImprissonedSkepticCageDoor_a4de2766-b580-4db4-b8a0-ad906fdca96b,S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd);
SetOnStage(RC_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,0);

IF
ObjectFlagSet("FTJ_LizardDreamerGiveSuppliesToPlayer",_Player,_)
THEN
ItemToInventory(RC_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3,_Player,1);

IF
CharacterDying(RC_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4)
THEN
GlobalSetFlag("FTJ_LizardDreamerIsDead");

//REGION Imprisoned Skeptic Interactions
//interrupt player if they try to talk to imprissoned while Olgo is looking
IF
DialogStartRequested(RC_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Player)
AND
GlobalGetFlag("FTJ_ImprissonedSkepticFreed",0)
AND
CharacterCanSee(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player,1)
AND
CharacterIsDead(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,0)
AND
CharacterIsInCombat(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,0)
AND
QueryOnlyOnce("OlgoDoInterrupt")
THEN
ProcForceStopDialog(_Player);
ProcForceStopDialog(RC_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a);
ProcForceStopDialog(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd);
Proc_StartDialog(0,"FTJ_GhettoBossInterruptPrisoner",S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,RC_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Player);

IF
DialogEnded("FTJ_GhettoBossInterruptPrisoner",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_BrutesGoHostileToCharacter",1)
THEN
ProcSetHostileToIndivPlayer(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player);


//If player tries to attack or teleport imprisonned out of cage, then attack them
IF
CharacterUsedSkillOnTarget(_Player,S_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_,"Teleportation",_)
AND
DB_IsPlayer(_Player)
AND
DB_FTJ_Brutes(_Brute)
AND
CharacterCanSee(_Brute,_Player,1)
AND
GlobalGetFlag("FTJ_ClearAmyroDoorOwnership",0)
THEN
ProcSetHostileToIndivPlayer(_Brute,_Player);

IF
AttackedByObject(S_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
DB_FTJ_Brutes(_Brute)
AND
CharacterCanSee(_Brute,_Player,1)
AND
GlobalGetFlag("FTJ_ClearAmyroDoorOwnership",0)
THEN
ProcSetHostileToIndivPlayer(_Brute,_Player);

//REGION Healing Amyro, do Warning, then combat
IF
CharacterStatusApplied(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Status,(CHARACTERGUID)_Player)
AND 
QRY_IsHealingStatus(_Status)
AND
CharacterIsPartyMember(_Player,1)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player)
AND
GlobalGetFlag("FTJ_ClearAmyroDoorOwnership",0)
AND
DB_FTJ_GriffDidHealingWarning(1)
THEN
ProcSetHostileToIndivPlayer(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player);


IF
CharacterStatusApplied(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Status,(CHARACTERGUID)_Player)
AND 
QRY_IsHealingStatus(_Status)
AND
CharacterIsPartyMember(_Player,1)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player)
AND
GlobalGetFlag("FTJ_ClearAmyroDoorOwnership",0)
AND
NOT DB_FTJ_GriffDidHealingWarning(1)
THEN
DB_FTJ_GriffDidHealingWarning(1);
RemoveStatus(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Status);
Proc_StartDialog(0,"FTJ_GhettoBossHealWarning",CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,_Player);

///Check Hostility towards Amyro if the Brutes see him leaving without having been released by Griff
IF
StoryEvent(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,"FTJ_AmyroBruteHostilityCheck")
AND
GlobalGetFlag("FTJ_ClearAmyroDoorOwnership",0)
AND
DB_FTJ_Brutes(_Brute)
AND
CharacterCanSee(_Brute,CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,1)
THEN
ProcForceStopDialog(_Brute);
Proc_CharacterSetTemporaryHostileRelation(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a,_Brute);

//END_REGION

//END_REGION

IF
ObjectFlagSet("FTJ_OrangesToOlgo", CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd, _ID)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
AND
QryTakeItemFromMagicPockets(_Player,(ITEMGUID)RC_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3,S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd)
THEN
DB_NOOP(1);

IF
ObjectFlagSet("FTJ_DrugsToOlgo", CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd, _ID)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
AND
QryTakeItemFromMagicPockets(_Player,(ITEMGUID)RC_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096, S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd)
THEN
DB_NOOP(1);

// Keep track of whether the drugs are in the orange
IF
ItemRemovedFromContainer(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,ITEMGUID_S_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3)
THEN
NOT DB_FTJ_Brutes_DrudanaeInOrange(1);

IF
ItemAddedToContainer(ITEMGUID_S_FTJ_OlgoDrugs_7a4769d5-c45b-49c1-a22b-5121073c6096,ITEMGUID_S_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3)
THEN
DB_FTJ_Brutes_DrudanaeInOrange(1);

//player opened oranges and found drugs (can't destroy oranges, because it's a story item)
IF
CharacterUsedItem(_Player,RC_FTJ_OlgoOranges_c5d71987-c3ee-4775-a7b9-807461de56a3)
AND
DB_FTJ_Brutes_DrudanaeInOrange(1)
THEN
Proc_FTJ_FoundDrudanae(_Player);

PROC
Proc_FTJ_FoundDrudanae((CHARACTERGUID)_Player)
THEN
UserSetFlag(_Player,"FTJ_PlayerKnowsAboutDrugs");

PROC
Proc_FTJ_FoundDrudanae((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_FTJ_OlgoSaheila_FoundDrugs",0)
AND
UserGetFlag(_Player,"FTJ_OlgoGaveQuest",1)
AND
GlobalGetFlag("FTJ_OlgoQuestResolved",0)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd, "FTJ_DrugsToOlgo",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_OlgoSaheila_FoundDrugs");
ProcDefineReflectionDialog("FTJ_RD_FoundDrudanae",_Player);
Proc_RC_FTJ_RemoveRDFromNotOnGriffQuest();

PROC
Proc_RC_FTJ_RemoveRDFromNotOnGriffQuest()
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"FTJ_OlgoGaveQuest",0)
AND
DB_ReflectionDialogs_Queued(_Player,_ReflectionDialog)
THEN
Proc_ReflectionDialog_CancelForPlayer(_Player);

IF 
ObjectFlagSet("FTJ_OlgoReleasePrisoner",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player2)
THEN
ProcHideMarker(_Player2,"RC_FTJ_Olgo");
DB_FTJ_OlgoReleasePrisoner(1);

//REGION Dreamer assassinate
IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_SendAssassin")
AND
CharacterIsDead(RC_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,0)
AND
QueryOnlyOnce("FTJ_SendAssassin")
THEN
CharacterAppearOutOfSightTo(RC_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,_Player,1,0,"");
CharacterSetForceSynch(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,1);
SetScriptframe(RC_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,"KillDreamer");

IF
TextEventSet("AssassinTest")
AND
CharacterGetHostCharacter((CHARACTERGUID)_Player)
THEN
SetStoryEvent((CHARACTERGUID)_Player,"FTJ_SendAssassin");
CharacterAttack(_Player,CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b);

IF
AutomatedDialogEnded("FTJ_AD_BruteAssassin",_)
THEN
RemoveStatus(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,"LYING");
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,0);
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,0);

//check for Players who helped Stingtail against Silence
IF
ObjectEnteredCombat(_Player,_ID)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,_ID)
THEN
ObjectSetFlag(_Player,"FTJ_DefendedStingtail");

IF
ObjectEnteredCombat(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b,_ID)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_CombatCharacters(_Player,_ID)
THEN
ObjectSetFlag(_Player,"FTJ_DefendedStingtail");

//If Stingtail goes hostile to someone who defended him, clear the flag
IF
CharacterRelationChangedTo(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4,_Player,0)
AND
ObjectGetFlag(_Player,"FTJ_DefendedStingtail",1)
THEN
ObjectClearFlag(_Player,"FTJ_DefendedStingtail",0);

//XP for party who helped stingtail
IF
DialogEnded("FTJ_LizardDreamer",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
DialogGetLocalFlag(_ID,"ThankDefender",1)
AND
QueryOnlyOnce("FTJ_StingtailThankDefender_Once")
THEN
CharacterAddGold(_Player,35);
PartyAddExperience(_Player,1,3,5);


//END_REGION


//REGION Marked Crate

IF
CharacterUsedItem(_Char,RC_FTJ_StolenCrateOfGoods_1a8dd23b-8a45-45a1-905a-7b6494405860)
AND
UserGetFlag(_Char,"FTJ_OlgoGaveQuest",1)
AND
UserGetFlag(_Char,"FTJ_KnowMarkedCrateIsEmpty",0)
THEN
StartVoiceBark("FTJ_VB_GhettoBossCrate",_Char);

IF
CharacterUsedItem(_Char,RC_FTJ_StolenCrateOfGoods_1a8dd23b-8a45-45a1-905a-7b6494405860)
THEN
UserSetFlag(_Char,"FTJ_KnowMarkedCrateIsEmpty");
UserSetFlag(_Char,"QuestUpdate_RC_FTJ_OlgoSaheila_CrateFound");


//END_REGION


IF
DialogEnded("FTJ_GhettoBoss",_)
AND
DB_FTJ_OlgoReleasePrisoner(1)
THEN
ProcCharacterMoveTo(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,RC_FTJ_ImprissonedSkepticCageDoor_a4de2766-b580-4db4-b8a0-ad906fdca96b,0,"FTJ_OpenImprissonedSkepticCage");
NOT DB_FTJ_OlgoReleasePrisoner(1);

IF
StoryEvent((CHARACTERGUID)S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,"FTJ_OpenImprissonedSkepticCage")
THEN
ItemUnLock(RC_FTJ_ImprissonedSkepticCageDoor_a4de2766-b580-4db4-b8a0-ad906fdca96b);
ItemOpen(RC_FTJ_ImprissonedSkepticCageDoor_a4de2766-b580-4db4-b8a0-ad906fdca96b);
GlobalSetFlag("FTJ_ClearAmyroDoorOwnership");


IF
GlobalFlagSet("FTJ_ClearAmyroDoorOwnership")
THEN
ItemClearOwner(RC_FTJ_ImprissonedSkepticCageDoor_a4de2766-b580-4db4-b8a0-ad906fdca96b);



//REGION Black Market Dealer
IF 
ObjectFlagSet("FTJ_BlackMarketA",_Player,_)
THEN 
DB_FTJ_BlackMarketWontSell(_Player);
CharacterSetCanTrade(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,0);

IF 
ObjectFlagSet("FTJ_BlackMarketDiscount",(CHARACTERGUID)_Player,_)
THEN 
PartySetShopPriceModifier(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,_Player,75);

PROC
PROC_GLOBAL_DialogStartRequested(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,_Player)
AND
DB_FTJ_BlackMarketWontSell(_Player)
THEN
CharacterSetCanTrade(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,0);

PROC
PROC_GLOBAL_DialogStartRequested(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,_Player)
AND
NOT DB_FTJ_BlackMarketWontSell(_Player)
THEN
CharacterSetCanTrade(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671,1);

////END_REGION

//REGION Butters Diary
IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_ButterDiary_14b2bf9d-3542-4557-a88c-ea082534ed86)
THEN
OpenCustomBookUI(_Player,"FTJ_ButterDiaryBase");

IF
ObjectFlagSet("FTJ_SeducedButter",_,_)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_HasButterDiary",1)
THEN
AddEntryToCustomBook("FTJ_ButterDiaryBase","FTJ_ButterDiaryPositive");

IF
ObjectFlagSet("FTJ_SeducedButter",_,_)
THEN
GlobalSetFlag("ARX_ButterIsWaiting");

IF
ObjectFlagSet("FTJ_OlgoGuard_004_AnswerB",_,_)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_HasButterDiary",1)
THEN
AddEntryToCustomBook("FTJ_ButterDiaryBase","FTJ_ButterDiaryNegative");

//END_REGION


IF
CharacterDied(CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd)
THEN
GlobalSetFlag("FTJ_GriffDead");
ProcFTJUpdateSaheilaQuestforPlayers("GriffDead");

IF
CharacterDied(CHARACTERGUID_S_FTJ_ImprisonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a)
THEN
ProcFTJUpdateSaheilaQuestforPlayers("AmyroDead");
ObjectSetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"QuestUpdate_FTJ_OriginRedPrince_AmyroDead");

PROC
ProcFTJUpdateSaheilaQuestforPlayers((STRING)_Update)
AND
StringConcatenate("QuestUpdate_RC_FTJ_OlgoSaheila_",_Update,_Flag)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestAdd_RC_FTJ_OlgoSaheila",1)
THEN
ObjectSetFlag(_Player,_Flag);

//REGION Butter Interaction if seduced

IF
AttackedByObject(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,_Player,_Attacker,_,_)
AND
CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c != _Attacker
AND
ObjectGetFlag(_Player,"FTJ_SeducedButter",1)
THEN
ObjectClearFlag(_Player,"FTJ_SeducedButter",0);

IF
ObjectTurnStarted(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c, _Id)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_CombatCharacters(_Player, _CombatId)
AND
_Id == _CombatId
AND
ObjectGetFlag(_Player,"FTJ_SeducedButter",1)
AND
CharacterGetRelationToCharacter(_Player,CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,0)
THEN
Proc_FTJ_ButterJoinsPlayerInCombat(_Player);

IF
ObjectEnteredCombat(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,_Id)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_CombatCharacters(_Player, _CombatId)
AND
_Id == _CombatId
AND
ObjectGetFlag(_Player,"FTJ_SeducedButter",1)
AND
CharacterGetRelationToCharacter(_Player,CHARACTERGUID_S_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd,0)
THEN
Proc_FTJ_ButterJoinsPlayerInCombat(_Player);

PROC
Proc_FTJ_ButterJoinsPlayerInCombat((CHARACTERGUID)_Player)
THEN
SetFaction(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_Brutes_Butter");
CharacterSetRelationIndivFactionToIndivFaction(_Player,CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,100);
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,_Player,100);
CharacterSetRelationIndivFactionToFaction(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_Brutes",0);
CharacterSetRelationFactionToIndivFaction("FTJ_Brutes",CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,0);
ObjectSetFlag(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_ButterHelpedFightBrutes");
SetVarString(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"AD","");

IF
TextEventSet("FTJ_SeducedButter")
AND
CharacterGetHostCharacter((CHARACTERGUID)_Player)
THEN
ObjectSetFlag(_Player,"FTJ_SeducedButter");

IF
ObjectTurnStarted(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c,"FTJ_ButterHelpedFightBrutes",1)
AND
QueryOnlyOnce("FTJ_AD_ButterHelpsPlayer_Once")
THEN
Proc_StartDialog(1,"FTJ_AD_ButterHelpsPlayer",CHARACTERGUID_S_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c);

//END_REGION

//REGION DOS2EE-3118 savegame hack

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 5, 1, 0)
AND
NOT DB_QuestDef_State("RC_FTJ_OlgoSaheila","CloseLeftFortJoySaheila")
AND
NOT DB_QuestDef_CloseAtRegionEnded_Conditions_TrueGlobalFlag_FalseUserFlag("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoySaheila","FJ_FortJoy_Main","FTJ_ImprissonedSkepticFreed","QuestUpdate_RC_FTJ_OlgoSaheila_SaheilaThanks")
AND
DB_QuestDef_CloseAtRegionEnded_Condition_FalseGlobalFlag_OrClose("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoy","FJ_FortJoy_Main","FTJ_ImprissonedSkepticFreed")
THEN
DB_QuestDef_State("RC_FTJ_OlgoSaheila","CloseLeftFortJoySaheila");
DB_QuestDef_CloseAtRegionEnded_Conditions_TrueGlobalFlag_FalseUserFlag("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoySaheila","FJ_FortJoy_Main","FTJ_ImprissonedSkepticFreed","QuestUpdate_RC_FTJ_OlgoSaheila_SaheilaThanks");
NOT DB_QuestDef_CloseAtRegionEnded_Condition_FalseGlobalFlag_OrClose("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoy","FJ_FortJoy_Main","FTJ_ImprissonedSkepticFreed");
DB_QuestDef_CloseAtRegionEnded_Condition_FalseGlobalFlag("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoy","FJ_FortJoy_Main","FTJ_ImprissonedSkepticFreed");
DB_QuestDef_CloseEvent("RC_FTJ_OlgoSaheila","QuestUpdate_RC_FTJ_OlgoSaheila_CloseLeftFortJoySaheila");

//END_REGION


PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
