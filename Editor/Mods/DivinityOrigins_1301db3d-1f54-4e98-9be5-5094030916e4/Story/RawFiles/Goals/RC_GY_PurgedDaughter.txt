Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/purged-daughter

DB_RC_GY_PurgedDaughter_Clones((CHARACTERGUID)CHARACTERGUID_S_RC_GY_PurgedDaughter_ClonePoison_7c7c2f9e-c438-495c-bb71-ecdc551b21c5,"RS3_FX_Char_Creatures_VoidWoken_Grunt_Anguish_01","RS3_FX_Char_Creatures_VoidWoken_Grunt_Anguish_Hands_01");
DB_RC_GY_PurgedDaughter_Clones(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneIce_cb9314cf-3a24-4edf-ab89-e82c1cb31428,"RS3_FX_Char_Creatures_VoidWoken_Grunt_Despair_01","RS3_FX_Char_Creatures_VoidWoken_Grunt_Despair_Hands_01");
DB_RC_GY_PurgedDaughter_Clones(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneWarrior_62c96c68-4053-4c9c-8d85-1652a0aea44c,"RS3_FX_Char_Creatures_VoidWoken_Grunt_Fury_01","RS3_FX_Char_Creatures_VoidWoken_Grunt_Fury_Hands_01");
DB_RC_GY_PurgedDaughter_Clones(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneRogue_23595e3e-4501-4d4c-a609-d09701c308eb,"RS3_FX_Char_Creatures_VoidWoken_Grunt_Fear_01","RS3_FX_Char_Creatures_VoidWoken_Grunt_Fear_Hands_01");

SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_ClonePoison_7c7c2f9e-c438-495c-bb71-ecdc551b21c5,0);
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneIce_cb9314cf-3a24-4edf-ab89-e82c1cb31428,0);
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneWarrior_62c96c68-4053-4c9c-8d85-1652a0aea44c,0);
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_CloneRogue_23595e3e-4501-4d4c-a609-d09701c308eb,0);


ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_House_df3de883-553c-4de1-ab7d-7f990c29f6a1);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_Basement_8059a36e-6ce9-402a-970f-2e3ee98e0ea5);

DB_Dialogs(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_Father");
DB_Dialogs(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"");
DB_Ghosts(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,CHARACTERGUID_S_RC_GY_PurgedDaughter_Ghost_e2942af9-57ca-47c8-aef4-e38b6f726fd9,"RC_GY_PurgedDaughter_Ghost");

DB_NoLowAttitudeDialog(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);

DB_SneakTriggerSpotter(TRIGGERGUID_S_RC_GY_PurgedDaughter_SpotSneakerTrigger_93ec6646-f031-4e51-94ae-74c00397799a,CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);
PROC_LoopEffect("RS3_FX_GP_Status_HoECollar_01",CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_SourceCollar","RC_Main","Dummy_NeckFX");
ApplyStatus(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"SOURCE_MUTED",-1.0,1);

CharacterSetCanTrade(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,0);
ItemToInventory(ITEMGUID_S_RC_GY_PurgedDaughter_CellarKey_cb9c498a-92ef-4813-9aae-7cc3f54cad72,CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15);

DB_RC_GY_PurgedDaughter_HouseDoors((ITEMGUID)ITEMGUID_S_RC_GY_PurgedDaughter_FrontDoor_5f0382bf-9aea-430e-958c-1661b7d5bed2);
DB_RC_GY_PurgedDaughter_HouseDoors(ITEMGUID_S_RC_GY_PurgedDaughter_BackDoor_5dd18cf7-67fd-4b70-876f-575c3c6f0ed3);

DB_GLO_Attribute_Check_AgainstSpeaker("RC_GY_PurgedDaughter",1,"Memory","Easy",3,1);
DB_GLO_Attribute_Check_AgainstSpeaker("RC_GY_PurgedDaughter",2,"Wits","Easy",3,1);
DB_GLO_Attribute_Check_AgainstSpeaker("RC_GY_PurgedDaughter",3,"Intelligence","Easy",3,1);

SetOnStage(ITEMGUID_S_RC_GY_PurgedDaughter_Grave_6c773e2c-fca7-4453-a6e6-013117494ad4,0);

Proc_RC_GY_PurgedDaughter_CellarCorpseLie();
KBSECTION
//REGION Debug
IF
TextEventSet("pdref")
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_,_)
THEN
Foop(_Clone);
ApplyStatus(_Clone, "ETHEREAL_SOLES", -1.0);

IF
TextEventSet("daughterOperate")
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("DaughterOperateDebug")
THEN
CharacterSetHitpointsPercentage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,100.0);
PartySetFlag(_Player,"RC_GY_PurgedDaughter_DecidedToOperate",1);
SetCanFight(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);
SetCanJoinCombat(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);
ApplyDamage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,400,"Physical");
Proc_RC_GY_PurgedDaughter_CheckForSurgery();

IF
TextEventSet("fatherToCellar")
AND
DB_IsPlayer(_Player)
THEN
ItemUnlockAndOpen(ITEMGUID_S_RC_GY_PurgedDaughter_FrontDoor_5f0382bf-9aea-430e-958c-1661b7d5bed2);
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar");
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherIsInCellar");
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerProblem");
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerGaveQuest");
TeleportTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,TRIGGERGUID_S_RC_GY_PurgedDaughter_FatherCellarPoint_c164db7a-6c14-44f1-a981-2ca89ee956b0);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerWandering",0);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerCellarWaiting",400);

//END_REGION

//REGION Corpse On A Bed
PROC
Proc_RC_GY_PurgedDaughter_CellarCorpseLie()
THEN
CharacterUseItem(CHARACTERGUID_S_RC_GY_PurgedDaughter_CellarCorpse_898a8f7f-34ae-4d10-89b0-eace8a7320c5,ITEMGUID_S_RC_GY_PurgedDaughter_CorpseBed_18845ca2-9a42-472d-a969-560527827d90,"RC_GY_PurgedDaughter_CellarCorpseOnBed");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_CellarCorpse_898a8f7f-34ae-4d10-89b0-eace8a7320c5,"RC_GY_PurgedDaughter_CellarCorpseOnBed")
THEN
CharacterDie(CHARACTERGUID_S_RC_GY_PurgedDaughter_CellarCorpse_898a8f7f-34ae-4d10-89b0-eace8a7320c5,0,"Physical");
//END_REGION

//REGION Father allowed to enter cellar
IF
DialogEnded("RC_GY_PurgedDaughter_Father",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
DB_RC_GY_PurgedDaughter_HouseDoors(_Door)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_FatherGivesKeyToPlayer")
THEN
ItemToInventory(ITEMGUID_S_RC_GY_PurgedDaughter_CellarKey_cb9c498a-92ef-4813-9aae-7cc3f54cad72,_Player);
ItemClearOwner(ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1);
ItemClearOwner(_Door);
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerGaveQuest");

IF
ItemRemovedFromCharacter(ITEMGUID_S_RC_GY_PurgedDaughter_CellarKey_cb9c498a-92ef-4813-9aae-7cc3f54cad72,CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherHasNoKey");

IF
DialogEnded("RC_GY_PurgedDaughter_Father",_ID)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
DB_RC_GY_PurgedDaughter_HouseDoors(_Door)
AND
ItemIsLocked(_Door,0)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_FatherRunToCellar")
THEN
DialogRequestStop(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15);
ProcCharacterMoveTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1,1,"RC_GY_PurgedDaughter_FatherGotToHatch");

IF
ItemUnlocked(_Door,_Player,_)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
DB_RC_GY_PurgedDaughter_HouseDoors(_Door)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_FatherRunToCellar")
THEN
DialogRequestStop(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15);
ProcCharacterMoveTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1,1,"RC_GY_PurgedDaughter_FatherGotToHatch");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherGotToHatch")
THEN
ItemUnLock(ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1);
CharacterUseItem(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1,"RC_GY_PurgedDaughter_FatherEnteredCellar");
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherIsInCellar");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherEnteredCellar")
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,TRIGGERGUID_S_RC_GY_PurgedDaughter_FatherCellarPoint_c164db7a-6c14-44f1-a981-2ca89ee956b0,1,"");
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerWandering",0);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerCellarWaiting",400);

//END_REGION

//REGION Daughter Dialog Starts
PROC
ProcCharInTriggerSpotted(_Player,TRIGGERGUID_S_RC_GY_PurgedDaughter_SpotSneakerTrigger_93ec6646-f031-4e51-94ae-74c00397799a)
THEN
Proc_RC_GY_PurgedDaughter_ThreeWayDialog(_Player);

PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_Player)
AND
GlobalGetFlag("RC_GY_PurgedDaughter_GirlLives",0)
THEN
Proc_RC_GY_PurgedDaughter_ThreeWayDialog((CHARACTERGUID)_Player);

PROC
Proc_RC_GY_PurgedDaughter_ThreeWayDialog((CHARACTERGUID)_Player)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,0)
AND
QRY_IsInRange(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,_Player,20.0)
THEN
Proc_StartDialog(0,"RC_GY_PurgedDaughter",CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,_Player);
GlobalSetFlag("RC_GY_PurgedDaughter_DialogWithHealerPresent");

PROC
Proc_RC_GY_PurgedDaughter_ThreeWayDialog((CHARACTERGUID)_Player)
THEN
Proc_StartDialog(0,"RC_GY_PurgedDaughter",CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,NULL_00000000-0000-0000-0000-000000000000,_Player);

IF
DialogEnded("RC_GY_PurgedDaughter",_ID)
AND
DB_GlobalFlag("RC_GY_PurgedDaughter_DialogWithHealerPresent")
THEN
GlobalClearFlag("RC_GY_PurgedDaughter_DialogWithHealerPresent");

//END_REGION

//REGION Daughter combat
IF
AttackedByObject(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_Player,_Attacker,_,_)
AND
_Attacker != CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_DoAttackFlow")
THEN
SetStoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_AttackFlow");
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_Attack");
Proc_RC_GY_PurgedDaughter_AttackFlow();

IF
DialogEnded("RC_GY_PurgedDaughter",_ID)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_Attack",1)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_DoAttackFlow")
THEN
Proc_RC_GY_PurgedDaughter_AttackFlow();

PROC
Proc_RC_GY_PurgedDaughter_AttackFlow()
THEN
SetHasDialog(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0);
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"");
PlayAnimation(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"stillmental","RC_GY_PurgedDaughter_EngageCombat");
PlayEffect(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RS3_FX_Char_Animals_Crocodile_A_ScalePortation_Disappear_01");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_EngageCombat")
THEN
SetRelationFactionToPlayers("RC_GY_PurgedDaughter",0);
ItemTemplateAddTo("RC_FTJ_Amulet_BrokenSourceCollar_6a906795-b26f-47fd-90ab-ed1916f5b18f",CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);
PROC_StopLoopEffect(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_SourceCollar");
RemoveStatus(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"SOURCE_MUTED");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_EngageCombat")
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_FxDummy,_FxHand)
THEN
Foop(_Clone);
ApplyStatus(_Clone, "ETHEREAL_SOLES", -1.0);
PROC_LoopEffect(_FxDummy,_Clone,"RC_GY_PurgedDaughter_CloneDummyFX","RC_Main","Dummy_StatusFX");
PROC_LoopEffect(_FxHand,_Clone,"RC_GY_PurgedDaughter_CloneLHandFX","RC_Main","Dummy_L_HandFX");
PROC_LoopEffect(_FxHand,_Clone,"RC_GY_PurgedDaughter_CloneRHandFX","RC_Main","Dummy_R_HandFX");

IF
CharacterDying(_Clone)
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_FxDummy,_FxHand)
THEN
PROC_StopLoopEffect(_Clone,"RC_GY_PurgedDaughter_CloneDummyFX");
PROC_StopLoopEffect(_Clone,"RC_GY_PurgedDaughter_CloneLHandFX");
PROC_StopLoopEffect(_Clone,"RC_GY_PurgedDaughter_CloneRHandFX");
NOT DB_RC_GY_PurgedDaughter_Clones(_Clone,_FxDummy,_FxHand);
Poof(_Clone);

IF
CharacterDied(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15)
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerDied");

IF
CharacterDied(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964)
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_,_)
THEN
PlayEffect(_Clone,"RS3_FX_Skills_Fire_Haste_Impact_Root_01");
ApplyStatus(_Clone,"ENRAGED",-1.0,1);
ApplyStatus(_Clone,"HASTED",-1.0,1);

IF
CharacterStatusApplied(_Clone,"ENRAGED",_)
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_,_)
AND
QueryonlyOnce("RC_GY_PurgedDaughter_CloneAD")
THEN
Proc_StartDialog(1,"RC_GY_AD_PurgedDaughter_CloneFree",_Clone);

IF
CharacterDied(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",0)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_GY_PurgedDaughter_Basement_8059a36e-6ce9-402a-970f-2e3ee98e0ea5)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_KilledDaughter");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_LeaveTrigger_3ff7b102-6cbe-4942-ad5a-4c48d516410b);

IF
CharacterDied(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_GY_PurgedDaughter_Basement_8059a36e-6ce9-402a-970f-2e3ee98e0ea5)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_KilledDaughterHealer");
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,_Player,-20);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_LeaveTrigger_3ff7b102-6cbe-4942-ad5a-4c48d516410b);

//END_REGION

//REGION Daughter combat for operation
IF
ObjectTurnEnded(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_GY_PurgedDaughter_PlayerIsDoctor",1)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_CombatID)
AND
CombatGetIDForCharacter(_Player,_CombatID)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_CombatPlan")
THEN
StartVoiceBark("RC_GY_VB_PurgedDaughter_OperationCombat",_Player);

IF
CharacterReceivedDamage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964, _, _)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_ReadyForOperation",0)
AND
DB_IsPlayer(_Player)
AND
PartyGetFlag(_Player,"RC_GY_PurgedDaughter_DecidedToOperate",1)
THEN
Proc_RC_GY_PurgedDaughter_CheckForSurgery();

PROC
Proc_RC_GY_PurgedDaughter_CheckForSurgery()
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_HpPercentage)
AND
_HpPercentage <= 50.0
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_GirlIsReady")
THEN
ApplyStatus(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"KNOCKED_DOWN",-1.0,1);
Proc_RC_GY_PurgedDaughter_KnockedOut();

IF
ObjectFlagSet("RC_GY_PurgedDaughter_ReadyForOperation",CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_)
AND
DB_RC_GY_PurgedDaughter_Clones(_Clone,_,_)
THEN
Poof(_Clone);

//END_REGION

//REGION Daughter operation
PROC
Proc_RC_GY_PurgedDaughter_KnockedOut()
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"GLO_BlockRegenAfterCombat");
SetTag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"NO_ARMOR_REGEN");
SetStoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"ClearPeaceReturn");
CharacterSetAnimationOverride(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"knockdown_loop");
SetCanFight(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0);
SetCanJoinCombat(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0);
ProcCleanUpSneakTrigger(TRIGGERGUID_S_RC_GY_PurgedDaughter_SpotSneakerTrigger_93ec6646-f031-4e51-94ae-74c00397799a);
SetRelationFactionToPlayers("RC_GY_PurgedDaughter",50);
SetVarFixedString(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"currentState","State_AfterCombat");
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_ReadyForOperation");
ProcObjectTimer(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_StartOperationDialog",2000);
SetHasDialog(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);

PROC
ProcObjectTimerFinished(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_StartOperationDialog")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_GY_PurgedDaughter_PlayerIsDoctor",1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,_Player)
THEN
Proc_RC_GY_PurgedDaughter_ThreeWayDialog(_Player);

IF
GlobalFlagSet("RC_GY_PurgedDaughter_GirlDies")
THEN
CharacterDie(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0,"DoT");

IF
DialogEnded("RC_GY_PurgedDaughter",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
GlobalGetFlag("RC_GY_PurgedDaughter_GirlLives",1)
THEN
ObjectSetFlag(_Player,"RC_GY_PurgedDaughter_UnlockGrenadeRecipe");
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);
DB_Dialogs(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_Treated");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_LeaveTrigger_3ff7b102-6cbe-4942-ad5a-4c48d516410b);
Proc_RC_GY_PurgedDaughter_FatherDoExamine();

//END_REGION

//REGION After combat
IF
DialogEnded("RC_GY_PurgedDaughter_Father",_ID)
THEN
Proc_RC_GY_PurgedDaughter_FatherDoExamine();

PROC
Proc_RC_GY_PurgedDaughter_FatherDoExamine()
AND
GlobalGetFlag("RC_GY_PurgedDaughter_GirlLives",1)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherJoinInCellar",1)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherStartExamine",0)
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherStartExamine");

PROC
Proc_RC_GY_PurgedDaughter_FatherDoExamine()
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherStartExamine",1)
AND
QueryOnlyOnce("RC_GY_PurgedDaughter_FatherDoExamine")
THEN
ItemClearOwner(ITEMGUID_S_RC_GY_PurgedDaughter_Hatch_60e52d23-4817-4d0c-9d7c-b82c8cb0fcf1);
ItemClearOwner(ITEMGUID_S_RC_GY_PurgedDaughter_FrontDoor_5f0382bf-9aea-430e-958c-1661b7d5bed2);
CharacterPurgeQueue(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15);
SetScriptframe(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerExamine");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerHasSaidAD")
THEN
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15);
DB_Dialogs(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherTrader");
CharacterSetCanTrade(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,1);

IF
ObjectFlagSet("RC_GY_PurgedDaughter_UnlockGrenadeRecipe",(CHARACTERGUID)_Player,_)
THEN
CharacterUnlockRecipe(_Player,"GRN_Ingredient_Round_Empty_MindMaggots",1);

//END_REGION

//REGION Cleanup after player leaving
IF
CharacterLeftTrigger(_Player,TRIGGERGUID_S_RC_GY_PurgedDaughter_LeaveTrigger_3ff7b102-6cbe-4942-ad5a-4c48d516410b)
AND
QRY_AnyRegionActive()
AND
NOT DB_InRegion(_,TRIGGERGUID_S_RC_GY_PurgedDaughter_Basement_8059a36e-6ce9-402a-970f-2e3ee98e0ea5)
AND
NOT DB_InRegion(_,TRIGGERGUID_S_RC_GY_PurgedDaughter_House_df3de883-553c-4de1-ab7d-7f990c29f6a1)
AND
NOT DB_InRegion(_,TRIGGERGUID_S_RC_GY_SUB_Graveyard_59ac9cef-edf4-492f-906c-fbde552e68d3)
THEN
Proc_RC_GY_PurgedDaughter_AfterEffects(_Player);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_GY_PurgedDaughter_LeaveTrigger_3ff7b102-6cbe-4942-ad5a-4c48d516410b);

PROC
Proc_RC_GY_PurgedDaughter_AfterEffects((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerDied",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_OperationSuccessful",1)
THEN
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0);

PROC
Proc_RC_GY_PurgedDaughter_AfterEffects((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_HealerDied",0)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_OperationSuccessful",1)
THEN
Proc_RC_GY_PurgedDaughter_DaughterLives();
Proc_RC_GY_PurgedDaughter_FatherMoveOutOfCellar();


PROC
Proc_RC_GY_PurgedDaughter_AfterEffects((CHARACTERGUID)_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_KilledDaughterHealer",1)
THEN
Proc_RC_GY_PurgedDaughter_DaughterDied();
Proc_RC_GY_PurgedDaughter_FatherMoveOutOfCellar();

IF
ObjectFlagSet("QuestUpdate_RC_GY_PurgedDaughter_ToldHealerOfLife",(CHARACTERGUID)_Player,_)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,_Player,50);

IF
ObjectFlagSet("QuestUpdate_RC_GY_PurgedDaughter_ToldHealerOfDeath",(CHARACTERGUID)_Player,_)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,_Player,-50);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerWandering",0);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerSit",600);

PROC
Proc_RC_GY_PurgedDaughter_DaughterDied()
THEN
CharacterUnlinkGhost(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,CHARACTERGUID_S_RC_GY_PurgedDaughter_Ghost_e2942af9-57ca-47c8-aef4-e38b6f726fd9);
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,0);
SetOnStage(ITEMGUID_S_RC_GY_PurgedDaughter_Grave_6c773e2c-fca7-4453-a6e6-013117494ad4,1);
TeleportTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Ghost_e2942af9-57ca-47c8-aef4-e38b6f726fd9,TRIGGERGUID_S_RC_GY_PurgedDaughter_GhostPoint_62b1abb7-e160-4e94-8ae9-cbf349c292f3);
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_GhostAtGraveyard");

PROC
Proc_RC_GY_PurgedDaughter_DaughterLives()
THEN
ClearTag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"NO_ARMOR_REGEN");
ObjectClearFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"GLO_BlockRegenAfterCombat");
SetCanFight(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);
SetCanJoinCombat(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,1);
NOT DB_NoLowAttitudeDialog(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);
ProcCharacterEnableAllCrimes(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964);
ObjectSetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"RC_GY_PurgedDaughter_GettingWell");
SetVarFixedString(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,"currentState","State_PostQuest");
CharacterUseItem(CHARACTERGUID_S_RC_GY_PurgedDaughter_70f3182f-3c18-4504-9691-332d9dec7964,ITEMGUID_S_RC_GY_PurgedDaughter_Bed_27b8d750-6a50-443c-a5a7-a0839fa8e98a,"");
TeleportTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_CellarCorpse_898a8f7f-34ae-4d10-89b0-eace8a7320c5,TRIGGERGUID_S_RC_GY_PurgedDaughter_FatherCellarPoint_c164db7a-6c14-44f1-a981-2ca89ee956b0);
SetOnStage(CHARACTERGUID_S_RC_GY_PurgedDaughter_CellarCorpse_898a8f7f-34ae-4d10-89b0-eace8a7320c5,0);
ApplyStatus(ITEMGUID_S_RC_GY_PurgedDaughter_Torch_a05971f3-2ca1-46ed-a2b5-62001d6a440d,"BURNING",-1.0);
CreateSurface(TRIGGERGUID_S_RC_GY_PurgedDaughter_FatherCellarPoint_c164db7a-6c14-44f1-a981-2ca89ee956b0,"SurfaceNone",20.0,1.0);

PROC
Proc_RC_GY_PurgedDaughter_FatherMoveOutOfCellar()
AND
ObjectGetFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherIsInCellar",1)
THEN
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerCellarWaiting",0);
ProcCharacterMoveTo(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,ITEMGUID_S_RC_GY_PurgedDaughter_Ladder_7e3a004f-b129-82dd-3512-4562dbc87f19,0,"");
CharacterUseItem(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,ITEMGUID_S_RC_GY_PurgedDaughter_Ladder_7e3a004f-b129-82dd-3512-4562dbc87f19,"RC_GY_PurgedDaughter_FatherEnteredHouse");

IF
StoryEvent(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherEnteredHouse")
THEN
ObjectClearFlag(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"RC_GY_PurgedDaughter_FatherIsInCellar",0);
CharacterSetReactionPriority(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"HealerSit",600);

//END_REGION

//REGION After the quest
IF
DialogEnded("RC_GY_PurgedDaughter_FatherTrader",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"RC_GY_PurgedDaughter_HealerServices",1)
THEN
CharacterUseSkill(CHARACTERGUID_S_RC_GY_PurgedDaughter_Father_0850c066-28ee-4179-9d0a-9ceaff05bd15,"Target_FirstAidEnemy",_Player,1);
ObjectClearFlag(_Player,"RC_GY_PurgedDaughter_HealerServices",0);

//END_REGION

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_GY_PurgedDaughter_Basement_8059a36e-6ce9-402a-970f-2e3ee98e0ea5)
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_GY_PurgedDaughter_EnterCellar");
EXITSECTION
NOT DB_RC_GY_PurgedDaughter_HouseDoors(ITEMGUID_S_RC_GY_PurgedDaughter_FrontDoor_5f0382bf-9aea-430e-958c-1661b7d5bed2);
NOT DB_RC_GY_PurgedDaughter_HouseDoors(ITEMGUID_S_RC_GY_PurgedDaughter_BackDoor_5dd18cf7-67fd-4b70-876f-575c3c6f0ed3);
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
