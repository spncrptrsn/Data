Version 1
SubGoalCombiner SGC_AND
INITSECTION
//http://fileserver-dmz/mediawiki/index.php/Source_Collars

DB_GLO_SourceCollars_Region("FJ_FortJoy_Main");

DB_GLO_SourceCollars_PrisonersWithCollars((CHARACTERGUID)RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_BeachPrisoner_001_11cddbdf-40b8-4ce5-8ea8-e5f1ca8ac2e0);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_BeachPrisoner_002_dea028b6-c629-48be-b35e-e776716a8be1);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_StartingAreaChild_39cbb883-7e80-445c-b5f8-0e42d2283d73);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_BeachPrisoner_003_fea5669a-682c-4c8c-a1b9-d173f2a8b55f);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_BlackMarketDealer_7ecdfdd5-fb22-411d-9c19-0f6f62123671);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Brute_001_94131f94-2152-49f2-8ee2-9832263eec05);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Brute_002_e3ec4f83-ddef-4f10-8c71-5a022b571dad);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Brute_003_75c00f7f-f7ff-4227-bbe8-fe2a28fcb11c);
//DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_ShrineWorshipper_bd8a4344-814a-4904-8399-326a5a3f88d1);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_GhettoBlacksmith_175b32ec-f6a1-4aa1-9028-d02d593f092c);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_CourtRoomPrisoner_44d58ae4-66ab-4dfb-9f1d-0dcd59a48487);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_DoubtingPriest_a449c179-1c96-4180-91d6-cb5d6c4cb9a7);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_FalseSourcerer_d9578eb3-16fc-448c-ab38-577bd02065b3);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Human_003_8e83098f-6dd8-445d-a37b-d22be064d334);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Human_001_c36d342e-acc1-4d84-a33f-4af1f9f559a7);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Human_002_4c6af17b-a321-4cd0-b83e-ddeef7a49350);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Dwarf_001_579f0f98-e1a2-40b3-9851-b18c86945685);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Human_004_801c004b-5b7d-47d6-b389-1295905c4c2a);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_GhettoNPC_Human_004_801c004b-5b7d-47d6-b389-1295905c4c2a);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_ImprissonedSkeptic_792c9745-1a8d-4d63-ae4c-33927457730a);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_OlgoGuard_001_59786a5f-a665-498c-8bf3-ecb9e6cd69dc);
DB_GLO_SourceCollars_PrisonersWithCollars(S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_OlgoGuard_003_59fc99da-4c46-41d1-a467-1edbf5615921);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_OlgoGuard_004_eab494d8-4c9e-47f1-afb4-30815e1ea68c);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_OlgoGuard_005_6cad1eb7-7d14-45e0-af87-0ea519aa5887);
DB_GLO_SourceCollars_PrisonersWithCollars(S_FTJ_GhettoNPC_Human_005_cf83f2df-facb-40a6-9948-071f9b729d84);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Scavenger_5e1d150e-af80-4c21-a8b3-0e787a6ee205);
DB_GLO_SourceCollars_PrisonersWithCollars(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Sceptic_Lizard_001_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_RPAssassin_8d73b9c9-0d7e-4e5c-8cfb-6a13121cd440);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_SkepticChild_001_780631fb-3619-4ed1-b48b-f1ff847d4183);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_SkepticChild_002_7f795cf2-db7f-46b6-aa9c-f9d5eefcc789);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_SkepticSoldier_9dc4da24-9cd5-43cc-a01c-6923b59bd066);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Skeptic_Elf_001_d8902155-d0e3-4dfe-b6dd-d90fd5606f50);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_Skeptic_Human_001_86eac720-88eb-4612-af03-3b2813454aa1);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_StockholmSyndromeElf_279defb4-e957-47bc-a441-1c221b271861);
DB_GLO_SourceCollars_PrisonersWithCollars(S_RC_FTJ_GhettoBoss_84758f75-01a3-4cce-9922-f42ffc4afddd);
DB_GLO_SourceCollars_PrisonersWithCollars(RC_FTJ_BruteAssassin_d2df547d-852e-4644-ac6c-db99dacc539b);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_LizardDreamer_ffb80725-25ff-4174-98cb-60a11612e5c4);
DB_GLO_SourceCollars_PrisonersWithCollars(S_FTJ_TeleporterNPC_4e291594-10ec-4c1f-a126-936e45ff875d);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_ArenaMaster_4eadc6c7-f934-43ad-bb74-c59358106114);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_CollaredPrisoner_5bec83d5-d441-4491-980f-798ddf38d08d);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_GLO_BurnishedOne_dc614e64-d6ef-4b45-8864-73f2a92a1980);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_ArenaFan_001_bbffcfab-50b8-4200-afb8-514e5c2a64eb);
DB_GLO_SourceCollars_PrisonersWithCollars(CHARACTERGUID_S_FTJ_ArenaFan_002_b4e2cd45-b391-48e0-8c6f-edb57cbc5eae);

DB_SharedObjectFlags("FTJ_RemoveSourceCollar");
QuestSetCategory("RC_FTJ_SourceCollar", "QCA_Chapter_02");
KBSECTION
//REGION Quest to get rid of collars
/*
// Add collar quest to players when game starts
IF
GameStarted("FJ_FortJoy_Main",_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_GLO_SourceCollars_OncePerNPC(_Player)
AND
//ObjectGetFlag(_Player,"QuestUpdate_RC_FTJ_SourceCollar_StartSourceCollar",0)
THEN
//ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_SourceCollar_StartSourceCollar");
*/
/*
// Add collar quest to recruited Companions
IF
CharacterMadePlayer(_Origin)
AND
GetRegion(_Origin,_Region)
AND
_Region == "FJ_FortJoy_Main"
AND
ObjectGetFlag(_Origin,"FTJ_RemoveSourceCollar",0)
THEN
//ObjectSetFlag(_Origin,"QuestUpdate_RC_FTJ_SourceCollar_StartSourceCollar");
*/

//REGION Global Removal of Collars
IF
DialogStarted("FTJ_SW_River",_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_RemoveSourceCollar",0)
THEN
GlobalSetFlag("FTJ_SW_PlayerHasCollar");

IF
DialogEnded(_,_Id)
AND
DialogGetInvolvedNPC(_Id,1,_NPC)
AND
_NPC == CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e
THEN
GlobalClearFlag("FTJ_SW_PlayerHasCollar");

IF
GlobalFlagSet("GLO_RemoveAllPlayerSourceCollars")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ObjectSetFlag(_Player,"FTJ_RemoveSourceCollar");

IF
GlobalFlagSet("GLO_RemoveAllPlayerSourceCollars")
THEN
PlayEffect(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RS3_FX_GP_ScriptedEvent_HOE_Channel_Spell_Cast_01");
PlayAnimation(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"skill_prepare_soul_01_start");

//END_REGION


//REGION AD Crime 

IF
ObjectFlagSet("FTJ_RemoveSourceCollar",(CHARACTERGUID)_Char,_)
AND
CharacterGetCrimeRegion(_Char,"FJ_FortJoy_Main_FortJoy")
AND
ObjectGetFlag(_Char,"QuestUpdate_FTJ_Escape_EnterDunes",0)
THEN
CharacterRegisterCrime(_Char,"FTJCollarlessADs",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0);
CharacterRegisterCrime(_Char,"FTJCollarless",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0);
DB_FTJ_NoCollarCrime(_Char);


IF
CharacterEnteredTrigger(_Char,S_FTJ_DallisEventAutoEnd_Poly_c66c0ceb-84d0-42f2-af77-854d178a58d5)
AND
DB_FTJ_NoCollarCrime(_Char)
THEN
NOT DB_FTJ_NoCollarCrime(_Char);
CharacterStopCrime(_Char,"FTJCollarlessADs",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Char,"FTJCollarless",NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Leya Journal Followup
IF
DB_Dead(CHARACTERGUID_S_FTJ_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54)
AND
NOT DB_GlobalFlag("FTJ_SW_GarethAtShelter")
AND
DB_IsPlayer(_Player)
AND
DB_Sees(_Player, CHARACTERGUID_S_FTJ_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54)
AND
ObjectGetFlag(_Player, "QuestUpdate_RC_FTJ_SourceCollar_MetCollarRemover", 1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_SourceCollar_LeyaSentGarethDead");

IF
GlobalFlagSet("FTJ_SW_GarethAtShelter")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player, "QuestUpdate_RC_FTJ_SourceCollar_MetCollarRemover", 1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_SourceCollar_LeyaSentGarethSafe");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
