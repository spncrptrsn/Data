Version 1
SubGoalCombiner SGC_AND
INITSECTION
//doc: https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/heroic-rescue

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_PreDriftwoodRegion_3dce0f0a-a3a6-4c78-91b0-89dee598d440);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DU_HeroicRescue_ExplodeDoorZone_790cf92c-d164-4ea6-8b0a-d30c0d7629a4);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_DW_SeenVoidwokenVB_Box_aafa45cf-348c-416f-a19c-cefaa7455426);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_DU_HeroicRescue_SpawnVW_Box_88b60302-dd6d-4be6-889f-6039c4fabba9);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_DU_HeroicRescue_MariDialogStartBox_604c6c2e-3afa-4b49-8e69-e974c298e7e6);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc);

SetOnStage(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_02_00166785-b066-4b72-adae-4fb97dc9795e,0);
SetOnStage(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_02_dd96dab0-abe9-43da-a4ec-2c291891bbd2,0);

DB_Dialogs(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"RC_DU_HeroicRescue_BridgeKeeper");
DB_Dialogs(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicRescue_HeroicWife");
DB_DoNotFace(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f);
DB_Children(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f);

DB_Ghosts(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_Ghost_0572957b-482a-41f1-b1c3-347909dc1725,"RC_DU_HeroicRescue_HeroicWifeGhost");

DB_RC_DU_HeroicRescue_Characters((CHARACTERGUID)CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"RC_DU_HeroicRescue_BridgeKeeper");
DB_RC_DU_HeroicRescue_Characters(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicRescue_HeroicWife");

DB_RC_DU_HeroicRescue_Voidwoken((CHARACTERGUID)CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_01_9f5cc975-fbca-4383-aff8-837f527dd950);
DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_03_e131e879-68fb-43f2-ae69-5110bea54905);
DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_01_899212c1-3ba7-438d-981f-51ecf75c01a9);
DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_02_00166785-b066-4b72-adae-4fb97dc9795e);

DB_KillCounter_Internal((CHARACTERGUID)CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_01_899212c1-3ba7-438d-981f-51ecf75c01a9,"RC_DU_HeroicRescue_Voidwoken");
DB_KillCounter_Internal((CHARACTERGUID)CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_01_9f5cc975-fbca-4383-aff8-837f527dd950,"RC_DU_HeroicRescue_Voidwoken");
DB_KillCounter_Internal((CHARACTERGUID)CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_03_e131e879-68fb-43f2-ae69-5110bea54905,"RC_DU_HeroicRescue_Voidwoken");
DB_KillCounter("RC_DU_HeroicRescue_Voidwoken",3);
DB_RC_DU_VWTurnCount(0);

DB_DeadEvent(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicWifeDied");

//DB of Cellar door and Plates to check for
DB_RC_DU_HeroicRescue_TruePlates((ITEMGUID)ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate01_53a498d4-a5a1-4288-8b27-7f8ba18e20fc,"RC_DU_HeroicRescue_CellarPlate01_Pressed","RC_DU_HeroicRescue_CellarPlate01_UnPressed");
DB_RC_DU_HeroicRescue_TruePlates(ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate02_7e25d3ce-5d7b-4762-ab39-882392585f56,"RC_DU_HeroicRescue_CellarPlate02_Pressed","RC_DU_HeroicRescue_CellarPlate02_UnPressed");
DB_RC_DU_HeroicRescue_TruePlates(ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate03_5c608b7d-8a53-4732-b18c-283de6f9ca18,"RC_DU_HeroicRescue_CellarPlate03_Pressed","RC_DU_HeroicRescue_CellarPlate03_UnPressed");

ItemClearOwner(ITEMGUID_S_RC_DU_HeroicRescue_House_BackDoor_8bd90b69-9992-44c5-8ba9-fca71932806b);
ItemClearOwner(ITEMGUID_S_RC_DU_HeroicRescue_House_MiddleDoor_5857dfcf-46ee-4a8d-85ad-578cd6b3060b);
KBSECTION
IF
DB_KillCounter_Internal(_Voidwoken,"RC_DU_HeroicRescue_Voidwoken")
THEN
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DU_VoidwokenGiantInsect_WanderBox_bf8e411e-c574-44a8-b6c8-0a94d6f5ea72,_Voidwoken);


//REGION Bridge Keeper
IF
DialogStarted("RC_DU_HeroicRescue_BridgeKeeper",_)
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f);

IF
GlobalFlagSet("RC_DU_DrawBridge_VoidwokenAreDead")
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f);

IF
AttackedByObject(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,_,_Attacker,_,_)
AND
CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f != _Attacker
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"GEB_FleeOutOfSight");
SetVarInteger(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"bool_HasJoinedMother",0);
ObjectClearFlag(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicWife_NearHusband");

IF
ObjectFlagSet("GEB_FleeOutOfSight",CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,_)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,_)
AND
DB_DialogNPCs(_Inst,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_)
THEN
ProcForceStopDialog(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc);

//END_REGION


//REGION VW Roaring
PROC
ProcOneShotTriggerEntered(_Player, TRIGGERGUID_S_RC_DW_SeenVoidwokenVB_Box_aafa45cf-348c-416f-a19c-cefaa7455426)
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",0)
THEN
ProcObjectTimer(_Player,"RC_DU_VB_SeenVoidwoken",2500); // Timer For the Roar and the screen shake to play

PROC
ProcObjectTimerFinished(_Player,"RC_DU_VB_SeenVoidwoken")
THEN
StartVoiceBark("RC_DU_VB_SeenVoidwoken",(CHARACTERGUID)_Player);

//END_REGION


//REGION Journal Updates & Flags
IF
ObjectEnteredCombat(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
CombatGetIDForCharacter(_Voidwoken,_CombatID)
THEN
GlobalSetFlag("RC_DU_HeroicRescue_HeroicWifeIsInCombat");

PROC
Proc_ObjectLeftCombat(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_WasInCombat(_Voidwoken,_CombatID)
THEN
GlobalClearFlag("RC_DU_HeroicRescue_HeroicWifeIsInCombat");

// End - Wife Survived
IF
DialogEnded("RC_DU_HeroicRescue_ReunitedCouple",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
GlobalSetFlag("RC_DU_HeroicRescue_SurvivorsGoToDriftwood");

IF
GlobalFlagSet("RC_DU_HeroicWifeDied")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag((CHARACTERGUID)_Player, "QuestUpdate_RC_DU_HeroicRescue_WifeDied");
GlobalClearFlag("RC_DU_HeroicRescue_HeroicWifeIsInCombat");

//END_REGION


//REGION Backyard + trigger door opening
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_DU_HeroicRescue_SpawnVW_Box_88b60302-dd6d-4be6-889f-6039c4fabba9)
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",0)
THEN
CharacterAppear(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_02_dd96dab0-abe9-43da-a4ec-2c291891bbd2,1,"RC_DU_HeroicRescue_BackyardVW_Spawns");
Proc_StartDialog(1,"RC_DU_HeroicRescue_VB_SeeVoidwoken",_Player);

IF
CharacterDied(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_02_dd96dab0-abe9-43da-a4ec-2c291891bbd2)
THEN
GlobalSetFlag("RC_DU_HeroicRescue_BackyardVWIsDead");

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DU_HeroicRescue_House_BackDoor_8bd90b69-9992-44c5-8ba9-fca71932806b)
THEN
Proc_RC_DU_HeroicRescue_MariUnlocksBackdoor();

PROC
Proc_RC_DU_HeroicRescue_MariUnlocksBackdoor()
AND
GlobalGetFlag("RC_DU_HeroicRescue_BackyardVWIsDead",1)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,0)
AND
DB_InRegion(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10)
AND
DB_IsPlayer(_Player)
AND
NOT DB_InRegion(_Player,TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10)
AND
QueryOnlyOnce("RC+DU_HeroicRescue_BackDoorOpening")
THEN
DialogRequestStop(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc);
SetStoryEvent(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicRescue_MariOpensBackdoor");
GlobalSetFlag("RC_DU_HeroicRescue_OpenDoorForPlayer");

// Mari starts convo when you enter the house
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_DU_HeroicRescue_MariDialogStartBox_604c6c2e-3afa-4b49-8e69-e974c298e7e6)
AND
DB_IsPlayer(_Player)
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",0)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
CharacterIsInCombat(_Voidwoken,0)
THEN
Proc_StartDialog(0,"RC_DU_HeroicRescue_HeroicWife",CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_Player);

IF
ObjectFlagSet("RC_DU_HeroicRescue_AllowedToCraft",_Player,_)
THEN
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,(CHARACTERGUID)_Player,100);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,100);
TriggerClearItemOwner(TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10);

//END_REGION


//REGION Combat, Mari joining & VW spawn
//Mari joins combat at the end of a voidwoken turn if not
IF
ObjectTurnEnded((CHARACTERGUID)_Voidwoken)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
NOT DB_OnlyOnce("RC_DU_HeroicWifeJoinCombat")
AND
DB_RC_DU_VWTurnCount(_Int)
AND
IntegerSum(_Int,1,_Sum)
THEN
NOT DB_RC_DU_VWTurnCount(_Int);
DB_RC_DU_VWTurnCount(_Sum);

IF
DB_RC_DU_VWTurnCount(2)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,0)
AND
DB_InRegion(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,TRIGGERGUID_S_RC_DU_BridgeKeeperHouse_Box_7ed8ecd7-9613-4abe-aae9-3140ccc93e10)
AND
QueryOnlyOnce("RC_DU_HeroicWifeJoinCombat")
THEN
NOT DB_RC_DU_VWTurnCount(2);
ObjectSetFlag(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicWife_JoinedPlayerAutomatically");
SetVarFixedString(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"currentState","State_JoinCombat");

//Set Mari has allied to the player when she joins automatically
IF
ObjectEnteredCombat(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_CombatCharacters(_Voidwoken,_CombatID)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_CombatID)
AND
DB_CombatCharacters(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
THEN
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,(CHARACTERGUID)_Player, 100);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc, 100);

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_CombatID)
AND
DB_IsPlayer(_Player)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_CombatCharacters(_Voidwoken,_CombatID)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,0)
AND
DB_CombatCharacters(_Player,_CombatID)
AND
DB_CombatCharacters(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
THEN
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,(CHARACTERGUID)_Player, 100);
CharacterSetRelationIndivFactionToIndivFaction((CHARACTERGUID)_Player,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc, 100);

//New VW spawns
IF
DB_KillCounterDied(_Voidwoken,"RC_DU_HeroicRescue_Voidwoken")
AND
DB_KillCounter("RC_DU_HeroicRescue_Voidwoken",_Count)
AND
IntegerSum(_Count,1,_NewCount)
AND
QueryOnlyOnce("RC_DU_HeroicRescue_NewVWSpawns")
THEN
CharacterAppear(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_02_00166785-b066-4b72-adae-4fb97dc9795e,1,"");
DB_KillCounter_Internal((CHARACTERGUID)CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_02_00166785-b066-4b72-adae-4fb97dc9795e,"RC_DU_HeroicRescue_Voidwoken");
NOT DB_KillCounter("RC_DU_HeroicRescue_Voidwoken",_Count);
DB_KillCounter("RC_DU_HeroicRescue_Voidwoken",_NewCount);

IF
CharacterKilledBy(_Voidwoken,_AttackerOwner,_Attacker)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_IsPlayer(_AttackerOwner)
THEN
UserSetFlag(_AttackerOwner,"RC_DU_HeroicRescue_KilledAVoidwoken");

IF
CharacterDying(_Voidwoken)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_CombatCharacters(_Voidwoken,_CombatID)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_CombatID)
THEN
UserSetFlag(_Player,"RC_DU_HeroicRescue_KilledAVoidwoken");

IF
ObjectTurnStarted(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_CombatCharacters(_Voidwoken,_CombatID)
AND
DB_CombatCharacters(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_CombatID)
AND
QueryOnlyOnce("RC_DU_HeroicWifeCombatAD")
THEN
Proc_StartDialog(1,"RC_DU_HeroicRescue_AD_HeroicWifeJoinsFight",CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc);

//END_REGION


//REGION Battle ends
IF
CharacterKilledBy(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_AttackerOwner,_Attacker)
AND
DB_IsPlayer(_AttackerOwner)
THEN
DB_RC_DU_HeroicWifeKilledByPlayer(1);

IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc)
AND
NOT DB_RC_DU_HeroicWifeKilledByPlayer(_)
AND
DB_IsPlayer(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,1)
AND
QueryOnlyonce("RC_DU_HeroicRescue_DeathOfMari")
THEN
StartVoiceBark("RC_DU_HeroicRescue_VB_DeathOfMari",_Player);

IF
CharacterDied(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc)
AND
NOT DB_RC_DU_HeroicWifeKilledByPlayer(_)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,1)
AND
QueryOnlyonce("RC_DU_HeroicRescue_DeathOfMari")
THEN
StartVoiceBark("RC_DU_HeroicRescue_VB_DeathOfMari",_Player);

PROC
ReactOnKillCounter("RC_DU_HeroicRescue_Voidwoken")
THEN
GlobalSetFlag("RC_DU_DrawBridge_VoidwokenAreDead");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_DW_SeenVoidwokenVB_Box_aafa45cf-348c-416f-a19c-cefaa7455426);
SetStoryEvent(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"ClearPeaceReturn");
SetVarFixedString(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"currentState","State_AfterCombat");
SetVarFixedString(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"currentState","State_ReachHusband");

PROC
ReactOnKillCounter("RC_DU_HeroicRescue_Voidwoken")
AND
DB_IsPlayer(_Player)
AND
DB_WasInCombat(_Player,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_WasInCombat(_Voidwoken,_CombatID)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_DU_HeroicRescue_KilledVoidwoken");
UserSetFlag(_Player,"RC_DU_HeroicRescue_KilledAVoidwoken");

PROC
ReactOnKillCounter("RC_DU_HeroicRescue_Voidwoken")
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc, 0)
AND
DB_IsPlayer(_Player)
AND
DB_WasInCombat(_Player,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_WasInCombat(_Voidwoken,_CombatID)
THEN
UserSetFlag(_Player, "RC_DU_RescuedHeroicWife");

PROC
ReactOnKillCounter("RC_DU_HeroicRescue_Voidwoken")
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc, 0)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_CombatID)
AND
DB_RC_DU_HeroicRescue_Voidwoken(_Voidwoken)
AND
DB_WasInCombat(_Voidwoken,_CombatID)
THEN
UserSetFlag(_Player, "RC_DU_RescuedHeroicWife");

IF
ObjectFlagSet("RC_DU_RescuedHeroicWife",_Player,_)
THEN
ObjectSetFlag(_Player,"GLO_SetTag_HERO");

//END_REGION


//REGION post-fight reactions / go to Driftwood
IF
DialogEnded("RC_DU_HeroicRescue_BridgeKeeper",_)
AND
CharacterIsDead(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,1)
AND
QueryOnlyOnce("RC_DU_BarinLeaveForDriftwood")
THEN
GlobalSetFlag("RC_DU_HeroicRescue_SurvivorsGoToDriftwood");

IF
CharacterLeftTrigger(_Player,TRIGGERGUID_S_RC_DW_PreDriftwoodRegion_3dce0f0a-a3a6-4c78-91b0-89dee598d440)
AND
QRY_AnyRegionActive()
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",1)
AND
NOT QryCheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000,TRIGGERGUID_S_RC_DW_PreDriftwoodRegion_3dce0f0a-a3a6-4c78-91b0-89dee598d440)
THEN
GlobalSetFlag("RC_DU_HeroicRescue_SurvivorsGoToDriftwood");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_DW_PreDriftwoodRegion_3dce0f0a-a3a6-4c78-91b0-89dee598d440);
UserSetFlag(_Player,"QuestUpdate_RC_DU_HeroicRescue_WifeSurvived");

IF
ObjectFlagSet("RC_DU_HeroicWife_NearHusband",CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_)
AND
DB_RC_DU_HeroicRescue_Characters(_Char,_Dialog)
AND
CharacterIsDead(_Char,0)
THEN
PROC_RemoveDialogFromCharacter(_Char);
NOT DB_Dialogs(_Char,_Dialog);
DB_Dialogs(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"RC_DU_HeroicRescue_ReunitedCouple");

IF
ObjectFlagCleared("RC_DU_HeroicWife_NearHusband",CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,_)
THEN
Proc_RC_DU_HeroicRescue_DoubleDialogCleanUp();

IF
CharacterDied(_Char)
AND
DB_RC_DU_HeroicRescue_Characters(_Char,_)
THEN
Proc_RC_DU_HeroicRescue_DoubleDialogCleanUp();

IF
GlobalFlagSet("RC_DU_HeroicRescue_SurvivorsGoToDriftwood")
THEN
Proc_RC_DU_HeroicRescue_DoubleDialogCleanUp();

IF
GlobalFlagSet("RC_DU_HeroicRescue_SurvivorsGoToDriftwood")
AND
DB_RC_DU_HeroicRescue_Characters(_Char,_)
AND
CharacterIsDead(_Char,0)
THEN
CharacterDisappearOutOfSightToObject(_Char,TRIGGERGUID_S_RC_DW_BridgeKeeperAndWife_Point_12435842-23cc-4744-a9de-094ed770953b,1,"RC_DU_HeroicCoupleToDriftwood",1);
SetHasDialog(_Char,0);

IF
StoryEvent((CHARACTERGUID)_Char,"RC_DU_HeroicCoupleToDriftwood")
AND
DB_RC_DU_HeroicRescue_Characters(_Char,_)
THEN
CharacterAppearOutOfSightToObject(_Char,TRIGGERGUID_S_RC_DW_BridgeKeeperAndWife_Point_12435842-23cc-4744-a9de-094ed770953b,TRIGGERGUID_S_RC_DU_HeroicRescue_BridgeKeeper_Point_7d7b2755-427d-48fa-8162-ae6f3ef03052,0,"RC_DU_HeroicCoupleInDriftwood");
ObjectSetFlag(_Char,"RC_DU_HeroicRescue_InDriftwood");
SetHasDialog(_Char,1);
SetFaction(_Char,"RC_DW_Civilian");
SetVarFixedString(_Char,"currentState","State_InDriftwood");
GlobalSetFlag("RC_DW_HeroicWifeRescued");

PROC
Proc_RC_DU_HeroicRescue_DoubleDialogCleanUp()
AND
DB_RC_DU_HeroicRescue_Characters(_Char,_Dialog)
AND
CharacterIsDead(_Char,0)
THEN
PROC_RemoveDialogFromCharacter(_Char);
NOT DB_Dialogs(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"RC_DU_HeroicRescue_ReunitedCouple");
DB_Dialogs(_Char,_Dialog);

//END_REGION


//REGION BridgeHouse Cellar
//Proc to check for locked Door and open it
PROC
Proc_RC_DU_HeroicRescue_CellarOpenDoor()
THEN
ItemUnlockAndOpen(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9);
DB_RC_DU_HeroicRescue_KnowsHowOpenCellar(1);

IF
AttackedByObject(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9,_Player,_Attacker,_,_)
AND
ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9 != _Attacker
AND
QueryOnlyOnce("RC_DU_HeroicRescue_CellarDoorTrapTriggered")
AND
GetPosition(_Player,_X,_Y,_Z)
THEN
CreateExplosionAtPosition(_X,_Y,_Z,"Projectile_EnemyFireball",10);

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9)
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_DU_HeroicRescue_ExplodeDoorZone_790cf92c-d164-4ea6-8b0a-d30c0d7629a4)
AND
NOT DB_RC_DU_HeroicRescue_CellarDoorFinal(_)
AND
GetPosition(_Player,_X,_Y,_Z)
THEN
CreateExplosionAtPosition(_X,_Y,_Z,"Projectile_EnemyFireball",10);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_DU_HeroicRescue_ExplodeDoorZone_790cf92c-d164-4ea6-8b0a-d30c0d7629a4);

//Close and lock the door if not three Pressure Plates pressed
IF
CharacterItemEvent(_Char,_Plate,_Event)
AND
DB_RC_DU_HeroicRescue_TruePlates(_Plate,_,_Event)
AND
DB_RC_DU_HeroicRescue_PressedPlates(_Plate)
AND
NOT DB_RC_DU_HeroicRescue_CellarDoorFinal(_)
AND
ItemIsLocked(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9,0)
THEN
ItemCloseAndLock(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9,"");

IF
CharacterItemEvent(_Char,_Plate,_Event)
AND
DB_RC_DU_HeroicRescue_TruePlates(_Plate,_,_Event)
AND
DB_RC_DU_HeroicRescue_PressedPlates(_Plate)
AND
DB_RC_DU_HeroicRescue_CellarDoorFinal(_)
THEN
ItemClose(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9);

//if Plate is Pressed add it to the cheking DB
IF
CharacterItemEvent(_Char,_Plate,_Event)
AND
DB_RC_DU_HeroicRescue_TruePlates(_Plate,_Event,_)
AND
NOT DB_RC_DU_HeroicRescue_PressedPlates(_Plate)
THEN
DB_RC_DU_HeroicRescue_PressedPlates(_Plate);

//if Plate is UnPressed remove it from the cheking DB
IF
CharacterItemEvent(_Char,_Plate,_Event)
AND
DB_RC_DU_HeroicRescue_TruePlates(_Plate,_,_Event)
AND
DB_RC_DU_HeroicRescue_PressedPlates(_Plate)
THEN
NOT DB_RC_DU_HeroicRescue_PressedPlates(_Plate);

//Check DB for number of Pressed Plates and open Door if true
IF
DB_RC_DU_HeroicRescue_PressedPlates(_Plate)
AND
SysCount("DB_RC_DU_HeroicRescue_PressedPlates",1,3)
THEN
Proc_RC_DU_HeroicRescue_CellarOpenDoor();

//Open Door on Lever use
IF
CharacterItemEvent(_Char,ITEMGUID_S_RC_DU_HeroicRescue_CellarDoorLever_4227e46b-fbd0-4f2f-927b-6e88d58fd5aa,"RC_DU_HeroicRescue_CellarLeverUsed")
THEN
DB_RC_DU_HeroicRescue_CellarDoorFinal(1);
Proc_RC_DU_HeroicRescue_CellarOpenDoor();

IF
CharacterItemEvent(_Char,ITEMGUID_S_RC_DU_HeroicRescue_CellarLadder_c9b74369-2298-4a26-b9a7-f795998db488,"RC_DU_HeroicRescue_FromCellar")
THEN
ItemUnLock(ITEMGUID_RC_DU_HeroicRescue_CellarHatch_dec7a940-a1b4-42aa-8041-08cf14151374);


//Player VB if Entered From the House
IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DU_HeroicRescue_CellarHatch_dec7a940-a1b4-42aa-8041-08cf14151374)
AND
PartyGetFlag(_Player,"RC_DU_HeroicRescue_FromWell",0)
AND
ItemIsLocked(ITEMGUID_S_RC_DU_HeroicRescue_CellarHatch_dec7a940-a1b4-42aa-8041-08cf14151374,0)
AND
QueryOnlyOnce("RC_DU_HeroicResscue_EnteredCellar")
THEN
StartVoiceBark("RC_DU_HeroicRescue_VB_EnterCellar",_Player);
PartySetFlag(_Player,"RC_DU_HeroicRescue_FromHouse");

//Player VB if Entered From the Well
IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DU_HeroicRescue_Well_248aae23-e4f0-4a39-9dd9-b39daa76a3ff)
AND
PartyGetFlag(_Player,"RC_DU_HeroicRescue_FromHouse",0)
AND
QueryOnlyOnce("RC_DU_HeroicResscue_EnteredCellar")
THEN
StartVoiceBark("RC_DU_HeroicRescue_VB_EnterCellar",_Player);
PartySetFlag(_Player,"RC_DU_HeroicRescue_FromWell");

//Play VB When Click on LockedDoor
IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9)
AND
PartyGetFlag(_Player,"RC_DU_HeroicRescue_ClickedCellarDoor",0)
AND
ItemIsLocked(ITEMGUID_S_RC_DU_HeroicRescue_CellarLockedDoor_429d8e22-63ad-4be5-a3b1-66b86003dfb9,1)
AND
NOT DB_RC_DU_HeroicRescue_KnowsHowOpenCellar(_)
THEN
StartVoiceBark("RC_DU_HeroicRescue_VB_CellarDoor",_Player);

//END_REGION


//REGION Sound
IF
TextEventSet("CreatureSoundTestCharacter")
THEN
PlaySound(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_01_899212c1-3ba7-438d-981f-51ecf75c01a9,"Shrieker");

IF
TextEventSet("CreatureSoundTestItem")
THEN
PlaySound(S_RC_DU_Sound_HeroicRescue_CreatureDistantRoar_34b6f4af-d55f-4ddd-bfca-5032663ac4ad,"Shrieker");

IF
TextEventSet("CreatureSoundTestVoidwoken")
THEN
PlaySound(S_RC_DU_Sound_HeroicRescue_CreatureDistantRoar_34b6f4af-d55f-4ddd-bfca-5032663ac4ad,"Giant_Insect_Distant_Roar_01");

IF
TextEventSet("CreatureSoundTestVoidwokenSceneLoop")
THEN
PlaySound(S_RC_DU_Sound_HeroicRescue_CreatureDistantRoar_34b6f4af-d55f-4ddd-bfca-5032663ac4ad,"Giant_Insect_Abduction_Scene");

IF
TextEventSet("CreatureSoundTestVoidwokenOnChar")
AND
DB_IsPlayer(_Player)
THEN
PlaySound(_Player,"Giant_Insect_Distant_Roar_02");
PlaySound(_Player,"Giant_Insect_Distant_Roar_01");

PROC
ProcOneShotTriggerEntered(_Player, TRIGGERGUID_S_RC_DW_SeenVoidwokenVB_Box_aafa45cf-348c-416f-a19c-cefaa7455426)
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",0)
AND
QueryOnlyOnce("RC_DU_HeroicRescue_Voidwoken_SoundTirgger1")
THEN
DebugText(_Player,"Giant_Insect_Distant_Roar_01");
PlaySound(S_RC_DU_Sound_HeroicRescue_CreatureDistantRoar1_34b6f4af-d55f-4ddd-bfca-5032663ac4ad,"Giant_Insect_Distant_Roar_01");
Proc_ShakeCameraForTime(_Player,2000);

IF
CharacterUsedItem(_Player,S_TOOL_Ladder_Nature_12H_A_001_eb47020d-7319-4b1e-bfd8-d9f670423e27)
AND
GlobalGetFlag("RC_DU_DrawBridge_VoidwokenAreDead",0)
AND
QueryOnlyOnce("RC_DU_HeroicRescue_Voidwoken_SoundTirgger2")
THEN
DebugText(_Player,"Giant_Insect_Distant_Roar_02");
PlaySound(S_RC_DU_Sound_HeroicRescue_CreatureDistantRoar2_221e39f2-3bff-4650-8f71-4a67da2286d9,"Giant_Insect_Distant_Roar_02");
Proc_ShakeCameraForTime(_Player,2000);

//END_REGION
EXITSECTION
NOT DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_01_9f5cc975-fbca-4383-aff8-837f527dd950);
NOT DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_NoWings_03_e131e879-68fb-43f2-ae69-5110bea54905);
NOT DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_01_899212c1-3ba7-438d-981f-51ecf75c01a9);
NOT DB_RC_DU_HeroicRescue_Voidwoken(CHARACTERGUID_S_RC_DU_HeroicRescue_GiantInsect_Wings_02_00166785-b066-4b72-adae-4fb97dc9795e);

NOT DB_RC_DU_HeroicRescue_Characters(CHARACTERGUID_S_RC_DU_DrawBridgeKeeper_c7808968-e893-43c5-8856-ddc7f871037f,"RC_DU_HeroicRescue_BridgeKeeper");
NOT DB_RC_DU_HeroicRescue_Characters(CHARACTERGUID_S_RC_DU_DrawBridgeHeroicWife_e0988a52-c38e-4b29-849b-4e0efda467cc,"RC_DU_HeroicRescue_HeroicWife");

NOT DB_RC_DU_HeroicRescue_TruePlates(ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate01_53a498d4-a5a1-4288-8b27-7f8ba18e20fc,"RC_DU_HeroicRescue_CellarPlate01_Pressed","RC_DU_HeroicRescue_CellarPlate01_UnPressed");
NOT DB_RC_DU_HeroicRescue_TruePlates(ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate02_7e25d3ce-5d7b-4762-ab39-882392585f56,"RC_DU_HeroicRescue_CellarPlate02_Pressed","RC_DU_HeroicRescue_CellarPlate02_UnPressed");
NOT DB_RC_DU_HeroicRescue_TruePlates(ITEMGUID_S_RC_DU_HeroicRescue_CellarPressurePlate03_5c608b7d-8a53-4732-b18c-283de6f9ca18,"RC_DU_HeroicRescue_CellarPlate03_Pressed","RC_DU_HeroicRescue_CellarPlate03_UnPressed");
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
