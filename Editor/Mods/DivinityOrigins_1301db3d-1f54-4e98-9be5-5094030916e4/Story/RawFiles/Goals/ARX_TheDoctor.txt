Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_AD_Dialog(ITEMGUID_S_ARX_DoctorsHouse_Sign_01_62e034ad-33c2-46e7-8787-15a78d599e43,"ARX_DoctorsHouse_AD_Sign_01");
DB_AD_Dialog(ITEMGUID_S_ARX_DoctorsHouse_Sign_02_aa5fb312-3af4-4e69-8089-9fa444c3fa56,"ARX_DoctorsHouse_AD_Sign_02");
DB_Dialogs(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,NULL_00000000-0000-0000-0000-000000000000,"ARX_DoctorsHouse_TheDoctor");

DB_Dialogs(CHARACTERGUID_S_ARX_DoctorsHouse_WindUpToy_e1bfda93-e66d-44f7-b773-b4a075c6852d,"ARX_DoctorsHouse_WindUpToy");
DB_Dialogs(CHARACTERGUID_S_ARX_DoctorsHouse_Squirrel_36f7c708-ef9c-4718-ad95-21ccf44beb49,"ARX_DoctorsHouse_Squirrel");


ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_DoctorsHouse_GroundFloor_6a0dd371-c420-4b93-ba0e-a1aea9531617);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_DoctorsHouse_GroundFloor_DoorTrigger_2c001673-0baa-4a69-8f37-645af97e8a23);

Proc_CheckLohseInGame();

DB_ARX_DoctorsHouse_NPCs((CHARACTERGUID)CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_02_e8cc0255-7d6e-4f52-81ca-2551e8b445a1);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_03_0933d507-2e69-4d6d-9631-dff702e03744);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_04_6831724d-d355-42ef-be25-5bcc1e9baa52);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_05_708e03a9-50c3-40de-90ed-c5f58a45df84);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_06_88d45ba2-a4ec-45b8-bdcd-92951dbd06ca);
DB_ARX_DoctorsHouse_NPCs(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d);

DB_ARX_DoctorsPact((ITEMGUID)ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Beast_7ced4a14-a72e-4ba0-9766-59c0cdb93758,"BEAST");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Generic_88a4bc28-76aa-413a-a36e-f2737a8dadde,"GENERIC");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Ifan_31bae5ef-e798-45d7-a8f0-fb6b72673c61,"IFAN");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Fane_c4b676c0-9501-4647-8d24-9fc99bbcfdc6,"FANE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Lohse_3d4a27b7-c6d3-4e8f-aafb-bb6383662a81,"LOHSE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_RedPrince_e5769aaa-7a7e-4dc0-addf-254aaae85327,"RED PRINCE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Sebille_08978358-1fcd-493c-82c2-86a2ae0f0c4e,"SEBILLE");

//Checking correct character when Shapeshifted as well
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Beast_7ced4a14-a72e-4ba0-9766-59c0cdb93758,"SHAPESHIFT_BEAST");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Generic_88a4bc28-76aa-413a-a36e-f2737a8dadde,"SHAPESHIFT_GENERIC");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Ifan_31bae5ef-e798-45d7-a8f0-fb6b72673c61,"SHAPESHIFT_IFAN");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Fane_c4b676c0-9501-4647-8d24-9fc99bbcfdc6,"SHAPESHIFT_FANE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Lohse_3d4a27b7-c6d3-4e8f-aafb-bb6383662a81,"SHAPESHIFT_LOHSE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_RedPrince_e5769aaa-7a7e-4dc0-addf-254aaae85327,"SHAPESHIFT_RED PRINCE");
DB_ARX_DoctorsPact(ITEMGUID_S_ARX_DoctorsHouse_BloodVial_Sebille_08978358-1fcd-493c-82c2-86a2ae0f0c4e,"SHAPESHIFT_SEBILLE");

//DB_DeadEvent(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_DemonForm_ecf21bbb-a9bf-4921-ab7d-e56fc940de1a,"ARX_TheDoctor_IsDead");
DB_DeadEvent(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"ARX_TheDoctor_IsDead");

//SetOnStage(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_DemonForm_ecf21bbb-a9bf-4921-ab7d-e56fc940de1a,0);
SetOnStage(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,0);
SetOnStage(ITEMGUID_S_ARX_AncestorTree_GhostMace_d10c4bf0-cc3a-4fb8-9191-3b34fe322c2f,0);
/*
ProcCrimeSetCustomPrimarySensibleAction(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"Assault","");
ProcCrimeSetCustomPrimarySensibleAction(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"Steal","");
ProcCrimeSetCustomPrimarySensibleAction(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"UseForbiddenItem","");
ProcCrimeSetCustomPrimarySensibleAction(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"PickPocketFailed","");
*/
DB_ARX_TheDoctor_AmbushDemons((CHARACTERGUID)CHARACTERGUID_S_ARX_DoctorsHouse_DoctorsDemon_03_f12c9cc0-0219-46de-9746-3ea5b802cee6,1);
DB_ARX_TheDoctor_AmbushDemons(CHARACTERGUID_S_ARX_DoctorsHouse_DoctorsDemon_04_7f2515b5-1482-41d5-8f3d-20304eda0e9e,2);
DB_ARX_TheDoctor_AmbushDemons(CHARACTERGUID_S_ARX_DoctorsHouse_DoctorsDemon_02_ba9b8596-ddfa-4199-b4bb-273d010046eb,3);
DB_ARX_TheDoctor_AmbushDemons(CHARACTERGUID_S_ARX_DoctorsHouse_DoctorsDemon_01_4ac45868-d71a-4756-8e39-cf7550544c95,4);
DB_ARX_TheDoctor_AmbushDemons_Current(1);


DB_ARX_TheDoctor_Knows("ARX_MerchantEstate_DoctorsNotes_ReadNotes","ARX_TheDoctor_Knows_CakeIsbeil");
DB_ARX_TheDoctor_Knows("QuestUpdate_ARX_TheDoctor_Knows_NoDoor","ARX_TheDoctor_Knows_CakeIsbeil");
DB_ARX_TheDoctor_Knows("ARX_DoctorsHouse_WindUpToy_KillIsbeil","ARX_TheDoctor_Knows_CakeIsbeil");

DB_ARX_TheDoctor_Knows("ARX_TheDoctor_Knows_CakeIsbeil","ARX_TheDoctor_Knows_BlackringAttacks");
DB_ARX_TheDoctor_Knows("ARX_TheDoctor_Knows_GardenKemm","ARX_TheDoctor_Knows_BlackringAttacks");

DB_ARX_TheDoctor_Knows("ARX_KemmMansion_Garden_ShamblingMound_Possessed","ARX_TheDoctor_Knows_GardenKemm");



DB_ShovelArea(TRIGGERGUID_S_ARX_DoctorsHouse_GraveyardTreasure_02_Box_709c29f4-9643-48e2-a9ac-b3c7561ee716,"ARX_DoctorsHouse_GraveyardTreasure_02",ITEMGUID_S_ARX_DoctorsHouse_GraveyardTreasure_02_Pile_e75b89f0-ea05-4cfb-af60-26a440137112);
DB_ShovelRewardItemAppear("ARX_DoctorsHouse_GraveyardTreasure_02",ITEMGUID_S_ARX_DoctorsHouse_GraveyardTreasure_02_Treasure_d781c28a-cdad-4ce3-8b0a-0b14ef5078ca,TRIGGERGUID_S_ARX_DoctorsHouse_GraveyardTreasure_02_Point_528b9486-3be8-435a-8c2d-6ead20ecbf63);

DB_ShovelArea(TRIGGERGUID_S_ARX_DoctorsHouse_GraveyardTreasure_01_Box_c5d1d358-7bfe-4c3c-8287-c47473a3988f,"ARX_DoctorsHouse_GraveyardTreasure_01",ITEMGUID_S_ARX_DoctorsHouse_GraveyardTreasure_01_Pile_465e074e-8d2c-4456-9ddb-7c52d5414b2e);
DB_ShovelRewardItemAppear("ARX_DoctorsHouse_GraveyardTreasure_01",ITEMGUID_S_ARX_DoctorsHouse_GraveyardTreasure_01_Treasure_d545ca75-4a77-46b6-92d9-af391bf3277e,TRIGGERGUID_S_ARX_DoctorsHouse_GraveyardTreasure_01_Point_0e729d8c-584b-4db7-8507-2d694994de3b);

KBSECTION
//REGION check lohse
PROC
Proc_CheckLohseInGame()
AND
DB_IsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
GlobalSetFlag("LohseIsAvailable");

PROC
Proc_CheckLohseInGame()
AND
GlobalGetFlag("CompanionLeft_LOHSE_DiedInLV",0)
AND
GlobalGetFlag("CompanionLeft_LOHSE_OpposedInCOS",0)
AND
GlobalGetFlag("CompanionLeft_LOHSE_LowRelation",0)
THEN
GlobalSetFlag("LohseIsAvailable");

PROC
Proc_CheckLohseInGame()
AND
NOT DB_IsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
GlobalClearFlag("LohseIsAvailable");

PROC
Proc_CheckLohseInGame()
AND
GlobalGetFlag("CompanionLeft_LOHSE_LowRelation",1)
THEN
GlobalClearFlag("LohseIsAvailable");

PROC
Proc_CheckLohseInGame()
AND
GlobalGetFlag("CompanionLeft_LOHSE_OpposedInCOS",1)
THEN
GlobalClearFlag("LohseIsAvailable");

PROC
Proc_CheckLohseInGame()
AND
GlobalGetFlag("CompanionLeft_LOHSE_DiedInLV",1)
THEN
GlobalClearFlag("LohseIsAvailable");

IF
DB_IsPlayer(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
GlobalSetFlag("LohseIsAvailable");

IF
GlobalFlagSet("LohseIsAvailable")
THEN
CharacterSetCanTrade(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,0);

IF
GlobalFlagCleared("LohseIsAvailable")
THEN
CharacterSetCanTrade(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1);
//END_REGION
//REGION blood pacts

IF
StoryEvent((CHARACTERGUID)_Char,"ARX_DoctorsHouse_TheDoctor_SightedChar")
THEN
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck(_Char);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
DB_IsPlayer(_OtherChar)
AND
IsTagged(_OtherChar,"PROMISED",1)
AND
CharacterIsInCombat(_OtherChar,0)
AND
CharacterCanSee(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_OtherChar,1)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(_OtherChar);


PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
UserGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_TheDoctor_UserAcceptedThePact",0)
AND
GlobalGetFlag("ARX_DoctorsHouse_TheDoctor_LohseSightedDialog",0)
AND
CharacterCanSee(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1)
AND
CharacterIsInCombat(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0)
THEN
GlobalSetFlag("ARX_DoctorsHouse_TheDoctor_LohseSightedDialog");
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);


PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
UserGetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_TheDoctor_UserAcceptedThePact",0)
AND
GlobalGetFlag("ARX_DoctorsHouse_TheDoctor_LohseSightedDialog",0)
AND
CharacterCanSee(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0)
AND
CharactersAreGrouped(_Char,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1)
AND
CharacterIsInCombat(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0)
THEN
GlobalSetFlag("ARX_DoctorsHouse_TheDoctor_LohseSightedDialog");
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
UserGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_BringMeLohse",0)
AND
UserGetFlag(_Char,"ARX_TheDoctor_UserAcceptedThePact",0)
AND
IsTagged(_Char,"AVATAR",1)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(_Char);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
UserGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_BringMeLohse",0)
AND
UserGetFlag(_Char,"ARX_TheDoctor_UserAcceptedThePact",0)
AND
IsTagged(_Char,"AVATAR",0)
AND
CharacterGetReservedUserID(_Char,_Id)
AND
DB_IsPlayer(_OtherChar)
AND
IsTagged(_OtherChar,"AVATAR",0)
AND
CharacterGetReservedUserID(_OtherChar,_Id)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(_Char);


PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck((CHARACTERGUID)_Char)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
UserGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_BringMeLohse",0)
AND
UserGetFlag(_Char,"ARX_TheDoctor_UserAcceptedThePact",0)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start(_Char);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_InitiateDialogCheck_Start((CHARACTERGUID)_Char)
THEN
ProcForceStopDialog(_Char);
Proc_StartDialog(0,"ARX_DoctorsHouse_TheDoctor",CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,_Char);
DB_ARX_DoctorsHouse_TheDoctor_AddToDialog(_Char);
CharacterMoveTo(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,TRIGGERGUID_S_ARX_DoctorsHouse_Doctor_DialogPoint_79838641-b031-43c9-8101-bee136b256cb,0,"ARX_DoctorsHouse_Doctor_DialogPoint_Reached",0);
DB_ARX_DoctorsHouse_TheDoctor_LookAt(_Char);

IF
StoryEvent(_,"ARX_DoctorsHouse_Doctor_DialogPoint_Reached")
AND
DB_ARX_DoctorsHouse_TheDoctor_LookAt(_Char)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_Char);
NOT DB_ARX_DoctorsHouse_TheDoctor_LookAt(_Char);

IF
DialogStarted("ARX_DoctorsHouse_TheDoctor",_Id)
AND
DB_ARX_DoctorsHouse_TheDoctor_AddToDialog(_)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_AddToDialog(_Id);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_AddToDialog((INTEGER)_Id)
AND
DB_ARX_DoctorsHouse_TheDoctor_AddToDialog(_Char)
AND
DB_IsPlayer(_OtherChar)
AND
_OtherChar != _Char
AND
CharacterCanSee(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_OtherChar,1)
THEN
ProcForceStopDialog(_OtherChar);
DialogAddActor(_Id,_OtherChar);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_AddToDialog((INTEGER)_Id)
AND
DB_ARX_DoctorsHouse_TheDoctor_AddToDialog(_Char)
THEN
NOT DB_ARX_DoctorsHouse_TheDoctor_AddToDialog(_Char);


IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_NurseMoveTo",_Char,_)
THEN
CharacterMoveTo(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,_Char,0,"ARX_DoctorsHouse_TheDoctor_NurseMoved",1);
CharacterLookAt(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,_Char);

IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_Cut",_Char,_)
THEN
DB_ARX_DoctorsHouse_TheDoctor_Cut_LookAt(_Char);
//CharacterSetAnimationOverride(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,"Elves_Hero_Female_ABC_Attack_1H_01");
PlayAnimation(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,"Elves_Hero_Female_ABC_Attack_1H_01");
ApplyDamage(_Char,20,"Physical");
CreatePuddle(_Char,"SurfaceBlood",5,10,1,3,0.02);

IF
GlobalFlagSet("ARX_TheDoctor_PactSealed")
THEN
CharacterSetCanTrade(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1);
CharacterMoveTo(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,0,"ARX_DoctorsHouse_TheDoctor_NurseMoved_2",0);

IF
StoryEvent(_,"ARX_DoctorsHouse_TheDoctor_NurseMoved_2")
THEN
CharacterMoveTo(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,TRIGGERGUID_S_ARX_DoctorsHouse_Nurse_01_DialogPoint_249e31ef-2a4d-4021-93fd-a91db12f47b5,0,"ARX_DoctorsHouse_TheDoctor_NurseMoved_3",0);

IF
StoryEvent(_,"ARX_DoctorsHouse_TheDoctor_NurseMoved_2")
AND
DB_ARX_DoctorsHouse_TheDoctor_Cut_LookAt(_Char)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_DoctorsHouse_Nurse_01_649673eb-79f4-417f-9703-2a640a284f12,_Char);

IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_TeleportOut",_,_)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"cast_target_loop");

IF
DialogEnded("ARX_DoctorsHouse_TheDoctor",_)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog();

IF
DialogEnded("ARX_DoctorsHouse_TheDoctor_COM_Lohse",_)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog();

PROC
Proc_COMFinished("ARX_DoctorsHouse_TheDoctor_COM_Beast",_)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog();

PROC
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog()
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog()
AND
GlobalGetFlag("ARX_DoctorsHouse_TheDoctor_HostileAfterDialog",1)
AND
CharacterConsume(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"Arena_Initiative_1",_)
THEN
SetRelationFactionToPlayers("ARX_TheDoctor",0);
NOT DB_OriginMomentTag_3SP("ARX_DoctorsHouse_TheDoctor", "BEAST", "ARX_DoctorsHouse_TheDoctor_COM_Beast");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog()
AND
DB_IsPlayer(_Char)
AND
ObjectGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_TeleportOut",1)
THEN
PlayAnimation(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"cast_target_cast");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog()
AND
DB_IsPlayer(_Char)
AND
UserGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_TeleportOut",1)
//AND
//DB_InRegion(_Char,TRIGGERGUID_S_ARX_DoctorsHouse_GroundFloor_6a0dd371-c420-4b93-ba0e-a1aea9531617)
AND
DB_ARX_DoctorsHouse_NPCs(_NPC)
AND
CharacterCanSee(_NPC,_Char,1)
THEN
DB_ARX_DoctorsHouse_TheDoctor_PostDialogWait(_Char);
ObjectClearFlag(_Char,"ARX_DoctorsHouse_TheDoctor_TeleportOut",1);
PlayEffect(_Char,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");
TeleportTo(_Char,TRIGGERGUID_S_RC_ARX_Marker_BlackHouse_b63f99c8-3c48-4ed3-af90-b55f1b99a491);
ApplyStatus(_Char,"KNOCKED_DOWN",1.0,1);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_PostDialog()
AND
NOT DB_ARX_DoctorsHouse_TheDoctor_PostDialogWait(_)
AND
GlobalGetFlag("ARX_DoctorsHouse_TheDoctor_HostileAfterDialog",0)
THEN
GlobalSetFlag("ARX_DoctorsHouse_TheDoctor_RestartSpotter");

IF
CharacterStatusApplied(_Char,"KNOCKED_DOWN",_)
AND
DB_ARX_DoctorsHouse_TheDoctor_PostDialogWait(_Char)
AND
QueryOnlyOnce("ARX_DoctorsHouse_VB_TeleportedOut")
THEN
StartVoiceBark("ARX_DoctorsHouse_VB_TeleportedOut",_Char);

IF
CharacterStatusApplied(_Char,"KNOCKED_DOWN",_)
AND
DB_ARX_DoctorsHouse_TheDoctor_PostDialogWait(_Char)
THEN
NOT DB_ARX_DoctorsHouse_TheDoctor_PostDialogWait(_Char);
GlobalSetFlag("ARX_DoctorsHouse_TheDoctor_RestartSpotter");


IF
GlobalFlagSet("ARX_TheDoctor_PactSealed")
AND
DB_IsPlayer(_Char)
AND
UserGetFlag(_Char,"ARX_TheDoctor_UserAcceptedThePact",0)
AND
DB_InRegion(_Char,TRIGGERGUID_S_ARX_DoctorsHouse_GroundFloor_6a0dd371-c420-4b93-ba0e-a1aea9531617)
AND
DB_ARX_DoctorsHouse_NPCs(_NPC)
AND
CharacterCanSee(_NPC,_Char,1)
THEN
PlayEffect(_Char,"RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01");
TeleportTo(_Char,TRIGGERGUID_S_RC_ARX_Marker_BlackHouse_b63f99c8-3c48-4ed3-af90-b55f1b99a491);
ApplyStatus(_Char,"KNOCKED_DOWN",1.0,1);

IF
GlobalFlagSet("ARX_DoctorsHouse_TheDoctor_Transform")
THEN
Proc_ARX_DoctorsHouse_TheDoctor_Transform();

IF
GlobalFlagSet("ARX_DoctorsHouse_TheDoctor_Transformed")
AND
DB_IsPlayer(_Char)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_TheDoctor_Combat_DemonForm");

//END_REGION

//REGION
IF
CharacterEnteredTrigger(_Char,TRIGGERGUID_S_ARX_DoctorsHouse_GroundFloor_6a0dd371-c420-4b93-ba0e-a1aea9531617)
AND
ObjectGetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_Welcomed",0)
THEN
Proc_ARX_DoctorsHouse_TheDoctor_Welcomed(_Char);

PROC
Proc_ARX_DoctorsHouse_TheDoctor_Welcomed((CHARACTERGUID)_Char)
AND
ObjectGetFlag(_Char,"ARX_TheDoctor_HasInvitation",1)
THEN
ObjectSetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_Welcomed");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_Welcomed((CHARACTERGUID)_Char)
AND
GlobalGetFlag("CoS_SallowMan_IsDead",1)
AND
ObjectGetFlag(_Char,"QuestUpdate_RC_BF_ThePresence_ToldDemonsName",0)
THEN
ObjectSetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_Welcomed");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_Welcomed((CHARACTERGUID)_Char)
AND
ObjectGetFlag(_Char,"ARX_DoctorsHouse_Door_UnlockedDoor",1)
THEN
ObjectSetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_Welcomed");

PROC
Proc_ARX_DoctorsHouse_TheDoctor_Welcomed((CHARACTERGUID)_Char)
AND
CharacterGetReservedUserID(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_User)
AND
CharacterGetReservedUserID(_Char,_User)
THEN
ObjectSetFlag(_Char,"ARX_DoctorsHouse_TheDoctor_Welcomed");

//END_REGION


//REGION blood vials
IF
DB_ARX_DoctorsPact(_Obj,_)
THEN
SetOnStage(_Obj,0);

IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_Cut",(CHARACTERGUID)_Char,_)
AND
DB_ARX_DoctorsPact(_Obj,_Tag)
AND
IsTagged(_Char,_Tag,1)
THEN
DB_HasStoryEvent(_Obj,"ARX_TheDoctor_HasBloodVial");
ItemToInventory(_Obj,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d);
SetOnStage(_Obj,1);
DB_ARX_DoctorsPact_Char(_Char,_Obj);
SetTag(_Char,"BLOODBOUND");

//any crime against the doctor
/*
IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_Id)
AND
DB_ARX_DoctorsPact_Char(_Char,_Obj)
AND
CombatGetIDForCharacter(_Char,_Id)
AND
ItemIsInCharacterInventory(_Obj,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1)
THEN
PlayAnimation(_Char,"RS3_FX_Char_Creature_Demon_Caster_Impact_Possession_Dummy_01");
CharacterDie(_Char,1,"Explode");

IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_Id)
AND
DB_ARX_DoctorsPact_Char(_Char,_Obj)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_Id)
AND
ItemIsInCharacterInventory(_Obj,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1)
THEN
CharacterDie(_Char,1,"Explode");
*/
/*
PROC
ProcCrimeOnCustomSensibleAction((CHARACTERGUID)CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_,_,_,_,_Char,_,_,_,_)
AND
DB_ARX_DoctorsPact_Char(_Char,_Obj)
AND
ItemIsInCharacterInventory(_Obj,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1)
THEN
CharacterDie(_Char,1,"Explode");
*/
//END_REGION

//REGION possession
IF
StoryEvent(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"ARX_DoctorsHouse_TheDoctor_InitiatePossesssDialog")
AND
QueryOnlyOnce("ARX_DoctorsHouse_TheDoctor_PossessionDialog")
AND
StartDialog_Internal("ARX_DoctorsHouse_TheDoctor_Possession",1,CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,
	NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_)
THEN
DB_ARX_TheDoctor_CombatDialog_AddToDialog(1);
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"cower");

IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_Possession_ShowPain",(CHARACTERGUID)_Char,_)
THEN
CharacterSetAnimationOverride(_Char,"stillcrippled");

IF
ObjectFlagCleared("ARX_DoctorsHouse_TheDoctor_Possession_ShowPain",(CHARACTERGUID)_Char,_)
THEN
CharacterSetAnimationOverride(_Char,"");

IF
CharacterStatusApplied(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"DEMONIC_POSSESSION",_)
THEN
Proc_ARX_TheDoctor_Possession();
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_ARX_TheWeakening_TheDoctor_Possessed");

IF
CharacterUsedSkillOnTarget(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"Target_Quest_DemonicPossession_Kill",_,_)
THEN
Proc_ARX_TheDoctor_Possession();

IF
DialogEnded("ARX_DoctorsHouse_TheDoctor_Possession",_)
AND
CharacterGetReservedUserID(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_user)
AND
DB_IsPlayer(_char)
AND
CharacterGetReservedUserID(_char,_user)
AND
_char != CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295
THEN
GlobalSetFlag("ARX_TheDoctor_CheckUserCount_MoreThanOneChar");

PROC
Proc_ARX_TheDoctor_Possession()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Char)
THEN
ObjectSetFlag(_Char,"QuestUpdate_FTJ_COM_Lohse_DoctorPossessed");

PROC
Proc_ARX_TheDoctor_Possession()
AND
GetUserCount(1)
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
HasActiveStatus(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"DEMONIC_POSSESSION",0)
THEN
CharacterDie(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1,"Explode");

PROC
Proc_ARX_TheDoctor_Possession()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
THEN
DB_ARX_LohseAvatarBondAtPossession(_Avatar);

PROC
Proc_ARX_TheDoctor_Possession()
THEN
GlobalSetFlag("ARX_TheDoctor_LohsePossessed");

PROC
Proc_ARX_TheDoctor_Possession()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
AND
HasActiveStatus(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"DEMONIC_POSSESSION",1)
THEN
PROC_Origins_CompanionLeavePermanently(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
SetVarFixedString(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"currentState","");
SetHasDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0);
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_DoctorPossessed");
ObjectSetFlag(_Avatar,"QuestClose_FTJ_COM_Lohse");
SetFaction(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_TheDoctor");

PROC
Proc_ARX_TheDoctor_Possession()
AND
GlobalGetFlag("ARX_TheDoctor_CheckUserCount_MoreThanOneChar",0)
AND
QueryOnlyOnce("ARX_Launch_GLO_GameOver")
THEN
CharacterDie(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1,"Explode");
TimerLaunch("ARX_Launch_GLO_GameOver",2000);

PROC
Proc_ARX_TheDoctor_Possession()
//AND
//GetUserCount(1)
AND
IsTagged(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"AVATAR",1)
AND
QueryOnlyOnce("ARX_Launch_GLO_GameOver")
THEN
CharacterFreeze(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);
TimerLaunch("ARX_Launch_GLO_GameOver",2000);



IF
TimerFinished("ARX_Launch_GLO_GameOver")
THEN
GlobalSetFlag("GLO_GameOver");

PROC
Proc_ARX_TheDoctor_Possession()
THEN
SetTag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"BLOCK_RESURRECTION");
ApplyStatus(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,"INVULNERABLE",-1.0);


IF
CharacterDied(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
NOT DB_CurrentLevel("ARX_Endgame")
THEN
ClearTag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"BLOCK_RESURRECTION");

IF
StoryEvent(_,"ARX_TheDoctor_CheckUserCount")
AND
CharacterGetReservedUserID(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_user)
AND
DB_IsPlayer(_char)
AND
CharacterGetReservedUserID(_char,_user)
AND
_char != CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295
THEN
GlobalSetFlag("ARX_TheDoctor_CheckUserCount_MoreThanOneChar");

IF
DialogStarted("ARX_DoctorsHouse_TheDoctor_Possession",_Inst)
THEN
DB_ARX_TheDoctor_CombatDialog_AddToDialog_Inst(_Inst);

PROC
Proc_ARX_TheDoctor_CombatDialog_AddToDialog((INTEGER)_Inst)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_ID)
AND
DB_IsPlayer(_Char)
AND
NOT DB_DialogPlayers(_,_Char,_)
AND
CombatGetIDForCharacter(_Char,_ID)
THEN
DialogAddActor(_Inst,_Char);

IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_ID)
AND
DB_ARX_TheDoctor_CombatDialog_AddToDialog_Inst(_Inst)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,_ID)
AND
NOT DB_DialogNpcs(_,_Char,_)
AND
NOT DB_DialogPlayers(_,_Char,_)
THEN
DialogAddActor(_Inst,_Char);

IF
DialogEnded("ARX_DoctorsHouse_TheDoctor_Possession",_)
AND
DB_ARX_TheDoctor_CombatDialog_AddToDialog_Inst(_Inst)
THEN
NOT DB_ARX_TheDoctor_CombatDialog_AddToDialog_Inst(_Inst);
CharacterSetAnimationOverride(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"");

QRY
QRY_ARX_DoctorNearLohsePlayer()
AND
CharacterGetReservedUserID(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _ID)
AND
DB_IsPlayer(_Player)
AND
CharacterGetReservedUserID(_Player, _ID)
AND
GetDistanceTo(_Player, CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d, _Distance)
AND
_Distance < 13.0
THEN
DB_NOOP(0);

IF
GlobalFlagSet("ARX_TheDoctor_IsDead")
AND
CharacterIsDead(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,0)
AND
QRY_ARX_DoctorNearLohsePlayer()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _Avatar)
THEN
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_DoctorDefeat");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_TheDoctorIsDead_CRD_Lohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);

IF
GlobalFlagSet("ARX_TheDoctor_IsDead")
AND
CharacterIsDead(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Avatar)
THEN
DB_Queue("ARX_TheDoctorIsDead_CRD_Lohse");

IF
CharacterResurrected(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
DB_Queue("ARX_TheDoctorIsDead_CRD_Lohse")
AND
QRY_ARX_DoctorNearLohsePlayer()
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, _Avatar)
THEN
NOT DB_Queue("ARX_TheDoctorIsDead_CRD_Lohse");
ObjectSetFlag(_Avatar,"QuestUpdate_FTJ_COM_Lohse_DoctorDefeat");
Proc_RelationshipDialog(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"ARX_TheDoctorIsDead_CRD_Lohse",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295);



IF
GlobalFlagSet("ARX_TheDoctor_IsDead")
AND
DB_GlobalFlag("GLO_Lohse_Faced_Doctor")
AND
DB_Avatars((CHARACTERGUID)CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_DoctorDefeat");

IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_GiveScroll",CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,"QuestUpdate_FTJ_OriginLohse_DoctorPact");

//END_REGION

//REGION
IF
DialogStarted("ARX_DoctorsHouse_Door",_)
AND
DB_IsPlayer(_Char)
AND
IsTagged(_Char,"PROMISED",1)
THEN
GlobalSetFlag("ARX_DoctorsHouse_Door_PromisedInGame");
//END_REGION

//REGION journal entries
IF
ObjectFlagSet("ARX_DoctorsHouse_TheDoctor_Banned",_Char,_)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_TheDoctor_BannedFromHouse");

IF
CharacterDied(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
DB_IsPlayer(_Char)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_TheDoctor_TheDoctor_IsDead");

IF
CharacterDied(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,_Char)
THEN
ObjectSetFlag(_Char,"QuestUpdate_FTJ_COM_Lohse_DoctorDefeat");

//END_REGION

//REGION ancestor tree
IF
TextEventSet("tree")
AND
DB_IsPlayer(_Char)
THEN
TimerLaunch("ARX_AncestorTree_Appear",5000);
DB_ARX_AncestorTree_Appear(_Char);


IF
CharacterEnteredTrigger(_Char,TRIGGERGUID_S_ARX_Streets_c7f10608-b8ba-4c67-8e25-2074bde47487)
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_DoctorsHouse_TheDoctor_83083470-c543-45b3-ac8a-108df0daca8d,1)
AND
UserGetFlag(_Char,"QuestUpdate_RC_BI_TheTruth_FoundOutDemonsName",1)
AND
NOT DB_ARX_AncestorTree_Appear(_)
THEN
TimerLaunch("ARX_AncestorTree_Appear",5000);
DB_ARX_AncestorTree_Appear(_Char);

IF
TimerFinished("ARX_AncestorTree_Appear")
THEN
Proc_ARX_AncestorTree_Appear();

PROC
Proc_ARX_AncestorTree_Appear()
AND
DB_ARX_AncestorTree_Appear(_Char)
AND
QRY_SpeakerIsAvailable(_Char)
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
THEN
DB_ARX_AncestorTree_AppearedDialog(_Char);
GlobalSetFlag("ARX_AncestorTree_Appeared");
//CharacterAppearAt(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char,1,"ARX_AncestorTree_Appearing");
NOT DB_ARX_AncestorTree_Appear(_Char);
TeleportTo(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char);
Foop(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353);
Proc_StartDialog(0,"ARX_AncestorTree",CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char);

PROC
Proc_ARX_AncestorTree_Appear()
AND
DB_IsPlayer(_Char)
AND
QRY_SpeakerIsAvailable(_Char)
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
THEN
DB_ARX_AncestorTree_AppearedDialog(_Char);
TeleportTo(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char);
Foop(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353);
GlobalSetFlag("ARX_AncestorTree_Appeared");
//CharacterAppearAt(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char,1,"ARX_AncestorTree_Appearing");
Proc_StartDialog(0,"ARX_AncestorTree",CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char);

PROC
Proc_ARX_AncestorTree_Appear()
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
AND
DB_ARX_AncestorTree_Appear(_Char)
THEN
NOT DB_ARX_AncestorTree_Appear(_Char);
GlobalSetFlag("ARX_AncestorTree_AppearWait");

IF
StoryEvent(_,"ARX_AncestorTree_Appearing")
AND
DB_ARX_AncestorTree_AppearedDialog(_Char)
THEN
Proc_StartDialog(0,"ARX_AncestorTree",CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353,_Char);

IF
ObjectLeftCombat((CHARACTERGUID)_Char,_)
AND
GlobalGetFlag("ARX_AncestorTree_AppearWait",1)
AND
UserGetFlag(_Char,"QuestUpdate_RC_BI_TheTruth_FoundOutDemonsName",1)
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
AND
NOT DB_ARX_AncestorTree_Appear(_)
THEN
DB_ARX_AncestorTree_Appear(_Char);
TimerLaunch("ARX_AncestorTree_Appear",5000);
GlobalClearFlag("ARX_AncestorTree_AppearWait");

IF
DialogEnded(_,_)
AND
GlobalGetFlag("ARX_AncestorTree_AppearWait",1)
AND
DB_IsPlayer(_Char)
AND
UserGetFlag(_Char,"QuestUpdate_RC_BI_TheTruth_FoundOutDemonsName",1)
AND
GlobalGetFlag("ARX_AncestorTree_Appeared",0)
AND
NOT DB_ARX_AncestorTree_Appear(_)
THEN
DB_ARX_AncestorTree_Appear(_Char);
TimerLaunch("ARX_AncestorTree_Appear",5000);
GlobalClearFlag("ARX_AncestorTree_AppearWait");

IF
ObjectFlagSet("ARX_AncestorTree_GiveReward",_Char,_)
THEN
SetOnStage(ITEMGUID_S_ARX_AncestorTree_GhostMace_d10c4bf0-cc3a-4fb8-9191-3b34fe322c2f,1);
ItemToInventory(ITEMGUID_S_ARX_AncestorTree_GhostMace_d10c4bf0-cc3a-4fb8-9191-3b34fe322c2f,_Char);

IF
DialogEnded("ARX_AncestorTree",_)
THEN
Poof(CHARACTERGUID_S_ARX_AncestorTree_4ac4637a-158d-4081-80ac-df18ea17d353);
//END_REGION

//REGION
IF
TextEventSet("doctor3")
THEN
GlobalSetFlag("ARX_TheWeakening_Completed");

//END_REGION

//REGION doctors demons
IF
DB_ARX_TheDoctor_AmbushDemons(_Char,_)
THEN
SetOnStage(_Char,0);

IF
TimerFinished("ARX_TheDoctor_AmbushDemons_Appear")
AND
GlobalGetFlag("ARX_TheWeakening_Completed",0)
AND
NOT DB_ARX_TheDoctor_AmbushDemons_Current(5)
THEN
Proc_ARX_TheDoctor_AmbushDemons_Appear();

PROC
Proc_ARX_TheDoctor_AmbushDemons_Appear()
AND
DB_ARX_TheDoctor_AmbushDemons_Current(_Current)
AND
DB_ARX_TheDoctor_AmbushDemons(_Char,_Current)
THEN
CharacterSetFightMode(_Char,1,1);
CharacterAppear(_Char,1,"");
NOT DB_ARX_TheDoctor_AmbushDemons(_Char,_Current);

PROC
Proc_ARX_TheDoctor_AmbushDemons_Appear()
AND
DB_ARX_TheDoctor_AmbushDemons_Current(_Current)
AND
IntegerSum(_Current,1,_NewCount)
THEN
NOT DB_ARX_TheDoctor_AmbushDemons_Current(_Current);
DB_ARX_TheDoctor_AmbushDemons_Current(_NewCount);

PROC
Proc_ARX_TheDoctor_AmbushDemons_Appear()
AND
NOT DB_ARX_TheDoctor_AmbushDemons_Current(5)
THEN
TimerLaunch("ARX_TheDoctor_AmbushDemons_Appear",250);

//END_REGION

PROC
Proc_ARX_DoctorsHouse_TheDoctor_Transform()
AND
GlobalGetFlag("EG_AppearDoctor",0)
THEN
SetRelationFactionToPlayers("ARX_TheDoctor",0);

//REGION windup toy
IF
GlobalFlagSet("ARX_DoctorsHouse_WindUpToy_Jump")
THEN
CharacterSetFightMode(CHARACTERGUID_S_ARX_DoctorsHouse_WindUpToy_e1bfda93-e66d-44f7-b773-b4a075c6852d,1,0);
GlobalClearFlag("ARX_DoctorsHouse_WindUpToy_Jump");

IF
DialogEnded("ARX_DoctorsHouse_WindUpToy",_)
AND
GlobalGetFlag("ARX_DoctorsHouse_WindUpToy_Explode",0)
THEN
CharacterSetFightMode(CHARACTERGUID_S_ARX_DoctorsHouse_WindUpToy_e1bfda93-e66d-44f7-b773-b4a075c6852d,0,0);

IF
DialogEnded("ARX_DoctorsHouse_WindUpToy",_)
AND
GlobalGetFlag("ARX_DoctorsHouse_WindUpToy_Explode",1)
THEN
CharacterDie(CHARACTERGUID_S_ARX_DoctorsHouse_WindUpToy_e1bfda93-e66d-44f7-b773-b4a075c6852d,1,"DoT");
//END_REGION



IF
ObjectFlagSet(_Flag,(CHARACTERGUID)_Char,_)
AND
DB_ARX_TheDoctor_Knows(_Flag,_NewFlag)
AND
UserGetFlag(_Char,_NewFlag,0)
THEN
ObjectSetFlag(_Char,_NewFlag);

//REGION 
IF
CharacterUsedItem(_Char,ITEMGUID_S_ARX_TheDoctor_FishBarrel_7ab5ed36-5556-4055-ab2c-942894de1dd1)
AND
UserGetFlag(_Char,"ARX_TheDoctor_FishBarrel_Used",0)
THEN
UserSetFlag(_Char,"ARX_TheDoctor_FishBarrel_Used");



//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
