Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_CoS_Temples_ElfCave_Automaton(CHARACTERGUID_S_CoS_Temples_ElfCave_Automaton_001_3242ab1a-db0d-4c3b-a7f1-68c8d62bc651);
DB_CoS_Temples_ElfCave_Automaton(CHARACTERGUID_S_CoS_Temples_ElfCave_Automaton_002_444c20b4-8f62-4903-a0ff-de55707496e0);
DB_CoS_Temples_ElfCave_Automaton(CHARACTERGUID_S_CoS_Temples_ElfCave_Automaton_003_88f85544-1280-4b00-8beb-d05c6747afa4);
DB_CoS_Temples_ElfCave_Automaton(CHARACTERGUID_S_CoS_Temples_ElfCave_Automaton_004_c35234bc-6172-4661-a766-7542b6df79e5);

DB_Dialogs(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,"CoS_Temples_ElfCave_Sword");

ApplyStatus(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,"GROUNDED",-1.0);

SetOnStage(ITEMGUID_S_CoS_WPN_EternalSword_Reward_0bff00c6-23ed-4f0f-a883-bf7ca76326ba,0);
KBSECTION
IF
DB_CoS_Temples_ElfCave_Automaton(_Automaton)
THEN
DB_Dialogs(_Automaton,"CoS_Temples_ElfCave_Automaton");
DB_DoNotFace(_Automaton);
SetStoryEvent(_Automaton,"CreateCapacitorLink");


PROC
Proc_CoS_ElfCaveAutomatons_GoHostile()
AND
QueryOnlyOnce("CoS_Temples_ElfCave_AtmSwap_Once")
THEN
TriggerSetAtmosphere(TRIGGERGUID_AtmosphereTrigger_CoS_SmallCave1_55c628b5-b35e-4a05-b0ef-eaba3cd2b950,"0077f217-0c6b-46c7-b954-741322f3388e");


PROC
ProcBlockMoveOfItem((CHARACTERGUID)_Player,(ITEMGUID)ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33)
THEN
DB_CustomMoveItemResponse(_Player,ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);
Proc_CoS_Temples_ElfCave_TryStartDialog(_Player);

PROC
ProcBlockPickupOfItem((CHARACTERGUID)_Player,(ITEMGUID)ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33)
THEN
DB_CustomPickupItemResponse(_Player,ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);
Proc_CoS_Temples_ElfCave_TryStartDialog(_Player);

PROC
ProcBlockUseOfItem((CHARACTERGUID)_Player,(ITEMGUID)ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33)
THEN
DB_CustomUseItemResponse(_Player,ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);
Proc_CoS_Temples_ElfCave_TryStartDialog(_Player);

PROC
Proc_CoS_Temples_ElfCave_TryStartDialog((CHARACTERGUID)_Player)
AND
QRY_IsAvailableTo(_Player,ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33)
THEN
Proc_StartDialog(0,"CoS_Temples_ElfCave_Sword",ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,_Player);



IF
AttackedByObject(_Automaton,(CHARACTERGUID)_Player,_,_,_)
AND
DB_CoS_Temples_ElfCave_Automaton(_Automaton)
AND
CharacterIsPlayer(_Player,1)
AND
NOT DB_OnlyOnce("CoS_Temples_ElfCave_AutomatonsGoHostile_Once")
THEN
Proc_CoS_ElfCaveAutomatons_GoHostile();
EnterCombat(_Automaton,_Player);

IF
CharacterDied(_Automaton)
AND
DB_CoS_Temples_ElfCave_Automaton(_Automaton)
AND
NOT DB_OnlyOnce("CoS_Temples_ElfCave_AutomatonsGoHostile_Once")
THEN
Proc_CoS_ElfCaveAutomatons_GoHostile();

PROC
Proc_CoS_ElfCaveAutomatons_GoHostile()
THEN
GlobalSetFlag("CoS_Temples_ElfCave_AutomatonsHostile");
ProcForceStopDialog(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33);


PROC
Proc_CoS_ElfCaveAutomatons_GoHostile()
AND
QueryOnlyOnce("CoS_Temples_ElfCave_AutomatonsGoHostile_Once")
AND
DB_CoS_Temples_ElfCave_Automaton(_Automaton)
THEN
SetFaction(_Automaton,"Evil NPC");

IF
ObjectFlagSet("CoS_Temples_ElfCave_SwordToPlayer",_Player,_)
THEN
SetVisible(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);
ItemSetCanInteract(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);
SetOnStage(ITEMGUID_S_CoS_WPN_EternalSword_Reward_0bff00c6-23ed-4f0f-a883-bf7ca76326ba,1);
ItemToInventory(ITEMGUID_S_CoS_WPN_EternalSword_Reward_0bff00c6-23ed-4f0f-a883-bf7ca76326ba,_Player,1);

IF
DialogEnded("CoS_Temples_ElfCave_Sword",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,_Player)
AND
ObjectGetFlag(_Player,"CoS_Temples_ElfCave_SwordToPlayer",1)
AND
GlobalGetFlag("CoS_Temples_ElfCave_AutomatonsHostile",0)
THEN
Proc_CoS_ElfCaveAutomatons_GoHostile();
SetOnStage(ITEMGUID_S_CoS_Temples_ElfCave_Treasure_bf5b269a-555a-4153-b0b4-0bc070885b33,0);

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "CoS_Temples"
