Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Paladins

DB_Dialogs(S_ARX_Prison_ToWindegoGuard1_e58ded34-c56c-4959-9c7b-159529273705,"ARX_Prison_ToWindegoGuard1");
ItemToInventory(S_ARX_PlayerPrisonDoor_ToWindego_Key1_8e584ad8-bca8-486b-8444-8de4cf9ac067,S_ARX_Prison_ToWindegoGuard1_e58ded34-c56c-4959-9c7b-159529273705);
DB_Dialogs(S_ARX_Prison_ToWindegoGuard2_9b70b655-d8f4-4690-9da5-39c364ed3c77,"ARX_Prison_ToWindegoGuard2");
ItemSetOwner(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7,S_ARX_Prison_ToWindegoGuard1_e58ded34-c56c-4959-9c7b-159529273705);


DB_ARX_Prison_ToWindegoGuard(S_ARX_Prison_ToWindegoGuard1_e58ded34-c56c-4959-9c7b-159529273705);
DB_ARX_Prison_ToWindegoGuard(S_ARX_Prison_ToWindegoGuard2_9b70b655-d8f4-4690-9da5-39c364ed3c77);

DB_Dialogs(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,"ARX_Prison_WindegoCell_Paladin");
ObjectSetFlag(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,"ARX_Prison_WindegoCell_Paladin"); // So we can check for that spesific paladin in Group Speaker Text
DB_Dialogs(S_ARX_Prison_WindegoCell_Paladin_Guard1_36c0b27a-f0fb-4a14-bbb2-719a5fed418c,"ARX_Prison_WindegoCell_Paladin_Guard1");
DB_Dialogs(S_ARX_Prison_WindegoCell_Paladin_Guard2_b2e2ebb4-5c01-410e-998a-9ddf00e69513,"ARX_Prison_WindegoCell_Paladin_Guard2");

DB_ARX_Prison_Windego_PaladinGuards((CHARACTERGUID)S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);
DB_ARX_Prison_Windego_PaladinGuards(S_ARX_Prison_WindegoCell_Paladin_Guard1_36c0b27a-f0fb-4a14-bbb2-719a5fed418c);
DB_ARX_Prison_Windego_PaladinGuards(S_ARX_Prison_WindegoCell_Paladin_Guard2_b2e2ebb4-5c01-410e-998a-9ddf00e69513);

CharacterAddGold(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,155);
DB_TrespassTrigger(S_ARX_Prison_WindegoCell_PaladinOnwerShipTirgger_2848eaf9-39a0-4052-9f07-cf666e0a19c4,ARX_Prison_WindegoTresspassing_021f40a2-d394-4cb3-9fd4-3ec52105e1a0,"ARX_Prison_Windego_Trespassing_NearPuzzle",S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);
// Convert to new DB_DialogMoneyTransfer() system if still needed. See https://sites.google.com/a/larian.com/larian-wikisite/osiris-api-tips#TOC-DB_DialogMoneyTransfer
//DB_NPCMoneyInDialog("ARX_Prison_WindegoCell_Paladin_BlackMail1",100,"TakeFromNPC",1);
//DB_NPCMoneyInDialog("ARX_Prison_WindegoCell_Paladin_BlackMail2",50,"TakeFromNPC",1);
//DB_NPCMoneyInDialog("ARX_Prison_WindegoCell_Paladin_BribeToLeave",1000,"GiveNPC",1);

DB_TrespassTrigger(S_ARX_Prison_WayToWindego_Tresspassing_2392a136-41d1-479e-b3a6-90c3514baa7e,S_ARX_Prison_WayToWindego_Tresspassing_OutTrigger_4db124fa-1083-44b7-8321-b87afbfe11f9);

//END_REGION

//Machine To release Windeog
ProcDeclareCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints");
DB_ARX_Barracks_Prison_Windego_Machine(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,2,"OverHeat");
DB_ARX_Barracks_Prison_Windego_Machine(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,4,"Explode");

DB_ARX_Prison_WindegoPuzzle_Runes(ITEMGUID_S_ARX_Barracks_Prison_Windego_MachineRune_1_7e520bc8-ed11-45ca-8fe2-12ffca764339,"On","PUZ_Raanaar_GroundRune_Off_B_cfe5b13a-1883-4ac7-8e28-2d1ab0a7687c",1);
DB_ARX_Prison_WindegoPuzzle_Runes(ITEMGUID_S_ARX_Barracks_Prison_Windego_MachineRune_2_943cf2d7-cec8-481d-afea-256fbdf68bdb,"On","PUZ_Raanaar_GroundRune_Off_B_cfe5b13a-1883-4ac7-8e28-2d1ab0a7687c",2);
DB_ARX_Prison_WindegoPuzzle_Runes(ITEMGUID_S_ARX_Barracks_Prison_Windego_MachineRune_3_79769ab1-4f6f-45bd-9dc7-7ac50191da47,"On","PUZ_Raanaar_GroundRune_Off_B_cfe5b13a-1883-4ac7-8e28-2d1ab0a7687c",3);
DB_ARX_Prison_WindegoPuzzle_Runes(ITEMGUID_S_ARX_Barracks_Prison_Windego_MachineRune_4_5dc90cef-2251-42cb-8c81-2e332c7947c0,"On","PUZ_Raanaar_GroundRune_Off_B_cfe5b13a-1883-4ac7-8e28-2d1ab0a7687c",4);


DB_ARX_Prison_PuzzleBarriarWalls(S_PUZ_Quest_Wall_Magic_A_WithPhysics_000_10e89b34-49ad-477f-b2e5-dd59900f5301);
DB_ARX_Prison_PuzzleBarriarWalls(S_PUZ_Quest_Wall_Magic_A_WithPhysics_001_78a117d6-722e-4c8c-886d-de7fa1330bb1);
DB_ARX_Prison_PuzzleBarriarWalls(S_PUZ_Quest_Wall_Magic_A_WithPhysics_002_d90872b8-72a9-4ff1-a958-932bbd61dbed);
DB_ARX_Prison_PuzzleBarriarWalls(S_PUZ_Quest_Wall_Magic_A_WithPhysics_003_df31458b-cc98-49a1-bd98-82ab3cdd10dc);
DB_ARX_Prison_PuzzleBarriarWalls(S_PUZ_Quest_Wall_Magic_A_WithPhysics_004_23380c5f-bbe3-4780-b3d2-c2906eb1a84e);
//REGION Journal


ProcTriggerRegisterForPlayers(S_ARX_Prison_WindegosCell_23bfdf1c-6617-4d76-9557-7e766aaca53b);
ProcTriggerRegisterForPlayers(S_ARX_Prison_WindegoCell_SecretPassageEntered_041e1045-2c7f-4101-a16b-f24ccffc3590);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Prison_WindegoCell_SecretPassageEntered_02_1f04d0fb-84c0-4db4-8c05-179211581a08);
DB_ARX_Prison_WindegoCell_SecretPassageEntered_Trigger(S_ARX_Prison_WindegoCell_SecretPassageEntered_041e1045-2c7f-4101-a16b-f24ccffc3590);
DB_ARX_Prison_WindegoCell_SecretPassageEntered_Trigger(TRIGGERGUID_S_ARX_Prison_WindegoCell_SecretPassageEntered_02_1f04d0fb-84c0-4db4-8c05-179211581a08);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_1460d0ae-3117-41fb-9f43-681a58b1eac6);

//END_REGION

Proc_RegisterPartyDecisionDialogOutcomes_Fixed("ARX_Prison_PDD_WhatToDoWithWindego","ARX_Prison_Windego_Chosen_Spare","ARX_Prison_Windego_Chosen_Kill","ARX_Prison_Windego_Chosen_GiveSwornBreaker","","");
Proc_RegisterPartyDecisionDialogOutcomes_Fixed("ARX_Prison_PDD_Windego_SecondSwornbreaker","ARX_Prison_Windego_Second_Give","ARX_Prison_Windego_Second_DontGive","","","");

//Secret Region
LockSecretRegion(TRIGGERGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretRegion_0e386e3c-1713-43fd-a7b1-10998be4156c);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretRegion_0e386e3c-1713-43fd-a7b1-10998be4156c);
SetVisible(ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_463b685b-9612-42b6-8c44-0811ebbe8919,0);
KBSECTION
/*
//REGION Custom Trespassing Crime 
IF
DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger)
THEN
DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000);

PROC
proc_Remove_DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger)
THEN
proc_Remove_DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000);

PROC
proc_Remove_DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)_Victim)
AND
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_OutTrigger,_Victim)
THEN
NOT DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_OutTrigger,_Victim);

PROC
proc_Remove_DB_ARX_WindegosPuzzle_TrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)_Victim)
AND
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_OutTrigger)
THEN
NOT DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_OutTrigger);

IF
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_,_)
THEN
ProcTriggerRegisterForPlayers((TRIGGERGUID)_Trigger);

IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_,_Victim)
AND
DB_IsPlayer(_Player)
THEN
DB_PlayerTrespassing(_Player,_Trigger);
CharacterRegisterCrime(_Player,"ARX_Prison_Windego_Trespassing_NearPuzzle",(TRIGGERGUID)_Trigger,(CHARACTERGUID)_Victim,0);

IF
CharacterLeftTrigger(_Player,_Trigger)
AND
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_,_Victim)
THEN
CharacterStopCrime(_Player,"ARX_Prison_Windego_Trespassing_NearPuzzle",_Trigger);
NOT DB_PlayerTrespassing(_Player,_Trigger);

IF
DialogEnded(_,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_FirstPlayer)
AND
ObjectGetFlag(_FirstPlayer,"TeleportOutOfTrespass",1)
AND
DB_PlayerTrespassing((CHARACTERGUID)_FirstPlayer,_Trigger)
AND
DB_ARX_WindegosPuzzle_TrespassTrigger(_Trigger,_Outside,_)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
TeleportTo(_Player,_Outside);
NOT DB_PlayerTrespassing(_FirstPlayer,_Trigger);
ObjectClearFlag(_FirstPlayer,"TeleportOutOfTrespass",0);

IF
CharacterSelectedAsBestUnavailableFallbackLead(_NPC,_Region,_UnavailableCrimeId,_BusyCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
CrimeGetType(_UnavailableCrimeId,"ARX_Prison_Windego_Trespassing_NearPuzzle")
AND
CrimeGetType(_BusyCrimeID,"ARX_Prison_Windego_Trespassing_NearPuzzle")
AND
DB_DialogNPCs(_ID,_NPC,1)
AND
DB_DialogPlayers(_ID,_Player1,1)
THEN
ProcForceStopDialog(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);
ProcForceStopDialog(S_ARX_Prison_WindegoCell_Paladin_Guard1_36c0b27a-f0fb-4a14-bbb2-719a5fed418c);
ProcForceStopDialog(S_ARX_Prison_WindegoCell_Paladin_Guard2_b2e2ebb4-5c01-410e-998a-9ddf00e69513);
Proc_CharacterSetTemporaryHostileRelation(_NPC,_Criminal1);
Proc_StartDialog(1,"ARX_AD_Prison_Windego_Trespassing_NearPuzzle_StartCombat",_NPC);

IF
CharacterDied(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366)
THEN
NOT DB_ARX_WindegosPuzzle_TrespassTrigger(S_ARX_Prison_WindegoCell_PaladinOnwerShipTirgger_2848eaf9-39a0-4052-9f07-cf666e0a19c4,ARX_Prison_WindegoTresspassing_021f40a2-d394-4cb3-9fd4-3ec52105e1a0,S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);

//END_REGION
*/
//REGION Init
PROC
ProcRegionStarted("ARX_Main")
AND
CharacterIsDead(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,1)
AND
QueryOnlyOnce("ARX_Prison_Windego_RessurectIfDead")
THEN
CharacterResurrect(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
NOT DB_Dead(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182); //This was only happening one frame after the ressurect call which used to case her to lose her dialog
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_Windego_SheWasDead");

PROC
ProcRegionStarted("ARX_Main")
AND
QueryOnlyOnce("ARX_Prison_Windego_SetUpWindego")
THEN
SetOnStage(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,1);
TeleportTo(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,ARX_Prison_WindegosPrisonCell_73e42cc2-40b0-4ce0-b553-63413c0ca475);
ProcRemoveAllDialogEntriesForSpeaker(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182); // If she still has her FTJ Dialog
DB_NoLowAttitudeDialog(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
DB_Dialogs(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_Windego");
ProcCharacterDisableAllCrimes(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
CharacterLevelUpTo(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,17);
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_FTJ_EscapedPrisoner_IsInARX");
SetTag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"BLOCK_PICKPOCKET");
Transform(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"UNIQUE_Windego_Undead_6d42f147-f097-4a9d-9cc0-ab6e53213c5b",0);
ApplyStatus(S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288,"FEAR",-1.0);
ItemTemplateAddTo("LOOT_Source_Orb_106a7107-cf36-4331-b5b5-6de71969f370",S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288,2);
proc_ARX_Prison_Windego_SetUpWindego_GhostSetUp(S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288);
ItemToInventory(S_GLO_Windego_2SP_SourceOrb1_010c950c-7621-4883-bdb5-9d349b13e3da,S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
ItemToInventory(S_GLO_Windego_2SP_SourceOrb2_b916a156-aa29-4532-8270-c8f70991dcac,S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
ProcSetInvulnerable(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,1);
ProcRemoveSourceCollar(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
ApplyStatus(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"GROUNDED",-1.0,1);
SetFaction(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Windego");
DB_HideEquippedWeapon(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
DB_HideEquippedShield(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182); //for Windego's duel wands

//DOSTWO-27004 When Windegoe goes into combat
IF
ObjectEnteredCombat(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
AND
DB_HideEquippedWeapon(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182)
THEN
Proc_EquipHiddenWeapon(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
Proc_EquipHiddenShield(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

PROC
proc_ARX_Prison_Windego_SetUpWindego_GhostSetUp((CHARACTERGUID)_Windego)
AND
DB_Ghosts(_Windego,_Ghost,_Dialog)
THEN
DestroyGhost(_Ghost);
NOT DB_Ghosts(_Windego,_Ghost,_Dialog);


PROC
proc_ARX_Prison_Windego_SetUpWindego_GhostSetUp((CHARACTERGUID)_Windego)
THEN
DB_Ghosts(S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288,"ARX_Prison_Windego_Ghost");

IF
ObjectFlagSet("ARX_Prison_FTJ_EscapedPrisoner_IsInARX",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID)
THEN
SetVarInteger(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"FleeFromDangerousSurface",0);
SetCanFight(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,0);

//END_REGION 

//REGION Releasing Windego // Talking to the Device

IF
CharacterUsedSkillOnTarget(_Player,S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
AND
DB_TrespassTrigger(_Trigger,_,"ARX_Prison_Windego_Trespassing_NearPuzzle",_Victim)
THEN
DB_PlayerTrespassing((CHARACTERGUID)_Player,(TRIGGERGUID)_Trigger);
CharacterRegisterCrime((CHARACTERGUID)_Player,"ARX_Prison_Windego_Trespassing_NearPuzzle",(TRIGGERGUID)_Trigger,(CHARACTERGUID)_Victim,0);

PROC
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player)
THEN
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_1", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_2", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_3", 0);

PROC
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player)
AND
CharacterGetSourcePoints(_Player, _Amount)
AND
_Amount > 0
THEN
ObjectSetFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints", 0);

PROC
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player)
AND
CharacterGetSourcePoints(_Player, _Amount)
AND
_Amount >= 1
THEN
ObjectSetFlag(_Player,"ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_1", 0);

PROC
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player)
AND
CharacterGetSourcePoints(_Player, _Amount)
AND
_Amount >= 2
THEN
ObjectSetFlag(_Player,"ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_2", 0);


PROC
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player)
AND
CharacterGetSourcePoints(_Player, _Amount)
AND
_Amount >= 3
THEN
ObjectSetFlag(_Player,"ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_3", 0);

IF
CharacterUsedItem(_Player,S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1)
AND
CharacterIsInCombat(_Player,0)
THEN
Proc_StartDialog(0,"ARX_Barracks_Prison_Windego_CellDevice", S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,_Player);
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player);


IF
CharacterUsedItem(_Player,S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1)
AND
CharacterIsInCombat(_Player,1)
AND
QRY_SpeakerIsAvailable(_Player,1)
AND
StartDialog_Internal("ARX_Barracks_Prison_Windego_CellDevice",1,S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,_Player,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_Noop(1);
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player);

IF
DialogEnded("ARX_Barracks_Prison_Windego_CellDevice",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints",1)
THEN
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_1", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_2", 0);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerHaveSourcePoints_3", 0);


IF
ObjectFlagSet("ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_1",_Player,_)
THEN
Proc_ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_ToMachine((CHARACTERGUID)_Player,1);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_1", 0);

IF
ObjectFlagSet("ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_2",_Player,_)
THEN
Proc_ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_ToMachine((CHARACTERGUID)_Player,2);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_2", 0);

IF
ObjectFlagSet("ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_3",_Player,_)
THEN
Proc_ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_ToMachine((CHARACTERGUID)_Player,3);
ObjectClearFlag(_Player, "ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_3", 0);

PROC
Proc_ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_ToMachine((CHARACTERGUID)_Player,(INTEGER)_Amount)
AND
IntegerProduct(-1, _Amount, _AmountToRemove)
THEN
CharacterAddSourcePoints(_Player,_AmountToRemove);
ProcIncreaseCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Amount);
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceAddedToDevice_01"); // TODO: Change the name of this effect
Proc_ShakeCameraForTime(_Player,200);
proc_ARX_Barracks_Prison_Windego_CellGenerator_CalculateSP((CHARACTERGUID)_Player);

IF
CharacterUsedSkillOnTarget(_Player,S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"Target_Item_ReplenishSource",_,_)
THEN
ProcObjectTimer(_Player,"ARX_Prison_WindegoCell_CastReplanishSource",1000);


PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"ARX_Prison_WindegoCell_CastReplanishSource")
AND
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Num)
AND
DB_ARX_Barracks_Prison_Windego_Machine(_Machine,_NumToExplode,"Explode")
AND
IntegerSubtract(_NumToExplode,1,_NumToExplodeLessOne)
AND
_Num == _NumToExplodeLessOne
THEN
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player);
ObjectSetFlag(_Player, "QuestUpdate_ARX_Prison_Windego_PuzzleSolved");
GlobalSetFlag("ARX_Prison_WindegoCell_PuzzleSolved");
Proc_ARX_Prison_Windego_PaladinGuards_Hostile(_Player);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"ARX_Prison_WindegoCell_CastReplanishSource")
AND
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Num)
AND
DB_ARX_Barracks_Prison_Windego_Machine(_Machine,_NumToExplode,"Explode")
AND
_Num < _NumToExplode
THEN
CharacterRegisterCrime(_Player,"UseForbiddenItem",S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,NULL_00000000-0000-0000-0000-000000000000,0);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"ARX_Prison_WindegoCell_CastReplanishSource")
THEN
ProcIncreaseCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",1);
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceAddedToDevice_01"); 
Proc_ShakeCameraForTime(_Player,200);

PROC
Proc_ARX_Prison_Windego_PaladinGuards_Hostile((CHARACTERGUID)_Player)
AND
DB_ARX_Prison_Windego_PaladinGuards(_Paladin)
AND
NOT DB_Dead(_Paladin)
AND
ObjectIsOnStage(_Paladin,1)
THEN
ProcForceStopDialog(_Paladin);
ProcMakeNPCHostile((CHARACTERGUID)_Paladin,_Player);

IF
ObjectSourcePointAddRequest(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,_AddSP,_WasSP)
THEN
ProcIncreaseCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_AddSP);
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceAddedToDevice_01"); // TODO: Change the name of this effect
Proc_CameraShakeAroundCharacter(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,25,4.0);


IF
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Num)
AND
DB_ARX_Barracks_Prison_Windego_Machine(_Machine,_NumToOverHeat,"OverHeat")
AND
_Num >= _NumToOverHeat
AND
QueryOnlyOnce("ARX_Barracks_Prison_Windego_Machine_IsOverHitting")
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Raanaar_Lamp_A_Overheat_01",_Machine,"ARX_Barracks_Prison_Windego_Machine_IsOverHitting","ARX_Main","Dummy_LTS_Raanaar_Lamp_A");
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect((ITEMGUID)_Machine,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceMachine_Hit_01");
ObjectSetFlag(_Machine,"ARX_Barracks_Prison_Windego_Machine_IsOverHitting");

IF
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Num)
AND
DB_ARX_Barracks_Prison_Windego_Machine(_Machine,_NumToExplode,"Explode")
AND
_Num >= _NumToExplode
AND
QueryOnlyOnce("ARX_Barracks_Prison_Windego_Machine_Exploded")
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Raanaar_Lamp_A_Exploded_01",_Machine,"ARX_Barracks_Prison_Windego_Machine_Exploded","ARX_Main","Dummy_LTS_Raanaar_Lamp_A");
PROC_StopLoopEffect(_Machine,"ARX_Barracks_Prison_Windego_Machine_IsOverHitting");
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect((ITEMGUID)_Machine,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceMachine_Hit_01");
ObjectSetFlag(_Machine,"ARX_Barracks_Prison_Windego_Machine_Exploded");
//Transform(_Machine,"LTS_Raanaar_Lamp_Off_A_f3372f01-755a-47e6-9380-129b67bbc11b",1);

//Flags to not let the player add too much SP
IF
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",2)
THEN
ObjectSetFlag(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"ARX_Barracks_Prison_Windego_Machine_Needs2SP");

IF
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",3)
THEN
ObjectSetFlag(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"ARX_Barracks_Prison_Windego_Machine_Needs1SP");


//Turning on and off the runes
IF
DB_GlobalCounter("ARX_Barracks_Prison_Windego_MachineSourcePoints",_Num)
AND
DB_ARX_Prison_WindegoPuzzle_Runes(_Rune,"On",_OffRoot,_Index)
AND
_Index <= _Num  
THEN
Transform((ITEMGUID)_Rune,_OffRoot);
NOT DB_ARX_Prison_WindegoPuzzle_Runes(_Rune,"On",_OffRoot,_Index);
DB_ARX_Prison_WindegoPuzzle_Runes(_Rune,"Off",_OffRoot,_Index);

PROC
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect((ITEMGUID)_ITEM,(STRING)_EffectName)
AND
GetPosition(_ITEM,_X,_Y,_Z)
AND
RealSum(_Y,1.5,_NewY)
THEN
PlayEffectAtPosition(_EffectName,_X,_NewY,_Z);

IF
DialogEnded("ARX_Barracks_Prison_Windego_CellDevice",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"ARX_Prison_Windego_PlayerOpenedCell",1)
AND
QueryOnlyOnce("ARX_Prison_Windego_PlayerOpenedCell")
THEN
Proc_ARX_Prison_Windego_PaladinGuards_Hostile(_Player);
GlobalSetFlag("ARX_Prison_WindegoCell_PuzzleSolved");
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player);
ObjectSetFlag(_Player, "QuestUpdate_ARX_Prison_Windego_PuzzleSolved");

IF
GlobalFlagSet("ARX_Prison_WindegoCell_PuzzleSolved")
AND
DB_ARX_Prison_PuzzleBarriarWalls(_Wall)
THEN
SetOnStage(_Wall,0);

IF
GlobalFlagSet("ARX_Prison_WindegoCell_PuzzleSolved")
THEN
ProcForceStopDialog(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
ProcCharacterEnableAllCrimes(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
ProcCharacterMoveTo(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,S_ARX_Prison_WindegoCell_OutOfCellPoint_61dc0970-0800-4194-b77a-5832d1e1d374,0,"ARX_Prison_WindegoCell_WindegoLeftCell");
SetVarInteger(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"FleeFromDangerousSurface",1);
SetCanFight(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,1);
ClearTag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"BLOCK_PICKPOCKET");
ProcSetInvulnerable(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,0);
RemoveStatus(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"GROUNDED");


IF
StoryEvent(_Char,"ARX_Prison_WindegoCell_WindegoLeftCell")
AND
NOT DB_ARX_Prison_Windego_PlayerOpenedCell(_)
THEN
Proc_ARX_Prison_WindegoCell_WindegoLeftCell((CHARACTERGUID)_Char);

IF
StoryEvent(_Char,"ARX_Prison_WindegoCell_WindegoLeftCell")
AND
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player)
AND
CharacterIsInCombat((CHARACTERGUID)_Player,0)
THEN
Proc_ARX_Prison_WindegoCell_WindegoLeftCell((CHARACTERGUID)_Char);

IF
StoryEvent(_Char,"ARX_Prison_WindegoCell_WindegoLeftCell")
AND
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player)
AND
CharacterIsInCombat((CHARACTERGUID)_Player,1)
AND
CombatGetIDForCharacter((CHARACTERGUID)_Player,_CombatID)
THEN
ProcSetRelationToPlayers((CHARACTERGUID)_Char,100);
Proc_StartDialog(1,"ARX_AD_Prison_Windego",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
DB_ARX_Prison_WindegoCell_WindegoLeftCell_StartDialogAfterCombat((CHARACTERGUID)_Char,_CombatID);

IF
CombatEnded(_CombatID)
AND
DB_ARX_Prison_WindegoCell_WindegoLeftCell_StartDialogAfterCombat((CHARACTERGUID)_Char,_CombatID)
THEN
ProcSetRelationToPlayers(_Char,50);
NOT DB_ARX_Prison_WindegoCell_WindegoLeftCell_StartDialogAfterCombat(_Char,_CombatID);
Proc_ARX_Prison_WindegoCell_WindegoLeftCell(_Char);


PROC
Proc_ARX_Prison_WindegoCell_WindegoLeftCell((CHARACTERGUID)_Char)
AND
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player)
AND
CharacterCanSee((CHARACTERGUID)_Char,(CHARACTERGUID)_Player,1)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(0,"ARX_Prison_Windego",_Char,_Player);

PROC
Proc_ARX_Prison_WindegoCell_WindegoLeftCell((CHARACTERGUID)_Char)
AND
DB_ARX_Prison_Windego_PlayerOpenedCell(_Player)
AND
CharacterCanSee((CHARACTERGUID)_Char,(CHARACTERGUID)_Player,0)
AND
QRY_GetClosestAvailableCharacterTo(_Char,1)
AND
DB_ClosestAvailableCharacterTo(_Player2,_Char,_)
THEN
Proc_StartDialog(0,"ARX_Prison_Windego",_Char,_Player2);

PROC
Proc_ARX_Prison_WindegoCell_WindegoLeftCell((CHARACTERGUID)_Char)
AND
NOT DB_ARX_Prison_Windego_PlayerOpenedCell(_)
AND
QRY_GetClosestAvailableCharacterTo(_Char,1)
AND
DB_ClosestAvailableCharacterTo(_Player,_Char,_)
THEN
Proc_StartDialog(0,"ARX_Prison_Windego",_Char,_Player);
//END_REGION

//REGION Handling Teleporting to Windego

IF
CharacterUsedSkillAtPosition(_Player,_sX,_sY,_sZ,_Skill,"jump",_)  
AND
PositionIsInTrigger(_sX,_sY,_sZ,TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_1460d0ae-3117-41fb-9f43-681a58b1eac6,1)
AND
GetPosition(_Player,_X,_Y,_Z)
THEN
Proc_Update_DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z);

PROC
Proc_Update_DB_ARX_Prison_WindegosPrisonCell_BlockTeleport((CHARACTERGUID)_Player,(REAL)_X,(REAL)_Y,(REAL)_Z)
AND
DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z)
THEN
NOT DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z);

PROC
Proc_Update_DB_ARX_Prison_WindegosPrisonCell_BlockTeleport((CHARACTERGUID)_Player,(REAL)_X,(REAL)_Y,(REAL)_Z)
THEN
DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_1460d0ae-3117-41fb-9f43-681a58b1eac6)
AND
NOT DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_,_,_)
THEN
TeleportTo(_Player,TRIGGERGUID_S_ARX_Prison_WindegoCell_OutOfCellPoint_61dc0970-0800-4194-b77a-5832d1e1d374);
PlayEffect(_Player,"RS3_FX_Char_Creatures_Shriker_LightningBolt_Impact_01");
PlayEffect(TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_Effect_302bc9b1-410b-45de-84da-34cfb0f25481,"RS3_FX_GP_Combat_Hit_MagicalArmor_01");
ProcObjectTimer(_Player,"ARX_Prison_WindegosPrisonCell_BlockTeleport",10); //Waiting for code to release the character to applay the status

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_1460d0ae-3117-41fb-9f43-681a58b1eac6)
AND
DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z)
THEN
NOT DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z);
//PlayEffect(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"RS3_FX_GP_Impacts_Air_LightningBolt_Vertical_01");
TeleportToPosition(_Player,_X,_Y,_Z,"",0);
PlayEffect(_Player,"RS3_FX_Char_Creatures_Shriker_LightningBolt_Impact_01");
PlayEffect(TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_Effect_302bc9b1-410b-45de-84da-34cfb0f25481,"RS3_FX_GP_Combat_Hit_MagicalArmor_01");
ProcObjectTimer(_Player,"ARX_Prison_WindegosPrisonCell_BlockTeleport",10); //Waiting for code to release the character to applay the status

PROC
ProcObjectTimerFinished(_Player,"ARX_Prison_WindegosPrisonCell_BlockTeleport")
THEN
ApplyStatus(_Player,"KNOCKED_DOWN",4.0,1);

IF
GlobalFlagSet("ARX_Prison_WindegoCell_PuzzleSolved")
AND
DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z)
THEN
NOT DB_ARX_Prison_WindegosPrisonCell_BlockTeleport(_Player,_X,_Y,_Z);

IF
GlobalFlagSet("ARX_Prison_WindegoCell_PuzzleSolved")
THEN
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_Prison_WindegosPrisonCell_BlockTeleport_1460d0ae-3117-41fb-9f43-681a58b1eac6);
//END_REGION 

//REGION Convising The Paladin
IF
DialogEnded("ARX_Prison_WindegoCell_Paladin",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Prison_WindegoCell_PaladinLeave",1)
THEN
SetHasDialog(_NPC,0);
Proc_StartDialog(1,"ARX_AD_Prison_WindegoCell_Paladin_Leave",_NPC);
ProcRemoveDBTrespassTrigger(S_ARX_Prison_WayToWindego_Tresspassing_2392a136-41d1-479e-b3a6-90c3514baa7e,S_ARX_Prison_WayToWindego_Tresspassing_OutTrigger_4db124fa-1083-44b7-8321-b87afbfe11f9);

IF
DialogEnded("ARX_Prison_Windego_Trespassing_NearPuzzle",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Prison_WindegoCell_PaladinLeave",1)
THEN
SetHasDialog(_NPC,0);
TriggerClearItemOwner(S_ARX_Prison_WindegoCell_PaladinOnwerShipTirgger_2848eaf9-39a0-4052-9f07-cf666e0a19c4);
ProcRemoveDBTrespassTrigger(S_ARX_Prison_WayToWindego_Tresspassing_2392a136-41d1-479e-b3a6-90c3514baa7e,S_ARX_Prison_WayToWindego_Tresspassing_OutTrigger_4db124fa-1083-44b7-8321-b87afbfe11f9);
Proc_StartDialog(1,"ARX_AD_Prison_WindegoCell_Paladin_Leave",_NPC);

IF
DialogEnded("ARX_Prison_Windego_Trespassing_NearPuzzle",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Prison_WindegoCell_PaladinLeave",1)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
CharacterStopCrime((CHARACTERGUID)_Player,"ARX_Prison_Windego_Trespassing_NearPuzzle",NULL_00000000-0000-0000-0000-000000000000);

IF
AutomatedDialogStarted("ARX_AD_Prison_WindegoCell_Paladin_Leave",_ID)
AND
DB_ARX_Prison_Windego_PaladinGuards(_Guard)
AND
_Guard != S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366
THEN
ProcForceStopDialog(_Guard);
SetHasDialog(_Guard,0);
CharacterLookAt(_Guard,S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);

IF
AutomatedDialogEnded("ARX_AD_Prison_WindegoCell_Paladin_Leave",_ID)
AND
DB_ARX_Prison_Windego_PaladinGuards(_Guard)
THEN
ProcForceStopDialog(_Guard); // Just in case the dialog failed
SetHasDialog(_Guard,0); // Just in case the dialog failed
ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ent_b9c27482-6226-4f8a-9164-2ad8fad5fb19,0,"ARX_Prison_WindegoCell_Paladin_Disappeared");
//ProcCharacterDisappearOutOfSight((CHARACTERGUID)_Guard,180,0,"ARX_Prison_WindegoCell_Paladin_Disappeared",0);

IF
AutomatedDialogEnded("ARX_AD_Prison_WindegoCell_Paladin_Leave",_ID)
THEN
ItemUnLock(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7);

IF
StoryEvent(_NPC,"ARX_Prison_WindegoCell_Paladin_Disappeared")
THEN
SetOnStage(_NPC,0);

IF
StoryEvent(_NPC,"ARX_Prison_WindegoCell_Paladin_Disappeared")
THEN
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoCell_Paladin_Disappeared");

IF
TextEventSet("SetAnimation")
THEN
CharacterSetAnimationOverride(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"BehindBars_01");

IF
CharacterDied(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366)
THEN
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoCell_Paladin_Disappeared");
ARX_Prison_Windego_PaladinGuards_Leave();

PROC 
ARX_Prison_Windego_PaladinGuards_Leave()
AND
DB_ARX_Prison_Windego_PaladinGuards(_Guard)
AND
CharacterIsDead((CHARACTERGUID)_Guard,0)
AND
CharacterIsInCombat(_Guard,0)
THEN
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_Guard,0,0,"ARX_Prison_WindegoCell_Paladin_Disappeared",1);

PROC 
ARX_Prison_Windego_PaladinGuards_Leave()
AND
DB_ARX_Prison_Windego_PaladinGuards(_Guard)
AND
CharacterIsDead((CHARACTERGUID)_Guard,0)
AND
CharacterIsInCombat(_Guard,1)
AND
DB_CombatCharacters(_Guard,_ID)
THEN
DB_ARX_Prison_Windego_PaladinGuards_Leave_AfterCombat(_Guard,_ID);

IF
CombatEnded(_ID)
AND
DB_ARX_Prison_Windego_PaladinGuards_Leave_AfterCombat(_Guard,_ID)
AND
CharacterIsDead((CHARACTERGUID)_Guard,0)
THEN
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_Guard,180,0,"ARX_Prison_WindegoCell_Paladin_Disappeared",1);
//END_REGION

//REGION Windegos ADs 

IF
ObjectEnteredCombat(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_ID)
AND
CombatGetInvolvedPlayer(_ID,1,_Player)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee((CHARACTERGUID)S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,(CHARACTERGUID)S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,1)
THEN
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoCell_WindegoSawCombatStart");
Proc_StartDialog(1,"ARX_AD_Prison_Windego",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
ObjectFlagSet("ARX_Prison_WindegoCell_Paladin_Disappeared",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_)
THEN
Proc_StartDialog(1,"ARX_AD_Prison_Windego",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
GlobalFlagSet("ARX_Prison_WindegoCell_PuzzleSolved")
THEN
Proc_StartDialog(1,"ARX_AD_Prison_Windego",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
//END_REGION

//REGION Windego goes away

IF
DialogEnded("ARX_Prison_Windego",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182)
AND
ObjectGetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoEscaped",1)
AND
GlobalGetFlag("ARX_Prison_Windego_DiedSwornbreaker",0)
AND
QueryOnlyOnce("ARX_Prison_WindegoEscaped_Obj")
THEN
Poof(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
GlobalSetFlag("ARX_Prison_WindegoEscaped");
Proc_ARX_PrisonWindegoPoofRatIfAlive();

IF
DialogEnded("ARX_Prison_Windego",_ID)
AND
GlobalGetFlag("ARX_Prison_Windego_DiedSwornbreaker",1)
THEN
CharacterDieImmediate(d783285f-d3be-4cba-8333-CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,1,"DoT");


IF
DialogEnded("ARX_Prison_Windego",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"ARX_Prison_Windego_PlayerGavePromiseBreaker",1)
THEN
StartVoiceBark("ARX_Prison_VB_Windego_PlayerGavePromiseBreaker",_Player);

IF
DialogEnded("ARX_Prison_Windego",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_Windego_FightPlayer",1)
THEN
ProcMakeNPCHostile(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_Player);
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
ObjectEnteredCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_CombatID)
AND
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182)
THEN
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_CombatID);
NOT DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
ObjectSwitchedCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_OldCobmatId,_NewCombatId)
AND
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_OldCobmatId)
THEN
NOT DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_OldCobmatId);
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_NewCombatId);

IF
CombatEnded(_ID)
AND
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID)
THEN
NOT DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID);

IF
ObjectLeftCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID)
AND
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID)
AND
CharacterIsDead(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,0)
THEN
NOT DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,_ID);
ObjectSetFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoEscaped");
Proc_StartDialog(1,"ARX_AD_Prison_Windego_PostFight",S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
GlobalFlagSet("ARX_Prison_WindegoEscaped")
AND
DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182)
THEN
NOT DB_ARX_Prison_WindeogoDisappearAfterCombat(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);

IF
AutomatedDialogEnded("ARX_AD_Prison_Windego_PostFight",_)
THEN
Poof(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
Proc_ARX_PrisonWindegoPoofRatIfAlive();
GlobalSetFlag("ARX_Prison_WindegoEscaped");

PROC
Proc_ARX_PrisonWindegoPoofRatIfAlive()
AND
CharacterIsDead(S_ARX_Barracks_MainHall_Rat_c7ab563d-8320-4f2a-97f9-3f6db03e41ce,0)
THEN
Poof(S_ARX_Barracks_MainHall_Rat_c7ab563d-8320-4f2a-97f9-3f6db03e41ce);

PROC
Proc_GLO_PromiseBreak_Effect_Accept(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182)
AND
DB_CurrentLevel(_CurLevel)
THEN
ProcObjectTimer(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"S_FTJ_SW_EscapedPrisoner_PlayDeath",1500);

PROC
ProcObjectTimerFinished(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"S_FTJ_SW_EscapedPrisoner_PlayDeath")
THEN
CharacterSetAnimationOverride(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"die_crush");
GlobalSetFlag("ARX_Prison_Windego_DiedSwornbreaker");
//END_REGION

//REGION EnteredTheRoom From the Secret Passage
/*
IF
CharacterUsedItem(_Player,S_ARX_Prison_SecretRoom_ToWindegoCell_7235b773-54b2-4085-9d42-f74f0a5bec4d) // Windego cell moved away from the Secret Passage ( will need to REgister for Arhu's Keeper Or remove the Secret passage )
THEN
ObjectSetFlag(_Player,"ARX_Prison_WindegoCell_PlayerUsedSceretPassage");
*/
IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_ARX_Prison_WindegoCell_SecretPassageEntered_Trigger(_Trigger)
AND
CharacterCanSee(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_Player,1)
AND
QueryOnlyOnce("ARX_Prison_WindegoCell_PlayerUsedSceretPassage")
THEN
CharacterLookAt(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_Player);
Proc_StartDialog(1,"ARX_AD_Prison_WindegoCell_Paladin",S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366);


//END_REGION

//REGION Door to Windego
IF
CharacterDied(S_ARX_Prison_ToWindegoGuard1_e58ded34-c56c-4959-9c7b-159529273705)
AND
CharacterIsDead(S_ARX_Prison_ToWindegoGuard2_9b70b655-d8f4-4690-9da5-39c364ed3c77,0)
THEN
ItemSetOwner(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7,S_ARX_Prison_ToWindegoGuard2_9b70b655-d8f4-4690-9da5-39c364ed3c77);

IF
DialogEnded("ARX_Prison_ToWindegoGuard1",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_Prison_ToWindegoGuard1_PersuasionSuccuss",1)
THEN
ItemUnlockAndOpen(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7);
ItemClearOwner(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7);
ProcRemoveDBTrespassTrigger(S_ARX_Prison_WayToWindego_Tresspassing_2392a136-41d1-479e-b3a6-90c3514baa7e,S_ARX_Prison_WayToWindego_Tresspassing_OutTrigger_4db124fa-1083-44b7-8321-b87afbfe11f9);


IF
ObjectEnteredCombat(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_Id)
AND
CombatGetInvolvedPlayer(_ID,1,_Player)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_Prison_ToWindegoGuard(_Guard)
AND
CharacterIsDead((CHARACTERGUID)_Guard,0)
THEN
DialogRequestStop(_Guard);
ProcCharacterMoveTo(_Guard,S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,1,"ARX_AD_Prison_ToWindegoGuard_RunToHelp");
DB_ARX_Prison_WindegoCell_Paladin_GuardsToHelp(_Guard,_Id);
//TeleportTo(_Guard,TRIGGERGUID_S_ARX_Prison_AIHint1_001_1e2c1df1-57f0-4800-b541-29658341c601);
SetHasDialog(_Guard,0);

IF
ObjectEnteredCombat(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_Id)
AND
CombatGetInvolvedPlayer(_ID,1,_Player)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_Prison_ToWindegoGuard(_Guard)
AND
CharacterIsDead((CHARACTERGUID)_Guard,0)
AND
QueryOnlyOnce("ARX_AD_Prison_ToWindegoGuard_RunToHelp")
THEN
ItemUnlockAndOpen(S_ARX_PlayerPrisonDoor_ToWindego_1e4c49e5-15d3-47ef-9965-fad3e43cd1b7);
Proc_StartDialog(1,"ARX_AD_Prison_ToWindegoGuard_RunToHelp",_Guard);

IF 
CombatEnded(_ID)
AND
DB_ARX_Prison_WindegoCell_Paladin_GuardsToHelp(_Guard,_ID)
AND
DB_MovingTo(_Guard,_Player,_Running,_ID)
THEN
ProcClearStoryMove(_Guard);

IF
StoryEvent(_Guard,"ARX_AD_Prison_ToWindegoGuard_RunToHelp")
THEN
SetHasDialog(_Guard,1);

IF
ObjectEnteredCombat(S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_Id)
AND
QueryOnlyOnce("ARX_Prison_SourceMuteImpact")
AND
DB_IsPlayer(_Player)
AND
QRY_IsInRange(_Player,ITEMGUID_S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,25.0)
THEN
ApplyStatus(_Player,"SOURCE_MUTED",24.0,1);

IF
DB_OnlyOnce("ARX_Prison_SourceMuteImpact")
AND
GetPosition(ITEMGUID_S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,_X,_Y,_Z)
THEN
PlayScaledEffectAtPosition("RS3_FX_GP_Impacts_Air_LightningBolt_Vertical_01",4.0,_X,_Y,_Z);

//END_REGION

//REGION To Barracks
IF //using the lever from insdie the secret room
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_Lever_abd4bcbc-0f7e-4807-ad5a-01ff9711491d)
AND
QueryOnlyOnce("ARX_Prison_WindeoCell_ToBarracks_SecretDoor_RevealFromStory")
THEN
SetStoryEvent(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_db79594a-e95f-4e31-abb9-bca50a120526,"RevealFromStory");

IF //using the lever from insdie the secret room
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_Lever_abd4bcbc-0f7e-4807-ad5a-01ff9711491d)
THEN
ItemUnLock(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_db79594a-e95f-4e31-abb9-bca50a120526);
ItemOpen(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_db79594a-e95f-4e31-abb9-bca50a120526);

IF //using the door from outside the secret room
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretDoor_db79594a-e95f-4e31-abb9-bca50a120526)
THEN
ARX_Prison_WindeoCell_ToBarracks_SecretRegion_Unlock();

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretRegion_0e386e3c-1713-43fd-a7b1-10998be4156c)
AND
DB_IsPlayer(_Player)
THEN
ARX_Prison_WindeoCell_ToBarracks_SecretRegion_Unlock();

PROC
ARX_Prison_WindeoCell_ToBarracks_SecretRegion_Unlock()
THEN
UnlockSecretRegion(TRIGGERGUID_S_ARX_Prison_WindeoCell_ToBarracks_SecretRegion_0e386e3c-1713-43fd-a7b1-10998be4156c);
//SetOnStage(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_3db00448-5a68-457d-84ab-c19ace3082d4, 0); //When we have an effet move this to 
//SetOnStage(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_000_1e9291ec-b9c3-49fb-a509-2ce9ae285692, 0);
PlayEffect(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_3db00448-5a68-457d-84ab-c19ace3082d4,"RS3_FX_GP_ScriptedEvent_ARX_Windego_SecretRegion_RockFade_01");
PlayEffect(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_000_1e9291ec-b9c3-49fb-a509-2ce9ae285692,"RS3_FX_GP_ScriptedEvent_ARX_Windego_SecretRegion_RockFade_01");
TimerCancel("ARX_ARX_Prison_WindeoCell_ToBarracks_RemoveRocks");
TimerLaunch("ARX_ARX_Prison_WindeoCell_ToBarracks_RemoveRocks",900);

IF
TimerFinished("ARX_ARX_Prison_WindeoCell_ToBarracks_RemoveRocks")
THEN
SetOnStage(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_3db00448-5a68-457d-84ab-c19ace3082d4, 0);
SetOnStage(ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_HidingStone_000_1e9291ec-b9c3-49fb-a509-2ce9ae285692, 0);

//Ladder in Barracks
IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Lever_a97d05ce-225f-4752-a33f-035b6d7fde72)
THEN
SetVisible(ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_463b685b-9612-42b6-8c44-0811ebbe8919,1);
proc_ItemMoveToTrigger(ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_463b685b-9612-42b6-8c44-0811ebbe8919,TRIGGERGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_OpenT_7820ffb5-7aff-4bd1-9e07-3140f85746d0,1.0,1.1,0);

IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_Hatch_c0c697d1-6aa4-4651-beb0-abbd3ce1957f)
AND
QueryOnlyOnce("ARX_Barracks_WindeoCell_ToPrison_Ladder")
THEN
SetVisible(ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_463b685b-9612-42b6-8c44-0811ebbe8919,1);
proc_ItemMoveToTrigger(ITEMGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_463b685b-9612-42b6-8c44-0811ebbe8919,TRIGGERGUID_S_ARX_Barracks_WindeoCell_ToPrison_Ladder_OpenT_7820ffb5-7aff-4bd1-9e07-3140f85746d0,1.0,1.1,0);

IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Prison_WindeoCell_ToBarracks_Hatch_c0c697d1-6aa4-4651-beb0-abbd3ce1957f)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_FoundVault");
ProcUnregisterForUser(S_ARX_Barracks_VaultEntered_0790cd06-4e2b-4cc1-b021-46f1dc180357,_Player);

//END_REGION

//REGION Journal
IF
CharacterEnteredTrigger(_Player,S_ARX_Prison_WindegosCell_23bfdf1c-6617-4d76-9557-7e766aaca53b)
THEN
ObjectSetFlag(_Player, "QuestUpdate_ARX_Prison_Windego_EnteredTheRoom");

IF
DialogEnded("ARX_Prison_Windego",_ID)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_Prison_Windego_TalkedToWindego");

IF
DialogEnded("ARX_Prison_WindegoCell_Paladin",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Prison_WindegoCell_PaladinLeave",1)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
ObjectSetFlag((CHARACTERGUID)_Player, "QuestUpdate_ARX_Prison_Windego_PaladinLeft");

IF
DialogEnded("ARX_Prison_Windego_Trespassing_NearPuzzle",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)_NPC)
AND
ObjectGetFlag(_NPC,"ARX_Prison_WindegoCell_PaladinLeave",1)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
ObjectSetFlag((CHARACTERGUID)_Player, "QuestUpdate_ARX_Prison_Windego_PaladinLeft");

IF
CharacterKilledBy(CHARACTERGUID_S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366,_AttackOwner,_Attacker)
AND
DB_IsPlayer(_AttackOwner)
AND
DB_IsPlayer(_Attacker)
THEN
ObjectSetFlag((CHARACTERGUID)_Attacker,"QuestUpdate_ARX_Prison_Windego_PaladinKilled");

IF
CharacterDied(CHARACTERGUID_S_ARX_Prison_WindegoCell_Paladin_383eb4a6-4c76-4d97-82ea-089f96e5e366)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_Prison_Windego_PaladinLeft");


//END_REGION

//REGION Debug
IF
TextEventSet("ARX_Prison_Remove_SourcePoints")
AND
DB_IsPlayer(_Player)
THEN
CharacterAddSourcePoints((CHARACTERGUID)_Player, -1);

IF
TextEventSet("ARX_Prison_ADD_SourcePoints")
AND
DB_IsPlayer(_Player)
THEN
CharacterAddSourcePoints((CHARACTERGUID)_Player, 1); 

IF
TextEventSet("WindegoDebug_ReadNotes")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_Prison_WindegoCell_Paladin_ReadRecords");

IF
TextEventSet("WindegoDebug_MetWindego")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"FTJ_SW_HasMet_EscapedPrisoner");

IF
TextEventSet("WindegoDebug_Effect_Exploded")
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Raanaar_Lamp_A_Exploded_01",S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"ARX_Barracks_Prison_Windego_Machine_Exploded","ARX_Main","Dummy_LTS_Raanaar_Lamp_A");
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceMachine_Hit_01");

IF
TextEventSet("WindegoDebug_Effect_OverHeat")
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_Raanaar_Lamp_A_Overheat_01",S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"ARX_Barracks_Prison_Windego_Machine_IsOverHitting","ARX_Main","Dummy_LTS_Raanaar_Lamp_A");
Proc_ARX_Prison_WindegoCell_SourceMachinePlayEffect(S_ARX_Barracks_Prison_Windego_CellGenerator_aa32299f-d394-4cec-9dd7-c8dfae0daed1,"RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_SourceMachine_Hit_01");


IF
TextEventSet("WindegoStat_VB")
AND
DB_IsPlayer(_Player)
THEN
StartVoiceBark("ARX_Prison_VB_Windego_PlayerGavePromiseBreaker",_Player);

IF
TextEventSet("WindegoAdd_SourcePoints")
AND
DB_IsPlayer(_Player)
THEN
Proc_ARX_Barracks_Prison_Windego_PlayerGiveSourcePoints_ToMachine(_Player,1);

IF
TextEventSet("WindegoTestGoneEffect")
AND
DB_IsPlayer(_Player)
AND
GetPosition(_Player,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_Ghost_GodKingVanish_01",_X,_Y,_Z);

//END_REGION 

//REGION Kemms Vault

IF
TextEventSet("windesc")
THEN
ProcSetInvulnerable(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,0);
GlobalSetFlag("ARX_Prison_WindegoEscaped");

IF
ObjectFlagSet("ARX_Prison_Windego_WindegoLeft_SetFlag",_Char,_)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_Prison_Windego_WindegoLeft");

IF
ObjectFlagSet("ARX_Prison_Windego_WindegoLeft_SetFlag",_Char,_)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
ObjectSetFlag(_Char,"QuestUpdate_ARX_Prison_Windego_WindegoLeftKemmVault");


// Appear in Kemm's Vault
IF
GlobalFlagSet("ARX_Prison_WindegoEscaped")
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
QueryOnlyOnce("ARX_Prison_WindegoEscaped_Glo")
THEN
ObjectClearFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_Windego_FightPlayer");
ObjectClearFlag(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,"ARX_Prison_WindegoEscaped");
Foop(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182);
TeleportTo(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,TRIGGERGUID_S_ARX_KemmVault_WindegoDeathPoint_224191d9-347f-497f-9db7-5a3bb6419635);
//CharacterDie(S_FTJ_SW_EscapedPrisoner_d783285f-d3be-4cba-8333-db8976cef182,0,"DoT");
Proc_ARX_KemmVault_WindegoEvent();


//Handling Crimes
IF
AttackedByObject(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,(CHARACTERGUID)_Player,_,_,_DamageSource)
AND
NOT DB_DialogNPCs(_,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
AND
DB_IsPlayer(_Player)
AND
NOT QryIgnoreDamageSource(_DamageSource)
AND
GlobalGetFlag("ARX_KemmVault_Windego_Wounded",1)
THEN
Proc_StartDialog(1,"ARX_AD_Prison_Windego_AttackedWhileCrippled",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

IF
CharacterPickpocketFailed(_Player,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182)
AND
NOT DB_DialogNPCs(_,CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
AND
DB_IsPlayer(_Player)
THEN
Proc_StartDialog(1,"ARX_AD_Prison_Windego_AttackedWhileCrippled",CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

PROC
Proc_ARX_KemmVault_WindegoEvent()
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
THEN
CharacterLookAt(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,TRIGGERGUID_S_ARX_KemmVault_Windego_LookAt_dce8fd08-d3b0-408e-9dd4-71f4af245c88);
SetVarFixedString(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"currentState","State_ARX_KemmVault_Wounded");
ApplyStatus(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"CRIPPLED",-1.0,1);
GlobalSetFlag("ARX_KemmVault_Windego_Wounded");
DB_DoNotFace(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);
SetCanFight(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,0);
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182);

PROC
Proc_ARX_KemmVault_WindegoEvent()
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
GetVarFloat(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"maxVitality",_Vitality)
AND
RealDivide(_Vitality,8.5,_DamageAmount)
AND
Integer(_DamageAmount,_DamageAmountInt)
THEN
ApplyDamage(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_DamageAmountInt,"Physical");

IF
DialogStartRequested(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
AND
GlobalGetFlag("ARX_KemmVault_Windego_Wounded",1)
THEN
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,"Lie_Wounded_03_Loop");

IF
DialogStartRequested(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182,_)
AND
GlobalGetFlag("ARX_KemmVault_Windego_Wounded",1)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_SetKemm_FromWindego")
THEN
Proc_ARX_KemmVault_ArhusPrison_SetKemm();

IF
CharacterDied(CHARACTERGUID_S_GLO_Windego_d783285f-d3be-4cba-8333-db8976cef182)
THEN
GlobalClearFlag("ARX_KemmVault_Windego_Wounded");

IF
DialogEnded("ARX_Prison_Windego_Ghost",_ID)
AND
DialogGetInvolvedNPC(_ID,1,(CHARACTERGUID)S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288)
AND
ObjectGetFlag(S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288,"ARX_Prison_Windego_Ghost_GodKingVanish",1)
AND
GetPosition(S_GLO_Windego_WindegoGhost_d309b284-43c9-4d68-830c-fcf393aa6288,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_ARX_Prison_Windego_Ghost_GodKingVanish_01",_X,_Y,_Z);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
