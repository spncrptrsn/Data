Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/fortjoy---the-helpful-doctor

DB_Dialogs(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,"FTJ_Doctor");
DB_Dialogs(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"FTJ_DyingMan");

DB_GiveItemToEvent((ITEMGUID)ITEMGUID_S_FTJ_DyingManCard_9ad3db11-1a93-4cc0-b38b-784d19613ea7,"FTJ_DainCardTo");
DB_HasStoryEvent((ITEMGUID)ITEMGUID_S_FTJ_DyingManCard_9ad3db11-1a93-4cc0-b38b-784d19613ea7,"FTJ_HasDainCard");
ItemToInventory(ITEMGUID_S_FTJ_DyingManCard_9ad3db11-1a93-4cc0-b38b-784d19613ea7,CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);


CharacterSetHitpointsPercentage(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1.0);
ProcCharacterDisableAllCrimes(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
CharacterSetAnimationOverride(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"knockdown_loop");
KBSECTION
IF 
ObjectFlagSet("FTJ_DoctorGaveIngredients",(CHARACTERGUID)_Player,_)
THEN 
ItemTemplateAddTo("CON_Herb_Mushroom_A_0106e3c1-bd81-4118-8a28-59c6dc941feb",_Player,1);
ItemTemplateAddTo("CON_Potion_Empty_A_cd6e86ca-e9be-444e-a7df-d295ec6bb578",_Player,1);
CharacterUnlockRecipe(_Player,"CON_Potion_Empty_A_CON_Herb_Mushroom_A",1);



IF 
AttackedByObject(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,(CHARACTERGUID)_Player,(CHARACTERGUID)_Attacker,_,_)
AND
CharacterIsInCombat(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,0)
THEN 
DialogRequestStop(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d);
Proc_StartDialog(1,"FTJ_AD_DoctorGoHostile",RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d);
ProcMakeNPCHostile(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Attacker);

IF 
DialogStarted("FTJ_Doctor",_ID)
AND 
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND 
CharacterGetHitpointsPercentage(_Player,_Per)
AND 
_Per < 100.0
THEN 
GlobalSetFlag("FTJ_DoctorTalkingToInjured");

PROC
ProcSetMagicPocketsOwnershipFlag(_Player,"Has_TaggedItem_ALCOHOL")
THEN
ProcSetMagicPocketsOwnershipFlag(_Player,"FTJ_Doctor_HasBooze");

PROC
ProcClearMagicPocketsOwnershipFlag(_Player,"Has_TaggedItem_ALCOHOL")
THEN
ProcClearMagicPocketsOwnershipFlag(_Player,"FTJ_Doctor_HasBooze");

IF
ObjectFlagSet("FTJ_Doctor_RemoveBooze",(CHARACTERGUID)_Player,_)
AND
QryRemoveTaggedItemFromMagicPockets(_Player,"ALCOHOL",1)
THEN
PartyAddExperience(_Player,1,2,4);
DB_FTJ_QueueHealInjuredMan(_Player);

IF
DialogEnded("FTJ_Doctor",_)
AND
DB_FTJ_QueueHealInjuredMan((CHARACTERGUID)_Player)
AND
QueryOnlyOnce("FTJ_LesteHealDain_Once")
THEN
NOT DB_FTJ_QueueHealInjuredMan(_Player);
PartyAddExperience(_Player,1,2,4);
SetVarObject(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,"PlayerToCureDisease",RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
SetScriptFrame(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,"HealDisease");


IF 
DialogEnded("FTJ_Doctor",_)
THEN 
GlobalClearFlag("FTJ_DoctorTalkingToInjured");
GlobalClearFlag("FTJ_DoctorTalkingToDiseased");
GlobalClearFlag("FTJ_DoctorTalkingToPlayerWithMushroom");

IF 
DialogStarted("FTJ_Doctor",_ID)
AND 
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
HasActiveStatus(_Player,"DISEASED",1)
THEN
GlobalSetFlag("FTJ_DoctorTalkingToDiseased");


//Mona Disease Player
IF
DialogEnded("FTJ_GhettoNPC_Human_003",_ID)
AND 
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
GlobalGetFlag("FTJ_MonaCured",0)
THEN
ApplyStatus(_Player,"DISEASED",60.0);

IF
CharacterStatusRemoved(CHARACTERGUID_S_FTJ_GhettoNPC_Human_003_8e83098f-6dd8-445d-a37b-d22be064d334,"DISEASED",(CHARACTERGUID)_Player)
AND
GlobalGetFlag("FTJ_MonaCured",0)
AND
DB_IsPlayer(_Player)
THEN
ProcSetHostileToIndivPlayer(CHARACTERGUID_S_FTJ_GhettoNPC_Human_003_8e83098f-6dd8-445d-a37b-d22be064d334,_Player);
GlobalSetFlag("FTJ_MonaCured");
Proc_StartDialog(1,"FTJ_AD_GhettoNPC_Human_003_GoHostile",CHARACTERGUID_S_FTJ_GhettoNPC_Human_003_8e83098f-6dd8-445d-a37b-d22be064d334);

IF
CharacterRelationChangedTo(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Char,0)
THEN
SetCanFight(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1);
SetCanJoinCombat(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1);

//REGION
IF
ObjectFlagSet("FTJ_DyingManQ2",(CHARACTERGUID)_Player,_)
THEN
DB_RC_FTJ_DyingManAttemptGoHostile(_Player);
ProcCharacterEnableAllCrimes(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
CharacterSetAnimationOverride(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"");
SetCanFight(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1);

IF 
DialogEnded("FTJ_DyingMan",_)
AND
DB_RC_FTJ_DyingManAttemptGoHostile(_Player)
THEN
Proc_RC_FTJ_CheckForDoctor(_Player);
NOT DB_RC_FTJ_DyingManAttemptGoHostile(_Player);

PROC
Proc_RC_FTJ_CheckForDoctor((CHARACTERGUID)_Player)
AND
CharacterIsDead(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,0)
AND
CharacterIsInCombat(CHARACTERGUID_S_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,0)
AND
GetDistanceTo(_Player,RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Distance)
AND
_Distance < 10.0
AND
CharacterCanSee(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,1)
THEN
Proc_StartDialog(0,"FTJ_DoctorIntervenes",RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);


PROC
Proc_RC_FTJ_CheckForDoctor((CHARACTERGUID)_Player)
AND
CharacterIsDead(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,1)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player,-100);
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,-100);

PROC
Proc_RC_FTJ_CheckForDoctor((CHARACTERGUID)_Player)
AND
CharacterCanSee(RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,0)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player,-100);
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,-100);

PROC
Proc_RC_FTJ_CheckForDoctor((CHARACTERGUID)_Player)
AND
GetDistanceTo(_Player,RC_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Distance)
AND
_Distance >= 10.0
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player,-100);
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_BackAlleyDoctor_65e376df-3470-41fd-add2-4411fb61439d,_Player,-100);

IF 
DialogEnded("FTJ_DoctorIntervenes",_)
THEN
ProcCharacterDisableAllCrimes(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
CharacterSetAnimationOverride(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"knockdown_loop");
SetCanFight(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,0);
//END_REGION

//REGION Healing the Dying man
IF 
CharacterStatusApplied(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Status,(CHARACTERGUID)_Player)
AND 
QRY_IsHealingStatus(_Status)
AND 
CharacterIsPartyMember(_Player,1)
AND
GlobalGetFlag("FTJ_DoctorHealedDyingMan",0)
AND 
CharacterIsDead(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,0)
AND 
NOT DB_FTJ_DyingManHasPlayerToThank(_Player)
AND
QueryOnlyOnce("FTJ_DyingManDoThanksForHealing")
THEN 
SetCanFight(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1);
SetVarInteger(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"bool_CanCower",1);
SetVarInteger(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"bool_CanFleeWhileCowering",1);
SetVarInteger(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"FleeFromDangerousSurface",1);
CharacterSetAnimationOverride(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"");
PlayAnimation(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"knockdown_getup","FTJ_DyingManDoThanksForHealing");
GlobalSetFlag("FTJ_DyingManHealedBySpell");
ProcCharacterEnableAllCrimes(RC_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);

IF 
CharacterStatusApplied(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Status,(CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
AND 
QRY_IsHealingStatus(_Status)
AND
GlobalGetFlag("FTJ_DoctorHealedDyingMan",0)
AND 
CharacterIsDead(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,0)
AND 
NOT DB_FTJ_DyingManHasPlayerToThank(_Player)
THEN 
ProcForceStopDialog(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
DB_FTJ_DyingManHasPlayerToThank(_Player);
ObjectSetFlag(_Player,"FTJ_PlayerHealedDyingMan",0);
PartyAddExperience(_Player,1,2,4);

IF 
CharacterStatusApplied(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Status,(CHARACTERGUID)_Healer)
AND
NOT DB_IsPlayer(_Healer)
AND 
QRY_IsHealingStatus(_Status)
AND
QRY_IsSummonOrPartyFollower(_Healer)
AND
CharacterGetOwner(_Healer, _Player)
AND
DB_IsPlayer(_Player)
AND
GlobalGetFlag("FTJ_DoctorHealedDyingMan",0)
AND 
CharacterIsDead(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,0)
AND 
NOT DB_FTJ_DyingManHasPlayerToThank(_Player)
THEN 
ProcForceStopDialog(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc);
DB_FTJ_DyingManHasPlayerToThank(_Player);
ObjectSetFlag(_Player,"FTJ_PlayerHealedDyingMan",0);
PartyAddExperience(_Player,1,2,4);

IF 
StoryEvent((CHARACTERGUID)CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,"FTJ_DyingManDoThanksForHealing")
AND 
DB_FTJ_DyingManHasPlayerToThank(_Player)
AND
QRY_IsAvailableTo(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player)
THEN 
Proc_StartDialog(0,"FTJ_DyingMan",CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player);

///// Kill Dain if event started and all Players leave area
IF
DialogStarted("FTJ_DyingMan",_)
AND
NOT DB_FTJ_MetDyingMan(1)
THEN
DB_FTJ_MetDyingMan(1);

IF
CharacterLeftTrigger(_Player,TRIGGERGUID_S_FTJ_SUB_Ghetto_19107918-c6d6-4c93-a377-e8a76c8d0f27)
AND
DB_FTJ_MetDyingMan(1)
AND
GlobalGetFlag("FTJ_DyingManHealedBySpell",0)
AND
GetClosestPlayer(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,_Player,_Dist)
AND
_Dist > 30.0
THEN
CharacterDie(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc,1,"DoT");

IF
CharacterDied(CHARACTERGUID_S_FTJ_DyingMan_80288510-7e12-4710-90cb-16a1e2d50efc)
THEN
GlobalSetFlag("FTJ_DyingManDied");

//END_REGION

PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
