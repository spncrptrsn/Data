Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialogs
ProcDeclareCounter("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog");

//First Room
DB_Dialogs(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman");
DB_Ghosts(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_CreepyCraftsman_Ghost_b3c8a7c7-45ea-4947-a2b4-30587e5e99fa,"ARX_CreepyShop_CreepyCraftsman_Ghost");
 
DB_Dialogs(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,"ARX_CreepyShop_SourcePuppet");
SetHasDialog(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,1);
//DB_Dialogs(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,"ARX_CreepyShop_1stRoom_SourcePuppet2"); // Dialog is handled diffirently if he sees you interacting with the puppet
DB_Dialogs(S_ARX_CreepyShop_1stRoom_SourcePuppet3_e6f70daa-9d61-45a2-af9c-0376aa288495,"ARX_CreepyShop_SourcePuppet");
//2nd Room
DB_Dialogs(S_ARX_CreepyShop_2ndRoom_SourcePuppet1_2c91e073-9f81-4e3f-92cc-db1eb8ad0172,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndRoom_SourcePuppet3_45dfd954-93eb-4b82-80f2-6265c7277ffa,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndRoom_SourcePuppet2_0ac99f41-5e40-4edc-b546-b4795a315b25,"ARX_CreepyShop_SourcePuppet");
//2nd Floor
DB_Dialogs(S_ARX_CreepyShop_2ndFloor_SourcePuppet1_480f3e01-426b-4d07-b001-892b8aa7b7f7,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndFloor_SourcePuppet2_aa35f60d-d12f-4021-b714-5207f138434b,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndFloor_SourcePuppet3_ccce45e6-566c-4d59-88a0-f2721c2a692e,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndFloor_SourcePuppet4_69cf2e83-1b5a-4831-b214-352cadceba96,"ARX_CreepyShop_SourcePuppet");
DB_Dialogs(S_ARX_CreepyShop_2ndFloor_SourcePuppet5_72df0b99-e10f-4c8c-81de-c3967f31d94d,"ARX_CreepyShop_SourcePuppet");

//END_REGION
//OnwerShip
DB_ItemOwnerShipTriggers("ARX_Main",S_ARX_CreepyCraftsman_ShopFirstFloor_071d7947-c5f6-4c44-ae1c-bed1f10a573d,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
DB_ItemOwnerShipTriggers("ARX_Main",S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
//REGION Puppets and Hacks
DB_ARX_CreepyShop_HackyChairs(S_ARX_CreepyShop_PuppetChairHack1_233d42f1-93ba-4fe9-9fa2-1605db0236e2,S_FUR_Humans_Citz_Table_A3_000_737e2774-87fd-4aa0-8e86-d24e260a9ccc);
DB_ARX_CreepyShop_HackyChairs(S_ARX_CreepyShop_PuppetChairHack2_659eaa66-0d8d-4d50-8f90-d15093f497a6,S_FUR_Humans_Blacksmith_Workbench_C_000_ARX_Main_Rework_000_b3dc22ca-105d-8441-33ff-ea232a46e9e9);
DB_ARX_CreepyShop_HackyChairs(S_ARX_CreepyShop_PuppetChairHack3_c7a7d90d-6026-4976-9ace-88b43359bc1d,FUR_Humans_Citz_LongestTable_Poor_A1_000_d19f023b-4685-4516-8295-c7a3bbd45528);
DB_ARX_CreepyShop_HackyChairs(S_ARX_CreepyShop_PuppetChairHack4_08690826-2793-46d5-b723-19929b74db42,S_FUR_Dwarves_Citz_Table_A_000_51eaf951-1852-4472-87c9-933ff4a41d1d);

DB_ARX_CreepyShop_PuppetChairs(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,S_ARX_CreepyShop_PuppetChairHack3_c7a7d90d-6026-4976-9ace-88b43359bc1d);
DB_ARX_CreepyShop_PuppetChairs(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,S_ARX_CreepyShop_PuppetChairHack2_659eaa66-0d8d-4d50-8f90-d15093f497a6);
DB_ARX_CreepyShop_PuppetChairs(S_ARX_CreepyShop_1stRoom_SourcePuppet3_e6f70daa-9d61-45a2-af9c-0376aa288495,S_ARX_CreepyShop_PuppetChairHack1_233d42f1-93ba-4fe9-9fa2-1605db0236e2);
DB_ARX_CreepyShop_PuppetChairs(S_ARX_CreepyShop_2ndRoom_SourcePuppet3_45dfd954-93eb-4b82-80f2-6265c7277ffa,S_ARX_CreepyShop_PuppetChairHack4_08690826-2793-46d5-b723-19929b74db42);

//FIRST ROOM
DB_ARX_CreepyShop_SourcePuppets((CHARACTERGUID)S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7); 
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_1stRoom_SourcePuppet3_e6f70daa-9d61-45a2-af9c-0376aa288495);
//2nd Room
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndRoom_SourcePuppet1_2c91e073-9f81-4e3f-92cc-db1eb8ad0172);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndRoom_SourcePuppet3_45dfd954-93eb-4b82-80f2-6265c7277ffa);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndRoom_SourcePuppet2_0ac99f41-5e40-4edc-b546-b4795a315b25);

//2nd Floor
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndFloor_SourcePuppet1_480f3e01-426b-4d07-b001-892b8aa7b7f7);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndFloor_SourcePuppet2_aa35f60d-d12f-4021-b714-5207f138434b);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndFloor_SourcePuppet3_ccce45e6-566c-4d59-88a0-f2721c2a692e);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndFloor_SourcePuppet4_69cf2e83-1b5a-4831-b214-352cadceba96);
DB_ARX_CreepyShop_SourcePuppets(S_ARX_CreepyShop_2ndFloor_SourcePuppet5_72df0b99-e10f-4c8c-81de-c3967f31d94d);

//2ndFloorPuppets - For God King
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)S_ARX_CreepyShop_2ndFloor_SourcePuppet1_480f3e01-426b-4d07-b001-892b8aa7b7f7);
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)S_ARX_CreepyShop_2ndFloor_SourcePuppet2_aa35f60d-d12f-4021-b714-5207f138434b);
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)S_ARX_CreepyShop_2ndFloor_SourcePuppet3_ccce45e6-566c-4d59-88a0-f2721c2a692e);
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)S_ARX_CreepyShop_2ndFloor_SourcePuppet4_69cf2e83-1b5a-4831-b214-352cadceba96);
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)S_ARX_CreepyShop_2ndFloor_SourcePuppet5_72df0b99-e10f-4c8c-81de-c3967f31d94d);

//Spawners
DB_ARX_CreepyShop_SourcePuppets_Spawners(S_ARX_CreepyShop_2ndFloor_SourcePuppet1_480f3e01-426b-4d07-b001-892b8aa7b7f7,S_ARX_CreepyShop_PuppetSpawner1_f547ad22-83c5-445e-89b8-09e339531f59,S_ARX_CreepyShop_PuppetSpawner1_FloorHack_e4d6bcc5-c7f1-4eb4-a674-1dd2440e9ddb);
DB_ARX_CreepyShop_SourcePuppets_Spawners(S_ARX_CreepyShop_2ndFloor_SourcePuppet2_aa35f60d-d12f-4021-b714-5207f138434b,S_ARX_CreepyShop_PuppetSpawner2_16d0b55c-fbdc-46dc-bf48-4ad9b67ed8f5,S_ARX_CreepyShop_PuppetSpawner2_FloorHack_671fd16f-fd3d-4838-9062-93fee54c2fb5,S_ARX_CreepyShop_2ndFloor_SourcePuppet2_SpawnOnEntry_0b99ac83-9dbe-4c20-8201-af36480b6a1e);
DB_ARX_CreepyShop_SourcePuppets_Spawners(S_ARX_CreepyShop_2ndFloor_SourcePuppet5_72df0b99-e10f-4c8c-81de-c3967f31d94d,S_ARX_CreepyShop_PuppetSpawner3_cdd9a78e-ee76-4894-91e6-ce466e448602,S_ARX_CreepyShop_PuppetSpawner3_FloorHack_b19b98ba-fef5-4ad8-8b3c-338db15cbff3,S_ARX_CreepyShop_2ndFloor_SourcePuppet3_SpawnOnEntry_08043c19-957a-4ae5-8ad2-c0028bf8fd61);


//Spawner Triggers

//END_REGION

//REGION Triggers
ProcTriggerRegisterForPlayers(S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711);
TriggerRegisterForCharacter(S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
TriggerRegisterForCharacter(S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711,S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707);
TriggerRegisterForCharacter(S_ARX_CreepyCraftsman_ShopFirstFloor_071d7947-c5f6-4c44-ae1c-bed1f10a573d,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
TriggerRegisterForCharacter(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
//END_REGION

//REGION Tresspassing
/*
DB_ARX_CreepyShopTrespassTrigger(S_ARX_CreepyShop_2ndRoom_f739c0d4-6528-466e-a185-11b082f2e057,S_ARX_CreepyShop_Tresspassing_Out_2dc7d29e-da1d-48da-a7ec-c0fd6a84d1fb,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
DB_ARX_CreepyShopTrespassTrigger(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,S_ARX_CreepyShop_Tresspassing_Out_2dc7d29e-da1d-48da-a7ec-c0fd6a84d1fb,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);

DB_ARX_CreepyShopTrespassTrigger_CustomCrime(S_ARX_CreepyShop_2ndRoom_f739c0d4-6528-466e-a185-11b082f2e057,"ARX_CreepyCraftsman_TresspassingIn2ndRoom");
DB_ARX_CreepyShopTrespassTrigger_CustomCrime(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,"ARX_CreepyCraftsman_TresspassingIn2ndFloor");
*/
DB_TrespassTrigger(S_ARX_CreepyShop_2ndRoom_f739c0d4-6528-466e-a185-11b082f2e057,S_ARX_CreepyShop_Tresspassing_Out_2dc7d29e-da1d-48da-a7ec-c0fd6a84d1fb,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
DB_TrespassTrigger(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,S_ARX_CreepyShop_Tresspassing_Out_2dc7d29e-da1d-48da-a7ec-c0fd6a84d1fb,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
ProcTriggerRegisterForPlayers(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78);

//END_REGION

//REGION Scroll of Atonement
DB_HasStoryEvent(ITEMGUID_S_ARX_CreepyCraftsman_ScrollOfAtonment_b5a89b75-bbef-44f1-b22f-148a1b9d13ab,"ARX_CreepyCraftsman_Has_Scroll");

//END_REGION

//REGION Source Amulet
DB_GiveItemToEvent(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,"ARX_CreepyCraftsman_Give_SourceAmulet");
DB_HasStoryEvent(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,"ARX_CreepyCraftsman_Has_SourceAmulet");
ItemToInventory(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
//END_REGION

//REGION Cathedral Designs 
ItemToInventory(S_ARX_CreepyCraftsman_CathedralDesigns_b5a89b75-bbef-44f1-b22f-148a1b9d13ab,S_ARX_CreepyCraftsman_OldWorkStation_4b67b311-7654-4a90-ba46-c68ec4495bc5);
ItemToInventory(S_ARX_CreepyCraftsman_UnsentLetterToDad_7b7476cb-87e0-4f0d-baa4-dece00dd16ce,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
//DB_GiveItemToEvent(S_ARX_CreepyCraftsman_CathedralDesigns_b5a89b75-bbef-44f1-b22f-148a1b9d13ab,"ARX_CreepyCraftsman_GiveCathedralDesigns"
/*
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("FROZEN",1);
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("STUNNED",2);
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("FEAR",3);
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("PETRIFIED",4);
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("BLIND",5);
DB_ARX_CreepyCraftsman_CathedralDesigns_Penelties("MUTED",6);
*/
//END_REGION

//REGION Journal

//END_REGION
ProcDeclareCounter("ARX_CreepyCraftsman_WarnPlayer_StoleSource");
SetOnStage(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,1);

DB_DeadEvent(CHARACTERGUID_S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyCraftsman_CreepyIsDead");
SetOnStage(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,0);
KBSECTION
//REGION Source Puppets DB

IF
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
THEN
SetTag(_Puppet,"SOURCE_PUPPET");
CharacterDisableAllCrimes((CHARACTERGUID)_Puppet);
DB_IgnoreAssault(_Puppet);
DB_NoLowAttitudeDialog(_Puppet);
TriggerRegisterForCharacter(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78,_Puppet);
TriggerRegisterForCharacter(S_ARX_CreepyCraftsman_ShopFirstFloor_071d7947-c5f6-4c44-ae1c-bed1f10a573d,_Puppet);


IF
ObjectWasTagged(_Puppet,"SOURCE_PUPPET")
THEN
CharacterDisableAllCrimes((CHARACTERGUID)_Puppet);
DB_IgnoreAssault(_Puppet);
DB_NoLowAttitudeDialog(_Puppet);

IF
DB_ARX_CreepyShop_PuppetChairs(_Puppet,_Chair)
THEN
CharacterUseItem((CHARACTERGUID)_Puppet,(ITEMGUID)_Chair,"");
//CharacterMoveTo((CHARACTERGUID)_Puppet,_Chair,1,"ARX_CreepyShop_PuppetReachedChair",1);

IF
CharacterDied(_Puppet)
AND
DB_ARX_CreepyShop_PuppetChairs(_Puppet,_Chair)
THEN
SetOnStage(_Chair,0);

IF
StoryEvent(_Puppet,"ARX_CreepyShop_PuppetReachedChair")
AND
DB_ARX_CreepyShop_HackyChairs(_Puppet,_Chair)
THEN
CharacterUseItem((CHARACTERGUID)_Puppet,(ITEMGUID)_Chair,"");
//END_REGION

//REGION Hacky Chairs 
IF
ItemDestroyed(_Item)
AND
DB_ARX_CreepyShop_HackyChairs(_HackChair,_Item)
THEN
ItemDestroy((ITEMGUID)_HackChair);
//END_REGION

//REGION Barracks Read the Report
IF 
GameBookInterfaceClosed(ARX_Barracks_Archives_ToyMakerReport_d6afb020-20d3-4ba1-9650-56a7002d7f9a,_Player)
THEN
UserSetFlag(_Player,"ARX_CreepyShop_CreepyCraftman_ReadReportInBarracks");
ObjectSetFlag(_Player,"QuestUpdate_ARX_CreepyCraftsman_KnowAboutCathedral");


IF
ObjectFlagSet("QuestUpdate_ARX_CreepyCraftsman_KnowAboutCathedral",_Player,_)
THEN
ObjectSetFlag(_Player,"ARX_CreepyShop_CreepyCraftman_ReadReportInBarracks");


//END_REGION

//REGION Creepy_CraftsMen Start Converasation
/*
IF
CharacterEnteredTrigger(_Player,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711)
AND
DB_IsPlayer(_Player)
AND
QRY_SpeakerIsAvailable(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
AND
GlobalGetFlag("ARX_CreepyShop_CreepyCraftsman_ShowedTrick",0)
AND
DB_InRegion(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711)
THEN
//PlaySound(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"SE_ARX_CreepyCraftsman_DialogStart_Scare"); // TODO: Add a Synth String SFX
CharacterLookAt(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player,0);
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player);
ProcTriggerUnregisterForPlayers(S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711);
*/

IF
CharacterEnteredTrigger(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711)
AND
DB_InRegion(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711)
THEN
ObjectSetFlag(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftman_ShowTrickNearPuppet");

IF
CharacterLeftTrigger(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711)
THEN
ObjectClearFlag(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftman_ShowTrickNearPuppet",0);

IF
DialogEnded("ARX_CreepyShop_CreepyCraftsman",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CC_CreepyCraftsman_PlayerWitnessedTrick",1)
THEN
ObjectClearFlag(_Player,"ARX_CC_CreepyCraftsman_PlayerWitnessedTrick",0);

//END_REGION

//REGION Bringing The puppet To Life ( Magic Trick )

IF
ObjectFlagSet("ARX_CreepyShop_CreepyCraftsman_TurnToPuppet",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_id)
THEN
CharacterLookAt(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707);
PlayAnimation(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"use_craft");

IF
GlobalFlagSet("ARX_CreepyShop_CreepyCraftsman_ShowedTrick")
AND
CharacterIsDead(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,0)
THEN
ObjectSetFlag(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,"ARX_CreepyShop_SourcePuppet_IsOn");
PlayAnimation(S_ARX_CreepyShop_1stRoom_SourcePuppet1_e584817f-1320-4056-a02f-5b4622d4d707,"Sit_Surprise_01","");

IF
ObjectFlagSet("ARX_CreepyShop_CreepyCraftsman_TurnToPlayer",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_id)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
CharacterLookAt(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player);
//END_REGION

//REGION Touching the unfinished Puppet
PROC
PROC_GLOBAL_DialogStartRequested(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,(GUIDSTRING)_Player)
AND
CharacterCanSee((CHARACTERGUID)S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player,1)
AND
QRY_SpeakerIsAvailable(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
THEN
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman_DontTouchThePuppet",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player);

PROC
PROC_GLOBAL_DialogStartRequested(S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,_Player)
AND
CharacterCanSee((CHARACTERGUID)S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player,0)
THEN
Proc_StartDialog(0,"ARX_CreepyShop_SourcePuppet",S_ARX_CreepyShop_1stRoom_SourcePuppet2_9951e2e6-b114-4413-b36e-25f929d961e7,_Player);
//END_REGION

//REGION  Puppet Calling Alarm
IF
DialogStarted("ARX_CreepyShop_TresspassingCrime",_ID)
AND
DialogGetInvolvedNPC(_ID,1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
THEN
ObjectSetFlag(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_Craftsman_StartedCrimeDialog");

IF
DialogStarted("ARX_CreepyShop_CreepyCraftsman_StartCombat",_ID)
AND
DialogGetInvolvedNPC(_ID,1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
THEN
ObjectSetFlag(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_Craftsman_StartedCrimeDialog");

IF
StoryEvent(_Char,"ARX_CreepyShop_Craftsman_StopAllDialogs")
THEN
ProcForceStopDialog(_Char);

IF
StoryEvent(_Char,"ARX_CreepyShop_Craftsman_StopAllDialogs")
THEN
Proc_StartDialog(1,"ARX_AD_CreepyCraftsman_Alarmed_GoInvestigate",_Char);

IF
DialogEnded("ARX_CreepyShop_TresspassingCrime",_ID) // So it will not trigger on each dialog
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
THEN
ObjectClearFlag(_NPC,"ARX_CreepyShop_Craftsman_StartedCrimeDialog",0);

IF
DialogEnded("ARX_CreepyShop_CreepyCraftsman_StartCombat",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
THEN
ObjectClearFlag(_NPC,"ARX_CreepyShop_Craftsman_StartedCrimeDialog",0);
//END_REGION

//REGION Disabling A Puppet 
IF
DialogStarted(_Dialog,_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
IsTagged(_NPC,"SOURCE_PUPPET",1)
AND
CharacterGetMagicArmorPercentage((CHARACTERGUID)_NPC,0.0)
THEN
ObjectSetFlag(_NPC,"ARX_SourcePuppet_HasNoMagicalArmor");

IF
DialogEnded(_Dialog,_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
IsTagged(_NPC,"SOURCE_PUPPET",1)
THEN
ObjectClearFlag(_NPC,"ARX_SourcePuppet_HasNoMagicalArmor");

IF
DialogEnded(_Dialog,_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
IsTagged(_NPC,"SOURCE_PUPPET",1)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag((CHARACTERGUID)_Player,"ARX_CreepyShop_SourcePuppet_PlayerStoleSource",1)
THEN
ObjectClearFlag(_Player,"ARX_CreepyShop_SourcePuppet_PlayerStoleSource",0);
CharacterUseSkill(_Player,"Target_SourceVampirism",_NPC);

IF
CharacterUsedSkillOnTarget(_Player,_NPC,_Skill,_,_)
AND
DB_SourceVampirism_Skills(_Skill)
AND
IsTagged(_NPC,"SOURCE_PUPPET",1)
AND
ObjectGetFlag((CHARACTERGUID)_NPC,"ARX_CreepyShop_SourcePuppet_IsOn",1)
THEN
ARX_CreepyShop_SourceVamp_Puppet((CHARACTERGUID)_Player,(CHARACTERGUID)_NPC);

PROC
ARX_CreepyShop_SourceVamp_Puppet((CHARACTERGUID)_Player,(CHARACTERGUID)_Puppet) //There is Player check in here as sometimes not only the player might vemporize them
AND
CharacterGetMagicArmorPercentage(_Puppet,0.0)
AND
CharacterIsDead(_Puppet,0)
THEN
//Proc_AddSourcePoint(_Player); //Handled in the skill
ObjectClearFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",0);

PROC
ARX_CreepyShop_SourceVamp_Puppet((CHARACTERGUID)_Player,(CHARACTERGUID)_Puppet)
AND
DB_IsPlayer(_Player)
THEN
CharacterRegisterCrime(_Player,"ARX_CreepyCraftsman_TurnedOffPuppet",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0);
DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,_Puppet);
//END_REGION

//REGION Attacking A Puppet

IF
AttackedByObject((CHARACTERGUID)_Puppet,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",1)
THEN
ARX_CreepyShopMakePuppetsHostile((CHARACTERGUID)_Player);

IF
AttackedByObject((CHARACTERGUID)_Puppet,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",0)
AND
CharacterCanSee(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player,1)
THEN
ARX_CreepyShopMakePuppetsHostile((CHARACTERGUID)_Player);

PROC
ARX_CreepyShopMakePuppetsHostile((CHARACTERGUID)_Player)
AND
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,_)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
AND
DB_InRegion((CHARACTERGUID)_Puppet,_Region)
AND
DB_InRegion(_Player,_Region)
AND
ObjectGetFlag((CHARACTERGUID)_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",1)
THEN
ProcMakeNPCHostile(_Player,_Puppet);

PROC
ARX_CreepyShopMakePuppetsHostile((CHARACTERGUID)_Player)
AND
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,_)
AND
CharacterIsDead(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,0)
AND
CharacterIsInCombat(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,0)
AND
DB_InRegion(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Region)
AND
DB_InRegion(_Player,_Region)
THEN
ProcForceStopDialog(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
Proc_StartDialog(1,"ARX_AD_CreepyCraftsman_AttackedPuppets",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);
ProcMakeNPCHostile(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394);

PROC
ARX_CreepyShopMakePuppetsHostile((CHARACTERGUID)_Player)
AND
DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,_Puppet)
THEN
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,_Puppet);
//END_REGION

//REGION Kill Puppet Master

IF
CharacterDied(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
THEN
SetRelationFactionToPlayers("ARX_CC_CreepyCraftsmen",0);

//END_REGION
/*
//REGION Tesspassing To the 2nd room

IF
DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger)
THEN
DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000);

PROC
proc_Remove_DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger)
THEN
proc_Remove_DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000);

PROC
proc_Remove_DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)_Victim)
AND
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_OutTrigger,_Victim)
THEN
NOT DB_ARX_CreepyShopTrespassTrigger(_Trigger,_OutTrigger,_Victim);

PROC
proc_Remove_DB_ARX_CreepyShopTrespassTrigger((TRIGGERGUID)_Trigger,(TRIGGERGUID)_OutTrigger,(CHARACTERGUID)_Victim)
AND
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_OutTrigger)
THEN
NOT DB_ARX_CreepyShopTrespassTrigger(_Trigger,_OutTrigger);

IF
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_,_)
THEN
ProcTriggerRegisterForPlayers((TRIGGERGUID)_Trigger);

IF
CharacterEnteredTrigger(_Player,_Trigger)
AND
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_,_Victim)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_CreepyShopTrespassTrigger_CustomCrime(_Trigger,_Crime)
THEN
DB_PlayerTrespassing(_Player,_Trigger);
CharacterRegisterCrime(_Player,_Crime,(TRIGGERGUID)_Trigger,(CHARACTERGUID)_Victim,0);

IF
CharacterLeftTrigger(_Player,_Trigger)
AND
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_,_Victim)
AND
DB_ARX_CreepyShopTrespassTrigger_CustomCrime(_Trigger,_Crime)
THEN
CharacterStopCrime(_Player,_Crime,_Trigger);
NOT DB_PlayerTrespassing(_Player,_Trigger);

IF
DialogEnded(_,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_FirstPlayer)
AND
ObjectGetFlag(_FirstPlayer,"TeleportOutOfTrespass",1)
AND
DB_PlayerTrespassing((CHARACTERGUID)_FirstPlayer,_Trigger)
AND
DB_ARX_CreepyShopTrespassTrigger(_Trigger,_Outside,_)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
TeleportTo(_Player,_Outside);
NOT DB_PlayerTrespassing(_FirstPlayer,_Trigger);
ObjectClearFlag(_FirstPlayer,"TeleportOutOfTrespass",0);

//END_REGION
*/
/* //Handled in the Generics 
//REGION Tesspassing To the 2nd room Multiplayer

IF
CharacterSelectedAsBestUnavailableFallbackLead(_NPC,_Region,_UnavailableCrimeId,_BusyCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
CrimeGetType(_UnavailableCrimeId,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
CrimeGetType(_BusyCrimeID,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
DB_DialogNPCs(_ID,_NPC,1)
AND
DB_DialogPlayers(_ID,_Player1,1)
AND
DB_DialogPlayers(_ID,_Player2,2)
AND
DB_DialogPlayers(_ID,_Player3,3)
THEN
CharacterStopCrime(_Criminal1,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal2,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal3,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal4,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
ProcForceStopDialog(_NPC);
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman_StartCombat",_NPC,_Criminal1,_Criminal2,_Player1,_Player2,_Player3);

IF
CharacterSelectedAsBestUnavailableFallbackLead(_NPC,_Region,_UnavailableCrimeId,_BusyCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
CrimeGetType(_UnavailableCrimeId,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
CrimeGetType(_BusyCrimeID,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
DB_DialogNPCs(_ID,_NPC,1)
AND
DB_DialogPlayers(_ID,_Player1,1)
AND
DB_DialogPlayers(_ID,_Player2,2)
THEN
CharacterStopCrime(_Criminal1,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal2,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal3,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal4,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
ProcForceStopDialog(_NPC);
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman_StartCombat",_NPC,_Criminal1,_Criminal2,_Player1,_Player2);

IF
CharacterSelectedAsBestUnavailableFallbackLead(_NPC,_Region,_UnavailableCrimeId,_BusyCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
CrimeGetType(_UnavailableCrimeId,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
CrimeGetType(_BusyCrimeID,"ARX_CreepyCraftsman_TresspassingIn2ndRoom")
AND
DB_DialogNPCs(_ID,_NPC,1)
AND
DB_DialogPlayers(_ID,_Player1,1)
THEN
CharacterStopCrime(_Criminal1,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal2,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal3,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Criminal4,"ARX_CreepyCraftsman_TresspassingIn2ndRoom",NULL_00000000-0000-0000-0000-000000000000);
ProcForceStopDialog(_NPC);
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman_StartCombat",_NPC,_Criminal1,_Criminal2,_Player1);

//END_REGION
*/
//REGION Tresspassing To 2nd Floor 
IF 
CharacterEnteredTrigger(_Player,S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_CreepyCraftsman_PlayerIsOn_2ndFloor");

IF 
CharacterLeftTrigger(_Player,S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78)
AND
DB_IsPlayer(_Player)
THEN
ObjectClearFlag(_Player,"ARX_CreepyCraftsman_PlayerIsOn_2ndFloor");

//END_REGION

//REGION Killing The Puppet Master
/*
IF
CharacterKilledByCharacter(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",1)
THEN
ProcSetFactionHostileToIndivPlayer("ARX_CC_CreepyCraftsmen",_Player);
*/

IF
CharacterKilledBy(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_AttackerOwner,_Attacker)
AND
DB_IsPlayer(_AttackerOwner)
THEN
ProcSetFactionHostileToIndivPlayer("ARX_CC_CreepyCraftsmen",_AttackerOwner);


//END_REGION

//REGION Source Amulet

IF
DialogStarted("ARX_CreepyShop_CreepyCraftsman",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CreepyCraftsman_AgreedToFillSourceAmulet",1)
AND
ItemIsInCharacterInventory(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,(CHARACTERGUID)_Player,1)
AND
ObjectGetFlag(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,"GLO_SourceAmuletIsFull",1)
THEN
ObjectSetFlag(_Player,"ARX_CreepyCraftsman_SourceAmuletIsFull");

IF
DialogEnded("ARX_CreepyShop_CreepyCraftsman",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CreepyCraftsman_SourceAmuletIsFull",1)
THEN
ObjectClearFlag(_Player,"ARX_CreepyCraftsman_SourceAmuletIsFull",0);


// Casting on the Puppets
IF
CharacterUsedSkillOnTarget(_Player,_SourcePuppet,"Target_Item_ReplenishSource",_,_)
AND
IsTagged(_SourcePuppet,"SOURCE_PUPPET",1)
AND
ObjectGetFlag(_SourcePuppet,"ARX_CreepyShop_SourcePuppet_IsOn",0)
THEN
ObjectSetFlag(_SourcePuppet,"ARX_CreepyShop_SourcePuppet_IsOn");

//END_REGION

//REGION CreepyCraftsMan_CombatLogic
IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
CombatGetIDForCharacter(_Player,_ID)
AND
DB_IsPlayer(_AllPlayers)
AND
DB_CombatCharacters(_AllPlayers, _ID)
AND
QRY_SpeakerIsAvailable(_AllPlayers,1)
AND
DB_GlobalCounter("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog",_Count)
THEN
ProcIncreaseCounter("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog",1);
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_AllPlayers,_Count);


IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player5,4)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player4,3)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player3,2)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player2,1)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player1,0)
AND
QRY_SpeakerIsAvailable(_Player1,1)
AND
StartDialog_Internal("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player1,_Player2,_Player3,_Player4,_Player5,1)
THEN
DB_NOOP(1);


IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player4,3)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player3,2)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player2,1)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player1,0)
AND
QRY_SpeakerIsAvailable(_Player1,1)
AND
StartDialog_Internal("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player1,_Player2,_Player3,_Player4,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_NOOP(1);


IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player3,2)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player2,1)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player1,0)
AND
QRY_SpeakerIsAvailable(_Player1,1)
AND
StartDialog_Internal("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player1,_Player2,_Player3,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_NOOP(1);

IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player2,1)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player1,0)
AND
QRY_SpeakerIsAvailable(_Player1,1)
AND
StartDialog_Internal("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player1,_Player2,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_NOOP(1);

IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player1,0)
AND
QRY_SpeakerIsAvailable(_Player1,1)
AND
StartDialog_Internal("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",1,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player1,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_NOOP(1);

IF 
DialogStarted("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
CharacterLookAt((CHARACTERGUID)_NPC,_Player);

IF
CharacterCharacterEvent(_Player,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_StartDialog_InCombat")
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player,_)
THEN
CharacterSetImmortal(_Player,1);

IF 
DialogEnded("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",_ID)
AND
DB_ARX_CreepyShop_CreepyCraftsman_TellAboutTraps_Dialog(_Player,_)
THEN
CharacterSetImmortal(_Player,0);


IF 
DialogEnded("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CreepyShop_CreepyCraftsman_SparedHim",1)
AND
CombatGetIDForCharacter((CHARACTERGUID)_NPC,_CombatID)
THEN
PartySetFlag((CHARACTERGUID)_Player,"ARX_CreepyCraftsman_AllowAccess");
SetRelationFactionToPlayers("ARX_CC_CreepyCraftsmen",50);
EndCombat(_CombatID);
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_NPC,0,1,"ARX_CreepyShop_CreepyCraftsman_Fled",1);
SetHasDialog(_NPC,0);

IF 
DialogEnded("ARX_CreepyShop_CreepyCraftsman_TellAboutTraps",_ID)
AND
DialogGetInvolvedNPC(_ID,1,_NPC)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CreepyShop_CreepyCraftsman_SparedHim",0)
THEN
Proc_StartDialog(1,"ARX_AD_CreepyCraftsman_SummonPuppets",_NPC);
ObjectSetFlag(_NPC,"ARX_CreepyShop_CreepyCraftsman_SpawnPuppets");


//Puppets Combat Group //The 1st puppets that would move to the other floor will make all the other puppet join combat. Needed to clear thier Combat Group ID
IF
ObjectFlagSet("ARX_CreepyShop_CreepyCraftsman_SpawnPuppets",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
THEN
SetCombatGroupID(_Puppet,"");

IF
ObjectFlagCleared("ARX_CreepyShop_CreepyCraftsman_SpawnPuppets",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_)
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
AND
NOT DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
THEN
SetCombatGroupID(_Puppet,"04db7ab9-89a1-4726-9079-bcacf085c66b");

IF
ObjectFlagCleared("ARX_CreepyShop_CreepyCraftsman_SpawnPuppets",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
THEN
SetCombatGroupID(_Puppet,"a02c828e-9c7f-4c6b-94f7-e53fbca889e0");
//END_REGION

//REGION Spawn Puppets

//DB Setup
IF
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard)
THEN
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,NULL_00000000-0000-0000-0000-000000000000);
/*
IF
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_Trigger)
AND
_Trigger != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_OneShotPlayerTrigger((TRIGGERGUID)_Trigger);

PROC
ProcOneShotTriggerEntered(_Player,_Trigger)
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_Trigger)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_WaitToBeSpawned",1)
AND
CharacterIsDead((CHARACTERGUID)_Puppet,0)
THEN
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem(_Puppet,(ITEMGUID)_Item,(ITEMGUID)_HackBoard);
*/

IF
ObjectFlagSet("ARX_CreepyShop_CreepyCraftsman_SpawnPuppets",_Craftsman,_)
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_WaitToBeSpawned",1)
AND
CharacterIsDead((CHARACTERGUID)_Puppet,0)
THEN
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem(_Puppet,(ITEMGUID)_Item,(ITEMGUID)_HackBoard);


PROC
ProcBlockUseOfItem(_Player,_Item)
AND
DB_IsPlayer(_Player)
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_WaitToBeSpawned",1)
AND
CharacterIsDead((CHARACTERGUID)_Puppet,0)
THEN
DB_CustomUseItemResponse(_Player,_Item,0);
//Proc_StartDialog(0,"",_Player,_Item);
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem(_Puppet,_Item,(ITEMGUID)_HackBoard);


PROC
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem((CHARACTERGUID)_Puppet,(ITEMGUID)_Item,(ITEMGUID)_HackBoard)
AND
HasActiveStatus(_Puppet,"INVISIBLE",1)
THEN
RemoveStatus(_Puppet,"INVISIBLE");

PROC
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem((CHARACTERGUID)_Puppet,(ITEMGUID)_Item,(ITEMGUID)_HackBoard)
THEN
SetOnStage(_HackBoard,0);
PlayAnimation(_Item,"open");
ItemSetCanInteract(_Item,0);
ProcObjectTimer(_Item,"ARX_CreepyShop_SourcePuppet_Spawned",500);

PROC
ProcObjectTimerFinished(_Item,"ARX_CreepyShop_SourcePuppet_Spawned")
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
THEN
ObjectSetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn");
ItemSetCanInteract((ITEMGUID)_Item,1);
PlayAnimation(_Item,"close");

IF
ItemDestroyed(_Item)
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
AND
CharacterIsDead((CHARACTERGUID)_Puppet,0)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_WaitToBeSpawned",1)
THEN
CharacterDie(_Puppet,0,"Physical");

IF
ItemDestroyed(_Item)
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
THEN
ItemDestroy((ITEMGUID)_HackBoard);

//END_REGION

//REGION CreepyCraftsmna Let the player pass 

IF 
ObjectFlagSet("ARX_CreepyCraftsman_AllowAccess",_Player,_ID)
AND
DB_TrespassTrigger(_Trigger,_OutTrigger,_CrimeName,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
THEN
ProcCharacterDisableCrime((CHARACTERGUID)_Player,_CrimeName);
//TriggerUnregisterForCharacter((TRIGGERGUID)_Trigger,(CHARACTERGUID)_Player);

IF 
ObjectFlagSet("ARX_CreepyCraftsman_AllowAccess",(CHARACTERGUID)_Player,_ID)
AND
DB_TrespassTrigger(_Trigger,_OutTrigger,_CrimeName,S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394)
AND
DB_InRegion(_Player,_Trigger)
THEN
CharacterStopCrime(_Player, _CrimeName, _Trigger);

IF 
ObjectFlagSet("ARX_CreepyCraftsman_AllowAccess",_Player,_ID)
THEN
ItemClearOwner(ITEMGUID_1m_CastleHouse_A_Stairs_A_002_ARX_Main_Rework_000_739c5c21-ab3f-8b8a-3b4f-7bc28ccc1a15);
ItemClearOwner(ITEMGUID_1m_CityHouse_A_Door_A_014_ARX_Main_Rework_000_54fdaac5-5964-80e4-214b-4bff92338c89);
ItemClearOwner(ITEMGUID_05m_WoodenHouse_A_Stair_Down_A_Item_004_b507ea66-e916-4195-bf0d-93cc00fa7ecc);
ItemClearOwner(ITEMGUID_S_ARX_CreepyCraftsman_CathedralDesignHolder_4b67b311-7654-4a90-ba46-c68ec4495bc5);

//END_REGION

//REGION Cathdral Designs

//Learning the password from the letter

IF
GameBookInterfaceClosed(S_ARX_CreepyCraftsman_UnsentLetterToDad_7b7476cb-87e0-4f0d-baa4-dece00dd16ce,_Player)
THEN
UserSetFlag(_Player,"ARX_CreepyCraftsman_PlayerKnowsPassword");

IF
CharacterUsedItem(_Player,S_ARX_CreepyCraftsman_CathedralDesignHolder_4b67b311-7654-4a90-ba46-c68ec4495bc5)
AND
DB_IsPlayer(_Player)
AND
ItemIsLocked(S_ARX_CreepyCraftsman_CathedralDesignHolder_4b67b311-7654-4a90-ba46-c68ec4495bc5,1)
THEN
Proc_StartDialog(0,"ARX_CreepyCraftsman_CathedralDesignHolder",_Player);


IF
DialogEnded("ARX_CreepyCraftsman_CathedralDesignHolder",_ID)
AND
GlobalGetFlag("ARX_CreepyCraftsman_CathedralDesignHolder_Unlocked",1)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
ItemUnLock(S_ARX_CreepyCraftsman_CathedralDesignHolder_4b67b311-7654-4a90-ba46-c68ec4495bc5);
CharacterUseItem((CHARACTERGUID)_Player,S_ARX_CreepyCraftsman_CathedralDesignHolder_4b67b311-7654-4a90-ba46-c68ec4495bc5,"");

IF
DialogEnded("ARX_CreepyCraftsman_CathedralDesignHolder",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_CreepyCraftsman_PlayerGuessedWrong",1)
THEN
PlayEffect(_Player,"RS3_FX_GP_Impacts_Mine_Electric_01");
CharacterDie((CHARACTERGUID)_Player,0,"Electrocution");
ObjectClearFlag(_Player,"ARX_CreepyCraftsman_PlayerGuessedWrong",0);

//END_REGION


//REGION GodKind Brings Toys to Life
IF
CharacterCharacterEvent(_Player,_Puppet,"ARX_CreepyCraftsman_GodKing_BringPuppetsToLife")
AND
QRY_SpeakerIsAvailable(_Puppet)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QueryOnlyOnce("ARX_CreepyCraftsman_GodKing_PuppetDialogStart")
THEN
SetOnStage(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,1); // just in case
TeleportTo(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,_Puppet);
Proc_StartDialog(0,"ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_Puppet,CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,_Player);

IF
CharacterCharacterEvent(_Player,_Puppet,"ARX_CreepyCraftsman_GodKing_BringPuppetsToLife")
AND
DB_IsPlayer(_OtherPlayer)
AND
IsTagged(_OtherPlayer,"PROMISED",1)
AND
ObjectGetFlag(_OtherPlayer,"ARX_CreepyCraftsman_PlayerIsOn_2ndFloor",1)
THEN
GlobalSetFlag("ARX_CreepyCraftsman_GodKing_PromisedInTheRoom");

IF
DialogStarted("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_ID)
AND
DB_DialogNPCs(_ID,_Puppet,_)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing((CHARACTERGUID)_Puppet)
AND
DB_IsPlayer(_Player)
AND
NOT DB_DialogPlayers(_ID,_Player,_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,_Puppet)
THEN
DialogAddActor(_ID,_Player);

IF 
CharacterLeftTrigger(_Player,S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78)
AND
GlobalGetFlag("ARX_CreepyCraftsman_GodKing_PromisedInTheRoom",1)
THEN
proc_ARX_CreepyCraftsman_Shop2ndFloor_CheckForPromisedPlayers(S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78);

PROC
proc_ARX_CreepyCraftsman_Shop2ndFloor_CheckForPromisedPlayers((TRIGGERGUID)_Trigger)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"PROMISED",1)
AND
DB_InRegion(_Player, _Trigger)
THEN
DB_ARX_CreepyCraftsman_Shop2ndFloor_PromisedPlayerInRegion(_Player);

PROC
proc_ARX_CreepyCraftsman_Shop2ndFloor_CheckForPromisedPlayers((TRIGGERGUID)_Trigger)
AND
NOT DB_ARX_CreepyCraftsman_Shop2ndFloor_PromisedPlayerInRegion(_)
THEN
GlobalClearFlag("ARX_CreepyCraftsman_GodKing_PromisedInTheRoom");

PROC //Cleanup
proc_ARX_CreepyCraftsman_Shop2ndFloor_CheckForPromisedPlayers((TRIGGERGUID)_Trigger)
AND
DB_ARX_CreepyCraftsman_Shop2ndFloor_PromisedPlayerInRegion(_Player)
THEN
NOT DB_ARX_CreepyCraftsman_Shop2ndFloor_PromisedPlayerInRegion(_Player);

IF 
CharacterLeftTrigger(_Player,S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"AI_UNPREFERRED_TARGET",1)
THEN
ClearTag(_Player,"AI_UNPREFERRED_TARGET");

IF
DialogRequestFailed("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_ID)
THEN
NOT DB_OnlyOnce("ARX_CreepyCraftsman_GodKing_PuppetDialogStart");

IF
DialogStarted("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_ID)
THEN
GlobalSetFlag("ARX_CreepyCraftsman_GodKing_PuppetDialogStarted");

IF
ObjectFlagSet("ARX_CreepyCraftsman_PuppetTalksWithVoiceOfGodKing",(CHARACTERGUID)_Puppet,_ID)
THEN
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets(_Puppet);
PlaySound(_Puppet,"SE_ARX_Puppet_Transformation_01");

IF
DialogEnded("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_ID)
AND
DB_DialogNPCs(_ID,_Puppet,1)
THEN
PlaySound(_Puppet,"SE_ARX_Puppet_Transformation_01"); // The effect plays on all the other puppet but for the sound pourposes it would come for the one puppet you were talking to to not clutter the mix
PlaySound(_Puppet,"SE_ARX_Puppet_Transformation_GodKingLaugh_01");

IF
DialogEnded("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife",_ID)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
AND
CharacterIsDead((CHARACTERGUID)_Puppet,0)
THEN
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets(_Puppet);
SetOnStage(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,0);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets((CHARACTERGUID)_Puppet)
THEN
ObjectSetFlag(_Puppet,"ARX_CreepyCraftsman_PuppetPossessedByGodKing");
SetVarInteger(_Puppet,"ADOnTurnedOn",0); //This Disableds the puppet from ADing. As there are 3 of them being spawned at the same time
SetVarInteger(_Puppet,"ADOnTurnedOff",0); 
SetVarInteger(_Puppet,"NotifyPuppetIsOffToCreep",0); 
SetVarInteger(_Puppet,"PuppetIsSpotting",0); 
PlayEffect(_Puppet,"RS3_FX_GP_ScriptedEvent_ARX_Puppet_Transformation_01"); 
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_ARX_Puppet_Possessed_01",_Puppet,"ARX_CreepyCraftsman_PuppetPossessedByGodKing","ARX_Main","");
ApplyStatus(_Puppet,"POSSESSED",-1.0,1);
SetFaction(_Puppet,"ARX_CreepyCraftsman_GodKing_Puppet");
CharacterAddSkill(_Puppet,"Target_Curse");

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets((CHARACTERGUID)_Puppet)
AND
QueryOnlyOnce("ARX_CreepyCraftsman_GodKing_BringPuppetsToLife_SetRelationOnce")
AND
DB_IsPlayer(_OtherPlayer)
AND
IsTagged(_OtherPlayer,"PROMISED",1)
THEN
CharacterSetRelationFactionToIndivFaction("ARX_CreepyCraftsman_GodKing_Puppet",_OtherPlayer,50);

// End combat if there are only sworn Players
QRY
qry_ARX_CreepyCraftsman_GodKing_InCombat((INTEGER)_CombatID)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
AND
DB_CombatCharacters(_Puppet,_CombatID)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyCraftsman_PuppetPossessedByGodKing",1)
THEN
DB_Noop(1);

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_CombatID)
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"PROMISED",1)
AND
qry_ARX_CreepyCraftsman_GodKing_InCombat(_CombatID)
THEN
Proc_SetTagForCombat(_Player,"AI_UNPREFERRED_TARGET");


IF
ObjectLeftCombat((CHARACTERGUID)_Player,_CombatID)
AND
DB_IsPlayer(_Player)
AND
qry_ARX_CreepyCraftsman_GodKing_InCombat(_CombatID)
THEN
proc_ARX_CreepyShop_SourcePuppets_GodKing_PlayerLeftCombat(_Player,_CombatID);

PROC
proc_ARX_CreepyShop_SourcePuppets_GodKing_PlayerLeftCombat((CHARACTERGUID)_Player,(INTEGER)_CombatID)
AND
DB_IsPlayer(_OtherPlayer)
AND
_OtherPlayer != _Player
AND
DB_CombatCharacters(_OtherPlayer,_CombatID)
AND
IsTagged(_OtherPlayer,"PROMISED",0)
THEN
DB_ARX_CreepyShop_SourcePuppets_GodKing_HaveEnemiesInCombat(_Player);

PROC
proc_ARX_CreepyShop_SourcePuppets_GodKing_PlayerLeftCombat((CHARACTERGUID)_Player,(INTEGER)_CombatID)
AND
NOT DB_ARX_CreepyShop_SourcePuppets_GodKing_HaveEnemiesInCombat(_)
THEN
proc_ARX_CreepyShop_SourcePuppets_GodKing_EndCombat(_CombatID);

PROC
proc_ARX_CreepyShop_SourcePuppets_GodKing_PlayerLeftCombat((CHARACTERGUID)_Player,(INTEGER)_CombatID)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing_HaveEnemiesInCombat(_Players)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets_GodKing_HaveEnemiesInCombat(_Players);

PROC
proc_ARX_CreepyShop_SourcePuppets_GodKing_EndCombat((INTEGER)_CombatID)
AND
NOT DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce")
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_CombatID)
AND
IsTagged(_Player,"PROMISED",1)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
AND
DB_CombatCharacters(_Puppet,_CombatID)
AND
QRY_SpeakerIsAvailable(_Puppet,1)
AND
QRY_SpeakerIsAvailable(_Player,1)
AND
QueryOnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce")
THEN
EndCombat(_CombatID);
ProcCharacterMoveToAndTalk(_Puppet,_Player,"ARX_CreepyShop_SourcePuppets_GodKing_EndCombat",0,"ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_Dialog",1,15.0);

PROC
proc_ARX_CreepyShop_SourcePuppets_GodKing_EndCombat((INTEGER)_CombatID)
AND
DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce")
THEN
EndCombat(_CombatID);

//Handle move to and talk fail
IF
CharacterMoveToAndTalkFailed(_Puppet,_Player,"ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_Dialog")
AND
DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce")
THEN
NOT DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce");

IF
CharacterMoveToAndTalkRequestDialogFailedEvent(_Puppet,_Player,"ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_Dialog")
AND
DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce")
THEN
NOT DB_OnlyOnce("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat_OnlyOnce");

IF
DialogStarted("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat",_ID)
AND
DB_DialogNPCs(_ID,_Puppet,1)
THEN
SetOnStage(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,1); 
TeleportTo(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,_Puppet);
DialogAddActorAt(_ID,CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,3);

IF
DialogEnded("ARX_CreepyShop_SourcePuppets_GodKing_EndCombat",_ID)
THEN
SetOnStage(CHARACTERGUID_S_ARX_GodKing_InvisHelper_CreepyShop_c573050e-cb3f-4074-9858-d0cb61148345,0);

IF
CharacterDying(_Puppet)
AND
DB_LoopEffect(_Puppet, _fxHandle,"ARX_CreepyCraftsman_PuppetPossessedByGodKing",_Region,_effect, _BoneName)
THEN
PROC_StopLoopEffect(_Puppet,"ARX_CreepyCraftsman_PuppetPossessedByGodKing");

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets((CHARACTERGUID)_Puppet) //This will never happen on ARX_CreepyCraftsman_PuppetTalksWithVoiceOfGodKing Flag set. Cant start a dialog with a puppet that is not spawned
AND
DB_ARX_CreepyShop_SourcePuppets_Spawners(_Puppet,_Item,_HackBoard,_)
AND
ObjectGetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_WaitToBeSpawned",1)
THEN
proc_ARX_CreepyCraftsman_SpawnPuppetFromItem(_Puppet,(ITEMGUID)_Item,(ITEMGUID)_HackBoard);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetsToLifeTransformPuppets((CHARACTERGUID)_Puppet)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKing(_Puppet)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets(_Puppet); //To not trigger any of the Attacked and turning Hostile events

//Toknow if the player Ecnounted the puppets
IF
CombatStarted(_ID)
AND
qry_ARX_CreepyCraftsman_GodKing_InCombat(_ID)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player, _ID)
THEN
PartySetFlag(_Player,"ARX_CreepyCraftsman_GodKing_FoughtPuppets");

IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_ID)
AND
DB_IsPlayer(_Player)
AND
qry_ARX_CreepyCraftsman_GodKing_InCombat(_ID)
THEN
PartySetFlag(_Player,"ARX_CreepyCraftsman_GodKing_FoughtPuppets");

//Puppets Combat Logic
PROC
ARX_CreepyShop_SourceVamp_Puppet(_Player,_Puppet)
AND
DB_CombatCharacters(_Player,_CombatID)
AND
qry_ARX_CreepyCraftsman_GodKing_InCombat(_CombatID)
AND
GetUUID(_Puppet,_PuppetUUID)
AND
StringConcatenate(_PuppetUUID,"TimerToTurnOn",_PuppetToTurnOnCounter)
THEN
ProcDeclareCounter(_PuppetToTurnOnCounter);
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn((CHARACTERGUID)_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter);

IF
ObjectTurnStarted((CHARACTERGUID)_CombatChar)
AND
DB_CombatCharacters(_CombatChar,_CombatID)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
THEN
ProcIncreaseCounter(_PuppetToTurnOnCounter,1);

IF
ObjectTurnEnded((CHARACTERGUID)_CombatChar)
AND
DB_CombatCharacters(_CombatChar,_CombatID)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
AND
DB_GlobalCounter(_PuppetToTurnOnCounter,2)
THEN
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife(_Puppet);

IF
ObjectSwitchedCombat((CHARACTERGUID)_Puppet,_OldCombatID,_NewCombatID) //Combat Merging
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_OldCombatID,_PuppetToTurnOnCounter)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_OldCombatID,_PuppetToTurnOnCounter);
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_NewCombatID,_PuppetToTurnOnCounter);

IF
CharacterDying(_Puppet) //Puppet Dies
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter);
ProcRemoveCounter(_PuppetToTurnOnCounter);

IF
CombatEnded(_CombatID) //Combat ended
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
AND
NOT DB_CombatCharacters(_,_CombatID)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter);
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife(_Puppet);
ProcRemoveCounter(_PuppetToTurnOnCounter);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife((CHARACTERGUID)_Puppet)
AND
NOT DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_)
THEN
SetCanFight(_Puppet,1);
SetCanJoinCombat(_Puppet,1);
CharacterSetReactionPriority(_Puppet,"DontMoveWhileAD_Combat",1800);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife((CHARACTERGUID)_Puppet)
AND
DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_)
THEN
ObjectSetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn");
PlayEffect(_Puppet,"RS3_FX_GP_ScriptedEvent_ARX_Puppet_Transformation_01"); 
ApplyStatus(_Puppet,"POSSESSED",-1.0,1);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife((CHARACTERGUID)_Puppet)
AND
CharacterIsInCombat(_Puppet,1)
THEN
JumpToTurn(_Puppet);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife((CHARACTERGUID)_Puppet)
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
AND
NOT DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_)
THEN
Proc_StartDialog(1,"ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife",_Puppet);
DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_Puppet);

IF
AutomatedDialogEnded("ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife",_)
AND
DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_Puppet)
THEN
CharacterSetReactionPriority(_Puppet,"DontMoveWhileAD_Combat",0);
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife(_Puppet);

IF
AutomatedDialogRequestFailed("ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife",_)
AND
DB_ARX_AD_CreepyCraftsman_GodKing_BringPuppetsToLife_FirstTime(_Puppet)
THEN
CharacterSetReactionPriority(_Puppet,"DontMoveWhileAD_Combat",0);
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife(_Puppet);

PROC
proc_ARX_CreepyCraftsman_GodKing_BringPuppetBackToLife((CHARACTERGUID)_Puppet) //Cleanup
AND
DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter)
THEN
NOT DB_ARX_CreepyShop_SourcePuppets_GodKingTurnsPuppetOn(_Puppet,_Player,_CombatID,_PuppetToTurnOnCounter);
ProcRemoveCounter(_PuppetToTurnOnCounter);

//END_REGION

//REGION Journal 
IF
ObjectFlagSet("ARX_CreepyCraftsman_PlayerKnowsCathedralSecret",(CHARACTERGUID)_Player,_ID)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_CreepyCraftsman_KnowCathedralSecret");


IF
DialogEnded("ARX_CreepyShop_CreepyCraftsman",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_CreepyCraftsman_MetCreep");

IF
DialogEnded("ARX_CreepyCraftsman_CathedralDesignHolder",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_CreepyCraftsman_InteractedWithDesk");

IF
DialogEnded("ARX_CreepyCraftsman_CathedralDesignHolder",_ID)
AND
GlobalGetFlag("ARX_CreepyCraftsman_CathedralDesignHolder_Unlocked",1)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_CreepyCraftsman_DeskIsOpen");


IF
DialogEnded("ARX_CreepyShop_TresspassingCrime",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_CreepyCraftsman_TriedToGoTo2ndFloor");


//END_REGION

//REGION Debug

IF
TextEventSet("CC_ComeToMe")
THEN
CharacterMoveTo(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1,"",0);

IF
TextEventSet("ARX_CreepyCraftsman_Knows_Password")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_CreepyCraftsman_PlayerKnowsPassword");

IF
TextEventSet("CC_AllPuppetsToMe")
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
THEN
CharacterMoveTo((CHARACTERGUID)_Puppet,S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295,1,"",0);

IF
TextEventSet("CC_AwayfromMe")
THEN
CharacterMoveTo(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyShop_CreepyCraftsmen_StartConversaton_5c27fa66-a6c3-4368-bdde-d538bb90a711,1,"",0);

IF
TextEventSet("CC_FirstRoom_TurnPuppetsOn")
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
THEN
ObjectSetFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn");

IF
TextEventSet("CC_FirstRoom_TurnPuppetsOff")
AND
DB_ARX_CreepyShop_SourcePuppets(_Puppet)
THEN
ObjectClearFlag(_Puppet,"ARX_CreepyShop_SourcePuppet_IsOn",0);

IF
TextEventSet("ARX_CC_ShowTrick")
THEN
GlobalSetFlag("ARX_CreepyShop_CreepyCraftsman_ShowedTrick");

IF
TextEventSet("ARX_CC-StartDialog")
AND
DB_IsPlayer(_Player)
THEN
//PlaySound(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"SE_ARX_CreepyCraftsman_DialogStart_Scare");
Proc_StartDialog(0,"ARX_CreepyShop_CreepyCraftsman",S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player);

IF
TextEventSet("ARX_AmuletToPlayer")
AND
DB_IsPlayer(_Player)
THEN
ItemToInventory(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,_Player);


IF
TextEventSet("ARX_SourceAmulet_AddCharge")
THEN
ItemAddCharges(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,1);

IF
TextEventSet("ARX_SourceAmulet_RemoveCharge")
THEN
ItemAddCharges(S_ARX_CreepyCraftsman_SourceAmulet_f9c139b9-bb0f-4027-b8a4-806df5336fd2,-1);

IF
TextEventSet("ARX_CC-SpawnPuppet1")
THEN
ObjectSetFlag(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,"ARX_CreepyShop_CreepyCraftsman_SpawnPuppets");
PlayAnimation(S_ARX_CreepyShop_PuppetSpawner1_f547ad22-83c5-445e-89b8-09e339531f59,"open","ARX_ItemOpened");
ObjectSetFlag(S_ARX_CreepyShop_2ndFloor_SourcePuppet1_480f3e01-426b-4d07-b001-892b8aa7b7f7,"ARX_CreepyShop_SourcePuppet_IsOn");

IF
StoryEvent(_ITEM,"ARX_ItemOpened")
THEN
DebugText(_ITEM,"ARX_ItemOpened");

IF
TextEventSet("ARX_CreepyCraftsman_AmuletIsFull")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_CreepyCraftsman_SourceAmuletIsFull");


IF
TextEventSet("ARX_CreepyCraftsman_FixAttitude")
AND
DB_IsPlayer(_Player)
THEN
CharacterAddAttitudeTowardsPlayer(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,_Player,51);

IF
TextEventSet("CreepyFreeArhu")
THEN
GlobalSetFlag("ARX_KemmVault_Arhu_Freed");

IF
TextEventSet("CreepyArhuSentMe")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_Arhu_CreepyCraftsmanAmulet");

IF
TextEventSet("CreepyReadDoc")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_CreepyShop_CreepyCraftman_ReadReportInBarracks");

IF
TextEventSet("Creepy_allowAccess")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"ARX_CreepyCraftsman_AllowAccess");


IF
TextEventSet("TeleportCreepyTo2ndFloor")
THEN
TeleportTo(S_ARX_CreepyShop_CreepyCraftsman_63af3c4c-b4d6-4f97-9c49-50d80c41d394,S_ARX_CreepyCraftsman_Shop2ndFloor_7ec6f5e8-5ced-4cbc-88df-19d29d726c78);
//END_REGION

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
