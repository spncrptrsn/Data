Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba,"CoS_Temples_KnightOfTirCendelius");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba,CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_Ghost_5421f1bb-7bd3-48e2-862b-c2d95adcf8b9,"CoS_Temples_KnightOfTirCendelius_Ghost");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_Animal_001_25c480ef-7cc5-4449-af8a-f68fadb2e0e0,"CoS_Temples_Elf_Animal_001");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Elf_Animal_001_25c480ef-7cc5-4449-af8a-f68fadb2e0e0,CHARACTERGUID_S_CoS_Temples_Elf_Animal_001_Ghost_02ce2d54-8f59-4091-826b-86d48cf291a0,"CoS_Temples_Elf_Animal_001_Ghost");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_Animal_002_81445d6d-9c36-4f54-ab26-49f2bf3c6ed0,"CoS_Temples_Elf_Animal_002");

DB_Dialogs(CHARACTERGUID_S_CoS_Temples_WanderingKnight_2ab81248-b275-4aaf-8cce-3c4f63b01e7e,"CoS_Temples_WanderingKnight");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_DwarfPriestess_3447b1f4-18d5-4952-9034-8967995ab7f2,"CoS_Temples_Elf_DwarfPriestess");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_LizardPriest_0afc01e3-8760-4c4e-906d-72e84e5d329f,"CoS_Temples_Elf_LizardPriest");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_001_a3b4c346-d77b-4b20-afaa-1d3d14d4307b,"CoS_Temples_Elf_ElfPriest_001");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_002_6efb4ca8-6e39-4a58-ad52-f8ac7938265e,"CoS_Temples_Elf_ElfPriest_002");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_003_42774305-287a-4cd5-80a7-08f805c2e69e,"CoS_Temples_Elf_ElfPriest_003");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_001_1f9e87b0-47e4-438d-9930-777cae653edd,"CoS_Temples_Elf_Merchant_001");
DB_IsNotMessingAround(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_001_1f9e87b0-47e4-438d-9930-777cae653edd);
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_002_3b0c1af8-cacb-424d-8e2a-3f51aa92bee6,"CoS_Temples_Elf_Merchant_002");
DB_IsNotMessingAround(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_002_3b0c1af8-cacb-424d-8e2a-3f51aa92bee6);

DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_WanderingKnight_2ab81248-b275-4aaf-8cce-3c4f63b01e7e);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_DwarfPriestess_3447b1f4-18d5-4952-9034-8967995ab7f2);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_LizardPriest_0afc01e3-8760-4c4e-906d-72e84e5d329f);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_001_a3b4c346-d77b-4b20-afaa-1d3d14d4307b);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_002_6efb4ca8-6e39-4a58-ad52-f8ac7938265e);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_003_42774305-287a-4cd5-80a7-08f805c2e69e);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_001_1f9e87b0-47e4-438d-9930-777cae653edd);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_Merchant_002_3b0c1af8-cacb-424d-8e2a-3f51aa92bee6);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba);
DB_CoS_ElfTemple_Citizens(CHARACTERGUID_S_CoS_Temples_Elf_Animal_001_25c480ef-7cc5-4449-af8a-f68fadb2e0e0);


//BR ghosts near shriekers
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_GhostNearShrieker_001_Body_07c5b98d-e069-4ad3-af2e-e7a5f2f9703b,CHARACTERGUID_S_CoS_Temples_GhostNearShrieker_001_f8f604f5-1d3b-4af0-b66f-7ec677443f52,"CoS_Temples_GhostNearShrieker_001");
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_GhostNearShrieker_002_Body_eed00f03-5f57-4539-92ca-38f4a8ecef26,CHARACTERGUID_S_CoS_Temples_GhostNearShrieker_002_3f12b4ec-e10c-49b7-b183-4ba88d74fbd9,"CoS_Temples_GhostNearShrieker_002");

//Cowering BR
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_001_78df2cf8-b492-461b-a34d-2116b29a294d,"CoS_Temples_Elf_BlackRing_001");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_002_4078d759-ed9d-4971-9f68-415cb9a71704,"CoS_Temples_Elf_BlackRing_002");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_003_b31439fd-3d0f-4a85-aedd-a59ad856842b,"CoS_Temples_Elf_BlackRing_003");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_004_c1631c6e-e570-49ed-9987-d699da96059c,"CoS_Temples_Elf_BlackRing_004");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_005_8f340801-5f6e-4b7e-9f34-c734f22e3b53,"CoS_Temples_Elf_BlackRing_005");
DB_Dialogs(CHARACTERGUID_S_CoS_Temples_Elf_BlackRingWarg_001_d13b4a32-5c70-4585-aef2-1e858c920c8b,"CoS_Temples_Elf_BlackRingWarg_001");




ObjectSetFlag(CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba,"GLO_IgnoredBySourceTotems");
ObjectSetFlag(CHARACTERGUID_S_CoS_Temples_Elf_Animal_002_81445d6d-9c36-4f54-ab26-49f2bf3c6ed0,"GLO_IgnoredBySourceTotems");
ObjectSetFlag(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"GLO_IgnoredBySourceTotems");

//CoS Totems at the Elf Temple
DB_FTJ_SW_SourceTotems((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Shrieker_001_23749c6a-3167-40a3-a9ed-02b7e3a6c15f,"CoS_Temples_DetectedByTotem_001","CoS_Temples_Totem_001_Spotted");
DB_FTJ_SW_SourceTotems((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Shrieker_002_2de1c6ec-96e2-4d65-a72b-29d57d59911d,"CoS_Temples_DetectedByTotem_002","CoS_Temples_Totem_002_Spotted");
DB_FTJ_SW_SourceTotems((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Shrieker_003_ba39319a-42cf-4549-8fb9-495bb31561ca,"CoS_Temples_DetectedByTotem_003","CoS_Temples_Totem_003_Spotted");
DB_FTJ_SW_SourceTotems((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Shrieker_004_489ace18-5920-4d0b-9641-9c1b97bc2212,"CoS_Temples_DetectedByTotem_004","CoS_Temples_Totem_004_Spotted");

SetOnStage(ITEMGUID_S_CoS_Temples_Elf_Ladder_0a4f0a64-619f-889b-2c5f-f31673b59d79,0);

//Paladin Corpse near seekers
DB_Ghosts(CHARACTERGUID_S_CoS_Temples_Elf_PaladinCorpse_0625d074-7b0a-419e-b6f4-2d4e3a2dc093,CHARACTERGUID_S_CoS_Temples_Elf_PaladinCorpse_Ghost_358d80c5-8384-4252-9185-bb1344debcfd,"CoS_Temples_Elf_PaladinCorpse_Ghost");

DB_DeadEvent(CHARACTERGUID_S_CoS_Temples_Elf_Animal_001_25c480ef-7cc5-4449-af8a-f68fadb2e0e0,"CoS_Temples_Elf_Tiger_IsDead");
DB_DeadEvent(CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_002_4078d759-ed9d-4971-9f68-415cb9a71704,"CoS_Temples_Elf_BlackRing_CaptainIsDead");

DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_001_23749c6a-3167-40a3-a9ed-02b7e3a6c15f,"CoS_ElfTemple_FirstShriekers");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_002_2de1c6ec-96e2-4d65-a72b-29d57d59911d,"CoS_ElfTemple_FirstShriekers");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_003_ba39319a-42cf-4549-8fb9-495bb31561ca,"CoS_ElfTemple_FirstShriekers");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_004_489ace18-5920-4d0b-9641-9c1b97bc2212,"CoS_ElfTemple_FirstShriekers");
DB_KillCounter("CoS_ElfTemple_FirstShriekers",2);

DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_001_23749c6a-3167-40a3-a9ed-02b7e3a6c15f,"CoS_ElfTemple_AllShriekersKilled");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_002_2de1c6ec-96e2-4d65-a72b-29d57d59911d,"CoS_ElfTemple_AllShriekersKilled");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_003_ba39319a-42cf-4549-8fb9-495bb31561ca,"CoS_ElfTemple_AllShriekersKilled");
DB_KillCounter_Internal(CHARACTERGUID_S_CoS_Temples_Shrieker_004_489ace18-5920-4d0b-9641-9c1b97bc2212,"CoS_ElfTemple_AllShriekersKilled");
DB_KillCounter("CoS_ElfTemple_AllShriekersKilled",4);

DB_RepairTrader((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_WanderingKnight_2ab81248-b275-4aaf-8cce-3c4f63b01e7e,3);
DB_LoremasterTrader((CHARACTERGUID)CHARACTERGUID_S_CoS_Temples_Elf_Merchant_002_3b0c1af8-cacb-424d-8e2a-3f51aa92bee6,4);


KBSECTION
IF
DB_CoS_ElfTemple_Citizens(_Citizen)
THEN
ObjectSetFlag(_Citizen,"GLO_IgnoredBySourceTotems");

IF
StoryEvent(_Player,"CoS_ElfKnight_StartDialog")
THEN
Proc_StartDialog(0,"CoS_Temples_KnightOfTirCendelius",CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba,_Player);
ObjectSetFlag(_Player,"GLO_IgnoredBySourceTotems");
DB_CoS_ElfKnight_HasSpokenToPlayer(1);


IF
StoryEvent(_Player,"CoS_Temples_Elf_BlackRing_002_StartDialog")
THEN
Proc_StartDialog(0,"CoS_Temples_Elf_BlackRing_002",CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_002_4078d759-ed9d-4971-9f68-415cb9a71704,_Player);

//Dialog end to combat
IF
DialogEnded("CoS_Temples_Elf_BlackRing_002",_Id)
AND
DialogGetInvolvedNPC(_Id,1,(CHARACTERGUID)_Captain)
AND
ObjectGetFlag(_Captain,"CoS_Temples_CaptainGoHostile",1)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_ElfTemple","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_ElfTemple",0);


IF
StoryEvent(_Player,"CoS_Temples_Elf_ElfPriest_003_StartDialog")
THEN
Proc_StartDialog(0,"CoS_Temples_Elf_ElfPriest_003",CHARACTERGUID_S_CoS_Temples_Elf_ElfPriest_003_42774305-287a-4cd5-80a7-08f805c2e69e,_Player);


IF
ObjectFlagSet("CoS_GiveSallowManMirror",(CHARACTERGUID)_Player,_)
THEN
ItemTemplateAddTo("QUEST_DarkMirror_BlackRing_a3da854d-5b28-47cc-b7da-e7075d0f97f3",_Player,1);
ObjectClearFlag(_Player,"CoS_GiveSallowManMirror",0);

PROC
ReactOnKillCounter("CoS_ElfTemple_FirstShriekers")
AND
NOT DB_CoS_ElfKnight_HasSpokenToPlayer(1)
THEN
GlobalSetFlag("CoS_Temples_Elf_FirstGheistsPurged");
CharacterMoveTo(CHARACTERGUID_S_CoS_Temples_Elf_KnightOfTirCendelius_08874b98-961f-43ef-9c60-1890c8e8cbba,TRIGGERGUID_S_CoS_Temples_KnightOfTC_Shrieker_Point_91499b32-8e00-4d16-b1a1-0b6db9435fa7,1,"",0);
CharacterMoveTo(CHARACTERGUID_S_CoS_Temples_Elf_Animal_002_81445d6d-9c36-4f54-ab26-49f2bf3c6ed0,TRIGGERGUID_S_CoS_Temples_KnightBuddy_Shrieker_Point_001_1ded5bb9-c738-488b-8966-810a8b0c96fa,1,"",0);

PROC
ReactOnKillCounter("CoS_ElfTemple_FirstShriekers")
THEN
GlobalSetFlag("CoS_Temples_Elf_AllShriekersPurged");

IF
GlobalFlagSet("CoS_Temples_CanEnterElfTemple")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"GLO_IgnoredBySourceTotems");
DB_GLO_IgnoredBySourceTotems(_Player);

IF
CharacterMadePlayer(_Player)
AND
GlobalGetFlag("CoS_Temples_CanEnterElfTemple",1)
AND
NOT DB_GLO_IgnoredBySourceTotems(_Player)
THEN
ObjectSetFlag(_Player,"GLO_IgnoredBySourceTotems");
DB_GLO_IgnoredBySourceTotems(_Player);

//Ladder Roll
IF
CharacterUsedItem(_,ITEMGUID_S_CoS_Temples_Elf_LadderRoll_db78369d-21ae-4e18-8cd3-3df398381d91)
AND
GetPosition(ITEMGUID_S_CoS_Temples_Elf_LadderRoll_db78369d-21ae-4e18-8cd3-3df398381d91,_X,_Y,_Z)
AND
GetPosition(ITEMGUID_S_CoS_Temples_Elf_Ladder_0a4f0a64-619f-889b-2c5f-f31673b59d79,_X1,_Y1,_Z1)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X,_Y,_Z);
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_Teleport_GenericSmoke_01",_X1,_Y1,_Z1);
SetOnStage(ITEMGUID_S_CoS_Temples_Elf_LadderRoll_db78369d-21ae-4e18-8cd3-3df398381d91,0);
SetOnStage(ITEMGUID_S_CoS_Temples_Elf_Ladder_0a4f0a64-619f-889b-2c5f-f31673b59d79,1);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_CoS_Temples_Autosave_ElfTempleShriekers_05c77567-01b6-4a56-b2ff-d82765558e85)
AND
GlobalGetFlag("CoS_Temples_Elf_FirstGheistsPurged",0)
AND
QueryOnlyOnce("CoS_Temples_VB_Shriekers_Once")
THEN
ProcObjectTimer(_Player,"CoS_Temples_VB_Shriekers_Timer",1700);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"CoS_Temples_VB_Shriekers_Timer")
THEN
StartVoiceBark("CoS_Temples_VB_Shriekers",_Player);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_CoS_Temples_Autosave_ElfTempleShriekers_05c77567-01b6-4a56-b2ff-d82765558e85)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_Temples_Shriekers",0)
THEN
PartySetFlag(_Player,"QuestUpdate_CoS_Temples_Shriekers");

//Soap to Captain
IF
ObjectFlagSet("CoS_ToldForktongueBath",(CHARACTERGUID)_Player,_)
AND
QryRemoveItemTemplateFromMagicPockets(_Player,"FUR_WashSoap_A_eda48b44-7f26-4922-84bf-85725ef067c1",1)
THEN
ItemTemplateAddTo("FUR_WashSoap_A_eda48b44-7f26-4922-84bf-85725ef067c1",CHARACTERGUID_S_CoS_Temples_Elf_BlackRing_002_4078d759-ed9d-4971-9f68-415cb9a71704,1);


//REGION BR hiding hostility logic

IF
TextEventSet("toshriekers")
THEN
GlobalSetFlag("CoS_Temples_Elf_BlackRingLeave");


IF
StoryEvent(_BR,"GLO_HitByShrieker")
AND
GetFaction(_BR,_Faction)
AND
_Faction == "CoS_BlackRing_ElfTemple"
AND
GlobalGetFlag("CoS_Temples_Elf_BlackRingLeave",1)
THEN
CharacterSetRelationFactionToFaction("CoS_BlackRing_ElfTemple","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_BlackRing_ElfTemple",0);


//END_REGION

//REGION Lizard Priest

IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Temples_Elf_LizardPriest_StartDialog")
THEN
Proc_StartDialog(0,"CoS_Temples_Elf_LizardPriest",CHARACTERGUID_S_CoS_Temples_Elf_LizardPriest_0afc01e3-8760-4c4e-906d-72e84e5d329f,_Player);

//Bless
IF
DialogStarted("CoS_Temples_Elf_LizardPriest",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
CharacterHasSkill(_Player,"Target_Bless",1)
THEN
ObjectSetFlag(_Player,"CoS_Temples_Elf_LizardPriest_PlayerHasBless");

IF
ObjectFlagSet("CoS_Temples_Elf_LizardPriest_BlessLizard",(CHARACTERGUID)_Player,_) //dont 
THEN
CharacterUseSkill(_Player,"Target_Bless",CHARACTERGUID_S_CoS_Temples_Elf_LizardPriest_0afc01e3-8760-4c4e-906d-72e84e5d329f,0);

//Reset flags
IF
DialogEnded("CoS_Temples_Elf_LizardPriest",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
ObjectClearFlag(_Player,"CoS_Temples_Elf_LizardPriest_PlayerHasBless");

IF
ObjectFlagSet("CoS_AddCoinPurse",(CHARACTERGUID)_Player,_)
THEN
ItemTemplateAddTo("QUEST_CoS_LOOT_CoinPurse_A_95b5dc3b-72b0-4fca-a89f-8156f7c69e7c",_Player,1);
ObjectClearFlag(_Player,"CoS_AddCoinPurse",0);

IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_CoS_SUB_Temples_Lizard_0a009ed0-61f5-4670-9d26-1417ebf02922)
AND
ObjectGetFlag(_Player,"CoS_EnteredTheLizardTemple",0)
THEN
ObjectSetFlag(_Player,"CoS_EnteredTheLizardTemple");


IF
ObjectFlagSet("CoS_LizardPriestPrayedToPlayer",(CHARACTERGUID)_Player,_)
THEN
PartyAddExperience(_Player,1,16,2);


//END_REGION

PROC
ProcRegionEnded("CoS_Main")
THEN
GoalCompleted;


EXITSECTION
Proc_GLO_Shriekers_RemoveIgnoreCharacterFlags();
ENDEXITSECTION
ParentTargetEdge "CoS_Temples"
