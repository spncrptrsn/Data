Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Initiation Trigger
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DU_RiverInitationTrigger_fc2735f8-78e6-40a5-80a2-1e447de3271c,CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e);
KBSECTION
//REGION Debug: disable River spotting for dialog when leaving the initial trigger
// Happens in case you teleport your party before game start elsewhere
IF
CharacterLeftTrigger(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,TRIGGERGUID_S_RC_DU_RiverInitationTrigger_fc2735f8-78e6-40a5-80a2-1e447de3271c)
AND
QRY_AnyRegionActive()
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_RC_DU_RiverInitationTrigger_fc2735f8-78e6-40a5-80a2-1e447de3271c,CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e);
GlobalClearFlag("RC_DU_VL_EnableSpottingLogicRiver");
GlobalSetFlag("RC_DU_VL_StopSpottingLogicRiver");
//END_REGION

//REGION Start River Dialogue
IF
StoryEvent(_player,"RC_DU_VL_StartRiverDialogue")
AND
ObjectGetFlag(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_DU_VL_TalkedToRiver",0) //If the player did not attack her or talked to her
THEN
Proc_RC_DU_VL_StartRiverDialogue((CHARACTERGUID)_player);

PROC
Proc_RC_DU_VL_StartRiverDialogue((CHARACTERGUID)_player)
AND
NOT QRY_RC_LV_Act2Intro_TryLohse()
AND
NOT QRY_RC_LV_Act2Intro_TryAnyAvatar()
THEN
DialogRequestStop(_player); //Make sure the spotted player is not in dialogue currently
ObjectSetFlag(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_DU_VL_TalkedToRiver");
ProcFaceEachother((CHARACTERGUID)_player, CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e);
Proc_StartDialog(0,"RC_DU_VL_River",CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,_player);

QRY
QRY_RC_LV_Act2Intro_TryLohse()
AND
DB_Avatars(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
AND
QRY_SpeakerIsAvailableAndInDialogRange(CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295, CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e)
AND
QRY_StartDialog(0, "RC_DU_VL_River", CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e, CHARACTERGUID_S_Player_Lohse_bb932b13-8ebf-4ab4-aac0-83e6924e4295)
THEN
ObjectSetFlag(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_DU_VL_TalkedToRiver");

QRY
QRY_RC_LV_Act2Intro_TryAnyAvatar()
AND
DB_Avatars(_Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTERGUID)_Avatar, CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e)
AND
QRY_StartDialog(0, "RC_DU_VL_River", CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e, _Avatar)
THEN
ObjectSetFlag(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_DU_VL_TalkedToRiver");
//END_REGION


//REGION River goes to Blood Island
IF
DialogEnded("RC_DU_VL_River",_inst)
AND
DB_DialogPlayers(_inst,_player,1)
THEN
PROC_GLO_River_AbortTeleportedAway(); //If river was attacked reset it
SetHasDialog(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,0);
DB_BlockRiverAttackReaction(1);
CharacterMoveTo(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,TRIGGERGUID_RC_LV_Entrance_5d830273-0215-4be4-96ce-8a1122f01bb0,0,"RC_LV_VL_RiverGoToBloodIsland",0);

IF
StoryEvent(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_LV_VL_RiverGoToBloodIsland")
THEN
TeleportTo(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,TRIGGERGUID_RC_LV_Exit_07c3b04e-f9d4-469d-b498-d9dab649084a,"RC_LV_VL_RiverGoToBloodIsland_OnCoast",0);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e);
//DB_Dialogs(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_LV_RiverOnBoat");
SetVarFixedString(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"currentState","");
NOT DB_BlockRiverAttackReaction(1);

IF
StoryEvent(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_LV_VL_RiverGoToBloodIsland_OnCoast")
THEN
// The Blood Island code will set her on stage once she is near
CharacterDisappearOutOfSight(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,0,0,"RC_LV_VL_RiverAtBloodIsland",0);

//END_REGION

//On Lady Vengeance: Check if river tp back to LV, QUaryOnlyOnce and set her if true (Check with Mathieu)
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
