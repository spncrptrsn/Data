Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/disappearance_of_arhu

DB_Dialogs(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,"ARX_Cathedral_DisapArhu_Paladin_000");
DB_Dialogs(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d,"ARX_Cathedral_DisapArhu_Paladin_001");
DB_Dialogs(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"ARX_Cathedral_DisapArhu_Paladin_002");
DB_Dialogs(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Priest_b604b9f7-6d7f-4aa8-9f14-1305f0d74fde,"ARX_Cathedral_DisapArhu_Priest");

//REGION Paladin behaviour and crimes
DB_TrespassTrigger((TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_TrespassPoly_35235753-3891-4aa7-9446-0f77f5d542d2,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_OutPoint_acbbd023-9c2b-4131-9658-3396c4598f4f,"ARX_Cathedral_DisapArhu_Trespass");

DB_ARX_Cathedral_DisapArhu_PaladinGuards((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Point_000_e7ac2737-80fa-4c2d-be1b-b2630e940ca7,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Investigation_Point_000_f5513a1d-66e9-4b33-8892-0b7932e116b4);
DB_ARX_Cathedral_DisapArhu_PaladinGuards((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Point_001_fb05b515-d77b-4fb7-b4ee-e801369eccb2,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Investigation_Point_001_3472d046-f054-4f41-8796-8351699e8895);
DB_ARX_Cathedral_DisapArhu_PaladinGuards((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Point_002_ebc355b0-1a8f-4ec1-9f29-01c4172b15b8,(TRIGGERGUID)TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Investigation_Point_002_96493337-8d9a-4364-af50-904c772227e3);
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_Point_01_d13d49be-5e67-46e0-b02d-5c98b12346ef);
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_Point_02_40f28947-e875-4c47-aad8-52520a32d5bc);
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_Point_03_d67bcc34-eee1-4664-b2dd-43c1e9a0b3aa);

DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,SPLINEGUID_S_ARX_Cathedral_DisapArhu_Paladin_InvestigatingSpline_00_1e3cfc32-4d4d-49e0-a9a2-714b49814689);
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d,SPLINEGUID_S_ARX_Cathedral_DisapArhu_Paladin_InvestigatingSpline_01_adb4c3d4-2365-42fb-a687-6f3a64e0c8bc);
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines((CHARACTERGUID)CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,SPLINEGUID_S_ARX_Cathedral_DisapArhu_Paladin_InvestigatingSpline_02_0a4f3a3d-484d-40c5-bcb1-330431b2fa80);

DB_CrimeWarningIsAD("ARX_AD_Cathedral_DisapArhu_PriestTrespassNotice");
//Proc_ARX_Cathedral_DisapArhu_SetUpCrimes();
//END_REGION
//REGION Key
DB_HasStoryEvent(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_000_b6549eb1-854c-46e5-a8a6-83a600bc7ae6,"ARX_Cathedral_DisapArhu_HasKey");
DB_HasStoryEvent(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_003_6906b26d-3a29-49ac-aa9e-1861a1419a39,"ARX_Cathedral_DisapArhu_HasKey");
DB_GiveItemToEvent(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_000_b6549eb1-854c-46e5-a8a6-83a600bc7ae6,"ARX_Cathedral_DisapArhu_ReceivedKey");
ItemToInventory(ITEMGUID_S_ARX_Cathedral_DisapArhu_Journal_794e8f40-6aa5-411f-b4f2-2cbede844908,ITEMGUID_S_ARX_Cathedral_DisapArhu_BedroomChest_c27736c6-8c89-4b0e-a89b-d9b8511d4720); // Moved the Arhu's journal to his chest
//END_REGION
KBSECTION
//REGION Init & debug

//--- Bring Arhu to his apartment 
//--- Bring Arhu to his penthouse
//--- Bring Arhu to his condo
IF
TextEventSet("FreeArhu")
THEN
Proc_ARX_KemmVault_ArhusPrison_PostKemm();

IF
TextEventSet("FreeArhu")
THEN
Proc_ARX_KemmVault_ArhusPrison_PostKemm();
GlobalSetFlag("ARX_KemmVault_Arhu_Freed_OnceCongrats");
GlobalClearFlag("ARX_KemmVault_Arhu_Fainted");
NOT DB_Queue("ARX_KemmVault_ArhusPrison_Dialog");
GlobalSetFlag("ARX_KemmVault_ArhusPrison_PrisonBroken");
RemoveStatus(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"GROUNDED");
ClearTag(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"CHICKENTOUCH_IMMUNE");
PROC_StopLoopEffect(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"RS3_FX_GP_ScriptedEvent_Arhu_Binding_01");
NOT DB_DoNotFace(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
PROC_StopLoopBeamEffect(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_01_e9fcdbbc-d4c1-41cd-a3f4-fa79104e9f3c,"ARX_KemmVault_ArhusPrison_Source_01");
PROC_StopLoopBeamEffect(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_02_4cd4055b-bf94-43c4-93b5-c0c2fac5e767,"ARX_KemmVault_ArhusPrison_Source_02");
PROC_StopLoopBeamEffect(CHARACTERGUID_S_ARX_KemmVault_ArhusPrison_Source_03_3f2200a1-88b2-4311-97c0-23ba089d4cfe,"ARX_KemmVault_ArhusPrison_Source_03");

IF
TextEventSet("FreeArhu")
THEN
GlobalClearFlag("ARX_KemmVault_Arhu_ToTheCathedral");
CharacterDisappearOutOfSightToObject(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,ITEMGUID_S_ARX_KemmVault_FinalFloor_Ext_305e609e-b8c5-4631-a956-c245e7cfdbfe,0,"ARX_KemmVault_Arhu_Disappeared",0);

//END_REGION


//REGION Journal updates / flags

//--- FindArhuInCathedral
IF
ObjectFlagSet("QuestUpdate_ARX_HuntingForDallis_ArhuIsCathedralKeeper",(CHARACTERGUID)_Player,_)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuIsMissing",0)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_DefeatedReimond",1)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_FindArhuInCathedral");

IF
ObjectFlagSet("QuestUpdate_ARX_HuntingForDallis_DefeatedReimond",(CHARACTERGUID)_Player,_)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuIsMissing",0)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_ArhuIsCathedralKeeper",1)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_FindArhuInCathedral");


IF
ObjectFlagSet("QuestUpdate_ARX_CreepyCraftsman_GoGetArhu",(CHARACTERGUID)_Player,_)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuIsMissing",0)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_FindArhuInCathedral");


//--- ArhuIsMissing
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
DB_IsPlayer(_Player)
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_InCathedral")
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuIsMissing");
UserSetFlag(_Player,"QuestUpdate_CORE_Chapter6_ARX_ArhuMissing");


//----- Kemm's Invite
IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Cathedral_DisappearanceOfArhu_KemmRequest_3bf778f9-1e30-4bc1-83d5-0babbf46f2b9,_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_KemmRequest");


//--- Map marker
IF
ObjectFlagSet("ARX_KemmMansion_SetMapMarker",(CHARACTERGUID)_Player,_)
THEN
ProcShowMarker(_Player,"ARX_KemmMansion");


IF
ObjectFlagSet("ARX_Cathedral_DisapArhu_ReceivedKey",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"ARX_Cathedral_DisapArhu_GotKeyFromPriest");


//--- Kid cat
IF
DialogStarted("ARX_KemmsKid_1",_Inst)
AND
DB_DialogPlayers(_Inst,_Char,_)
AND
UserGetFlag((CHARACTERGUID)_Char,"QuestUpdate_ARX_DisappearanceOfArhu_KidSawCat",0)
THEN
UserSetFlag(_Char,"QuestUpdate_ARX_DisappearanceOfArhu_KidSawCat");


//--- Arhu is a cat
// Catpole
IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Cathedral_PetToy_ScratchPole_a9ba9f06-ab80-4889-8657-1f25a1109580)
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_Arhu_CatHint");
Proc_StartDialog(1,"ARX_AD_Cathedral_DisapArhu_CatStuff",_Player);


// Fur
IF
ItemTemplateAddedToCharacter(UNIQUE_ARX_ArhuHair_5466f0fc-f27d-4c32-92c0-b3798003a301,_,_Player)
AND
DB_IsPlayer(_Player)
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_InCathedral")
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_IsDead")
THEN
Proc_ARX_Cathedral_DisapArhu_PickedUpFur(_Player);


PROC
Proc_ARX_Cathedral_DisapArhu_PickedUpFur((CHARACTERGUID)_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
THEN
UserSetFlag(_Player,"ARX_Arhu_CatHint");

PROC
Proc_ARX_Cathedral_DisapArhu_PickedUpFur((CHARACTERGUID)_Player)
AND
NOT DB_InRegion(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
PartyGetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuIsMissing",1)
AND
UserGetFlag(_Player,"ARX_KemmVault_SawArhu",0)
AND
QueryOnlyOnce("ARX_ArhuFur_VB_PickedUp")
THEN
StartVoiceBark("ARX_ArhuFur_VB_PickedUp",_Player);

//END_REGION


//REGION Crime stuff

//--- Removing ownership when the paladins are convinced to let the player investigate the room
/*
IF
ObjectFlagSet("ARX_Cathedral_DisapArhu_Paladin_001_SucceededPersuasion",(CHARACTERGUID)_Player,_Inst)
AND
DB_DialogName("ARX_Cathedral_DisapArhu_PaladinArrest",_Inst)
THEN
TriggerClearItemOwner(TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604);*/

IF
ObjectFlagSet("ARX_Cathedral_DisapArhu_Paladin_001_SucceededPersuasion",(CHARACTERGUID)_Player,_)
THEN
ItemClearOwner(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);
ItemClearOwner(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b);
Proc_ARX_Cathedral_DisapArhu_DisableTrespassingForPlayer(_Player);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_AppearAt_ArhusRoom")
AND
DB_IsPlayer(_Player)
THEN
Proc_ARX_Cathedral_DisapArhu_DisableTrespassingForPlayer(_Player);

PROC
Proc_ARX_Cathedral_DisapArhu_DisableTrespassingForPlayer((CHARACTERGUID)_Player)
THEN
ProcCharacterDisableCrime(_Player,"ARX_Cathedral_DisapArhu_Trespass");
CharacterStopCrime(_Player,"ARX_Cathedral_DisapArhu_Trespass",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_TrespassPoly_35235753-3891-4aa7-9446-0f77f5d542d2);
NOT DB_PlayerTrespassing(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_TrespassPoly_35235753-3891-4aa7-9446-0f77f5d542d2);



//--- Stopping all crimes in Arhu's room (used when Kemm arrives to prevent the scene from being ruined by investigation behaviours)
IF
CrimeIsRegistered(_Victim,_,_CrimeID,_,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
DB_InRegion(_Criminal1,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
NOT DB_GlobalFlag("ARX_Cathedral_DisapArhu_KemmAppeared")
THEN
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);

IF
OnCrimeResolved(_CrimeID,_Victim,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
THEN
NOT DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);

IF
OnCrimeRemoved(_CrimeID,_Victim,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
THEN
NOT DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);

IF
OnCrimeMergedWith(_CrimeID,_NewCrimeID)
AND
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
THEN
NOT DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_NewCrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);

PROC
Proc_ARX_Kemm_MoveToNextLocation("ArhusRoom")
THEN
Proc_ARX_Cathedral_DisapArhu_CancelInterrogation();

PROC
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes()
THEN
DB_Crime_DoNotStopDialog("ARX_Kemm");

PROC
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes()
THEN
Proc_ARX_Cathedral_DisapArhu_CancelInterrogation();

PROC
Proc_ARX_Cathedral_DisapArhu_CancelInterrogation()
AND
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_ID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
DB_InterrogationRequested(_RegionID,_ID,_Arrester,_Criminal,_Criminal2,_Criminal3,_Criminal4,_Dialog)
THEN
PROC_CancelInterrogation(_Arrester,_ID,1,_Criminal,_Criminal2,_Criminal3,_Criminal4);


PROC
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes()
AND
DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
THEN
NOT DB_ARX_Cathedral_DisapArhu_ActiveCrime(_Victim,_CrimeID,_Criminal1,_Criminal2,_Criminal3,_Criminal4);
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes_Part2(_Criminal1,_CrimeID);
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes_Part2(_Criminal2,_CrimeID);
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes_Part2(_Criminal3,_CrimeID);
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes_Part2(_Criminal4,_CrimeID);

PROC
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes_Part2((CHARACTERGUID)_Criminal,(INTEGER)_CrimeID)
AND
NOT QRY_CharacterIsNull(_Criminal)
THEN
CharacterStopCrimeWithID(_Criminal,_CrimeID);

IF
DialogEnded("ARX_Kemm",_)
AND
DB_Crime_DoNotStopDialog("ARX_Kemm")
THEN
NOT DB_Crime_DoNotStopDialog("ARX_Kemm");


//--- preventing the player from going to prison if Kemm arrives during the trespassing arrest dialog
PROC
Proc_ARX_Kemm_MoveToNextLocation("ArhusRoom")
THEN
GlobalSetFlag("ARX_Cathedral_DisapArhu_KemmMoving");

IF
ObjectFlagSet("Start_Arrest_AfterDialog",(CHARACTERGUID)_Character,_ID)
AND
DB_DialogName("ARX_Cathedral_DisapArhu_PaladinArrest",_ID)
AND
Qry_ARX_Cathedral_DisapArhu_KemmInArhusRoom()
THEN
ObjectClearFlag(_Character,"Start_Arrest_AfterDialog",0);
NOT DB_ArrestAfterDialog(_Character,_ID);
Proc_ARX_Cathedral_DisapArhu_ReactToKemm();


/* I guess if the player chose the hostile option in the arrest dialog, it's their problem.
IF
ObjectFlagSet("TemporaryHostilityAfterDialog",(CHARACTERGUID)_Player,_ID)
AND
DB_DialogName("ARX_Cathedral_DisapArhu_PaladinArrest",_ID)
AND
Qry_ARX_Cathedral_DisapArhu_KemmInArhusRoom()
THEN
NOT DB_TemporaryHostilityAfterDialog(_Player,_ID);
Proc_ARX_Cathedral_DisapArhu_ReactToKemm();
*/

/*
PROC
Proc_ARX_Cathedral_DisapArhu_SetUpCrimes()
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
THEN
DB_CrimeReaction_CustomWarning(_Paladin,"Trespassing","ARX_Cathedral_DisapArhu_PaladinArrest");
ProcCrimeSetCustomPrimarySensibleAction(_Paladin,"Trespassing","");
*/

PROC
ProcCrimeTrespassingBlockHostileFallback((INTEGER)_CrimeID,(CHARACTERGUID)_NPC)
AND
IsTagged(_NPC,"ARX_PRIEST",1)
THEN
DB_CrimeTrespassingBlockHostile(_CrimeID,_NPC);

IF
DialogStarted("ARX_Cathedral_DisapArhu_PaladinArrest",_Inst)
AND
NOT DB_ARX_Cathedral_DisapArhu_PaladinSawApartment((CHARACTERGUID)_)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
THEN
Proc_ARX_Cathedral_DisapArhu_PaladinSeeApartment(_Paladin);

//END_REGION


//REGION Paladin react to Kemm coming to the apartment

QRY
Qry_ARX_Cathedral_DisapArhu_KemmInArhusRoom()
AND
DB_GlobalFlag("ARX_Cathedral_DisapArhu_KemmMoving")
THEN
DB_NOOP(1);

QRY
Qry_ARX_Cathedral_DisapArhu_KemmInArhusRoom()
AND
DB_GlobalFlag("ARX_Cathedral_DisapArhu_KemmAppeared")
THEN
DB_NOOP(1);

IF
GlobalFlagSet("ARX_Cathedral_DisapArhu_KemmAppeared")
THEN
GlobalClearFlag("ARX_Cathedral_DisapArhu_KemmMoving");

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Cathedral_DisapArhu_PaladinAppeared")
THEN
Proc_ARX_Cathedral_DisapArhu_ReactToKemm();


PROC
Proc_ARX_Cathedral_DisapArhu_ReactToKemm()
AND
NOT DB_OnlyOnce("ARX_Cathedral_DisapArhu_ReactToKemm")
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
AND
NOT DB_Dead(_Paladin)
THEN
DB_OnlyOnce("ARX_Cathedral_DisapArhu_ReactToKemm");
Proc_ARX_Cathedral_DisapArhu_ReactToKemm_Part2(_Paladin);


PROC
Proc_ARX_Cathedral_DisapArhu_ReactToKemm_Part2((CHARACTERGUID)_Paladin)
AND
DB_DialogNPCs(_,_Paladin,_)
THEN
ProcForceStopDialog(_Paladin);


PROC
Proc_ARX_Cathedral_DisapArhu_ReactToKemm_Part2((CHARACTERGUID)_Paladin)
AND
ObjectIsOnStage(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
THEN
CharacterLookAt(_Paladin,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

PROC
Proc_ARX_Cathedral_DisapArhu_ReactToKemm_Part2((CHARACTERGUID)_Paladin)
THEN
PlayAnimation(_Paladin,"Salute_01");

PROC
Proc_ARX_Cathedral_DisapArhu_ReactToKemm_Part2(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d)
THEN
Proc_StartDialog(1,"ARX_Cathedral_DisapArhu_AD_PaladinsSaluteKemm",CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d);


//END_REGION


//REGION Paladins see apartment

PROC
Proc_ARX_Cathedral_DisapArhu_PaladinSeeApartment((CHARACTERGUID)_Paladin)
AND
NOT DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin)
AND
Qry_ARX_Cathedral_DisapArhu_DoorIsOpened() // Door is opened
THEN
DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin);
ObjectSetFlag(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartment");
ProcObjectTimer(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartAD",600);


PROC
ProcObjectTimerFinished(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d,"ARX_Cathedral_DisapArhu_PaladinSawApartAD")
THEN
Proc_StartDialog(1,"ARX_AD_Cathedral_DisapArhu_PaladinSawTrashedApart",CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_001_59cd4273-7285-4992-a2ce-54299c92333d);

PROC
ProcObjectTimerFinished(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartAD")
THEN
CharacterLookAt((CHARACTERGUID)_Paladin,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_Point_d13d49be-5e67-46e0-b02d-5c98b12346ef);
Proc_ARX_Cathedral_DisapArhu_InitiateMoveToCrimeScene();


// Triggers
IF
StoryEvent(_,"ARX_Cathedral_DisapArhu_MovedToDoor")
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_PaladinSawApartmentAfterMoving")
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
THEN
Proc_ARX_Cathedral_DisapArhu_PaladinSeeApartment(_Paladin);

IF
ItemOpened(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
AND
NOT DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin)
THEN
Proc_ARX_Cathedral_DisapArhu_PaladinSeeApartment(_Paladin);

IF
ItemDestroying(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8) // to long to wait after the destroying, feels like a bug
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
AND
NOT DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin)
THEN
DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin);
ObjectSetFlag(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartment");
ProcObjectTimer(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartAD",600);

QRY
Qry_ARX_Cathedral_DisapArhu_DoorIsOpened()
AND
ItemIsOpened(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8,1)
THEN
DB_NOOP(1);

QRY
Qry_ARX_Cathedral_DisapArhu_DoorIsOpened()
AND
DB_DestroyedItems(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8)
THEN
DB_NOOP(1);


//END_REGION


//REGION (Player) Entering/searching apartment


IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
DB_IsPlayer(_Player)
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_InCathedral")
AND
UserGetFlag(_Player,"ARX_Cathedral_DisapArhu_SawTrashedApart",0)
THEN
UserSetFlag(_Player,"ARX_Cathedral_DisapArhu_SawTrashedApart");
Proc_StartDialog(1,"ARX_AD_Cathedral_DisapArhu_SawTrashedApart",_Player);


//END_REGION


//REGION Moving Paladins to the door (Arhu is dead/came back)

PROC
Proc_ARX_Cathedral_DisapArhu_InitiateMovePaladinsToDoor((INTEGER)_Delay)
AND
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines(_Paladin,_) // This handles both cases when Investigation stops and when they move into the room and only Ranger 02 is patroling
THEN
SetStoryEvent(_Paladin,"StopPatrol");
SetStoryEvent(_Paladin,"InterruptPatrol");
DB_ARX_Cathedral_DisapArhu_PaladinGoingToMove(_Paladin);
ProcObjectTimer(_Paladin,"ARX_Cathedral_DisapArhu_MoveToDoor",_Delay);


//--- moving
PROC
ProcObjectTimerFinished(_Paladin,"ARX_Cathedral_DisapArhu_MoveToDoor")
THEN
NOT DB_ARX_Cathedral_DisapArhu_PaladinGoingToMove((CHARACTERGUID)_Paladin);

PROC
ProcObjectTimerFinished(_Paladin,"ARX_Cathedral_DisapArhu_MoveToDoor")
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards((CHARACTERGUID)_Paladin,_Point,_)
THEN
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor(_Paladin,_Point);

PROC
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor((CHARACTERGUID)_Paladin,(TRIGGERGUID)_Point)
AND
IsSpeakerReserved(_Paladin,0)
AND
NOT DB_CombatCharacters(_Paladin,_)
AND
NOT DB_Dead(_Paladin)
THEN
ProcCharacterMoveTo(_Paladin,_Point,0,"ARX_Cathedral_DisapArhu_MovedToDoor");


//--- Wait after dialog
PROC
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor((CHARACTERGUID)_Paladin,(TRIGGERGUID)_Point)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_Point,_)
AND
IsSpeakerReserved(_Paladin,1)
AND
DB_DialogNPCs(_Inst,_Paladin,_)
THEN
DB_ARX_Cathedral_DisapArhu_MoveToAfterDialog((CHARACTERGUID)_Paladin,_Inst,_Point);

IF
DialogEnded(_,_Inst)
AND
DB_ARX_Cathedral_DisapArhu_MoveToAfterDialog(_Paladin,_Inst,_Point)
THEN
NOT DB_ARX_Cathedral_DisapArhu_MoveToAfterDialog(_Paladin,_Inst,_Point);
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor(_Paladin,_Point);


//--- Wait after combat
PROC
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor((CHARACTERGUID)_Paladin,(TRIGGERGUID)_Point)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_Point,_)
AND
DB_CombatCharacters(_Paladin,_Id)
THEN
DB_ARX_Cathedral_DisapArhu_MoveToAfterCombat((CHARACTERGUID)_Paladin,_Id,_Point);

IF
CombatEnded(_Id)
AND
DB_ARX_Cathedral_DisapArhu_MoveToAfterCombat(_Paladin,_Id,_Point)
THEN
NOT DB_ARX_Cathedral_DisapArhu_MoveToAfterCombat(_Paladin,_Id,_Point);
Proc_ARX_Cathedral_DisapArhu_MovePaladinsToDoor(_Paladin,_Point);


//--- New original pos before the door
IF
StoryEvent((CHARACTERGUID)_Paladin,"ARX_Cathedral_DisapArhu_MovedToDoor")
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_Point,_)
AND
GetPosition(_Point,_X,_Y,_Z)
THEN
SetVarFloat3(_Paladin,"NPCOrgPos",_X,_Y,_Z);
SetVarFloat3(_Paladin,"DefaultPoint",_X,_Y,_Z);
SetVarObject(_Paladin,"lookAtTrig",S_ARX_Cathedral_Scribe_Ownership_Box_000_2d368ad5-0bac-4e00-80f2-fecd6370b48f);

//END_REGION


//REGION Moving Paladins to crime scene

//--- Edge-case: player attacks the door from the inside
IF
DB_Crime_Vandalise(_Vandal,ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8,_)
AND
DB_InRegion(_Vandal,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
NOT Qry_ARX_Cathedral_DisapArhu_DoorIsOpened()
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_OpenDoorBecauseOfCrime")
THEN
TimerLaunch("ARX_Cathedral_DisapArhu_OpenDoorBecauseOfCrime_Delay",1200);

IF
TimerFinished("ARX_Cathedral_DisapArhu_OpenDoorBecauseOfCrime_Delay")
THEN
Proc_ARX_Cathedral_DisapArhu_InitiateMoveToCrimeScene();


//--- Paladins moved to the door already
PROC
Proc_ARX_Cathedral_DisapArhu_InitiateMoveToCrimeScene()
AND
NOT DB_GlobalFlag("ARX_KemmVault_Arhu_InCathedral")
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_MovePaladinsInApart")
THEN
Proc_ARX_Cathedral_DisapArhu_SetSawApartment();
Proc_ARX_Cathedral_DisapArhu_PrepMoveToCrimeScene();
GlobalSetFlag("ARX_Cathedral_DisapArhu_PaladinInvestigates");

PROC
Proc_ARX_Cathedral_DisapArhu_SetSawApartment()
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
THEN
DB_ARX_Cathedral_DisapArhu_PaladinSawApartment(_Paladin);
ObjectSetFlag(_Paladin,"ARX_Cathedral_DisapArhu_PaladinSawApartment");

PROC
Proc_ARX_Cathedral_DisapArhu_PrepMoveToCrimeScene()
AND
NOT DB_DestroyedItems(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8)
AND
ItemIsOpened(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8,0)
THEN
ItemUnlockAndOpen(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);


IF
GlobalFlagSet("ARX_Cathedral_DisapArhu_PaladinInvestigates")
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_)
AND
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates(_Paladin,_Trigger)
THEN
ProcCharacterMoveTo(_Paladin,_Trigger,1,"ARX_Cathedral_DisapArhu_MovedToScene");


//--- Behaviour adjustments
IF
StoryEvent((CHARACTERGUID)_Paladin,"ARX_Cathedral_DisapArhu_MovedToScene")
AND
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines(_Paladin,_Spline)
THEN
SetVarObject(_Paladin,"SplineGUID",_Spline);
SetStoryEvent(_Paladin,"InterruptPatrol");
SetStoryEvent(_Paladin,"InitiateSplinePatrol"); 
ClearVarObject(_Paladin,"previousPos"); 
CharacterSetReactionPriority(_Paladin,"Patrol",5);

IF
StoryEvent(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"ARX_Cathedral_DisapArhu_MovedToScene")
THEN
SetVarString(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"splineAD","ARX_AD_Cathedral_DisapArhu_PaladinsSearchApart");
SetVarFixedString(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"NodeAnimation1","Look_Down_Long_01");
SetVarFixedString(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"NodeAnimation2","Look_Down_Short_01");
SetVarFixedString(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Ranger_002_c0f68387-ccc7-48cd-b175-c41b00f1cf81,"NodeAnimation","PickCoin_01");
//SetVarFixedString(_Paladin,"currentState","State_Default"); //Set a behaviour script state with investigation-like behaviour


IF
StoryEvent((CHARACTERGUID)_Paladin,"ARX_Cathedral_DisapArhu_MovedToScene")
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_,_Point)
AND
GetPosition(_Point,_X,_Y,_Z)
THEN
SetVarFloat3(_Paladin,"NPCOrgPos",_X,_Y,_Z);
SetVarFloat3(_Paladin,"DefaultPoint",_X,_Y,_Z);


IF
StoryEvent(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,"ARX_Cathedral_DisapArhu_MovedToScene")
THEN
CharacterSetReactionPriority(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,"StartDialogAgainDelay",0);
CharacterSetReactionPriority(CHARACTERGUID_S_ARX_Cathedral_DisapArhu_Paladin_Tank_000_1d842a02-9a45-4bad-ab7c-feeeb706a973,"TalkTo",0);

//END_REGION


//REGION Paladin dies

IF
CharacterDied(_Paladin)
AND
DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_Point,_InvestigationPoint)
THEN
NOT DB_ARX_Cathedral_DisapArhu_PaladinGuards(_Paladin,_Point,_InvestigationPoint);


//END_REGION


//REGION Arhu comes back

//--- Setting up the paladins
IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
NOT DB_GlobalFlag("ARX_Cathedral_DisapArhu_PaladinInvestigates")
THEN
Proc_ARX_Cathedral_DisapArhu_SetSawApartment();


IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
DB_GlobalFlag("ARX_Cathedral_DisapArhu_PaladinInvestigates")
THEN
Proc_ARX_Cathedral_DisapArhu_StopInvestigation();
GlobalClearFlag("ARX_Cathedral_DisapArhu_PaladinInvestigates");
Proc_ARX_Cathedral_DisapArhu_InitiateMovePaladinsToDoor(2000);

PROC
Proc_ARX_Cathedral_DisapArhu_StopInvestigation()
AND
DB_ARX_Cathedral_DisapArhu_PaladinInvestigates_Splines(_Paladin,_)
THEN
SetVarObject(_Paladin,"lookAtTrig",S_ARX_Cathedral_Scribe_Ownership_Box_000_2d368ad5-0bac-4e00-80f2-fecd6370b48f);



//--- Removing crime triggers
IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
THEN
ProcRemoveDBTrespassTrigger(TRIGGERGUID_S_ARX_Cathedral_DisapArhu_TrespassPoly_35235753-3891-4aa7-9446-0f77f5d542d2,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_OutPoint_acbbd023-9c2b-4131-9658-3396c4598f4f);
TriggerSetItemOwner(TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);


IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
NOT DB_DestroyedItems(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8)
THEN
ItemClearOwner(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);
ItemUnLock(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);

IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
NOT DB_DestroyedItems(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b)
THEN
ItemClearOwner(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b);
ItemUnLock(ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b);


//--- Setting up Arhu, the pilgrim and the dog

IF
StoryEvent(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ARX_Arhu_ArrivedInCathedral")
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
SetHasDialog(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1);
CharacterSetCanTrade(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,1);
ProcCharacterEnableAllCrimes(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b);
CharacterSetReactionPriority(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"inPrisonReaction",0);
SetVarString(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"currentState","State_Default");
SetVarInteger(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"ClearInternalStatePriority",1);
CharacterSetReactionPriority(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b,"State_Default",1000);



IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_Cathedral_Pilgrim_000_11441aa0-b063-427f-86b8-f606bf1a6ddd)
THEN
ClearVarObject(CHARACTERGUID_S_ARX_Cathedral_Pilgrim_000_11441aa0-b063-427f-86b8-f606bf1a6ddd,"CharMoveTo");
ClearVarObject(CHARACTERGUID_S_ARX_Cathedral_Pilgrim_000_11441aa0-b063-427f-86b8-f606bf1a6ddd,"CharMoveTo_AD");

IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND 
NOT DB_Dead(CHARACTERGUID_S_ARX_Cathedral_Dog_b9627fb3-f0ad-425c-a0dd-3ede0d222416)
THEN
SetVarInteger(CHARACTERGUID_S_ARX_Cathedral_Dog_b9627fb3-f0ad-425c-a0dd-3ede0d222416,"ReturnToDefaultPosition",0);


IF
CharacterSawCharacter(_Player, CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b)
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_KemmVault_Arhu_7befbac9-04f4-4861-81a9-8d2eeb21df5b)
AND
DB_IsPlayer(_Player)
AND
DB_GlobalFlag("ARX_KemmVault_Arhu_InCathedral")
THEN
UserSetFlag(_Player,"QuestUpdate_ARX_DisappearanceOfArhu_ArhuPrison_FreedArhu"); //for players who didn't free Arhu directly

//END_REGION


//REGION Telling the Paladins that Arhu died

IF
GlobalFlagSet("ARX_DisapArhu_ArhuDead_PaladinsKnow")
AND
DB_GlobalFlag("ARX_Cathedral_DisapArhu_PaladinInvestigates")
THEN
Proc_ARX_Cathedral_DisapArhu_StopInvestigation();


//END_REGION


//REGION Pet Busket 
PROC
ProcRegionStarted("ARX_Main")
AND
GetPosition(ITEMGUID_FUR_Humans_PetToy_SleepingBasket_001_0246c9a7-68df-4515-8093-8768af42d476,_X,_Y,_Z)
THEN
DB_ARX_UNIQUE_DaggerOfCruelty_ScatterPosition(_X,_Y,_Z);
SetOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,0);

IF
ItemMoved(ITEMGUID_FUR_Humans_PetToy_SleepingBasket_001_0246c9a7-68df-4515-8093-8768af42d476)
AND
ObjectIsOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,0)
THEN
Proc_Scatter_S_ARX_UNIQUE_DaggerOfCruelty();

IF
ItemDestroying(ITEMGUID_FUR_Humans_PetToy_SleepingBasket_001_0246c9a7-68df-4515-8093-8768af42d476)
AND
ObjectIsOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,0)
THEN
Proc_Scatter_S_ARX_UNIQUE_DaggerOfCruelty();

IF
ItemAddedToCharacter(ITEMGUID_FUR_Humans_PetToy_SleepingBasket_001_0246c9a7-68df-4515-8093-8768af42d476,_Player)
AND
ObjectIsOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,0)
THEN
Proc_Scatter_S_ARX_UNIQUE_DaggerOfCruelty();

IF
ItemAddedToContainer(ITEMGUID_FUR_Humans_PetToy_SleepingBasket_001_0246c9a7-68df-4515-8093-8768af42d476,_Player)
AND
ObjectIsOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,0)
THEN
Proc_Scatter_S_ARX_UNIQUE_DaggerOfCruelty();

PROC
Proc_Scatter_S_ARX_UNIQUE_DaggerOfCruelty()
AND
DB_ARX_UNIQUE_DaggerOfCruelty_ScatterPosition(_X,_Y,_Z)
THEN
SetOnStage(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,1);
ItemScatterAt(ITEMGUID_S_ARX_UNIQUE_DaggerOfCruelty_dd34e069-1f61-4f47-9efd-6b0775783044,_X,_Y,_Z);
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
