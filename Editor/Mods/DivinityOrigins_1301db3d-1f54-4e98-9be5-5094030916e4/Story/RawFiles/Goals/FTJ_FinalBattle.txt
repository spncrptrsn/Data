Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(ITEMGUID_S_FTJ_BoatToShip_001_63914b60-eea0-4d17-8081-898b58ef9cc0,0);
SetOnStage(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,0);

DB_FTJ_FinalBattle_Magister((CHARACTERGUID)CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9); 
DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187);
DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3);
DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5);
DB_FTJ_FinalBattle_CountVoidwoken(0);

SetOnStage(CHARACTERGUID_S_FTJ_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,0);


//REGION killCounter
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_Gheist_06082187-829f-43e1-b3bb-f3242a70904d,"FTJ_FinalBattle");
DB_KillCounter_Internal(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_FinalBattle");
DB_KillCounter("FTJ_FinalBattle",7);

DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9,"FTJ_FinalBattle_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187,"FTJ_FinalBattle_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3,"FTJ_FinalBattle_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5,"FTJ_FinalBattle_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_Gheist_06082187-829f-43e1-b3bb-f3242a70904d,"FTJ_FinalBattle_Fallback");
DB_KillCounter_Internal(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_FinalBattle_Fallback");
DB_KillCounter("FTJ_FinalBattle_Fallback",6);

DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_Gheist_06082187-829f-43e1-b3bb-f3242a70904d,"FTJ_FinalBattle");
DB_SceneManager(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_FinalBattle");
//END_REGION
DB_DeadEvent(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"GLO_AlexandarIsDead");
DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"GLO_SawAlexandarDead");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_SW_FinalFight_InfiltrationBox_a8d17d54-17ec-4d49-92c6-02eef947dea4);

//GlobalSetFlag("FTJ_FinalBattle_Alexander_StopSpotter");


DB_FTJ_FinalBattleMagisters(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9);
DB_FTJ_FinalBattleMagisters(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187);
DB_FTJ_FinalBattleMagisters(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3);
DB_FTJ_FinalBattleMagisters(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5);
DB_FTJ_FinalBattleMagisters(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_Gheist_06082187-829f-43e1-b3bb-f3242a70904d);

ProcTriggerRegisterForPlayers(TRIGGERGUID_AiHintTrig_FTJ_FinalBattle_Burrow_9a987d10-c149-4d86-ab30-02c6b1b46c26);
ProcCharacterDisableCrime(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e, "ActiveUndead");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_SW_CallToArms_Warriors_FallbackCombatStart_b1a38fb6-82e6-4c37-bbf3-9158c3855c63);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_SW_FinalBattle_FallbackSightCheck_6595bab1-fe51-4fa6-a8ea-7b83e83b658f);


KBSECTION
//https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/ftj_finalbattle
IF
CharacterDying(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
THEN
Proc_StartDialog(1,"FTJ_AD_AlexandarDeathScream",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_BOOK_AlexandarJournal_000_5c2a4a0e-28bc-4dd1-855b-0fa7f95bb741)
THEN
UserSetFlag(_Player,"FTJ_Hunted_AlexandarHunted");

IF
DB_FTJ_FinalBattle_Magister(_Char)
THEN
TriggerRegisterForCharacter(TRIGGERGUID_AiHintTrig_FTJ_FinalBattle_Burrow_9a987d10-c149-4d86-ab30-02c6b1b46c26,_Char);

IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_FinalBattle_NotAlexander_SpotCharacter")
AND
GlobalGetFlag("FTJ_FinalBattle_Alexander_Initiated",0)
AND
QueryOnlyOnce("FTJ_FinalBattle_Alexander_SpotCharacter")
THEN
Proc_FTJ_SW_FinalBattle_CanStartAlexandarDialogue(_Char);


IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_FinalBattle_Alexander_SpotCharacter")
AND
GlobalGetFlag("FTJ_FinalBattle_Alexander_Initiated",0)
AND
QueryOnlyOnce("FTJ_FinalBattle_Alexander_SpotCharacter")
THEN
Proc_FTJ_SW_FinalBattle_CanStartAlexandarDialogue(_Char);
/*
GlobalSetFlag("FTJ_FinalBattle_Alexander_StopSpotter");
GlobalSetFlag("FTJ_FinalBattle_Alexander_Initiated");
Proc_StartDialog(0,"FTJ_FinalBattle_Alexandar",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Char);
*/
PROC
Proc_FTJ_SW_FinalBattle_CanStartAlexandarDialogue((CHARACTERGUID)_Char)
AND
DB_IsPlayer(_Char)
AND
CharacterCanSee(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349, _Char, 1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
QRY_SpeakerIsAvailable(_Char)
AND
QueryOnlyOnce("FTJ_FinalBattle_Alexander_Initiated")
THEN
GlobalSetFlag("FTJ_FinalBattle_Alexander_StopSpotter");
GlobalSetFlag("FTJ_FinalBattle_Alexander_Initiated");
Proc_StartDialog(0,"FTJ_FinalBattle_Alexandar",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Char);
DebugText(_Char,"Proc_StartDialog");

PROC
Proc_FTJ_SW_FinalBattle_CanStartAlexandarDialogue((CHARACTERGUID)_Char)
AND
GlobalGetFlag("FTJ_FinalBattle_Alexander_Initiated",0)
AND
DB_IsPlayer(_OtherChar)
AND
CharacterCanSee(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349, _OtherChar, 1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
QRY_SpeakerIsAvailable(_OtherChar)
AND
QueryOnlyOnce("FTJ_FinalBattle_Alexander_Initiated")
THEN
GlobalSetFlag("FTJ_FinalBattle_Alexander_StopSpotter");
GlobalSetFlag("FTJ_FinalBattle_Alexander_Initiated");
Proc_StartDialog(0,"FTJ_FinalBattle_Alexandar",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_OtherChar);
DebugText(_OtherChar,"Proc_StartDialog");


PROC
Proc_FTJ_SW_FinalBattle_CanStartAlexandarDialogue((CHARACTERGUID)_Char)
AND
GlobalGetFlag("FTJ_FinalBattle_Alexander_Initiated",0)
THEN
Proc_FTJ_FinalBattle_InitiateFight();
DebugText(_Char,"Proc_FTJ_FinalBattle_InitiateFight");

IF
CharacterEnteredTrigger(_, TRIGGERGUID_S_FTJ_SW_CallToArms_Warriors_FallbackCombatStart_b1a38fb6-82e6-4c37-bbf3-9158c3855c63)
AND
NOT DB_OnlyOnce("FTJ_FinalBattle_Alexander_Initiated")
AND
NOT QRY_FTJ_SW_FinalBattle_CanStartAlexandarDialogue()
THEN
Proc_FTJ_FinalBattle_InitiateFight();

QRY
QRY_FTJ_SW_FinalBattle_CanStartAlexandarDialogue()
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349, _Player, 1)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
QRY_SpeakerIsAvailable(_Player)
AND
GlobalGetFlag("FTJ_FinalBattle_Alexander_Initiated",0)
AND
NOT DB_OnlyOnce("FTJ_FinalBattle_Alexander_Initiated")
AND
QRY_StartDialog(0,"FTJ_FinalBattle_Alexandar",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349, _Player)
THEN
GlobalSetFlag("FTJ_FinalBattle_Alexander_StopSpotter");
GlobalSetFlag("FTJ_FinalBattle_Alexander_Initiated");
DB_OnlyOnce("FTJ_FinalBattle_Alexander_Initiated");

PROC
Proc_DialogFlagSetup("FTJ_FinalBattle_Alexandar",CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Player)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"IFAN",1) //NOT polymorphed
AND
GetDistanceTo(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Dist)
AND
_Dist < 20.0
AND
CharacterCanSee(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,1)
THEN
ObjectSetFlag(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_SW_FinalBattle_IfanPresent");

IF
GlobalFlagSet("FTJ_FinalBattle_Alexander_InitiateSpotter")
THEN
SetCombatGroupID(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"");

IF
DialogEnded("FTJ_FinalBattle_Alexandar",_)
THEN
Proc_FTJ_FinalBattle_InitiateFight();

IF
AttackedByObject(_Char,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
GetFaction(_Char,"FTJ_FinalBattle")
THEN
Proc_FTJ_FinalBattle_InitiateFight();

IF
ObjectEnteredCombat(_Char,_Combat)
AND
DB_FTJ_FinalBattleMagisters(_Char)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_Combat)
THEN
Proc_FTJ_FinalBattle_InitiateFight();

PROC
Proc_FTJ_FinalBattle_InitiateFight()
AND
DB_FTJ_FinalBattleMagisters(_Char)
THEN
DialogRequestStop(_Char);

PROC
Proc_FTJ_FinalBattle_InitiateFight()
THEN
DialogRequestStop(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);

PROC
Proc_FTJ_FinalBattle_InitiateFight()
AND
DB_FTJ_FinalBattleMagisters(_Char)
THEN
SetFaction(_Char,"RC_Magister");

PROC
Proc_FTJ_FinalBattle_InitiateFight()
THEN
SetFaction(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"RC_Magister");
SetCombatGroupID(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"f07fa968-7e37-4420-9ee8-7fdeab725837");
CharacterSetRelationFactionToFaction("FTJ_SW_ShelterNPC","RC_Magister",0);
CharacterSetRelationFactionToFaction("RC_Magister","FTJ_SW_ShelterNPC",0);

PROC
Proc_FTJ_FinalBattle_InitiateFight()
THEN
TimerLaunch("FTJ_SW_FinalBattle_AtmosTimer_01",10000);

IF
TimerFinished("FTJ_SW_FinalBattle_AtmosTimer_01")
THEN
TriggerSetAtmosphere(TRIGGERGUID_S_AtmosphereTrigger_FTJ_FinalBattleBeach_d4987042-6d48-4c3d-8ac5-763d0c400902, "0d18531b-7435-4a55-b25c-3e065fea1faf");

//REGION final battles voidwoken
IF
ObjectTurnEnded(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_AlexandarPhase_1",1)
//GetFaction(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_FinalBattle")
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
THEN
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance();


IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
DB_FTJ_FinalBattle_Magister(_npc)
AND
DB_CombatCharacters(_npc,_id)
AND
CombatGetActiveEntity(_id,(CHARACTERGUID)_char)
AND
_Char != NULL_00000000-0000-0000-0000-000000000000
AND
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_)
THEN
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_char);

IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
DB_CombatCharacters(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_id)
AND
CombatGetActiveEntity(_id,NULL_00000000-0000-0000-0000-000000000000)
AND
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_)
THEN
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance_Queued();

IF
ObjectTurnEnded((CHARACTERGUID)_player)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_player)
THEN
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance_Queued();

PROC
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance_Queued()
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_player)
AND
DB_CombatCharacters(_player,_id)
AND
CombatGetActiveEntity(_id,_char)
AND
_char != NULL_00000000-0000-0000-0000-000000000000
THEN
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_player);
SetStoryEvent(_char,"onSetOnStage_SpawnAt"); 

PROC
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance_Queued()
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_player)
THEN
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Queue(_player);
SetStoryEvent(_player,"onSetOnStage_SpawnAt");

PROC
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance()
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_int)
AND
_int>=2
AND
DB_CombatCharacters(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_id)
AND
CombatGetActiveEntity(_id,_char)
THEN
SetStoryEvent(_char,"onSetOnStage_SpawnAt"); //find better way of doing it

PROC
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance()
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_int)
AND
_int<=2
AND
IntegerSum(_int,1,_newInt)
THEN
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_int);
DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_newInt);

PROC
Proc_FTJ_FinalBattle_TimeVoidwokenAppearance()
AND
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_)
THEN
DB_FTJ_FinalBattle_TimeVoidwokenAppearance(1);

IF
CharacterDying(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GetPosition(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_FJ_Worm_Voidwoken_Spawning_01",_X,_Y,_Z);

IF
CharacterDying(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
GlobalGetFlag("FTJ_AlexandarPhase_1",1)
AND
NOT DB_CombatCharacters(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_)
THEN
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Fallback();

PROC
DB_FTJ_FinalBattle_TimeVoidwokenAppearance_Fallback()
AND
DB_FTJ_FinalBattle_Magister(_char)
AND
QueryOnlyOnce("FTJ_FinalBattle_Fallback")
THEN
Proc_FTJ_FinalBattle_InitiateFight();
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"onSetOnStage_SpawnAtFallback"); //find better way of doing it

IF
StoryEvent(_,"FTJ_FinalBattle_Voidwoken_StorySpawnAt")
AND
QueryOnlyOnce("FTJ_FinalBattle_Voidwoken_StorySpawnAt")
AND
GetVarFloat3(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"appearPos",_x,_y,_z)
THEN
CharacterAppearAtPosition(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_x,_y,_z,1,"FTJ_FinalBattle_Voidwoken_StoryAppeared");
TimerLaunch("FTJ_SW_WormAppearSourceFX",1000);

IF
StoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, "FTJ_FinalBattle_VoidwokenAppearFailed")
THEN
TimerLaunch("FTJ_FinalBattle_VoidwokenAppearFailed_Timer", 1000);

// Try again, not much else we can do
IF
TimerFinished("FTJ_FinalBattle_VoidwokenAppearFailed_Timer")
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, "onSetOnStage_SpawnAtFallback");

//REGION Savegame patch in case voidwoken worm failed to appear (DOS2EE-3654)
IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 5, 1, 0)
AND
DB_OnlyOnce("FTJ_FinalBattle_Voidwoken_StorySpawnAt")
AND
ObjectIsOnStage(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, 0)
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, "FTJ_FinalBattle_VoidwokenAppearFailed");

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 5, 1, 0)
AND
DB_OnlyOnce("FTJ_FinalBattle_Fallback")
AND
ObjectIsOnStage(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, 0)
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73, "FTJ_FinalBattle_VoidwokenAppearFailed");
//END_REGION

IF
TimerFinished("FTJ_SW_WormAppearSourceFX")
AND
GetPosition(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_FJ_Worm_Voidwoken_Spawning_01",_X,_Y,_Z);

IF
ObjectLeftCombat(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_)
AND
DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_int)
THEN
NOT DB_FTJ_FinalBattle_TimeVoidwokenAppearance(_int);

IF
ObjectEnteredCombat(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_)
//GlobalFlagSet("FTJ_FinalBattle_VoidwokenAppeared")
AND
QueryOnlyOnce("FTJ_SW_FinalBattle_Voidwoken_JumpToTurn")
THEN
JumpToTurn(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73);

IF
ObjectEnteredCombat(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Combat)
THEN
Proc_FTJ_FinalBattle_PhaseIIMusic();

IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_Combat)
AND
DB_IsPlayer(_Char)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",1)
THEN
Proc_FTJ_FinalBattle_PhaseIIMusic();

IF
SavegameLoaded(_,_,_,_)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",1)
THEN
Proc_FTJ_FinalBattle_PhaseIIMusic();

PROC
Proc_FTJ_FinalBattle_PhaseIIMusic()
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Combat)
AND
DB_IsPlayer(_Char)
AND
DB_CombatCharacters(_Char,_Combat)
THEN
MusicPlayForPeer(_Char,"Boss_Fight_Phase_II_Start");

IF
StoryEvent(CHARACTERGUID_S_FTJ_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"FTJ_FinalBattle_VoidwokenAppeared")
//AND
//DB_FTJ_FinalBattle_Magister_Queue2(_Char)
THEN
GlobalSetFlag("FTJ_FinalBattle_VoidwokenAppeared");
TriggerSetAtmosphere(TRIGGERGUID_S_AtmosphereTrigger_FTJ_FinalBattleBeach_d4987042-6d48-4c3d-8ac5-763d0c400902, "09edc0f3-c27e-414a-a053-a4c1d2d1271a");

PROC
Proc_FTJ_FinalBattle_ThreeWayDialog()
AND
DB_IsPlayer(_Char)
AND
IsTagged(_Char,"AVATAR",1)
AND
HasActiveStatus(_Char,"FROZEN",0)
AND
HasActiveStatus(_Char,"STUNNED",0)
AND
HasActiveStatus(_Char,"PETRIFIED",0)
AND
HasActiveStatus(_Char,"INVISIBLE",0)
AND
HasActiveStatus(_Char,"SNEAKING",0)
AND
CharacterIsDead(_Char,0)
AND
GetDistanceTo(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char,_Dist)
AND
_Dist <= 15
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
THEN
DB_FinalBattle_ThreeWayDialog_QueueChar(_Char);

PROC
Proc_FTJ_FinalBattle_ThreeWayDialog()
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
AND
DB_IsPlayer(_Char)
AND
HasActiveStatus(_Char,"FROZEN",0)
AND
HasActiveStatus(_Char,"STUNNED",0)
AND
HasActiveStatus(_Char,"PETRIFIED",0)
AND
HasActiveStatus(_Char,"INVISIBLE",0)
AND
HasActiveStatus(_Char,"SNEAKING",0)
AND
CharacterIsDead(_Char,0)
AND
GetDistanceTo(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char,_Dist)
AND
_Dist <= 15
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
THEN
DB_FinalBattle_ThreeWayDialog_QueueChar(_Char);

PROC
Proc_FTJ_FinalBattle_ThreeWayDialog()
AND
HasActiveStatus(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FROZEN",0)
AND
HasActiveStatus(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"STUNNED",0)
AND
HasActiveStatus(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"PETRIFIED",0)
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,0)
AND
DB_FinalBattle_ThreeWayDialog_QueueChar(_Char)
AND
StartDialog_Internal("FTJ_FinalBattle",1,CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_)
THEN
GlobalSetFlag("FTJ_FinalBattle_ThreeWayDialogStarted");
ProcSetInvulnerable(_Char,1);
ProcSetInvulnerable(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,1);
ProcSetInvulnerable(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,1);
CharacterLookAt(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char);
CharacterLookAt(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Char);
CharacterLookAt(_Char,CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73);

PROC
Proc_FTJ_FinalBattle_ThreeWayDialog()
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,1)
AND
DB_FinalBattle_ThreeWayDialog_QueueChar(_Char)
AND
StartDialog_Internal("FTJ_FinalBattle",1,CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_)
THEN
GlobalSetFlag("FTJ_FinalBattle_ThreeWayDialogStarted");
ProcSetInvulnerable(_Char,1);
ProcSetInvulnerable(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,1);
CharacterLookAt(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_Char);
CharacterLookAt(_Char,CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73);

IF
StoryEvent(_,"FTJ_FinalBattle_VoidwokenAppeared")
//ObjectEnteredCombat(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,_)
//ObjectTurnStarted(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",1)
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
THEN
Proc_FTJ_FinalBattle_ThreeWayDialog();

IF
ObjectTurnStarted(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",1)
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
THEN
Proc_FTJ_FinalBattle_ThreeWayDialog();
/*
IF
GlobalFlagSet("FTJ_FinalBattle_VoidwokenAppeared")
AND
NOT DB_FinalBattle_ThreeWayDialog_QueueChar(_)
THEN
Proc_FTJ_FinalBattle_ThreeWayDialog();
*/
IF
DialogEnded("FTJ_FinalBattle",_)
AND
DB_FinalBattle_ThreeWayDialog_QueueChar(_Char)
THEN
ProcSetInvulnerable(_Char,0);
ProcSetInvulnerable(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,0);
ProcSetInvulnerable(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,0);

//Fallback

PROC
ReactOnKillCounter("FTJ_FinalBattle_Fallback")
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
DB_FTJ_FinalBattle_Magister(_Magi)
AND
DB_WasInCombat(_Magi,_Combat)
AND
DB_IsPlayer(_Char)
AND
DB_WasInCombat(_Char,_Combat)
AND
DB_InRegion(_Char,TRIGGERGUID_AiHintTrig_FTJ_FinalBattle_Burrow_9a987d10-c149-4d86-ab30-02c6b1b46c26)
AND
QueryOnlyOnce("FTJ_FinalBattle_Fallback")
THEN
SetStoryEvent(_Char,"onSetOnStage_SpawnAt");

PROC
ReactOnKillCounter("FTJ_FinalBattle_Fallback")
AND
GlobalGetFlag("FTJ_FinalBattle_VoidwokenAppeared",0)
AND
QueryOnlyOnce("FTJ_FinalBattle_Fallback")
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"onSetOnStage_SpawnAtFallback");

//END_REGION


//REGION Dallis Join Fight
IF
ObjectFlagSet("DEBUG_FTJ_RallyingPointSetup_Exter",(CHARACTERGUID)_Player,_)
THEN
ObjectClearFlag(_Player,"DEBUG_FTJ_RallyingPointSetup_Exter");
CharacterDie(CHARACTERGUID_S_FTJ_SW_Warrior_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54,0,"DoT");
GlobalSetFlag("FTJ_SW_ExterLeadsCallToArms");
ObjectSetFlag(_Player,"DEBUG_FTJ_RallyingPointSetup");

IF
TextEventSet("asaf")
THEN
ObjectSetFlag(CHARACTERGUID_S_Player_Sebille_c8d55eaf-e4eb-466a-8f0d-6a9447b5b24c,"DEBUG_FTJ_RallyingPointSetup");

IF
ObjectFlagSet("DEBUG_FTJ_RallyingPointSetup",(CHARACTERGUID)_Player,_)
THEN
CharacterDie(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,0,"DoT");
DB_OnlyOnce("FTJ_StartDallisEvent_OneShot");
DialogRequestStop(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
GlobalSetFlag("FTJ_ForceStartDallisPurge");
GlobalSetFlag("FTJ_DallisGhettoEventEnd");
GlobalSetFlag("FTJ_AlexandarPhase_1");
ProcCharacterDisableCrime(CHARACTERGUID_S_FTJ_SW_Warrior_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54, "ActiveUndead");
ProcCharacterDisableCrime(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"ActiveUndead");
CharacterTeleportPartiesToTrigger(TRIGGERGUID_S_FTJ_SW_GarethAttackWait_ce65a666-74e4-4903-bbcf-200251975965,"");

IF
ObjectFlagSet("DEBUG_FTJ_RallyingPointSetup",_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ProcSetHostileToIndivPlayer(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,_Player);

IF
ObjectFlagSet("DEBUG_FTJ_RallyingPointSetup",(CHARACTERGUID)_Player,_)
THEN
ObjectClearFlag(_Player,"DEBUG_FTJ_RallyingPointSetup");
DB_DontFTJ_SW_ForcedIntoCombat(CHARACTERGUID_S_FTJ_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54);

IF
CharacterDied(CHARACTERGUID_S_FTJ_SW_Warrior_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54)
AND
DB_GlobalFlag("FTJ_SW_GarethAtShelter")
AND
NOT DB_GlobalFlag("FTJ_SW_LeaveCallToArms")
THEN
GlobalSetFlag("FTJ_SW_LeaveCallToArms");
GlobalSetFlag("FTJ_SW_ExterLeadsCallToArms");


IF
ObjectFlagSet("DEBUG_FTJ_RallyingPointSetup",_,_)
AND
DB_FTJ_SW_GarethsWarriors((CHARACTERGUID)_Char,_,_,_)
THEN
ObjectSetFlag(_Char,"FTJ_SW_JoinCallToArms");
GlobalSetFlag("FTJ_SW_LeaveCallToArms");
SetCanFight(_Char,1);
SetCanJoinCombat(_Char,1);


IF
TextEventSet("FTJBattle")
THEN
CharacterDie(CHARACTERGUID_S_FTJ_Florence_c272a37a-85ea-438f-9871-1551ef45d338,0,"DoT");
DB_OnlyOnce("FTJ_StartDallisEvent_OneShot");
DialogRequestStop(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572);
GlobalSetFlag("FTJ_ForceStartDallisPurge");
GlobalSetFlag("FTJ_DallisGhettoEventEnd");
GlobalSetFlag("FTJ_AlexandarPhase_1");


IF
TextEventSet("FTJBattle")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ProcSetHostileToIndivPlayer(CHARACTERGUID_S_GLO_Dallis_69b951dc-55a4-44b8-a2d5-5efedbd7d572,_Player);

IF
TextEventSet("ftjwarriors")
AND
DB_FTJ_SW_GarethsWarriors((CHARACTERGUID)_Char,_,_,_)
THEN
ObjectSetFlag(_Char,"FTJ_SW_JoinCallToArms");
GlobalSetFlag("FTJ_SW_LeaveCallToArms");
SetCanFight(_Char,1);
SetCanJoinCombat(_Char,1);
//END_REGION

//REGION Boat To Lady Vengeance
//Gareth (or Exter) Boat Dialog
IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_GarethStartBoatDialog")
AND
DB_FTJ_SW_CallToArmsLeaders(_Leader,_,_Dialog)
THEN
Proc_StartDialog(0,_Dialog,_Leader,_Player);

IF
TextEventSet("boattest")
THEN
ReactOnKillCounter("FTJ_FinalBattle");

PROC
ReactOnKillCounter("FTJ_FinalBattle")
THEN
GlobalSetFlag("FTJ_FinalBattleOver");
SetOnStage(ITEMGUID_S_FTJ_BoatToShip_001_63914b60-eea0-4d17-8081-898b58ef9cc0,1);
proc_ItemMoveToTrigger(ITEMGUID_S_FTJ_BoatToShip_001_63914b60-eea0-4d17-8081-898b58ef9cc0,TRIGGERGUID_S_FTJ_SW_BoatToLV_Point_8f0f27d3-0bb0-4366-8c3a-d84cbaded309,5.0,1.0,1);

PROC
ReactOnKillCounter("FTJ_FinalBattle")
AND
DB_IsPlayer(_Player)
AND
QRY_FTJ_FinalBattle_WasInFight(_Player)
AND
//QRY_FTJ_FinalBattle_AttackStarted(_Player)
ObjectGetFlag(_Player,"QuestUpdate_FTJ_Escape_Island_EscapeSeeker",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_FinalBattle");

PROC
ReactOnKillCounter("FTJ_FinalBattle")
AND
DB_IsPlayer(_Player)
AND
QRY_FTJ_FinalBattle_WasInFight(_Player)
AND
//NOT QRY_FTJ_FinalBattle_AttackStarted(_Player)
ObjectGetFlag(_Player,"QuestUpdate_FTJ_Escape_Island_EscapeSeeker",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_FTJ_SW_Shriekers_Know_Shrieker",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_FinalBattleNoSeeker");

PROC
ReactOnKillCounter("FTJ_FinalBattle")
AND
DB_IsPlayer(_Player)
AND
QRY_FTJ_FinalBattle_WasInFight(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_FTJ_Escape_Island_DragonHelp",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_Island_FinalBattleDragon");

QRY
QRY_FTJ_FinalBattle_WasInFight((CHARACTERGUID)_Player)
AND
DB_WasInCombat(_Player,_ID)
AND
DB_FTJ_FinalBattle_Magister(_Magister)
AND
DB_WasInCombat(_Magister,_ID)
THEN
DB_NOOP(1);

QRY
QRY_FTJ_FinalBattle_WasInFight((CHARACTERGUID)_Player)
AND
DB_WasInCombat(_Player,_ID)
AND
DB_WasInCombat(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_ID)
THEN
DB_NOOP(1);

QRY
QRY_FTJ_FinalBattle_AttackStarted((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestClose_FTJ_SW_CallToArms_AttackStarted",1)
THEN
DB_NOOP(1);

QRY
QRY_FTJ_FinalBattle_AttackStarted((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestClose_FTJ_SW_CallToArms_AttackStartedExter",1)
THEN
DB_NOOP(1);

//END_REGION



//REGION Boat to Lady Vengeance_Seekers
IF
CharacterEnteredTrigger(_Player, TRIGGERGUID_S_FTJ_SW_FinalFight_InfiltrationBox_a8d17d54-17ec-4d49-92c6-02eef947dea4)
AND
GlobalGetFlag("FTJ_SW_CallToArms_PathIsCleared", 1)
AND
GlobalGetFlag("FTJ_SW_CallToArmsReady", 1)
THEN
GlobalSetFlag("FTJ_SW_FinalBattle_StartInfiltration");  // also set in CallToArms goal after Gareth's dialog ends


IF
GlobalFlagSet("FTJ_SW_FinalBattle_StartInfiltration")
THEN
Proc_FTJ_SW_CTA_RecruitedWarriorsStartFollow();

IF
GlobalFlagSet("FTJ_SW_FinalBattle_StartInfiltration")
THEN
Proc_FTJ_SW_PlayGratianasCheeringDialog();
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_FTJ_SW_FinalFight_InfiltrationBox_a8d17d54-17ec-4d49-92c6-02eef947dea4);
Proc_FTJ_InitiateInfiltration();


PROC
Proc_FTJ_SW_PlayGratianasCheeringDialog()
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_SW_ShelterUndead_f0602373-d2cb-4658-a91b-9d111c928152, "FTJ_SW_JoinCallToArms", 1)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_SW_ShelterUndead_f0602373-d2cb-4658-a91b-9d111c928152, 0)
AND
QueryOnlyOnce("FTJ_SW_GratianaCheerOnWarriorsOnce")
THEN
SetStoryEvent(CHARACTERGUID_S_FTJ_SW_ShelterUndead_f0602373-d2cb-4658-a91b-9d111c928152, "FTJ_SW_GratianaCheerOnWarriors");


PROC
Proc_FTJ_InitiateInfiltration()
THEN
Proc_StartDialog(1,"FTJ_SW_AD_FinalBattle_ExterInfiltration",CHARACTERGUID_S_FTJ_SW_Warrior_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54);


PROC
Proc_FTJ_InitiateInfiltration()
AND
GlobalGetFlag("FTJ_SW_ExterLeadsCallToArms",1)
THEN
Proc_StartDialog(1,"FTJ_AD_FinalBattle_GerathInfiltration",CHARACTERGUID_S_FTJ_SW_Warrior_Squire_650e8e08-55a2-4ea6-a9f3-c027e4f8c494);


PROC
Proc_FTJ_InitiateInfiltration()
AND
DB_FTJ_SW_GarethsWarriors(_Char, _, _, _)
AND
ObjectGetFlag(_Char, "FTJ_SW_JoinCallToArms", 1)
AND
CharacterIsDead(_Char, 0)
AND
NOT DB_FTJ_SW_WarriorsRecruited(_Char, _)
THEN
ProcForceStopDialog(_Char);
CharacterSetForceUpdate(_Char, 1);
CharacterSetReactionPriority(_Char,"FTJ_FinalBattle_initiateInfiltration", 1700);
DB_FTJ_FinalBattleInfiltration(_Char);

IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_FinalBattle_ReachedBoat")
THEN
SetHasDialog(_Char, 1);
SetOnStage(_Char, 0);
CharacterSetReactionPriority(_Char,"FTJ_FinalBattle_initiateInfiltration", 0);

IF
CharacterDied(_Char)
AND
DB_FTJ_FinalBattleInfiltration(_Char)
THEN
NOT DB_FTJ_FinalBattleInfiltration(_Char);
Proc_FTJ_CheckInfiltrationDone_Dead();
CharacterSetForceUpdate(_Char, 0);

PROC
Proc_FTJ_CheckInfiltrationDone_Dead()
AND
NOT DB_FTJ_FinalBattleInfiltration(_)
AND
DB_GlobalFlag("FTJ_FinalBattle_AnyoneReachedBoat")
THEN
SetOnStage(ITEMGUID_S_FTJ_BoatToShip_Seekers_75a2ae6a-56ad-4e82-902a-a57917ec046b,0);

IF
StoryEvent((CHARACTERGUID)_Char,"FTJ_FinalBattle_ReachedBoat")
AND
DB_FTJ_FinalBattleInfiltration(_Char)
THEN
GlobalSetFlag("FTJ_FinalBattle_AnyoneReachedBoat");
NOT DB_FTJ_FinalBattleInfiltration(_Char);
Proc_FTJ_CheckInfiltrationDone();
CharacterSetForceUpdate(_Char, 0);

PROC
Proc_FTJ_CheckInfiltrationDone()
AND
NOT DB_FTJ_FinalBattleInfiltration(_)
THEN
SetOnStage(ITEMGUID_S_FTJ_BoatToShip_Seekers_75a2ae6a-56ad-4e82-902a-a57917ec046b,0);
GlobalSetFlag("FTJ_FinalBattle_InfiltrationDone");

IF
StoryEvent(CHARACTERGUID_S_FTJ_SW_Warrior_SeekerCaptain_1329f018-23e4-4717-9bc8-074b28d04c54,"FTJ_FinalBattle_ReachedBoat")
THEN
GlobalSetFlag("FTJ_FinalBattle_GarethReachedBoat");
ProcSetFlagOnAll("QuestClose_FTJ_SW_BatteredAndCornered");
//END_REGION

//REGION 
IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GlobalGetFlag("FTJ_AlexandarPhase_1",1)
THEN
DB_FTJ_SW_FinalBattle_QueueMagisterAD(1);

IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GetDistanceTo(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Dist)
AND
_Dist < 20.0
THEN
Proc_StartDialog(1,"FTJ_SW_AD_IfanKilledAlexandar",CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

PROC
Proc_ObjectLeftCombat(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_CombatID)
AND
GlobalGetFlag("FTJ_AlexandarPhase_1",1)
AND
DB_IsPlayer(_Player)
AND
DB_WasInCombat(_Player,_CombatID)
THEN
PartySetFlag(_Player,"FTJ_SW_HelpedKillAlexandar");

PROC
Proc_ObjectLeftCombat(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_CombatID)
AND
GlobalGetFlag("FTJ_AlexandarPhase_1",1)
AND
DB_IsPlayer(_Player)
AND
DB_CombatCharacters(_Player,_CombatID)
THEN
PartySetFlag(_Player,"FTJ_SW_HelpedKillAlexandar");

IF
ObjectTurnStarted((CHARACTERGUID)_Char)
AND
DB_FTJ_SW_FinalBattle_QueueMagisterAD(1)
AND
DB_FTJ_FinalBattle_Magister(_Char)
AND
HasActiveStatus(_Char,"FROZEN",0)
AND
HasActiveStatus(_Char,"STUNNED",0)
AND
HasActiveStatus(_Char,"PETRIFIED",0)
THEN
NOT DB_FTJ_SW_FinalBattle_QueueMagisterAD(1);
Proc_StartDialog(1,"FTJ_SW_AD_FinalBattle_AlexandarDeath",_Char);

IF
CharacterDied(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
DB_FTJ_SW_GarethsWarriors(_Warrior,_,_,_)
AND
DB_MurderIgnoreFor(_Warrior,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
THEN
NOT DB_MurderIgnoreFor(_Warrior,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);
NOT DB_AssaultFamilyIgnoreFor(_Warrior,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349);

//END_REGION

PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;

EXITSECTION
NOT DB_FTJ_FinalBattle_Magister((CHARACTERGUID)CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9); 
NOT DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187);
NOT DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3);
NOT DB_FTJ_FinalBattle_Magister(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5);

NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_000_c283e820-0166-4668-8ad4-842085d58de9,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_001_165f1353-a916-4291-940a-293efbe8f187,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_002_0b7282f6-a131-4441-a113-8f3ea62fa9e3,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_003_b5dd6af4-6b34-482e-bc0a-72bd6269aaf5,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattle_Voidwoken_7dcf3cc2-d015-4aff-9949-71fc539fcc73,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_FTJ_SW_FinalBattleMagister_Gheist_06082187-829f-43e1-b3bb-f3242a70904d,"FTJ_FinalBattle");
NOT DB_KillCounter_Internal(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,"FTJ_FinalBattle");
ENDEXITSECTION
ParentTargetEdge "FortJoy"
