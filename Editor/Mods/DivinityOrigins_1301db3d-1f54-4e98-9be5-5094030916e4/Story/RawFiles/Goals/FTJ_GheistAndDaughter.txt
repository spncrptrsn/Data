Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(RC_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,"FTJ_GheistDaughter");
DB_Dialogs(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,"FTJ_BeachGheist");
DB_HasStoryEvent((ITEMGUID)RC_FTJ_GheistDaughterRing_3a52e9c1-5acf-487b-9533-3519993d34a2,"RC_FTJ_HasGheistRing");
DB_GiveItemToEvent((ITEMGUID)RC_FTJ_GheistDaughterRing_3a52e9c1-5acf-487b-9533-3519993d34a2,"RC_FTJ_GheistRingTo");

ItemToInventory(ITEMGUID_S_FTJ_ChapelUpperFloorDoorKey_da06411f-48f8-4a1a-a576-635fc56ec2a8,CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861);
DB_GiveItemToEvent((ITEMGUID)ITEMGUID_S_FTJ_ChapelUpperFloorDoorKey_da06411f-48f8-4a1a-a576-635fc56ec2a8,"FTJ_CourtRoomKeyTo");

DB_HasStoryEvent((ITEMGUID)ITEMGUID_S_FTJ_ChapelUpperFloorDoorKey_da06411f-48f8-4a1a-a576-635fc56ec2a8,"FTJ_HasCourtRoomKey");
CharacterSetCanTrade(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,0);
ItemToInventory(RC_FTJ_GheistDaughterRing_3a52e9c1-5acf-487b-9533-3519993d34a2,RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,-1);
//CharacterSetHitpointsPercentage(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,12.0);
//ProcCharacterDisableAllCrimes(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c);
DB_IsNotMessingAround(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c);

// First entry is used to check whether she has any money at all, the second to transfer up to 50 gold
// This is a transfer from the magister to the player, but this is a three-speaker dialog and
// the magister is speaker 2 (which is the default speaker that gets checked for money, as it's
// usually the player) 
DB_DialogMoneyTransfer(1,"FTJ_YarrowReunitedWithFather",1);
DB_DialogMoneyTransfer(2,"FTJ_YarrowReunitedWithFather",50);


DB_KilledEvent(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c, "FTJ_PlayerKilledMigo");
KBSECTION
//http://fileserver-dmz/mediawiki/index.php/Murderous_Gheist

//REGION Yarrow Death Journal

IF
DB_Dead(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861)
AND
DB_IsPlayer(_Player)
AND
DB_Sees(_Player, CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_InfoGheist",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_YarrowDead");

//END_REGION

//REGION Seeing Migo
IF 
CharacterSawCharacter(_Player,RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
DB_IsPlayer(_Player)
AND 
QRY_SpeakerIsAvailable(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,0)
AND 
QueryOnlyOnce("FTJ_SawGheistEatingAD")
THEN
Proc_StartDialog(1,"FTJ_VB_GheistFight",_Player);


IF 
CharacterSawCharacter(_Player,RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_MigoSpot");


//END_REGION

IF 
DialogEnded("FTJ_BeachGheist",_Inst)
AND
GlobalGetFlag("FTJ_GheistHostile",1)
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
ProcSetRelationToPlayers(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,0);
DB_RC_FTJ_BeachGheistDialogStarted(_Player);

//REGION Looting Migos Corpses
IF
CharacterLootedCharacterCorpse(_Player,_Corpse)
AND
CharacterCanSee(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,_Player,1)
AND
GlobalGetFlag("FTJ_GheistPacified",0)
AND
QueryOnlyOnce("FTJ_BeachGheistReactToUsingCorpse")
THEN
Proc_StartDialog(0,"FTJ_BeachGheist",CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,_Player);

IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_BeachGheistVictimLimb_002_3a0f4775-972f-4f96-b3d9-7c155e1fb517)
AND
CharacterCanSee(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,_Player,1)
AND
GlobalGetFlag("FTJ_GheistPacified",0)
AND
QueryOnlyOnce("FTJ_BeachGheistReactToUsingCorpse")
AND
QueryOnlyOnce("FTJ_PlayerPacifedGheist_Once")
THEN
Proc_StartDialog(0,"FTJ_BeachGheist",CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,_Player);

//END_REGION

//REGION Dialog ended & Dead events
IF
DialogEnded("FTJ_BeachGheist",_ID)
AND
GlobalGetFlag("FTJ_GheistPacified",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
QueryOnlyOnce("FTJ_PlayerPacifedGheist_Once")
THEN
UserSetFlag(_Player,"QuestAdd_RC_FTJ_MurderousGheist");
UserSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_PacifiedGheist");

IF
ObjectFlagSet("RC_FTJ_GheistRingTo",(CHARACTERGUID)_Player,_)
THEN
UserSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_GheistGaveRing");


IF
CharacterDied(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
THEN
GlobalSetFlag("RC_FTJ_BeachGheistDead");

//only start the reflection dialog if the gheist started the conversation with the player
IF
CharacterDied(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
DB_RC_FTJ_BeachGheistDialogStarted(_Player)
THEN
ProcDefineReflectionDialog("FTJ_RD_BeachGheist",(CHARACTERGUID)_Player);

IF
ObjectFlagSet("FTJ_PlayerKilledMigo",_Player,_)
THEN
ObjectSetFlag(_Player,"QuestAdd_RC_FTJ_MurderousGheist");
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_StartGheist");

//Make sure other users in different parties can still get the update 
IF
CharacterLootedCharacterCorpse(_Player,RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_StartGheist",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_StartGheist");

IF
ObjectFlagSet("FTJ_GheistQuestInfo",(CHARACTERGUID)_Player,_)
THEN
ObjectSetFlag(_Player,"QuestAdd_RC_FTJ_MurderousGheist");
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_InfoGheist");


IF
GlobalFlagSet("RC_FTJ_GheistDaughterRingReturned")
THEN
ItemToInventory(RC_FTJ_GheistDaughterRing_3a52e9c1-5acf-487b-9533-3519993d34a2,RC_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,-1);
ProcCharacterDisableCrime(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,"FTJCollarless");
/*
IF
GlobalFlagSet("RC_FTJ_GheistDaughterRingReturned")
AND
DB_IsPlayer(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_FTJ_MurderousGheist_EndGheist");
*/

IF
ObjectFlagSet("FTJ_YarrowFlowerTo",CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
QryRemoveItemTemplateFromMagicPockets(_Player,"FTJ_YarrowFlower_cc1bb8f1-3a4e-46d7-9268-c420bece54a3",1)
THEN
ItemTemplateAddTo("FTJ_YarrowFlower_cc1bb8f1-3a4e-46d7-9268-c420bece54a3",CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,1);
//END_REGION

//REGION Check for Ghest Has Plant
IF
ItemTemplateAddedToCharacter(CON_Herb_YarrowFlower_cc1bb8f1-3a4e-46d7-9268-c420bece54a3,_,CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
THEN
GlobalSetFlag("FTJ_GheistHasYarrowPlant");

IF
ItemTemplateRemovedFromCharacter("CON_Herb_YarrowFlower_cc1bb8f1-3a4e-46d7-9268-c420bece54a3",_,CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
CharacterGetItemTemplateCount(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,"FTJ_YarrowFlower_cc1bb8f1-3a4e-46d7-9268-c420bece54a3",_Int)
AND
_Int == 0
THEN
GlobalClearFlag("FTJ_GheistHasYarrowPlant");

IF
ObjectFlagSet("FTJ_CourtRoomKeyTo",(CHARACTERGUID)_Player,_)
AND
UserGetFlag(_Player,"QuestUpdate_FTJ_Escape_YarrowReward",0)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_YarrowReward");

IF
TextEventSet("yarrowmarker")
AND
DB_IsPlayer(_Player)
THEN
ProcShowMarker(_Player,"FTJ_DoorToMagisterQuarters");

IF
ObjectFlagSet("FTJ_MapMarkerToMagisterQuarters",_Player,_)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"FTJ_DoorToMagisterQuarters");

IF
ItemUnlocked(ITEMGUID_S_FTJ_DoorToMagisterQuarters_5d5f9fda-55c3-429e-ace3-ba41bd3a59be,_Player,ITEMGUID_S_FTJ_ChapelUpperFloorDoorKey_da06411f-48f8-4a1a-a576-635fc56ec2a8)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag(_Player,"QuestUpdate_FTJ_Escape_YarrowReward",1)
THEN
UserSetFlag(_Player,"QuestUpdate_FTJ_Escape_Yarrow_KeyUsed");

//END_REGION

//REGION Reunited add 3 way dialog
IF
GlobalFlagSet("FTJ_YarrowReunited")
THEN
PROC_RemoveDialogFromCharacter(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861);
PROC_RemoveDialogFromCharacter(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c);
DB_Dialogs(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,"FTJ_YarrowReunitedWithFather");

IF
CharacterDied(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861)
AND
GlobalGetFlag("FTJ_YarrowReunited",1)
THEN
SetFaction(RC_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,"Evil NPC");

IF
CharacterDied(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c)
AND
GlobalGetFlag("FTJ_YarrowReunited",1)
THEN
PROC_RemoveDialogFromCharacter(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861);
DB_Dialogs(RC_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,"FTJ_GheistDaughter");

IF
AttackedByObject(CHARACTERGUID_S_FTJ_BeachGheist_47263b13-ace6-4950-99b6-4f2b6ae8cc6c,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,_Player,1)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_GheistDaughter_7511c722-d6fa-4236-ab56-e68018362861,_Player,-100);

//END_REGION

PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
