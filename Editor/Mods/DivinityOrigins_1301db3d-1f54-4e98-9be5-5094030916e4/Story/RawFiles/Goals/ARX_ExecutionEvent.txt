Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Wiki :https://sites.google.com/a/larian.com/projecttest/home/wiki-articles/quest-design-documentation/arx---paladin-execution

//EventSetup
SetHasDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
CharacterSetFightMode(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1,1);
CharacterSetCanTrade(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0);
CharacterSetAnimationOverride(RC_Humans_Female_Paladin_000_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"Tied_Up_01_Loop");
GlobalSetFlag("RC_ARX_Barracks_ExecutionEvent");
ProcTriggerRegisterForPlayers(S_ARX_Barracks_Execution_RemoveCorpse_77363571-77e2-4d9f-a58b-22bd5aab90de);
DB_Ghosts(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_ARX_Kemm_Ghost_4dc40adc-fa79-4bc2-96f0-a9ce8fae8476,"ARX_Kemm_Ghost");

//Triggers
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_ARX_Barracks_Execusion_Event_ae914a91-5a9a-4dd3-916f-482868f5eec4);
TriggerRegisterForPlayers(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);

//Dialogs 
DB_Dialogs(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"RC_ARX_Barracks_PrisonersWife");
//DB_Dialogs(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barracks_ExecutionPrisoner");
SetHasDialog(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,1);

//Dialog Spectators 
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"ARX_AD_Barracks_Paladin_01");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"ARX_AD_Barracks_Battlemage");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"ARX_AD_Barracks_Paladin_06");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"ARX_AD_Barracks_Paladin_02");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"ARX_AD_Barracks_Paladin_07");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,"ARX_AD_Barracks_ExecutionGuard1");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard2_cd5f4253-d085-440b-8e3b-2a26c4bbc4f8,"ARX_AD_Barracks_ExecutionGuard2");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"RC_ARX_AD_Barracks_Paladin_05");
DB_AD_Dialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"RC_ARX_AD_Barracks_Paladin_04");

//Dialogs PostExecution 
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"RC_ARX_Barracks_Paladin_01");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"RC_ARX_Barracks_Battlemage");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"RC_ARX_Barracks_Paladin_06");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"RC_ARX_Barracks_Paladin_02");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"RC_ARX_Barracks_Paladin_07");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,"RC_ARX_Barracks_ExecutionGuard1");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard2_cd5f4253-d085-440b-8e3b-2a26c4bbc4f8,"RC_ARX_Barracks_ExecutionGuard2");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"RC_ARX_Barracks_Paladin_05");
DB_PostExecutionDialogsDialogs(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"RC_ARX_Barracks_Paladin_04");

//Ghosts
DB_Ghosts(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,S_RC_ARX_Barracks_Ghost_ExecutionPrisoner_67284f31-95a7-4043-9ff4-38cf1fe82e14,"RC_ARX_Barracks_Ghost_ExecutionPrisoner");

//Journal


// Funcional DBs
DB_RC_ARX_Barracks_ExecutionGuards(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,RC_ARX_Barracks_Execution_GuardCell1_24e4f885-2e3e-489e-8da3-786f6ce4d370);
DB_RC_ARX_Barracks_ExecutionGuards(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard2_cd5f4253-d085-440b-8e3b-2a26c4bbc4f8,RC_ARX_Barracks_Execution_GuardCell2_469d1c8a-5018-41a7-a844-cd87a76cb94d);


//Scene Manager
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_ExecutionGuard2_cd5f4253-d085-440b-8e3b-2a26c4bbc4f8,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"RC_ARX_Barracks_ExecutionScene");
DB_SceneManager((CHARACTERGUID)S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"RC_ARX_Barracks_ExecutionScene");


DB_SceneTriggerManager("RC_ARX_Barracks_ExecutionScene",(TRIGGERGUID)S_RC_ARX_Barracks_Execusion_Event_ae914a91-5a9a-4dd3-916f-482868f5eec4,0);

ApplyStatus(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"QUEST_TIEDUP",-1.0,1);
DB_ItemOwnerShipTriggers("ARX_Main",S_ARX_Barrakcs_KemmsOwnershipTrigger_59c51e46-4fd6-44dc-ab78-c7390c0a84aa,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

DB_KilledEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_KilledKemm");
KBSECTION
//REGION Journal

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag((CHARACTERGUID)_Player,"RC_ARX_Barracks_ExecutionEvent_Witnessed",1)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_Barracks_Execution_PaladinExecuted");

IF
DialogEnded("RC_ARX_Barracks_ExecutionPersuasion",_ID)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",1)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_Barracks_Execution_ConvicedToSpare");

PROC
Proc_SceneOver("RC_ARX_Barracks_ExecutionScene")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
DB_IsPlayer(_Player)
AND
UserGetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_Barracks_Execution_Start",1)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_Barracks_Execution_Interrupted");


//END_REGION

//REGION Start Execution

PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_ARX_Barracks_Execusion_Event_ae914a91-5a9a-4dd3-916f-482868f5eec4)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
THEN
ProcForceStopDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
ProcForceStopDialog(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_Barracks_ExecutionEventStartAD");
PartySetFlag(_Player,"RC_ARX_Barracks_ExecutionEvent_Witnessed");
GlobalClearFlag("RC_ARX_Barrack_Exection_PreEvent_CrowdRespond"); // Edge case if the crowd is in the middle of responding when the AD is stopped Flag can get stuck

IF
GlobalFlagSet("RC_ARX_Barracks_ExecutionEvent")
THEN
SetStoryEvent(S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068,"ARX_ExecutionEvent_Wife_StartSpotting");

IF
GlobalFlagSet("RC_ARX_Barracks_ExecutionEvent") //Flag is set on the init of the goal
AND
CharacterGetEquippedItem(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"Weapon",(ITEMGUID)_Weapon)
THEN
CharacterUnequipItem(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Weapon);

IF
GlobalFlagSet("RC_ARX_Barracks_ExecutionEvent") //Flag is set on the init of the goal
AND
CharacterGetEquippedItem(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"Shield",(ITEMGUID)_Shield)
THEN
CharacterUnequipItem(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Shield);

IF
CharacterCharacterEvent(_Wife,_Player,"ARX_ExecutionEvent_Wife_StartDialog")
AND
UserGetFlag(_Player,"RC_ARX_Barracks_WifeAskedForHelp",0)
THEN
Proc_StartDialog(0,"RC_ARX_Barracks_PrisonersWife",S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,_Player);
//ProcCharacterMoveToAndTalk(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,_Player,"RC_ARX_Barracks_PrisonersWife",0,"",1,10.0,1,0);

IF
DialogEnded("RC_ARX_Barracks_PrisonersWife",_Id)
THEN
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);
SetStoryEvent(S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068,"ARX_ExecutionEvent_Wife_StopSpotting");
//NOT DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
THEN
SetStoryEvent(S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068,"ARX_ExecutionEvent_Wife_StopSpotting");

//END_REGION

//REGION Kill Prisoner
IF
AutomatedDialogEnded("RC_ARX_AD_Kemm_Execution_Accusation",_)
AND
GlobalGetFlag("RC_ARX_BarrackExecustion_KemmReadyToKill",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",0)
AND
QueryOnlyOnce("RC_ARX_BarrackExecustion_KeemDoneAccusation")
THEN
Proc_StartDialog(1,"RC_ARX_AD_Execution_WifeScream",S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719);
ProcCharacterMoveTo(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,S_RC_ARX_Barracks_WifeScreamPoint_03ce153d-5d8e-48dc-bcbc-55bb1b42e079,1,"RC_ARX_Barracks_Execution_WifeScream"); // Not useing the proc because it enables Generics after
ProcForceStopDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719);
SetHasDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,0);
TimerLaunch("RC_ARX_Barracks_Execute_Paladin",7000);

IF
DialogEnded("RC_ARX_Barracks_ExecutionPersuasion",_ID)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent_KillPrisonerNow",1)
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
TimerCancel("RC_ARX_Barracks_Execute_Paladin");
CharacterSetArmorPercentage(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0.0);
CharacterAttack(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

IF
StoryEvent(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"RC_ARX_Barracks_Execution_WifeScream")
THEN
CharacterLookAt(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
SetHasDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,1);

IF
TimerFinished("RC_ARX_Barracks_Execute_Paladin")
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
QRY_SpeakerIsAvailable(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
CharacterSetArmorPercentage(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0.0);
CharacterAttack(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

IF
TimerFinished("RC_ARX_Barracks_Execute_Paladin")
AND
NOT QRY_SpeakerIsAvailable(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
CharacterIsDead(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
TimerLaunch("RC_ARX_Barracks_Execute_Paladin",2000);

IF
AttackedByObject(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_,_DType,_)
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
NOT DB_SceneManager(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barracks_ExecutionScene");
ProcForceStopDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719); //Just in Case she is ADing so she can yell "NO"
CharacterDie(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0,"Physical");
//GlobalSetFlag("RC_ARX_Barracks_ExecutionEvent");

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",0)
THEN
CreatePuddle(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"SurfaceBlood",3,5,1,2,0.05);

IF	//Just in Case
GlobalFlagSet("RC_ARX_Barracks_ConvincedToSpare")
THEN
TimerCancel("RC_ARX_Barracks_Execute_Paladin");
//END_REGION

//REGION Talking To The Prisoners
PROC
PROC_GLOBAL_DialogStartRequested(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player)
AND
ObjectGetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm",0)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
THEN
ObjectSetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm");
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm");
Proc_StartDialog(0,"RC_ARX_Barracks_ExecutionPersuasion",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player);
//TimerLaunch("RC_ARX_Barracks_Execute_Paladin",7000);

/*
IF
DialogEnded("RC_ARX_Barracks_ExecutionPersuasion",_Inst)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
ObjectGetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm",1)
THEN
ObjectClearFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm",0);


IF
DialogEnded("RC_ARX_Barracks_ExecutionPrisoner",_ID)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
THEN
TimerCancel("RC_ARX_Barracks_Execute_Paladin");


IF
DialogEnded("RC_ARX_Barracks_ExecutionPrisoner",_Inst)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
ObjectGetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_StartedDialogWithPrisoner",1)
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
ObjectClearFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_StartedDialogWithPrisoner");
PROC_RemoveDialogFromCharacter(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
SetHasDialog(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,1);
ObjectSetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm");
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm");
//Proc_StartDialog(1,"RC_ARX_AD_Kemm_Execution_Accusation",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
//Proc_StartDialog(0,"RC_ARX_Barracks_ExecutionPersuasion",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player);
*/
PROC
PROC_GLOBAL_DialogStartRequested(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player)
AND
ObjectGetFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",0)
THEN
Proc_StartDialog(1,"RC_ARX_AD_Kemm_Execution_Accusation",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
//END_REGION

//REGION Prisoner Dies

IF
CharacterDying(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
CharacterCanSee(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,1)
THEN
ObjectSetFlag(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"RC_ARX_Barracks_SawHusbandDie");
CharacterLookAt(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
Proc_StartDialog(1,"RC_ARX_AD_Execution_WifeScream",S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719);

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
THEN
GlobalSetFlag("RC_ARX_Barracks_ExecutionPrisonerDead");
GlobalSetFlag("RC_ARX_Barracks_ExecutionEndedCorpseStillThere");
Proc_StartDialog(1,"RC_ARX_AD_Kemm_Execution_Accusation",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
THEN
GlobalSetFlag("RC_ARX_Barracks_ExecutionPrisonerDead");

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
CharacterIsInCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
CharacterSetFightMode(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0,0); //Needs a smoother Transition

IF
AutomatedDialogEnded("RC_ARX_AD_Kemm_Execution_Accusation",_)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionPrisonerDead",1)
AND
QueryOnlyOnce("RC_ARX_BarrackExecustion_KeemKilledPrisoner")
THEN
GlobalClearFlag("RC_ARX_Barracks_ExecutionEvent");
//END_REGION

//REGION Talking To Kemm
PROC
PROC_GLOBAL_DialogStartRequested(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",0)
AND
QRY_SpeakerIsAvailable(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
THEN
Proc_StartDialog(0,"RC_ARX_Barracks_ExecutionPersuasion",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player);

PROC
PROC_GLOBAL_DialogStartRequested(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",0)
AND
NOT QRY_SpeakerIsAvailable(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
CharacterIsInCombat(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
ProcForceStopDialog(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
Proc_StartDialog(0,"RC_ARX_Barracks_ExecutionPersuasion",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player);


IF
DialogEnded("RC_ARX_Barracks_ExecutionPersuasion",_Id)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",1)
THEN
CharacterSetFightMode(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0,0);
Proc_StartDialog(1,"RC_ARX_AD_Kemm_Execution_Accusation",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
SetHasDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0);
PROC_RemoveDialogFromCharacter(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

IF
AutomatedDialogEnded("RC_ARX_AD_Kemm_Execution_Accusation",_)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",1)
AND
QueryOnlyOnce("RC_ARX_BarrackExecustion_KemmSaparedPrisoner")
THEN
GlobalClearFlag("RC_ARX_Barracks_ExecutionEvent");
//END_REGION

//REGION Execution Over
//Everyone Else

// Don't Know If Necessary 
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
DB_SceneManager(_Char,"RC_ARX_Barracks_ExecutionScene")
AND
DB_AD_Dialog(_Char,_Dialog)
AND
NOT DB_RC_ARX_Barracks_ExecutionGuards(_Char,_) //Gets cleared in the Guard timer RC_ARX_Barracks_Guards_Go_ToPrison
THEN
NOT DB_AD_Dialog(_Char,_Dialog);


IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
DB_PostExecutionDialogsDialogs(_Char,_Dialog)
AND
NOT DB_RC_ARX_Barracks_ExecutionGuards(_Char,_) //Gets cleared in the Guard timer RC_ARX_Barracks_Guards_Go_ToPrison
THEN
DB_Dialogs(_Char,_Dialog);


// ARX Genoside
IF
GlobalFlagSet("ARX_InitiateGenocide")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
THEN
GlobalClearFlag("RC_ARX_Barracks_ExecutionEvent");

IF
GlobalFlagSet("ARX_InitiateGenocide")
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
THEN
ProcCharacterDisappearOutOfSight(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,90,1,"",1);




//-------Prisoner 
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
DB_Dialogs(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barracks_ExecutionPrisoner");
ObjectClearFlag(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"RC_ARX_Barrack_ExecutionPrisoner_DialogBlockedByKemm",0);
CharacterSetAnimationOverride(RC_Humans_Female_Paladin_000_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"");

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
HasActiveStatus(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"QUEST_TIEDUP",1)
THEN
RemoveStatus(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"QUEST_TIEDUP");

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",1)
THEN
ProcCharacterMoveTo(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_ExecutedPaladinSparedReachedStairs");

IF
StoryEvent(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9, "RC_ARX_Barracks_ExecutedPaladinSparedReachedStairs")
THEN
CharacterAppearOutOfSightTo(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,S_RC_ARX_Barracks_Execution_Prisonercell_2338d803-7933-42ab-9d5a-a3e19b46c34a,0,0,"");
GlobalSetFlag("ARX_Barracks_ExecutionPrisoner_InPrison");

//-------Wife 
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",0)
THEN
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,1)
THEN
CharacterSetAnimationOverride(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"emotion_sad_looping1");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068)
AND
DB_IsPlayer(_Player)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",0)
THEN
CharacterSetAnimationOverride(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,"");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);
CharacterMoveToAndTalk(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,_Player,"RC_ARX_Barracks_PrisonersWife",0,"RC_ARX_Barracks_PrisonersWife_Ended",1,5.0);

 // Is triggered when movement on succuss as well. DOSTWO-21353
IF
CharacterMoveToAndTalkFailed(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,_Player,"RC_ARX_Barracks_PrisonersWife_Ended")
THEN
TriggerRegisterForPlayers(TRIGGERGUID_S_RC_ARX_Barracks_WifeStartDialog_a7d6b362-9667-444f-9924-d77991c17068);
//Proc_StartDialog(0,"RC_ARX_Barracks_PrisonersWife",S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,_Player);

IF
DialogEnded("RC_ARX_Barracks_PrisonersWife",_ID)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",0)
AND
DB_DialogNPCs(_ID,_NPC,1)
AND
ObjectGetFlag(_NPC,"RC_ARX_Barracks_WifeResumeBehaviour",1)
AND
QueryOnlyOnce("RC_ARX_Barracks_WifeResumeBehaviour")
THEN
SetHasDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,0);
ProcCharacterDisappearOutOfSight(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,90,0,"RC_ARX_Barracks_Execution_WifeLeft",0);

IF
StoryEvent(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719, "RC_ARX_Barracks_Execution_WifeLeft")
THEN
SetHasDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,1);
CharacterAppearOutOfSightTo(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719,S_RC_ARX_Wife_PostExectutionSpot_3fc0e276-1260-43aa-a426-951c11fc99fe,0,0,"");

//-------Kemm
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",0)
THEN
proc_RC_ARX_Barracks_Execution_KemmLeave();
Proc_SceneOver("RC_ARX_Barracks_ExecutionScene");

PROC
proc_RC_ARX_Barracks_Execution_KemmLeave()
THEN
//ProcCharacterDisappearOutOfSight(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,90,0,"RC_ARX_Barracks_KemmFinishedExecution",0);
ProcCharacterMoveTo(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Kemms_PostExecutionSpot_3a1e3ce3-767c-4ae3-b891-b9b36da45abb,0,"RC_ARX_Barracks_KemmFinishedExecution");
SetHasDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
ProcRemoveAllDialogEntriesForSpeaker(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
DB_AD_Dialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_AD_Kemm_WalkingHome");

IF
StoryEvent(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, "RC_ARX_Barracks_KemmFinishedExecution")
THEN
//CharacterAppearOutOfSightTo(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_KemmsMansion_PostExecutionSpot_3a1e3ce3-767c-4ae3-b891-b9b36da45abb,0,0,"");
CharacterSetFightMode(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0,0);
//SetHasDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
ProcRemoveNPCADs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm");

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
THEN
CharacterSetCanTrade(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
ObjectClearFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_Barracks_ExecutionEventStartAD");
//-------Guards
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
THEN
TimerLaunch("RC_ARX_Barracks_Guards_Go_ToPrison",1200); //Timer to make them move away in a more fluid way

IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Char,_) 
AND
DB_AD_Dialog(_Char,_Dialog)
THEN
NOT DB_AD_Dialog(_Char,_Dialog);


IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
DB_PostExecutionDialogsDialogs(_Char,_Dialog)
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_) 
THEN
DB_Dialogs(_Char,_Dialog);

IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",0)
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEndedCorpseStillThere",0)
THEN
Proc_ARX_Barracks_Guards_Go_ToPrison_FollowOrGo((CHARACTERGUID)_Guard);
SetHasDialog(_Guard,0);
ProcForceStopDialog(_Guard);

PROC
Proc_ARX_Barracks_Guards_Go_ToPrison_FollowOrGo((CHARACTERGUID)_Guard)
AND
CharacterCanSee(_Guard,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,1)
AND
GlobalGetFlag("ARX_Brracks_Guards_Go_ToPrison_Following",0)
THEN
CharacterFollowCharacter(_Guard,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
DB_ARX_Barracks_Guards_Go_ToPrison_Following(_Guard);
GlobalSetFlag("ARX_Brracks_Guards_Go_ToPrison_Following");
//ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
GlobalFlagSet("ARX_Brracks_Guards_Go_ToPrison_Following")
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_)
AND
NOT DB_ARX_Barracks_Guards_Go_ToPrison_Following((CHARACTERGUID)_Guard)
THEN
ProcCharacterMoveTo(_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
StoryEvent(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9, "RC_ARX_Barracks_ExecutedPaladinSparedReachedStairs")
AND
DB_ARX_Barracks_Guards_Go_ToPrison_Following(_Guard)
AND
GetDistanceTo(_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,_Dist)
THEN
proc_ARX_Barracks_Guards_Go_ToPrison_GoOrIsAlreadyThere((CHARACTERGUID)_Guard,_Dist);

PROC
proc_ARX_Barracks_Guards_Go_ToPrison_GoOrIsAlreadyThere((CHARACTERGUID)_Guard,(REAL)_Dist)
AND
_Dist < 3.0
THEN
SetStoryEvent(_Guard,"RC_ARX_Barracks_GuardReachedStairs");

PROC
proc_ARX_Barracks_Guards_Go_ToPrison_GoOrIsAlreadyThere((CHARACTERGUID)_Guard,_Dist)
AND
_Dist > 3.0
THEN
ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

PROC
Proc_ARX_Barracks_Guards_Go_ToPrison_FollowOrGo((CHARACTERGUID)_Guard)
AND
CharacterCanSee(_Guard,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",0)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEndedCorpseStillThere",1)
THEN
SetHasDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,0);
ProcForceStopDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4);
ProcCharacterMoveTo((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard1_f8473850-e68d-464a-92fe-0668c19f79e4,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
StoryEvent(_Guard,"RC_ARX_Barracks_GuardReachedStairs")
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_Trigger)
THEN
SetOnStage(_Guard,0);
CharacterAppearOutOfSightTo((CHARACTERGUID)_Guard,_Trigger,0,0,"ARX_Prison_ExecutionGuardAppeared");
CharacterSetReactionPriority(_Guard,"GuardPosition",100);

IF
StoryEvent(_Guard,"ARX_Prison_ExecutionGuardAppeared")
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_Trigger)
AND
GlobalGetFlag("RC_ARX_Barracks_ConvincedToSpare",1)
THEN
SetHasDialog(_Guard,1);
ItemSetOwner(BLD_Humans_Prison_Grating_Door_B_002_b149b405-f50a-4341-aea3-ed7fa585872a,(CHARACTERGUID)_Guard);
ItemCloseAndLock(BLD_Humans_Prison_Grating_Door_B_002_b149b405-f50a-4341-aea3-ed7fa585872a,"ARX_PrisonCells_Key");
DB_ARX_Prison_DoorsOnwership(_Guard);





//END_REGION

//REGION Prisoner In Combat

IF
CombatEnded(_ID)
AND
DB_WasInCombat(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_ID)
//DB_WasInCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ID) Removed this check as it fails when we one shot Kemm as he was never in the Combat
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
CharacterIsDead(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
NOT DB_GlobalFlag("RC_ARX_Barracks_ExecutionEvent")
AND
QueryOnlyOnce("ARX_Barracks_CheckIfKemmWasKilledInTheBarracks")
THEN
GlobalSetFlag("RC_ARX_Barracks_ConvincedToSpare");
proc_ARX_Barracks_Execution_KilledPaladins(_ID);

PROC
proc_ARX_Barracks_Execution_KilledPaladins((INTEGER)_CombatID)
AND
DB_IsPlayer(_Player)
AND
DB_WasInCombat(_Player,_CombatID)
AND
QRY_SpeakerIsAvailable(_Player)
AND
GetDistanceTo(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,_Dist)
AND
_Dist < 30.0
AND
GlobalGetFlag("RC_ARX_Barracks_Execution_KilledPaladins",0)
THEN
GlobalSetFlag("RC_ARX_Barracks_Execution_KilledPaladins");
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,"RC_ARX_Barracks_ExecutionPrisoner",0,"RC_ARX_Barracks_Execution_KilledPaladins",1,15.0,1,1);

IF
CharacterMoveToAndTalkFailed(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,"RC_ARX_Barracks_Execution_KilledPaladins")
THEN
SetHasDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0,1,"",0);

PROC
proc_ARX_Barracks_Execution_KilledPaladins((INTEGER)_CombatID)
AND
GlobalGetFlag("RC_ARX_Barracks_Execution_KilledPaladins",0)
THEN
GlobalSetFlag("RC_ARX_Barracks_Execution_KilledPaladins");
SetHasDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0,1,"",0);

IF
DialogEnded("RC_ARX_Barracks_ExecutionPrisoner",_ID)
AND
DB_GlobalFlag("RC_ARX_Barracks_Execution_KilledPaladins")
THEN
SetHasDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0);
CharacterDisappearOutOfSight(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0,1,"",0);

IF
DialogEnded("RC_ARX_Barracks_ExecutionPrisoner",_ID)
AND
DB_GlobalFlag("RC_ARX_Barracks_Execution_KilledPaladins")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Barracks_Execution_KilledAllPaladins");
//END_REGION

//REGION Dealing with the Corpse

IF
CharacterLeftTrigger(_Char,S_ARX_Barracks_Execution_RemoveCorpse_77363571-77e2-4d9f-a58b-22bd5aab90de)
AND
DB_IsPlayer(_Char)
AND
NOT DB_InRegion(_,S_ARX_Barracks_Execution_RemoveCorpse_77363571-77e2-4d9f-a58b-22bd5aab90de)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEndedCorpseStillThere",1)
THEN
GlobalClearFlag("RC_ARX_Barracks_ExecutionEndedCorpseStillThere");

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEndedCorpseStillThere")
AND
QRY_AnyRegionActive()
THEN
ProcCharacterMoveTo((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_ExecutionGuard2_cd5f4253-d085-440b-8e3b-2a26c4bbc4f8,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");
//SetOnStage(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0);
//END_REGION

//REGION Prisoner Is In Jail

IF
ItemOpened(ITEMGUID_S_BLD_Humans_Prison_Grating_Door_B_002_b149b405-f50a-4341-aea3-ed7fa585872a)
AND
CharacterIsDead(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
GlobalGetFlag("ARX_Barracks_ExecutionPrisoner_InPrison",1)
THEN
ProcForceStopDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
ObjectSetFlag(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"ARX_Prison_ArhusKeeper_Disapear");

IF
ItemDestroyed(ITEMGUID_S_BLD_Humans_Prison_Grating_Door_B_002_b149b405-f50a-4341-aea3-ed7fa585872a)
AND
CharacterIsDead(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
AND
GlobalGetFlag("ARX_Barracks_ExecutionPrisoner_InPrison",1)
THEN
ProcForceStopDialog(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);
ObjectSetFlag(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"ARX_Prison_ArhusKeeper_Disapear");

//END_REGION 

//REGION Scene Interaption
//Special case for attacking Kemm with Poision
IF
CharacterStatusAttempt(S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, "POISONED",(CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
THEN
Proc_SceneInterrupted(S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked");

PROC
Proc_SceneInterrupted(_NPC,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
CharacterIsDead(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
ProcForceStopDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

PROC
Proc_SceneInterrupted((CHARACTERGUID)_NPC,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
CharacterIsDead(_NPC,0)
THEN
CharacterSetTemporaryHostileRelation(_NPC,_Player);

PROC
Proc_SceneInterrupted(_NPC,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
_NPC != S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9
AND
_NPC != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
THEN
ProcForceStopDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719); // Just in Case 
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_Attacked");
proc_RC_ARX_Barracks_ExecutionSceneClose(1);
SetRelationIndivFactionToPlayers(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,100);

//Handles OneShot
PROC
Proc_SceneInterrupted((CHARACTERGUID)_NPC,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
CharacterIsDead(_NPC,1)
AND
DB_SceneManager(_OtherNPCs,"RC_ARX_Barracks_ExecutionScene")
AND
CharacterIsDead(_OtherNPCs,0)
AND
_OtherNPCs != S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9
AND
_OtherNPCs != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
THEN
Proc_CharacterSetTemporaryHostileRelation((CHARACTERGUID)_OtherNPCs,_Player);

PROC
Proc_SceneInterrupted(_NPC,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
_NPC == S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
THEN
ProcForceStopDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
ProcForceStopDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719); // Just in Case 
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_Attacked");
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
CharacterSetTemporaryHostileRelation(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);
proc_RC_ARX_Barracks_ExecutionSceneClose(1);
SetRelationIndivFactionToPlayers(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0);


PROC
Proc_SceneInterrupted(_NPC,_NULLPlayer,"RC_ARX_Barracks_ExecutionScene",_Reason)
AND
DB_GLO_GenericSceneManager_LeavingReason(_Reason)
AND
_NPC != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
THEN
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_Attacked");
ProcForceStopDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
proc_RC_ARX_Barracks_ExecutionSceneClose(1);

PROC
Proc_SceneInterrupted(_NPC,_NULLPlayer,"RC_ARX_Barracks_ExecutionScene",_Reason)
AND
DB_GLO_GenericSceneManager_LeavingReason(_Reason)
AND
_NPC != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,1)
THEN
CharacterSetTemporaryHostileRelation(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);

PROC
Proc_SceneInterrupted(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_NULLPlayer,"RC_ARX_Barracks_ExecutionScene",_Reason)
AND
DB_GLO_GenericSceneManager_LeavingReason(_Reason)
THEN
SetRelationIndivFactionToPlayers(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,100);

PROC
proc_RC_ARX_Barracks_ExecutionSceneEveryoneDraw()
AND
DB_SceneManager(_NPC,"RC_ARX_Barracks_ExecutionScene")
AND
_NPC != S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9
AND
_NPC != S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28
AND
_NPC != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
THEN
proc_DrawWeaponforXTime((CHARACTERGUID)_NPC,3000);


PROC
Proc_SceneInterrupted(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
ObjectGetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_PrisonerAttackedOnce",1)
THEN
ProcForceStopDialog(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
ProcForceStopDialog(S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719); // Just in Case 
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
CharacterSetTemporaryHostileRelation(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);
proc_RC_ARX_Barracks_ExecutionSceneClose(1);

PROC
Proc_SceneInterrupted(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
CharacterIsPlayer(_Player,1)
AND
ObjectGetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_PrisonerAttackedOnce",0)
AND
QRY_SpeakerIsAvailable(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
proc_RC_ARX_Barracks_ExecutionSceneEveryoneDraw();

PROC
Proc_SceneInterrupted(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,"RC_ARX_Barracks_ExecutionScene","Attacked")
AND
CharacterIsPlayer(_Player,1)
AND
ObjectGetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_PrisonerAttackedOnce",0)
AND
NOT QRY_SpeakerIsAvailable(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
DB_SceneManager(_NPC,"RC_ARX_Barracks_ExecutionScene")
AND
_NPC != S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9
AND
_NPC != S_RC_ARX_Barracks_PrisonersWife_8dc43bf7-827f-440a-9de5-c2a2eb0bc719
AND
QRY_SpeakerIsAvailable(_NPC)
AND
QueryOnlyOnce("RC_ARX_BarrackExecustion_GaveWarning")
THEN
Proc_StartDialog(1,"RC_ARX_AD_Execution_KemmSceneInterrupted",_NPC);
ObjectSetFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"RC_ARX_ExecutionSceneInterrupt_PrisonerAttackedOnce");
proc_RC_ARX_Barracks_ExecutionSceneEveryoneDraw();

PROC
proc_RC_ARX_Barracks_ExecutionSceneClose((INTEGER)_Interrupted)
THEN
GlobalClearFlag("RC_ARX_Barracks_ExecutionEvent");
TimerLaunch("RC_ARX_Barracks_ExecutionScene_CloseScene",100); // This gives us time to clear the AD dialogs and give back normal dialogs to the Paladins

PROC
proc_RC_ARX_Barracks_ExecutionSceneClose(1)
THEN
GlobalSetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted");

IF
TimerFinished("RC_ARX_Barracks_ExecutionScene_CloseScene")
THEN
Proc_SceneOver("RC_ARX_Barracks_ExecutionScene");


//-------Kemm
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
CharacterIsInCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0) //TODO: Sometimes this isn't fast eanough to catch if the is combat
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
CharacterAttack(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
CharacterIsInCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
proc_RC_ARX_Barracks_Execution_KemmLeave();

// Failsafe for the check on the Global Flag
IF
ObjectLeftCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ID)
AND
CharacterIsDead(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
CharacterAttack(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

IF
CharacterDied(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
CharacterIsInCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
DB_CombatCharacters(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, _ID)
THEN
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, _ID);

IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
CharacterIsInCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
DB_CombatCharacters(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, _ID)
THEN
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28, _ID);

IF
ObjectSwitchedCombat(_NPC,_OldID,_NewID)
AND
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(_NPC,_OldID)
THEN
NOT DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(_NPC,_OldID);
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(_NPC,_NewID);

IF
ObjectLeftCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ID)
AND
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ID)
THEN
proc_RC_ARX_Barracks_Execution_KemmLeave();

//-------Guards

IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_)
AND
CharacterIsInCombat((CHARACTERGUID)_Guard,0)
THEN
ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
TimerFinished("RC_ARX_Barracks_Guards_Go_ToPrison")
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionSceneInterrupted",1)
AND
DB_RC_ARX_Barracks_ExecutionGuards(_Guard,_)
AND
CharacterIsInCombat((CHARACTERGUID)_Guard,1)
AND
DB_CombatCharacters(_Guard,_ID)
THEN
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(_Guard,_ID);

IF
ObjectLeftCombat(_Guard,_ID)
AND
DB_RC_ARX_Barracks_ExecutionGuards((CHARACTERGUID)_Guard,_)
AND
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat(_Guard,_ID)
THEN
ProcCharacterMoveTo((CHARACTERGUID)_Guard,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_GuardReachedStairs");

IF
ObjectLeftCombat(_Prisoner,_ID)
AND
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat_Prisoner(_Prisoner,_ID)
THEN
ProcCharacterMoveTo(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_ExecutedPaladinSparedReachedStairs");
//END_REGION

//REGION Debug

IF
TextEventSet("ExecutionOver")
THEN
proc_RC_ARX_Barracks_ExecutionSceneClose(0);

IF
TextEventSet("SendKemmToVault")
THEN
Proc_ARX_KemmVault_ArhusPrison_SetKemm();

IF
TextEventSet("StopOverRide")
THEN
CharacterSetAnimationOverride(RC_Humans_Female_Paladin_000_ccdfda3c-4d67-42a4-a48f-665d71b259d9,"");

IF
TextEventSet("ARX_Barracks_SentWarOwls_ActII")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DF_PaladinCheckpoint_Finished");

IF
TextEventSet("ARX_Barracks_AttackPrisoner")
THEN
CharacterAttack(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);


IF
TextEventSet("ARX_Prisoner_MoveTo_Me")
THEN
CharacterMoveTo(CHARACTERGUID_S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,1,"",0);


IF
TextEventSet("SetKemmGhostIsbeilFlags")
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_ARX_TheImperialDwarves_Sewers_Q_IsDead");
UserSetFlag(_Player,"ARX_Sewers_Q_Ghost_ConsumedIsbeilSource");
GlobalSetFlag("RC_ARX_Sewers_Q_IsDead");


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
