Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57,"ARX_Neighborhood_HouseSchool_Mother");
DB_Dialogs(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840,"ARX_Neighborhood_HouseSchool_Kid");
DB_Children(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840);

DB_GiveItemToEvent(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Key2_33cafbcc-3cf4-4b5e-baa1-b3413dd51b37,"ARX_Neighborhood_HouseSchool_Mother_GiveKey");
DB_HasStoryEvent(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Key2_33cafbcc-3cf4-4b5e-baa1-b3413dd51b37,"ARX_Neighborhood_HouseSchool_Mother_HasKey");
ItemToInventory(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Key2_33cafbcc-3cf4-4b5e-baa1-b3413dd51b37,CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57);

DB_GiveItemToEvent(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Mother_Reward_8e806ec0-1c5d-4498-86c3-ca4569682005,"ARX_Neighborhood_HouseSchool_Mother_GiveReward");
DB_HasStoryEvent(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Mother_Reward_8e806ec0-1c5d-4498-86c3-ca4569682005,"ARX_Neighborhood_HouseSchool_Mother_HasReward");
ItemToInventory(ITEMGUID_S_ARX_Neighborhood_HouseSchool_Mother_Reward_8e806ec0-1c5d-4498-86c3-ca4569682005,CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57);

DB_ShovelArea(TRIGGERGUID_S_ARX_Neighborhood_PlaygroundTreasure_AreaTrig_d844a3e8-f3d0-4007-ba2f-46d484ef6646,"ARX_Neighborhood_PlaygroundTreasure",ITEMGUID_S_ARX_Neighborhood_PlaygroundTreasure_Mound_6fc3bb36-18b1-492e-8fb8-7256b3fed412);
DB_ShovelRewardItemAppear("ARX_Neighborhood_PlaygroundTreasure",ITEMGUID_S_ARX_Neighborhood_PlaygroundTreasure_Sword_dce677ea-963c-40da-9d6e-834dddfb6ebd,TRIGGERGUID_S_ARX_Neighborhood_PlaygroundTreasure_PointTrig_40d1144c-85e8-437b-b06a-d0bdd4301602);



//Hiding Puppet
SetTag(ARX_Neighborhood_School_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"SOURCE_PUPPET");
DB_Dialogs(ARX_Neighborhood_School_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_Neighborhood_HouseSchool_SourcePuppet");

DB_ARX_Neighborhood_School_SourcePuppet_Books(S_ARX_Neighborhood_HouseSchool_SourcePuppet_Book1_be73d194-784f-42c0-bfe1-9825980e949a);
DB_ARX_Neighborhood_School_SourcePuppet_Books(S_ARX_Neighborhood_HouseSchool_SourcePuppet_Book2_9ab455f8-8daf-485a-b24e-5bd291bf8d7c);
DB_ARX_Neighborhood_School_SourcePuppet_Books(S_ARX_Neighborhood_HouseSchool_SourcePuppet_Book3_fa57291a-de5a-4f56-81b8-cd3511ab94b5);

//Squatters 
DB_ARX_Neighborhood_HouseSchool_Squatter(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd);
DB_ARX_Neighborhood_HouseSchool_Squatter(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa);
DB_ARX_Neighborhood_HouseSchool_Squatter(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08);
DB_ARX_Neighborhood_HouseSchool_Squatter(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_2_b57a19db-6eed-4a02-b56b-c523c9f98793);DB_ARX_Neighborhood_HouseSchool_Squatter(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_3_14139f56-bdeb-4a23-9af7-2141ae7c3b71);

ProcCharacterDisableCrime(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa,"Steal");
ProcCharacterDisableCrime(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa,"UseForbiddenItem");
ProcCharacterDisableCrime(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa,"TeleportPlayerDialog");

//Dialogs
DB_Dialogs(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd,"ARX_Neighborhood_HouseSchool_Squatter_Priest");
DB_Dialogs(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa,"ARX_Neighborhood_HouseSchool_Squatter_Junkie");

DB_Dialogs(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_2_b57a19db-6eed-4a02-b56b-c523c9f98793,"ARX_Neighborhood_HouseSchool_Squatter_Junkie2");
DB_Dialogs(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_3_14139f56-bdeb-4a23-9af7-2141ae7c3b71,"ARX_Neighborhood_HouseSchool_Squatter_Junkie3");

DB_Dialogs(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_ConceredParent_8e4dd316-aa43-4f5f-9093-92f0a7f749fe,"ARX_Neighborhood_HouseSchool_ConcernedParent");

DB_Dialogs(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08,"ARX_Neighborhood_HouseSchool_Squatter_Thief");
DB_Children(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08);

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Neighborhood_HouseSchool_Mother_ReactToPlayer_5192557e-e937-4d0a-8aa9-9b3dae28e2e7);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_ARX_Neighborhood_HouseSchool_Squat_e292a874-7533-4c21-b535-7f2728f6a7cc);

DB_ARX_Neighborhood_HouseSchool_JunkieDialogs("ARX_Neighborhood_HouseSchool_Squatter_Junkie");
DB_ARX_Neighborhood_HouseSchool_JunkieDialogs("ARX_Neighborhood_HouseSchool_Squatter_Junkie2");
DB_ARX_Neighborhood_HouseSchool_JunkieDialogs("ARX_Neighborhood_HouseSchool_Squatter_Junkie3");

ItemToInventory(ITEMGUID_S_ARX_Neighborhood_HouseSchool_SourcePuppet_ScrapMetal_8a3d6a61-ac86-4d2a-8a4f-111481f1ec47,CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
ProcTriggerRegisterForPlayers(TRIGGERGUID_ARX_Neighborhood_HouseSchool_SourcePuppet_PlayerIsComing_d43309f0-4668-46bc-9059-15990c329959);

DB_DoNotFace(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd,"ARX_Neighborhood_HouseSchool_SawPriestDead");

DB_KilledEvent(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd,"ARX_Neighborhood_HouseSchool_KilledPriest");
DB_KilledEvent(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd,"QuestUpdate_ARX_Neighborhood_HouseSchool_KilledThePriest");
KBSECTION
//REGION Living Area
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Neighborhood_HouseSchool_Mother_ReactToPlayer_5192557e-e937-4d0a-8aa9-9b3dae28e2e7)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57)
AND
QueryOnlyOnce("S_ARX_Neighborhood_HouseSchool_Mother_ReactToPlayer")
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57,_Player);
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_Mother_ReactToPlayer",CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57);


IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Neighborhood_HouseSchool_SchoolRecords_b5ea393e-c431-8a95-3286-cabfeb9d9518,_Player)
AND
QueryOnlyOnce("ARX_Neighborhood_HouseSchool_SchoolRecords_PlayerReact")
THEN
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_SchoolRecords_PlayerReact",_Player);

IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_MotherShowKemmsSecret",_Player,_ID)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"ARX_KemmsRoom_Secret");

//END_REGION 

//REGION House School Squaters
IF
DB_ARX_Neighborhood_HouseSchool_Squatter(_Squatter)
THEN
ProcCharacterDisableCrime((CHARACTERGUID)_Squatter,"Vandalise");
ProcCharacterDisableCrime((CHARACTERGUID)_Squatter,"TeleportPlayerDialog");


PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_ARX_Neighborhood_HouseSchool_Squat_e292a874-7533-4c21-b535-7f2728f6a7cc)
THEN
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_ReactToSquat",_Player);

//Junkie
IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_Squatter_Junkie_Give_Drudanae",_Player,_ID)
AND
QryRemoveTaggedLocalItemsFromMagicPockets((CHARACTERGUID)_Player,"DRUDANAE",1)
THEN
DB_NOOP(1);

//Thief Kid
IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_Squatter_Thief_ToldAboutGuild",_Player,_ID)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"ARX_Sewers_ThievesGuild_HiddenDoor");
ProcShowMarker((CHARACTERGUID)_Player,"ARX_Barracks_SecretPassageToPrison");
//SetStoryEvent(ITEMGUID_S_ARX_Sewers_ThievesGuild_HiddenDoor_2a9ddab3-03d6-4694-b782-d2c53a911834,"RevealFromStory");

IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Sewers_ThievesGuild_HiddenDoor_2a9ddab3-03d6-4694-b782-d2c53a911834)
THEN
ProcHideMarker(_Player,"ARX_Sewers_ThievesGuild_HiddenDoor");

//Convince them to leave
IF
DialogEnded("ARX_Neighborhood_HouseSchool_Squatter_Priest",_ID)
AND
GlobalGetFlag("ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave",1)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
UserSetFlag((CHARACTERGUID)_Player,"ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave");

IF
DialogEnded("ARX_Neighborhood_HouseSchool_Squatter_Priest",_ID)
AND
GlobalGetFlag("ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave",1)
THEN
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_Squatter_Priest",CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squater_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd);
SetHasDialog(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squater_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd,0);

IF
AutomatedDialogEnded("ARX_Neighborhood_HouseSchool_AD_Squatter_Priest",_ID)
AND
GlobalGetFlag("ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave",1)
AND
DB_ARX_Neighborhood_HouseSchool_Squatter(_Squatter)
THEN
ProcForceStopDialog(_Squatter);
SetHasDialog(_Squatter,0);
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_Squatter,180,1,"ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave_Disappeared",1);

//Killing The Priest
IF
CharacterDied(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa,0)
THEN
ProcForceStopDialog(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa);
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_Squater_Junkie_ReactToPriestDead",CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squater_Junkie_38d54ee7-e0f2-427f-a5f7-a5a77fde9afa);

IF
CharacterDied(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Squatter_Priest_f284a46a-7f16-4ab3-8bda-2df2127f2acd)
AND
DB_ARX_Neighborhood_HouseSchool_Squatter(_Squatter)
AND
CharacterIsDead((CHARACTERGUID)_Squatter,0)
THEN
ProcForceStopDialog(_Squatter);
SetHasDialog(_Squatter,0);
ProcCharacterDisappearOutOfSight((CHARACTERGUID)_Squatter,180,1,"ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave_Disappeared",1);

IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_SawPriestDead",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"ARX_Neighborhood_HouseSchool_KilledPriest",0)
THEN
PartySetFlag(_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_PriestIsDead");
//END_REGION

//REGION Junkie_Squatter 

IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_Squatter_Junkie_RevealMarker",_Player,_ID)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"ARX_KemmsGarden_Hidden_Drudanae");

//END_REGION

//REGION Journal
IF
DialogEnded(_Dialog,_ID)
AND
DB_ARX_Neighborhood_HouseSchool_JunkieDialogs(_Dialog)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_MetHobosInTheSchool");

IF
DialogEnded("ARX_Neighborhood_HouseSchool_Squatter_Priest",_ID)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_MetPriest");

IF
DialogEnded("ARX_Neighborhood_HouseSchool_Squatter_Priest",_ID)
AND
GlobalGetFlag("ARX_Neighborhood_HouseSchool_Squatters_ConvincedToLeave",1)
AND
DB_DialogPlayers(_ID,_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_ConvicedPriestToLeave");

IF
CharacterDied(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Mother_b58bae11-7146-4682-bd0a-e1428276ba57)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_KilledMother");

IF //DB_QuestDef_State("ARX_Neighborhood_HouseSchool","ToldMotherPriestLeft",-1); Used to close it before any reward entry could trigger. There is a way to close it without a reward
DialogEnded("ARX_Neighborhood_HouseSchool_Mother",_ID)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag((CHARACTERGUID)_Player,"QuestUpdate_ARX_Neighborhood_HouseSchool_ToldMotherPriestLeft",1)
AND
QuestIsClosed(_Player,"ARX_Neighborhood_HouseSchool",0)
THEN
QuestClose(_Player,"ARX_Neighborhood_HouseSchool");
//END_REGION 

//REGION House School Source Puppet
IF
ObjectFlagSet("ARX_CreepyShop_ShowMarker",_Player,_ID)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"ARX_CreepyShop");
SetStoryEvent(S_ARX_CreepyShoop_2ndFloorSecretEntrence_052d277d-a139-4e65-a469-0957e188a91b,"RevealFromStory");

IF
ItemMoved(_Item)
AND
DB_ARX_Neighborhood_School_SourcePuppet_Books(_Item)
THEN
ObjectSetFlag(_Item,"ARX_Neighborhood_HouseSchool_SourcePuppet_BookMoved");

IF
CharacterUsedItem(_Player,S_ARX_CreepyShoop_2ndFloorSecretExit_e50c8f1c-704c-4740-9e32-83d51c35bd50)
AND
DB_IsPlayer(_Player)
AND
GetVarInteger(S_ARX_CreepyShoop_2ndFloorSecretEntrence_052d277d-a139-4e65-a469-0957e188a91b,"CurrentIsVisible",0)
THEN
SetStoryEvent(S_ARX_CreepyShoop_2ndFloorSecretEntrence_052d277d-a139-4e65-a469-0957e188a91b,"RevealFromStory");

/*
IF
CharacterMovedItem(_Player,_Item)
AND
DB_ARX_Neighborhood_School_SourcePuppet_Books(_Item)
AND
ObjectGetFlag(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_CreepyShop_SourcePuppet_IsOn",1)
AND
DB_IsPlayer(_Player)
AND
QRY_SpeakerIsAvailable(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(0,"ARX_Neighborhood_HouseSchool_SourcePuppet",S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player);
*/

IF
AttackedByObject(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player,_Summon,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ObjectSetFlag(_Player,"ARX_Neighborhood_HouseSchool_SourcePuppet_Attacked");

IF
AttackedByObject(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player,_Summon,_,_)
AND
ObjectGetFlag(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_CreepyShop_SourcePuppet_IsOn",1)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
QRY_SpeakerIsAvailable(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
THEN
CharacterSetAnimationSetOverride(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"");
NOT DB_DoNotFace(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
Proc_StartDialog(0,"ARX_Neighborhood_HouseSchool_SourcePuppet",S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player);


IF
AttackedByObject(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player,_Summon,_,_)
AND
ObjectGetFlag(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_CreepyShop_SourcePuppet_IsOn",1)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
QRY_SpeakerIsAvailable(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
THEN
Proc_StartDialog(1,"ARX_Neighborhood_HouseSchool_AD_SourcePuppet_Attacked",S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
ObjectClearFlag(_Player,"ARX_Neighborhood_HouseSchool_SourcePuppet_Attacked");

IF
DialogEnded("ARX_Neighborhood_HouseSchool_SourcePuppet",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,_Player)
AND
ObjectGetFlag(_Player,"ARX_Neighborhood_HouseSchool_SourcePuppet_Attacked",1)
THEN
ObjectClearFlag(_Player,"ARX_Neighborhood_HouseSchool_SourcePuppet_Attacked");

IF
DialogEnded("ARX_Neighborhood_HouseSchool_SourcePuppet",_Id)
AND
DialogGetInvolvedNPC(_Id,1,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
AND
ObjectGetFlag(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_CreepyShop_SourcePuppet_IsOn",1)
AND
ObjectGetFlag(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_Neighborhood_HouseSchool_FleeAfterDialog",1)
THEN
ApplyStatus(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"INVISIBLE",-1.0,1);
CharacterDisappearOutOfSight(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,0,1,"",1);

IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_Attack",_Player,_ID)
THEN
CharacterAttack((CHARACTERGUID)_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);

IF
AttackedByObject(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player,_Summon,_,_)
AND
ObjectGetFlag(_Player,"ARX_Neighborhood_HouseSchool_Attack",1)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
NOT DB_ARX_CreepyShop_SourceVamp_Puppet(_Player,S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
THEN
CharacterSetAnimationSetOverride(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"");
PlayAnimation(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"hit");
NOT DB_DoNotFace(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
CharacterLookAt(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player);
ObjectClearFlag(_Player,"ARX_Neighborhood_HouseSchool_Attack");


IF
CharacterDied(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30)
THEN
GlobalSetFlag("ARX_Neighborhood_HouseSchool_SourcePuppet_Gone");

IF
CharacterWentOnStage(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,0)
THEN
GlobalSetFlag("ARX_Neighborhood_HouseSchool_SourcePuppet_Gone");

IF
CharacterLeftTrigger(_Player,TRIGGERGUID_ARX_Neighborhood_HouseSchool_SourcePuppet_PlayerIsComing_d43309f0-4668-46bc-9059-15990c329959)
AND
DB_IsPlayer(_Player)
AND
NOT DB_InRegion(_,TRIGGERGUID_ARX_Neighborhood_HouseSchool_SourcePuppet_PlayerIsComing_d43309f0-4668-46bc-9059-15990c329959)
AND
QRY_AnyRegionActive()
THEN
SetStoryEvent(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"ARX_Neighborhood_HouseSchool_SourcePuppet_NoPlayerNearBy");


IF
ObjectFlagSet("ARX_Neighborhood_HouseSchool_PuppetWakedUp",_Player,_ID)
THEN
CharacterSetAnimationSetOverride(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"");
PlayAnimation(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,"Surprise_01");
NOT DB_DoNotFace(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30);
CharacterLookAt(S_ARX_Neighborhood_HouseSchool_SourcePuppet_12ef3e3e-3ec3-4904-8cbd-f9720d669e30,_Player);
//END_REGION
//see _CRIME_CrimeTriggers
IF
AttackedByObject(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840,_,_Attacker,_,_)
AND
CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840 != _Attacker
AND
ObjectGetFlag(CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840,"GEB_FleeOutOfSight",0)
THEN
Proc_StartDialog(1,"GEB_AD_CallForHelp",CHARACTERGUID_S_ARX_Neighborhood_HouseSchool_Kid_be1a9a3e-aa0d-45e0-aa24-8da9f8a1c840);


IF
AttackedByObject(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08,_,_Attacker,_,_)
AND
CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08 != _Attacker
AND
ObjectGetFlag(CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08,"GEB_FleeOutOfSight",0)
THEN
Proc_StartDialog(1,"GEB_AD_CallForHelp",CHARACTERGUID_ARX_Neighborhood_HouseSchool_Squatter_Thief_72d4ccdd-1ae1-4dec-99b3-80306f3c4b08);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
