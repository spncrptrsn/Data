Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94,"FTJ_ShakedownEvent");
DB_FTJ_ShakedownBrutes((CHARACTERGUID)CHARACTERGUID_S_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
DB_FTJ_ShakedownBrutes((CHARACTERGUID)S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);

DB_FTJ_ShakeDownNPCs((CHARACTERGUID)S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
DB_FTJ_ShakeDownNPCs(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
DB_FTJ_ShakeDownNPCs(S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_ShakedownEventSaw_Box_86575c24-ef13-4c5c-a30e-5aa6ab23d337);

ItemToInventory(ITEMGUID_S_FTJ_Limb_ElodiHead_999a3538-2fa9-476c-8d6d-da99da0827a8, CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
DB_GiveItemToEvent(ITEMGUID_S_FTJ_Limb_ElodiHead_999a3538-2fa9-476c-8d6d-da99da0827a8,"FTJ_GiveElodiHead");
CharacterSetCanTrade(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,0);

DB_NoLowAttitudeDialog(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
Proc_FTJ_Shakedown_Init();
KBSECTION
PROC
Proc_FTJ_Shakedown_Init()
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
SetFaction(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"FTJ_ShakeDownElf");


PROC
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,(CHARACTERGUID)_Char)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
ProcMakeNPCHostile(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Char);
/*
PROC
Proc_RC_FTJ_EndShakedown()
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
SetFaction(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"Origin_Ifan");
*/
PROC
PROC_GLOBAL_DialogStartRequested((CHARACTERGUID)_NPC,_Player)
AND
DB_FTJ_ShakeDownNPCs(_NPC)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
AND
CharacterIsDead(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,0)
AND
GetDistanceTo(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Dist)
AND
_Dist < 18.0
AND
NOT DB_OnlyOnce("FTJ_ShakedownEvent_End")
THEN
DialogRequestStop(_NPC);
Proc_StartDialog(0,"FTJ_ShakedownEvent",RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94,_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
CharacterSetRelationIndivFactionToIndivFaction(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,100);

//Add Ifan to dialog if not Avatar
PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
AND
NOT DB_OnlyOnce("FTJ_ShakedownEvent_End")
THEN
DialogRequestStop(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);
Proc_StartDialog(0,"FTJ_ShakedownEvent",RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94,_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);

//Stop AD if combat starts
IF
ObjectEnteredCombat((CHARACTERGUID)_Participant,_)
AND
DB_FTJ_ShakeDownNPCs(_Participant)
THEN
DialogRequestStop(_Participant);

//REGION Brute Shakedown //http://fileserver-dmz/mediawiki/index.php/Brute_Shakedown
IF
CharacterDied(_Char)
AND
DB_FTJ_ShakeDownNPCs(_Char)
THEN
Proc_RC_FTJ_EndShakedown();

IF
DialogStarted("FTJ_ShakedownEvent",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
PartySetFlag(_Player,"FTJ_SawBrutesTerrorizing");

PROC
Proc_RC_FTJ_EndShakedown()
AND
QueryOnlyOnce("FTJ_ShakedownEvent_End")
THEN
PROC_RemoveDialogFromCharacter(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
PROC_RemoveDialogFromCharacter(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
PROC_RemoveDialogFromCharacter(S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);
DB_Dialogs(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,"FTJ_ShakedownElf");
DB_Dialogs(CHARACTERGUID_S_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,"FTJ_ShakedownBrute");
DB_Dialogs(CHARACTERGUID_S_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94,"FTJ_GhettoBossGuard_002");
NOT DB_NoStealingReaction(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
NOT DB_NoStealingReaction(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
NOT DB_NoStealingReaction(S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94);
SetVarFixedString(S_RC_FTJ_OlgoGuard_002_6d445f10-dec4-4026-9d9f-5b1c3fcd3e94,"currentState","State_Default");
SetVarFixedString(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,"currentState","State_Default");
CharacterSetReactionPriority(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,"MoveToDefaultPos",1000);
DB_FTJ_SaheilaAllies(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
CharacterSetCanTrade(RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,1);

IF 
DialogEnded("FTJ_ShakedownEvent",_ID)
AND 
GlobalGetFlag("FTJ_Shakedown_SideElf",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN 
Proc_RC_FTJ_EndShakedown();
UserSetFlag(_Player,"FTJ_AddElodiAttitude");
UserSetFlag(_Player,"FTJ_HelpedAgainstShakedownBrutes");
PartySetFlag(_Player,"GLO_SetTag_HERO");
CharacterSetRelationFactionToFaction("FTJ_ShakeDownElf","Hero",100);
CharacterSetRelationFactionToFaction("Hero","FTJ_ShakeDownElf",100);
ProcMakeNPCHostile(_Player,S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6);
ProcMakeNPCHostile(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Elodi_ElodiRescued");

IF 
DialogEnded("FTJ_ShakedownEvent",_ID)
AND 
GlobalGetFlag("FTJ_Shakedown_SideBrutes",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN 
Proc_RC_FTJ_EndShakedown();
UserSetFlag(_Player,"FTJ_AddShakedownBrutesAttitude");
ProcMakeNPCHostile(_Player,CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
ProcMakeNPCHostile(S_RC_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);
PartySetFlag(_Player,"GLO_SetTag_VILLAIN");

IF 
DialogEnded("FTJ_ShakedownEvent",_ID)
AND 
GlobalGetFlag("FTJ_Shakedown_Neutral",1)
THEN 
Proc_RC_FTJ_EndShakedown();
ProcMakeNPCHostile(CHARACTERGUID_S_FTJ_ShakedownDwarf_0991b582-8305-4259-8280-a55bbe32a1b6,CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789);


IF 
DialogEnded("FTJ_ShakedownEvent",_ID)
AND 
GlobalGetFlag("FTJ_Shakedown_Neutral",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player,-5);

//Peaceful resolution
IF 
DialogEnded("FTJ_ShakedownEvent",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND 
GlobalGetFlag("FTJ_Shakedown_Peace",1)
THEN 
Proc_RC_FTJ_EndShakedown();
UserSetFlag(_Player,"FTJ_AddElodiAttitude");
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,20);
CharacterSetRelationFactionToFaction("FTJ_ShakeDownElf","Hero",100);
CharacterSetRelationFactionToFaction("Hero","FTJ_ShakeDownElf",100);
PartyAddExperience(_Player,1,2,5);
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Elodi_ElodiRescued");
PartySetFlag(_Player,"GLO_SetTag_HERO");
Proc_StartDialog(0,"FTJ_ShakedownElfThanksPlayer",(CHARACTERGUID)RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player);

IF
ObjectFlagSet("FTJ_AddElodiAttitude",(CHARACTERGUID)_Player,_)
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,50);
CharacterSetRelationFactionToFaction("FTJ_ShakeDownElf","Hero",100);
CharacterSetRelationFactionToFaction("Hero","FTJ_ShakeDownElf",100);

IF
ObjectFlagSet("FTJ_AddElodiAttitude",(CHARACTERGUID)_Player,_)
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player,10);

IF
ObjectFlagSet("FTJ_AddShakedownBrutesAttitude",(CHARACTERGUID)_Player,_)
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
AND
DB_FTJ_ShakedownBrutes((CHARACTERGUID)_Brute)
THEN
CharacterAddAttitudeTowardsPlayer(_Brute,_Player,50);


IF
ObjectFlagSet("FTJ_AddShakedownBrutesAttitude",(CHARACTERGUID)_Player,_)
AND
NOT QRY_IsSummonOrPartyFollower(_Player)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,_Player,-20);


//REGION Sebille Custom Scripting

IF
ObjectFlagSet("FTJ_Shakedown_KnockDown",(CHARACTERGUID)_Char,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
CharacterLookAt(_Player,_Char);
PlayAnimation(_Player,"skill_trip_cast");
ApplyStatus(_Char,"KNOCKED_DOWN",16.0,1);
//CharacterSetAnimationOverride(_Char,"knockdown_loop");

IF
ObjectFlagSet("FTJ_ShakeDown_MoveTo",(CHARACTERGUID)_Char,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
CharacterMoveTo(_Char,_Player,0,"",0);

IF
ObjectFlagSet("FTJ_Shakedown_Cripple",_Char,_)
THEN
ApplyStatus(_Char,"CRIPPLED",-1.0,1);

//END_REGION

//REGION Combat joined
//Check for players who joined combat against the Shakedown Brutes
IF
ObjectEnteredCombat((CHARACTERGUID)_Player,_ID)
AND
DB_IsPlayer(_Player)
AND
DB_FTJ_ShakedownBrutes(_Brute)
AND
DB_CombatCharacters(_Brute,_ID)
AND
DB_CombatCharacters(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_ID)
AND
CharacterGetRelationToCharacter(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,_Relation)
AND
_Relation != 0
THEN
UserClearFlag(_Player,"FTJ_Shakedown_Neutral",0);
GlobalClearFlag("FTJ_Shakedown_Neutral");
ObjectSetFlag(_Player,"FTJ_HelpedAgainstShakedownBrutes");

IF
ObjectEnteredCombat(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_ID)
AND
DB_IsPlayer(_Player)
AND
DB_FTJ_ShakedownBrutes(_Brute)
AND
DB_CombatCharacters(_Player,_ID)
AND
DB_CombatCharacters(_Brute,_ID)
AND
CharacterGetRelationToCharacter(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,_Relation)
AND
_Relation != 0
THEN
UserClearFlag(_Player,"FTJ_Shakedown_Neutral",0);
GlobalClearFlag("FTJ_Shakedown_Neutral");
ObjectSetFlag(_Player,"FTJ_HelpedAgainstShakedownBrutes");


//Go hostile to Elodi and remove the help flag
IF
CharacterRelationChangedTo(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,0)
AND
DB_IsPlayer(_Player)
THEN
UserClearFlag(_Player,"FTJ_HelpedAgainstShakedownBrutes", 0);

IF
StoryEvent(_,"FTJ_ShakedownElfStartDialogWithPlayer")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player, "FTJ_HelpedAgainstShakedownBrutes", 1)
THEN
UserSetFlag(_Player, "FTJ_Shakedown_SavedElodi");


IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_ShakedownElfStartDialogWithPlayer")
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f)
AND
IsTagged(CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f,"AVATAR",0)
AND
QueryOnlyOnce("FTJ_ShakedownElfStartDialogWithPlayer")
THEN
Proc_StartDialog(0,"FTJ_ShakedownElfThanksPlayer",(CHARACTERGUID)RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,CHARACTERGUID_S_Player_Ifan_ad9a3327-4456-42a7-9bf4-7ad60cc9e54f);


IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_ShakedownElfStartDialogWithPlayer")
AND
QueryOnlyOnce("FTJ_ShakedownElfStartDialogWithPlayer")
THEN
Proc_StartDialog(0,"FTJ_ShakedownElfThanksPlayer",(CHARACTERGUID)RC_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player);



//END_REGION
//END_REGION

//REGION Kill Elodi conditions
IF
CharacterEnteredTrigger((CHARACTERGUID)_Player,TRIGGERGUID_S_FTJ_ShakedownEventSaw_Box_86575c24-ef13-4c5c-a30e-5aa6ab23d337)
AND
QueryOnlyOnce("FTJ_ShakedownEventHasBeenSeen")
THEN
DB_FTJ_ShakedownEventSeen(1);

IF
CharacterLeftTrigger(_Player,TRIGGERGUID_S_FTJ_SUB_Ghetto_19107918-c6d6-4c93-a377-e8a76c8d0f27)
AND
DB_IsPlayer(_Player)
AND
NOT DB_OnlyOnce("FTJ_ShakedownEvent_End")
AND
DB_OnlyOnce("FTJ_ShakedownEventHasBeenSeen")
AND
GetClosestPlayer(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_ClosestPlayer,_)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,0)
AND
CharacterCanSee(_ClosestPlayer,CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,0)
AND
GetDistanceTo(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,_Player,_Dist)
AND
_Dist > 35.0
THEN
CharacterDie(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789,0,"DoT");


//END_REGION

IF
CharacterDied(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789)
AND
DB_IsPlayer(_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Elodi_ElodiDead");

IF
ItemRemovedFromCharacter(ITEMGUID_S_FTJ_Limb_ElodiHead_999a3538-2fa9-476c-8d6d-da99da0827a8, CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789)
THEN
ObjectSetFlag(CHARACTERGUID_S_FTJ_ShakedownElf_c854185f-ce11-416f-b327-d692a5e3a789, "FTJ_LostHead");


PROC
ProcRegionEnded("FJ_FortJoy_Main")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
