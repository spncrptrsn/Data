Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Kemm_DisappearOutOfSightToObject("MagisterVault",ITEMGUID_S_Barracks_BurntRoom_EncryptedHatch_6d5ccd8a-a3e6-48ef-b279-99ce87bc9f11);
DB_Kemm_DisappearOutOfSightToObject("ArhusRoom",ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);
DB_Kemm_DisappearOutOfSightToObject("KemmVault",ITEMGUID_S_ARX_KemmVault_SecretEntrance_Ent_38b137bb-2d1b-4ef7-b685-1cef60049212);


DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541);
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e);
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387);
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba);
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae);
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07); 
DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999); 
 
//Paladins Searching For Evidence
//Barracks
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_01_e40ef41f-74ac-49c5-843d-6a2902db393b);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_02_4ea9dc08-799e-4237-9ce6-6dfbb64f8d0e);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_03_b86fc2ba-f162-4bcd-b646-d9f2f500e35a);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_04_f7794457-7f0b-488a-8852-fd64993a0505); 
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_05_ced49b91-5bc0-437a-9d16-f1b5ff3a4c1b); 
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_06_ca1b8c10-22ad-43cf-ad54-1ca583dadbd5);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"RC_ARX_Barracks_ExecutionEvent_Ended",SPLINEGUID_S_ARX_Barracks_EvidenceSearchSpline_Paladin_07_28770cd9-a67f-4f26-aee3-f87b73f7e199);
//White Magister Vault
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_01_d4a5ef71-94b7-450a-9f43-f322d9d05e57);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_02_cd455502-5e44-49be-8ec2-954feabcd2bf);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_03_0d712b97-2d4d-44b3-9d5b-ce705d08fe1d);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_04_82237824-d0d5-4a69-b5fd-5c865cac393e);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_05_a3174f02-c1b8-4a2b-befe-7c3d0647fd09);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared",SPLINEGUID_S_ARX_WhiteMagisterVault_EvidenceSearchSpline_Paladin_06_ccca1573-a130-426b-b1b2-9eff3cff55d2);

//Arhu's Room 
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_01_e5f429eb-4a2a-484a-b675-03990fb66541,"ARX_Cathedral_DisapArhu_PaladinAppeared",SPLINEGUID_S_ARX_Cathedral_DisapArhu_EvidenceSearchSpline_Paladin_01_b66f3f0f-8ef8-4693-83cb-92e964ee8617);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_02_ec5ee593-00e8-4356-a955-71336fd39e6e,"ARX_Cathedral_DisapArhu_PaladinAppeared",SPLINEGUID_S_ARX_Cathedral_DisapArhu_EvidenceSearchSpline_Paladin_02_80c6c187-3fd1-4ca3-9d54-427ae55e2b9b);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_03_342b305c-5eb6-4d2d-a14b-8e50d77b6387,"ARX_Cathedral_DisapArhu_PaladinAppeared",SPLINEGUID_S_ARX_Cathedral_DisapArhu_EvidenceSearchSpline_Paladin_03_359808a1-8781-4b92-8798-2c371dfb60a3);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_04_7a4c0e5a-607c-4296-b500-762ae00195ba,"ARX_Cathedral_DisapArhu_PaladinAppeared",SPLINEGUID_S_ARX_Cathedral_DisapArhu_EvidenceSearchSpline_Paladin_04_c63d59d9-8520-4557-afa9-c20e963b9863);
DB_ARX_Barracks_KemmsPaladins_Searching_Splines((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_05_c61c595c-48f0-4cb2-bee9-19746af03bae,"ARX_Cathedral_DisapArhu_PaladinAppeared",SPLINEGUID_S_ARX_Cathedral_DisapArhu_EvidenceSearchSpline_Paladin_05_75fe2cd5-00cc-4411-9332-177ab33eef31);

SetOnStage(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_OnKemm_a6fc34b8-f020-4efa-a803-f35c0d7e8783,0); //Kemm Has the key to Arhu's Place, he uses it to open his balconey 
DB_HasStoryEvent(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_OnKemm_a6fc34b8-f020-4efa-a803-f35c0d7e8783,"ARX_Kemm_HasArhus_Key");

//REGION Flags
DB_ARX_Kemm_BlackRingKnowledge("ARX_KemmMansion_Attic_Knows_BlackringMirror");
DB_ARX_Kemm_BlackRingKnowledge("ARX_KnowsAboutKemmEighth");

DB_ARX_Kemm_MissingPaintingKnowledge("ARX_KemmVault_KnowsAboutGhostPainting");
DB_ARX_Kemm_MissingPaintingKnowledge("ARX_Sewers_ThievesGuild_ThiefLeader_SucceededPersuasion_PaintingOrigin");
DB_ARX_Kemm_MissingPaintingKnowledge("QuestUpdate_ARX_KemmVault_ThievesGuild_KnowPainting");

DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_ThievesGuild_KnowPainting");
DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_PaladinRumor");
DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_AppraiserSecret");
DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_KemmVault_AtticLetter");
DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_KemmVault_LowerWater");
DB_ARX_Kemm_VaultKnowledge("ARX_Sewers_ThievesGuild_ThiefLeader_SucceededPersuasion_PaintingOrigin");
DB_ARX_Kemm_VaultKnowledge("ARX_Prison_Windego_Mentioned_SwornBreaker");

DB_ARX_QuestDef_DeadCharacterUpdates(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_SawDeadKemm");
//END_REGION

//REGION Kemms Combat Paladins
DB_ARX_Kemm_CombatPaladin((CHARACTERGUID)CHARACTERGUID_S_ARX_KemmsPersonal_Paladin_Healer_64eca748-71b1-4cd2-afd4-6a130a6e0ddf);
DB_ARX_Kemm_CombatPaladin(CHARACTERGUID_S_ARX_KemmsPersonal_Paladin_Ranger_d0323ce9-586a-4227-8022-56bb38890b70);
DB_ARX_Kemm_CombatPaladin(CHARACTERGUID_S_ARX_KemmsPersonal_Paladin_Tank_118fef6e-afda-4674-a839-449d7feb5530);

//END_REGION

Proc_ARX_Kemm_SetUpCrime();
DB_SeenDeadNPCPartyFlag(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_Party_SawKemmDead");
KBSECTION
//REGION Paladins Initiate Searching Beahvour
//Barracks Execution Ended
IF
GlobalFlagCleared("RC_ARX_Barracks_ExecutionEvent")
AND
DB_ARX_Barracks_KemmsPaladins(_Paladin)
THEN
SetStoryEvent(_Paladin,"RC_ARX_Barracks_ExecutionEvent_Ended");

IF
StoryEvent((CHARACTERGUID)_Paladin,_Event)
AND
DB_ARX_Barracks_KemmsPaladins_Searching_Splines(_Paladin,_Event,_Spline)
THEN
SetVarObject(_Paladin,"SplineGUID",_Spline);
SetStoryEvent(_Paladin,"InterruptPatrol");
SetStoryEvent(_Paladin,"InitiateSplinePatrol");
ClearVarObject(_Paladin,"previousPos"); //Part of DangerousSurfaces_Fallback. If they were waiting for a Surface to disappear it will reset that behaviour
//END_REGION

//REGION Trigger Kemms Appearance Magister Vault

IF
CharacterDying(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7)
AND
CharacterIsInCombat(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,1)
AND
CombatGetIDForCharacter(S_RC_DW_WhiteMagister_b1bdd004-a286-4ad5-9826-a763d672b2a7,_CombatID)
THEN
DB_Barracks_WhiteMagisterVault_KemmAppearance_AfterCombat(_CombatID);

IF
CombatEnded(_CombatID)
AND
DB_Barracks_WhiteMagisterVault_KemmAppearance_AfterCombat(_CombatID)
THEN
NOT DB_Barracks_WhiteMagisterVault_KemmAppearance_AfterCombat(_CombatID);
TimerLaunch("ARX_Barracks_WhiteMagisterVault_KemmAppear_Timer",30000); //This is a fallback if the player didn't talk to Reimond's ghost nor opened his journal 

IF
DialogEnded("ARX_Barracks_WhiteMagisterVault_WhiteMagisterGhost",_ID)
AND
GlobalGetFlag("ARX_Barracks_WhiteMagisterVault_KemmAppear",0)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag(_Player,"ARX_Barracks_PlayerKnows_WhiteMagisterTruth",1)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_KemmAppear_OnlyOnce")
THEN
proc_ARX_Barracks_WhiteMagisterVault_StartKemmAppearTimer();

IF
GameBookInterfaceClosed(S_ARX_Barracks_WhiteMagisterVault_ReimondsJournal_aeb8cffd-a213-4279-931c-3f73967efa4f,_Player)
AND
GlobalGetFlag("ARX_Barracks_WhiteMagisterVault_KemmAppear",0)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_KemmAppear_OnlyOnce")
THEN
proc_ARX_Barracks_WhiteMagisterVault_StartKemmAppearTimer();

PROC
proc_ARX_Barracks_WhiteMagisterVault_StartKemmAppearTimer()
THEN
TimerCancel("ARX_Barracks_WhiteMagisterVault_KemmAppear_Timer");
TimerLaunch("ARX_Barracks_WhiteMagisterVault_KemmAppear_Timer",3000);

IF
TimerFinished("ARX_Barracks_WhiteMagisterVault_KemmAppear_Timer")
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
GlobalGetFlag("ARX_Cathedral_DisapArhu_KemmAppeared",0)
AND
GlobalGetFlag("ARX_InitiateGenocide",0)
THEN
NOT DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999); //Leaves one paladin behind
SetCombatGroupID(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"");
Proc_ARX_Kemm_MoveToNextLocation("MagisterVault");
//END_REGION

//REGION Kemm Appearing the Magister Vault

IF
StoryEvent((CHARACTERGUID)_Character,"ARX_Kemm_AppearAt_MagisterVault")
THEN
CharacterAppearOutOfSightToObject(_Character,TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,0,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared");
SetHasDialog(_Character,1);

IF
StoryEvent(_Character,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
DB_AD_Dialog(_Character,_Dialog)
THEN
ProcRemoveNPCADs(_Character);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
THEN
GlobalSetFlag("ARX_Barracks_WhiteMagisterVault_KemmAppear");
ClearVarObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"Seat");

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
NOT DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_)
THEN
DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm"); 

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
ItemIsDestroyed(ITEMGUID_S_ARX_WhiteMagisterVault_KemmChair_e9d751ac-669e-4a5f-962d-d6052c049614,0)
THEN
SetVarObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"Seat",ITEMGUID_S_ARX_WhiteMagisterVault_KemmChair_e9d751ac-669e-4a5f-962d-d6052c049614);
ClearVarObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"SeatStartPosition");
CharacterSetReactionPriority(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"GatherSeatInfo",1142);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15)
AND
GetClosestAlivePlayer(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ClosestPlayer,_)
AND
NOT DB_ARX_Barracks_WhiteMagisterVault_KemmIsMovingToTalk(1)
THEN
DB_ARX_Barracks_WhiteMagisterVault_KemmIsMovingToTalk(1);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ClosestPlayer,"ARX_Kemm",0,"ARX_Barracks_WhiteMagisterVault_KemmTalkToPlayer",1,30.0,1,0);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
NOT DB_ARX_Barracks_WhiteMagisterVault_KemmIsMovingToTalk(1)
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
//DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28); 

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Barracks_WhiteMagisterVault_PaladinAppeared")
AND
DB_ARX_Barracks_WhiteMagisterVault_KemmIsMovingToTalk(1)
THEN
NOT DB_ARX_Barracks_WhiteMagisterVault_KemmIsMovingToTalk(1);

IF
CharacterMoveToAndTalkFailed(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"ARX_Barracks_WhiteMagisterVault_KemmTalkToPlayer")
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
//DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
CharacterMoveToAndTalkRequestDialogFailedEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"ARX_Barracks_WhiteMagisterVault_KemmTalkToPlayer")
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
//DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
CharacterCharacterEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"ARX_Kemm_StartDialogOnSight")
THEN
Proc_StartDialog(0,"ARX_Kemm",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);
/*
//Kemm Onwership over the Vault
IF
DialogEnded("ARX_Kemm",_)
AND
NOT DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
GlobalGetFlag("ARX_Barracks_WhiteMagisterVault_KemmAppear",1)
AND
QueryOnlyOnce("ARX_Barracks_WhiteMagisterVault_KemmAppear_SetupOwnership")
THEN
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_RegionTrigger_c03d300b-0c04-425e-8af0-8644cb5a1c15,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
DB_ARX_KemmMansion_OwnershipIgnore((ITEMGUID)ITEMGUID_S_ARX_Barracks_VaultStaircaseToArchives_17223372-6923-42b1-a318-00797f4856d9);
DB_ARX_KemmMansion_OwnershipIgnore((ITEMGUID)ITEMGUID_S_ARX_Barracks_WhiteMagisterVault_ToArchives_3345cde5-07ef-4361-b9fb-388d623b1aac);
*/
//END_REGION 

//REGION Trigger Kemm Appearing in Arhus Room
//Trigger the appear
IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Cathedral_DisapArhu_Journal_794e8f40-6aa5-411f-b4f2-2cbede844908,_Player)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppear_Timer_Started")
THEN
TimerLaunch("ARX_Cathedral_DisapArhu_KemmAppear_Timer",5000);

IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Cathedral_DisappearanceOfArhu_KemmRequest_3bf778f9-1e30-4bc1-83d5-0babbf46f2b9,_Player)
AND
GlobalGetFlag("ARX_KemmVault_Arhu_InCathedral",0)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppear_Timer_Started")
THEN
TimerLaunch("ARX_Cathedral_DisapArhu_KemmAppear_Timer",5000);

IF
TimerFinished("ARX_Cathedral_DisapArhu_KemmAppear_Timer")
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",0)
AND
GlobalGetFlag("ARX_InitiateGenocide",0)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppear_Timer")
THEN
NOT DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07); //Leaves one paladin behind
NOT DB_ARX_Barracks_KemmsPaladins((CHARACTERGUID)CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999); 
SetCombatGroupID(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"");
SetCombatGroupID(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"");
Proc_ARX_Kemm_MoveToNextLocation("ArhusRoom");

IF
TimerFinished("ARX_Cathedral_DisapArhu_KemmAppear_Timer")
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppear_Timer")
THEN
Proc_ARX_Cathedral_DisapArhu_InitiateMoveToCrimeScene();

IF
TimerFinished("ARX_Cathedral_DisapArhu_KemmAppear_Timer") // Just in case there is another player in Arhu's room while Kemm is in his vault
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_KemmAppeared",1)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppear_Timer")
THEN
Proc_ARX_Cathedral_DisapArhu_InitiateMoveToCrimeScene();

//END_REGION

//REGION Kemm Appearing in Arhus Room
IF
StoryEvent((CHARACTERGUID)_Character,"ARX_Kemm_AppearAt_ArhusRoom")
AND
_Character != S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28
THEN
ProcObjectTimer(_Character,"ARX_AppearAt_ArhusRoom",2000); // Gives time for Kemm to appear and enter to the room

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Character,"ARX_AppearAt_ArhusRoom")
THEN
CharacterAppearOutOfSightToObject(_Character,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_OutPoint_acbbd023-9c2b-4131-9658-3396c4598f4f,TRIGGERGUID_S_ARX_Cathedral_Pilgrims_LookAtPoint_2c234fcf-7d85-4d0c-a13a-476db03b3b11,0,"ARX_Cathedral_DisapArhu_PaladinAppeared");
SetHasDialog(_Character,1);

IF
StoryEvent(_Character,"ARX_Kemm_AppearAt_ArhusRoom")
AND
DB_AD_Dialog(_Character,_Dialog)
THEN
ProcRemoveNPCADs(_Character);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_AppearAt_ArhusRoom")
THEN
CharacterAppearOutOfSightToObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_OutPoint_acbbd023-9c2b-4131-9658-3396c4598f4f,TRIGGERGUID_S_ARX_Cathedral_Pilgrims_LookAtPoint_2c234fcf-7d85-4d0c-a13a-476db03b3b11,0,"ARX_Cathedral_DisapArhu_PaladinAppeared");
SetHasDialog(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);
ProcRemoveDBTrespassTrigger(S_ARX_Cathedral_DisapArhu_TrespassPoly_35235753-3891-4aa7-9446-0f77f5d542d2,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_OutPoint_acbbd023-9c2b-4131-9658-3396c4598f4f);
Proc_ARX_Cathedral_DisapArhu_StopAllCrimes();
GlobalSetFlag("ARX_Cathedral_DisapArhu_KemmAppeared");
GlobalSetFlag("ARX_Cathedral_KemmAppeared_AutoStartedDialog");
Proc_ARX_Cathedral_DisapArhu_PrepMoveToCrimeScene();
ClearVarObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"Seat");
SetVarFixedString(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"currentState","Default_InArhusRoom");
SetOnStage(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_OnKemm_a6fc34b8-f020-4efa-a803-f35c0d7e8783,1);
ItemToInventory(ITEMGUID_S_ARX_Cathedral_DisapArhu_Key_OnKemm_a6fc34b8-f020-4efa-a803-f35c0d7e8783,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Cathedral_DisapArhu_PaladinAppeared")
AND
NOT DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_)
THEN
DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm"); 


//Handlding Kemm Appearing
IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Cathedral_DisapArhu_PaladinAppeared")
AND
DB_IsPlayer(_Player)
AND
DB_InRegion(_Player,TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604)
AND
GetClosestAlivePlayer(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_ClosestPlayer,_)
AND
NOT DB_ARX_Cathedral_DisapArhu_KemmIsMovingToTalk(1)
THEN
DB_ARX_Cathedral_DisapArhu_KemmIsMovingToTalk(1);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"ARX_Kemm",0,"DB_ARX_Cathedral_DisapArhu_KemmTalkToPlayer",1,30.0,1,0);

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Cathedral_DisapArhu_PaladinAppeared")
AND
NOT DB_ARX_Cathedral_DisapArhu_KemmIsMovingToTalk(1)
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28); 

IF
StoryEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Cathedral_DisapArhu_PaladinAppeared")
AND
DB_ARX_Cathedral_DisapArhu_KemmIsMovingToTalk(1)
THEN
NOT DB_ARX_Cathedral_DisapArhu_KemmIsMovingToTalk(1);

IF
CharacterMoveToAndTalkFailed(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"DB_ARX_Cathedral_DisapArhu_KemmTalkToPlayer")
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28); 
GlobalClearFlag("ARX_Cathedral_KemmAppeared_AutoStartedDialog");

IF
CharacterMoveToAndTalkRequestDialogFailedEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"DB_ARX_Cathedral_DisapArhu_KemmTalkToPlayer")
AND
NOT DB_DialogPlayers(_,_Player,_)
THEN
GlobalSetFlag("ARX_Kemm_StartDialogOnSight");
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28); 
GlobalClearFlag("ARX_Cathedral_KemmAppeared_AutoStartedDialog");

IF
CharacterMoveToAndTalkRequestDialogFailedEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"DB_ARX_Cathedral_DisapArhu_KemmTalkToPlayer")
AND
DB_DialogPlayers(_,_Player,_)
THEN
ProcForceStopDialog(_Player);
Proc_StartDialog(0,"ARX_Kemm",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);

IF
CharacterCharacterEvent(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player,"ARX_Kemm_StartDialogOnSight")
THEN
Proc_StartDialog(0,"ARX_Kemm",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Player);

//If Kemm attacked the Balcony Door in Arhu's Room
IF
AttackedByObject(S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_,_)
THEN
ItemDestroy(S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b);

//Kemm Onwership over Arhu's Room
IF
DialogEnded("ARX_Kemm",_)
AND
NOT DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
GlobalGetFlag("ARX_Cathedral_DisapArhu_KemmAppeared",1)
AND
QueryOnlyOnce("ARX_Cathedral_DisapArhu_KemmAppeared_OnwerShip")
THEN
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);

IF
DB_ItemOwnerShipTriggers("ARX_Main",TRIGGERGUID_S_ARX_Cathedral_DisapArhu_Apartment_SubregionPoly_39f541dd-408b-4deb-89bb-939abd732604,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
DB_ARX_KemmMansion_OwnershipIgnore((ITEMGUID)ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_5542b495-b9c6-4e6c-a27b-628906da4fb8);
DB_ARX_KemmMansion_OwnershipIgnore((ITEMGUID)ITEMGUID_S_ARX_Cathedral_DisapArhu_ApartDoor_Garden_4195b7e3-af28-41fc-8f43-427dc90c419b);
//END_REGION

//REGION Move To Next Location

PROC
Proc_ARX_KemmVault_ArhusPrison_SetKemm()
AND
QueryOnlyOnce("ARX_KemmVault_ArhusPrison_SetKemm")
THEN
GlobalSetFlag("ARX_KemmVault_ArhusPrison_SetKemm"); //Effects his AD when he leaves
Proc_ARX_Kemm_MoveToNextLocation("KemmVault");
SetCombatGroupID(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"");
ItemTemplateAddTo("ITEMGUID_WPN_UNIQUE_ARX_KemmsShield_0e42ad67-661f-4e3a-9ff2-f97a838a4b7b",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1);

//Post execution anywhere in the world
PROC
Proc_ARX_Kemm_MoveToNextLocation((STRING)_Location)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",0)
AND
CharacterIsInCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
DB_Kemm_DisappearOutOfSightToObject(_Location,_Object)
AND
StringConcatenate("ARX_Kemm_AppearAt_",_Location,_AppearAtLocationEvent)
THEN
ProcForceStopDialog(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
SetHasDialog(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0);
ProcClearStoryMove(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_StartDialog(1,"ARX_AD_Kemm_LeaveToNextLocation",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
ProcCharacterDisappearOutOfSightToObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_Object,1,_AppearAtLocationEvent,0);
CharacterSetFightMode(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0,0);
GlobalSetFlag("ARX_Kemm_StartDialogOnSight_Stop");
proc_ARX_Paladin_MoveToNextLocation(_Location);


//Handling The Paladins

PROC
proc_ARX_Paladin_MoveToNextLocation((STRING)_Location)
AND
_Location != "KemmVault"
AND
DB_ARX_Barracks_KemmsPaladins(_Paladin)
AND
CharacterIsDead(_Paladin,0)
AND
CharacterIsInCombat(_Paladin,0)
AND
DB_Kemm_DisappearOutOfSightToObject(_Location,_Object)
AND
StringConcatenate("ARX_Kemm_AppearAt_",_Location,_AppearAtLocationEvent)
THEN
ProcForceStopDialog(_Paladin);
SetHasDialog(_Paladin,0);
ProcCharacterDisappearOutOfSightToObject(_Paladin,_Object,1,_AppearAtLocationEvent,0);

PROC
proc_ARX_Paladin_MoveToNextLocation((STRING)_Location)
AND
_Location != "KemmVault"
AND
DB_ARX_Barracks_KemmsPaladins(_Paladin)
AND
CharacterIsInCombat(_Paladin,1)
AND
CombatGetIDForCharacter(_Paladin,_CombatID)
THEN
DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_CombatID,_Location);


//Handle Execution
PROC
Proc_ARX_Kemm_MoveToNextLocation((STRING)_Location)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GetClosestAlivePlayer(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,_Distance)
AND
_Distance > 40
THEN
proc_RC_ARX_Barracks_ExecutionSceneClose(0);
CharacterDie(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0,"DoT");
TimerLaunch("RC_ARX_Barracks_ExecutionEvent_WaitToFinish",3000);
DB_ARX_Kemm_MoveToNextLocation_AfterExecution(_Location);

PROC
Proc_ARX_Kemm_MoveToNextLocation((STRING)_Location)
AND
GlobalGetFlag("RC_ARX_Barracks_ExecutionEvent",1)
AND
GetClosestAlivePlayer(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,_Player,_Distance)
AND
_Distance < 40
THEN
proc_RC_ARX_Barracks_ExecutionSceneClose(0);
TimerLaunch("RC_ARX_Barracks_ExecutionEvent_WaitToFinish",3000);
DB_ARX_Kemm_MoveToNextLocation_AfterExecution(_Location);

IF
TimerFinished("RC_ARX_Barracks_ExecutionEvent_WaitToFinish")
AND
DB_ARX_Kemm_MoveToNextLocation_AfterExecution(_Location)
THEN
NOT DB_ARX_Kemm_MoveToNextLocation_AfterExecution(_Location);
Proc_ARX_Kemm_MoveToNextLocation(_Location);

IF
TimerFinished("RC_ARX_Barracks_ExecutionEvent_WaitToFinish")
AND
CharacterIsDead(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9,0)
THEN
GlobalSetFlag("RC_ARX_Barracks_ConvincedToSpare");
Proc_ARX_Barracks_Handle_ExecutionPrisoner(S_RC_ARX_Barracks_ExecutionPrisoner_ccdfda3c-4d67-42a4-a48f-665d71b259d9);

PROC
Proc_ARX_Barracks_Handle_ExecutionPrisoner((CHARACTERGUID)_Prisoner)
AND
CharacterIsInCombat(_Prisoner,0)
THEN
ProcCharacterMoveTo(_Prisoner,S_RC_ARX_Prison_Ext_b92d5e05-d370-4833-85ca-40cb9007f327,0,"RC_ARX_Barracks_ExecutedPaladinSparedReachedStairs");

PROC
Proc_ARX_Barracks_Handle_ExecutionPrisoner((CHARACTERGUID)_Prisoner)
AND
CharacterIsInCombat(_Prisoner,1)
AND
DB_CombatCharacters(_Prisoner,_ID)
THEN
DB_RC_ARX_Barracks_ExecutionEventLeaveAfterCombat_Prisoner(_Prisoner,_ID); //This is being handled in the Execution Goal


//Handling Combat
PROC
Proc_ARX_Kemm_MoveToNextLocation((STRING)_Location)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
CharacterIsInCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
AND
CombatGetIDForCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_CombatID)
THEN
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location);

IF
ObjectTurnEnded(_Object)
AND
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location)
AND
CombatGetIDForCharacter((CHARACTERGUID)_Object,_CombatID)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1)
THEN
NOT DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location);

IF
ObjectTurnEnded(_Object)
AND
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,"KemmVault")
AND
CombatGetIDForCharacter((CHARACTERGUID)_Object,_CombatID)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
NOT DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,"KemmVault");
//JumpToTurn(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
DB_CombatCutscene_PrioritizedObject(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
Proc_StartDialog(1,"ARX_AD_Kemm_LeaveToNextLocation",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
DB_ARX_Kemm_MoveToNextLocation_AfterAD("KemmVault");

IF
ObjectSwitchedCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_CombatID,_NewCombatID)
AND
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location)
THEN
NOT DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location);
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_NewCombatID,_Location);

IF
ObjectSwitchedCombat((CHARACTERGUID)_Paladin,_CombatID,_NewCombatID)
AND
DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_CombatID,_Location)
THEN
NOT DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_CombatID,_Location);
DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_NewCombatID,_Location);

IF
CombatEnded(_CombatID)
AND
DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
AND
CharacterIsInCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0)
THEN
NOT DB_ARX_Kemm_MoveToNextLocation_AfterCombat(_CombatID,_Location);
Proc_ARX_Kemm_MoveToNextLocation(_Location);

IF
CombatEnded(_CombatID)
AND
DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_CombatID,_Location)
AND
CharacterIsDead(_Paladin,0)
AND
CharacterIsInCombat(_Paladin,0)
AND
DB_Kemm_DisappearOutOfSightToObject(_Location,_Object)
AND
StringConcatenate("ARX_Kemm_AppearAt_",_Location,_AppearAtLocationEvent)
THEN
ProcForceStopDialog(_Paladin);
SetHasDialog(_Paladin,0);
ProcCharacterDisappearOutOfSightToObject(_Paladin,_Object,1,_AppearAtLocationEvent,0);
NOT DB_ARX_Paladin_MoveToNextLocation_AfterCombat(_Paladin,_CombatID,_Location);
//END_REGION

//REGION Leave a Paladin Behind
IF
GlobalFlagSet("ARX_Cathedral_DisapArhu_KemmAppeared")
AND
GlobalGetFlag("ARX_Barracks_WhiteMagisterVault_KemmAppear",0)
THEN
SetCombatGroupID(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,"");
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07, 50, 0, "ARX_Cathedral_DisapArhu_KemmAppeared_Paladin_06_Disappear", 1);
SetHasDialog(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07,0);
DialogRequestStop(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_06_cb44540a-5e2b-4b4d-87c0-382bb1528a07);
SetStoryEvent(CHARACTERGUID_S_RC_ARX_Barracks_Paladin_07_07343789-f903-4877-8d5f-c69aa52b3999,"ARX_Barracks_Trigger_PaladinLeftBehingFromStory"); //Makes this Paladin be left behind even if Kemm was never in the Barracks
//END_REGION

//REGION Dialog flags

// Black Ring confrontation
IF
ObjectFlagSet(_Flag,(CHARACTERGUID)_Player,_)
AND
DB_ARX_Kemm_BlackRingKnowledge(_Flag)
THEN
UserSetFlag(_Player,"ARX_Kemm_BlackRingKnowledge");
UserSetFlag(_Player,"QuestUpdate_CORE_Covenant_Kemm");
 

//Missing painting
IF
ObjectFlagSet(_Flag,(CHARACTERGUID)_Player,_)
AND
DB_ARX_Kemm_MissingPaintingKnowledge(_Flag)
THEN
UserSetFlag(_Player,"ARX_Kemm_MissingPaintingKnowledge");


// Kemm's Vault
IF
ObjectFlagSet(_Flag,(CHARACTERGUID)_Player,_)
AND
DB_ARX_Kemm_VaultKnowledge(_Flag)
THEN
UserSetFlag(_Player,"ARX_Kemm_VaultKnowledge");



// Arhu confrontation
IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Cathedral_DisapArhu_Journal_794e8f40-6aa5-411f-b4f2-2cbede844908,_Player)
THEN
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmPressuringArhu");

IF
GameBookInterfaceClosed(ITEMGUID_S_ARX_Cathedral_DisappearanceOfArhu_KemmRequest_3bf778f9-1e30-4bc1-83d5-0babbf46f2b9,_Player)
THEN
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmInvitingArhu");


IF
ObjectFlagSet("ARX_Kemm_WhiteMagisterVault_LookAt",CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_)
THEN
ObjectClearFlag(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm_WhiteMagisterVault_LookAt");
CharacterLookAt(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,TRIGGERGUID_S_ARX_Barracks_WhiteMagisterVault_KemmLookAt_f35692aa-943b-4276-977b-f8d4c01ef6b6);


// Kemm is dead
IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_ARX_Kemm_Ghost_4dc40adc-fa79-4bc2-96f0-a9ce8fae8476)
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_Kemm_SawSpiritOfKemm");
UserSetFlag(_Player,"ARX_Kemm_SawDeadKemm");


//Vault
IF
CharacterEnteredTrigger(_Char,TRIGGERGUID_S_ARX_KemmVault_Floor_01_8bd84dae-9618-4027-9a62-a03bc59a7beb)
THEN
UserSetFlag(_Char,"ARX_KemmVault_EnteredVault");

//END_REGION

//REGION Kemm Combat Paladins

IF 
DB_ARX_Kemm_CombatPaladin(_Paladin)
THEN
SetOnStage(_Paladin,0);

//Kemm
IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_CombatID) 
AND
DB_ARX_Kemm_InCombat(_AnyCombatID)
THEN
NOT DB_ARX_Kemm_InCombat(_AnyCombatID);

IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_CombatID)
AND
GlobalGetFlag("ARX_KemmVault_ArhusPrison_SetKemm",0) //Used to setup Kemm before he appears in His Vault
THEN
DB_ARX_Kemm_InCombat(_CombatID);

IF
ObjectSwitchedCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_OldCombatID,_NewCombatID)
AND
DB_ARX_Kemm_InCombat(_OldCombatID)
THEN
NOT DB_ARX_Kemm_InCombat(_OldCombatID);
DB_ARX_Kemm_InCombat(_NewCombatID);

IF
ObjectSwitchedCombat(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,_OldCombatID,_NewCombatID)
AND
DB_ARX_Kemm_InCombat_FirstTurnEnded(_OldCombatID)
THEN
NOT DB_ARX_Kemm_InCombat_FirstTurnEnded(_OldCombatID);
DB_ARX_Kemm_InCombat_FirstTurnEnded(_NewCombatID);

IF
CombatEnded(_CombatID) //Clean up and this should also handle combat merging
AND
DB_ARX_Kemm_InCombat_FirstTurnEnded(_CombatID)
THEN
NOT DB_ARX_Kemm_InCombat_FirstTurnEnded(_CombatID);

IF
ObjectTurnEnded(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28) //This will trigger again for a merged combat but it will only cause a PurgeQueue 
AND
DB_ARX_Kemm_InCombat(_CombatID)
AND
NOT DB_ARX_Kemm_InCombat_FirstTurnEnded(_CombatID)
AND
DB_ARX_Kemm_CombatPaladin(_Paladin)
AND
ObjectIsOnStage(_Paladin,1)
THEN
Proc_ARX_Kemm_CombatPaladins_EnteredCombatWhileOnStage(_Paladin);

IF
ObjectTurnEnded(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28) // It feels better to have them appear after he had 1 turn
AND
DB_ARX_Kemm_InCombat(_CombatID)
AND
NOT DB_ARX_Kemm_InCombat_FirstTurnEnded(_CombatID)
AND
DB_ARX_Kemm_CombatPaladin(_Paladin)
AND
ObjectIsOnStage(_Paladin,0)
THEN
SetCanJoinCombat(_Paladin,1);
CharacterAppearOutOfSightToObject(_Paladin,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,0,"ARX_Kemm_CombatPaladinAppeared");

//If They appeared and they are not in combat
IF
StoryEvent((CHARACTERGUID)_Paladin,"ARX_Kemm_CombatPaladinAppeared")
AND
CharacterIsInCombat(_Paladin,0)
THEN
ProcCharacterMoveTo(_Paladin,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1,""); //Sometimes they would appear too far to enter combat

IF
ObjectTurnEnded(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
AND
DB_ARX_Kemm_InCombat(_CombatID)
THEN
DB_ARX_Kemm_InCombat_FirstTurnEnded(_CombatID);

PROC
Proc_ARX_Kemm_CombatPaladins_EnteredCombatWhileOnStage((CHARACTERGUID)_Paladin)
THEN
SetCanJoinCombat(_Paladin,1);
CharacterPurgeQueue(_Paladin); //In case they are disappearing out of sight while Kemm enters combat

PROC
Proc_ARX_Kemm_CombatPaladins_EnteredCombatWhileOnStage((CHARACTERGUID)_Paladin)
AND
CharacterIsInCombat(_Paladin,0)
THEN
ProcCharacterMoveTo(_Paladin,CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,1,"");

IF
ObjectEnteredCombat((CHARACTERGUID)_Paladin,_CombatID) 
AND
DB_ARX_Kemm_CombatPaladin(_Paladin)
AND
DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_CombatID)
THEN
NOT DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_CombatID);

IF
ObjectEnteredCombat((CHARACTERGUID)_Paladin,_CombatID)
AND
DB_ARX_Kemm_CombatPaladin(_Paladin)
THEN
DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_CombatID);

IF
ObjectSwitchedCombat((CHARACTERGUID)_Paladin,_OldCombatID,_NewCombatID)
AND
DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_OldCombatID)
THEN
NOT DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_OldCombatID);
DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_CombatID)
THEN
CharacterPurgeQueue(_Paladin);
SetCanJoinCombat(_Paladin,0);
ProcCharacterDisappearOutOfSight(_Paladin,0,1,"ARX_Kemm_CombatPaladinDisappeared",0);

IF
CombatEnded(_CombatID) //In case combat ends before they manage to join combat
AND
DB_ARX_Kemm_InCombat(_CombatID)
AND
DB_ARX_Kemm_CombatPaladin(_Paladin)
AND
NOT DB_ARX_Kemm_CombatPaladinDisppaerAfterCombat(_Paladin,_)
THEN
CharacterPurgeQueue(_Paladin);
SetCanJoinCombat(_Paladin,0);
ProcCharacterDisappearOutOfSight(_Paladin,0,1,"ARX_Kemm_CombatPaladinDisappeared",0);

//END_REGION 

//REGION Paladin behaviour

IF
DialogEnded("ARX_Kemm",_ID) 
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag(_Player,"ARX_Kemm_PaladinDrawOnSight",1)
THEN
ObjectClearFlag(_Player,"ARX_Kemm_PaladinDrawOnSight");

//All Other Paladins Disappear Out Of Sight when Arhu is back
IF
GlobalFlagSet("ARX_KemmVault_Arhu_InCathedral")
AND
GlobalGetFlag("ARX_Cathedral_DisapArhu_KemmAppeared",1)
AND
DB_ARX_Barracks_KemmsPaladins_Searching_Splines(_Paladin,"ARX_Cathedral_DisapArhu_PaladinAppeared",_)
THEN
ProcForceStopDialog(_Paladin);
ProcCharacterDisappearOutOfSight(_Paladin,180,1,"",0);
SetHasDialog(_Paladin,0);


//END_REGION 

//REGION Journal

IF //Edge case
ObjectFlagSet("ARX_Kemm_CheckBarracksState_JournaUpdate",_Player,_)
AND
QuestAccepted((CHARACTERGUID)_Player,"ARX_Barracks",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_ARX_Barracks_LookingForWhiteMagisters",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_ARX_Barracks_KemmLeftBarracks_Unresolved");
ObjectSetFlag(_Player,"QuestUpdate_ARX_HuntingForDallis_KemmLeftBarracks_Unresolved");

//END_REGION 

//REGION Debug

IF
TextEventSet("KemmAppearAt")
AND
GetTextEventParamString(1,_Location)
THEN
Proc_ARX_Kemm_MoveToNextLocation(_Location);


// Setting the dialog and flags used in it
IF
TextEventSet("SetKemmReworkDialog")
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28)
THEN
DialogRequestStop(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
PROC_RemoveDialogFromCharacter(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28);
DB_Dialogs(S_RC_ARX_KammMansion_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_Kemm");


IF
TextEventSet("SetKemmOwlFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_KnowsAbout_KemmInvestigation");
UserSetFlag(_Player,"QuestUpdate_RC_DF_PaladinCheckpoint_Finished");

IF
TextEventSet("SetKemmVaultFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_KemmVault_SawEighthShrine");
UserSetFlag(_Player,"ARX_Kemm_MissingPaintingKnowledge");
UserSetFlag(_Player,"QuestUpdate_ARX_KemmVault_AppraiserSecret");

IF
TextEventSet("SetKemmBRFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_KemmMansion_Attic_Knows_BlackringMirror");
UserSetFlag(_Player,"ARX_Kemm_BlackRingKnowledge");
UserSetFlag(_Player,"QuestUpdate_RC_ARX_TheImperialDwarves_Sewers_Q_IsDead");
UserSetFlag(_Player,"ARX_KnowsAboutKemmEighth");
UserSetFlag(_Player,"ARX_Kemm_SawSpiritOfKemm");



IF
TextEventSet("SetKemmArhuFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmInvitingArhu");
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmPressuringArhu");

IF
TextEventSet("SetKemmAllFlags")
AND
DB_IsPlayer(_Player)
THEN
UserSetFlag(_Player,"ARX_KnowsAbout_KemmInvestigation");
UserSetFlag(_Player,"QuestUpdate_RC_DF_PaladinCheckpoint_Finished");
UserSetFlag(_Player,"ARX_KemmVault_SawEighthShrine");
UserSetFlag(_Player,"ARX_Kemm_MissingPaintingKnowledge");
UserSetFlag(_Player,"QuestUpdate_ARX_KemmVault_AppraiserSecret");
UserSetFlag(_Player,"ARX_KemmMansion_Attic_Knows_BlackringMirror");
UserSetFlag(_Player,"ARX_Kemm_BlackRingKnowledge");
UserSetFlag(_Player,"QuestUpdate_RC_ARX_TheImperialDwarves_Sewers_Q_IsDead");
UserSetFlag(_Player,"ARX_KnowsAboutKemmEighth");
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmInvitingArhu");
UserSetFlag(_Player,"ARX_Kemm_Knows_KemmPressuringArhu");
UserSetFlag(_Player,"ARX_Kemm_SawSpiritOfKemm");

//END_REGION

//REGION Crime reactions
PROC
Proc_ARX_Kemm_SetUpCrime()
THEN
ProcCharacterDisableCrime(CHARACTERGUID_S_ARX_Kemm_3e6ead7d-dd35-4f9d-985e-af2de0d76d28,"ARX_PassedPathOfBlood");

PROC
Proc_ARX_Kemm_SetUpCrime()
AND
DB_ARX_Barracks_KemmsPaladins(_Paladin)
THEN
ProcCharacterDisableCrime(_Paladin,"ARX_PassedPathOfBlood");
//END_REGION

//REGION Savegame patching

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 6, 0, 1)
THEN
NOT DB_ARX_Kemm_VaultKnowledge("QuestUpdate_ARX_KemmVault_KemmVault_AtticNote");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
