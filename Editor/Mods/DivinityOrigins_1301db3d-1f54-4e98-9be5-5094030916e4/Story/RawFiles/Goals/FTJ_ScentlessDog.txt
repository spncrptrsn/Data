Version 1
SubGoalCombiner SGC_AND
INITSECTION
//http://fileserver-dmz/mediawiki/index.php/The_Scentless_Source_Dog
DB_Dialogs(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_StrayDog");
DB_Dialogs(RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,"FTJ_PrisonSourceHound_001");
DB_Dialogs(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,"FTJ_PrisonSourceHound_002");
DB_Dialogs(RC_FTJ_PrisonSourceHound_003_07ab270c-ffa9-4339-bdca-4acbbdad44ea,"FTJ_PrisonSourceHound_003");
DB_Dialogs(RC_FTJ_PrisonSourceHound_004_3ea9afc1-0e32-475f-a651-3f6f75be6bb8,"FTJ_PrisonSourceHound_004");
DB_Dialogs(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,"FTJ_CapturedDog");

ProcTriggerRegisterForPlayers(RC_FTJ_SourceHoundHostile_Box_baf70a0e-6cb4-4757-8232-ec1263579853);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_FTJ_HearHoundsBarkingVB_Poly_444a8442-b2d6-4ac2-b344-61221647134d);

SetOnStage(FTJ_DogKey_74c755d0-801d-4c04-874e-5e901e938703,0);

DB_HasStoryEvent((ITEMGUID)ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,"FTJ_HasHoundMasterBall");
DB_GiveItemToEvent((ITEMGUID)ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,"FTJ_HoundMasterBallGive");

DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,"FTJ_KnowsEmmyIsDead");

Proc_FTJ_ScentlessDog_Init();

Proc_RegisterPartyDecisionDialogOutcomes_Fixed("FTJ_PDD_CapturedDog","FTJ_PDD_CapturedDog_Live","FTJ_PDD_CapturedDog_Die","","","");
KBSECTION
PROC
Proc_FTJ_ScentlessDog_Init()
THEN
ItemToInventory(ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,CHARACTERGUID_RC_FTJ_OlgoCellarMagister_001_402470db-ad49-4de7-8a60-7f69c8e5d26e);

IF
DialogStarted("FTJ_StrayDog",_)
AND
NOT DB_Dead(CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830)
AND
GetDistanceTo(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,CHARACTERGUID_S_FTJ_BlackCat_4bff6ccc-5889-4c90-bcb1-572f1c29d830,_Dist)
AND
_Dist < 6.0
THEN
ObjectSetFlag(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_ReactToBlackCat");


//REGION Feeding dog
//give dog food through dialog
IF 
ObjectFlagSet("FTJ_GiveMeatToDog",(CHARACTERGUID)_Player,_)
THEN
DB_FTJ_StrayDogCatchNextItemRemoved(1);

IF 
ObjectFlagSet("FTJ_GiveMeatToDog",(CHARACTERGUID)_Player,_)
AND 
QueryOnlyOnce("FTJ_RemoveMeatOneShot")
AND
UserTransferTaggedLocalItems(_Player,CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"MEAT",1,_)
THEN 
DB_NOOP(1);

//Give Fish
IF 
ObjectFlagSet("FTJ_GiveFishToDog",(CHARACTERGUID)_Player,_)
THEN
DB_FTJ_StrayDogCatchNextItemRemoved(1);

IF 
ObjectFlagSet("FTJ_GiveFishToDog",(CHARACTERGUID)_Player,_)
AND 
QueryOnlyOnce("FTJ_RemoveFishOneShot")
AND
UserTransferTaggedLocalItems(_Player,CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FISH",1,_)
THEN
DB_NOOP(1);


//Check next item removed hack with DB_
IF
ItemAddedToCharacter(_Item,CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca)
AND
DB_FTJ_StrayDogCatchNextItemRemoved(1)
AND
IsTagged(_Item,"POISONED",1)
THEN
ObjectSetFlag(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogAtePoisonedFood");

IF
ItemAddedToCharacter(_Item,CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca)
AND
DB_FTJ_StrayDogCatchNextItemRemoved(1)
THEN
CharacterUseItem(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,_Item,"");
NOT DB_FTJ_StrayDogCatchNextItemRemoved(1);

IF
DialogEnded("FTJ_StrayDog",_)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogAtePoisonedFood",1)
THEN
ApplyStatus(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"POISONED",-1.0);
TimerLaunch("FTJ_BuddyAtePoisonedFood",1250);
SetHasDialog(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

//Eat Poisoned food
IF
CharacterUsedItem(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,_Item)
AND
NOT DB_DialogNPCs(_,CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,_)
AND
IsTagged(_Item,"POISONED",1)
THEN
TimerLaunch("FTJ_BuddyAtePoisonedFood",2250);
SetHasDialog(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

IF
TimerFinished("FTJ_BuddyAtePoisonedFood")
THEN
CharacterDie(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0,"DoT");
CreateSurface(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"SurfacePoison",2.0,-1.0);




//dog ate meat off ground
//
IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_GiveFishToDog")
AND
QueryOnlyOnce("FTJ_DogDigUpKeyStart")
THEN 
PlayAnimation(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"use_eat","FTJ_DogMoveToKey");
GlobalSetFlag("FTJ_DogHasBeenFed");
SetHasDialog(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_GiveMeatToDog")
AND
QueryOnlyOnce("FTJ_DogDigUpKeyStart")
THEN 
PlayAnimation(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"use_eat","FTJ_DogMoveToKey");
GlobalSetFlag("FTJ_DogHasBeenFed");
SetHasDialog(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogMoveToKey")
THEN 
CharacterPurgeQueue(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca);
Proc_StartDialog(1,"FTJ_AD_StrayDog",CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca);
ProcCharacterMoveTo(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,RC_FTJ_DogKey_Point_53240ac4-d6a9-410d-bb5b-dd072f680c30,1,"FTJ_DogDig");
//END_REGION


IF 
DialogEnded("FTJ_StrayDog",_)
AND 
GlobalGetFlag("FTJ_DogHasBeenFed",1)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogAtePoisonedFood",0)
AND
QueryOnlyOnce("FTJ_DogDigUpKeyStart")
THEN 
ProcCharacterMoveTo(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,RC_FTJ_DogKey_Point_53240ac4-d6a9-410d-bb5b-dd072f680c30,1,"FTJ_DogDig");
SetHasDialog(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogDig")
AND
NOT DB_Shovelling_Mound(_,RC_FTJ_DirtMound_007_c10b0200-9375-4f75-9dd2-93d8af0553f7)
THEN 
PlayAnimation(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"use_inspect","FTJ_DogKeyAppear");
GlobalSetFlag("FTJ_DogShowsKey");
SetHasDialog(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,0);

IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogDig")
THEN
TimerLaunch("FTJ_DogBark",1000);

IF 
StoryEvent((CHARACTERGUID)RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_DogKeyAppear")
AND
DB_ShovelArea(_,_,RC_FTJ_DirtMound_007_c10b0200-9375-4f75-9dd2-93d8af0553f7)
AND 
QueryOnlyOnce("FTJ_KeyDugUpOneShot")
THEN 
ObjectSetFlag(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"FTJ_StrayDogDugUpKey");
SetOnStage(FTJ_DogKey_74c755d0-801d-4c04-874e-5e901e938703,1);
ItemDragToTrigger(FTJ_DogKey_74c755d0-801d-4c04-874e-5e901e938703,RC_FTJ_DogKeyDrag_Point_55fc7f60-8358-42c1-923b-1fcc1e5eb283);
SetHasDialog(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,1);
ItemRemove(RC_FTJ_DirtMound_007_c10b0200-9375-4f75-9dd2-93d8af0553f7);

IF
CharacterDied(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca)
THEN
GlobalSetFlag("RC_FTJ_ScentlessDogDead");

IF 
TimerFinished("FTJ_DogBark")
THEN 
SetHasDialog(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,1);
CharacterLookAt(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,FTJ_DogKey_74c755d0-801d-4c04-874e-5e901e938703);
PlayAnimation(RC_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca,"cast_shout_cast","");


//REGION  Feeding a general corpse to the dog
PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca, _Player)
THEN
ObjectClearFlag(_Player, "FTJ_HasLimbForDog", 0);
NOT DB_OnlyOnce("FTJ_HasLimbForDog");

PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca, _Player)
AND
DB_FTJ_CorpseItemForBuddy((ITEMGUID)_Item)
THEN
NOT DB_FTJ_CorpseItemForBuddy(_Item);

PROC
PROC_GLOBAL_DialogStartRequested(CHARACTERGUID_S_FTJ_ScentlessDog_086dbd6e-d911-4996-a23d-06d2ac1344ca, _Player)
AND
DB_HasTaggedItem((CHARACTERGUID)_Player, _Item, "BODYPART", _)
AND
_Item != ITEMGUID_S_FTJ_FlorenceLeg_09d02979-2749-4f1d-b1b7-5d2ddcfd6aa9
AND
QueryOnlyOnce("FTJ_HasLimbForDog")
THEN
ObjectSetFlag(_Player, "FTJ_HasLimbForDog", 0);
DB_FTJ_CorpseItemForBuddy(_Item);

IF
ObjectFlagSet("FTJ_CorpseToDog", _Player, _)
AND
DB_FTJ_CorpseItemForBuddy(_Item)
THEN
ItemRemove(_Item);
//END_REGION


//Hounds Barking VB
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_FTJ_HearHoundsBarkingVB_Poly_444a8442-b2d6-4ac2-b344-61221647134d)
AND
QRY_SpeakerIsAvailable(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,0)
AND
QueryOnlyOnce("FTJ_PlayerHearDogsBarking")
THEN
StartVoiceBark("FTJ_VB_HearDogsBarking",_Player);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_FTJ_HearHoundsBarkingVB_Poly_444a8442-b2d6-4ac2-b344-61221647134d);


//REGION Houndmasters room
//thrown when the hound sees a player for the first time
IF
StoryEvent((CHARACTERGUID)_,"FTJ_HoundMasterDogDialogStart")
AND
QueryOnlyOnce("RC_FTJ_QRY_PetPalPlayer")
THEN
Proc_RC_FTJ_QRY_PetPalPlayer();

//try to find the closest petpal player if possible
PROC
Proc_RC_FTJ_QRY_PetPalPlayer()
AND
DB_IsPlayer(_Player)
AND
IsTagged(_Player,"PETPAL",1)
AND
CharacterCanSee(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,_Player,1)
AND
GetDistanceTo(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,_Player,_Dist)
AND
_Dist < 14.0
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b)
AND
QueryOnlyOnce("RC_FTJ_SourceHoundDialogStart") 
THEN
Proc_StartDialog(0,"FTJ_PrisonSourceHounds",RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,_Player);

//no nearby petpal? just use the closest player
PROC
Proc_RC_FTJ_QRY_PetPalPlayer()
AND
NOT DB_OnlyOnce("RC_FTJ_SourceHoundDialogStart")
AND
GetClosestAlivePlayer(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,_Player,_)
AND
CharacterCanSee(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,_Player,1)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b)
AND
QueryOnlyOnce("RC_FTJ_SourceHoundDialogStart") 
THEN
Proc_StartDialog(0,"FTJ_PrisonSourceHounds",RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,_Player);

//Closest not available? just look for one I can see
PROC
Proc_RC_FTJ_QRY_PetPalPlayer()
AND
NOT DB_OnlyOnce("RC_FTJ_SourceHoundDialogStart")
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,_Player,1)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d)
AND
QRY_SpeakerIsAvailable(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b)
AND
QueryOnlyOnce("RC_FTJ_SourceHoundDialogStart") 
THEN
Proc_StartDialog(0,"FTJ_PrisonSourceHounds",RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,_Player);

//If all else fails, go hostile
PROC
Proc_RC_FTJ_QRY_PetPalPlayer()
AND
NOT DB_OnlyOnce("RC_FTJ_SourceHoundDialogStart")
THEN
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_003_07ab270c-ffa9-4339-bdca-4acbbdad44ea,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_004_3ea9afc1-0e32-475f-a651-3f6f75be6bb8,0);

IF
DialogEnded("FTJ_PrisonSourceHounds",_)
AND
GlobalGetFlag("RC_FTJ_SourceHoundsGoHostile",1)
THEN
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_003_07ab270c-ffa9-4339-bdca-4acbbdad44ea,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_004_3ea9afc1-0e32-475f-a651-3f6f75be6bb8,0);


IF
DialogEnded("FTJ_PrisonSourceHounds",_ID)
AND
GlobalGetFlag("RC_FTJ_SourceHoundsGoHostile",0)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
ProcTriggerUnregisterForPlayers(RC_FTJ_SourceHoundHostile_Box_baf70a0e-6cb4-4757-8232-ec1263579853);
PartyAddExperience(_Player,1,4,7);
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_End_Peaceful");


// EmmyDead journal entry
IF
CharacterDied(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_Start",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_End_EmmyDead");

IF
ObjectFlagSet("QuestUpdate_FTJ_SourceHounds_Start",(CHARACTERGUID)_Player,_)
AND
DB_GlobalFlag("FTJ_EmmieIsDead")
THEN
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_End_EmmyDead");

//REGION DOS2EE-1558
IF
DialogEnded("FTJ_PrisonSourceHounds",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_ToldEmmieAboutBuddy",1)
AND
GlobalGetFlag("RC_FTJ_SourceHoundsGoHostile",0)
THEN
PartySetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_End_Peaceful");

IF
DialogEnded("FTJ_PrisonSourceHounds",_Id)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_ToldEmmieAboutBuddy",1)
AND
GlobalGetFlag("RC_FTJ_SourceHoundsGoHostile",1)
THEN
PartySetFlag(_Player,"QuestUpdate_FTJ_SourceHounds_End_EmmyDead");
//END_REGION

IF
CharacterEnteredTrigger(_Player,RC_FTJ_SourceHoundHostile_Box_baf70a0e-6cb4-4757-8232-ec1263579853)
THEN
ProcForceStopDialog(RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d);
ProcForceStopDialog(RC_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_003_07ab270c-ffa9-4339-bdca-4acbbdad44ea,0);
ProcSetRelationToPlayers(CHARACTERGUID_S_FTJ_PrisonSourceHound_004_3ea9afc1-0e32-475f-a651-3f6f75be6bb8,0);

//Gave hounds the ball for persuade
IF
ObjectFlagSet("FTJ_GiveBallToHounds",_Player,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
RealSum(_Y,0.5,_NewY)
THEN
PlayAnimation(_Player,"Throw_Away_01");
TeleportToPosition(ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,_X,_NewY,_Z,"",1);
ItemDragToTrigger(ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,TRIGGERGUID_S_RC_FTJ_BallThrow_Point_03b540a0-23e9-483e-9219-669da4e6d548);
CharacterMoveTo(CHARACTERGUID_RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,TRIGGERGUID_S_RC_FTJ_BallThrow_Point_03b540a0-23e9-483e-9219-669da4e6d548,1,"FTJ_PickUpBall",0);

IF
StoryEvent(_Dog,"FTJ_PickUpBall")
THEN
PlayAnimation(CHARACTERGUID_RC_FTJ_PrisonSourceHound_001_89158247-ee74-41c8-8c69-641c4ab0b69d,"use_inspect","");
ItemToInventory(ITEMGUID_S_RC_FTJ_HoundMasterBall_3a45ae00-2ae0-468c-8854-a1787b9b5b6e,_Dog);

IF
CharacterDied(CHARACTERGUID_S_FTJ_PrisonSourceHound_002_d77ae4b8-f357-4ee1-beef-ea992857487b)
THEN
GlobalSetFlag("FTJ_EmmieIsDead");
//END_REGION

//REGION Captured Dog
//Toggle CanChickenFlee when exit the cage
IF
GlobalFlagSet("FTJ_CapturedDogFreed")
THEN
SetVarInteger(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,"bool_CanChickenFlee",1);

//Check for Petpal on spotted
IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_CapturedDogFreedDialogStart")
AND
IsTagged(_Player,"PETPAL",1)
AND
QueryOnlyOnce("FTJ_CapturedDogFreedDialog_Start")
THEN
Proc_FTJ_StartBertieFreedDialog(_Player);

//No Petpal on spotted Player? check for nearby Petpal Player
IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_CapturedDogFreedDialogStart")
AND
DB_IsPlayer((CHARACTERGUID)_AllPlayers)
AND
IsTagged(_AllPlayers,"PETPAL",1)
AND
DB_InRegion(_AllPlayers,TRIGGERGUID_S_FTJ_SUB_HoundMasterRoom_7c5ed6fd-2a36-4ff0-8bbc-d0b2d5ddfd88)
AND
QRY_SpeakerIsAvailable(_AllPlayers)
AND
QueryOnlyOnce("FTJ_CapturedDogFreedDialog_Start")
THEN
Proc_FTJ_StartBertieFreedDialog(_AllPlayers);

//Else do with spotted player
IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_CapturedDogFreedDialogStart")
AND
QueryOnlyOnce("FTJ_CapturedDogFreedDialog_Start")
THEN
Proc_FTJ_StartBertieFreedDialog(_Player);
DebugText(_Player,"Block 3");

//DOSTWO-27453
IF
DialogStarted("FTJ_PDD_CapturedDog",_)
THEN
SetHasDialog(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,0);
GlobalSetFlag("FTJ_CapturedDogLeave");

IF
DialogStarted("FTJ_PDD_CapturedDog",_)
AND
NOT DB_OnlyOnce("FTJ_CapturedDogFreedDialog_Start")
THEN
DB_OnlyOnce("FTJ_CapturedDogFreedDialog_Start");

PROC
Proc_FTJ_StartBertieFreedDialog((CHARACTERGUID)_Player)
THEN
Proc_StartDialog(0,"FTJ_CapturedDog",CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,_Player);
CharacterMoveTo(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,_Player,0,"",0);
PartyAddExperience(_Player,1,4,5);
GlobalSetFlag("FTJ_CapturedDogLeave");

//Mercy Kill Dog
IF
DialogEnded("FTJ_CapturedDog",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"FTJ_MercyKillDog",1)
THEN
DB_NPC_CrimeAttitude_DoNotChange(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,"AttackAnimal");
CharacterAttack(_Player,CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15);

IF
AttackedByObject(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,(CHARACTERGUID)_Player,_Attacker,_,_)
AND
CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15 != _Attacker
AND
ObjectGetFlag(_Player,"FTJ_MercyKillDog",1)
THEN
CharacterDie(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,0,"DoT");

//Go Hostile
IF
DialogEnded("FTJ_CapturedDog",_ID)
AND
GlobalGetFlag("FTJ_CapturedDogGoHostile",1)
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTERGUID)_Player)
THEN
SetCanFight(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,1);
EnterCombat(_Player,CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15);
CharacterSetRelationFactionToFaction("FTJ_Bertie","Hero",0);
CharacterSetRelationFactionToFaction("Hero","FTJ_Bertie",0);


//Convince Dog to live
IF
ObjectFlagSet("FTJ_CapturedDogPersuaded",(CHARACTERGUID)_Player,_)
THEN
PartyAddExperience(_Player,1,4,7);

//reading book gives player info flag about how source hounds are made
IF
CharacterUsedItem(_Player,ITEMGUID_S_FTJ_HoundMasterBook_76a40202-3611-494b-968e-995101a7cdf7)
THEN
UserSetFlag(_Player,"FTJ_LearnedAboutSourceHoundOrigins");


//END_REGION



//REGION Ignore teleportation Crime hack
IF
CharacterUsedSkillOnTarget(_Player,CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,_,"Teleportation",_)
AND
GlobalGetFlag("FTJ_CapturedDogLeave",0)
THEN
DB_IgnoreAssault(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15);

IF
AttackedByObject(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15,(CHARACTERGUID)_Player,_,_,_)
AND
DB_IsPlayer(_Player)
AND
DB_IgnoreAssault(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15)
THEN
NOT DB_IgnoreAssault(CHARACTERGUID_S_FTJ_CapturedDog_d526390b-7920-48d8-81d2-420d92dd2d15);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
