Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,0);
SetOnStage(CHARACTERGUID_S_CoS_Delorus_Warg_549d3a12-e98b-4bf8-949b-e2c144119aee,0);


DB_Dialogs(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_Delorus");
DB_Ghosts(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Delorus_Ghost_a77abaa3-404b-4032-8683-7945cb7a1037,"CoS_Delorus_Ghost");

DB_CoS_MagisterAlignments("CoS_Magister");
DB_CoS_MagisterAlignments("CoS_Magister_Delorus");
DB_CoS_MagisterAlignments("CoS_Magister_Human");



DB_CoS_Temples_DelorusLastStand_BR(CHARACTERGUID_S_CoS_Temples_DelorusLastStand_BR_001_01588951-9c0d-445f-b205-dbd92c71c058);
DB_CoS_Temples_DelorusLastStand_BR(CHARACTERGUID_S_CoS_Temples_DelorusLastStand_BR_002_772d7656-5b72-4980-ab77-fca802a61e96);
DB_CoS_Temples_DelorusLastStand_BR(CHARACTERGUID_S_CoS_Temples_DelorusLastStand_BR_003_1e82cd8b-e835-443f-8662-c65a45264c88);

DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_Delorus_Dead");
Proc_CoS_Temples_Delorus_Init();
KBSECTION
PROC
Proc_CoS_Temples_Delorus_Init()
AND
GlobalGetFlag("FTJ_InjuredMagisterSaved",1)
AND
GlobalGetFlag("FTJ_DelorusIsDead",0)
THEN
SetOnStage(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,1);
CharacterDisableCrime(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"SourceMagic");
CharacterDisableCrime(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"ActiveUndead");

IF
DB_CoS_Temples_DelorusLastStand_BR(_BR)
THEN
SetOnStage(_BR,0);

IF
CharacterResurrected(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327)
THEN
NOT DB_Dead(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);
DB_Dialogs(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_Delorus");


IF
StoryEvent((CHARACTERGUID)_Player,"CoS_Delorus_StartDialog")
AND
QueryOnlyOnce("CoS_Delorus_StartDialog_Once")
THEN
Proc_StartDialog(0,"CoS_Delorus",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);

IF
ObjectFlagSet("CoS_Delorus_FollowPlayer",(CHARACTERGUID)_Player,_)
THEN
CharacterAddToPlayerCharacter(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);
ProcCharacterMoveTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player,0,"");

IF
ObjectFlagCleared("CoS_Delorus_FollowPlayer",(CHARACTERGUID)_Player,_)
THEN
CharacterRemoveFromPlayerCharacter(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);

IF
CharacterDied(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327)
AND
DB_IsPlayer(_Player)
THEN
CharacterRemoveFromPlayerCharacter(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);


IF
DialogStarted("CoS_Delorus",_)
AND
NOT DB_OnlyOnce("CoS_Delorus_StartDialog_Once")
THEN
DB_OnlyOnce("CoS_Delorus_StartDialog_Once");

IF
StoryEvent(_Player,"CoS_Delorus_DeadFriend_DialogStart")
THEN
Proc_StartDialog(0,"CoS_Delorus_DeadFriend",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);

IF
ObjectFlagSet("CoS_DelorusMoveToDeadFriend",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_)
THEN
CharacterPurgeQueue(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);
CharacterMoveTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Temples_DeadDelorusFriend_a79145e8-ecf6-485e-bbcc-3b10fc2b527c,1,"Mourning_Animation",0);

IF
StoryEvent(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"Mourning_Animation")
THEN
PlayAnimation(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"Kneel_02");

IF
DialogEnded(_,_Id)
AND
ObjectGetFlag(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_Delorus_HostileToPlayers",1)
THEN
CharacterSetRelationFactionToFaction("CoS_Magister_Delorus","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_Magister_Delorus",0);

//REGION Purging his friend
//Purge Dead Friend
IF
CharacterUsedSkillOnTarget((CHARACTERGUID)_Player,CHARACTERGUID_S_CoS_Temples_DeadDelorusFriend_a79145e8-ecf6-485e-bbcc-3b10fc2b527c,_PurgingSkill,_,_)
AND
DB_SourceVampirism_Skills(_PurgingSkill)
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Temples_DeadDelorusFriend_a79145e8-ecf6-485e-bbcc-3b10fc2b527c,1)
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player,1)
THEN
Proc_CoS_DelorusGoHostileToPlayers();

//Purge character he is praying for
IF
CharacterUsedSkillOnTarget((CHARACTERGUID)_Player,CHARACTERGUID_S_CoS_Temples_DeadMagister_001_26506f1a-b421-47b5-9e3c-9f0c65876d29,_PurgingSkill,_,_)
AND
DB_SourceVampirism_Skills(_PurgingSkill)
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Temples_DeadMagister_001_26506f1a-b421-47b5-9e3c-9f0c65876d29,1)
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player,1)
THEN
Proc_CoS_DelorusGoHostileToPlayers();

PROC
Proc_CoS_DelorusGoHostileToPlayers()
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"CoS_Delorus_FollowPlayer",1)
THEN
ObjectClearFlag(_Player,"CoS_Delorus_FollowPlayer");

PROC
Proc_CoS_DelorusGoHostileToPlayers()
THEN
CharacterSetRelationFactionToFaction("CoS_Magister_Delorus","Hero",0);
CharacterSetRelationFactionToFaction("Hero","CoS_Magister_Delorus",0);
JumpToTurn(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);

PROC
Proc_CoS_DelorusGoHostileToPlayers()
AND
CharacterCanSee(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Temples_DeadMagister_001_26506f1a-b421-47b5-9e3c-9f0c65876d29,1)
THEN
Proc_StartDialog(1,"CoS_Delorus_AD_DeadFriendPurged",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);


//END_REGION

//REGION
//Delorus Leave
IF
DialogEnded("CoS_Delorus_DeadFriend",_Id)
AND
ObjectGetFlag(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_Delorus_LeavesParty",1)
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTERGUID)_Player)
THEN
ObjectSetFlag(_Player,"QuestUpdate_CoS_Delorus_Fail_LeftParty");
SetHasDialog(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,0,0,"CoS_ToDeathPoint",0);

//Remove follow to remove the summon
IF
ObjectFlagSet("QuestUpdate_CoS_Delorus_Fail_LeftParty",(CHARACTERGUID)_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ObjectClearFlag(_Player,"CoS_Delorus_FollowPlayer",0);

IF
StoryEvent(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_ToDeathPoint")
THEN
SetOnStage(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,1);
TeleportTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,TRIGGERGUID_S_CoS_DelorusDeath_Point_2d1a372a-dbcc-4f27-b002-03202afb9119);
CharacterDieImmediate(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,1,"DoT");
CreateSurface(TRIGGERGUID_S_CoS_DelorusDeath_Point_2d1a372a-dbcc-4f27-b002-03202afb9119,"SurfaceBlood",2.5,-1.0);
SetOnStage(CHARACTERGUID_S_CoS_Delorus_Warg_549d3a12-e98b-4bf8-949b-e2c144119aee,1);

IF
CharacterLootedCharacterCorpse((CHARACTERGUID)_Player,CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_Delorus_Fail_LeftParty",1)
AND
QueryOnlyOnce("CoS_RD_Delorus_FoundCorpse_Once")
THEN
ProcDefineReflectionDialog("CoS_RD_Delorus_FoundCorpse",_Player);


//END_REGION

//Dialog after completing quest while Delorus is following
IF
StoryEvent(_Player,"CoS_Delorus_QuestCompleteDoDialog")
THEN
Proc_StartDialog(0,"CoS_Delorus",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player);


//REGION Journal Updates
IF
ObjectFlagSet("CoS_Delorus_FollowPlayer",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"QuestUpdate_CoS_Delorus_Start");
TriggerRegisterForCharacter(TRIGGERGUID_S_CoS_SUB_Temples_Elf_b3f134d0-e320-4bec-802c-6a093d291363,CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);

IF
CharacterDied(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_Delorus_Start",1)
THEN
PartySetFlag(_Player,"QuestUpdate_CoS_Delorus_Fail_Dead");

IF
CharacterEnteredTrigger(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,TRIGGERGUID_S_CoS_SUB_Temples_Elf_b3f134d0-e320-4bec-802c-6a093d291363)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_Delorus_Start",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_CoS_Delorus_Fail_Dead",0)
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_CoS_SUB_Temples_Elf_b3f134d0-e320-4bec-802c-6a093d291363,CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);
PartySetFlag(_Player,"QuestUpdate_CoS_Delorus_EnteredTemple");

IF
ObjectFlagSet("CoS_Delorus_QuestEnd",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"QuestUpdate_CoS_Delorus_Complete");
DB_Temples_AlexandarsBattalion(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);
CharacterGiveReward(_Player,"COS_DelorusBow");
GlobalSetFlag("CoS_DelorusQuestComplete");


//Remove follow to remove the summon
IF
ObjectFlagSet("CoS_Delorus_QuestEnd",(CHARACTERGUID)_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
ObjectClearFlag(_Player,"CoS_Delorus_FollowPlayer",0);

//Wont follow into Academy
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_CoS_SUB_Academy_51ddb828-18a6-4b6e-9f5a-e2b2883862e1)
AND
ObjectGetFlag(_Player,"CoS_Delorus_FollowPlayer",1)
THEN
TeleportTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_CoS_Temples_DeadMagister_001_26506f1a-b421-47b5-9e3c-9f0c65876d29);
ObjectClearFlag(_Player,"CoS_Delorus_FollowPlayer",0);



//END_REGION

//REGION Delorus Try Interject 

IF
ObjectFlagSet("FactionHostileToIndivPlayerAfterDialog",_Player,_Id)
AND
DialogGetInvolvedNPC(_Id,1,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349)
AND
GetDistanceTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Dist)
AND
_Dist < 13.0
THEN
DB_CoS_DelorusTryAlexandarCombatInterject((CHARACTERGUID)_Player);

//Started combat from Dialog
IF
ObjectEnteredCombat(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_)
AND
GlobalGetFlag("CoS_DelorusQuestComplete",1)
AND
GlobalGetFlag("CoS_GarethRevenge_Resolution_HostileToAlexandar",0) // we already do an interjection in the dialog
THEN
ProcObjectTimer(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_DelorusInterjectInAlexandarCombat_Timer",1000);

PROC
ProcObjectTimerFinished(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_DelorusInterjectInAlexandarCombat_Timer")
THEN
Proc_CoS_DelorusInterjectInAlexandarCombat();

PROC
Proc_CoS_DelorusInterjectInAlexandarCombat()
AND
DB_CombatCharacters(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_DId)
AND
DB_CoS_DelorusTryAlexandarCombatInterject((CHARACTERGUID)_Player)
AND
DB_CombatCharacters(_Player,_PId)
AND
_PId == _DId
AND
DB_CombatCharacters(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_AId)
AND
_DId == _AId
THEN
ObjectSetFlag(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_DelorusInterjectInAlexandarCombat");

//Handle case of out of dialog combar
PROC
Proc_CoS_DelorusInterjectInAlexandarCombat()
AND
NOT DB_CoS_DelorusTryAlexandarCombatInterject(_)
AND
DB_CombatCharacters(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_DId)
AND
GetClosestAlivePlayer(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player,_)
AND
DB_CombatCharacters(_Player,_PId)
AND
_PId == _DId
AND
DB_CombatCharacters(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_AId)
AND
_DId == _AId
AND
CharacterGetRelationToCharacter(_Player,CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_Relation)
AND
_Relation == 0
THEN
DB_CoS_DelorusTryAlexandarCombatInterject(_Player);
ObjectSetFlag(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_DelorusInterjectInAlexandarCombat");


IF
ObjectFlagSet("CoS_DelorusInterjectInAlexandarCombat",CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_)
AND
DB_CoS_DelorusTryAlexandarCombatInterject(_Player)
AND
QueryOnlyOnce("CoS_DelorusInterjectInAlexandarCombat_Once")
AND
StartDialog_Internal("CoS_Temples_DelorusInterjectInAlexandarCombat",1,CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,_Player,NULL_00000000-0000-0000-0000-000000000000,
		NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
JumpToTurn(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);


IF
ObjectFlagSet("CoS_Temples_DelorusInterject_Peace",_Player,_)
AND
GetFaction(_Player,_PlayerFaction)
AND
GetFaction(CHARACTERGUID_S_GLO_Alexandar_03e6345f-1bd3-403c-80e2-a443a74f6349,_AlexFaction)
THEN
CharacterSetRelationFactionToFaction(_AlexFaction,_PlayerFaction,50);
CharacterSetRelationFactionToFaction(_PlayerFaction,_AlexFaction,50);

IF
ObjectFlagSet("CoS_Temples_DelorusInterject_Peace",(CHARACTERGUID)_Player,_)
AND
DB_CombatCharacters(_Player,_Id)
THEN
EndCombat(_Id);


IF
DialogStarted("CoS_DelorusInterjectInAlexandarCombat",_)
THEN
DB_CombatCutscene_PrioritizedObject(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);

IF
DialogEnded("CoS_DelorusInterjectInAlexandarCombat",_)
THEN
NOT DB_CombatCutscene_PrioritizedObject(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327);

IF
DialogEnded("CoS_DelorusInterjectInAlexandarCombat",_)
AND
DB_CoS_DelorusTryAlexandarCombatInterject(_Player)
THEN
NOT DB_CoS_DelorusTryAlexandarCombatInterject(_Player);


//END_REGION



//Delorus will leave the Party if Followed Player goes hostile to Magisters
IF
StoryEvent(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_DelorusGoHostileToPlayers")
THEN
Proc_CoS_DelorusGoHostileToPlayers();


//Set Delorus Last Stand
IF
StoryEvent(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_LastStandCheck")
AND
DB_CoS_Temples_DelorusLastStand_BR(_BR)
THEN
SetOnStage(_BR,1);

IF
StoryEvent(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,"CoS_LastStandCheck")
THEN
TeleportTo(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,TRIGGERGUID_S_CoS_Temples_DelorusLastStand_Point_477ca66f-f992-4cd4-9c2d-67955012de5e);
SetOnStage(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,1);
CharacterDie(CHARACTERGUID_S_CoS_Delorus_ab4a9043-f15a-4500-90cf-aa0d520b9327,1,"DoT");


PROC
ProcRegionEnded("CoS_Main")
THEN
GoalCompleted;

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "CoS_Temples"
