Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
PROC
PROC_GLO_LVDismissCompanionsAfterDialog((STRING)_Dialog,(INTEGER)_IsAD,(INTEGER)_IsRD)
THEN
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,_IsAD,_IsRD);

PROC
PROC_GLO_LVDismissCompanionsAfterDialog((STRING)_Dialog,(INTEGER)_IsAD,(INTEGER)_IsRD)
THEN
TimerLaunch("GLO_LVDismissCompanionsAfterRD_DismissCompanions",2500);

//Freeze until the RD begins
PROC
PROC_GLO_LVDismissCompanionsAfterDialog((STRING)_Dialog,(INTEGER)_IsAD,(INTEGER)_IsRD)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
CharacterFreeze(_Player);

PROC
PROC_GLO_LVDismissCompanionsAfterDialog((STRING)_Dialog,(INTEGER)_IsAD,(INTEGER)_IsRD)
AND
DB_CompanionAvatarBond(_Companion,_Avatar)
THEN
SetHasDialog(_Companion,0);

//Unfreeze after the timer
IF
TimerFinished("GLO_LVDismissCompanionsAfterRD_DismissCompanions")
AND
DB_IsPlayer((CHARACTERGUID)_Player)
THEN
CharacterUnfreeze(_Player);

IF
TimerFinished("GLO_LVDismissCompanionsAfterRD_DismissCompanions")
AND
SysCount("DB_IsPlayer",1,_Amount)
AND
_Amount > 1
AND
DB_Avatars(_Player)
AND
ObjectIsCharacter((CHARACTERGUID)_Player,1)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,_IsAD,_IsRD)
AND
StringConcatenate("GLO_LVDismissCompanionsAfterRD_CompanionDismissal_Start_Once_",_Dialog,_DismissalStartID)
AND
QueryOnlyOnce(_DismissalStartID)
THEN
RemoveStatus(_Player,"SNEAKING");
PROC_GLO_LVDismissCompanionsAfterDialog_StartDialog(_Player,_Dialog,_IsAD,_IsRD);

//REGION RD case
PROC
PROC_GLO_LVDismissCompanionsAfterDialog_StartDialog((CHARACTERGUID)_Player,(STRING)_Dialog,0,1)
THEN
ProcDefineReflectionDialog(_Dialog,_Player);
ProcStartReflectionDialog(_Player,_Dialog);

IF
DB_ReflectionDialog_Finished(_Dialog)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,0,1)
AND
StringConcatenate("GLO_LVDismissCompanionsAfterRD_Finished_",_Dialog,_FinishedRD)
AND
QueryOnlyOnce(_FinishedRD)
THEN
PROC_LVDismissCompanions_DismissAll();

IF
DB_ReflectionDialog_Finished(_Dialog)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,0,1)
THEN
NOT DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,0,1);
//END_REGION

//REGION AD case
PROC
PROC_GLO_LVDismissCompanionsAfterDialog_StartDialog((CHARACTERGUID)_Player,(STRING)_Dialog,1,0)
THEN
Proc_StartDialog(1,_Dialog,_Player);
TimerLaunch(_Dialog,1000);

IF
TimerFinished(_Dialog)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,1,0)
THEN
PROC_LVDismissCompanions_DismissAll();

IF
AutomatedDialogEnded(_Dialog,_)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,1,0)
THEN
NOT DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,1,0);

IF
AutomatedDialogRequestFailed(_Dialog,_)
AND
DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,1,0)
THEN
NOT DB_GLO_LVDismissCompanionsAfterDialog(_Dialog,1,0);
//END_REGION

PROC
PROC_LVDismissCompanions_DismissAll()
THEN
PROC_GLO_PartyMembers_CollectDismissAll();

PROC
PROC_LVDismissCompanions_DismissAll()
AND
DB_IsPlayer(_Player)
AND
NOT DB_GLO_PartyMembers_CollectDismissAll_Keep(_Player)
THEN
PROC_GLO_PartyMembers_Remove(_Player,(CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000,0);
SetHasDialog(_Player,0);

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "DOS2ModWrapper"
