Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_CoS_Temples_SpyMaster_787c6c4a-6e5a-4044-9616-27e21e5a171e, "CoS_FoundDeadSpyMaster");
Proc_JDF_CreateCustomFlagsDependency("QuestUpdate_FTJ_COM_RedPrince_ToSallowMan","QuestUpdate_FTJ_COM_RedPrince_BlackMirror_RedPrince","QuestUpdate_FTJ_COM_RedPrince_HouseOfShadows_BlackMirror_RedPrince");
Proc_JDF_CreateCustomFlagsDependency("QuestUpdate_FTJ_OriginRedPrince_ToSallowMan","QuestUpdate_FTJ_OriginRedPrince_BlackMirror_Pregnant_Warned","QuestUpdate_FTJ_OriginRedPrince_HouseOfShadows_BlackMirror");
KBSECTION
//REGION Recruitment
PROC
PROC_GLO_PartyMembers_RecruiteeAvatarBond(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,(CHARACTERGUID)_Avatar)
AND
NOT DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_RedPrince_RecruitedInFortJoy");
GlobalSetFlag("GLO_RedPrince_WasRecruitedInFortJoy");

PROC
PROC_GLO_PartyMembers_RecruiteeAvatarBond(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,(CHARACTERGUID)_Avatar)
AND
DB_GlobalFlag("FTJ_LV_SetUp")
THEN
ObjectSetFlag(_Avatar,"GLO_RedPrince_RecruitedInLV");

IF
GlobalFlagSet("FTJ_LV_SetUp")
AND
NOT DB_GlobalFlag("GLO_RedPrince_WasRecruitedInFortJoy")
THEN
GlobalSetFlag("GLO_RedPrince_BaharaFinished");

IF
DialogStarted("RedPrince_Recruitment",_)
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);


// Before LV
PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player)
AND
ObjectGetFlag(_Player, "QuestAdd_FTJ_COM_RedPrince", 0)
AND
NOT DB_GlobalFlag("GLO_RedPrince_WasRecruitedInFortJoy")
AND
NOT DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
UserSetFlag(_Player,"QuestAdd_FTJ_COM_RedPrince");
UserSetFlag(_Player,"QuestUpdate_FTJ_COM_RedPrince_Start");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player)
AND
ObjectGetFlag(_Player, "QuestAdd_FTJ_COM_RedPrince", 0)
AND
NOT DB_GlobalFlag("GLO_RedPrince_WasRecruitedInFortJoy")
AND
DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
UserSetFlag(_Player,"QuestAdd_FTJ_COM_RedPrince");
UserSetFlag(_Player,"QuestUpdate_FTJ_COM_RedPrince_Start_AfterBahara");


// LV
PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player)
AND
DB_GlobalFlag("FTJ_LV_SetUp")
AND
ObjectGetFlag(_Player, "QuestAdd_FTJ_COM_RedPrince", 0)
AND
NOT DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
UserSetFlag(_Player,"QuestAdd_FTJ_COM_RedPrince");
UserSetFlag(_Player,"QuestUpdate_FTJ_COM_RedPrince_Start_LV_NoStingtail");

PROC
PROC_GLO_PartyMembers_Add(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player)
AND
DB_GlobalFlag("FTJ_LV_SetUp")
AND
ObjectGetFlag(_Player, "QuestAdd_FTJ_COM_RedPrince", 0)
AND
DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
UserSetFlag(_Player,"QuestAdd_FTJ_COM_RedPrince");
UserSetFlag(_Player,"QuestUpdate_FTJ_COM_RedPrince_Start_LV_NoBahara");


//END_REGION

//REGION Princess_Poof
PROC
PROC_PrincessPoof((CHARACTERGUID)_Character)
AND
GetRegion(_Character,_Region)
AND
DB_CurrentLevel(_Region)
AND
GetPosition(_Character,_X,_Y,_Z)
THEN
PlayEffectAtPosition("RS3_FX_GP_ScriptedEvent_RedPrincess_Teleport_01",_X,_Y,_Z);

PROC
PROC_PrincessPoof((CHARACTERGUID)_Character)
THEN
SetOnStage(_Character,0);
//END_REGION

//REGION Red Prince talks to the Spymaster in any capacity
IF
DB_DialogNPCs(_ID, CHARACTERGUID_S_GLO_RedPrincess_050fbbf9-3fc9-40cd-9cbb-43b4b3754a5e, _)
AND
DB_DialogPlayers(_ID, CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "RED PRINCE", 1)
THEN
GlobalSetFlag("GLO_RPMetRedPrincess");

IF
DB_DialogNPCs(_ID, CHARACTERGUID_S_GLO_RedPrincess_050fbbf9-3fc9-40cd-9cbb-43b4b3754a5e, _)
AND
DB_DialogPlayers(_ID, CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
AND
IsTagged(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "RED PRINCE", 1)
THEN
GlobalSetFlag("GLO_RPMetRedPrincess");

//END_REGION

//REGION The introduction from the Shadow Prince is not necessary if Brahmos or the Red Prince already explained the situation.
//Companion
IF
ObjectFlagSet("QuestUpdate_FTJ_COM_RedPrince_RedPrincessMate", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_COM_RedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_COM_RedPrince_ToSallowMan");

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_RedPrince_RedPrincessRefused", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_COM_RedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_COM_RedPrince_ToSallowMan");

IF
ObjectFlagSet("QuestUpdate_FTJ_COM_RedPrince_ToRedPrincess", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_COM_RedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_COM_RedPrince_ToSallowMan");

//Avatar
IF
ObjectFlagSet("QuestUpdate_FTJ_OriginRedPrince_RedPrincessMate", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_OriginRedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_OriginRedPrince_ToSallowMan");

IF
ObjectFlagSet("QuestUpdate_FTJ_OriginRedPrince_RedPrincessTryKill", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_OriginRedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_OriginRedPrince_ToSallowMan");

IF
ObjectFlagSet("QuestUpdate_FTJ_OriginRedPrince_ToRedPrincess", CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, _)
THEN
PROC_JournalEntries_ClearQuestUpdateEvent("FTJ_OriginRedPrince","RedPrincessLearnShadowPrince", "QuestUpdate_FTJ_OriginRedPrince_ToSallowMan");
//END_REGION

//REGION See what the Red Prince knows at the end of RC
QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfRedPrincessPlot()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_SpyMasterInvite", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfRedPrincessPlot()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_ToRedPrincess", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfRedPrincessPlot()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_RedPrincessRefused", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfRedPrincessPlot()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_RedPrincessMate", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfBrahmos()
AND
DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfBrahmos()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_RC_LizardDreamer", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_COM_RedPrinceKnowsOfBrahmos()
AND
UserGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_COM_RedPrince_RC_PaladinInfo", 1)
THEN
DB_NOOP(1);


QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfRedPrincessPlot()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_SpyMasterInvite", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfRedPrincessPlot()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_ToRedPrincess", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfRedPrincessPlot()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_RedPrincessTryKill", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfRedPrincessPlot()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_RedPrincessMate", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfBrahmos()
AND
DB_GlobalFlag("GLO_RedPrince_BaharaFinished")
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfBrahmos()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_RC_LizardDreamer", 1)
THEN
DB_NOOP(1);

QRY
QRY_RC_RCEnd_Avatar_RedPrinceKnowsOfBrahmos()
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "QuestUpdate_FTJ_OriginRedPrince_RC_PaladinInfo", 1)
THEN
DB_NOOP(1);
//END_REGION


//REGION 
IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 5, 1, 0)
THEN
DB_SeenDeadNPCPartyFlag(CHARACTERGUID_S_CoS_Temples_SpyMaster_787c6c4a-6e5a-4044-9616-27e21e5a171e, "CoS_FoundDeadSpyMaster");
Proc_JDF_CreateCustomFlagsDependency("QuestUpdate_FTJ_COM_RedPrince_ToSallowMan","QuestUpdate_FTJ_COM_RedPrince_BlackMirror_RedPrince","QuestUpdate_FTJ_COM_RedPrince_HouseOfShadows_BlackMirror_RedPrince");
//END_REGION

IF
DialogEnded("RC_FL_RedPrincess_CRD_RedPrince", _)
AND
ObjectGetFlag(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f, "GLO_Companion_Leave", 1)
AND
DB_CompanionAvatarBond(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,(CHARACTERGUID)_Player)
THEN
PROC_Origins_CompanionLeavePermanently(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f);
DB_CompanionLeaving(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,_Player);
CharacterMakeStoryNpc(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,1);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,0,1,"GLO_CompanionLeaves_LowRelation",1);
Proc_OriginLeft(CHARACTERGUID_S_Player_RedPrince_a26a1efb-cdc8-4cf3-a7b2-b2f9544add6f,"_LowRelation");
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
