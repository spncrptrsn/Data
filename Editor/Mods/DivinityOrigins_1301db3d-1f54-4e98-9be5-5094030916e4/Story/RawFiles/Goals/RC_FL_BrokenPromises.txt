Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/home/quest-design-documentation/farmlands---broken-promises

DB_Dialogs(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"RC_FL_Almira");
DB_Dialogs(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_Mihaly");
DB_Ghosts(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_RC_FL_Almira_Ghost_8c267afc-aca5-4145-b89f-f02e49344c1a,"RC_FL_Almira_Ghost");
DB_Ghosts(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,CHARACTERGUID_RC_FL_Mihaly_Ghost_3de3ea33-ae38-448f-857d-cbd855e3d7b6,"RC_FL_Mihaly_Ghost");

DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadMagister_01_609b8de7-bf7b-4579-ac22-2e54c1dc098f,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadMagister_01_Ghost_cabeb280-a0ca-4c9e-8838-7c3e3554ecb4,"RC_FL_BrokenPromises_DeadMagister_01_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadMagister_04_5dfd5445-352a-44fa-87b3-01a7563cc352,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadMagister_04_Ghost_2203b266-001f-461b-808a-3155294cbf15,"RC_FL_BrokenPromises_DeadMagister_04_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_01_5e4d6720-b261-41cc-a699-4d273dfc8fc4,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_01_Ghost_c80d1325-4d8d-404c-bf73-e96dd15c94be,"RC_FL_BrokenPromises_DeadFarmer_01_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_04_0f12939e-41b1-4403-97c2-0b42886a1170,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_04_Ghost_f680edbc-5599-4ea1-a893-4ddd35a939e6,"RC_FL_BrokenPromises_DeadFarmer_04_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_06_b65b5d45-6da3-4ab7-93a7-9acfae38c62e,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_06_Ghost_4dab41ee-b8be-4f96-986c-e0c8d14b9fdc,"RC_FL_BrokenPromises_DeadFarmer_06_Ghost");
DB_Ghosts(CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_08_6e7b9800-213f-4020-bcce-4285313122b0,CHARACTERGUID_S_RC_FL_BrokenPromises_DeadFarmer_08_Ghost_db393b62-d576-4092-a86b-00a01fbd846a,"RC_FL_BrokenPromises_DeadFarmer_08_Ghost");

DB_RC_FL_AlmiraGroup((CHARACTERGUID)CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"QuestUpdate_RC_FL_BrokenPromises_AlmiraDied");
DB_RC_FL_AlmiraGroup(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"QuestUpdate_RC_FL_BrokenPromises_MihalyDied");

DB_RC_FL_AlanMinions((CHARACTERGUID)CHARACTERGUID_S_RC_FL_AlanBoss_NPC_01_143d8d41-883e-4498-bc77-1b21954043c2);
DB_RC_FL_AlanMinions(CHARACTERGUID_S_RC_FL_AlanBoss_NPC_02_d4befb98-3743-4d61-a84a-e5f7014cd410);
DB_RC_FL_AlanMinions(CHARACTERGUID_S_RC_FL_AlanBoss_NPC_03_b3c6b4b8-266e-44ac-b2b6-f842eb21129a);
DB_RC_FL_AlanMinions(CHARACTERGUID_S_RC_FL_AlanBoss_NPC_04_2bc702d4-4b39-41db-a033-eced5d793a13);

DB_DeadEvent(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"RC_FL_AlmiraDead");
DB_DeadEvent(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,"RC_FL_AlanBossDead");

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153);

ProcCharacterDisableAllCrimes(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2);
CharacterSetHitpointsPercentage(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,30.0);
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"stillcrippled");
CreatePuddle(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"SurfaceBlood",4,8,4,8,1.0);

DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_FL_BrokenPromises_AlmirasHideout_6bbd5c7d-4614-4406-8684-39344257d4fc);
KBSECTION
//REGION Debug
IF
TextEventSet("goAlmira")
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("DebugStartAlmiraEscorting")
THEN
TeleportTo(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);
TeleportTo(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_Player);
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_MetAlmira");
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_ClearSurfaces");
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escort");
ObjectSetFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows");
GlobalSetFlag("RC_FL_BrokenPromises_Escorting");
ApplyStatus(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"DECAYING_TOUCH",-1.0,1);
ApplyStatus(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"DECAYING_TOUCH",-1.0,1);

IF
TextEventSet("esAlmira")
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("DebugStartAlmiraCompleteEscorting")
THEN
TeleportTo(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);
TeleportTo(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_Player);
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_MetAlmira");
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_ClearSurfaces");
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escort");
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escaped");
ObjectSetFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyEscaped");
SetVarFixedString(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"currentState","State_PostFarmlands");

//END_REGION


IF
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_)
THEN
TriggerRegisterForCharacter(TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153,_AlmiraGroup);


//REGION Alan

IF
DB_RC_FL_AlanMinions(_AlanMinion)
THEN
CharacterDisableCrime(_AlanMinion,"ActiveUndead");

IF
ObjectEnteredCombat(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,_CombatID)
AND
DB_RC_FL_AlanMinions(_AlanMinion)
AND
NOT GetFaction(_AlanMinion,"Evil NPC")
THEN
SetFaction(_AlanMinion,"Evil NPC");

IF
AttackedByObject(_AlanMinion,_Player,_,_,_)
AND
DB_IsPlayer((CHARACTERGUID)_Player)
AND
DB_RC_FL_AlanMinions((CHARACTERGUID)_AlanMinion)
AND
QueryOnlyOnce("RC_FL_TurnAlanMinionsEvil")
AND
DB_RC_FL_AlanMinions((CHARACTERGUID)_AllAlanMinion)
THEN
SetFaction(_AllAlanMinion,"Evil NPC");
Proc_RC_FL_TurnAlanMinionsEvil_EnterCombatCheck(_AllAlanMinion,_Player);


PROC
Proc_RC_FL_TurnAlanMinionsEvil_EnterCombatCheck((CHARACTERGUID)_AllAlanMinion,(CHARACTERGUID)_Player)
AND
GetDistanceTo(_AllAlanMinion,_Player,_Dist)
AND
_Dist < 25
THEN
EnterCombat(_Player,_AllAlanMinion);

IF
CharacterReceivedDamage(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141, _, _)
AND
CharacterGetHitpointsPercentage(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,_HpPercentage)
THEN
Proc_RC_FL_AlanNextPhase(_HpPercentage);

PROC
Proc_RC_FL_AlanNextPhase((REAL)_HpPercentage)
AND
_HpPercentage <= 95.0
AND
QueryOnlyOnce("RC_FL_AlanBoss_GetSpells")
THEN
CharacterAddSkill(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,"Target_EnemyGraspOfTheStarved");
CharacterAddSkill(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,"Shout_EnemyFear");
CharacterAddSkill(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,"Projectile_EnemyFireball");

PROC
Proc_RC_FL_AlanNextPhase((REAL)_HpPercentage)
AND
_HpPercentage <= 60.0
AND
QueryOnlyOnce("RC_FL_AlanBoss_GetMoreSpells")
THEN
TriggerSetAtmosphere(TRIGGERGUID_AtmosphereTrigger_RC_Farmlands_Alan_569bb0c5-1ea9-43d0-b1b1-1ee49c0533db,"9cb2f29e-cd03-421f-885e-a9b7e9299ae6");
CharacterAddSkill(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,"ProjectileStrike_EnemyMeteorShower_Alan");

IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141)
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("RC_FL_VoiceBark_SeenAlanBoss")
THEN
StartVoiceBark("RC_FL_VB_SeenAlanBoss",_Player);
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_FoundAlanBoss");

PROC
Proc_ObjectLeftCombat((CHARACTERGUID)_Player,_CombatID)
AND
DB_WasInCombat(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,_CombatID)
AND
DB_IsPlayer(_Player)
AND
CharacterIsDead(CHARACTERGUID_S_RC_FL_AlanBoss_ef0adba7-2471-4972-9feb-ceb4c7547141,1)
AND
QueryOnlyOnce("RC_FL_AlanBossDeath")
THEN
StartVoiceBark("RC_FL_VB_AlanBossDeath",_Player);

IF
GlobalFlagSet("RC_FL_AlanBossDead")
AND
DB_IsPlayer(_Player)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_KilledAlanBoss");

IF
GlobalFlagSet("RC_FL_AlanBossDead")
THEN
TriggerSetAtmosphere(TRIGGERGUID_AtmosphereTrigger_RC_Farmlands_Alan_569bb0c5-1ea9-43d0-b1b1-1ee49c0533db,"06d87eb1-d41d-49e6-805f-54666d4355f2");
TriggerSetAtmosphere(TRIGGERGUID_AtmosphereTrigger_RC_Farmlands_Rift_71435c4a-b3c4-4e8a-875c-025570863f3d,"06d87eb1-d41d-49e6-805f-54666d4355f2");
SetVarFixedString(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"currentState","State_PostFarmlands");
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"");
TriggerLaunchIterator(TRIGGERGUID_S_RC_FL_AlanAura_d07244f9-2e65-4c06-b811-c647fd5886c0,"CharacterWithAlanAura");

//END_REGION


//REGION First Dialog with Almira
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_FL_BrokenPromises_AlmirasHideout_6bbd5c7d-4614-4406-8684-39344257d4fc)
THEN
Proc_StartDialog(0,"RC_FL_Almira",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);
Proc_RC_FL_BrokenPromises_AlmiraUnsheathe(_Player);

PROC
Proc_RC_FL_BrokenPromises_AlmiraUnsheathe((CHARACTERGUID)_Player)
AND
QueryOnlyOnce("RC_FL_BrokenPromises_FirstDialog")
THEN
CharacterSetFightMode(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,1,0);
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player,0,"");

IF
ObjectFlagSet("RC_FL_BrokenPromises_AlmraSheathe",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_)
AND
QueryOnlyOnce("RC_FL_BrokenPromises_AlmraSheathe")
THEN
CharacterSetFightMode(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,0,0);

//END_REGION


//REGION Almira Wings
IF
ObjectFlagSet("RC_FL_BrokenPromises_MihalyAlreadyFollows",CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_)
THEN
SetStoryEvent(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"NearMihaly");

IF
StoryEvent(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"AlmiraTeleport")
AND
CharacterIsInCombat(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,0)
AND
NOT QRY_IsInRange(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,10.0)
THEN
ProcCharacterStopFollow(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f);
//CharacterPurgeQueue(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f);
CharacterUseSkill(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"Shout_EnemyWings",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,1,1,1);

IF
CharacterUsedSkill(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"Shout_EnemyWings",_,_)
AND
CharacterIsInCombat(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,0)
THEN
TeleportTo(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"NearMihaly",1);

IF
StoryEvent(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"NearMihaly")
AND
DB_InRegion(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153)
THEN
ProcCharacterFollowCharacter(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2);

//END_REGION


//REGION Follower part
//Remove Mihaly from party if he was following a character who was asked to leave party
IF
CharacterLeftParty(_Player)
AND
IsTagged(_Player,"COMPANION",1)
AND
ObjectGetFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows",1)
THEN
ObjectClearFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows");

IF
ObjectFlagCleared("RC_FL_BrokenPromises_MihalyFollows",(CHARACTERGUID)_Player,_)
AND
DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Player)
THEN
ObjectClearFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyAlreadyFollows");
CharacterRemoveFromPlayerCharacter(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_Player);
ProcCharacterStopFollow(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f);
NOT DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Player);

IF
ObjectFlagSet("RC_FL_BrokenPromises_MihalyFollows",(CHARACTERGUID)_Player,_)
THEN
ObjectSetFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyAlreadyFollows");
CharacterAddToPlayerCharacter(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_Player);
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"");
DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Player);

IF
CharacterUsedSkillOnTarget(_,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_,"Teleportation",_)
AND
DB_GlobalFlag("RC_FL_BrokenPromises_Escorting")
AND
NOT DB_IgnoreAssault(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2)
THEN
DB_IgnoreAssault(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2);

IF
AttackedByObject((CHARACTERGUID)_Defender,(CHARACTERGUID)_AttackOwner,_,_,_)
AND
DB_RC_FL_AlmiraGroup(_Defender,_)
AND
DB_IsPlayer(_AttackOwner)
THEN
Proc_RC_FL_BrokenPromises_HandleAttack(_Defender,_AttackOwner);

IF
AttackedByObject(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_,_,_)
AND
DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Player)
THEN
Proc_RC_FL_BrokenPromises_Assault(_Player);

PROC
Proc_RC_FL_BrokenPromises_HandleAttack((CHARACTERGUID)_Defender,(CHARACTERGUID)_AttackOwner)
AND
NOT DB_IgnoreAssault(_Defender)
THEN
Proc_RC_FL_BrokenPromises_Assault(_AttackOwner);

PROC
Proc_RC_FL_BrokenPromises_HandleAttack((CHARACTERGUID)_Defender,(CHARACTERGUID)_AttackOwner)
AND
DB_IgnoreAssault(_Defender)
THEN
NOT DB_IgnoreAssault(_Defender);

PROC
Proc_RC_FL_BrokenPromises_Assault((CHARACTERGUID)_Character)
AND
NOT DB_Crime_Assault(_,_,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f)
AND
NOT DB_CombatCharacters(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_)
THEN
ProcCrimeRegisterAssault(_Character,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,0);

PROC
Proc_RC_FL_BrokenPromises_Assault((CHARACTERGUID)_Character)
AND
DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Player)
THEN
ObjectClearFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows");

//END_REGION


//REGION Escort completion
IF
CharacterLeftTrigger(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153)
AND
DB_RC_FL_BrokenPromises_PlayerWithMihaly((CHARACTERGUID)_Player)
AND
CharacterIsDead(HARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,0)
THEN
ObjectClearFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows");
ObjectSetFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyEscaped");

IF
ObjectFlagSet("RC_FL_BrokenPromises_MihalyEscaped",CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,_)
AND
DB_InRegion(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153)
AND
QRY_IsInRange(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,10.0)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,1,"AlmiraFinalPoint");

IF
StoryEvent(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"AlmiraFinalPoint")
THEN
Proc_RC_FL_AlmiraLeftRegion();

IF
CharacterLeftTrigger(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153)
THEN
Proc_RC_FL_AlmiraLeftRegion();

PROC
Proc_RC_FL_AlmiraLeftRegion()
AND
QRY_IsInRange(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,5.0)
AND
ObjectGetFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyEscaped",1)
THEN
ProcCharacterStopFollow(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f);
GlobalClearFlag("RC_FL_BrokenPromises_Escorting");

IF
GlobalFlagCleared("RC_FL_BrokenPromises_Escorting")
AND
DB_IsPlayer(_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escort",1)
AND
ObjectGetFlag(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_BrokenPromises_MihalyEscaped",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escaped");
Proc_RC_FL_BrokenPromises_FinishEscape(_Player);

PROC
Proc_RC_FL_BrokenPromises_FinishEscape((CHARACTERGUID)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f)
AND
QRY_SpeakerIsAvailableAndInDialogRange(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f)
THEN
CharacterLookAt(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);
Proc_StartDialog(0,"RC_FL_Almira",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);

//END_REGION

//REGION Source Point
IF
ObjectFlagSet("RC_FL_BrokenPromises_Kiss",_Player,_)
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_RC_Almira_LoveScene_Player_01",_Player,"RC_FL_BrokenPromises_KissFX","RC_Main","Dummy_StatusFX");
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_RC_Almira_LoveScene_Almira_01",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"RC_FL_BrokenPromises_AlmiraFX","RC_Main","Dummy_BodyFX");

IF
ObjectFlagCleared("RC_FL_BrokenPromises_Kiss",_Player,_)
THEN
PROC_StopLoopEffect(_Player,"RC_FL_BrokenPromises_KissFX");
PROC_StopLoopEffect(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"RC_FL_BrokenPromises_AlmiraFX");

//END_REGION

//REGION Character Deaths
IF
CharacterDying(_AlmiraGroup)
AND
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_DeathFlag)
AND
DB_IsPlayer(_Player)
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153,_AlmiraGroup);
PartySetFlag(_Player,_DeathFlag);
DB_NoLowAttitudeDialog(_AlmiraGroup);

IF
CharacterDying(_AlmiraGroup)
AND
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_)
AND
DB_IsPlayer(_Player)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_FL_BrokenPromises_Escort",1)
THEN
ObjectClearFlag(_Player,"RC_FL_BrokenPromises_MihalyFollows");

IF
ObjectFlagSet("QuestUpdate_RC_FL_BrokenPromises_MihalyDied",(CHARACTERGUID)_Player,_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f)
THEN
Proc_StartDialog(0,"RC_FL_Almira",CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_Player);

//END_REGION


//REGION Almira attacks
IF
DialogEnded(_,_ID)
AND
DB_DialogNPCs(_ID,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag(_Player,"RC_FL_Almira_Attack",1)
AND
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_)
THEN
ProcSetRelationToPlayers(_AlmiraGroup,0);

IF
DialogEnded(_,_ID)
AND
DB_DialogNPCs(_ID,CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,_)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
ObjectGetFlag((CHARACTERGUID)_Player,"RC_FL_Almira_Attack",1)
AND
DB_RC_FL_BrokenPromises_PlayerWithMihaly(_Char)
AND
CharacterIsInPartyWith(_Char,_Player,1)
THEN
ObjectClearFlag(_Char,"RC_FL_BrokenPromises_MihalyFollows");

//END_REGION


//REGION Almira on LV
//Removing Almira from RC
IF
DialogEnded("RC_FL_Almira",_ID)
AND
GlobalGetFlag("RC_FL_BrokenPromises_AlmiraToShip",1)
AND
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_)
THEN
ProcCharacterDisappearOutOfSightToObject(_AlmiraGroup,S_RC_LV_Entrance_5d830273-0215-4be4-96ce-8a1122f01bb0,0,"RC_LV_ReturnToLVAfterQuest",1);
SetHasDialog(_AlmiraGroup,0);
TriggerUnregisterForCharacter(TRIGGERGUID_S_S_RC_FL_BrokenPromises_Box_9ba2179f-e23f-48eb-b41c-7cdc10506153,_AlmiraGroup);

IF
CharacterEnteredTrigger(_AlmiraGroup,S_RC_LV_OnBoard_3d5b3e43-2126-464e-81d1-3c0b60841276)
AND
DB_RC_FL_AlmiraGroup(_AlmiraGroup,_)
THEN
SetHasDialog(_AlmiraGroup,1);

IF
CharacterEnteredTrigger(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,S_RC_LV_OnBoard_3d5b3e43-2126-464e-81d1-3c0b60841276)
THEN
CharacterSetCustomTradeTreasure(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,"RC_FL_Mihaly");
CharacterSetCanTrade(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,1);

//Tablet found
IF
ObjectFlagSet("GLO_HasAtaraxianTablet_PromiseInfo",(CHARACTERGUID)_Player,_)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_FL_TabletForAlmira_TabletFound");

IF
ObjectFlagSet("RC_FL_Almira_GivesRewardForTablet",(CHARACTERGUID)_Player,_)
THEN
ItemTemplateAddTo("QUEST_AlmiraRing_4b9bb633-8762-43fd-89b2-ec6532e1339d",_Player,1);


//Removing Almira from the ship
PROC
ProcRegionEnded("RC_Main")
AND
DB_IsPlayer(_Player)
AND
DB_IsPlayer(_Char)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_FL_TabletForAlmira_TabletQuest",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_FL_TabletForAlmira_GaveTabletAlmira",0)
AND
ObjectGetFlag(_Char,"GLO_HasAtaraxianTablet_PromiseInfo",0)
THEN
SetOnStage(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,0);
SetOnStage(CHARACTERGUID_S_GLO_Mihaly_3355517b-0a92-426b-9160-54fa8507adf2,0);
GlobalClearFlag("RC_FL_BrokenPromises_AlmiraToShip");
ObjectSetFlag(_Player,"QuestUpdate_RC_FL_TabletForAlmira_LeftRegion");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
