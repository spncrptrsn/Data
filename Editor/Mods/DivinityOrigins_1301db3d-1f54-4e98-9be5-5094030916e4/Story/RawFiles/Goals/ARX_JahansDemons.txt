Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ARX_JahansDemonsVictims((CHARACTERGUID)CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,(CHARACTERGUID)CHARACTERGUID_S_ARX_Mhordkan_Victim_f1dfe5fe-8989-42e4-9a44-04e021174cc1);
DB_ARX_JahansDemonsVictims((CHARACTERGUID)CHARACTERGUID_S_ARX_Demons_Freed_ShainHound_503a9995-9033-4d4f-a190-f8af5d17dcfa,(CHARACTERGUID)CHARACTERGUID_S_ARX_Shain_Victim_5fcc6e2b-dafa-4e48-98e8-29544f619f04);


DB_ARX_SoulMates((CHARACTERGUID)CHARACTERGUID_S_ARX_JahansDemons_Fallback_01_185efcd7-4aa8-4091-b65e-2c62ff4199a3,(CHARACTERGUID)CHARACTERGUID_S_ARX_JahansDemons_Fallback_06_126a13cd-5931-4a25-b568-db5c609082b0);
DB_ARX_SoulMates(CHARACTERGUID_S_ARX_JahansDemons_Fallback_04_adeb719d-86a5-46c2-b7a9-1b82b5f24544,CHARACTERGUID_S_ARX_JahansDemons_Fallback_05_441c0c36-39bb-4563-a885-b06d6374af02);
DB_ARX_SoulMates(CHARACTERGUID_S_ARX_JahansDemons_Fallback_03_cfef563e-2391-43a3-b291-acc6ba6a6692,CHARACTERGUID_S_ARX_JahansDemons_Fallback_02_7f8d502d-cc64-475e-a0aa-18a4a0a98814);

DB_ARX_SoulMates_StatusOutsidecombat(CHARACTERGUID_S_ARX_JahansDemons_Fallback_Warrior_01_Animal_441c0c36-39bb-4563-a885-b06d6374af02,"SLEEPING");

DB_ARX_SoulMates_CompanionDied((CHARACTERGUID)CHARACTERGUID_S_ARX_JahansDemons_Fallback_01_185efcd7-4aa8-4091-b65e-2c62ff4199a3,"CLEAR_MINDED","ARX_JahansDemons_AD_Fallback_01");
DB_ARX_SoulMates_CompanionDied(CHARACTERGUID_S_ARX_JahansDemons_Fallback_04_adeb719d-86a5-46c2-b7a9-1b82b5f24544,"ENRAGED","ARX_JahansDemons_AD_Fallback_04");
DB_ARX_SoulMates_CompanionDied(CHARACTERGUID_S_ARX_JahansDemons_Fallback_03_cfef563e-2391-43a3-b291-acc6ba6a6692,"FORTIFIED","ARX_JahansDemons_AD_Fallback_03");

DB_ARX_SoulMates_CompanionDied(CHARACTERGUID_S_ARX_JahansDemons_Fallback_06_126a13cd-5931-4a25-b568-db5c609082b0,"STEEL_SKIN","GEB_AD_Noticed_AnimalAttackedAnimal");
DB_ARX_SoulMates_CompanionDied(CHARACTERGUID_S_ARX_JahansDemons_Fallback_05_441c0c36-39bb-4563-a885-b06d6374af02,"ENRAGED","GEB_AD_Noticed_AnimalAttackedAnimal");
DB_ARX_SoulMates_CompanionDied(CHARACTERGUID_S_ARX_JahansDemons_Fallback_02_7f8d502d-cc64-475e-a0aa-18a4a0a98814,"HASTED","GEB_AD_Noticed_AnimalAttackedAnimal");

Proc_ARX_JahansDemons_SetUp();
KBSECTION
//REGION Debug
IF
TextEventSet("arx_jahdem_tp")
THEN
Proc_ARX_JahansDemons_SetUp(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243);
Proc_ARX_JahansDemons_SetUp(CHARACTERGUID_S_ARX_Demons_Freed_ShainHound_503a9995-9033-4d4f-a190-f8af5d17dcfa);

IF
TextEventSet("soul")
AND
DB_ARX_SoulMates(_Char,_Tar)
THEN
CharacterUseSkill(_Char,"Target_Quest_PermanentSoulMate",_Tar,1,1);

//END_REGION

//REGION Init setup
PROC
Proc_ARX_JahansDemons_SetUp()
THEN
SetOnStage(CHARACTERGUID_S_ARX_Mhordkan_Victim_f1dfe5fe-8989-42e4-9a44-04e021174cc1,0);
SetOnStage(CHARACTERGUID_S_ARX_Shain_Victim_5fcc6e2b-dafa-4e48-98e8-29544f619f04,0);
SetOnStage(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,0);
SetOnStage(CHARACTERGUID_S_ARX_Demons_Freed_ShainHound_503a9995-9033-4d4f-a190-f8af5d17dcfa,0);

PROC
Proc_ARX_JahansDemons_SetUp()
AND
GlobalGetFlag("RC_BF_Mhordkan_Free",1)
THEN
Proc_ARX_JahansDemons_SetUp(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243);

PROC
Proc_ARX_JahansDemons_SetUp()
AND
GlobalGetFlag("RC_BF_Shain_Free",1)
THEN
Proc_ARX_JahansDemons_SetUp(CHARACTERGUID_S_ARX_Demons_Freed_ShainHound_503a9995-9033-4d4f-a190-f8af5d17dcfa);

PROC
Proc_ARX_JahansDemons_SetUp((CHARACTERGUID)_Demon)
AND
DB_ARX_JahansDemonsVictims(_Demon,_Victim)
THEN
SetOnStage(_Victim,1);
CreatePuddle(_Victim,"SurfaceBlood",4,8,1,2,1.0);
SetOnStage(_Demon,1);
SetVarObject(_Demon,"Victim",_Victim);
CharacterSetReactionPriority(_Demon,"Reaction_Feast",1500);
ProcCharacterMoveTo(_Demon,_Victim,0,"ARX_AtVictim");
Proc_ARX_JahansDemons_SetUp_KillFallback();

PROC
Proc_ARX_JahansDemons_SetUp()
AND
GlobalGetFlag("RC_BF_Mhordkan_Free",0)
AND
GlobalGetFlag("RC_BF_Shain_Free",0)
AND
DB_ARX_SoulMates(_Char,_Tar)
THEN
CharacterSetForceUpdate(_Char,1);
CharacterSetForceUpdate(_Tar,1);
CharacterUseSkill(_Char,"Target_Quest_PermanentSoulMate",_Tar,1,1);

PROC
Proc_ARX_JahansDemons_SetUp()
THEN
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_JahansDemons_FeastTrigger_a789a9cd-4641-4b16-ac1c-e1a1063a9f13);

PROC
Proc_ARX_JahansDemons_SetUp_KillFallback()
AND
QueryOnlyOnce("ARX_JahansDemons_SetUp_KillFallback")
AND
DB_ARX_SoulMates(_Char,_Other)
THEN
CharacterDie(_Char,0,"DoT");
SetOnStage(_Other,0);
NOT DB_ARX_SoulMates(_Char,_Other);

//END_REGION

//REGION Soulmates dying effects

IF
CharacterDied((CHARACTERGUID)_Tar)
AND
DB_ARX_SoulMates(_Char,_Tar)
THEN
CharacterSetForceUpdate(_Char,0);
CharacterSetForceUpdate(_Tar,0);

IF
CharacterDied(_Char)
AND
DB_ARX_SoulMates_CompanionDied(_Char,_,_)
THEN
Proc_ARX_SoulMates_CompanionDied(_Char);

PROC
Proc_ARX_SoulMates_CompanionDied((CHARACTERGUID)_Char)
AND
DB_ARX_SoulMates(_Char,_Other)
AND
DB_ARX_SoulMates_CompanionDied(_Other,_Status,_AD)
AND
NOT DB_Dead(_Other)
THEN
Proc_StartDialog(1,_AD,_Other);
PlayEffect(_Other,"RS3_FX_Skills_Water_Restoration_Impact_01");
ApplyStatus(_Other,_Status,-1.0,1);

PROC
Proc_ARX_SoulMates_CompanionDied((CHARACTERGUID)_Char)
AND
DB_ARX_SoulMates(_Other,_Char)
AND
DB_ARX_SoulMates_CompanionDied(_Other,_Status,_AD)
AND
NOT DB_Dead(_Other)
THEN
ApplyStatus(_Other,_Status,-1.0,1);
Proc_StartDialog(1,_AD,_Other);

//END_REGION

//REGION Entering area (dialog & set hostile)
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_JahansDemons_FeastTrigger_a789a9cd-4641-4b16-ac1c-e1a1063a9f13)
AND
ObjectIsOnStage(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,1)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,0)
THEN
Proc_StartDialog(0,"ARX_Outskirts_MhordkanAttack",CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,_Player);

IF
DialogEnded("ARX_Outskirts_MhordkanAttack",_)
AND
DB_ARX_JahansDemonsVictims(_Demon,_)
THEN
SetFaction(_Demon,"Evil NPC");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_JahansDemons_FeastTrigger_a789a9cd-4641-4b16-ac1c-e1a1063a9f13)
AND
ObjectIsOnStage(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,1)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,1)
AND
DB_ARX_JahansDemonsVictims(_Demon,_)
THEN
SetFaction(_Demon,"Evil NPC");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_JahansDemons_FeastTrigger_a789a9cd-4641-4b16-ac1c-e1a1063a9f13)
AND
ObjectIsOnStage(CHARACTERGUID_S_ARX_Demons_Freed_Mhordkan_863f2fd0-2ebc-49cc-acea-c97c60e1b243,0)
AND
DB_ARX_JahansDemonsVictims(_Demon,_)
THEN
SetFaction(_Demon,"Evil NPC");

//END_REGION

//REGION Goal completion
IF
CharacterDied(_Demon)
AND
DB_ARX_JahansDemonsVictims(_Demon,_Victim)
THEN
NOT DB_ARX_JahansDemonsVictims(_Demon,_Victim);
Proc_ARX_JahansDemons_CheckDead();

PROC
Proc_ARX_JahansDemons_CheckDead()
AND
SysCount("DB_ARX_JahansDemonsVictims",2,0)
THEN
GoalCompleted;
//END_REGION

//REGION Status on bear
IF
DB_ARX_SoulMates_StatusOutsidecombat(_NPC,_Status)
THEN
ApplyStatus(_NPC,_Status,-1.0,1);

IF
ObjectLeftCombat(_NPC,_)
AND
DB_ARX_SoulMates_StatusOutsidecombat((CHARACTERGUID)_NPC,_Status)
AND
NOT DB_Dead(_NPC)
THEN
ApplyStatus(_NPC,_Status,-1.0,1);


IF
ObjectEnteredCombat(_NPC,_)
AND
DB_ARX_SoulMates_StatusOutsidecombat(_NPC,_Status)
AND
HasActiveStatus(_NPC,_Status,1)
THEN
RemoveStatus(_NPC,_Status);
//END_REGION
EXITSECTION
SysClear("DB_ARX_JahansDemonsVictims",2);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_JahansDemons_FeastTrigger_a789a9cd-4641-4b16-ac1c-e1a1063a9f13);
ENDEXITSECTION
ParentTargetEdge "ARX"
