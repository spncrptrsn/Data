Version 1
SubGoalCombiner SGC_AND
INITSECTION
//http://fileserver-dmz/mediawiki/index.php/Slaver_Magisters
DB_KillCounter_Internal(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,"FTJ_Slavers");
DB_KillCounter_Internal(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,"FTJ_Slavers");
DB_KillCounter("FTJ_Slavers",2);

DB_SceneManager(CHARACTERGUID_S_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,"FTJ_Slavers");
DB_SceneManager(CHARACTERGUID_S_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,"FTJ_Slavers");
DB_SceneManager(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"FTJ_Slavers");
ProcCharacterEnableCrime(CHARACTERGUID_S_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,"ActiveUndead");
ProcCharacterEnableCrime(CHARACTERGUID_S_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,"ActiveUndead");
ProcCharacterEnableCrime(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"ActiveUndead");

DB_SceneTriggerManager("FTJ_Slavers", S_RC_DW_SceneTrigger_Slavers_906108724-e72a-4eaf-8b48-da6cfcb9527d, 0);

CharacterSetCanTrade(CHARACTERGUID_S_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a, 0);
CharacterSetCanTrade(CHARACTERGUID_S_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3, 0);

ProcTriggerRegisterForPlayers(RC_FTJ_SlaverEventStart_Box_b9c19d65-8726-4609-8951-4fa93f9d0d30);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_FTJ_SW_PlayerSwampArrived_9e3ed73e-ae5d-416e-b020-bf50dc55c462);

DB_SneakTriggerSpotter(TRIGGERGUID_S_FTJ_SlaverMagistersAttack_5b8a39f0-f344-4c16-ab50-b46fcea60c73, CHARACTERGUID_S_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a);
DB_SneakTriggerSpotter(TRIGGERGUID_S_FTJ_SlaverMagistersAttack_5b8a39f0-f344-4c16-ab50-b46fcea60c73, CHARACTERGUID_S_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3);
KBSECTION
PROC
Proc_SceneInterrupted(_NPC, _Character, "FTJ_Slavers", _)
AND
IsSpeakerReserved(_NPC, 0)
AND
NOT DB_IsPlayer(_Character)
AND
DB_IsPlayer(_Player)
THEN
CharacterSetRelationFactionToIndivFaction("RC_FTJ_SlaverMagister", (CHARACTERGUID)_Player, 0);
CharacterSetRelationIndivFactionToFaction((CHARACTERGUID)_Player, "RC_FTJ_SlaverMagister", 0);
SetVarFixedString(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "currentState", "State_WaitAtBoat");

PROC
Proc_SceneInterrupted(_NPC, _Character, "FTJ_Slavers", _)
AND
IsSpeakerReserved(_NPC, 0)
AND
DB_IsPlayer(_Character)
THEN
SetStoryEvent(_Character, "FTJ_StartChildEvent");
SetVarFixedString(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "currentState", "State_WaitAtBoat");

//REGION Combat
IF 
StoryEvent((CHARACTERGUID)_Player,"FTJ_StartChildEvent")
AND 
NOT QRY_FTJ_MagisterSlaversTalk(_Player)
AND
DB_IsPlayer(_Player)
THEN
CharacterSetRelationFactionToIndivFaction("RC_FTJ_SlaverMagister", (CHARACTERGUID)_Player, 0);
CharacterSetRelationIndivFactionToFaction((CHARACTERGUID)_Player, "RC_FTJ_SlaverMagister", 0);

IF 
StoryEvent((CHARACTERGUID)_Player,"FTJ_StartChildEvent")
AND 
QRY_FTJ_MagisterSlaversTalk(_Player)
THEN 
CharacterLookAt(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,_Player,0);
CharacterLookAt(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,_Player,0);
Proc_StartDialog(0,"FTJ_Kidnappers",RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,_Player,RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb);
DB_FTJ_SlaverChildEventOneShot(1);

QRY
QRY_FTJ_MagisterSlaversTalk((CHARACTERGUID)_Player)
AND
CharacterIsInCombat(_Player, 0)
AND
CharacterIsDead(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,0)
AND 
CharacterIsDead(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,0)
AND 
CharacterIsDead(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,0)
AND 
NOT DB_FTJ_SlaverChildEventOneShot(1)
THEN
DB_NOOP(1);

IF
TextEventSet("Slavers")
THEN
GlobalSetFlag("FTJ_SlaverMagisterLeave");

IF 
DialogEnded("FTJ_Kidnappers",_)
AND 
DB_KillCounter_Internal(_Enemy,"FTJ_Slavers")
AND
GlobalGetFlag("FTJ_SlaverMagisterLeave",0)
THEN 
CharacterSetRelationFactionToFaction("RC_FTJ_SlaverMagister", "Hero", 0);
CharacterSetRelationFactionToFaction("Hero", "RC_FTJ_SlaverMagister", 0);

IF 
DialogEnded("FTJ_Kidnappers",_)
AND 
DB_KillCounter_Internal((CHARACTERGUID)_Enemy,"FTJ_Slavers")
AND
GlobalGetFlag("FTJ_SlaverMagisterLeave",1)
THEN
SetStoryEvent(_Enemy, "GEN_CharacterDisableAllCrimesBeforeDisappear");
Proc_SceneOver("FTJ_Slavers");
ProcCharacterMoveTo(_Enemy,S_FTJ_StairsToPrisonFloor_290b85aa-0be9-8096-4434-2facda63dbc5,1,"GEN_GoOffStage");
TimerLaunch("FTJ_DelaySlaverKidDialog",1000);

IF
TimerFinished("FTJ_DelaySlaverKidDialog")
THEN
ReactOnKillCounter("FTJ_Slavers");

PROC
ReactOnKillCounter("FTJ_Slavers")
THEN 
Proc_FTJ_ChildOneSaved();

PROC 
Proc_FTJ_ChildOneSaved()
THEN 
GlobalSetFlag("FTJ_DistressedChildSaved");
DB_Dialogs(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"FTJ_KidnappedChild");
Proc_SceneOver("FTJ_Slavers");

//talk to the nearest available Player, else his script will cause him to run to the boat
PROC 
Proc_FTJ_ChildOneSaved()
AND 
DB_IsPlayer(_Player)
AND
CharacterIsControlled(_Player,1)
AND 
CharacterCanSee(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player,1)
AND 
QRY_SpeakerIsAvailable(_Player)
AND
NOT DB_FTJ_ChildSavedOneShot(1)
THEN 
Proc_StartDialog(0,"FTJ_KidnappedChild",RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player);
DB_FTJ_ChildSavedOneShot(1);

IF 
DialogStarted("FTJ_KidnappedChild",_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
AND 
QueryOnlyOnce("FTJ_ChildSavedDialog")
THEN 
SetVarFixedString(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"currentState","State_WaitAtBoat");
//ObjectSetFlag((CHARACTERGUID)_Player,"QuestAdd_FTJ_Child");
ObjectSetFlag((CHARACTERGUID)_Player,"QuestUpdate_FTJ_Child_StartChildSaved");
GlobalSetFlag("FTJ_DistressedChildSaved");

//REGION Han not saved
IF
CharacterEnteredTrigger(_Player,RC_FTJ_SlaverEventStart_Box_b9c19d65-8726-4609-8951-4fa93f9d0d30)
AND
DB_IsPlayer(_Player)
THEN
DB_FTJ_RC_FTJ_SlaverEventStart(1);
ProcTriggerUnregisterForPlayers(RC_FTJ_SlaverEventStart_Box_b9c19d65-8726-4609-8951-4fa93f9d0d30);

///// Set off stage if players enter start trigger then leave
IF
CharacterLeftTrigger(_,TRIGGERGUID_S_FTJ_SUB_PrisonGroundFloor_6c759383-8420-4354-ac44-b4fa5b2f7bb5)
AND
DB_FTJ_RC_FTJ_SlaverEventStart(1)
AND
GlobalGetFlag("FTJ_DistressedChildSaved",0)
AND
QRY_AnyRegionActive()
AND 
CharacterIsDead(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,0)
AND 
CharacterIsDead(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,0)
AND
GetClosestPlayer(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player,_Dist)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,0)
AND
_Dist > 40.0
THEN
SetOnStage(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,0);
SetOnStage(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,0);
SetOnStage(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,0);
DB_FTJ_SlaversLeftWithChild(1);
Proc_SceneOver("FTJ_Slavers");

IF
CharacterLeftTrigger(_,TRIGGERGUID_S_FTJ_SUB_PrisonGroundFloor_6c759383-8420-4354-ac44-b4fa5b2f7bb5)
AND
DB_FTJ_RC_FTJ_SlaverEventStart(1)
AND
GlobalGetFlag("FTJ_DistressedChildSaved",0)
AND
QRY_AnyRegionActive()
AND 
CharacterIsDead(RC_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a,0)
AND 
CharacterIsDead(RC_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3,0)
AND
GetClosestPlayer(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player,_Dist)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,0)
AND
GlobalGetFlag("FTJ_RaftToDunesUsed", 0)
AND
_Dist > 40.0
THEN
SetOnStage(RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,0);
//END_REGION

//END_REGION

//REGION Raft to the Dunes

IF
CharacterEnteredTrigger(_Player,S_RC_FTJ_EscapeRaftVB_Poly_5365bd9a-b315-44fc-8c80-caa31b362a0a)
AND
QRY_SpeakerIsAvailable(_Player)
AND
NOT DB_FTJ_SlaversLeftWithChild(1)
AND
GlobalGetFlag("FTJ_RaftToDunesUsed",0)
AND
GlobalGetFlag("FTJ_SW_HanLeaveMagisters", 0)
AND
GlobalGetFlag("FTJ_RaftToDunesDestroyed", 0)
AND
QueryOnlyOnce("FTJ_EscapeRaftVB")
THEN
StartVoiceBark("FTJ_VB_EscapeRaft",_Player);


//Start Raft dialog
IF 
CharacterUsedItem(_Player,RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5)
AND
QRY_SpeakerIsAvailable(RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5)
THEN
Proc_StartDialog(0,"FTJ_RaftToDunes",RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,_Player);

IF 
CharacterUsedItem(_Player,RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5)
AND
CharacterIsInCombat(_Player, 1)
THEN
Proc_StartDialog(1,"GLO_AD_CannotUseNow", _Player);

IF
ObjectFlagSet("FTJ_UseRaft",(CHARACTERGUID)_Player,_)
THEN
DB_RC_FTJ_UsedRaft(_Player);

IF
DialogEnded("FTJ_RaftToDunes",_)
AND
DB_RC_FTJ_UsedRaft(_Player)
THEN
GlobalSetFlag("FTJ_RaftToDunesUsed");
Proc_RC_FTJ_ClosePlayersUseRaft(_Player);
ItemSetCanInteract(RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,0);

//Bring Child With
PROC
Proc_FTJ_CheckForChildInRaft((CHARACTERGUID)_Player)
AND
GetDistanceTo(S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player,_Dist)
AND
_Dist < 14.0
AND
CharacterIsDead(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,0)
AND
GlobalGetFlag("FTJ_DistressedChildSaved",1)
AND
QueryOnlyOnce("Proc_FTJ_CheckForChildInRaft")
THEN
DialogRequestStop(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb);
TeleportTo(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,S_FTJ_CapturedChildOffRaft_Point_dc5ea4df-aa90-4f4b-850b-75c73104fafa,"RC_FTJ_TeleportToRaftExit",1);
ObjectSetFlag(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "FTJ_SW_ReachedSwamp", 0);
ObjectSetFlag(_Player, "QuestUpdate_FTJ_Escape_KidnappedKid", 0);

PROC
Proc_RC_FTJ_ClosePlayersUseRaft((CHARACTERGUID)_Player)
AND
DB_IsPlayer(_AllPlayers)
AND
GetDistanceTo(_AllPlayers,ITEMGUID_S_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,_Dist)
AND
_Dist < 10.0
AND
CharacterIsInPartyWith(_AllPlayers,_Player,1)
THEN
FadeToBlack(_AllPlayers, 0.8, 0, "FTJ_RaftToSwamps");
DB_FTJ_RaftToSwampsTeleporting(_AllPlayers);
ProcObjectTimer(_Player,"FTJ_DoUseBoatVB",2000);

IF
FadeOutDone(_, "FTJ_RaftToSwamps")
AND
DB_FTJ_RaftToSwampsTeleporting(_Player)
THEN
Proc_FTJ_CheckForChildInRaft(_Player);
FadeToBlack(_Player, 0.7, 1, "FTJ_RaftToSwamps");
NOT DB_FTJ_RaftToSwampsTeleporting(_Player);
TeleportTo(_Player,RC_FTJ_RaftEscapeDropOff_Point_d3587a39-76d8-40f1-ac4a-8d86c4b85638,"RC_FTJ_TeleportToRaftExit",1);

IF
FadeOutDone(_, "FTJ_RaftToSwamps")
THEN
TeleportTo(RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,RC_FTJ_RaftBeach_Point_cddba465-f616-40e9-9804-0e37af631606);

PROC
Proc_RC_FTJ_ClosePlayersUseRaft((CHARACTERGUID)_Player)
THEN
ItemSetCanInteract(ITEMGUID_S_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5, 0);

IF
StoryEvent((CHARACTERGUID)_Player,"RC_FTJ_TeleportToRaftExit")
AND
GetDistanceTo(_Player,CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Dist)
AND
_Dist < 14.0
THEN
ObjectSetFlag(_Player, "FTJ_SW_TookBoatWithHan");

IF
StoryEvent((CHARACTERGUID)_Player,"FTJ_ChildStartShelterDialog")
THEN
Proc_StartDialog(0,"FTJ_ChildTellPlayerOfShelter",S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,_Player);
//END_REGION

PROC
ProcOneShotTriggerEntered(_,TRIGGERGUID_S_FTJ_SW_PlayerSwampArrived_9e3ed73e-ae5d-416e-b020-bf50dc55c462)
THEN
ObjectSetFlag(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "FTJ_SW_PlayersEnteredSwamp");

IF
GlobalFlagSet("FTJ_SW_HanLeaveMagisters")
THEN
GlobalSetFlag("FTJ_DistressedChildSaved");
DB_OnlyOnce("FTJ_ChildSavedDialog");
DB_Dialogs(RC_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb,"FTJ_KidnappedChild");
Proc_SceneOver("FTJ_Slavers");

IF
GlobalFlagSet("FTJ_SW_HanLeaveMagisters")
AND
GlobalGetFlag("FTJ_RaftToDunesUsed", 0)
THEN
SetOnStage(CHARACTERGUID_S_FTJ_MagisterSlaver_001_1f5664fc-db5e-4428-a3ed-8719e5602d4a, 0);
SetOnStage(CHARACTERGUID_S_FTJ_MagisterSlaver_002_3dc0a0f4-07b6-4066-a99c-1706e33c98e3, 0);
SetOnStage(RC_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5,0);

IF
DB_CombatCharacters(_Character, _)
AND
DB_KillCounter_Internal(_Character,"FTJ_Slavers")
AND
GetVarFixedString(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "currentState", "State_NotSaved")
THEN
CharacterMoveTo(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, TRIGGERGUID_S_FTJ_HanWatchFight_e2df71db-b306-4acb-8c8d-2fb05cfdbe7a, 1, "FTJ_ArrivedWatchFightSlavers", 0);

IF
StoryEvent(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "FTJ_ArrivedWatchFightSlavers")
THEN
CharacterLookFromTrigger(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, TRIGGERGUID_S_FTJ_HanWatchFight_e2df71db-b306-4acb-8c8d-2fb05cfdbe7a, 1);

PROC
ProcCharInTriggerSpotted(_Player,TRIGGERGUID_S_FTJ_SlaverMagistersAttack_5b8a39f0-f344-4c16-ab50-b46fcea60c73)
AND
DB_KillCounter_Internal(_Enemy,"FTJ_Slavers")
AND
GlobalGetFlag("FTJ_SlaverMagisterLeave",0)
THEN 
DialogRequestStop(_Enemy);
ProcSetRelationToPlayers(_Enemy,0);

IF
ItemDestroyed(ITEMGUID_S_FTJ_RaftToDunes_4fdd3e34-1988-4933-9413-9be7f063c9e5)
THEN
GlobalSetFlag("FTJ_RaftToDunesDestroyed");

IF
DialogEnded("FTJ_KidnappedChild", _)
AND
ObjectGetFlag(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "FTJ_RunOffBrokenBoat", 1)
THEN
ObjectClearFlag(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, "FTJ_RunOffBrokenBoat", 0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_FTJ_CapturedChild_53d4aa5c-dd91-4e12-9ca8-d66879cc6ffb, 90, 1, "", 1);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "FortJoy"
