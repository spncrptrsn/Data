Version 1
SubGoalCombiner SGC_AND
INITSECTION
//https://sites.google.com/a/larian.com/larian-wikisite/dos2/quest-design-documentation/ambushes-on-the-hills

DB_Ghosts(CHARACTERGUID_RC_WH_Ambush02_SourcererCorpse_a06ea1fa-56e9-4112-b26c-e29fda535c95,CHARACTERGUID_RC_WH_Ambush02_Sourcerer_Ghost_a7a98245-d614-4d97-b676-9b5275ddd9ab,"RC_WH_Ambush02_SourcererGhost");

//DB_RC_WH_CollaredCorpse(CHARACTERGUID_RC_WH_Ambush01_DeadDwarf_11f458e9-4c31-4386-b9ca-e82b01fa0471);
DB_RC_WH_CollaredCorpse(CHARACTERGUID_RC_WH_Ambush02_DwarfCorpse_b9fe58a7-31ac-4273-8323-0e8506ea1487);
DB_RC_WH_CollaredCorpse(CHARACTERGUID_RC_WH_Ambush02_HumanCorpse_6c238598-396a-4f16-b159-dce49cd59e5d);
DB_RC_WH_CollaredCorpse(CHARACTERGUID_RC_WH_Ambush02_SourcererCorpse_a06ea1fa-56e9-4112-b26c-e29fda535c95);

DB_RC_WH_Ambushers((CHARACTERGUID)CHARACTERGUID_RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1);
DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca);
DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfCaster_516967c7-315b-499d-8779-255482b3106e);
DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfRanger_cc677d58-8ec6-4046-8d3d-d03bdb620e09);
DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfRogue_d8103bb4-79b5-4b2a-a5df-2681261acfc6);
DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52);

DB_RC_WH_AmbushesVBs(1,"RC_WH_VB_Ambush_StartOne","RC_WH_VB_Ambush_EndOne");
DB_RC_WH_AmbushesVBs(2,"RC_WH_VB_Ambush_StartTwo","RC_WH_RD_PostAmbushes");

//REGION Ambusher ghosts
DB_Ghosts(RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1,S_RC_WH_Ambush01_DwarfRanger_Spirit_4016bf30-ee08-48d4-b4ad-aade962ebef8,"RC_WH_Ambush01_DwarfRanger_Ghost");
DB_Ghosts(S_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca,S_RC_WH_Ambush01_DwarfCaster_Spirit_7b5bc070-0aae-4755-82b1-3192547fc134,"RC_WH_Ambush01_DwarfCaster_Ghost");
DB_Ghosts(RC_WH_Ambush02_DwarfRanger_cc677d58-8ec6-4046-8d3d-d03bdb620e09,S_RC_WH_Ambush02_DwarfRanger_Spirit_efe96f52-3577-46e7-9014-4e0e400f9a1b,"RC_WH_Ambush02_DwarfRanger_Ghost");
DB_Ghosts(RC_WH_Ambush02_DwarfRogue_d8103bb4-79b5-4b2a-a5df-2681261acfc6,S_RC_WH_Ambush02_DwarfRogue_Spirit_d261058d-abb1-412a-8771-63ed52b4f3f8,"RC_WH_Ambush02_DwarfRogue_Ghost");
DB_Ghosts(S_RC_WH_Ambush02_DwarfCaster_516967c7-315b-499d-8779-255482b3106e,S_RC_WH_Ambush02_DwarfCaster_Spirit_3acb9031-93b8-4be3-b8b2-eea3395b4543,"RC_WH_Ambush02_DwarfCaster_Ghost");
DB_Ghosts(S_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52,S_RC_WH_Ambush02_DwarfWarrior_Spirit_8e200bf5-4561-4063-b8b6-9197f5e0a449,"RC_WH_Ambush02_DwarfWarrior_Ghost");
//END_REGION


//REGION Ambush 01
DB_AmbushTrigger(TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,NULL_00000000-0000-0000-0000-000000000000);

DB_RC_WH_AmbushersForTrigger((TRIGGERGUID)TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,(CHARACTERGUID)CHARACTERGUID_S_RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1,(TRIGGERGUID)TRIGGERGUID_S_RC_WH_Ambush01_RangerPoint_eec660d5-1d4a-492d-8460-797f162a64b9);
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,CHARACTERGUID_S_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca,TRIGGERGUID_S_RC_WH_Ambush01_CasterPoint_f1871947-64aa-4d61-a1df-7c1d64ab1c2c);

DB_OneShotPlayerTrigger(TRIGGERGUID_RC_WH_Ambush01_WitsTrigger_38bb2777-0599-44de-88ff-9bb7c1010a55);

DB_RC_WH_AmbushAnnouncer((TRIGGERGUID)TRIGGERGUID_RC_WH_Ambush01_LeaveTrigger_a5932baf-d609-434e-bb7d-9f0979299d7c,(CHARACTERGUID)S_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca,"RC_WH_Ambush01_Proclamation");

//END_REGION


//REGION Ambush 02
DB_OneShotPlayerTrigger(TRIGGERGUID_S_RC_WH_Ambush02_CaravanCommentTrigger_b3273eea-778d-41c9-a4c8-c7d865c00aa4);

DB_AmbushTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,NULL_00000000-0000-0000-0000-000000000000);

DB_RC_WH_AmbushersForTrigger((TRIGGERGUID)TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,(CHARACTERGUID)CHARACTERGUID_RC_WH_Ambush02_DwarfCaster_516967c7-315b-499d-8779-255482b3106e,(TRIGGERGUID)TRIGGERGUID_S_RC_WH_Ambush02_CasterPoint_463c3005-9ac3-4f93-94ae-f1e6a31085f3);
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfRanger_cc677d58-8ec6-4046-8d3d-d03bdb620e09,TRIGGERGUID_S_RC_WH_Ambush02_RangerPoint_a18ff618-d9a7-4ef2-890a-fedd53bcf725);
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfRogue_d8103bb4-79b5-4b2a-a5df-2681261acfc6,TRIGGERGUID_S_RC_WH_Ambush02_RoguePoint_b9818dd8-d060-48dc-ad8c-03b3307b154e);
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52,TRIGGERGUID_S_RC_WH_Ambush02_WarriorPoint_0afbc544-91a2-406a-84cb-cf79aba3697c);

DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine01_b373691e-20f5-45c5-b870-1bdf165ea7e0);
DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine02_35951026-5516-49ea-b71c-1308e7ebba96);
DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine03_4bada126-d466-436d-a724-9bb37b6b3ab8);
DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine04_cec98ad6-0d43-485a-8e8f-0a9641560d7a);
DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine05_d386f24e-ebc3-42db-885b-0717da717fbf);

DB_RC_WH_AmbushAnnouncer((TRIGGERGUID)TRIGGERGUID_RC_WH_Ambush02_LeaveTrigger_5b0e3b20-8baa-48fc-9ad1-7b47b5cb60a3,(CHARACTERGUID)CHARACTERGUID_S_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52,"RC_WH_Ambush02_Proclamation");

//END_REGION
KBSECTION
//REGION Dying VB
IF
StoryEvent(_Possessed,"RC_WH_AD_PossessedMordusDwarfDies")
AND
StartDialog_Internal_NoDeadCheck("RC_WH_AD_PossessedMordusDwarfDies",0,_Possessed,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
DB_NOOP(1);
//END_REGION


//REGION Common
IF
DB_RC_WH_Ambushers(_Dwarf)
THEN
ApplyStatus(_Dwarf,"POSSESSED",-1.0);
SetOnStage(_Dwarf,0);

PROC
ProcLaunchAmbush(_Trigger,_Player)
AND
DB_RC_WH_AmbushAnnouncer(_LeaveTrigger,_Announcer,_Dialog)
AND
DB_RC_WH_AmbushersForTrigger(_Trigger,_Announcer,_WalkTrigger)
AND
NOT DB_RC_WH_AmbushAnnouncementStarted(_LeaveTrigger,_Player)
THEN
// Re-register trigger, because we want to start combat if the player tries
// sneak other characters past during the dialog
ProcTriggerRegisterForPlayers(_LeaveTrigger);
DB_RC_WH_AmbushAnnouncementStarted(_LeaveTrigger,_Player);
Proc_RC_WH_InitAmbusher(_Announcer,_WalkTrigger);
Proc_StartDialog(0,_Dialog,_Announcer,_Player);

IF
DB_Dead(_Announcer)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
THEN
NOT DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog);

PROC
Proc_RC_WH_InitAmbusher((CHARACTERGUID)_Ambusher,(TRIGGERGUID)_PointTrigger)
AND
GlobalGetFlag("RC_DW_WC_BossElderIsDead",0)
THEN
Foop(_Ambusher);
ProcCharacterMoveTo(_Ambusher,_PointTrigger,0,"");

//END_REGION


//REGION Ambush announcement
IF
DialogStarted(_Dialog,_)
AND
DB_RC_WH_AmbushAnnouncementStarted(_Trigger,_Player)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
THEN
DB_RC_WH_AmbushAnnouncementBusy(_Trigger);

// Start ambush if attacking ambusher or leaving the ambush trigger again
IF
CharacterLeftTrigger(_Player,_Trigger)
AND
QRY_AnyRegionActive()
AND
DB_RC_WH_AmbushAnnouncementStarted(_Trigger,_AnnouncementPlayer)
AND
HasActiveStatus(_Player,"INVISIBLE",0)
AND
HasActiveStatus(_Player,"SNEAKING",0)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
THEN
Proc_RC_WH_CleanUpAnnoucementAndLaunchAmbush(_Trigger,_AnnouncementPlayer);

IF
CharacterReceivedDamage(_Announcer, _, _)
AND
CharacterIsInCombat(_Announcer,0)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
AND
DB_RC_WH_AmbushAnnouncementStarted(_Trigger,_Player)
THEN
Proc_RC_WH_CleanUpAnnoucementAndLaunchAmbush(_Trigger,(CHARACTERGUID)_Player);

// End of dialog -> also start ambush
IF
DialogEnded(_Dialog,_ID)
AND
DB_RC_WH_AmbushAnnouncementStarted(_Trigger,_Player)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
THEN
NOT DB_RC_WH_AmbushAnnouncementBusy(_Trigger);
Proc_RC_WH_CleanUpAnnoucementAndLaunchAmbush(_Trigger,(CHARACTERGUID)_Player);

// Start actual ambush
PROC
Proc_RC_WH_CleanUpAnnoucementAndLaunchAmbush((TRIGGERGUID)_Trigger,(CHARACTERGUID)_Player)
AND
DB_RC_WH_AmbushAnnouncementBusy(_Trigger)
AND
DB_RC_WH_AmbushAnnouncer(_Trigger,_Announcer,_Dialog)
THEN
NOT DB_RC_WH_AmbushAnnouncementBusy(_Trigger);
DialogRequestStopForDialog(_Dialog,_Announcer);

PROC
Proc_RC_WH_CleanUpAnnoucementAndLaunchAmbush((TRIGGERGUID)_Trigger,(CHARACTERGUID)_Player)
THEN
ProcTriggerUnregisterForPlayers(_Trigger);
NOT DB_RC_WH_AmbushAnnouncementStarted(_Trigger) ;
Proc_RC_WH_LaunchAmbushForTrigger(_Trigger,_Player);

//END_REGION


//REGION Ambush 01
//Start ambush if player NOT sneaking AND NOT invisible when they aproach a trigger
PROC
Proc_RC_WH_LaunchAmbushForTrigger((TRIGGERGUID)TRIGGERGUID_RC_WH_Ambush01_LeaveTrigger_a5932baf-d609-434e-bb7d-9f0979299d7c,(CHARACTERGUID)_Player)
AND
DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_PointTrigger)
AND
NOT DB_RC_WH_AmbushAnnouncer(TRIGGERGUID_RC_WH_Ambush01_LeaveTrigger_a5932baf-d609-434e-bb7d-9f0979299d7c,_Ambusher,_)
THEN
Proc_RC_WH_InitAmbusher(_Ambusher,_PointTrigger);
Proc_RC_WH_EnterAmbush(_Player);
Proc_StartDialog(1,"RC_WH_AD_Ambush01_BattleCries",CHARACTERGUID_RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1);

//Check for Wits when player aproaches a trigger
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_RC_WH_Ambush01_WitsTrigger_38bb2777-0599-44de-88ff-9bb7c1010a55)
AND
DB_IsPlayer(_Char)
AND
QRY_IsInRange(_Player,_Char,10.0)
AND
QRY_CheckPlayerStat(_Char,"Wits",15)
AND
QueryOnlyOnce("RC_WH_Ambush_CheckWits")
THEN
DB_RC_WH_Ambush_WitsGood(1);
StartVoiceBark("RC_WH_VB_Ambush",_Char);

//Boost ambushers' initiative if player's Wits are low
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_RC_WH_Ambush01_WitsTrigger_38bb2777-0599-44de-88ff-9bb7c1010a55)
AND
NOT DB_RC_WH_Ambush_WitsGood(_)
AND
DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_)
AND
CharacterConsume(_Ambusher,"POTION_Medium_Perception_Potion",_)
THEN
DB_NOOP(1);

IF
CharacterDied(_Ambusher)
AND
DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_PointTrigger)
THEN
NOT DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_PointTrigger);
PROC_RC_WH_Ambushers_CheckAlive(TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a);

//END_REGION


//REGION Ambush 01 Mystic resolution
IF
DialogEnded("RC_WH_Ambush01_Proclamation",_InstanceID)
AND
ObjectGetFlag(CHARACTERGUID_S_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca,"RC_WH_AmbushersLeave",1)
AND
DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_PointTrigger)
THEN
Proc_RC_WH_Ambushes_CleaningUp(_Ambusher);
NOT DB_RC_WH_AmbushersForTrigger(RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,_Ambusher,_PointTrigger);
NOT DB_RC_WH_Ambushers(_Ambusher);

//END_REGION


//REGION Ambush 02 Ghost
PROC
PROC_GLOBAL_DialogStartRequested((CHARACTERGUID)CHARACTERGUID_RC_WH_Ambush02_Sourcerer_Ghost_a7a98245-d614-4d97-b676-9b5275ddd9ab,_Player)
AND
UserGetFlag((CHARACTERGUID)_Player,"RC_WH_Ambush2_Ghost_Peace",0)
THEN
PlayAnimation(CHARACTERGUID_RC_WH_Ambush02_Sourcerer_Ghost_a7a98245-d614-4d97-b676-9b5275ddd9ab,"skill_prepare_divine_01_loop");
PlayAnimation(CHARACTERGUID_RC_WH_Ambush02_Sourcerer_Ghost_a7a98245-d614-4d97-b676-9b5275ddd9ab,"skill_cast_aoe_divine_01_cast");

IF
ObjectFlagSet("RC_WH_Ambush02_Ghost_PlayerBlesses",CHARACTERGUID_RC_WH_Ambush02_Sourcerer_Ghost_a7a98245-d614-4d97-b676-9b5275ddd9ab,_ID)
AND
DialogGetInvolvedPlayer(_ID,1,_Player)
THEN
PlayAnimation(_Player,"skill_prepare_divine_01_loop");
PlayAnimation(_Player,"skill_cast_aoe_divine_01_cast");

//END_REGION


//REGION Comment about seeing ambushed caravan
PROC
ProcOneShotTriggerEntered(_Player,TRIGGERGUID_S_RC_WH_Ambush02_CaravanCommentTrigger_b3273eea-778d-41c9-a4c8-c7d865c00aa4)
THEN
Proc_StartDialog(1,"RC_WH_AD_Ambush02_CaravanComment",_Player);

// Don't trigger the AD if we started combat
IF
DB_RC_WH_AmbushTwoTriggered(_)
THEN
RemoveOneShotDialog(TRIGGERGUID_S_RC_WH_Ambush02_CaravanCommentTrigger_b3273eea-778d-41c9-a4c8-c7d865c00aa4);

//END_REGION


//REGION Ambush 02
// Source collars on corpses
IF
GameStarted("RC_Main",_)
AND
DB_RC_WH_CollaredCorpse(_Corpse)
AND
NOT DB_RC_WH_CollaredCorpse_OncePerCorpse((CHARACTERGUID)_Corpse)
THEN
DB_RC_WH_CollaredCorpse_OncePerCorpse(_Corpse);
PROC_LoopEffect("RS3_FX_GP_Status_HoECollar_01",_Corpse,"RC_DW_WC_SourceCollar","RC_Main","Dummy_NeckFX");

//Send Start ambush if player triggers a mine
IF
StoryEvent(_TrapMine,"Mine")
AND
DB_RC_WH_TrapMines(_TrapMine)
AND
NOT DB_RC_WH_AmbushTwoTriggered(_)
AND
GetClosestAlivePlayer(_TrapMine,_Player,_)
THEN
ProcTriggerUnregisterForPlayers(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79);
ProcLaunchAmbush(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,_Player);

//Send Start ambush if player NOT sneaking AND NOT invisible when they aproach a trigger
PROC
Proc_RC_WH_LaunchAmbushForTrigger(TRIGGERGUID_RC_WH_Ambush02_LeaveTrigger_5b0e3b20-8baa-48fc-9ad1-7b47b5cb60a3,_Player)
AND
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,_Ambusher,_PointTrigger)
AND
NOT DB_RC_WH_AmbushAnnouncer(TRIGGERGUID_RC_WH_Ambush02_LeaveTrigger_5b0e3b20-8baa-48fc-9ad1-7b47b5cb60a3,_Ambusher,_)
THEN
Proc_RC_WH_InitAmbusher(_Ambusher,_PointTrigger);
DB_RC_WH_AmbushTwoTriggered(1);
Proc_RC_WH_EnterAmbush(_Player);
Proc_StartDialog(1,"RC_WH_AD_Ambush02_BattleCries",CHARACTERGUID_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52);

IF
CharacterDied(_Ambusher)
AND
DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,_Ambusher,_PointTrigger)
THEN
NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,_Ambusher,_PointTrigger);
PROC_RC_WH_Ambushers_CheckAlive(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79);

//END_REGION


//REGION VB Playback
PROC
PROC_RC_WH_Ambushers_CheckAlive((TRIGGERGUID)_Trigger)
AND
NOT DB_RC_WH_AmbushersForTrigger(_Trigger,_,_)
AND
DB_RC_WH_AmbushedPlayer(_Player)
THEN
Proc_RC_WH_EndedAmbush(_Player);

PROC
Proc_RC_WH_EnterAmbush((CHARACTERGUID)_Player)
AND
NOT DB_RC_WH_AmbushNumber(_)
THEN
DB_RC_WH_AmbushNumber(1);

PROC
Proc_RC_WH_EnterAmbush((CHARACTERGUID)_Player)
AND
DB_RC_WH_AmbushNumber(_Ambush)
AND
DB_RC_WH_AmbushesVBs(_Ambush,_Dialog,_)
THEN
StartVoiceBark(_Dialog,_Player);
DB_RC_WH_AmbushedPlayer(_Player);

PROC
Proc_RC_WH_EndedAmbush((CHARACTERGUID)_Player)
AND
DB_RC_WH_AmbushNumber(_Ambush)
AND
DB_RC_WH_AmbushesVBs(_Ambush,_,_Dialog)
AND
IntegerSum(_Ambush,1,_NextAmbush)
AND
QRY_RC_WH_PlayDialog(_Ambush,_Dialog,_Player)
THEN
NOT DB_RC_WH_AmbushedPlayer(_Player);
NOT DB_RC_WH_AmbushNumber(_Ambush);
DB_RC_WH_AmbushNumber(_NextAmbush);

QRY
QRY_RC_WH_PlayDialog((INTEGER)_Ambush,(STRING)_Dialog,(CHARACTERGUID)_Player)
AND
_Ambush == 1
THEN
StartVoiceBark(_Dialog,_Player);

QRY
QRY_RC_WH_PlayDialog((INTEGER)_Ambush,(STRING)_Dialog,(CHARACTERGUID)_Player)
AND
_Ambush == 2
THEN
ProcObjectTimer(_Player,_Dialog,3000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RC_WH_RD_PostAmbushes")
THEN
ProcDefineReflectionDialog("RC_WH_RD_PostAmbushes",_Player);
DB_RC_WH_ClearAmbushes(1);

//END_REGION


//REGION Flags to use in other goals (RC_WH_DwarvenCamp)
PROC
Proc_RC_WH_EnterAmbush((CHARACTERGUID)_Player)
THEN
UserSetFlag(_Player,"RC_WH_Ambushes_Encountered");

//END_REGION


//REGION Cleaning Up
IF
DB_RC_WH_ClearAmbushes(1)
THEN
GoalCompleted;

IF
GlobalFlagSet("RC_DW_WC_BossElderIsDead")
AND
DB_RC_WH_Ambushers(_Dwarf)
THEN
DialogRequestStop(_Dwarf);
Proc_RC_WH_Ambushes_CleaningUp(_Dwarf);

PROC
Proc_RC_WH_Ambushes_CleaningUp((CHARACTERGUID)_Character)
AND
DB_IsPlayer(_Char)
THEN
RemoveStatus(_Character,"POSSESSED");
SetFaction(_Character,"Neutral");
LeaveCombat(_Character);
ChangeAttitude(_Character,_Char,0);
SetHasDialog(_Character,0);
CharacterDisappearOutOfSight(_Character,79,1,"",1);

IF
GlobalFlagSet("RC_DW_WC_BossElderIsDead")
THEN
GoalCompleted;

//END_REGION
EXITSECTION
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1);
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca);
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfCaster_516967c7-315b-499d-8779-255482b3106e);
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfRanger_cc677d58-8ec6-4046-8d3d-d03bdb620e09);
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfRogue_d8103bb4-79b5-4b2a-a5df-2681261acfc6);
NOT DB_RC_WH_Ambushers(CHARACTERGUID_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52);

NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,CHARACTERGUID_S_RC_WH_Ambush01_DwarfRanger_6fe51a7e-7a70-4151-9f0b-b1d21ffd9dc1,TRIGGERGUID_S_RC_WH_Ambush01_RangerPoint_eec660d5-1d4a-492d-8460-797f162a64b9);
NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush01_CombatTrigger_b8931c03-c3e1-418a-a1b9-81efdff7d08a,CHARACTERGUID_S_RC_WH_Ambush01_DwarfCaster_ade0ee22-8fb7-422b-9c32-978a1f5f79ca,TRIGGERGUID_S_RC_WH_Ambush01_CasterPoint_f1871947-64aa-4d61-a1df-7c1d64ab1c2c);

NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfCaster_516967c7-315b-499d-8779-255482b3106e,TRIGGERGUID_S_RC_WH_Ambush02_CasterPoint_463c3005-9ac3-4f93-94ae-f1e6a31085f3);
NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfRanger_cc677d58-8ec6-4046-8d3d-d03bdb620e09,TRIGGERGUID_S_RC_WH_Ambush02_RangerPoint_a18ff618-d9a7-4ef2-890a-fedd53bcf725);
NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfRogue_d8103bb4-79b5-4b2a-a5df-2681261acfc6,TRIGGERGUID_S_RC_WH_Ambush02_RoguePoint_b9818dd8-d060-48dc-ad8c-03b3307b154e);
NOT DB_RC_WH_AmbushersForTrigger(TRIGGERGUID_RC_WH_Ambush02_CombatTrigger_cdc42ba3-24eb-4edb-adbc-7f3c2892be79,CHARACTERGUID_RC_WH_Ambush02_DwarfWarrior_7c63431f-4a27-4e63-acfe-f24f23745b52,TRIGGERGUID_S_RC_WH_Ambush02_WarriorPoint_0afbc544-91a2-406a-84cb-cf79aba3697c);

NOT DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine01_b373691e-20f5-45c5-b870-1bdf165ea7e0);
NOT DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine02_35951026-5516-49ea-b71c-1308e7ebba96);
NOT DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine03_4bada126-d466-436d-a724-9bb37b6b3ab8);
NOT DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine04_cec98ad6-0d43-485a-8e8f-0a9641560d7a);
NOT DB_RC_WH_TrapMines(ITEMGUID_S_RC_WH_Ambush02_Mine05_d386f24e-ebc3-42db-885b-0717da717fbf);

NOT DB_RC_WH_AmbushesVBs(1,"RC_WH_VB_Ambush_StartOne","RC_WH_VB_Ambush_EndOne");
NOT DB_RC_WH_AmbushesVBs(2,"RC_WH_VB_Ambush_StartTwo","RC_WH_RD_PostAmbushes");
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
