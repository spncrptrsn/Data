Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dying Magister
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"ARX_Outskirts_DyingMagister");
DB_Ghosts(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,CHARACTERGUID_S_ARX_Outskirts_DyingMagister_Ghost_9f50e930-1b85-4c14-9cdd-3c6d94ab807d,"ARX_Outskirts_DyingMagister_Ghost");
DB_DoNotFace(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380);
DB_OneShotPlayerTrigger(TRIGGERGUID_S_ARX_Outskirts_DyingMagister_Trigger_ee3d2be3-a541-480d-978a-5bcacb6f4948);

CharacterSetArmorPercentage(CHARACTERGUID_S_ARXt_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,0.0);
CharacterSetMagicArmorPercentage(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,0.0);

//END_REGION
//REGION Escaping pilgrims 
DB_OneShotPlayerTrigger(TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_PolyTrig_265a623f-616f-4ca7-ae64-188cfc10a11a);
//END_REGION
//REGION Pilgrim camp / Welcoming Pilgrims
//Pilgrims
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_01_4b0b9682-2a28-4e81-9623-4ac0852a77df,"ARX_Outskirts_PilgrimCamp_Pilgrim_01");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_02_94aabc2a-f496-4c20-973f-44e727108167,"ARX_Outskirts_PilgrimCamp_Pilgrim_02");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_03_868b6616-d3f0-4ddb-96ab-f2da61f85383,"ARX_Outskirts_PilgrimCamp_Pilgrim_03");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_04_1e26f4fd-8721-4ac0-890b-0ac8a3ae282b,"ARX_Outskirts_PilgrimCamp_Pilgrim_04");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_05_bc7e692e-288f-467f-8a73-07aa2b5889c6,"ARX_Outskirts_PilgrimCamp_Pilgrim_05");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_SpyMaster_Lizard_4273f979-51ef-4884-a550-0490993a39ef,"ARX_Outskirts_PilgrimCamp_Pilgrim_06"); //Used as a Spy for the SpyMaster
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_07_3e119fa8-c377-468d-a0b8-0ac08523f2cb,"ARX_Outskirts_PilgrimCamp_Pilgrim_07");
DB_DoNotFace(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Pilgrim_01_4b0b9682-2a28-4e81-9623-4ac0852a77df);

//Travellers
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Traveller_000_71899aaa-9fed-4600-af3e-17f6dc0babac,"ARX_Outskirts_PilgrimCamp_Traveller_000");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_PilgrimCamp_Traveller_001_58df1fda-55b3-45e2-bc58-a8e511553839,"ARX_Outskirts_PilgrimCamp_Traveller_001");

//Voice barks
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_ARX_Outskirts_PilgrimCamp_VB_Box_954ab4fa-ee17-4b3a-bdf6-be337bb14f42,"ARX_Outskirts_VB_NoticePilgrimCamp");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_ARX_Outskirts_BrokenBridgeVB_Box_1281acc9-fa1a-414e-a9e5-d1e31a7ad350,"ARX_Outskirts_VB_BrokenBridgeVista");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_ARX_Outskirts_LVVistaVB_Box_9dd3a958-bd5d-462f-8951-9303ffcbfc5f,"ARX_Outskirts_VB_LadyVengeanceVista");
//DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_ARX_Outskirts_PilgrimCamp_CampfireVB_Box_41773325-0654-42af-ba49-a55cd93cc224,"ARX_Outskirts_VB_PilgrimCampfire");
DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_ARX_Outskirts_DeathfogBelow_VB_Box_247a41fc-8d6b-4f06-a0fa-acd62556e6dc,"ARX_Outskirts_VB_DeathfogBelow");

//Welcoming Pilgrims
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,"ARX_Outskirts_WelcomingPilgrim_000");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"ARX_Outskirts_WelcomingPilgrim_001");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_BoxTrigger_dd3f2c7e-c466-4193-9690-6d04c935e64a);
DB_Outskirts_WelcomingPilgrims((CHARACTERGUID)CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,(TRIGGERGUID)TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_Point_000_341208f4-7713-433d-a5c5-589841b27eb9,"Look_Down_Long_01");
DB_Outskirts_WelcomingPilgrims((CHARACTERGUID)CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,(TRIGGERGUID)TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_Point_001_34aae0b5-8898-4696-ac3f-c9af3dbe1437,"Look_Down_Short_01");
//END_REGION
//REGION Signs, statues, etc.
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_Outskirts_Statue_TheDivine_000_3bf6b74b-102c-4ebe-af92-99193978caff,"ARX_Outskirts_AD_DivineStatue_000");
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_Outskirts_RoadChapel_A_000_4717d421-1c3c-466c-9d1f-1be051d7d01e,"ARX_Outskirts_AD_RoadChapel_000");
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_Outskirts_RoadChapel_A_001_f3f4dc4a-6f15-49f6-89b4-178cfc99000f,"ARX_Outskirts_AD_RoadChapel_001");
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_Outskirts_RoadChapel_A_002_fab67131-4486-4776-867a-2a2da5ad6dd7,"ARX_Outskirts_AD_RoadChapel_002");
DB_ARX_Cathedral_InteractiveAD(ITEMGUID_S_ARX_Outskirts_RoadChapel_A_003_96931c7b-4902-4c26-b9a3-d609db10cc16,"ARX_Outskirts_AD_RoadChapel_003");
//END_REGION
//REGION Animals

DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Animals_Squirrel_A_000_3087edca-a557-4a14-b908-b6a7d47db4c8,"ARX_Outskirts_Squirrel_000");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Animals_Squirrel_A_001_b6fb216c-f357-47bf-acdb-07ce03a1f706,"ARX_Outskirts_Squirrel_001");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Animals_Squirrel_A_002_69216260-b451-484f-8fb9-661e6037d96a,"ARX_Outskirts_Squirrel_002");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Animals_Rabbit_A_000_2018c20c-4cac-45c0-964d-26be65bb4bca,"ARX_Outskirts_Rabbit_000");
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Animals_Deer_A_000_30cf001e-4c9c-49ef-8e72-fdc9d2797583,"ARX_Outskirts_Deer_000");

//END_REGION
//REGION piles

DB_ShovelArea(TRIGGERGUID_S_ARX_Outskirts_Dirtpile_Box_000_2e3159f2-c9f7-4b1f-b638-ecd8e17af090,"ARX_Outskirts_DirtpileReward",ITEMGUID_S_ARX_Outskirts_Dirtpile_000_a9b0b7ca-fe00-4962-83eb-ce75925eb656);
DB_ShovelRewardItemAppear("ARX_Outskirts_DirtpileReward",ITEMGUID_S_ARX_Outskirts_Dirtpile_Chest_000_9590f331-2856-4c1d-b25c-009581dbea10,TRIGGERGUID_S_ARX_Outskirts_Dirtpile_Chest_Point_000_1586c868-01fd-4c23-856c-47d01c6a81c1);

DB_ShovelArea(TRIGGERGUID_S_ARX_Outskirts_Forestpile_Box_000_621dac54-00e2-471a-9cac-4a52ebf0031b,"ARX_Outskirts_ForestpileReward",ITEMGUID_S_ARX_Outskirts_Forestpile_000_b7cf5f8a-99c1-4dad-b34e-fba2db77f352);
DB_ShovelRewardItemAppear("ARX_Outskirts_ForestpileReward",ITEMGUID_S_ARX_Outskirts_Forestpile_Chest_000_9b8ee4ed-1292-4857-8555-ccb3f96165ca,TRIGGERGUID_S_ARX_Outskirts_Forestpile_Chest_Point_000_ee762281-bbcb-4762-aabd-3cbf1d72d714);

//END_REGION
//REGION roads
DB_Dialogs(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d,"ARX_Outskirts_Roads_LoharEmissary");
DB_DoNotFace(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d);
//END_REGION
//REGION pilgrim set

DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Band_A_392e580b-690e-4f2a-b4a1-e17076ade407");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Belt_A_7d8f0c71-c602-4144-894c-5f3673d909c4");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Boots_A_c38f9cbd-918b-437c-ab1b-97a394a1f00d");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Cowl_A_103aed36-c53e-4fc4-a9f4-7c08b8655dcd");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Gloves_A_a45d41fb-0d15-4a47-a504-3e343faa815b");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Mantle_A_98cf1716-2914-4a9b-b88b-f33c3da3a13a");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Pants_A_ca26411a-c447-46c2-9adb-3a3dfa5b8074");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Ring_A_d406a818-5e2d-4bcf-83b8-e0c24786d6da");
DB_PilgrimSet("ARM_UNIQUE_Pilgrim_Talisman_A_852def9d-3cb9-403c-ae6f-991f0dbdb583");

DB_PilgrimSet_Slot("Breast");
DB_PilgrimSet_Slot("Belt");
DB_PilgrimSet_Slot("Gloves");
DB_PilgrimSet_Slot("Boots");
DB_PilgrimSet_Slot("Ring");
DB_PilgrimSet_Slot("Ring2");
DB_PilgrimSet_Slot("Helmet");
DB_PilgrimSet_Slot("Leggings");
DB_PilgrimSet_Slot("Amulet");

//END_REGION
KBSECTION
//REGION Dying Magister

PROC
ProcOneShotTriggerEntered(_Char,TRIGGERGUID_S_ARX_Outskirts_DyingMagister_Trigger_ee3d2be3-a541-480d-978a-5bcacb6f4948)
AND
CharacterIsDead(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,0)
AND
GlobalGetFlag("ARX_Outskirts_DyingMagister_RunAway",0)
THEN
StartVoiceBark("ARX_Outskirts_VB_SeenDyingMagister",_Char);

IF
CharacterStatusRemoved(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN",_)
THEN
NOT DB_DoNotFace(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380);

IF
CharacterStatusRemoved(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN",_)
AND
DB_ARX_Outskirts_DyingMagister_LookAt(_Char,_Inst)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,_Char);
NOT DB_ARX_Outskirts_DyingMagister_LookAt(_Char,_Inst);

IF
CharacterStatusRemoved(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN",_)
AND
NOT DB_ARX_Outskirts_DyingMagister_LookAt(_,_)
THEN
GlobalSetFlag("ARX_Outskirts_DyingMagister_CharHealed");

IF 
ObjectFlagSet("ARX_Outskirts_DyingMagister_GaveHealthPotion",(CHARACTERGUID)_Char,_)
AND
QryRemoveTaggedLocalItemsFromMagicPockets(_Char,"HEALING_POTION",1)
AND
CharacterConsume(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"POTION_Large_Healing_Potion",_)
THEN 
DB_ARX_Outskirts_DyingMagister_GaveHealthPotion(_Char);
//CharacterSetHitpointsPercentage(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,90.0);
ObjectSetFlag(_Char,"ARX_Outskirts_DyingMagister_CharHealed");
GlobalSetFlag("ARX_Outskirts_DyingMagister_Healed");

IF 
CharacterStatusApplied(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,_String,(CHARACTERGUID)_Player)
AND 
QRY_IsHealingStatus(_String)
AND 
CharacterIsPartyMember(_Player,1)
AND
QueryOnlyOnce("ARX_Outskirts_DyingMagister_Heal")
THEN
ObjectSetFlag(_Player,"ARX_Outskirts_DyingMagister_CharHealed");
GlobalSetFlag("ARX_Outskirts_DyingMagister_Healed");
Proc_StartDialog(0,"ARX_Outskirts_DyingMagister",CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,_Player);

IF
ObjectFlagSet("ARX_Outskirts_DyingMagister_Kill",(CHARACTERGUID)_Char,_id)
THEN
DB_ARX_Outskirts_DyingMagister_Kill(_Char,_id);

IF
DialogEnded("ARX_Outskirts_DyingMagister",_id)
AND
DB_ARX_Outskirts_DyingMagister_Kill(_Char,_id)
THEN
CharacterAttack(_Char,CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380);

IF
AttackedByObject(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,_,_Attacker,_,_)
AND
CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380 != _Attacker
AND
DB_ARX_Outskirts_DyingMagister_Kill(_Char,_id)
THEN
CharacterDie(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,1,"Physical");
NOT DB_ARX_Outskirts_DyingMagister_Kill(_Char,_id);

IF
ObjectFlagSet("ARX_Outskirts_DyingMagister_StandUp",_Char,_Inst)
THEN
DB_ARX_Outskirts_DyingMagister_LookAt(_Char,_Inst);
RemoveStatus(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN");

IF
DialogEnded("ARX_Outskirts_DyingMagister",_)
AND
GlobalGetFlag("ARX_Outskirts_DyingMagister_RunAway",1)
THEN
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,0);
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,TRIGGERGUID_S_ARX_Outskirts_DyingMagister_DisappearTrig_3084754a-b7c9-4eef-8000-19eb01af0568,1,"ARX_Outskirts_DyingMagister_ReachedTrig");


IF
StoryEvent(_,"ARX_Outskirts_DyingMagister_ReachedTrig")
THEN
CharacterDisappearOutOfSightToObject(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_RunToTrig_36e17694-f0de-4433-87e0-972516199d0f,1,"",0);

IF
DialogStarted("ARX_Outskirts_DyingMagister",_)
THEN
GlobalSetFlag("ARX_Outskirts_DyingMagister_InitiateCheck");

IF
CharacterEnteredTrigger(_Char,TRIGGERGUID_S_ARX_ClanWarAndStatue_ActivationTrigger_67932552-0fa1-480e-99ed-287cb8751b28)
AND
GlobalGetFlag("ARX_Outskirts_DyingMagister_InitiateCheck",0)
THEN
GlobalSetFlag("ARX_Outskirts_DyingMagister_InitiateCheck");


IF
GlobalFlagSet("ARX_Outskirts_DyingMagister_OutOfSight")
AND
GlobalGetFlag("ARX_Outskirts_DyingMagister_Healed",0)
THEN
CharacterDie(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,1,"DoT");

IF
GlobalFlagSet("ARX_Outskirts_DyingMagister_OutOfSight")
AND
GlobalGetFlag("ARX_Outskirts_DyingMagister_Healed",1)
THEN
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,0);
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,TRIGGERGUID_S_ARX_Outskirts_DyingMagister_DisappearTrig_3084754a-b7c9-4eef-8000-19eb01af0568,1,"ARX_Outskirts_DyingMagister_ReachedTrig");

IF
ObjectEnteredCombat(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,_)
AND
HasActiveStatus(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN",1)
THEN
RemoveStatus(CHARACTERGUID_S_ARX_Outskirts_DyingMagister_1a5bff3b-91d1-4b56-9880-81ec2caca380,"KNOCKED_DOWN");
//END_REGION

//REGION Escaping pilgrims
PROC
ProcOneShotTriggerEntered(_Char,TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_PolyTrig_265a623f-616f-4ca7-ae64-188cfc10a11a)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_Outskirts_EscapingPilgrims_01_050f4ede-a99f-4564-b213-a28f7ce04eaf,TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_RunToTrig_36e17694-f0de-4433-87e0-972516199d0f,1,"ARX_Outskirts_EscapingPilgrims_AtFinalTrig");
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_Outskirts_EscapingPilgrims_02_813a8580-e5e1-43a6-a5ca-e47294f61175,TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_RunToTrig_36e17694-f0de-4433-87e0-972516199d0f,1,"ARX_Outskirts_EscapingPilgrims_AtFinalTrig");
ProcCharacterMoveTo(CHARACTERGUID_S_ARX_Outskirts_EscapingPilgrims_03_cbae91c0-91f9-4274-b5de-4a752aacd34d,TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_RunToTrig_36e17694-f0de-4433-87e0-972516199d0f,1,"ARX_Outskirts_EscapingPilgrims_AtFinalTrig");

IF
StoryEvent((CHARACTERGUID)_Char,"ARX_Outskirts_EscapingPilgrims_AtFinalTrig")
THEN
ProcCharacterDisappearOutOfSightToObject(_Char,(TRIGGERGUID)TRIGGERGUID_S_ARX_Outskirts_EscapingPilgrims_RunToTrig_000_3e22df64-0d9b-4bbe-bbb0-6d1293460e77,1,"ARX_Outskirts_EscapingPilgrims_AtFinalTrig_000",1);

IF
StoryEvent((CHARACTERGUID)_Char,"ARX_Outskirts_EscapingPilgrims_SpottedChar")
THEN
Proc_StartDialog(1,"ARX_Outskirts_AD_EscapingPilgrims",CHARACTERGUID_S_ARX_Outskirts_EscapingPilgrims_01_050f4ede-a99f-4564-b213-a28f7ce04eaf);
//END_REGION

//REGION Signs
IF
CharacterUsedItem(_Player,ITEMGUID_S_ARX_Outskirts_SignpostToDW_df46be59-33b9-4b67-ab05-a0edd2911442)
THEN
Proc_StartDialog(1,"ARX_Outskirts_AD_Signpost_Driftwood",ITEMGUID_S_ARX_Outskirts_SignpostToDW_df46be59-33b9-4b67-ab05-a0edd2911442,_Player);

//END_REGION

//REGION Debug
IF
TextEventSet("beasttoarx")
AND
DB_IsPlayer(_Char)
THEN
ObjectSetFlag(_Char,"RC_DW_Lohar_MicheilRos");
//END_REGION
 
//REGION Lohars emissary
IF
RegionStarted("ARX_Main")
AND
GlobalGetFlag("RC_DW_LoharsWeddingInvitation_RemovedFromLohar",0)
AND
QueryOnlyOnce("RC_DW_LoharsWeddingInvitation_ToEmissary")
THEN
ItemToInventory(ITEMGUID_S_RC_DW_LoharsWeddingInvitation_b1ceabe0-cf1c-4013-9c87-d05d19b74641,CHARACTERGUID_S_ARX_Outskirts_BloatedCorpse_001_74e2cd97-37a7-4c0a-8230-31c51902a375);

IF
ObjectFlagSet("QuestUpdate_RC_ARX_TheImperialDwarves_Outskirts_AttendingTheWedding",(CHARACTERGUID)_Char,_)
THEN
ProcShowMarker(_Char,"ARX_MerchantEstate");

IF
DialogStarted("ARX_Outskirts_Roads_LoharEmissary",_Id)
THEN
Proc_ARX_Outskirts_Roads_LoharEmissary(_Id);

PROC
Proc_ARX_Outskirts_Roads_LoharEmissary((INTEGER)_Id)
AND
DB_IsPlayer((CHARACTERGUID)_Char)
AND
DB_DialogPlayers(_Id,_Char,2)
THEN
CharacterLookAt(_Char,CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d);

PROC
Proc_ARX_Outskirts_Roads_LoharEmissary((INTEGER)_Id)
AND
DB_DialogPlayers(_Id,_Char,2)
AND
ObjectGetFlag(_Char,"RC_DW_Lohar_MicheilRos",1)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d,_Char);

PROC
Proc_ARX_Outskirts_Roads_LoharEmissary((INTEGER)_Id)
AND
DB_DialogPlayers(_Id,_Char,2)
AND
IsTagged(_Char,"DWARF-FRIEND",1)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d,_Char);

IF
ObjectFlagSet("ARX_Outskirts_Roads_LoharEmissary_FaceChar",_Char,_)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d,_Char);
ObjectClearFlag(_Char,"ARX_Outskirts_Roads_LoharEmissary_FaceChar");

IF
GlobalFlagSet("ARX_Outskirts_Roads_LoharEmissary_LookAway")
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_Roads_LoharEmissary_28ad69a5-50de-40cd-8164-1183b722877d,TRIGGERGUID_S_ARX_Outskirts_Roads_LoharEmissary_Trig_ffa5953b-3e6e-4789-9c20-74b5c87f0dd3);
GlobalClearFlag("ARX_Outskirts_Roads_LoharEmissary_LookAway");
//END_REGION

//REGION SpyMasters Spy
IF
CharacterCharacterEvent(_Lizard,_Player,"ARX_Outskirts_PilgrimCamp_SpyMaster_Lizard_SpottedRedPrince")
AND
GlobalGetFlag("CoS_SpymasterWarnedRedPrince",1)
THEN
Proc_StartDialog(1,"ARX_Outskirts_AD_PilgrimCamp_SpyMaster_Lizard_SpottedRedPrince",_Lizard);
CharacterLookAt(_Lizard,_Player);


//END_REGION

//REGION Welcoming Pilgrims

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_BoxTrigger_dd3f2c7e-c466-4193-9690-6d04c935e64a)
AND
GlobalGetFlag("ARX_Outskirts_WelcomingPilgrims_EventTriggered",0)
THEN
GlobalSetFlag("ARX_Outskirts_WelcomingPilgrims_EventTriggered");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_BoxTrigger_dd3f2c7e-c466-4193-9690-6d04c935e64a);
GlobalSetFlag("ARX_Outskirts_WelcomingPilgrims_GreetingPlayer");
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,0);
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,0);
DB_ARX_Outskirts_WelcomingPilgrims_SpottedPlayer(_Player);
ProcCharacterFollowCharacter(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073);
ProcCharacterMoveToAndTalk(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,_Player,"ARX_Outskirts_WelcomingPilgrim_000",0,"ARX_Outskirts_WelcomingPilgrims_RanUpToPlayer",1,30.0);

IF
StoryEvent(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,"ARX_Outskirts_WelcomingPilgrims_RanUpToPlayer")
AND
DB_ARX_Outskirts_WelcomingPilgrims_SpottedPlayer(_Player)
AND
NOT DB_Dead(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c)
THEN
ProcCharacterStopFollow(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c);
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,_Player);
PlayAnimation(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"Clap_01");
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,1);

IF
DialogEnded("ARX_Outskirts_WelcomingPilgrim_001",_)
AND
DB_GlobalFlag("ARX_Outskirts_WelcomingPilgrims_GreetingPlayer")
AND
DB_ARX_Outskirts_WelcomingPilgrims_SpottedPlayer(_Player)
THEN
CharacterLookAt(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,_Player);



//---Trigger moving to ledge
//failed
IF
CharacterMoveToAndTalkRequestDialogFailedEvent(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,_,"ARX_Outskirts_WelcomingPilgrims_RanUpToPlayer")
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_EventFailed();

IF
CharacterMoveToAndTalkFailed(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,_,"ARX_Outskirts_WelcomingPilgrims_RanUpToPlayer")
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_EventFailed();

PROC
Proc_ARX_Outskirts_WelcomingPilgrims_EventFailed()
THEN
ProcCharacterStopFollow(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c);
GlobalClearFlag("ARX_Outskirts_WelcomingPilgrims_GreetingPlayer");
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge();


//went through
IF
DialogEnded("ARX_Outskirts_WelcomingPilgrim_000",_)
AND
DB_GlobalFlag("ARX_Outskirts_WelcomingPilgrims_GreetingPlayer")
THEN
GlobalClearFlag("ARX_Outskirts_WelcomingPilgrims_GreetingPlayer");
Proc_ARX_Outskirts_WelcomingPilgrims_ADBeforeMoveToLedge();

PROC
Proc_ARX_Outskirts_WelcomingPilgrims_ADBeforeMoveToLedge()
AND
NOT DB_GlobalFlag("ARX_Outskirts_WelcomingPilgrims_TalkedToPlayer") //set when Godwoken is mentionned
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge();

PROC
Proc_ARX_Outskirts_WelcomingPilgrims_ADBeforeMoveToLedge()
AND
DB_GlobalFlag("ARX_Outskirts_WelcomingPilgrims_TalkedToPlayer")
THEN
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,0);
SetHasDialog(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073,0);
Proc_StartDialog(1,"ARX_Outskirts_WelcomingPilgrim_AD_Dual",CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073);
TimerLaunch("ARX_Outskirts_WelcomingPilgrims_MoveToLedge_Delay",4000);

IF
TimerFinished("ARX_Outskirts_WelcomingPilgrims_MoveToLedge_Delay")
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge();



// Cancelling the event if the player is wandering outside the main path
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Outskirts_DeathFogZone_Subregion_Box_9930dd4d-18db-49dc-b844-ad689f66834a)
AND
DB_IsPlayer(_Player)
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_Cancel();

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_ARX_Outskirts_Harbour_Subregion_Box_c14f8f58-aa68-4f8a-a18c-3a47dd16cf28)
AND
DB_IsPlayer(_Player)
THEN
Proc_ARX_Outskirts_WelcomingPilgrims_Cancel();

PROC
Proc_ARX_Outskirts_WelcomingPilgrims_Cancel()
AND
NOT DB_GlobalFlag("ARX_Outskirts_WelcomingPilgrims_EventTriggered")
THEN
GlobalSetFlag("ARX_Outskirts_WelcomingPilgrims_EventTriggered");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_ARX_Outskirts_WelcomingPilgrim_BoxTrigger_dd3f2c7e-c466-4193-9690-6d04c935e64a);
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge();



// Moving to ledge
PROC
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge()
AND
DB_ARX_Outskirts_WelcomingPilgrims_SpottedPlayer(_Player)
THEN
NOT DB_ARX_Outskirts_WelcomingPilgrims_SpottedPlayer(_Player);

PROC
Proc_ARX_Outskirts_WelcomingPilgrims_MoveToLedge()
AND
DB_Outskirts_WelcomingPilgrims(_Pilgrim,_Trigger,_Anim)
THEN
SetHasDialog(_Pilgrim,0);
ProcCharacterMoveTo(_Pilgrim,_Trigger,0,"ARX_Outskirts_WelcomingPilgrim_MovedToPoint");
SetVarObject(_Pilgrim,"DefaultPointTrigger",_Trigger);
SetVarInteger(_Pilgrim,"ReturnToDefaultPosition",1);
SetVarFixedString(_Pilgrim,"AnimationStanding",_Anim);



// Moved
IF
StoryEvent(_Pilgrim,"ARX_Outskirts_WelcomingPilgrim_MovedToPoint")
THEN
SetHasDialog(_Pilgrim,1);
SetVarObject(_Pilgrim,"Animation_LookAtTrigger",S_ARX_Outskirts_WelcomingPilgrim_Deathfog_LookAtPoint_6846b700-b81e-45a0-9e71-b0f894d01a80);

IF
StoryEvent(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"ARX_Outskirts_WelcomingPilgrim_MovedToPoint")
THEN
SetVarInteger(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"CanWander",1);
SetVarObject(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"talkTo_NPC",CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_000_1efaaccc-08a2-4322-a794-5dd010706073);
SetVarString(CHARACTERGUID_S_ARX_Outskirts_WelcomingPilgrim_001_217a37e1-bfc1-43ea-aea4-f44d1dcce27c,"talkTo_AD","ARX_Outskirts_WelcomingPilgrim_AD_Dual");


//END_REGION

//REGION pilgrim set
IF
TextEventSet("set")
AND
DB_IsPlayer(_Char)
AND
DB_PilgrimSet(_Temp)
THEN
ItemTemplateAddTo(_Temp,_Char,1,1);

IF
ItemTemplateEquipped(_Template,_Char)
AND
DB_PilgrimSet(_Template)
THEN
Proc_Arx_PilgrimSet_Check(_Char);

IF
ItemTemplateUnEquipped(_Template,_Char)
AND
DB_PilgrimSet(_Template)
AND
DB_PilgrimSet_Count(_Char,_Count)
THEN
NOT DB_PilgrimSet_Count(_Char,_Count);
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char);

PROC
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char)
AND
DB_PilgrimSet_Count(_Char,_Count)
THEN
NOT DB_PilgrimSet_Count(_Char,_Count);

PROC
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char)
THEN
DB_PilgrimSet_Count(_Char,0);

PROC
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char)
AND
DB_PilgrimSet_Slot(_Slot)
AND
CharacterGetEquippedItem(_Char,_Slot,_Item)
AND
GetTemplate(_Item,_Template)
AND
DB_PilgrimSet(_Template)
AND
DB_PilgrimSet_Count(_Char,_Count)
AND
IntegerSum(_Count,1,_NewCount)
THEN
DB_PilgrimSet_Count(_Char,_NewCount);

PROC
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char)
AND
DB_PilgrimSet_Count(_Char,9)
THEN
ObjectSetFlag(_Char, "GLO_PilgrimSetBless", 0);

PROC
Proc_Arx_PilgrimSet_Check((CHARACTERGUID)_Char)
AND
NOT DB_PilgrimSet_Count(_Char,9)
THEN
ObjectClearFlag(_Char, "GLO_PilgrimSetBless", 0);

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 6, 0, 4)
AND
DB_PilgrimSet_Count(_Char, 9)
THEN
RemoveStatus(_Char, "BLESSED");
ObjectSetFlag(_Char, "GLO_PilgrimSetBless", 0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ARX"
