Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_LastManStandingTeamList("PVP_1");
DB_LastManStandingTeamList("PVP_2");
DB_LastManStandingTeamList("PVP_3");
DB_LastManStandingTeamList("PVP_4");

KBSECTION
PROC
Proc_Arena_CheckWinCondition_CheckForLMS()
AND
DB_Arena_PlayerParticipants(_Arena,_Inst,_Char,_Team)
AND
IsTagged(_Char,"AVATAR",1)
AND
CharacterGetReservedUserID(_Char,_User)
AND
DB_Arena_PlayerParticipants(_Arena,_Inst,_UserCharacters,_Team)
AND
CharacterGetReservedUserID(_UserCharacters,_User)
AND
CharacterIsDead(_UserCharacters,0)
AND
DB_Arena_PlayerParticipants(_Arena,_Inst,_OtherChar,_Team)
AND
IsTagged(_OtherChar,"AVATAR",1)
AND
CharacterGetReservedUserID(_OtherChar,_OtherUser)
AND
_OtherUser != _User
AND
DB_Arena_PlayerParticipants(_Arena,_Inst,_OtherUserCharacters,_Team)
AND
CharacterGetReservedUserID(_OtherUserCharacters,_OtherUser)
AND
CharacterIsDead(_OtherUserCharacters,0)
AND
GlobalGetFlag("Arena_RequestingLastManStanding",0)
THEN
GlobalSetFlag("Arena_RequestingLastManStanding");
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1();

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
ObjectGetFlag(_Char,"Arena_LastManStanding_Accept",1)
THEN
ObjectClearFlag(_Char,"Arena_LastManStanding_Accept");

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_IsPlayer(_Char)
THEN
UserClearFlag(_Char,"ArenaLMS_HasAvatar",0);
UserClearFlag(_Char,"ArenaLMS_AvatarIsDead",0);


PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_LastManStanding_InitiateDialog_Count(_Int)
THEN
NOT DB_LastManStanding_InitiateDialog_Count(_Int);

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
THEN
DB_LastManStanding_InitiateDialog_Count(1);

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_LastManStanding_InitiateDialog_Speaker(_Count,_Char)
THEN
NOT DB_LastManStanding_InitiateDialog_Speaker(_Count,_Char);

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
THEN
DB_LastManStanding_InitiateDialog_Speaker(2,NULL_00000000-0000-0000-0000-000000000000);
DB_LastManStanding_InitiateDialog_Speaker(3,NULL_00000000-0000-0000-0000-000000000000);
DB_LastManStanding_InitiateDialog_Speaker(4,NULL_00000000-0000-0000-0000-000000000000);
DB_LastManStanding_InitiateDialog_Speaker(5,NULL_00000000-0000-0000-0000-000000000000);

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
IsTagged(_Char,"AVATAR",1)
THEN
UserSetFlag(_Char,"ArenaLMS_HasAvatar");

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
IsTagged(_Char,"AVATAR",1)
AND
CharacterIsDead(_Char,1)
THEN
UserSetFlag(_Char,"ArenaLMS_AvatarIsDead");

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
CharacterIsDead(_Char,0)
AND
DB_LastManStanding_InitiateDialog_Count(_Count)
AND
IntegerSum(_Count,1,_NewCount)
THEN
UserClearFlag(_Char,"ArenaLMS_UserMadeDecision",0);
DB_LastManStanding_InitiateDialog_Speaker(_NewCount,_Char);
NOT DB_LastManStanding_InitiateDialog_Speaker(_NewCount,NULL_00000000-0000-0000-0000-000000000000);
NOT DB_LastManStanding_InitiateDialog_Count(_Count);
DB_LastManStanding_InitiateDialog_Count(_NewCount);

PROC
ProcForceLeaveCombat((CHARACTERGUID)_Char)
THEN
LeaveCombat(_Char);

PROC
ProcForceLeaveCombat((CHARACTERGUID)_Char)
AND
DB_CombatCharacters(_Char,_ID)
THEN
NOT DB_CombatCharacters(_Char,_ID);

PROC
ProcForceLeaveCombat((CHARACTERGUID)_Char)
AND
DB_CombatObjects(_Char,_ID)
THEN
NOT DB_CombatObjects(_Char,_ID);


PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
THEN
ProcForceLeaveCombat(_Char);

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_LastManStanding_InitiateDialog_Speaker(_,_Char)
THEN
RemoveStatus(_Char,"CHARMED");

PROC
Proc_Arena_SetUp_LastManStanding_InitiateDialog_1()
AND
DB_Arena_PlayerParticipants(_Arena,_,_,_)
AND
DB_ArenaMaster(_Speaker1,_Dialog,_Arena,_)
AND
StringConcatenate(_Dialog,"_LastManStanding",(STRING)_NewDialog)
AND
DB_LastManStanding_InitiateDialog_Speaker(2,_Speaker2)
AND
DB_LastManStanding_InitiateDialog_Speaker(3,_Speaker3)
AND
DB_LastManStanding_InitiateDialog_Speaker(4,_Speaker4)
AND
DB_LastManStanding_InitiateDialog_Speaker(5,_Speaker5)
AND
QRY_StartDialog(0,_NewDialog,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_Speaker5)
THEN
DB_NOOP(1);


IF
GlobalFlagSet("Arena_LastManStanding_CheckDialogResults")
THEN
Proc_Arena_SetUp_CheckDialogResults();
GlobalClearFlag("Arena_LastManStanding_CheckDialogResults");

PROC
Proc_Arena_SetUp_CheckDialogResults()
THEN
GlobalClearFlag("Arena_LastManStanding_NoAccept");
GlobalClearFlag("Arena_LastManStanding_AcceptWinner");

PROC
Proc_Arena_SetUp_CheckDialogResults()
AND
DB_Arena_LastManStanding_AcceptCount(_Count)
THEN
NOT DB_Arena_LastManStanding_AcceptCount(_Count);

PROC
Proc_Arena_SetUp_CheckDialogResults()
THEN
DB_Arena_LastManStanding_AcceptCount(0);

PROC
Proc_Arena_SetUp_CheckDialogResults()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
ObjectGetFlag(_Char,"Arena_LastManStanding_Accept",1)
AND
DB_Arena_LastManStanding_AcceptCount(_Count)
AND
IntegerSum(_Count,1,_NewCount)
THEN
NOT DB_Arena_LastManStanding_AcceptCount(_Count);
DB_Arena_LastManStanding_AcceptCount(_NewCount);

PROC
Proc_Arena_SetUp_CheckDialogResults()
AND
DB_Arena_LastManStanding_AcceptCount(0)
THEN
GlobalSetFlag("Arena_LastManStanding_NoAccept");
GlobalClearFlag("Arena_RequestingLastManStanding");

PROC
Proc_Arena_SetUp_CheckDialogResults()
AND
DB_Arena_LastManStanding_AcceptCount(1)
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
ObjectGetFlag(_Char,"Arena_LastManStanding_Accept",1)
THEN
GlobalSetFlag("Arena_LastManStanding_AcceptWinner");
GlobalClearFlag("Arena_RequestingLastManStanding");

//REGION
IF
DialogEnded(_Dialog,_Inst)
AND
GlobalGetFlag("Arena_RequestingLastManStanding",1)
AND
DB_ArenaMaster(_,_ArenaDialog,_Arena,_)
AND
StringContains(_Dialog,_ArenaDialog,1)
AND
DB_Arena_PlayerParticipants(_Arena,_,_,_)
THEN
Proc_Arena_SetUp_LastManStanding_1();

IF
DialogEnded(_Dialog,_Inst)
AND
GlobalGetFlag("Arena_LastManStanding_AcceptWinner",1)
AND
DB_ArenaMaster(_,_ArenaDialog,_Arena,_)
AND
StringContains(_Dialog,_ArenaDialog,1)
AND
DB_Arena_PlayerParticipants(_Arena,_,_,_)
THEN
Proc_Arena_LastManStanding_SetDialogWinner();
GlobalClearFlag("Arena_LastManStanding_AcceptWinner");

IF
DialogEnded(_Dialog,_Inst)
AND
GlobalGetFlag("Arena_LastManStanding_NoAccept",1)
AND
DB_ArenaMaster(_,_ArenaDialog,_Arena,_)
AND
StringContains(_Dialog,_ArenaDialog,1)
AND
DB_Arena_PlayerParticipants(_Arena,_,_,_)
THEN
Proc_Arena_LastManStanding_SetDialogWinner();

PROC
Proc_Arena_LastManStanding_SetDialogWinner()
AND
DB_Arena_PlayerParticipants(_Arena,_Id,_Char,_Team)
THEN
NOT DB_Arena_PlayerParticipants(_Arena,_Id,_Char,_Team);
DB_Arena_PlayerParticipants(_Arena,_Id,_Char,"Arena_TeamB");

PROC
Proc_Arena_LastManStanding_SetDialogWinner()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
ObjectGetFlag(_Char,"Arena_LastManStanding_Accept",1)
AND
CharacterGetReservedUserID(_Char,_User)
AND
DB_Arena_PlayerParticipants(_Arena,_Id,_AnyChar,_Team)
AND
CharacterGetReservedUserID(_AnyChar,_User)
THEN
NOT DB_Arena_PlayerParticipants(_Arena,_Id,_AnyChar,_Team);
DB_Arena_PlayerParticipants(_Arena,_Id,_AnyChar,"Arena_TeamA");

PROC
Proc_Arena_LastManStanding_SetDialogWinner()
THEN
Proc_Arena_Win("Arena_TeamA");

//END_REGION

//REGION initiate last man standing
PROC
Proc_Arena_SetUp_LastManStanding_1()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
UserGetFlag(_Char,"Arena_LastManStanding_Accept",0)
AND
CharacterGetReservedUserID(_Char,_User)
AND
DB_Arena_PlayerParticipants(_,_,_AnyChar,_)
AND
CharacterGetReservedUserID(_AnyChar,_User)
THEN
Proc_Arena_SetUp_LastManStanding_RemoveChar(_AnyChar);
//CharacterDie(_AnyChar,0,"Explode");

PROC 
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
CharacterIsDead(_Char,1)
THEN
CharacterResurrectCustom(_Char,"");

PROC //Wait for Ring Girl
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
THEN
RemoveHarmfulStatuses(_Char);

PROC
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_PlayerParticipants(_Arena,_,_Char,_)
AND
DB_ArenaMaster(_,_,_Arena,_TeleportTo)
THEN
FadeToBlack(_Char,2.0,1,"Placeholder");
SetInArena(_Char,0);
CharacterSetSpectating(_Char,0);
TeleportTo(_Char,_TeleportTo);

PROC
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_CharIsAlive(_Team,_Char)
THEN
NOT DB_Arena_CharIsAlive(_Team,_Char);

PROC
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_PlayerParticipants(_Arena,_Inst,_Char,_Team)
THEN
NOT DB_Arena_PlayerParticipants(_Arena,_Inst,_Char,_Team);

PROC
Proc_Arena_SetUp_LastManStanding_RemoveChar((CHARACTERGUID)_Char)
AND
DB_Arena_PreviousFaction(_Char,_Faction)
THEN
SetFaction(_Char,_Faction);
NOT DB_Arena_PreviousFaction(_Char,_Faction);


PROC
Proc_Arena_SetUp_LastManStanding_1()
THEN
Proc_Arena_SetUp_LastManStanding_2();

PROC
Proc_Arena_SetUp_LastManStanding_2()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
CharacterIsDead(_Char,0)
AND
CharacterGetReservedUserID(_Char,_User)
AND
GetUserProfileID(_User,_Id)
AND
DB_LastManStandingTeamList(_Team)
AND
NOT DB_Arena_LastManStandingTeams(_,_,_Team)
AND
NOT DB_Arena_LastManStandingTeams(_,_Id,_)
AND
NOT DB_Arena_LastManStandingTeams(_Char,_,_)
THEN
DB_Arena_LastManStandingTeams(_Char,_Id,_Team);

PROC
Proc_Arena_SetUp_LastManStanding_2()
AND
DB_Arena_PlayerParticipants(_,_,_Char,_)
AND
CharacterGetReservedUserID(_Char,_User)
AND
GetUserProfileID(_User,_Id)
AND
DB_Arena_LastManStandingTeams(_,_Id,_Team)
AND
NOT DB_Arena_LastManStandingTeams(_Char,_,_)
THEN
DB_Arena_LastManStandingTeams(_Char,_Id,_Team);

PROC
Proc_Arena_SetUp_LastManStanding_1()
AND
DB_Arena_LastManStandingTeams(_Char,_,_Team)
THEN
SetFaction(_Char,_Team);

//END_REGION

//REGION win conditions
IF
CharacterDying(_Char)
AND
GlobalGetFlag("Arena_RequestingLastManStanding",1)
AND
DB_Arena_LastManStandingTeams(_Char,_User,_Team)
THEN
NOT DB_Arena_LastManStandingTeams(_Char,_User,_Team);
Proc_Arena_LastManStanding_CheckWinCondition();

IF
CharacterResurrected(_Char)
AND
GlobalGetFlag("Arena_RequestingLastManStanding",1)
AND
CharacterGetReservedUserID(_Char,_User)
AND
GetUserProfileID(_User,_Id)
AND
DB_Arena_LastManStandingTeams(_,_Id,_Team)
AND 
NOT DB_Arena_LastManStandingTeams(_Char,_,_)
THEN
DB_Arena_LastManStandingTeams(_Char,_Id,_Team);


PROC
Proc_Arena_LastManStanding_CheckWinCondition()
THEN
NOT DB_Arena_LastManStanding_NoWin(1);

PROC
Proc_Arena_LastManStanding_CheckWinCondition()
AND
DB_Arena_LastManStandingTeams(_,_,_User)
AND
DB_Arena_LastManStandingTeams(_,_,_OtherUser)
AND
_User != _OtherUser
THEN
DB_Arena_LastManStanding_NoWin(1);

PROC
Proc_Arena_LastManStanding_CheckWinCondition()
AND
NOT DB_Arena_LastManStanding_NoWin(1)
THEN
Proc_Arena_LastManStanding_SetWinState();

PROC
Proc_Arena_LastManStanding_SetWinState()
AND
DB_Arena_PlayerParticipants(_Arena,_ArenaID,_Char,_Team)
AND
CharacterGetReservedUserID(_Char,_User)
AND
GetUserProfileID(_User,_ProfileId)
AND
DB_Arena_LastManStandingTeams(_,_ProfileId,_)
THEN
NOT DB_Arena_PlayerParticipants(_Arena,_ArenaID,_Char,_Team);
DB_Arena_PlayerParticipants(_Arena,_ArenaID,_Char,"Arena_TeamA");

PROC
Proc_Arena_LastManStanding_SetWinState()
AND
DB_Arena_PlayerParticipants(_Arena,_ID,_Char,_Team)
AND
CharacterGetReservedUserID(_Char,_User)
AND
GetUserProfileID(_User,_ProfileId)
AND
DB_Arena_LastManStandingTeams(_,_OtherProfileId,_)
AND
_ProfileId != _OtherProfileId
THEN
NOT DB_Arena_PlayerParticipants(_Arena,_ID,_Char,_Team);
DB_Arena_PlayerParticipants(_Arena,_ID,_Char,"Arena_TeamB");

PROC
Proc_Arena_LastManStanding_SetWinState()
THEN
Proc_Arena_Win("Arena_TeamA");
GlobalClearFlag("Arena_RequestingLastManStanding");

PROC
Proc_Arena_Clear()
AND
DB_IsPlayer(_Char)
THEN
ObjectClearFlag(_Char,"Arena_LastManStanding_Accept",0);
//END_REGION

//REGION
IF
CharacterReservedUserIDChanged(_Char,_,_User)
AND
GlobalGetFlag("Arena_RequestingLastManStanding",1)
THEN
Proc_Arena_LastManStandingTeams_Reassigned(_User,_Char);

PROC
Proc_Arena_LastManStandingTeams_Reassigned((INTEGER)_User,(CHARACTERGUID)_Char)
AND
GetUserProfileID(_User,_Id)
AND
DB_Arena_LastManStandingTeams(_,_Id,_Team)
AND
DB_Arena_LastManStandingTeams(_Char,_OtherId,_OtherTeam)
THEN
NOT DB_Arena_LastManStandingTeams(_Char,_OtherId,_OtherTeam);
DB_Arena_LastManStandingTeams(_Char,_Id,_Team);
SetFaction(_Char,_Team);

PROC
Proc_Arena_LastManStandingTeams_Reassigned((INTEGER)_User,(CHARACTERGUID)_Char)
AND
DB_Arena_LastManStandingTeams(_Char,_OtherId,_Team)
AND
GetUserProfileID(_User,_Id)
AND
NOT DB_Arena_LastManStandingTeams(_,_Id,_)
THEN
NOT DB_Arena_LastManStandingTeams(_Char,_OtherId,_Team);
DB_Arena_LastManStandingTeams(_Char,_Id,_Team);
//SetFaction(_Char,_Team);


PROC
Proc_Arena_LastManStandingTeams_Reassigned(_,_Char)
AND
DB_Arena_LastManStandingTeams(_Char,_,_)
THEN
Proc_Arena_LastManStanding_CheckWinCondition();

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Shared_Campaign"
