Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
//REGION MoveToAndTalk

//Start Walking
PROC
ProcCharacterMoveToAndTalk((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent,(INTEGER)_Running,(REAL)_TimeOut)
THEN
ProcCharacterMoveToAndTalk((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent,(INTEGER)_Running,(REAL)_TimeOut,0,0);

PROC
ProcCharacterMoveToAndTalk((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent,(INTEGER)_Running,(REAL)_TimeOut,(INTEGER)_CheckForFallBackPlayers,(INTEGER)_ForcePartyCheck)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent)
THEN
NOT DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent);

PROC
ProcCharacterMoveToAndTalk((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent,(INTEGER)_Running,(REAL)_TimeOut,(INTEGER)_CheckForFallBackPlayers,(INTEGER)_ForcePartyCheck)
AND
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,_Target,_Dialog,_CheckForFallBackPlayers,_ForcePartCheck)
THEN
NOT DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,_Target,_Dialog,_CheckForFallBackPlayers,_ForcePartCheck);

PROC
ProcCharacterMoveToAndTalk((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent,(INTEGER)_Running,(REAL)_TimeOut,(INTEGER)_CheckForFallBackPlayers,(INTEGER)_ForcePartyCheck)
THEN
CharacterMoveToAndTalk(_Character,_Target,_Dialog,_IsAutomated,_MoveEvent,_Running,_TimeOut);
DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent);
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,_Target,_Dialog,_CheckForFallBackPlayers,_ForcePartyCheck);

//Movement Failed
IF
CharacterMoveToAndTalkFailed((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_MoveEvent)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent)
THEN
NOT DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent);

IF
AttackedByObject(_Character,_Source,_Summon,_DamageType,_)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
RegionEnded(_)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CharacterLeftRegion(_Characrer,_Region)
AND
DB_CurrentLevel(_Region)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CharacterLeftRegion(_Target,_Region)
AND
DB_CurrentLevel(_Region)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CharacterDied(_Target)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CharacterDied(_Character)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
DialogStarted(_,_ID)
AND
DB_DialogNPCS(_ID,_Character,_)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CombatStarted(_ID)
AND
DB_CombatCharacters(_Character, _ID)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving((CHARACTERGUID)_Character,_Target,_Dialog,_MoveEvent)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);


// Movement Finished
IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent)
THEN
NOT DB_CharacterMoveToAndTalk_CharacerIsMoving(_Character,_Target,_Dialog,_MoveEvent);

IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
THEN
SetStoryEvent(_Character,_MoveEvent);

// Dialog Failed
IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND 
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,_Target,_Dialog,0,_ForcePartyCheck)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);


IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND 
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,(CHARACTERGUID)_Target,_Dialog,1,0)
AND
DB_IsPlayer(_Target)
AND
QRY_GetClosestAvailableCharacterTo(_Target,1)
AND
NOT DB_MoveToAndTalk_FoundNewAvailablePlayer(1)
THEN
DB_MoveToAndTalk_FoundNewAvailablePlayer(1);
PROC_CharacterMoveToAndTalkRequestDialog_Closest(_Character,_Target,_Dialog,_IsAutomated,_MoveEvent);

IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND 
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,(CHARACTERGUID)_Target,_Dialog,1,1)
AND
DB_IsPlayer(_Target)
AND
QRY_GetClosestAvailableCharacterTo(_Target,1,1,_Target)
AND
NOT DB_MoveToAndTalk_FoundNewAvailablePlayer(1)
THEN
DB_MoveToAndTalk_FoundNewAvailablePlayer(1);
PROC_CharacterMoveToAndTalkRequestDialog_Closest(_Character,_Target,_Dialog,_IsAutomated,_MoveEvent);

IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND 
DB_CharacterMoveToAndTalk_CheckForFallBackCharacters(_Character,(CHARACTERGUID)_Target,_Dialog,1,_)
AND
DB_IsPlayer(_Target)
AND
NOT QRY_GetClosestAvailableCharacterTo(_Target,1)
AND
NOT DB_MoveToAndTalk_FoundNewAvailablePlayer(1)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
DB_MoveToAndTalk_FoundNewAvailablePlayer(1)
THEN
NOT DB_MoveToAndTalk_FoundNewAvailablePlayer(1);

// Dialog Success

IF
CharacterMoveToAndTalkRequestDialog((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
_Dialog!=""
AND
QRY_SpeakerIsAvailable(_Target)
THEN
Proc_StartDialog(_IsAutomated,_Dialog,_Character,_Target);

PROC
PROC_CharacterMoveToAndTalkRequestDialog_Closest((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND
DB_ClosestAvailableCharacterTo(_Player,(CHARACTERGUID)_Target,_)
THEN
Proc_StartDialog(_IsAutomated,_Dialog,_Character,_Player);

PROC
PROC_CharacterMoveToAndTalkRequestDialog_Closest((CHARACTERGUID)_Character,(GUIDSTRING)_Target,(STRING)_Dialog,(INTEGER)_IsAutomated,(STRING)_MoveEvent)
AND
NOT QRY_SpeakerIsAvailable(_Target)
AND
NOT DB_ClosestAvailableCharacterTo(_,(CHARACTERGUID)_Target,_)
THEN
CharacterMoveToAndTalkRequestDialogFailed(_Character,_Target,_MoveEvent);

//END_REGION

EXITSECTION

ENDEXITSECTION
